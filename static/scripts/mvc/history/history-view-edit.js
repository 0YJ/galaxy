"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(exports,"__esModule",{value:!0});var _historyView=require("mvc/history/history-view"),_historyView2=_interopRequireDefault(_historyView),_historyContents=require("mvc/history/history-contents"),_historyContents2=_interopRequireDefault(_historyContents),_states=require("mvc/dataset/states"),_states2=_interopRequireDefault(_states),_hdaModel=require("mvc/history/hda-model"),_hdaModel2=_interopRequireDefault(_hdaModel),_hdaLiEdit=require("mvc/history/hda-li-edit"),_hdaLiEdit2=_interopRequireDefault(_hdaLiEdit),_hdcaLiEdit=require("mvc/history/hdca-li-edit"),_hdcaLiEdit2=_interopRequireDefault(_hdcaLiEdit),_tag=require("mvc/tag"),_tag2=_interopRequireDefault(_tag),_annotation=require("mvc/annotation"),_annotation2=_interopRequireDefault(_annotation),_listCollectionCreator=require("mvc/collection/list-collection-creator"),_listCollectionCreator2=_interopRequireDefault(_listCollectionCreator),_pairCollectionCreator=require("mvc/collection/pair-collection-creator"),_pairCollectionCreator2=_interopRequireDefault(_pairCollectionCreator),_listOfPairsCollectionCreator=require("mvc/collection/list-of-pairs-collection-creator"),_listOfPairsCollectionCreator2=_interopRequireDefault(_listOfPairsCollectionCreator),_faIconButton=require("ui/fa-icon-button"),_faIconButton2=_interopRequireDefault(_faIconButton),_popupMenu=require("mvc/ui/popup-menu"),_popupMenu2=_interopRequireDefault(_popupMenu),_baseMvc=require("mvc/base-mvc"),_baseMvc2=_interopRequireDefault(_baseMvc),_localization=require("utils/localization"),_localization2=_interopRequireDefault(_localization);require("ui/editable-text");var _super=_historyView2.default.HistoryView,HistoryViewEdit=_super.extend({HDAViewClass:_hdaLiEdit2.default.HDAListItemEdit,HDCAViewClass:_hdcaLiEdit2.default.HDCAListItemEdit,initialize:function(t){t=t||{},_super.prototype.initialize.call(this,t),this.tagsEditor=null,this.dragItems=!0,this.annotationEditor=null,this.purgeAllowed=t.purgeAllowed||!1,this.annotationEditorShown=t.annotationEditorShown||!1,this.tagsEditorShown=t.tagsEditorShown||!1},_setUpListeners:function(){return _super.prototype._setUpListeners.call(this),this.on({"droptarget:drop":function(t,e){this.dataDropped(e),this.dropTargetOff()},"view:attached view:removed":function(){this._renderCounts()},"search:loading-progress":this._renderSearchProgress,"search:searching":this._renderSearchFindings})},_setUpModelListeners:function(){return _super.prototype._setUpModelListeners.call(this),this.listenTo(this.model,"change:size",this.updateHistoryDiskSize),this},_setUpCollectionListeners:function(){return _super.prototype._setUpCollectionListeners.call(this),this.listenTo(this.collection,{"change:deleted":this._handleItemDeletedChange,"change:visible":this._handleItemVisibleChange,"change:purged":function(t){this.model.fetch()},"fetching-deleted":function(t){this.$("> .controls .deleted-count").html("<i>"+(0,_localization2.default)("loading...")+"</i>")},"fetching-hidden":function(t){this.$("> .controls .hidden-count").html("<i>"+(0,_localization2.default)("loading...")+"</i>")},"fetching-deleted-done fetching-hidden-done":this._renderCounts}),this},_buildNewRender:function(){var t=_super.prototype._buildNewRender.call(this);return this.model?(Galaxy&&Galaxy.user&&Galaxy.user.id&&Galaxy.user.id===this.model.get("user_id")&&(this._renderTags(t),this._renderAnnotation(t)),t):t},updateHistoryDiskSize:function(){this.$(".history-size").text(this.model.get("nice_size"))},renderItems:function(t){var e=_super.prototype.renderItems.call(this,t);return this.searchFor?this._renderSearchFindings(t):this._renderCounts(t),e},_renderCounts:function(t){t=t instanceof jQuery?t:this.$el;var e=this.templates.counts(this.model.toJSON(),this);return t.find("> .controls .subtitle").html(e)},_renderTags:function(t){var e=this;this.tagsEditor=new _tag2.default.TagsEditor({model:this.model,el:t.find(".controls .tags-display"),onshowFirstTime:function(){this.render()},onshow:function(){e.toggleHDATagEditors(!0,e.fxSpeed)},onhide:function(){e.toggleHDATagEditors(!1,e.fxSpeed)},$activator:(0,_faIconButton2.default)({title:(0,_localization2.default)("Edit history tags"),classes:"history-tag-btn",faIcon:"fa-tags"}).appendTo(t.find(".controls .actions"))})},_renderAnnotation:function(t){var e=this;this.annotationEditor=new _annotation2.default.AnnotationEditor({model:this.model,el:t.find(".controls .annotation-display"),onshowFirstTime:function(){this.render()},onshow:function(){e.toggleHDAAnnotationEditors(!0,e.fxSpeed)},onhide:function(){e.toggleHDAAnnotationEditors(!1,e.fxSpeed)},$activator:(0,_faIconButton2.default)({title:(0,_localization2.default)("Edit history annotation"),classes:"history-annotate-btn",faIcon:"fa-comment"}).appendTo(t.find(".controls .actions"))})},_setUpBehaviors:function(t){if(t=t||this.$el,_super.prototype._setUpBehaviors.call(this,t),this.model&&Galaxy.user&&!Galaxy.user.isAnonymous()&&Galaxy.user.id===this.model.get("user_id")){var e=this;t.find("> .controls .name").attr("title",(0,_localization2.default)("Click to rename history")).tooltip({placement:"bottom"}).make_text_editable({on_finish:function(t){var i=e.model.get("name");t&&t!==i?(e.$el.find("> .controls .name").text(t),e.model.save({name:t}).fail(function(){e.$el.find("> .controls .name").text(e.model.previous("name"))})):e.$el.find("> .controls .name").text(i)}})}},multiselectActions:function(){var t=this,e=[{html:(0,_localization2.default)("Hide datasets"),func:function(){var e=_hdaModel2.default.HistoryDatasetAssociation.prototype.hide;t.getSelectedModels().ajaxQueue(e)}},{html:(0,_localization2.default)("Unhide datasets"),func:function(){var e=_hdaModel2.default.HistoryDatasetAssociation.prototype.unhide;t.getSelectedModels().ajaxQueue(e)}},{html:(0,_localization2.default)("Delete datasets"),func:function(){var e=_hdaModel2.default.HistoryDatasetAssociation.prototype.delete;t.getSelectedModels().ajaxQueue(e)}},{html:(0,_localization2.default)("Undelete datasets"),func:function(){var e=_hdaModel2.default.HistoryDatasetAssociation.prototype.undelete;t.getSelectedModels().ajaxQueue(e)}}];return t.purgeAllowed&&e.push({html:(0,_localization2.default)("Permanently delete datasets"),func:function(){if(confirm((0,_localization2.default)("This will permanently remove the data in your datasets. Are you sure?"))){var e=_hdaModel2.default.HistoryDatasetAssociation.prototype.purge;t.getSelectedModels().ajaxQueue(e)}}}),e=e.concat(t._collectionActions())},_collectionActions:function(){var t=this;return[{html:(0,_localization2.default)("Build Dataset List"),func:function(){t.buildCollection("list")}},{html:(0,_localization2.default)("Build Dataset Pair"),func:function(){t.buildCollection("paired")}},{html:(0,_localization2.default)("Build List of Dataset Pairs"),func:function(){t.buildCollection("list:paired")}}]},buildCollection:function(t,e,i){var o,n=this,e=e||n.getSelectedModels(),i=i||!1;"list"==t?o=_listCollectionCreator2.default.createListCollection:"paired"==t?o=_pairCollectionCreator2.default.createPairCollection:"list:paired"==t?o=_listOfPairsCollectionCreator2.default.createListOfPairsCollection:console.warn("Unknown collectionType encountered "+t),o(e,i).done(function(){n.model.refresh()})},_getItemViewOptions:function(t){var e=_super.prototype._getItemViewOptions.call(this,t);return _.extend(e,{purgeAllowed:this.purgeAllowed,tagsEditorShown:this.tagsEditor&&!this.tagsEditor.hidden,annotationEditorShown:this.annotationEditor&&!this.annotationEditor.hidden}),e},_handleItemDeletedChange:function(t){t.get("deleted")?this._handleItemDeletion(t):this._handleItemUndeletion(t),this._renderCounts()},_handleItemDeletion:function(t){var e=this.model.get("contents_active");e.deleted+=1,e.active-=1,this.model.contents.includeDeleted||this.removeItemView(t),this.model.set("contents_active",e)},_handleItemUndeletion:function(t){var e=this.model.get("contents_active");e.deleted-=1,this.model.contents.includeDeleted||(e.active-=1),this.model.set("contents_active",e)},_handleItemVisibleChange:function(t){t.hidden()?this._handleItemHidden(t):this._handleItemUnhidden(t),this._renderCounts()},_handleItemHidden:function(t){var e=this.model.get("contents_active");e.hidden+=1,e.active-=1,this.model.contents.includeHidden||this.removeItemView(t),this.model.set("contents_active",e)},_handleItemUnhidden:function(t){var e=this.model.get("contents_active");e.hidden-=1,this.model.contents.includeHidden||(e.active-=1),this.model.set("contents_active",e)},toggleHDATagEditors:function(t,e){_.each(this.views,function(i){i.tagsEditor&&i.tagsEditor.toggle(t,e)})},toggleHDAAnnotationEditors:function(t,e){_.each(this.views,function(i){i.annotationEditor&&i.annotationEditor.toggle(t,e)})},events:_.extend(_.clone(_super.prototype.events),{"click .show-selectors-btn":"toggleSelectors","click .toggle-deleted-link":function(t){this.toggleShowDeleted()},"click .toggle-hidden-link":function(t){this.toggleShowHidden()}}),_renderSearchProgress:function(t,e){var i=t+e;return this.$("> .controls .subtitle").html(["<i>",(0,_localization2.default)("Searching "),i,"/",this.model.contentsShown(),"</i>"].join(""))},_renderSearchFindings:function(t){t=t instanceof jQuery?t:this.$el;var e=this.templates.found(this.model.toJSON(),this);return t.find("> .controls .subtitle").html(e),this},dropTargetOn:function(){if(this.dropTarget)return this;this.dropTarget=!0;var t={dragenter:_.bind(this.dragenter,this),dragover:_.bind(this.dragover,this),dragleave:_.bind(this.dragleave,this),drop:_.bind(this.drop,this)},e=this._renderDropTarget();this.$list().before([this._renderDropTargetHelp(),e]);for(var i in t)t.hasOwnProperty(i)&&e.on(i,t[i]);return this},_renderDropTarget:function(){return this.$(".history-drop-target").remove(),$("<div/>").addClass("history-drop-target")},_renderDropTargetHelp:function(){return this.$(".history-drop-target-help").remove(),$("<div/>").addClass("history-drop-target-help").text((0,_localization2.default)("Drag datasets here to copy them to the current history"))},dropTargetOff:function(){if(!this.dropTarget)return this;this.dropTarget=!1;var t=this.$(".history-drop-target").get(0);for(var e in this._dropHandlers)this._dropHandlers.hasOwnProperty(e)&&t.off(e,this._dropHandlers[e]);return this.$(".history-drop-target").remove(),this.$(".history-drop-target-help").remove(),this},dropTargetToggle:function(){return this.dropTarget?this.dropTargetOff():this.dropTargetOn(),this},dragenter:function(t){t.preventDefault(),t.stopPropagation(),this.$(".history-drop-target").css("border","2px solid black")},dragover:function(t){t.preventDefault(),t.stopPropagation()},dragleave:function(t){t.preventDefault(),t.stopPropagation(),this.$(".history-drop-target").css("border","1px dashed black")},drop:function(t){t.preventDefault();var e=this,i=t.originalEvent.dataTransfer,o=i.getData("text");i.dropEffect="move";try{o=JSON.parse(o)}catch(t){e.warn("error parsing JSON from drop:",o)}return e.trigger("droptarget:drop",t,o,e),!1},dataDropped:function(t){var e=this;return _.isObject(t)&&"HistoryDatasetAssociation"===t.model_class&&t.id?0!==e.contents.currentPage?e.contents.fetchPage(0).then(function(){return e.model.contents.copy(t.id)}):e.model.contents.copy(t.id):jQuery.when()},toString:function(){return"HistoryViewEdit("+(this.model?this.model.get("name"):"")+")"}});HistoryViewEdit.prototype.templates=function(){var t=_baseMvc2.default.wrapTemplate(["<% var shown = Math.max( view.views.length, history.contents_active.active ) %>","<% if( shown ){ %>",'<span class="shown-count">',"<%- shown %> ",(0,_localization2.default)("shown"),"</span>","<% } %>","<% if( history.contents_active.deleted ){ %>",'<span class="deleted-count">',"<% if( view.model.contents.includeDeleted ){ %>",'<a class="toggle-deleted-link" href="javascript:void(0);">',(0,_localization2.default)("hide deleted"),"</a>","<% } else { %>","<%- history.contents_active.deleted %> ",'<a class="toggle-deleted-link" href="javascript:void(0);">',(0,_localization2.default)("deleted"),"</a>","<% } %>","</span>","<% } %>","<% if( history.contents_active.hidden ){ %>",'<span class="hidden-count">',"<% if( view.model.contents.includeHidden ){ %>",'<a class="toggle-hidden-link" href="javascript:void(0);">',(0,_localization2.default)("hide hidden"),"</a>","<% } else { %>","<%- history.contents_active.hidden %> ",'<a class="toggle-hidden-link" href="javascript:void(0);">',(0,_localization2.default)("hidden"),"</a>","<% } %>","</span>","<% } %>"],"history"),e=_baseMvc2.default.wrapTemplate([(0,_localization2.default)("Found")," <%- view.views.length %>, ","<% if( history.contents_active.deleted ){ %>","<% if( view.model.contents.includeDeleted ){ %>",'<a class="toggle-deleted-link" href="javascript:void(0);">',(0,_localization2.default)("hide deleted"),"</a>, ","<% } else { %>",'<a class="toggle-deleted-link" href="javascript:void(0);">',(0,_localization2.default)("show deleted"),"</a>, ","<% } %>","<% } %>","<% if( history.contents_active.hidden ){ %>","<% if( view.model.contents.includeHidden ){ %>",'<a class="toggle-hidden-link" href="javascript:void(0);">',(0,_localization2.default)("hide hidden"),"</a>","<% } else { %>",'<a class="toggle-hidden-link" href="javascript:void(0);">',(0,_localization2.default)("show hidden"),"</a>","<% } %>","<% } %>"],"history");return _.extend(_.clone(_super.prototype.templates),{counts:t,found:e})}(),exports.default={HistoryViewEdit:HistoryViewEdit};
//# sourceMappingURL=../../../maps/mvc/history/history-view-edit.js.map
