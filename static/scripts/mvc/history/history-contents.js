"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _controlledFetchCollection=require("mvc/base/controlled-fetch-collection"),_controlledFetchCollection2=_interopRequireDefault(_controlledFetchCollection),_hdaModel=require("mvc/history/hda-model"),_hdaModel2=_interopRequireDefault(_hdaModel),_hdcaModel=require("mvc/history/hdca-model"),_hdcaModel2=_interopRequireDefault(_hdcaModel),_historyPreferences=require("mvc/history/history-preferences"),_historyPreferences2=_interopRequireDefault(_historyPreferences),_baseMvc=require("mvc/base-mvc"),_baseMvc2=_interopRequireDefault(_baseMvc),_ajaxQueue=require("utils/ajax-queue"),_ajaxQueue2=_interopRequireDefault(_ajaxQueue),_super=_controlledFetchCollection2.default.PaginatedCollection,HistoryContents=_super.extend(_baseMvc2.default.LoggableMixin).extend({_logNamespace:"history",model:function(e,t){if("dataset"===e.history_content_type)return new _hdaModel2.default.HistoryDatasetAssociation(e,t);if("dataset_collection"===e.history_content_type){switch(e.collection_type){case"list":return new _hdcaModel2.default.HistoryListDatasetCollection(e,t);case"paired":return new _hdcaModel2.default.HistoryPairDatasetCollection(e,t);case"list:paired":return new _hdcaModel2.default.HistoryListPairedDatasetCollection(e,t);case"list:list":return new _hdcaModel2.default.HistoryListOfListsDatasetCollection(e,t)}var i="Unknown collection_type: "+e.collection_type;return console.warn(i,e),{validationError:i}}return{validationError:"Unknown history_content_type: "+e.history_content_type}},limitPerPage:500,limitPerProgressiveFetch:500,order:"hid",urlRoot:Galaxy.root+"api/histories",url:function(){return this.urlRoot+"/"+this.historyId+"/contents"},initialize:function(e,t){t=t||{},_super.prototype.initialize.call(this,e,t),this.history=t.history||null,this.setHistoryId(t.historyId||null),this.includeDeleted=t.includeDeleted||this.includeDeleted,this.includeHidden=t.includeHidden||this.includeHidden,this.model.prototype.idAttribute="type_id"},setHistoryId:function(e){this.historyId=e,this._setUpWebStorage()},_setUpWebStorage:function(e){if(this.historyId)return this.storage=new _historyPreferences2.default.HistoryPrefs({id:_historyPreferences2.default.HistoryPrefs.historyStorageKey(this.historyId)}),this.trigger("new-storage",this.storage,this),this.on({"include-deleted":function(e){this.storage.includeDeleted(e)},"include-hidden":function(e){this.storage.includeHidden(e)}}),this.includeDeleted=this.storage.includeDeleted()||!1,this.includeHidden=this.storage.includeHidden()||!1,this},comparators:_.extend(_.clone(_super.prototype.comparators),{name:_baseMvc2.default.buildComparator("name",{ascending:!0}),"name-dsc":_baseMvc2.default.buildComparator("name",{ascending:!1}),hid:_baseMvc2.default.buildComparator("hid",{ascending:!1}),"hid-asc":_baseMvc2.default.buildComparator("hid",{ascending:!0})}),running:function(){return this.filter(function(e){return!e.inReadyState()})},runningAndActive:function(){return this.filter(function(e){return!e.inReadyState()&&e.get("visible")&&!e.get("deleted")})},getByHid:function(e){return this.findWhere({hid:e})},haveDetails:function(){return this.all(function(e){return e.hasDetails()})},hidden:function(){return this.filter(function(e){return e.hidden()})},deleted:function(){return this.filter(function(e){return e.get("deleted")})},visibleAndUndeleted:function(){return this.filter(function(e){return e.get("visible")&&!e.get("deleted")})},setIncludeDeleted:function(e,t){if(_.isBoolean(e)&&e!==this.includeDeleted){if(this.includeDeleted=e,_.result(t,"silent"))return;this.trigger("include-deleted",e,this)}},setIncludeHidden:function(e,t){if(_.isBoolean(e)&&e!==this.includeHidden){if(this.includeHidden=e,t=t||{},_.result(t,"silent"))return;this.trigger("include-hidden",e,this)}},fetch:function(e){if(e=e||{},this.historyId&&!e.details){var t=_historyPreferences2.default.HistoryPrefs.get(this.historyId).toJSON();_.isEmpty(t.expandedIds)||(e.details=_.values(t.expandedIds).join(","))}return _super.prototype.fetch.call(this,e)},_buildFetchData:function(e){return _.extend(_super.prototype._buildFetchData.call(this,e),{v:"dev"})},_fetchParams:_super.prototype._fetchParams.concat(["v","details"]),_buildFetchFilters:function(e){var t=_super.prototype._buildFetchFilters.call(this,e)||{},i={};return this.includeDeleted||(i.deleted=!1,i.purged=!1),this.includeHidden||(i.visible=!0),_.defaults(t,i)},getTotalItemCount:function(){return this.history.contentsShown()},fetchUpdated:function(e,t){return e&&((t=t||{filters:{}}).remove=!1,t.filters={"update_time-ge":e.toISOString(),visible:""}),this.fetch(t)},fetchDeleted:function(e){var t=this;return(e=e||{}).filters=_.extend(e.filters,{deleted:!0,purged:void 0}),e.remove=!1,t.trigger("fetching-deleted",t),t.fetch(e).always(function(){t.trigger("fetching-deleted-done",t)})},fetchHidden:function(e){var t=this;return(e=e||{}).filters=_.extend(e.filters,{visible:!1}),e.remove=!1,t.trigger("fetching-hidden",t),t.fetch(e).always(function(){t.trigger("fetching-hidden-done",t)})},fetchAllDetails:function(e){var t={details:"all"};return(e=e||{}).data=_.extend(e.data||{},t),this.fetch(e)},fetchCollectionCounts:function(e){return e=e||{},e.keys=["type_id","element_count"].join(","),e.filters=_.extend(e.filters||{},{history_content_type:"dataset_collection"}),e.remove=!1,this.fetch(e)},_filterAndUpdate:function(e,t){var i=this,n=i.model.prototype.idAttribute,r=[t];return i.fetch({filters:e,remove:!1}).then(function(e){return e=e.reduce(function(e,t,r){var o=i.get(t[n]);return o?e.concat(o):e},[]),i.ajaxQueue("save",r,e)})},ajaxQueue:function(e,t,i){return i=i||this.models,new _ajaxQueue2.default.AjaxQueue(i.slice().reverse().map(function(i,n){var r=_.isString(e)?i[e]:e;return function(){return r.apply(i,t)}})).deferred},progressivelyFetchDetails:function(e){function t(s){s=s||0;var a=_.extend(_.clone(e),{view:"summary",keys:o,limit:r,offset:s,reset:0===s,remove:!1});_.defer(function(){n.fetch.call(n,a).fail(i.reject).done(function(e){i.notify(e,r,s),e.length!==r?(n.allFetched=!0,i.resolve(e,r,s)):t(s+r)})})}e=e||{};var i=jQuery.Deferred(),n=this,r=e.limitPerCall||n.limitPerProgressiveFetch,o=_hdaModel2.default.HistoryDatasetAssociation.prototype.searchAttributes.join(",");return t(),i},isCopyable:function(e){var t=["HistoryDatasetAssociation","HistoryDatasetCollectionAssociation"];return _.isObject(e)&&e.id&&_.contains(t,e.model_class)},copy:function(e){var t,i,n;_.isString(e)?(t=e,n="hda",i="dataset"):(t=e.id,n={HistoryDatasetAssociation:"hda",LibraryDatasetDatasetAssociation:"ldda",HistoryDatasetCollectionAssociation:"hdca"}[e.model_class]||"hda",i="hdca"===n?"dataset_collection":"dataset");var r=this,o=jQuery.ajax(this.url(),{method:"POST",contentType:"application/json",data:JSON.stringify({content:t,source:n,type:i})}).done(function(e){r.add([e],{parse:!0})}).fail(function(e,s,a){r.trigger("error",r,o,{},"Error copying contents",{type:i,id:t,source:n})});return o},createHDCA:function(e,t,i,n,r){return this.model({history_content_type:"dataset_collection",collection_type:t,history_id:this.historyId,name:i,hide_source_items:n||!1,element_identifiers:e}).save(r)},haveSearchDetails:function(){return this.allFetched&&this.all(function(e){return _.has(e.attributes,"annotation")})},matches:function(e){return this.filter(function(t){return t.matches(e)})},clone:function(){var e=Backbone.Collection.prototype.clone.call(this);return e.historyId=this.historyId,e},toString:function(){return["HistoryContents(",[this.historyId,this.length].join(),")"].join("")}});exports.default={HistoryContents:HistoryContents};
//# sourceMappingURL=../../../maps/mvc/history/history-contents.js.map
