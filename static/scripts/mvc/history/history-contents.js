define(["mvc/base/controlled-fetch-collection","mvc/history/hda-model","mvc/history/hdca-model","mvc/history/history-preferences","mvc/base-mvc","utils/ajax-queue"],function(a,b,c,d,e,f){"use strict";var g=a.ControlledFetchCollection,h=g.extend(e.LoggableMixin).extend({_logNamespace:"history",model:function(a,d){if("dataset"===a.history_content_type)return new b.HistoryDatasetAssociation(a,d);if("dataset_collection"===a.history_content_type){switch(a.collection_type){case"list":return new c.HistoryListDatasetCollection(a,d);case"paired":return new c.HistoryPairDatasetCollection(a,d);case"list:paired":return new c.HistoryListPairedDatasetCollection(a,d)}return{validationError:"Unknown collection_type: "+a.history_content_type}}return{validationError:"Unknown history_content_type: "+a.history_content_type}},limitOnFirstFetch:500,limitPerFetch:500,order:"hid",initialize:function(a,b){b=b||{},g.prototype.initialize.call(this,a,b),this.history=b.history||null,this.historyId=b.historyId||null,this.model.prototype.idAttribute="type_id",this.includeDeleted=b.includeDeleted||!1,this.includeHidden=b.includeHidden||!1,this.on("all",function(){var a=_.toArray(arguments);/^change:*/.test(a[0])||console.log.apply(console,[this+""].concat(a))})},urlRoot:Galaxy.root+"api/histories",url:function(){return this.urlRoot+"/"+this.historyId+"/contents"},comparators:_.extend(_.clone(g.prototype.comparators),{name:e.buildComparator("name",{ascending:!0}),"name-dsc":e.buildComparator("name",{ascending:!1}),hid:e.buildComparator("hid",{ascending:!1}),"hid-asc":e.buildComparator("hid",{ascending:!0})}),running:function(){return this.filter(function(a){return!a.inReadyState()})},runningAndActive:function(){return this.filter(function(a){return!a.inReadyState()&&a.get("visible")&&!a.get("deleted")})},getByHid:function(a){return _.first(this.filter(function(b){return b.get("hid")===a}))},haveDetails:function(){return this.all(function(a){return a.hasDetails()})},hidden:function(){return this.filter(function(a){return a.hidden()})},deleted:function(){return this.filter(function(a){return a.get("deleted")})},visibleAndUndeleted:function(){return this.filter(function(a){return a.get("visible")&&!a.get("deleted")})},setIncludeDeleted:function(a){_.isBoolean(a)&&a!==this.includeDeleted&&(this.includeDeleted=a,this.trigger("change:include-deleted",a,this))},setIncludeHidden:function(a){_.isBoolean(a)&&a!==this.includeHidden&&(this.includeHidden=a,this.trigger("change:include-hidden",a,this))},fetch:function(a){if(a=a||{},this.historyId&&!a.details){var b=d.HistoryPrefs.get(this.historyId).toJSON();a.details=_.values(b.expandedIds).join(",")}return g.prototype.fetch.call(this,a)},_buildFetchData:function(a){return _.extend(g.prototype._buildFetchData.call(this,a),{v:"dev"})},_fetchParams:g.prototype._fetchParams.concat(["v","details"]),_buildFetchFilters:function(a){var b=g.prototype._buildFetchFilters.call(this,a)||{},c={};return this.includeDeleted||(c.deleted=!1,c.purged=!1),this.includeHidden||(c.visible=!0),_.defaults(b,c)},fetchUpdated:function(a,b){return a&&(b=b||{filters:{}},b.remove=!1,b.filters={"update_time-ge":a.toISOString(),visible:""}),this.fetch(b)},fetchDeleted:function(a){a=a||{};var b=this;return a.filters=_.extend(a.filters,{deleted:!0,purged:void 0}),a.remove=!1,b.trigger("fetching-deleted",b),b.fetch(a).always(function(){b.trigger("fetching-deleted-done",b)})},fetchHidden:function(a){a=a||{};var b=this;return a.filters=_.extend(a.filters,{visible:!1}),a.remove=!1,b.trigger("fetching-hidden",b),b.fetch(a).always(function(){b.trigger("fetching-hidden-done",b)})},fetchAllDetails:function(a){a=a||{};var b={details:"all"};return a.data=_.extend(a.data||{},b),this.fetch(a)},_filterAndUpdate:function(a,b){var c=this,d=c.model.prototype.idAttribute,e=[b];return c.fetch({filters:a,remove:!1}).then(function(a){return a=a.reduce(function(a,b){var e=c.get(b[d]);return e?a.concat(e):a},[]),c.ajaxQueue("save",e,a)})},ajaxQueue:function(a,b,c){return c=c||this.models,new f.AjaxQueue(c.slice().reverse().map(function(c){var d=_.isString(a)?c[a]:a;return function(){return d.apply(c,b)}})).start()},limitPerProgressiveFetch:500,progressivelyFetchDetails:function(a){function c(a,b){return e.notify(a,g,b),f.allFetched?void e.resolve(a,g,b):void d(b+g)}function d(b){b=b||0;var d=_.extend(_.clone(a),{view:"summary",keys:i,limit:g,offset:b,reset:0===b}),h=0===b?f.fetchFirst:f.fetchMore;_.defer(function(){h.call(f,d).fail(e.reject).done(function(a){c(a,b)})})}a=a||{};var e=jQuery.Deferred(),f=this,g=a.limitPerCall||f.limitPerProgressiveFetch,h=b.HistoryDatasetAssociation.prototype.searchAttributes,i=h.join(",");return d(),e},isCopyable:function(a){var b=["HistoryDatasetAssociation","HistoryDatasetCollectionAssociation"];return _.isObject(a)&&a.id&&_.contains(b,a.model_class)},copy:function(a){var b,c,d;_.isString(a)?(b=a,d="hda",c="dataset"):(b=a.id,d={HistoryDatasetAssociation:"hda",LibraryDatasetDatasetAssociation:"ldda",HistoryDatasetCollectionAssociation:"hdca"}[a.model_class]||"hda",c="hdca"===d?"dataset_collection":"dataset");var e=this,f=jQuery.post(this.url(),{content:b,source:d,type:c,view:"detailed",keys:"create_time,update_time"}).done(function(a){e.add([a],{parse:!0})}).fail(function(){e.trigger("error",e,f,{},"Error copying contents",{type:c,id:b,source:d})});return f},createHDCA:function(a,b,c,d){var e=this.model({history_content_type:"dataset_collection",collection_type:b,history_id:this.historyId,name:c,element_identifiers:a});return e.save(d)},haveSearchDetails:function(){return this.allFetched&&this.all(function(a){return _.has(a.attributes,"annotation")})},matches:function(a){return this.filter(function(b){return b.matches(a)})},clone:function(){var a=Backbone.Collection.prototype.clone.call(this);return a.historyId=this.historyId,a},toString:function(){return["HistoryContents(",[this.historyId,this.length].join(),")"].join("")}}),i=h.extend({order:"hid",initialize:function(a,b){h.prototype.initialize.call(this,a,b),this.currentSection=0,this.sectionsFetched=[]},comparators:{hid:e.buildComparator("hid",{ascending:!1}),"hid-asc":e.buildComparator("hid",{ascending:!0})},_getLastHid:function(){return(this.history.get("hid_counter")||1)-1},_mapSectionRanges:function(a){var b=this,c=b._countSections(),d=_.range(c);return"hid"===this.order&&d.reverse(),d.map(function(c){return a(_.extend(b._getSectionRange(c),{number:c}))})},_countSections:function(){return Math.max(1,Math.floor(this._getLastHid()/this.hidsPerSection))},_lastSection:function(){return Math.max(0,this._countSections()-1)},_lastFullSection:function(){var a=this._countSections(),b=this._getLastHid()%this.hidsPerSection>0;return b?a-1:a},_getSectionRange:function(a){var b=this._getLastHid(),c=this.hidsPerSection,d=a*c,e=a===this._lastSection()?b:d+c-1;return{first:d,last:e}},_filterSectionCollection:function(a,b){return this._sectionCollection(a).filter(b)},_sectionCollection:function(a){for(var b=this,c=b._getSectionRange(a),d="hid"===this.order,e=[],f=b._indexOfHid(d?c.last:c.first),g=f;g<this.length;g++){var h=this.at(g),i=h.get("hid");if(d){if(i<c.first){console.log("< first");break}}else if(i>c.last){console.log("> last");break}e.push(h)}return e},_indexOfHid:function(a){return this._indexOfHidInModelArray(a,this.models,{descending:"hid"===this.order})},_indexOfHidInModelArray:function(a,b,c){function d(c){var d=b[c].get("hid");return e?d>a:a>d}var e=_.result(c,"descending",!0);return this._binarySearch({low:0,high:b.length,testFn:d})},_binarySearch:function(a){for(var b=a.low,c=a.high;c>b;){var d=Math.floor((b+c)/2);a.testFn(d)?b=d+1:c=d}return b},_indexOfHidInSection:function(a,b){var c=this,d=c._getSectionRange(b),e=b===c._lastSection(),f=("hid"===this.order,!e&&a>d.last);return f||a<d.first?null:c._indexOfHid(a)},_getCurrentSectionRange:function(){return this._getSectionRange(this.currentSection)},_filterCurrentSectionCollection:function(a){return this._filterSectionCollection(this.currentSection,a)},hidsPerSection:100,fetchFirst:function(a){return _.extend(a||{},{silent:!0}),this.currentSection=0,"hid"===this.order&&this._countSections()>1&&(this.currentSection=this._lastFullSection()),this.fetchSection(this.currentSection,a)},fetchSection:function(a,b){if(b=b||{},!b.bypassCache&&_.contains(this.sectionsFetched,a,this))return this.trigger("fetching-section-done",a,this),jQuery.when();var c=this;c.trigger("fetching-section",a,c);var d=c._getSectionRange(a);return c.fetch(_.extend(b,{silent:!0,remove:!1,filters:_.extend(b.filters||{},{"hid-ge":Math.max(d.first-1,0),"hid-le":d.last})})).always(function(){c.trigger("fetching-section-done",a,c)}).done(function(){c.sectionsFetched.push(a),c.sectionsFetched.sort()})},fetchDeletedInSection:function(a,b){b=b||{};var c=this;return b.filters=_.extend(b.filters,{deleted:!0,purged:void 0}),b.bypassCache=!0,c.trigger("fetching-deleted",c),c.fetchSection(a,b).always(function(){c.trigger("fetching-deleted-done",c)})},fetchHiddenInSection:function(a,b){b=b||{};var c=this;return b.filters=_.extend(b.filters,{visible:!1}),b.bypassCache=!0,c.trigger("fetching-deleted",c),c.fetchSection(a,b).always(function(){c.trigger("fetching-deleted-done",c)})}});return{HistoryContents:i}});
//# sourceMappingURL=../../../maps/mvc/history/history-contents.js.map