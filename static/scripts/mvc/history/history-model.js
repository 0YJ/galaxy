define(["mvc/history/history-contents","utils/utils","mvc/base-mvc","utils/localization"],function(a,b,c){"use strict";var d=Backbone.Model.extend(c.LoggableMixin).extend(c.mixin(c.SearchableModelMixin,{_logNamespace:"history",UPDATE_DELAY:4e3,defaults:{model_class:"History",id:null,name:"Unnamed History",state:"new",deleted:!1,contents_shown:{}},urlRoot:Galaxy.root+"api/histories",initialize:function(b,c,d){d=d||{},this.logger=d.logger||null,this.log(this+".initialize:",b,c,d),this.log("creating history contents:",c),this.contents=new a.HistoryContents(c||[],{historyId:this.get("id")}),this._setUpListeners(),this._setUpCollectionListeners(),this.updateTimeoutId=null},_setUpListeners:function(){return this.on({error:function(){this.clearUpdateTimeout()},"change:id":function(a,b){this.contents&&(this.contents.historyId=b)}})},_setUpCollectionListeners:function(){return this.contents?this.listenTo(this.contents,{error:function(){this.trigger.apply(this,jQuery.makeArray(arguments))}}):this},nice_size:function(){return b.bytesToString(this.get("size"),!0,2)},toJSON:function(){return _.extend(Backbone.Model.prototype.toJSON.call(this),{nice_size:this.nice_size()})},get:function(a){return"nice_size"===a?this.nice_size():Backbone.Model.prototype.get.apply(this,arguments)},ownedByCurrUser:function(){return Galaxy&&Galaxy.user?Galaxy.user.isAnonymous()||Galaxy.user.id!==this.get("user_id")?!1:!0:!1},numOfUnfinishedJobs:function(){var a=this.get("non_ready_jobs");return a?a.length:0},numOfUnfinishedShownContents:function(){var a=this.contents.running().visibleAndUndeleted();return a?a.length:0},searchAttributes:["name","annotation","tags"],searchAliases:{title:"name",tag:"tags"},_getSizeAndRunning:function(){return this.fetch({data:$.param({keys:"size,non_ready_jobs"})})},refresh:function(a){a=a||{};var b=this,c=b.lastUpdateTime;return b.lastUpdateTime=new Date,this.contents.allFetched=!1,b.contents.fetchUpdated(c).done(_.bind(b.checkForUpdates,b))},checkForUpdates:function(a){function b(){d.clearUpdateTimeout(),d.updateTimeoutId=setTimeout(function(){d.refresh(a)},c)}a=a||{};var c=this.UPDATE_DELAY,d=this;this.numOfUnfinishedShownContents()>0?b():d._getSizeAndRunning().done(function(){d.numOfUnfinishedJobs()>0?b():d.trigger("ready")})},clearUpdateTimeout:function(){this.updateTimeoutId&&(clearTimeout(this.updateTimeoutId),this.updateTimeoutId=null)},fetchWithContents:function(a,b){a=a||{},a.view="current";var c=this;return this.fetch(a).pipe(function(a){return c.contents.historyId=a.id,c.lastUpdateTime=new Date,c.contents.fetchFirst(b)})},_delete:function(a){return this.get("deleted")?jQuery.when():this.save({deleted:!0},a)},purge:function(a){return this.get("purged")?jQuery.when():this.save({deleted:!0,purged:!0},a)},undelete:function(a){return this.get("deleted")?this.save({deleted:!1},a):jQuery.when()},copy:function(a,b,c){if(a=void 0!==a?a:!0,!this.id)throw new Error("You must set the history ID before copying it.");var e={history_id:this.id};a&&(e.current=!0),b&&(e.name=b),c||(e.all_datasets=!1);var f=this,g=jQuery.post(this.urlRoot,e);return a?g.then(function(a){var b=new d(a);return b.setAsCurrent().done(function(){f.trigger("copied",f,a)})}):g.done(function(a){f.trigger("copied",f,a)})},setAsCurrent:function(){var a=this,b=jQuery.getJSON(Galaxy.root+"history/set_as_current?id="+this.id);return b.done(function(){a.trigger("set-as-current",a)}),b},toString:function(){return"History("+this.get("id")+","+this.get("name")+")"}})),e=c.ControlledFetchCollection.extend(c.LoggableMixin).extend({_logNamespace:"history",model:d,DEFAULT_ORDER:"update_time",sortOrders:{update_time:{getter:function(a){return new Date(a.get("update_time"))},asc:!1},"update_time-asc":{getter:function(a){return new Date(a.get("update_time"))},asc:!0},name:{getter:function(a){return a.get("name")},asc:!0},"name-dsc":{getter:function(a){return a.get("name")},asc:!1},size:{getter:function(a){return a.get("size")},asc:!1},"size-asc":{getter:function(a){return a.get("size")},asc:!0}},initialize:function(a,b){b=b||{},this.log("HistoryCollection.initialize",arguments),this.includeDeleted=b.includeDeleted||!1,this.setOrder(b.order||this.DEFAULT_ORDER),this.currentHistoryId=b.currentHistoryId,this.allFetched=b.allFetched||!1,this.setUpListeners()},urlRoot:Galaxy.root+"api/histories",url:function(){return this.urlRoot},_fetchDefaults:function(){var a={order:this.order,view:"detailed"};return this.includeDeleted||(a.filters={deleted:!1,purged:!1}),a},setUpListeners:function(){this.on({"change:deleted":function(a){this.debug("change:deleted",this.includeDeleted,a.get("deleted")),!this.includeDeleted&&a.get("deleted")&&this.remove(a)},copied:function(a,b){this.setCurrent(new d(b,[]))},"set-as-current":function(a){var b=this.currentHistoryId;this.trigger("no-longer-current",b),this.currentHistoryId=a.id}})},sort:function(a){return a=a||{},this.setOrder(a.order),Backbone.Collection.prototype.sort.call(this,a)},setOrder:function(a){var b=this,c=this.sortOrders[a];if(!_.isUndefined(c))return b.order=a,b.comparator=function(a,d){var e=b.currentHistoryId;return a.id===e?-1:d.id===e?1:(a=c.getter(a),d=c.getter(d),c.asc?a===d?0:a>d?1:-1:a===d?0:a>d?-1:1)},b.trigger("changed-order",b.order,b),b},create:function(a,b,c){var e=this,f=jQuery.getJSON(Galaxy.root+"history/create_new_current");return f.done(function(a){e.setCurrent(new d(a,[],c||{}))})},setCurrent:function(a,b){return b=b||{},this.unshift(a,b),this.currentHistoryId=a.get("id"),b.silent||this.trigger("new-current",a,this),this},reset:function(a,b){return this.allFetched=!1,Backbone.Collection.prototype.reset.call(this,a,b)},toString:function(){return"HistoryCollection("+this.length+")"}});return{History:d,HistoryCollection:e}});
//# sourceMappingURL=../../../maps/mvc/history/history-model.js.map