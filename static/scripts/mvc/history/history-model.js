"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(exports,"__esModule",{value:!0});var _historyContents=require("mvc/history/history-contents"),_historyContents2=_interopRequireDefault(_historyContents),_historyPreferences=require("mvc/history/history-preferences"),_historyPreferences2=_interopRequireDefault(_historyPreferences),_controlledFetchCollection=require("mvc/base/controlled-fetch-collection"),_controlledFetchCollection2=_interopRequireDefault(_controlledFetchCollection),_utils=require("utils/utils"),_utils2=_interopRequireDefault(_utils),_baseMvc=require("mvc/base-mvc"),_baseMvc2=_interopRequireDefault(_baseMvc),_localization=require("utils/localization"),_localization2=_interopRequireDefault(_localization),History=Backbone.Model.extend(_baseMvc2.default.LoggableMixin).extend(_baseMvc2.default.mixin(_baseMvc2.default.SearchableModelMixin,{_logNamespace:"history",UPDATE_DELAY:4e3,defaults:{model_class:"History",id:null,name:"Unnamed History",state:"new",deleted:!1,contents_active:{},contents_states:{}},urlRoot:Galaxy.root+"api/histories",contentsClass:_historyContents2.default.HistoryContents,searchAttributes:["name","annotation","tags"],searchAliases:{title:"name",tag:"tags"},initialize:function(t,e){e=e||{},this.logger=e.logger||null,this.log(this+".initialize:",t,e),this.contents=new this.contentsClass([],{history:this,historyId:this.get("id"),order:e.order}),this._setUpListeners(),this._setUpCollectionListeners(),this.updateTimeoutId=null},_setUpListeners:function(){return this.on({error:function(t,e,i,n,r){this.clearUpdateTimeout()},"change:id":function(t,e){this.contents&&(this.contents.historyId=e)}})},_setUpCollectionListeners:function(){return this.contents?this.listenTo(this.contents,{error:function(){this.trigger.apply(this,jQuery.makeArray(arguments))}}):this},contentsShown:function(){var t=this.get("contents_active"),e=t.active||0;return e+=this.contents.includeDeleted?t.deleted:0,e+=this.contents.includeHidden?t.hidden:0},nice_size:function(){var t=this.get("size");return t?_utils2.default.bytesToString(t,!0,2):(0,_localization2.default)("(empty)")},toJSON:function(){return _.extend(Backbone.Model.prototype.toJSON.call(this),{nice_size:this.nice_size()})},get:function(t){return"nice_size"===t?this.nice_size():Backbone.Model.prototype.get.apply(this,arguments)},ownedByCurrUser:function(){return!(!Galaxy||!Galaxy.user)&&(!Galaxy.user.isAnonymous()&&Galaxy.user.id===this.get("user_id"))},numOfUnfinishedJobs:function(){var t=this.get("non_ready_jobs");return t?t.length:0},numOfUnfinishedShownContents:function(){return this.contents.runningAndActive().length||0},_fetchContentRelatedAttributes:function(){var t=["size","non_ready_jobs","contents_active","hid_counter"];return this.fetch({data:$.param({keys:t.join(",")})})},refresh:function(t){t=t||{};var e=this,i=e.lastUpdateTime;return this.contents.allFetched=!1,(0!==e.contents.currentPage?function(){return e.contents.fetchPage(e.contents.currentPage)}:function(){return e.contents.fetchUpdated(i)})().done(function(i,n,r){var o;try{o=new Date(r.getResponseHeader("Date"))}catch(t){}e.lastUpdateTime=o||new Date,e.checkForUpdates(t)})},checkForUpdates:function(t){function e(){n.clearUpdateTimeout(),n.updateTimeoutId=setTimeout(function(){n.refresh(t)},i)}t=t||{};var i=this.UPDATE_DELAY,n=this;n.id&&(this.numOfUnfinishedShownContents()>0?e():n._fetchContentRelatedAttributes().done(function(t){n.numOfUnfinishedJobs()>0?e():n.trigger("ready")}))},clearUpdateTimeout:function(){this.updateTimeoutId&&(clearTimeout(this.updateTimeoutId),this.updateTimeoutId=null)},parse:function(t,e){var i=Backbone.Model.prototype.parse.call(this,t,e);return i.create_time&&(i.create_time=new Date(i.create_time)),i.update_time&&(i.update_time=new Date(i.update_time)),i},fetchWithContents:function(t,e){var i=this;return(t=t||{}).view="dev-detailed",this.fetch(t).then(function(t){return i.contents.history=i,i.contents.setHistoryId(t.id),i.fetchContents(e)})},fetchContents:function(t){t=t||{};var e=this;return e.lastUpdateTime=new Date,e.contents.fetchCurrentPage(t)},_delete:function(t){return this.get("deleted")?jQuery.when():this.save({deleted:!0},t)},purge:function(t){return this.get("purged")?jQuery.when():this.save({deleted:!0,purged:!0},t)},undelete:function(t){return this.get("deleted")?this.save({deleted:!1},t):jQuery.when()},copy:function(t,e,i){if(t=void 0===t||t,!this.id)throw new Error("You must set the history ID before copying it.");var n={history_id:this.id};t&&(n.current=!0),e&&(n.name=e),i||(n.all_datasets=!1),n.view="dev-detailed";var r=this,o=jQuery.post(this.urlRoot,n);return t?o.then(function(t){return new History(t).setAsCurrent().done(function(){r.trigger("copied",r,t)})}):o.done(function(t){r.trigger("copied",r,t)})},setAsCurrent:function(){var t=this,e=jQuery.getJSON(Galaxy.root+"history/set_as_current?id="+this.id);return e.done(function(){t.trigger("set-as-current",t)}),e},toString:function(){return"History("+this.get("id")+","+this.get("name")+")"}})),_collectionSuper=_controlledFetchCollection2.default.InfinitelyScrollingCollection,HistoryCollection=_collectionSuper.extend(_baseMvc2.default.LoggableMixin).extend({_logNamespace:"history",model:History,order:"update_time",limitOnFirstFetch:10,limitPerFetch:10,initialize:function(t,e){e=e||{},this.log("HistoryCollection.initialize",t,e),_collectionSuper.prototype.initialize.call(this,t,e),this.includeDeleted=e.includeDeleted||!1,this.currentHistoryId=e.currentHistoryId,this.setUpListeners()},urlRoot:Galaxy.root+"api/histories",url:function(){return this.urlRoot},setUpListeners:function(){return this.on({"change:deleted":function(t){this.debug("change:deleted",this.includeDeleted,t.get("deleted")),!this.includeDeleted&&t.get("deleted")&&this.remove(t)},copied:function(t,e){this.setCurrent(new History(e,[]))},"set-as-current":function(t){var e=this.currentHistoryId;this.trigger("no-longer-current",e),this.currentHistoryId=t.id}})},_buildFetchData:function(t){return _.extend(_collectionSuper.prototype._buildFetchData.call(this,t),{view:"dev-detailed"})},_buildFetchFilters:function(t){var e=_collectionSuper.prototype._buildFetchFilters.call(this,t)||{},i={};return this.includeDeleted?i.deleted=null:(i.deleted=!1,i.purged=!1),_.defaults(e,i)},fetchFirst:function(t){var e=this,i=$.when();return this.currentHistoryId&&(i=_collectionSuper.prototype.fetchFirst.call(e,{silent:!0,limit:1,filters:{purged:"",deleted:"","encoded_id-in":this.currentHistoryId}})),i.then(function(){return t=t||{},t.offset=0,e.fetchMore(t)})},comparators:_.extend(_.clone(_collectionSuper.prototype.comparators),{name:_baseMvc2.default.buildComparator("name",{ascending:!0}),"name-dsc":_baseMvc2.default.buildComparator("name",{ascending:!1}),size:_baseMvc2.default.buildComparator("size",{ascending:!1}),"size-asc":_baseMvc2.default.buildComparator("size",{ascending:!0})}),sort:function(t){var e=(t=t||{}).silent,i=this.remove(this.get(this.currentHistoryId));return _collectionSuper.prototype.sort.call(this,_.defaults({silent:!0},t)),this.unshift(i,{silent:!0}),e||this.trigger("sort",this,t),this},create:function(t,e,i,n){var r=this;return jQuery.getJSON(Galaxy.root+"history/create_new_current").done(function(t){r.setCurrent(new History(t,[],i||{}))})},setCurrent:function(t,e){return e=e||{},this.unshift(t,e),this.currentHistoryId=t.get("id"),e.silent||this.trigger("new-current",t,this),this},toString:function(){return"HistoryCollection("+this.length+",current:"+this.currentHistoryId+")"}});exports.default={History:History,HistoryCollection:HistoryCollection};
//# sourceMappingURL=../../../maps/mvc/history/history-model.js.map
