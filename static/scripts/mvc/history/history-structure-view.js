"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(exports,"__esModule",{value:!0});var _jobDag=require("mvc/history/job-dag"),_jobDag2=_interopRequireDefault(_jobDag),_jobModel=require("mvc/job/job-model"),_jobModel2=_interopRequireDefault(_jobModel),_jobLi=require("mvc/job/job-li"),_jobLi2=_interopRequireDefault(_jobLi),_datasetLi=require("mvc/dataset/dataset-li"),_datasetLi2=_interopRequireDefault(_datasetLi),_baseMvc=require("mvc/base-mvc"),_baseMvc2=_interopRequireDefault(_baseMvc),_localization=require("utils/localization"),_localization2=_interopRequireDefault(_localization);require("libs/d3");var logNamespace="history";window.JobDAG=_jobDag2.default;var HistoryStructureComponent=Backbone.View.extend(_baseMvc2.default.LoggableMixin).extend({_logNamespace:logNamespace,className:"history-structure-component",_INITIAL_ZOOM_LEVEL:1,_MIN_ZOOM_LEVEL:.25,_LINK_ID_SEP:"-to-",_VERTEX_NAME_DATA_KEY:"vertex-name",JobItemClass:_jobLi2.default.JobListItemView,ContentItemClass:_datasetLi2.default.DatasetListItemView,initialize:function(t){this.log(this+"(HistoryStructureComponent).initialize:",t),this.component=t.component,this._liMap={},this._createVertexItems(),this.zoomLevel=t.zoomLevel||this._INITIAL_ZOOM_LEVEL,this.layout=this._createLayout(t.layoutOptions)},_createVertexItems:function(){var t=this;t.component.eachVertex(function(e){var o,i=e.data.job?"job":"copy";"job"===i?o=t._createJobListItem(e):"copy"===i&&(o=t._createContentListItem(e)),t._liMap[e.name]=o}),t.debug("_liMap:",t._liMap)},_createJobListItem:function(t){this.debug("_createJobListItem:",t);var e=this,o=t.data,i=new _jobModel2.default.Job(o.job),n=_.map(i.get("outputs"),function(t){return e.model.contents.get(t.type_id)});i.outputCollection.reset(n),i.outputCollection.historyId=e.model.id;var a=new e.JobItemClass({model:i,tool:o.tool,jobData:o});return e.listenTo(a,"expanding expanded collapsing collapsed",e.renderGraph),e.listenTo(a.foldout,"view:expanding view:expanded view:collapsing view:collapsed",e.renderGraph),a},_createContentListItem:function(t){this.debug("_createContentListItem:",t);var e=this,o=t.data;o=e.model.contents.get(o.type_id);var i=new e.ContentItemClass({model:o});return e.listenTo(i,"expanding expanded collapsing collapsed",e.renderGraph),i},layoutDefaults:{linkSpacing:16,linkWidth:0,linkHeight:0,jobWidth:300,jobHeight:300,jobSpacing:12,linkAdjX:4,linkAdjY:0},_createLayout:function(t){t=_.defaults(_.clone(t||{}),this.layoutDefaults);var e=this,o=_.values(e.component.vertices),i=_.extend(t,{nodeMap:{},links:[],svg:{width:0,height:0}});return o.forEach(function(t,e){var o={name:t.name,x:0,y:0};i.nodeMap[t.name]=o}),e.component.edges(function(t){var e={source:t.source,target:t.target};i.links.push(e)}),i},render:function(t){this.debug(this+".render:",t);var e=this;e.$el.html(["<header></header>",'<nav class="controls"></nav>','<figure class="graph"></figure>',"<footer></footer>"].join(""));var o=e.$graph();return e.component.eachVertex(function(t){e._liMap[t.name].render(0).$el.appendTo(o).data(e._VERTEX_NAME_DATA_KEY,t.name)}),e.renderGraph(),this},$graph:function(){return this.$(".graph")},renderGraph:function(t){function e(){o._updateLayout(),o.$graph().css("transform",["scale(",o.zoomLevel,",",o.zoomLevel,")"].join("")).width(o.layout.svg.width).height(o.layout.svg.height),o.renderSVG(),o.component.eachVertex(function(t){var e=o._liMap[t.name],i=o.layout.nodeMap[t.name];e.$el.css({top:i.y,left:i.x})})}this.debug(this+".renderGraph:",t);var o=this;return this.$el.is(":visible")?e():_.delay(e,0),this},_updateLayout:function(){this.debug(this+"._updateLayout:");var t=this.layout;t.linkHeight=t.linkSpacing*_.size(t.nodeMap),t.svg.height=t.linkHeight+t.jobHeight,t.svg.width=0;var e=0,o=t.linkHeight;return _.each(t.nodeMap,function(i,n){i.x=e,i.y=o,e+=t.jobWidth+t.jobSpacing}),t.svg.width=t.linkWidth=Math.max(t.svg.width,e),t.links.forEach(function(e){var o=t.nodeMap[e.source],i=t.nodeMap[e.target];e.x1=o.x+t.linkAdjX,e.y1=o.y+t.linkAdjY,e.x2=i.x+t.linkAdjX,e.y2=i.y+t.linkAdjY}),this.debug(JSON.stringify(t,null,"  ")),this.layout},renderSVG:function(){this.debug(this+".renderSVG:");var t=this,e=t.layout,o=d3.select(this.$graph().get(0)).select("svg");o.empty()&&(o=d3.select(this.$graph().get(0)).append("svg")),o.attr("width",e.svg.width).attr("height",e.svg.height);var i=o.selectAll(".connection").data(e.links);return i.enter().append("path").attr("class","connection").attr("id",function(e){return[e.source,e.target].join(t._LINK_ID_SEP)}).on("mouseover",function(e){d3.select(this).classed("highlighted",!0),t._liMap[e.source].$el.addClass("highlighted"),t._liMap[e.target].$el.addClass("highlighted")}).on("mouseout",function(e){d3.select(this).classed("highlighted",!1),t._liMap[e.source].$el.removeClass("highlighted"),t._liMap[e.target].$el.removeClass("highlighted")}),i.attr("d",function(e){return t._connectionPath(e)}),o.node()},_connectionPath:function(t){var e=(t.x2-t.x1)/this.layout.svg.width*this.layout.linkHeight;return["M",t.x1,",",t.y1," ","C",t.x1+0,",",t.y1-e," ",t.x2-0,",",t.y2-e," ",t.x2,",",t.y2].join("")},events:{"mouseover .graph > .list-item":function(t){this.highlightConnected(t.currentTarget,!0)},"mouseout  .graph > .list-item":function(t){this.highlightConnected(t.currentTarget,!1)}},highlightConnected:function(t,e){this.debug("highlightConnected",t,e),e=void 0===e||e;var o=this,i=o.component,n=e?jQuery.prototype.addClass:jQuery.prototype.removeClass,a=e?"connection highlighted":"connection",r=n.call($(t),"highlighted").data(o._VERTEX_NAME_DATA_KEY);i.edges({target:r}).forEach(function(t){var e=t.source,i=o._liMap[e];n.call(i.$el,"highlighted"),o.$("#"+e+o._LINK_ID_SEP+r).attr("class",a)}),i.vertices[r].eachEdge(function(t){var e=t.target,i=o._liMap[e];n.call(i.$el,"highlighted"),o.$("#"+r+o._LINK_ID_SEP+e).attr("class",a)})},zoom:function(t){return this.zoomLevel=Math.min(1,Math.max(this._MIN_ZOOM_LEVEL,t)),this.renderGraph()},toString:function(){return"HistoryStructureComponent("+this.model.id+")"}}),VerticalHistoryStructureComponent=HistoryStructureComponent.extend({className:HistoryStructureComponent.prototype.className+" vertical",layoutDefaults:_.extend(_.clone(HistoryStructureComponent.prototype.layoutDefaults),{linkAdjX:0,linkAdjY:4}),_updateLayout:function(){this.debug(this+"._updateLayout:");var t=this,e=t.layout;e.linkWidth=e.linkSpacing*_.size(e.nodeMap),e.svg.width=e.linkWidth+e.jobWidth,e.svg.height=0;var o=e.linkWidth,i=0;return _.each(e.nodeMap,function(n,a){n.x=o,n.y=i;var r=t._liMap[a];i+=r.$el.height()+e.jobSpacing}),e.linkHeight=e.svg.height=Math.max(e.svg.height,i),e.links.forEach(function(t){var o=e.nodeMap[t.source],i=e.nodeMap[t.target];t.x1=o.x+e.linkAdjX,t.y1=o.y+e.linkAdjY,t.x2=i.x+e.linkAdjX,t.y2=i.y+e.linkAdjY}),this.debug(JSON.stringify(e,null,"  ")),e},_connectionPath:function(t){var e=(t.y2-t.y1)/this.layout.svg.height*this.layout.linkWidth;return["M",t.x1,",",t.y1," ","C",t.x1-e,",",t.y1+0," ",t.x2-e,",",t.y2-0," ",t.x2,",",t.y2].join("")},toString:function(){return"VerticalHistoryStructureComponent("+this.model.id+")"}}),HistoryStructureView=Backbone.View.extend(_baseMvc2.default.LoggableMixin).extend({_logNamespace:logNamespace,className:"history-structure",_layoutToComponentClass:{horizontal:HistoryStructureComponent,vertical:VerticalHistoryStructureComponent},_DEFAULT_LAYOUT:"vertical",initialize:function(t){this.layout=_.contains(t.layout,_.keys(this._layoutToComponentClass))?t.layout:this._DEFAULT_LAYOUT,this.log(this+"(HistoryStructureView).initialize:",t,this.model),this._processTools(t.tools),this._processJobs(t.jobs),this._createDAG()},_processTools:function(t){return this.tools=t||{},this.tools},_processJobs:function(t){return this.jobs=t||[],this.jobs},_createDAG:function(){this.dag=new _jobDag2.default({historyContents:this.model.contents.toJSON(),tools:this.tools,jobs:this.jobs,excludeSetMetadata:!0,excludeErroredJobs:!0}),this.debug(this+".dag:",this.dag),this._createComponents()},_createComponents:function(){this.log(this+"._createComponents");var t=this;return t.componentViews=t.dag.weakComponentGraphArray().map(function(e){return t._createComponent(e)}),t.componentViews},_createComponent:function(t){return this.log(this+"._createComponent:",t),new(0,this._layoutToComponentClass[this.layout])({model:this.model,component:t})},render:function(t){this.log(this+".render:",t);var e=this;return e.$el.addClass("clear").html(['<div class="controls"></div>','<div class="components"></div>'].join("")),e.componentViews.forEach(function(t){t.render().$el.appendTo(e.$components())}),e},$components:function(){return this.$(".components")},changeLayout:function(t){if(!(t in this._layoutToComponentClass))throw new Error(this+": unknown layout: "+t);return this.layout=t,this._createComponents(),this.render()},toString:function(){return"HistoryStructureView("+this.model.id+")"}});exports.default=HistoryStructureView;
//# sourceMappingURL=../../../maps/mvc/history/history-structure-view.js.map
