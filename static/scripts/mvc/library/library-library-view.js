define(["libs/toastr","mvc/library/library-model","mvc/ui/ui-select"],function(t,e,s){return{LibraryView:Backbone.View.extend({el:"#center",model:null,options:{},events:{"click .toolbtn_save_permissions":"savePermissions"},initialize:function(t){this.options=_.extend(this.options,t),this.options.id&&this.fetchLibrary()},fetchLibrary:function(s){this.options=_.extend(this.options,s),this.model=new e.Library({id:this.options.id});var i=this;this.model.fetch({success:function(){i.options.show_permissions?i.showPermissions():i.render()},error:function(e,s){void 0!==s.responseJSON?t.error(s.responseJSON.err_msg+" Click this to go back.","",{onclick:function(){Galaxy.libraries.library_router.back()}}):t.error("An error ocurred. Click this to go back.","",{onclick:function(){Galaxy.libraries.library_router.back()}})}})},render:function(t){$(".tooltip").remove(),this.options=_.extend(this.options,t);var e=this.templateLibrary();this.$el.html(e({item:this.model})),$("#center [data-toggle]").tooltip()},shareDataset:function(){t.info("Feature coming soon.")},goBack:function(){Galaxy.libraries.library_router.back()},showPermissions:function(e){this.options=_.extend(this.options,e),$(".tooltip").remove(),void 0!==this.options.fetched_permissions&&(0===this.options.fetched_permissions.access_library_role_list.length?this.model.set({is_unrestricted:!0}):this.model.set({is_unrestricted:!1}));var s=!1;Galaxy.user&&(s=Galaxy.user.isAdmin());var i=this.templateLibraryPermissions();this.$el.html(i({library:this.model,is_admin:s}));var a=this;$.get(Galaxy.root+"api/libraries/"+a.id+"/permissions?scope=current").done(function(t){a.prepareSelectBoxes({fetched_permissions:t})}).fail(function(){t.error("An error occurred while attempting to fetch library permissions.")}),$("#center [data-toggle]").tooltip(),$("#center").css("overflow","auto")},_serializeRoles:function(t){for(var e=[],s=0;s<t.length;s++)e.push(t[s][1]+":"+t[s][0]);return e},prepareSelectBoxes:function(t){this.options=_.extend(this.options,t);var e=this.options.fetched_permissions,i=this,a=this._serializeRoles(e.access_library_role_list),o=this._serializeRoles(e.add_library_item_role_list),r=this._serializeRoles(e.manage_library_role_list),n=this._serializeRoles(e.modify_library_role_list);i.accessSelectObject=new s.View(this._createSelectOptions(this,"access_perm",a,!0)),i.addSelectObject=new s.View(this._createSelectOptions(this,"add_perm",o,!1)),i.manageSelectObject=new s.View(this._createSelectOptions(this,"manage_perm",r,!1)),i.modifySelectObject=new s.View(this._createSelectOptions(this,"modify_perm",n,!1))},_createSelectOptions:function(t,e,s,i){return i=!0===i&&i,{minimumInputLength:0,css:e,multiple:!0,placeholder:"Click to select a role",container:t.$el.find("#"+e),ajax:{url:Galaxy.root+"api/libraries/"+t.id+"/permissions?scope=available&is_library_access="+i,dataType:"json",quietMillis:100,data:function(t,e){return{q:t,page_limit:10,page:e}},results:function(t,e){var s=10*e<t.total;return{results:t.roles,more:s}}},formatResult:function(t){return t.name+" type: "+t.type},formatSelection:function(t){return t.name},initSelection:function(t,e){var s=[];$(t.val().split(",")).each(function(){var t=this.split(":");s.push({id:t[0],name:t[1]})}),e(s)},initialData:s,dropdownCssClass:"bigdrop"}},comingSoon:function(){t.warning("Feature coming soon.")},copyToClipboard:function(){var t=Backbone.history.location.href;-1!==t.lastIndexOf("/permissions")&&(t=t.substr(0,t.lastIndexOf("/permissions"))),window.prompt("Copy to clipboard: Ctrl+C, Enter",t)},makeDatasetPrivate:function(){var e=this;$.post(Galaxy.root+"api/libraries/datasets/"+e.id+"/permissions?action=make_private").done(function(s){e.model.set({is_unrestricted:!1}),e.showPermissions({fetched_permissions:s}),t.success("The dataset is now private to you.")}).fail(function(){t.error("An error occurred while attempting to make dataset private.")})},removeDatasetRestrictions:function(){var e=this;$.post(Galaxy.root+"api/libraries/datasets/"+e.id+"/permissions?action=remove_restrictions").done(function(s){e.model.set({is_unrestricted:!0}),e.showPermissions({fetched_permissions:s}),t.success("Access to this dataset is now unrestricted.")}).fail(function(){t.error("An error occurred while attempting to make dataset unrestricted.")})},_extractIds:function(t){ids_list=[];for(var e=t.length-1;e>=0;e--)ids_list.push(t[e].id);return ids_list},savePermissions:function(e){var s=this,i=this._extractIds(this.accessSelectObject.$el.select2("data")),a=this._extractIds(this.addSelectObject.$el.select2("data")),o=this._extractIds(this.manageSelectObject.$el.select2("data")),r=this._extractIds(this.modifySelectObject.$el.select2("data"));$.post(Galaxy.root+"api/libraries/"+s.id+"/permissions?action=set_permissions",{"access_ids[]":i,"add_ids[]":a,"manage_ids[]":o,"modify_ids[]":r}).done(function(e){s.showPermissions({fetched_permissions:e}),t.success("Permissions saved.")}).fail(function(){t.error("An error occurred while attempting to set library permissions.")})},templateLibrary:function(){return _.template(['<div class="library_style_container">','<div id="library_toolbar">','<button data-toggle="tooltip" data-placement="top" title="Modify library item" class="btn btn-default toolbtn_modify_dataset primary-button" type="button">','<span class="fa fa-pencil"/>',"&nbsp;Modify","</button>",'<a href="#folders/<%- item.get("folder_id") %>/datasets/<%- item.id %>/permissions">','<button data-toggle="tooltip" data-placement="top" title="Manage permissions" class="btn btn-default toolbtn_change_permissions primary-button" type="button">','<span class="fa fa-group"/>',"&nbsp;Permissions","</button>","</a>",'<button data-toggle="tooltip" data-placement="top" title="Share dataset" class="btn btn-default toolbtn-share-dataset primary-button" type="button">','<span class="fa fa-share"/>',"&nbsp;Share","</button>","</div>","<p>","This dataset is unrestricted so everybody can access it. Just share the URL of this page. ",'<button data-toggle="tooltip" data-placement="top" title="Copy to clipboard" class="btn btn-default btn-copy-link-to-clipboard primary-button" type="button">','<span class="fa fa-clipboard"/>',"&nbsp;To Clipboard","</button> ","</p>",'<div class="dataset_table">','<table class="grid table table-striped table-condensed">',"<tr>",'<th scope="row" id="id_row" data-id="<%= _.escape(item.get("ldda_id")) %>">',"Name","</th>","<td>",'<%= _.escape(item.get("name")) %>',"</td>","</tr>",'<% if (item.get("file_ext")) { %>',"<tr>",'<th scope="row">Data type</th>',"<td>",'<%= _.escape(item.get("file_ext")) %>',"</td>","</tr>","<% } %>","</table>","</div>","</div>"].join(""))},templateLibraryPermissions:function(){return _.template(['<div class="library_style_container">','<div id="library_toolbar">','<a href="#">','<button data-toggle="tooltip" data-placement="top" title="Go back to the list of Libraries" class="btn btn-default primary-button" type="button">','<span class="fa fa-list"/>',"&nbsp;Libraries","</button>","</a>","</div>","<h1>",'Library: <%= _.escape(library.get("name")) %>',"</h1>",'<div class="alert alert-warning">',"<% if (is_admin) { %>","You are logged in as an <strong>administrator</strong> therefore you can manage any library on this Galaxy instance. Please make sure you understand the consequences.","<% } else { %>","You can assign any number of roles to any of the following permission types. However please read carefully the implications of such actions.","<% }%>","</div>",'<div class="dataset_table">',"<h2>Library permissions</h2>","<h4>Roles that can access the library</h4>",'<div id="access_perm" class="access_perm roles-selection"/>','<div class="alert alert-info roles-selection">',"User with <strong>any</strong> of these roles can access this library. If there are no access roles set on the library it is considered <strong>unrestricted</strong>.","</div>","<h4>Roles that can manage permissions on this library</h4>",'<div id="manage_perm" class="manage_perm roles-selection"/>','<div class="alert alert-info roles-selection">',"User with <strong>any</strong> of these roles can manage permissions on this library (includes giving access).","</div>","<h4>Roles that can add items to this library</h4>",'<div id="add_perm" class="add_perm roles-selection"/>','<div class="alert alert-info roles-selection">',"User with <strong>any</strong> of these roles can add items to this library (folders and datasets).","</div>","<h4>Roles that can modify this library</h4>",'<div id="modify_perm" class="modify_perm roles-selection"/>','<div class="alert alert-info roles-selection">',"User with <strong>any</strong> of these roles can modify this library (name, synopsis, etc.).","</div>",'<button data-toggle="tooltip" data-placement="top" title="Save modifications made on this page" class="btn btn-default toolbtn_save_permissions primary-button" type="button">','<span class="fa fa-floppy-o"/>',"&nbsp;Save","</button>","</div>","</div>"].join(""))}})}});
//# sourceMappingURL=../../../maps/mvc/library/library-library-view.js.map
