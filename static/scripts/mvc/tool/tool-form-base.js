"use strict";define(["utils/utils","utils/deferred","mvc/ui/ui-misc","mvc/form/form-view","mvc/citation/citation-model","mvc/citation/citation-view"],function(e,t,i,o,n,r){return o.extend({initialize:function(e){var i=this;this.deferred=new t,o.prototype.initialize.call(this,e),this.model.get("inputs")?this._buildForm(this.model.attributes):this.deferred.execute(function(e){i._buildModel(e,i.model.attributes,!0)}),this.model.get("listen_to_history")&&parent.Galaxy&&parent.Galaxy.currHistoryPanel&&this.listenTo(parent.Galaxy.currHistoryPanel.collection,"change",function(){i.model.get("onchange")()}),this.$el.on("remove",function(){i._destroy()})},_destroy:function(){var e=this;this.$el.off().hide(),this.deferred.execute(function(){o.prototype.remove.call(e),Galaxy.emit.debug("tool-form-base::_destroy()","Destroy view.")})},_buildForm:function(e){var t=this;this.model.set(e),this.model.set({title:e.title||"<b>"+e.name+"</b> "+e.description+" (Galaxy Version "+e.version+")",operations:!this.model.get("hide_operations")&&this._operations(),onchange:function(){t.deferred.reset(),t.deferred.execute(function(e){t.model.get("postchange")(e,t)})}}),this.model.get("customize")&&this.model.get("customize")(this),this.render(),this.model.get("collapsible")||this.$el.append($("<div/>").addClass("ui-margin-top-large").append(this._footer()))},_buildModel:function(t,o,n){var r=this,a=this.model.attributes;a.version=o.version,a.id=o.id;var s="",l={},d="";o.job_id?d=o.job_id:a.job_id&&(d=a.job_id),d?s=Galaxy.root+"api/jobs/"+d+"/build_for_rerun":(s=Galaxy.root+"api/tools/"+a.id+"/build",l=$.extend({},Galaxy.params),l.tool_id&&delete l.tool_id),a.version&&(l.tool_version=a.version),e.get({url:s,data:l,success:function(e){if(!e.display)return void(window.location=Galaxy.root);r._buildForm(e),!n&&r.message.update({status:"success",message:"Now you are using '"+a.name+"' version "+a.version+", id '"+a.id+"'.",persistent:!1}),Galaxy.emit.debug("tool-form-base::_buildModel()","Initial tool model ready.",e),t.resolve()},error:function(e,o){var n=e&&e.err_msg||"Uncaught error.";401==o?window.location=Galaxy.root+"user/login?"+$.param({redirect:Galaxy.root+"?tool_id="+a.id}):r.$el.is(":empty")?r.$el.prepend(new i.Message({message:n,status:"danger",persistent:!0,large:!0}).$el):Galaxy.modal&&Galaxy.modal.show({title:"Tool request failed",body:n,buttons:{Close:function(){Galaxy.modal.hide()}}}),Galaxy.emit.debug("tool-form-base::_buildModel()","Initial tool model request failed.",e),t.reject()}})},_operations:function(){var t=this,o=this.model.attributes,n=new i.ButtonMenu({icon:"fa-cubes",title:!o.narrow&&"Versions"||null,tooltip:"Select another tool version"});if(!o.sustain_version&&o.versions&&o.versions.length>1)for(var r in o.versions){var a=o.versions[r];a!=o.version&&n.addMenu({title:"Switch to "+a,version:a,icon:"fa-cube",onclick:function(){var e=o.id.replace(o.version,this.version),i=this.version;t.deferred.reset(),t.deferred.execute(function(n){o.hasOwnProperty("workflow")?(o.version=i,t.model.get("postchange")(n,t)):t._buildModel(n,{id:e,version:i})})}})}else n.$el.hide();var s=new i.ButtonMenu({icon:"fa-caret-down",title:!o.narrow&&"Options"||null,tooltip:"View available options"});return o.biostar_url&&(s.addMenu({icon:"fa-question-circle",title:"Question?",onclick:function(){window.open(o.biostar_url+"/p/new/post/")}}),s.addMenu({icon:"fa-search",title:"Search",onclick:function(){window.open(o.biostar_url+"/local/search/page/?q="+o.name)}})),s.addMenu({icon:"fa-share",title:"Share",onclick:function(){prompt("Copy to clipboard: Ctrl+C, Enter",window.location.origin+Galaxy.root+"root?tool_id="+o.id)}}),Galaxy.user&&Galaxy.user.get("is_admin")&&(s.addMenu({icon:"fa-download",title:"Download",onclick:function(){window.location.href=Galaxy.root+"api/tools/"+o.id+"/download"}}),s.addMenu({icon:"fa-refresh",title:"Reload XML",onclick:function(){e.get({url:Galaxy.root+"api/tools/"+o.id+"/reload",success:function(e){t.message.update({persistent:!1,message:"Tool XML has been reloaded.",status:"success"})},error:function(e){t.message.update({persistent:!1,message:e.err_msg,status:"danger"})}})}})),o.requirements&&o.requirements.length>0&&s.addMenu({icon:"fa-info-circle",title:"Requirements",onclick:function(){!this.requirements_visible||t.portlet.collapsed?(this.requirements_visible=!0,t.portlet.expand(),t.message.update({persistent:!0,message:t._templateRequirements(o),status:"info"})):(this.requirements_visible=!1,t.message.update({message:""}))}}),o.sharable_url&&s.addMenu({icon:"fa-external-link",title:"See in Tool Shed",onclick:function(){window.open(o.sharable_url)}}),$.getJSON("/api/webhooks/tool-menu/all",function(e){_.each(e,function(e){e.activate&&e.config.function&&s.addMenu({icon:e.config.icon,title:e.config.title,onclick:function(){new Function("options",e.config.function)(o)}})})}),{menu:s,versions:n}},_footer:function(){var e=this.model.attributes,t=$("<div/>").append(this._templateHelp(e));if(e.citations){var i=$("<div/>"),o=new n.ToolCitationCollection;o.tool_id=e.id;new r.CitationListView({el:i,collection:o}).render(),o.fetch(),t.append(i)}return t},_templateHelp:function(e){var t=$("<div/>").addClass("ui-form-help").append(e.help);return t.find("a").attr("target","_blank"),t},_templateRequirements:function(e){var t=e.requirements.length;if(t>0){var i="This tool requires ";_.each(e.requirements,function(e,o){i+=e.name+(e.version?" (Version "+e.version+")":"")+(o<t-2?", ":o==t-2?" and ":"")});var o=$("<a/>").attr("target","_blank").attr("href","https://galaxyproject.org/tools/requirements/").text("here");return $("<span/>").append(i+". Click ").append(o).append(" for more information.")}return"No requirements found."}})});
//# sourceMappingURL=../../../maps/mvc/tool/tool-form-base.js.map
