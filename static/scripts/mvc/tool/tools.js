"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _underscore=require("libs/underscore"),_underscore2=_interopRequireDefault(_underscore),_util=require("viz/trackster/util"),_util2=_interopRequireDefault(_util),_data=require("mvc/dataset/data"),_data2=_interopRequireDefault(_data),_toolForm=require("mvc/tool/tool-form"),_toolForm2=_interopRequireDefault(_toolForm),VisibilityMixin={hidden:!1,show:function(){this.set("hidden",!1)},hide:function(){this.set("hidden",!0)},toggle:function(){this.set("hidden",!this.get("hidden"))},is_visible:function(){return!this.attributes.hidden}},ToolParameter=Backbone.Model.extend({defaults:{name:null,label:null,type:null,value:null,html:null,num_samples:5},initialize:function(e){this.attributes.html=unescape(this.attributes.html)},copy:function(){return new ToolParameter(this.toJSON())},set_value:function(e){this.set("value",e||"")}}),ToolParameterCollection=Backbone.Collection.extend({model:ToolParameter}),DataToolParameter=ToolParameter.extend({}),IntegerToolParameter=ToolParameter.extend({set_value:function(e){this.set("value",parseInt(e,10))},get_samples:function(){return d3.scale.linear().domain([this.get("min"),this.get("max")]).ticks(this.get("num_samples"))}}),FloatToolParameter=IntegerToolParameter.extend({set_value:function(e){this.set("value",parseFloat(e))}}),SelectToolParameter=ToolParameter.extend({get_samples:function(){return _underscore2.default.map(this.get("options"),function(e){return e[0]})}});ToolParameter.subModelTypes={integer:IntegerToolParameter,float:FloatToolParameter,data:DataToolParameter,select:SelectToolParameter};var Tool=Backbone.Model.extend({defaults:{id:null,name:null,description:null,target:null,inputs:[],outputs:[]},urlRoot:Galaxy.root+"api/tools",initialize:function(e){this.set("inputs",new ToolParameterCollection(_underscore2.default.map(e.inputs,function(e){return new(ToolParameter.subModelTypes[e.type]||ToolParameter)(e)})))},toJSON:function(){var e=Backbone.Model.prototype.toJSON.call(this);return e.inputs=this.get("inputs").map(function(e){return e.toJSON()}),e},remove_inputs:function(e){var t=this,o=t.get("inputs").filter(function(t){return-1!==e.indexOf(t.get("type"))});t.get("inputs").remove(o)},copy:function(e){var t=new Tool(this.toJSON());if(e){var o=new Backbone.Collection;t.get("inputs").each(function(e){e.get_samples()&&o.push(e)}),t.set("inputs",o)}return t},apply_search_results:function(e){return-1!==_underscore2.default.indexOf(e,this.attributes.id)?this.show():this.hide(),this.is_visible()},set_input_value:function(e,t){this.get("inputs").find(function(t){return t.get("name")===e}).set("value",t)},set_input_values:function(e){var t=this;_underscore2.default.each(_underscore2.default.keys(e),function(o){t.set_input_value(o,e[o])})},run:function(){return this._run()},rerun:function(e,t){return this._run({action:"rerun",target_dataset_id:e.id,regions:t})},get_inputs_dict:function(){var e={};return this.get("inputs").each(function(t){e[t.get("name")]=t.get("value")}),e},_run:function(e){var t=_underscore2.default.extend({tool_id:this.id,inputs:this.get_inputs_dict()},e),o=$.Deferred(),i=new _util2.default.ServerStateDeferred({ajax_settings:{url:this.urlRoot,data:JSON.stringify(t),dataType:"json",contentType:"application/json",type:"POST"},interval:2e3,success_fn:function(e){return"pending"!==e}});return $.when(i.go()).then(function(e){o.resolve(new _data2.default.DatasetCollection(e))}),o}});_underscore2.default.extend(Tool.prototype,VisibilityMixin);var ToolView=Backbone.View.extend({}),ToolCollection=Backbone.Collection.extend({model:Tool}),ToolSectionLabel=Backbone.Model.extend(VisibilityMixin),ToolSection=Backbone.Model.extend({defaults:{elems:[],open:!1},clear_search_results:function(){_underscore2.default.each(this.attributes.elems,function(e){e.show()}),this.show(),this.set("open",!1)},apply_search_results:function(e){var t,o=!0;_underscore2.default.each(this.attributes.elems,function(i){i instanceof ToolSectionLabel?(t=i).hide():i instanceof Tool&&i.apply_search_results(e)&&(o=!1,t&&t.show())}),o?this.hide():(this.show(),this.set("open",!0))}});_underscore2.default.extend(ToolSection.prototype,VisibilityMixin);var ToolSearch=Backbone.Model.extend({defaults:{search_hint_string:"search tools",min_chars_for_search:3,clear_btn_url:"",visible:!0,query:"",results:null,clear_key:27},urlRoot:Galaxy.root+"api/tools",initialize:function(){this.on("change:query",this.do_search)},do_search:function(){var e=this.attributes.query;if(e.length<this.attributes.min_chars_for_search)this.set("results",null);else{var t=e;this.timer&&clearTimeout(this.timer),$("#search-clear-btn").hide(),$("#search-spinner").show();var o=this;this.timer=setTimeout(function(){"undefined"!=typeof ga&&ga("send","pageview",Galaxy.root+"?q="+t),$.get(o.urlRoot,{q:t},function(e){o.set("results",e),$("#search-spinner").hide(),$("#search-clear-btn").show()},"json")},400)}},clear_search:function(){this.set("query",""),this.set("results",null)}});_underscore2.default.extend(ToolSearch.prototype,VisibilityMixin);var ToolPanel=Backbone.Model.extend({initialize:function(e){this.attributes.tool_search=e.tool_search,this.attributes.tool_search.on("change:results",this.apply_search_results,this),this.attributes.tools=e.tools,this.attributes.layout=new Backbone.Collection(this.parse(e.layout))},parse:function(e){var t=this;return _underscore2.default.map(e,function e(o){var i=o.model_class;if(i.indexOf("Tool")===i.length-4)return t.attributes.tools.get(o.id);if("ToolSection"===i){var l=_underscore2.default.map(o.elems,e);return o.elems=l,new ToolSection(o)}return"ToolSectionLabel"===i?new ToolSectionLabel(o):void 0})},clear_search_results:function(){this.get("layout").each(function(e){e instanceof ToolSection?e.clear_search_results():e.show()})},apply_search_results:function(){var e=this.get("tool_search").get("results");if(null!==e){var t=null;this.get("layout").each(function(o){o instanceof ToolSectionLabel?(t=o).hide():o instanceof Tool?o.apply_search_results(e)&&t&&t.show():(t=null,o.apply_search_results(e))})}else this.clear_search_results()}}),BaseView=Backbone.View.extend({initialize:function(){this.model.on("change:hidden",this.update_visible,this),this.update_visible()},update_visible:function(){this.model.attributes.hidden?this.$el.hide():this.$el.show()}}),ToolLinkView=BaseView.extend({tagName:"div",render:function(){var e=$("<div/>");e.append(templates.tool_link(this.model.toJSON()));var t=this.model.get("form_style",null);if("upload1"===this.model.id)e.find("a").on("click",function(e){e.preventDefault(),Galaxy.upload.show()});else if("regular"===t){var o=this;e.find("a").on("click",function(e){e.preventDefault(),Galaxy.router.push("/",{tool_id:o.model.id,version:o.model.get("version")})})}return this.$el.append(e),this}}),ToolSectionLabelView=BaseView.extend({tagName:"div",className:"toolPanelLabel",render:function(){return this.$el.append($("<span/>").text(this.model.attributes.text)),this}}),ToolSectionView=BaseView.extend({tagName:"div",className:"toolSectionWrapper",initialize:function(){BaseView.prototype.initialize.call(this),this.model.on("change:open",this.update_open,this)},render:function(){this.$el.append(templates.panel_section(this.model.toJSON()));var e=this.$el.find(".toolSectionBody");return _underscore2.default.each(this.model.attributes.elems,function(t){if(t instanceof Tool){var o=new ToolLinkView({model:t,className:"toolTitle"});o.render(),e.append(o.$el)}else if(t instanceof ToolSectionLabel){var i=new ToolSectionLabelView({model:t});i.render(),e.append(i.$el)}}),this},events:{"click .toolSectionTitle > a":"toggle"},toggle:function(){this.model.set("open",!this.model.attributes.open)},update_open:function(){this.model.attributes.open?this.$el.children(".toolSectionBody").slideDown("fast"):this.$el.children(".toolSectionBody").slideUp("fast")}}),ToolSearchView=Backbone.View.extend({tagName:"div",id:"tool-search",className:"bar",events:{click:"focus_and_select","keyup :input":"query_changed","change :input":"query_changed","click #search-clear-btn":"clear"},render:function(){return this.$el.append(templates.tool_search(this.model.toJSON())),this.model.is_visible()||this.$el.hide(),$("#messagebox").is(":visible")&&this.$el.css("top","95px"),this.$el.find("[title]").tooltip(),this},focus_and_select:function(){this.$el.find(":input").focus().select()},clear:function(){return this.model.clear_search(),this.$el.find(":input").val(""),this.focus_and_select(),!1},query_changed:function(e){if(this.model.attributes.clear_key&&this.model.attributes.clear_key===e.which)return this.clear(),!1;this.model.set("query",this.$el.find(":input").val())}}),ToolPanelView=Backbone.View.extend({tagName:"div",className:"toolMenu",initialize:function(){this.model.get("tool_search").on("change:results",this.handle_search_results,this)},render:function(){var e=this,t=new ToolSearchView({model:this.model.get("tool_search")});return t.render(),e.$el.append(t.$el),this.model.get("layout").each(function(t){if(t instanceof ToolSection){var o=new ToolSectionView({model:t});o.render(),e.$el.append(o.$el)}else if(t instanceof Tool){var i=new ToolLinkView({model:t,className:"toolTitleNoSection"});i.render(),e.$el.append(i.$el)}else if(t instanceof ToolSectionLabel){var l=new ToolSectionLabelView({model:t});l.render(),e.$el.append(l.$el)}}),e.$el.find("a.tool-link").click(function(t){var o=$(this).attr("class").split(/\s+/)[0],i=e.model.get("tools").get(o);e.trigger("tool_link_click",t,i)}),this},handle_search_results:function(){var e=this.model.get("tool_search").get("results");e&&0===e.length?$("#search-no-results").show():$("#search-no-results").hide()}}),ToolFormView=Backbone.View.extend({className:"toolForm",render:function(){this.$el.children().remove(),this.$el.append(templates.tool_form(this.model.toJSON()))}}),IntegratedToolMenuAndView=Backbone.View.extend({className:"toolMenuAndView",initialize:function(){this.tool_panel_view=new ToolPanelView({collection:this.collection}),this.tool_form_view=new ToolFormView},render:function(){this.tool_panel_view.render(),this.tool_panel_view.$el.css("float","left"),this.$el.append(this.tool_panel_view.$el),this.tool_form_view.$el.hide(),this.$el.append(this.tool_form_view.$el);var e=this;this.tool_panel_view.on("tool_link_click",function(t,o){t.preventDefault(),e.show_tool(o)})},show_tool:function(e){var t=this;e.fetch().done(function(){t.tool_form_view.model=e,t.tool_form_view.render(),t.tool_form_view.$el.show(),$("#left").width("650px")})}}),templates={tool_search:_underscore2.default.template(['<input id="tool-search-query" class="search-query parent-width" name="query" ','placeholder="<%- search_hint_string %>" autocomplete="off" type="text" />','<a id="search-clear-btn" title="clear search (esc)"> </a>','<span id="search-spinner" class="search-spinner fa fa-spinner fa-spin"></span>'].join("")),panel_section:_underscore2.default.template(['<div class="toolSectionTitle" id="title_<%- id %>">','<a href="javascript:void(0)"><span><%- name %></span></a>',"</div>",'<div id="<%- id %>" class="toolSectionBody" style="display: none;">','<div class="toolSectionBg"></div>',"<div>"].join("")),tool_link:_underscore2.default.template(['<a class="<%- id %> tool-link" href="<%= link %>" target="<%- target %>" minsizehint="<%- min_width %>">','<span class="labels">',"<% _.each( labels, function( label ){ %>",'<span class="label label-default label-<%- label %>">',"<%- label %>","</span>","<% }); %>","</span>",'<span class="tool-old-link">',"<%- name %>","</span>"," <%- description %>","</a>"].join("")),tool_form:_underscore2.default.template(['<div class="toolFormTitle"><%- tool.name %> (version <%- tool.version %>)</div>','<div class="toolFormBody">',"<% _.each( tool.inputs, function( input ){ %>",'<div class="form-row">','<label for="<%- input.name %>"><%- input.label %>:</label>','<div class="form-row-input">',"<%= input.html %>","</div>",'<div class="toolParamHelp" style="clear: both;">',"<%- input.help %>","</div>",'<div style="clear: both;"></div>',"</div>","<% }); %>","</div>",'<div class="form-row form-actions">','<input type="submit" class="btn btn-primary" name="runtool_btn" value="Execute" />',"</div>",'<div class="toolHelp">','<div class="toolHelpBody"><% tool.help %></div>',"</div>"].join(""),{variable:"tool"})};exports.default={ToolParameter:ToolParameter,IntegerToolParameter:IntegerToolParameter,SelectToolParameter:SelectToolParameter,Tool:Tool,ToolCollection:ToolCollection,ToolSearch:ToolSearch,ToolPanel:ToolPanel,ToolPanelView:ToolPanelView,ToolFormView:ToolFormView};
//# sourceMappingURL=../../../maps/mvc/tool/tools.js.map
