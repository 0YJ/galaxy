"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _utils=require("utils/utils"),_utils2=_interopRequireDefault(_utils),_deferred=require("utils/deferred"),_deferred2=_interopRequireDefault(_deferred),_uiMisc=require("mvc/ui/ui-misc"),_uiMisc2=_interopRequireDefault(_uiMisc),_formView=require("mvc/form/form-view"),_formView2=_interopRequireDefault(_formView),_formData=require("mvc/form/form-data"),_formData2=_interopRequireDefault(_formData),_toolFormBase=require("mvc/tool/tool-form-base"),_toolFormBase2=_interopRequireDefault(_toolFormBase),_uiModal=require("mvc/ui/ui-modal"),_uiModal2=_interopRequireDefault(_uiModal),_webhooks=require("mvc/webhooks"),_webhooks2=_interopRequireDefault(_webhooks),_workflowIcons=require("mvc/workflow/workflow-icons"),_workflowIcons2=_interopRequireDefault(_workflowIcons),View=Backbone.View.extend({initialize:function(e){var t=this;this.modal=parent.Galaxy.modal||new _uiModal2.default.View,this.model=e&&e.model||new Backbone.Model(e),this.deferred=new _deferred2.default,this.setElement($("<div/>").addClass("ui-form-composite").append(this.$message=$("<div/>")).append(this.$header=$("<div/>")).append(this.$steps=$("<div/>"))),$("body").append(this.$el),this._configure(),this.render(),$(window).resize(function(){t._refresh()})},_refresh:function(e){var t=_.reduce(this.$el.children(),function(e,t){return e+$(t).outerHeight()},0)-this.$steps.height()+90;this.$steps.css("height",$(window).height()-t)},_configure:function(){function e(e,s){for(var a,o=/\$\{(.+?)\}/g;a=o.exec(String(e));){var n=a[1];s(t.wp_inputs[n]=t.wp_inputs[n]||{label:n,name:n,type:"text",color:"hsl( "+100*++i+", 70%, 30% )",style:"ui-form-wp-source",links:[]})}}var t=this;this.forms=[],this.steps=[],this.links=[],this.parms=[],_.each(this.model.get("steps"),function(e,i){Galaxy.emit.debug("tool-form-composite::initialize()",i+" : Preparing workflow step.");var s=_workflowIcons2.default[e.step_type],a=parseInt(i+1)+": "+(e.step_label||e.step_name);e.annotation&&(a+=" - "+e.annotation),e.step_version&&(a+=" (Galaxy Version "+e.step_version+")"),e=_utils2.default.merge({index:i,fixed_title:_.escape(a),icon:s||"",help:null,citations:null,collapsible:!0,collapsed:i>0&&!t._isDataStep(e),sustain_version:!0,sustain_repeats:!0,sustain_conditionals:!0,narrow:!0,text_enable:"Edit",text_disable:"Undo",cls_enable:"fa fa-edit",cls_disable:"fa fa-undo",errors:e.messages,initial_errors:!0,cls:"ui-portlet-narrow",hide_operations:!0,needs_refresh:!1,always_refresh:"tool"!=e.step_type},e),t.steps[i]=e,t.links[i]=[],t.parms[i]={}}),_.each(this.steps,function(e,i){_formData2.default.visitInputs(e.inputs,function(e,s){t.parms[i][s]=e})}),_.each(this.steps,function(e,i){_.each(e.output_connections,function(e){_.each(t.steps,function(s,a){s.step_index===e.input_step_index&&t.links[i].push(s)})})}),_.each(this.steps,function(e,i){_.each(t.steps,function(s,a){var o={};_.each(e.output_connections,function(e){s.step_index===e.input_step_index&&(o[e.input_name]=e)}),_.each(t.parms[a],function(t,s){var a=o[s];a&&(t.type="hidden",t.help=t.step_linked?t.help+", ":"",t.help+="Output dataset '"+a.output_name+"' from step "+(parseInt(i)+1),t.step_linked=t.step_linked||[],t.step_linked.push(e))})})});var i=0;this.wp_inputs={},_.each(this.steps,function(i,s){_.each(t.parms[s],function(t,s){e(t.value,function(e){e.links.push(i),t.wp_linked=!0,t.type="text",t.backdrop=!0,t.style="ui-form-wp-target"})}),_.each(i.post_job_actions,function(t){_.each(t.action_arguments,function(t){e(t,function(){})})})}),_.each(this.steps,function(e,i){if("tool"==e.step_type){var s=!0;_formData2.default.visitInputs(e.inputs,function(i,a,o){var n=i.value&&"RuntimeValue"==i.value.__class__,r=-1!=["data","data_collection"].indexOf(i.type),l=o[i.data_ref];i.step_linked&&!t._isDataStep(i.step_linked)&&(s=!1),i.options&&(0==i.options.length&&!s||i.wp_linked)&&(i.is_workflow=!0),l&&(i.is_workflow=l.step_linked&&!t._isDataStep(l.step_linked)||i.wp_linked),(r||i.value&&"RuntimeValue"==i.value.__class__&&!i.step_linked)&&(e.collapsed=!1),n&&(i.value=i.default_value),i.flavor="workflow",n||r||"hidden"===i.type||i.wp_linked||(i.optional||!_utils2.default.isEmpty(i.value)&&""!==i.value)&&(i.collapsible_value=i.value,i.collapsible_preview=!0)})}})},render:function(){var e=this;this.deferred.reset(),this._renderHeader(),this._renderMessage(),this._renderParameters(),this._renderHistory(),_.each(this.steps,function(t){e._renderStep(t)})},_renderHeader:function(){var e=this;this.execute_btn=new _uiMisc2.default.Button({icon:"fa-check",title:"Run workflow",cls:"btn btn-primary",onclick:function(){e._execute()}}),this.$header.addClass("ui-form-header").empty().append(new _uiMisc2.default.Label({title:"Workflow: "+this.model.get("name")}).$el).append(this.execute_btn.$el)},_renderMessage:function(){this.$message.empty(),this.model.get("has_upgrade_messages")&&this.$message.append(new _uiMisc2.default.Message({message:"Some tools in this workflow may have changed since it was last saved or some errors were found. The workflow may still run, but any new options will have default values. Please review the messages below to make a decision about whether the changes will affect your analysis.",status:"warning",persistent:!0,fade:!1}).$el);var e=this.model.get("step_version_changes");e&&e.length>0&&this.$message.append(new _uiMisc2.default.Message({message:"Some tools are being executed with different versions compared to those available when this workflow was last saved because the other versions are not or no longer available on this Galaxy instance. To upgrade your workflow and dismiss this message simply edit the workflow and re-save it.",status:"warning",persistent:!0,fade:!1}).$el)},_renderParameters:function(){var e=this;this.wp_form=null,_.isEmpty(this.wp_inputs)||(this.wp_form=new _formView2.default({title:"<b>Workflow Parameters</b>",inputs:this.wp_inputs,cls:"ui-portlet-narrow",onchange:function(){_.each(e.wp_form.input_list,function(t,i){_.each(t.links,function(t){e._refreshStep(t)})})}}),this._append(this.$steps.empty(),this.wp_form.$el))},_renderHistory:function(){this.history_form=new _formView2.default({cls:"ui-portlet-narrow",title:"<b>History Options</b>",inputs:[{type:"conditional",name:"new_history",test_param:{name:"check",label:"Send results to a new history",type:"boolean",value:"false",help:""},cases:[{value:"true",inputs:[{name:"name",label:"History name",type:"text",value:this.model.get("name")}]}]}]}),this._append(this.$steps,this.history_form.$el)},_renderStep:function(e){var t=this,i=null;this.deferred.execute(function(s){if(t.$steps.addClass("ui-steps"),"tool"==e.step_type)e.postchange=function(t,i){var s={tool_id:e.id,tool_version:e.version,inputs:$.extend(!0,{},i.data.create())};i.wait(!0),Galaxy.emit.debug("tool-form-composite::postchange()","Sending current state.",s),_utils2.default.request({type:"POST",url:Galaxy.root+"api/tools/"+e.id+"/build",data:s,success:function(e){i.update(e),i.wait(!1),Galaxy.emit.debug("tool-form-composite::postchange()","Received new model.",e),t.resolve()},error:function(e){Galaxy.emit.debug("tool-form-composite::postchange()","Refresh request failed.",e),t.reject()}})},i=new _toolFormBase2.default(e),e.post_job_actions&&e.post_job_actions.length&&i.portlet.append($("<div/>").addClass("ui-form-element-disabled").append($("<div/>").addClass("ui-form-title").html("<b>Job Post Actions</b>")).append($("<div/>").addClass("ui-form-preview").html(_.reduce(e.post_job_actions,function(e,t){return e+" "+t.short_str},""))));else{var a=-1!=["data_input","data_collection_input"].indexOf(e.step_type);_.each(e.inputs,function(e){e.flavor="module",e.hide_label=a}),i=new _formView2.default(_utils2.default.merge({title:e.fixed_title,onchange:function(){_.each(t.links[e.index],function(e){t._refreshStep(e)})},inputs:e.inputs&&e.inputs.length>0?e.inputs:[{type:"hidden",name:"No options available.",ignore:null}]},e))}t.forms[e.index]=i,t._append(t.$steps,i.$el),t._refresh(),e.needs_refresh&&t._refreshStep(e),i.portlet[t.show_progress?"disable":"enable"](),t.show_progress&&t.execute_btn.model.set({wait:!0,wait_text:"Preparing...",percentage:100*(e.index+1)/t.steps.length}),Galaxy.emit.debug("tool-form-composite::initialize()",e.index+" : Workflow step state ready.",e),setTimeout(function(){s.resolve()},0)})},_refreshStep:function(e){var t=this,i=this.forms[e.index];i?(_.each(t.parms[e.index],function(e,s){if(e.step_linked||e.wp_linked){var a=i.field_list[i.data.match(s)];if(a){var o=void 0;if(e.step_linked)o={values:[]},_.each(e.step_linked,function(e){if(t._isDataStep(e)){var i=t.forms[e.index].data.create().input;i&&_.each(i.values,function(e){o.values.push(e)})}}),!e.multiple&&o.values.length>0&&(o={values:[o.values[0]]});else if(e.wp_linked){o=e.value;for(var n,r=/\$\{(.+?)\}/g;n=r.exec(e.value);){var l=t.wp_form.field_list[t.wp_form.data.match(n[1])],u=l&&l.value();u&&(o=o.split(n[0]).join(u))}}void 0!==o&&a.value(o)}}}),i.trigger("change")):e.needs_refresh=!0},_refreshHistory:function(){var e=this,t=parent.Galaxy&&parent.Galaxy.currHistoryPanel&&parent.Galaxy.currHistoryPanel.model;this._refresh_history&&clearTimeout(this._refresh_history),t&&t.refresh().success(function(){0===t.numOfUnfinishedShownContents()&&(e._refresh_history=setTimeout(function(){e._refreshHistory()},t.UPDATE_DELAY))})},_execute:function(){var e=this;this.show_progress=!0,this._enabled(!1),this.deferred.execute(function(t){setTimeout(function(){t.resolve(),e._submit()},0)})},_submit:function(){var e=this,t=this.history_form.data.create(),i={new_history_name:t["new_history|name"]?t["new_history|name"]:null,history_id:t["new_history|name"]?null:this.model.get("history_id"),replacement_params:this.wp_form?this.wp_form.data.create():{},parameters:{},parameters_normalized:!0,batch:!0},s=!0;for(var a in this.forms){var o=this.forms[a],n=o.data.create(),r=e.steps[a],l=r.step_index;o.trigger("reset");for(var u in n){var p=n[u],d=o.data.match(u),_=(o.field_list[d],o.input_list[d]);if(!_.step_linked){if(!(s=this._isDataStep(r)?p&&p.values&&p.values.length>0:_.optional||_.is_workflow&&""!==p||!_.is_workflow&&null!==p)){o.highlight(d);break}i.parameters[l]=i.parameters[l]||{},i.parameters[l][u]=n[u]}}if(!s)break}s?(Galaxy.emit.debug("tool-form-composite::submit()","Validation complete.",i),_utils2.default.request({type:"POST",url:Galaxy.root+"api/workflows/"+this.model.id+"/invocations",data:i,success:function(t){if(Galaxy.emit.debug("tool-form-composite::submit","Submission successful.",t),e.$el.children().hide(),e.$el.append(e._templateSuccess(t)),$.isArray(t)&&t.length>0){e.$el.append($("<div/>",{id:"webhook-view"}));new _webhooks2.default.WebhookView({urlRoot:Galaxy.root+"api/webhooks/workflow",toolId:i.tool_id,toolVersion:i.tool_version})}e._refreshHistory()},error:function(t){Galaxy.emit.debug("tool-form-composite::submit","Submission failed.",t);var s=!1;if(t&&t.err_data)for(var a in e.forms){var o=e.forms[a],n=t.err_data[o.model.get("step_index")];if(n){var r=o.data.matchResponse(n);for(var l in r){o.highlight(l,r[l]),s=!0;break}}}s||e.modal.show({title:"Workflow submission failed",body:e._templateError(i,t&&t.err_msg),buttons:{Close:function(){e.modal.hide()}}})},complete:function(){e._enabled(!0)}})):(e._enabled(!0),Galaxy.emit.debug("tool-form-composite::submit()","Validation failed.",i))},_append:function(e,t){e.append("<p/>").append(t)},_enabled:function(e){this.execute_btn.model.set({wait:!e,wait_text:"Sending...",percentage:-1}),this.wp_form&&this.wp_form.portlet[e?"enable":"disable"](),this.history_form&&this.history_form.portlet[e?"enable":"disable"](),_.each(this.forms,function(t){t&&t.portlet[e?"enable":"disable"]()})},_isDataStep:function(e){for(var t=$.isArray(e)?e:[e],i=0;i<t.length;i++){var s=t[i];if(!s||!s.step_type||!s.step_type.startsWith("data"))return!1}return!0},_templateSuccess:function(e){return $.isArray(e)&&e.length>0?$("<div/>").addClass("donemessagelarge").append($("<p/>").html("Successfully invoked workflow <b>"+_utils2.default.sanitize(this.model.get("name"))+"</b>"+(e.length>1?" <b>"+e.length+" times</b>":"")+".")).append($("<p/>").append("<b/>").text("You can check the status of queued jobs and view the resulting data by refreshing the History pane. When the job has been run the status will change from 'running' to 'finished' if completed successfully or 'error' if problems were encountered.")):this._templateError(e,"Invalid success response. No invocations found.")},_templateError:function(e,t){return $("<div/>").addClass("errormessagelarge").append($("<p/>").text("The server could not complete the request. Please contact the Galaxy Team if this error persists. "+(JSON.stringify(t)||""))).append($("<pre/>").text(JSON.stringify(e,null,4)))}});exports.default={View:View};
//# sourceMappingURL=../../../maps/mvc/tool/tool-form-composite.js.map
