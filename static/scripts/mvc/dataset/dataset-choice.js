"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _filterDatasetJSON(e,t,a){function l(e,t){for(var a in t)if(t.hasOwnProperty(a)&&e[a]!==t[a])return!1;return!0}return e.filter(function(e){return console.debug(e),!e.deleted&&e.visible&&(!a||void 0===e.collection_type)&&l(e,t)})}Object.defineProperty(exports,"__esModule",{value:!0});var _datasetModel=require("mvc/dataset/dataset-model"),_datasetModel2=_interopRequireDefault(_datasetModel),_datasetList=require("mvc/dataset/dataset-list"),_datasetList2=_interopRequireDefault(_datasetList),_uiModal=require("mvc/ui/ui-modal"),_uiModal2=_interopRequireDefault(_uiModal),_baseMvc=require("mvc/base-mvc"),_baseMvc2=_interopRequireDefault(_baseMvc),_localization=require("utils/localization"),_localization2=_interopRequireDefault(_localization),logNamespace="dataset",DatasetChoiceModal=function(e,t){(t=_.defaults(t||{},{datasetsOnly:!0,where:{state:"ok"},multiselect:!1,selected:[]})).title=t.title||(t.multiselect?(0,_localization2.default)("Choose datasets:"):(0,_localization2.default)("Choose a dataset:"));var a,l,i,s=jQuery.Deferred();return(e=(t.filter||_filterDatasetJSON)(e,t.where,t.datasetsOnly)).length?(t.multiselect&&((i={})[(0,_localization2.default)("Ok")]=function(){s.resolve(l.getSelectedModels().map(function(e){return e.toJSON()}))}),(a=new _uiModal2.default.View({height:"auto",buttons:i,closing_events:!0,closing_callback:function(){s.resolve(null)},body:['<div class="list-panel"></div>'].join("")})).$(".modal-header").remove(),a.$(".modal-footer").css("margin-top","0px"),(l=new _datasetList2.default.DatasetList({title:t.title,subtitle:t.subtitle||(0,_localization2.default)(["Click the checkboxes on the right to select datasets. ","Click the datasets names to see their details. "].join("")),el:a.$body.find(".list-panel"),selecting:!0,selected:t.selected,collection:new _datasetModel2.default.DatasetAssociationCollection(e)})).once("rendered:initial",function(){a.show(),a.$el.addClass("dataset-choice-modal")}),t.multiselect||(l.on("rendered",function(){l.$(".list-actions").hide()}),l.on("view:selected",function(e){s.resolve([e.model.toJSON()])})),l.render(0),s.always(function(){a.hide()})):s.reject("No matches found")},DatasetChoice=Backbone.View.extend(_baseMvc2.default.LoggableMixin).extend({_logNamespace:logNamespace,className:"dataset-choice",initialize:function(e){this.debug(this+"(DatasetChoice).initialize:",e),this.label=void 0!==e.label?(0,_localization2.default)(e.label):"",this.where=e.where,this.datasetsOnly=void 0===e.datasetsOnly||e.datasetsOnly,this.datasetJSON=e.datasetJSON||[],this.selected=e.selected||[],this._setUpListeners()},_setUpListeners:function(){},render:function(){var e=this.toJSON();return this.$el.html(this._template(e)),this.$(".selected").replaceWith(this._renderSelected(e)),this},_template:function(e){return _.template(["<label>",'<span class="prompt"><%- label %></span>','<div class="selected"></div>',"</label>"].join(""))(e)},_renderSelected:function(e){return e.selected.length?$(_.template(['<div class="selected">','<span class="title"><%- selected.hid %>: <%- selected.name %></span>','<span class="subtitle">',"<i><%- selected.misc_blurb %></i>","<i>",(0,_localization2.default)("format")+": ","<%- selected.file_ext %></i>","<i><%- selected.misc_info %></i>","</span>","</div>"].join(""),{variable:"selected"})(e.selected[0])):$(['<span class="none-selected-msg">(',(0,_localization2.default)("click to select a dataset"),")</span>"].join(""))},toJSON:function(){var e=this;return{label:e.label,datasets:e.datasetJSON,selected:_.compact(_.map(e.selected,function(t){return _.findWhere(e.datasetJSON,{id:t})}))}},events:{click:"chooseWithModal"},chooseWithModal:function(){var e=this;return this._createModal().done(function(t){t?(e.selected=_.pluck(t,"id"),e.trigger("selected",e,t),e.render()):e.trigger("cancelled",e)}).fail(function(){e.trigger("error",e,arguments)})},_createModal:function(){return new DatasetChoiceModal(this.datasetJSON,this._getModalOptions())},_getModalOptions:function(){return{title:this.label,multiselect:!1,selected:this.selected,where:this.where,datasetsOnly:this.datasetsOnly}},toString:function(){return"DatasetChoice("+this.selected+")"}}),MultiDatasetChoice=DatasetChoice.extend({className:DatasetChoice.prototype.className+" multi",cells:{hid:(0,_localization2.default)("History #"),name:(0,_localization2.default)("Name"),misc_blurb:(0,_localization2.default)("Summary"),file_ext:(0,_localization2.default)("Format"),genome_build:(0,_localization2.default)("Genome"),tags:(0,_localization2.default)("Tags"),annotation:(0,_localization2.default)("Annotation")},initialize:function(e){this.showHeaders=void 0===e.showHeaders||e.showHeaders,this.cells=e.cells||this.cells,DatasetChoice.prototype.initialize.call(this,e)},_renderSelected:function(e){return e.selected.length?$(_.template(['<table class="selected">',"<% if( json.showHeaders ){ %>","<thead><tr>","<% _.map( json.cells, function( val, key ){ %>","<th><%- val %></th>","<% }); %>","</tr></thead>","<% } %>","<tbody>","<% _.map( json.selected, function( selected ){ %>","<tr>","<% _.map( json.cells, function( val, key ){ %>",'<td class="cell-<%- key %>"><%- selected[ key ] %></td>',"<% }) %>","</tr>","<% }); %>","</tbody>","</table>"].join(""),{variable:"json"})(e)):$(['<span class="none-selected-msg">(',(0,_localization2.default)("click to select a dataset"),")</span>"].join(""))},toJSON:function(){return _.extend(DatasetChoice.prototype.toJSON.call(this),{showHeaders:this.showHeaders,cells:this.cells})},_getModalOptions:function(){return _.extend(DatasetChoice.prototype._getModalOptions.call(this),{multiselect:!0})},toString:function(){return"DatasetChoice("+this.selected+")"}});exports.default={DatasetChoiceModal:DatasetChoiceModal,DatasetChoice:DatasetChoice,MultiDatasetChoice:MultiDatasetChoice};
//# sourceMappingURL=../../../maps/mvc/dataset/dataset-choice.js.map
