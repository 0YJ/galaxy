"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _states=require("mvc/dataset/states"),_states2=_interopRequireDefault(_states),_baseMvc=require("mvc/base-mvc"),_baseMvc2=_interopRequireDefault(_baseMvc),_localization=require("utils/localization"),_localization2=_interopRequireDefault(_localization),logNamespace="dataset",searchableMixin=_baseMvc2.default.SearchableModelMixin,DatasetAssociation=Backbone.Model.extend(_baseMvc2.default.LoggableMixin).extend(_baseMvc2.default.mixin(searchableMixin,{_logNamespace:logNamespace,defaults:{state:_states2.default.NEW,deleted:!1,purged:!1,name:"(unnamed dataset)",accessible:!0,data_type:"",file_ext:"",file_size:0,meta_files:[],misc_blurb:"",misc_info:"",tags:[]},initialize:function(e,t){this.debug(this+"(Dataset).initialize",e,t),this.get("accessible")||this.set("state",_states2.default.NOT_VIEWABLE),this.urls=this._generateUrls(),this._setUpListeners()},_generateUrls:function(){var e=this.get("id");if(!e)return{};var t={purge:"datasets/"+e+"/purge_async",display:"datasets/"+e+"/display/?preview=True",edit:"datasets/edit?dataset_id="+e,download:"datasets/"+e+"/display"+this._downloadQueryParameters(),report_error:"dataset/errors?id="+e,rerun:"tool_runner/rerun?id="+e,show_params:"datasets/"+e+"/show_params",visualization:"visualization",meta_download:"dataset/get_metadata_file?hda_id="+e+"&metadata_name="};return _.each(t,function(e,a){t[a]=Galaxy.root+e}),this.urls=t,t},_downloadQueryParameters:function(){return"?to_ext="+this.get("file_ext")},_setUpListeners:function(){this.on("change:state",function(e,t){this.log(this+" has changed state:",e,t),this.inReadyState()&&this.trigger("state:ready",e,t,this.previous("state"))}),this.on("change:id change:file_ext",function(e){this._generateUrls()})},toJSON:function(){var e=Backbone.Model.prototype.toJSON.call(this);return _.extend(e,{urls:this.urls})},isDeletedOrPurged:function(){return this.get("deleted")||this.get("purged")},inReadyState:function(){var e=_.contains(_states2.default.READY_STATES,this.get("state"));return this.isDeletedOrPurged()||e},hasDetails:function(){return!this.get("accessible")||this.has("annotation")},hasData:function(){return this.get("file_size")>0},fetch:function(e){var t=this;return Backbone.Model.prototype.fetch.call(this,e).always(function(){t._generateUrls()})},parse:function(e,t){var a=Backbone.Model.prototype.parse.call(this,e,t);return a.create_time&&(a.create_time=new Date(a.create_time)),a.update_time&&(a.update_time=new Date(a.update_time)),a},save:function(e,t){return t=t||{},t.wait=!!_.isUndefined(t.wait)||t.wait,Backbone.Model.prototype.save.call(this,e,t)},delete:function(e){return this.get("deleted")?jQuery.when():this.save({deleted:!0},e)},undelete:function(e){return!this.get("deleted")||this.get("purged")?jQuery.when():this.save({deleted:!1},e)},purge:function(e){if(this.get("purged"))return jQuery.when();(e=e||{}).url=this.urls.purge;var t=this,a=jQuery.ajax(e);return a.done(function(e,a,i){t.set({deleted:!0,purged:!0})}),a.fail(function(a,i,s){var n=(0,_localization2.default)("Unable to purge dataset");a.responseJSON&&a.responseJSON.error?n=a.responseJSON.error:-1!==a.responseText.indexOf("Removal of datasets by users is not allowed in this Galaxy instance")&&(n="Removal of datasets by users is not allowed in this Galaxy instance"),a.responseText=n,t.trigger("error",t,a,e,(0,_localization2.default)(n),{error:n})}),a},searchAttributes:["name","file_ext","genome_build","misc_blurb","misc_info","annotation","tags"],searchAliases:{title:"name",format:"file_ext",database:"genome_build",blurb:"misc_blurb",description:"misc_blurb",info:"misc_info",tag:"tags"},toString:function(){var e=this.get("id")||"";return this.get("name")&&(e='"'+this.get("name")+'",'+e),"Dataset("+e+")"}})),DatasetAssociationCollection=Backbone.Collection.extend(_baseMvc2.default.LoggableMixin).extend({_logNamespace:logNamespace,model:DatasetAssociation,urlRoot:Galaxy.root+"api/datasets",url:function(){return this.urlRoot},ids:function(){return this.map(function(e){return e.get("id")})},notReady:function(){return this.filter(function(e){return!e.inReadyState()})},haveDetails:function(){return this.all(function(e){return e.hasDetails()})},ajaxQueue:function(e,t){var a=jQuery.Deferred(),i=this.length,s=[];if(!i)return a.resolve([]),a;var n=this.chain().reverse().map(function(r,o){return function(){var l=e.call(r,t);l.done(function(e){a.notify({curr:o,total:i,response:e,model:r})}),l.always(function(e){s.push(e),n.length?n.shift()():a.resolve(s)})}}).value();return n.shift()(),a},matches:function(e){return this.filter(function(t){return t.matches(e)})},toString:function(){return["DatasetAssociationCollection(",this.length,")"].join("")}});exports.default={DatasetAssociation:DatasetAssociation,DatasetAssociationCollection:DatasetAssociationCollection};
//# sourceMappingURL=../../../maps/mvc/dataset/dataset-model.js.map
