"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _utils=require("utils/utils"),_utils2=_interopRequireDefault(_utils),_uploadModel=require("mvc/upload/upload-model"),_uploadModel2=_interopRequireDefault(_uploadModel),_defaultRow=require("mvc/upload/default/default-row"),_defaultRow2=_interopRequireDefault(_defaultRow),_uploadFtp2=require("mvc/upload/upload-ftp"),_uploadFtp3=_interopRequireDefault(_uploadFtp2),_uploadExtension=require("mvc/upload/upload-extension"),_uploadExtension2=_interopRequireDefault(_uploadExtension),_uiPopover=require("mvc/ui/ui-popover"),_uiPopover2=_interopRequireDefault(_uiPopover),_uiSelect=require("mvc/ui/ui-select"),_uiSelect2=_interopRequireDefault(_uiSelect),_uiMisc=require("mvc/ui/ui-misc"),_uiMisc2=_interopRequireDefault(_uiMisc),_lazyLimited=require("mvc/lazy/lazy-limited"),_lazyLimited2=_interopRequireDefault(_lazyLimited);require("utils/uploadbox"),exports.default=Backbone.View.extend({upload_size:0,collection:new _uploadModel2.default.Collection,counter:{announce:0,success:0,error:0,running:0,reset:function(){this.announce=this.success=this.error=this.running=0}},initialize:function(e){var t=this;this.app=e,this.options=e.options,this.list_extensions=e.list_extensions,this.list_genomes=e.list_genomes,this.ui_button=e.ui_button,this.ftp_upload_site=e.currentFtp(),this.setElement(this._template()),this.$uploadbox=this.$(".upload-box"),this.$uploadtable=this.$(".upload-table"),this.btnLocal=new _uiMisc2.default.Button({id:"btn-local",title:"Choose local file",onclick:function(){t.uploadbox.select()},icon:"fa fa-laptop"}),this.btnFtp=new _uiMisc2.default.Button({id:"btn-ftp",title:"Choose FTP file",onclick:function(){t._eventFtp()},icon:"fa fa-folder-open-o"}),this.btnCreate=new _uiMisc2.default.Button({id:"btn-new",title:"Paste/Fetch data",onclick:function(){t._eventCreate()},icon:"fa fa-edit"}),this.btnStart=new _uiMisc2.default.Button({id:"btn-start",title:"Start",onclick:function(){t._eventStart()}}),this.btnStop=new _uiMisc2.default.Button({id:"btn-stop",title:"Pause",onclick:function(){t._eventStop()}}),this.btnReset=new _uiMisc2.default.Button({id:"btn-reset",title:"Reset",onclick:function(){t._eventReset()}}),this.btnClose=new _uiMisc2.default.Button({id:"btn-close",title:"Close",onclick:function(){t.app.modal.hide()}}),_.each([this.btnLocal,this.btnFtp,this.btnCreate,this.btnStop,this.btnReset,this.btnStart,this.btnClose],function(e){t.$(".upload-buttons").prepend(e.$el)}),this.uploadbox=this.$uploadbox.uploadbox({url:this.app.options.nginx_upload_path,announce:function(e,n){t._eventAnnounce(e,n)},initialize:function(e){return t.app.toData([t.collection.get(e)],t.history_id)},progress:function(e,n){t._eventProgress(e,n)},success:function(e,n){t._eventSuccess(e,n)},error:function(e,n){t._eventError(e,n)},complete:function(){t._eventComplete()},ondragover:function(){t.$uploadbox.addClass("highlight")},ondragleave:function(){t.$uploadbox.removeClass("highlight")}}),this.ftp=new _uiPopover2.default.View({title:"FTP files",container:this.btnFtp.$el}),this.select_extension=new _uiSelect2.default.View({css:"upload-footer-selection",container:this.$(".upload-footer-extension"),data:_.filter(this.list_extensions,function(e){return!e.composite_files}),value:this.options.default_extension,onchange:function(e){t._changeExtension(e)}}),this.$(".upload-footer-extension-info").on("click",function(e){new _uploadExtension2.default({$el:$(e.target),title:t.select_extension.text(),extension:t.select_extension.value(),list:t.list_extensions,placement:"top"})}).on("mousedown",function(e){e.preventDefault()}),this.select_genome=new _uiSelect2.default.View({css:"upload-footer-selection",container:this.$(".upload-footer-genome"),data:this.list_genomes,value:this.options.default_genome,onchange:function(e){t._changeGenome(e)}}),this.loader=new _lazyLimited2.default({$container:this.$uploadbox,collection:this.collection,new_content:function(e){var n=new _defaultRow2.default(t,{model:e});return t.$uploadtable.find("> tbody:first").append(n.$el),n.render(),n}}),this.collection.on("remove",function(e){t._eventRemove(e)}),this.render()},render:function(){var e="";e=0==this.counter.announce?this.uploadbox.compatible()?"&nbsp;":"Browser does not support Drag & Drop. Try Firefox 4+, Chrome 7+, IE 10+, Opera 12+ or Safari 6+.":0==this.counter.running?"You added "+this.counter.announce+" file(s) to the queue. Add more files or click 'Start' to proceed.":"Please wait..."+this.counter.announce+" out of "+this.counter.running+" remaining.",this.$(".upload-top-info").html(e);var t=0==this.counter.running&&this.counter.announce+this.counter.success+this.counter.error>0,n=0==this.counter.running&&this.counter.announce>0,i=0==this.counter.running,o=this.counter.announce+this.counter.success+this.counter.error>0;this.btnReset[t?"enable":"disable"](),this.btnStart[n?"enable":"disable"](),this.btnStart.$el[n?"addClass":"removeClass"]("btn-primary"),this.btnStop[this.counter.running>0?"enable":"disable"](),this.btnLocal[i?"enable":"disable"](),this.btnFtp[i?"enable":"disable"](),this.btnCreate[i?"enable":"disable"](),this.btnFtp.$el[this.ftp_upload_site?"show":"hide"](),this.$(".upload-table")[o?"show":"hide"](),this.$(".upload-helper")[o?"hide":"show"]()},_eventAnnounce:function(e,t){this.counter.announce++;var n=new _uploadModel2.default.Model({id:e,file_name:t.name,file_size:t.size,file_mode:t.mode||"local",file_path:t.path,file_data:t});this.render(),this.collection.add(n)},_eventProgress:function(e,t){var n=this.collection.get(e);n.set("percentage",t),this.ui_button.model.set("percentage",this._uploadPercentage(t,n.get("file_size")))},_eventSuccess:function(e,t){var n=this.collection.get(e);n.set({percentage:100,status:"success"}),this.ui_button.model.set("percentage",this._uploadPercentage(100,n.get("file_size"))),this.upload_completed+=100*n.get("file_size"),this.counter.announce--,this.counter.success++,this.render(),Galaxy.currHistoryPanel.refreshContents()},_eventError:function(e,t){var n=this.collection.get(e);n.set({percentage:100,status:"error",info:t}),this.ui_button.model.set({percentage:this._uploadPercentage(100,n.get("file_size")),status:"danger"}),this.upload_completed+=100*n.get("file_size"),this.counter.announce--,this.counter.error++,this.render()},_eventComplete:function(){this.collection.each(function(e){"queued"==e.get("status")&&e.set("status","init")}),this.counter.running=0,this.render()},_eventRemove:function(e){var t=e.get("status");"success"==t?this.counter.success--:"error"==t?this.counter.error--:this.counter.announce--,this.uploadbox.remove(e.id),this.render()},_eventFtp:function(){if(this.ftp.visible)this.ftp.hide();else{this.ftp.empty();var e=this;this.ftp.append(new _uploadFtp3.default({collection:this.collection,ftp_upload_site:this.ftp_upload_site,onadd:function(t){return e.uploadbox.add([{mode:"ftp",name:t.path,size:t.size,path:t.path}])},onremove:function(t){e.collection.remove(t)}}).$el),this.ftp.show()}},_eventCreate:function(){this.uploadbox.add([{name:"New File",size:0,mode:"new"}])},_eventStart:function(){if(0!=this.counter.announce&&0==this.counter.running){var e=this;this.upload_size=0,this.upload_completed=0,this.collection.each(function(t){"init"==t.get("status")&&(t.set("status","queued"),e.upload_size+=t.get("file_size"))}),this.ui_button.model.set({percentage:0,status:"success"}),this.counter.running=this.counter.announce,this.history_id=this.app.currentHistory(),this._uploadFtp(),this.uploadbox.start(),this.render()}},_eventStop:function(){this.counter.running>0&&(this.ui_button.model.set("status","info"),$(".upload-top-info").html("Queue will pause after completing the current file..."),this.uploadbox.stop())},_eventReset:function(){if(0==this.counter.running){this.collection.reset(),this.counter.reset(),this.uploadbox.reset(),this.select_extension.value(this.options.default_extension),this.select_genome.value(this.options.default_genome),this.ui_button.model.set("percentage",0),this.render()}},_changeExtension:function(e,t){var n=this;this.collection.each(function(i){"init"!=i.get("status")||i.get("extension")!=n.options.default_extension&&t||i.set("extension",e)})},_changeGenome:function(e,t){var n=this;this.collection.each(function(i){"init"!=i.get("status")||i.get("genome")!=n.options.default_genome&&t||i.set("genome",e)})},_uploadFtp:function(){var e=this,t=[];this.collection.each(function(n){"queued"==n.get("status")&&"ftp"==n.get("file_mode")&&(e.uploadbox.remove(n.id),t.push(n))}),t.length>0&&$.uploadpost({data:this.app.toData(t),url:this.app.options.nginx_upload_path,success:function(n){_.each(t,function(t){e._eventSuccess(t.id)})},error:function(n){_.each(t,function(t){e._eventError(t.id,n)})}})},_uploadPercentage:function(e,t){return(this.upload_completed+e*t)/this.upload_size},_template:function(){return'<div class="upload-view-default"><div class="upload-top"><h6 class="upload-top-info"/></div><div class="upload-box"><div class="upload-helper"><i class="fa fa-files-o"/>Drop files here</div><table class="upload-table ui-table-striped" style="display: none;"><thead><tr><th>Name</th><th>Size</th><th>Type</th><th>Genome</th><th>Settings</th><th>Status</th><th/></tr></thead><tbody/></table></div><div class="upload-footer"><span class="upload-footer-title">Type (set all):</span><span class="upload-footer-extension"/><span class="upload-footer-extension-info upload-icon-button fa fa-search"/> <span class="upload-footer-title">Genome (set all):</span><span class="upload-footer-genome"/></div><div class="upload-buttons"/></div>'}});
//# sourceMappingURL=../../../../maps/mvc/upload/default/default-view.js.map
