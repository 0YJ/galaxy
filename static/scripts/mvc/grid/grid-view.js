"use strict";jQuery.ajaxSettings.traditional=!0,define(["mvc/grid/grid-model","mvc/grid/grid-template","mvc/ui/popup-menu"],function(t,i,e){return Backbone.View.extend({grid:null,initialize:function(t){this.setElement("#grid-container"),t.use_panels&&$("#center").css({padding:"10px",overflow:"auto"}),this.init_grid(t)},handle_refresh:function(t){t&&$.inArray("history",t)>-1&&top.Galaxy&&top.Galaxy.currHistoryPanel&&top.Galaxy.currHistoryPanel.loadCurrentHistory()},init_grid:function(e){this.grid=new t(e);var n=this.grid.attributes;this.handle_refresh(n.refresh_frames);var r=this.grid.get("url_base");if(r=r.replace(/^.*\/\/[^\/]+/,""),this.grid.set("url_base",r),this.$el.html(i.grid(n)),this.$el.find("#grid-table-header").html(i.header(n)),this.$el.find("#grid-table-body").html(i.body(n)),this.$el.find("#grid-table-footer").html(i.footer(n)),n.message){this.$el.find("#grid-message").html(i.message(n));var s=this;n.use_hide_message&&setTimeout(function(){s.$el.find("#grid-message").html("")},5e3)}this.init_grid_elements(),this.init_grid_controls(),init_refresh_on_change()},init_grid_controls:function(){var t=this;this.$el.find(".operation-button").each(function(){$(this).off(),$(this).click(function(){return t.submit_operation(this),!1})}),this.$el.find("input[type=text]").each(function(){$(this).off(),$(this).click(function(){$(this).select()}).keyup(function(){$(this).css("font-style","normal")})}),this.$el.find(".sort-link").each(function(){$(this).off(),$(this).click(function(){return t.set_sort_condition($(this).attr("sort_key")),!1})}),this.$el.find(".text-filter-form").each(function(){$(this).off(),$(this).submit(function(){var i=$(this).attr("column_key"),e=$("#input-"+i+"-filter"),n=e.val();return e.val(""),t.add_filter_condition(i,n),!1})}),this.$el.find(".text-filter-val > a").each(function(){$(this).off(),$(this).click(function(){return $(this).parent().remove(),t.remove_filter_condition($(this).attr("filter_key"),$(this).attr("filter_val")),!1})}),this.$el.find(".categorical-filter > a").each(function(){$(this).off(),$(this).click(function(){return t.set_categorical_filter($(this).attr("filter_key"),$(this).attr("filter_val")),!1})}),this.$el.find(".advanced-search-toggle").each(function(){$(this).off(),$(this).click(function(){return t.$el.find("#standard-search").slideToggle("fast"),t.$el.find("#advanced-search").slideToggle("fast"),!1})}),this.$el.find("#check_all").off(),this.$el.find("#check_all").on("click",function(){t.check_all_items()})},init_grid_elements:function(){this.$el.find(".grid").each(function(){var t=$(this).find("input.grid-row-select-checkbox"),i=$(this).find("span.grid-selected-count"),e=function(){i.text($(t).filter(":checked").length)};$(t).each(function(){$(this).change(e)}),e()}),0!==this.$el.find(".community_rating_star").length&&this.$el.find(".community_rating_star").rating({});var t=this.grid.attributes,i=this;if(this.$el.find(".page-link > a").each(function(){$(this).click(function(){return i.set_page($(this).attr("page_num")),!1})}),this.$el.find(".use-target").each(function(){$(this).click(function(t){return i.execute({href:$(this).attr("href"),target:$(this).attr("target")}),!1})}),0!=t.items.length)for(var n in t.items){var r=t.items[n],s=this.$el.find("#grid-"+n+"-popup");s.off();var a=new e(s);for(var o in t.operations){var l=t.operations[o],d=l.label,c=r.operation_config[d];if(r.encode_id,c.allowed&&l.allow_popup){var h={html:l.label,href:c.url_args,target:c.target,confirmation_text:l.confirm};h.func=function(t){t.preventDefault();var e=$(t.target).html(),n=this.findItemByHtml(e);i.execute(n)},a.addItem(h)}}}},add_filter_condition:function(t,e){if(""===e)return!1;this.grid.add_filter(t,e,!0);var n=$(i.filter_element(t,e)),r=this;n.click(function(){$(this).remove(),r.remove_filter_condition(t,e)}),this.$el.find("#"+t+"-filtering-criteria").append(n),this.go_page_one(),this.execute()},remove_filter_condition:function(t,i){this.grid.remove_filter(t,i),this.go_page_one(),this.execute()},set_sort_condition:function(t){var i=this.grid.get("sort_key"),e=t;-1!==i.indexOf(t)&&"-"!==i.substring(0,1)&&(e="-"+t),this.$el.find(".sort-arrow").remove();var n="-"==e.substring(0,1)?"&uarr;":"&darr;",r=$("<span>"+n+"</span>").addClass("sort-arrow");this.$el.find("#"+t+"-header").append(r),this.grid.set("sort_key",e),this.go_page_one(),this.execute()},set_categorical_filter:function(t,i){var e=this.grid.get("categorical_filters")[t],n=this.grid.get("filters")[t],r=this;this.$el.find("."+t+"-filter").each(function(){var s=$.trim($(this).text()),a=e[s],o=a[t];if(o==i)$(this).empty(),$(this).addClass("current-filter"),$(this).append(s);else if(o==n){$(this).empty();var l=$('<a href="#">'+s+"</a>");l.click(function(){r.set_categorical_filter(t,o)}),$(this).removeClass("current-filter"),$(this).append(l)}}),this.grid.add_filter(t,i),this.go_page_one(),this.execute()},set_page:function(t){var i=this;this.$el.find(".page-link").each(function(){var e,n=$(this).attr("id"),r=parseInt(n.split("-")[2],10),s=i.grid.get("cur_page");if(r===t)e=$(this).children().text(),$(this).empty(),$(this).addClass("inactive-link"),$(this).text(e);else if(r===s){e=$(this).text(),$(this).empty(),$(this).removeClass("inactive-link");var a=$('<a href="#">'+e+"</a>");a.click(function(){i.set_page(r)}),$(this).append(a)}}),"all"===t?this.grid.set("cur_page",t):this.grid.set("cur_page",parseInt(t,10)),this.execute()},submit_operation:function(t,i){var e=$(t).val();if(!this.$el.find('input[name="id"]:checked').length>0)return!1;var n=_.findWhere(this.grid.attributes.operations,{label:e});n&&!i&&(i=n.confirm||"");var r=[];return this.$el.find("input[name=id]:checked").each(function(){r.push($(this).val())}),this.execute({operation:e,id:r,confirmation_text:i}),!0},check_all_items:function(){var t,i=document.getElementById("check_all"),e=document.getElementsByTagName("input"),n=0;if(!0===i.checked)for(t=0;t<e.length;t++)-1!==e[t].name.indexOf("id")&&(e[t].checked=!0,n++);else for(t=0;t<e.length;t++)-1!==e[t].name.indexOf("id")&&(e[t].checked=!1);this.init_grid_elements()},go_page_one:function(){var t=this.grid.get("cur_page");null!==t&&void 0!==t&&"all"!==t&&this.grid.set("cur_page",1)},execute:function(t){var i=null,e=null,n=null,r=null,s=null;if(t&&(e=t.href,n=t.operation,i=t.id,r=t.confirmation_text,s=t.target,void 0!==e&&-1!=e.indexOf("operation="))){var a=e.split("?");if(a.length>1)for(var o=a[1],l=o.split("&"),d=0;d<l.length;d++)-1!=l[d].indexOf("operation")?(n=l[d].split("=")[1],n=n.replace(/\+/g," ")):-1!=l[d].indexOf("id")&&(i=l[d].split("=")[1])}return n&&i?!(r&&""!=r&&"None"!=r&&"null"!=r&&!confirm(r))&&(n=n.toLowerCase(),this.grid.set({operation:n,item_ids:i}),this.grid.can_async_op(n)?this.update_grid():this.go_to(s,e),!1):e?(this.go_to(s,e),!1):(this.grid.get("async")?this.update_grid():this.go_to(s,e),!1)},go_to:function(t,i){var e=this.grid.get("async");switch(this.grid.set("async",!1),advanced_search=this.$el.find("#advanced-search").is(":visible"),this.grid.set("advanced_search",advanced_search),i||(i=this.grid.get("url_base")+"?"+$.param(this.grid.get_url_data())),this.grid.set({operation:void 0,item_ids:void 0,async:e}),t){case"inbound":var n=$(".grid-header").closest(".inbound");if(0!==n.length)return void n.load(i);break;case"top":window.top.location=i;break;default:window.location=i}},update_grid:function(){var t=this.grid.get("operation")?"POST":"GET";this.$el.find(".loading-elt-overlay").show();var i=this;$.ajax({type:t,url:i.grid.get("url_base"),data:i.grid.get_url_data(),error:function(t){alert("Grid refresh failed")},success:function(t){var e=i.grid.get("embedded"),n=i.grid.get("insert"),r=$.parseJSON(t);r.embedded=e,r.insert=n,i.init_grid(r),i.$el.find(".loading-elt-overlay").hide()},complete:function(){i.grid.set({operation:void 0,item_ids:void 0})}})}})});
//# sourceMappingURL=../../../maps/mvc/grid/grid-view.js.map
