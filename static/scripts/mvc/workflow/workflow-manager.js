"use strict";define(["mvc/workflow/workflow-connector","libs/toastr"],function(t,n){function o(t,e){this.app=t,this.canvas_container=e,this.id_counter=0,this.nodes={},this.name=null,this.has_changes=!1,this.active_form_has_changes=!1,this.workflowOutputLabels={}}return $.extend(o.prototype,{canLabelOutputWith:function(t){return!t||!(t in this.workflowOutputLabels)},registerOutputLabel:function(t){t&&(this.workflowOutputLabels[t]=!0)},unregisterOutputLabel:function(t){t&&delete this.workflowOutputLabels[t]},updateOutputLabel:function(t,e){t&&this.unregisterOutputLabel(t),this.canLabelOutputWith(e)||n.warning("Workflow contains duplicate workflow output labels "+e+". This must be fixed before it can be saved."),e&&this.registerOutputLabel(e)},attemptUpdateOutputLabel:function(t,e,n){return!!this.canLabelOutputWith(n)&&(t.labelWorkflowOutput(e,n),t.nodeView.redrawWorkflowOutputs(),!0)},create_node:function(t,e,n){var o=this.app.prebuildNode(t,e,n);return this.add_node(o),this.fit_canvas_to_nodes(),this.app.canvas_manager.draw_overview(),this.activate_node(o),o},add_node:function(t){t.id=this.id_counter,t.element.attr("id","wf-node-step-"+t.id),this.id_counter++,this.nodes[t.id]=t,this.has_changes=!0,t.workflow=this},remove_node:function(t){this.active_node==t&&this.clear_active_node(),delete this.nodes[t.id],this.has_changes=!0},remove_all:function(){wf=this,$.each(this.nodes,function(t,e){e.destroy(),wf.remove_node(e)})},rectify_workflow_outputs:function(){var t=!1,e=!1;if($.each(this.nodes,function(n,o){o.workflow_outputs&&o.workflow_outputs.length>0&&(t=!0),$.each(o.post_job_actions,function(t,n){"HideDatasetAction"===n.action_type&&(e=!0)})}),!1!==t||!1!==e){var n=this;$.each(this.nodes,function(e,o){if("tool"===o.type){var i=!1;null==o.post_job_actions&&(o.post_job_actions={},i=!0);var a=[];$.each(o.post_job_actions,function(t,e){"HideDatasetAction"==e.action_type&&a.push(t)}),a.length>0&&$.each(a,function(t,e){i=!0,delete o.post_job_actions[e]}),t&&$.each(o.output_terminals,function(t,e){if(!0===!o.isWorkflowOutput(e.name)){i=!0;var n={action_type:"HideDatasetAction",output_name:e.name,action_arguments:{}};o.post_job_actions["HideDatasetAction"+e.name]=null,o.post_job_actions["HideDatasetAction"+e.name]=n}}),n.active_node==o&&!0===i&&n.reload_active_node()}})}},to_simple:function(){var t={};return $.each(this.nodes,function(e,n){var o={};$.each(n.input_terminals,function(t,e){o[e.name]=null;var n=[];$.each(e.connectors,function(t,i){if(i.handle1){var a={id:i.handle1.node.id,output_name:i.handle1.name},s=e.attributes.input.input_subworkflow_step_id;void 0!==s&&(a.input_subworkflow_step_id=s),n[t]=a,o[e.name]=n}})});var i={};n.post_job_actions&&$.each(n.post_job_actions,function(t,e){var n={action_type:e.action_type,output_name:e.output_name,action_arguments:e.action_arguments};i[e.action_type+e.output_name]=null,i[e.action_type+e.output_name]=n}),n.workflow_outputs||(n.workflow_outputs=[]);var a={id:n.id,type:n.type,content_id:n.content_id,tool_version:n.config_form.version,tool_state:n.tool_state,errors:n.errors,input_connections:o,position:$(n.element).position(),annotation:n.annotation,post_job_actions:n.post_job_actions,uuid:n.uuid,label:n.label,workflow_outputs:n.workflow_outputs};t[n.id]=a}),{steps:t}},from_simple:function(e,n){var o=void 0===n||n;wf=this;var i=0;o?wf.name=e.name:i=Object.keys(wf.nodes).length;var a=i,s=!1;$.each(e.steps,function(t,e){var n=wf.app.prebuildNode(e.type,e.name,e.content_id);o||(e.uuid=null,$.each(e.workflow_outputs,function(t,e){e.uuid=null})),n.init_field_data(e),e.position&&n.element.css({top:e.position.top,left:e.position.left}),n.id=parseInt(e.id)+i,wf.nodes[n.id]=n,a=Math.max(a,parseInt(t)+i),s||(n.workflow_outputs.length>0?s=!0:$.each(n.post_job_actions||[],function(t,e){"HideDatasetAction"===e.action_type&&(s=!0)}))}),wf.id_counter=a+1,$.each(e.steps,function(e,n){var o=wf.nodes[parseInt(e)+i];$.each(n.input_connections,function(e,n){n&&($.isArray(n)||(n=[n]),$.each(n,function(n,a){var s=wf.nodes[parseInt(a.id)+i],c=new t;c.connect(s.output_terminals[a.output_name],o.input_terminals[e]),c.redraw()}))}),s&&$.each(o.output_terminals,function(t,e){void 0===o.post_job_actions["HideDatasetAction"+e.name]&&(o.addWorkflowOutput(e.name),callout=$(o.element).find(".callout."+e.name),callout.find("img").attr("src",Galaxy.root+"static/images/fugue/asterisk-small.png"),wf.has_changes=!0)})})},check_changes_in_active_form:function(){this.active_form_has_changes&&(this.has_changes=!0,$("#right-content").find("form").submit(),this.active_form_has_changes=!1)},reload_active_node:function(){if(this.active_node){var t=this.active_node;this.clear_active_node(),this.activate_node(t)}},clear_active_node:function(){this.active_node&&(this.active_node.make_inactive(),this.active_node=null),this.app.showAttributes()},activate_node:function(t){this.active_node!=t&&(this.check_changes_in_active_form(),this.clear_active_node(),this.app.showForm(t.config_form,t),t.make_active(),this.active_node=t)},node_changed:function(t,e){this.has_changes=!0,this.active_node==t&&e&&(this.check_changes_in_active_form(),this.app.showForm(t.config_form,t,e)),this.app.showWorkflowParameters()},layout:function(){this.check_changes_in_active_form(),this.has_changes=!0;var t={},e={};for($.each(this.nodes,function(n,o){void 0===t[n]&&(t[n]=0),void 0===e[n]&&(e[n]=[])}),$.each(this.nodes,function(n,o){$.each(o.input_terminals,function(n,i){$.each(i.connectors,function(n,i){var a=i.handle1.node;t[o.id]+=1,e[a.id].push(o.id)})})}),node_ids_by_level=[];;){level_parents=[];for(var n in t)0==t[n]&&level_parents.push(n);if(0==level_parents.length)break;node_ids_by_level.push(level_parents);for(var o in level_parents){var i=level_parents[o];delete t[i];for(var a in e[i])t[e[i][a]]-=1}}if(!t.length){var s=this.nodes;v_pad=30;var c=80;$.each(node_ids_by_level,function(t,e){e.sort(function(t,e){return $(s[t].element).position().top-$(s[e].element).position().top});var n=0,o=v_pad;$.each(e,function(t,e){var i=s[e],a=$(i.element);$(a).css({top:o,left:c}),n=Math.max(n,$(a).width()),o+=$(a).height()+v_pad}),c+=n+80}),$.each(s,function(t,e){e.redraw()})}},bounds_for_all_nodes:function(){var t,n=1/0,o=-1/0,i=1/0,a=-1/0;return $.each(this.nodes,function(s,c){e=$(c.element),t=e.position(),n=Math.min(n,t.left),o=Math.max(o,t.left+e.width()),i=Math.min(i,t.top),a=Math.max(a,t.top+e.width())}),{xmin:n,xmax:o,ymin:i,ymax:a}},fit_canvas_to_nodes:function(){function t(t,e){return Math.ceil(t/e)*e}function e(t,e){return t<e||t>3*e?(new_pos=(Math.ceil(t%e/e)+1)*e,-(t-new_pos)):0}var n=this.bounds_for_all_nodes(),o=this.canvas_container.position(),i=this.canvas_container.parent(),a=e(n.xmin,100),s=e(n.ymin,100);a=Math.max(a,o.left),s=Math.max(s,o.top);var c=o.left-a,u=o.top-s,_=t(n.xmax+100,100)+a,r=t(n.ymax+100,100)+s;_=Math.max(_,-c+i.width()),r=Math.max(r,-u+i.height()),this.canvas_container.css({left:c,top:u,width:_,height:r}),this.canvas_container.children().each(function(){var t=$(this).position();$(this).css("left",t.left+a),$(this).css("top",t.top+s)})}}),o});
//# sourceMappingURL=../../../maps/mvc/workflow/workflow-manager.js.map
