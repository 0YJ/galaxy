define(["exports","utils/utils","mvc/workflow/workflow-manager","mvc/workflow/workflow-canvas","mvc/workflow/workflow-node","mvc/workflow/workflow-icons","mvc/workflow/workflow-forms","mvc/ui/ui-misc","utils/async-save-text","libs/toastr","ui/editable-text"],function(o,t,e,i,a,n,s,l,r,d){"use strict";function w(o){return o&&o.__esModule?o:{default:o}}function f(o){var t=$("#galaxy_tools").contents();0===t.length&&(t=$(document),$(this).removeClass("search_active"),t.find(".toolTitle").removeClass("search_match"),t.find(".toolSectionBody").hide(),t.find(".toolTitle").show(),t.find(".toolPanelLabel").show(),t.find(".toolSectionWrapper").each(function(){"recently_used_wrapper"!==$(this).attr("id")?$(this).show():$(this).hasClass("user_pref_visible")&&$(this).show()}),t.find("#search-no-results").hide(),t.find("#search-spinner").hide(),o&&t.find("#tool-search-query").val("search tools"))}function c(o,t){var e=m.default[t];if(e){var i=$('<i class="icon fa">&nbsp;</i>').addClass(e);o.before(i)}}Object.defineProperty(o,"__esModule",{value:!0});var u=w(t),h=w(e),p=w(i),v=w(a),m=w(n),k=w(s),g=w(l),y=w(r);!function(o){if(o&&o.__esModule)return o;var t={};if(null!=o)for(var e in o)Object.prototype.hasOwnProperty.call(o,e)&&(t[e]=o[e]);t.default=o}(d);window.workflow_globals=window.workflow_globals||{},o.default=Backbone.View.extend({initialize:function(o){function t(){$.jStorage.set("overview-off",!1),$("#overview-border").css("right","0px"),$("#close-viewport").css("background-position","0px 0px")}function e(){$.jStorage.set("overview-off",!0),$("#overview-border").css("right","20000px"),$("#close-viewport").css("background-position","12px 0px")}var i=window.workflow_globals.app=this;this.options=o,this.urls=o&&o.urls||{};var a=function(o,t){if(show_message("Saving workflow","progress"),i.workflow.check_changes_in_active_form(),!i.workflow.has_changes)return hide_modal(),void(t&&t());i.workflow.rectify_workflow_outputs(),u.default.request({url:Galaxy.root+"api/workflows/"+i.options.id,type:"PUT",data:{workflow:i.workflow.to_simple()},success:function(o){var e=$("<div/>").text(o.message);if(o.errors){e.addClass("warningmark");var a=$("<ul/>");$.each(o.errors,function(o,t){$("<li/>").text(t).appendTo(a)}),e.append(a)}else e.addClass("donemark");i.workflow.name=o.name,i.workflow.has_changes=!1,i.workflow.stored=!0,i.showWorkflowParameters(),o.errors?window.show_modal("Saving workflow",e,{Ok:hide_modal}):(t&&t(),hide_modal())},error:function(o){window.show_modal("Saving workflow failed.",o.err_msg,{Ok:hide_modal})}})};$("#tool-search-query").click(function(){$(this).focus(),$(this).select()}).keyup(function(){if($(this).css("font-style","normal"),this.value.length<3)f(!1);else if(this.value!=this.lastValue){$(this).addClass("search_active");var o=this.value;this.timer&&clearTimeout(this.timer),$("#search-spinner").show(),this.timer=setTimeout(function(){$.get(i.urls.tool_search,{q:o},function(o){if($("#search-no-results").hide(),$(".toolSectionWrapper").hide(),$(".toolSectionWrapper").find(".toolTitle").hide(),0!=o.length){var t=$.map(o,function(o,t){return"link-"+o});$(t).each(function(o,t){$("[id='"+t+"']").parent().addClass("search_match"),$("[id='"+t+"']").parent().show().parent().parent().show().parent().show()}),$(".toolPanelLabel").each(function(){for(var o=$(this),t=o.next(),e=!0;0!==t.length&&t.hasClass("toolTitle");){if(t.is(":visible")){e=!1;break}t=t.next()}e&&o.hide()})}else $("#search-no-results").show();$("#search-spinner").hide()},"json")},400)}this.lastValue=this.value}),this.canvas_manager=window.workflow_globals.canvas_manager=new p.default(this,$("#canvas-viewport"),$("#overview")),this.reset(),this.datatypes=JSON.parse($.ajax({url:Galaxy.root+"api/datatypes",async:!1}).responseText),this.datatypes_mapping=JSON.parse($.ajax({url:Galaxy.root+"api/datatypes/mapping",async:!1}).responseText),this.ext_to_type=this.datatypes_mapping.ext_to_class_name,this.type_to_type=this.datatypes_mapping.class_to_classes,this._workflowLoadAjax(i.options.id,{success:function(o){i.reset(),i.workflow.from_simple(o,!0),i.workflow.has_changes=!1,i.workflow.fit_canvas_to_nodes(),i.scroll_to_nodes(),i.canvas_manager.draw_overview();var t="";_.each(o.steps,function(e,a){var n="";e.errors&&(n+="<li>"+e.errors+"</li>"),_.each(o.upgrade_messages[a],function(o){n+="<li>"+o+"</li>"}),n&&(t+="<li>Step "+(parseInt(a,10)+1)+": "+i.workflow.nodes[a].name+"<ul>"+n+"</ul></li>")}),t?window.show_modal("Issues loading this workflow","Please review the following issues, possibly resulting from tool upgrades or changes.<p><ul>"+t+"</ul></p>",{Continue:hide_modal}):hide_modal(),i.showWorkflowParameters()},beforeSubmit:function(o){show_message("Loading workflow","progress")}}),window.make_popupmenu&&make_popupmenu($("#workflow-options-button"),{Save:a,"Save As":function(){var o=$('<form><label style="display:inline-block; width: 100%;">Save as name: </label><input type="text" id="workflow_rename" style="width: 80%;" autofocus/><br><label style="display:inline-block; width: 100%;">Annotation: </label><input type="text" id="wf_annotation" style="width: 80%;" /></form>');window.show_modal("Save As a New Workflow",o,{OK:function(){var o=$("#workflow_rename").val().length>0?$("#workflow_rename").val():"SavedAs_"+i.workflow.name,t=$("#wf_annotation").val().length>0?$("#wf_annotation").val():"";$.ajax({url:i.urls.workflow_save_as,type:"POST",data:{workflow_name:o,workflow_annotation:t,workflow_data:function(){return JSON.stringify(i.workflow.to_simple())}}}).done(function(o){window.onbeforeunload=void 0,window.location=Galaxy.root+"workflow/editor?id="+o,hide_modal()}).fail(function(){hide_modal(),alert("Saving this workflow failed. Please contact this site's administrator.")})},Cancel:hide_modal})},Run:function(){window.location=Galaxy.root+"workflow/run?id="+i.options.id},"Edit Attributes":function(){i.workflow.clear_active_node()},"Auto Re-layout":function(){i.workflow.layout(),i.workflow.fit_canvas_to_nodes(),i.scroll_to_nodes(),i.canvas_manager.draw_overview()},Close:function(){if(i.workflow.check_changes_in_active_form(),workflow&&i.workflow.has_changes){var o=function(){window.onbeforeunload=void 0,window.document.location=i.urls.workflow_index};window.show_modal("Close workflow editor","There are unsaved changes to your workflow which will be lost.",{Cancel:hide_modal,"Save Changes":function(){a(null,o)}},{"Don't Save":o})}else window.document.location=i.urls.workflow_index}});var n=$.jStorage.get("overview-size");void 0!==n&&$("#overview-border").css({width:n,height:n}),$.jStorage.get("overview-off")?e():t(),$("#overview-border").bind("dragend",function(o,t){var e=$(this).offsetParent(),i=e.offset(),a=Math.max(e.width()-(t.offsetX-i.left),e.height()-(t.offsetY-i.top));$.jStorage.set("overview-size",a+"px")}),$("#close-viewport").click(function(){"0px"===$("#overview-border").css("right")?e():t()}),window.onbeforeunload=function(){if(workflow&&i.workflow.has_changes)return"There are unsaved changes to your workflow which will be lost."},this.options.workflows.length>0&&$("#left").find(".toolMenu").append(this._buildToolPanelWorkflows()),$("div.toolSectionBody").hide(),$("div.toolSectionTitle > span").wrap("<a href='#'></a>");var s=null;$("div.toolSectionTitle").each(function(){var o=$(this).next("div.toolSectionBody");$(this).click(function(){o.is(":hidden")?(s&&s.slideUp("fast"),s=o,o.slideDown("fast")):(o.slideUp("fast"),s=null)})}),(0,y.default)("workflow-name","workflow-name",i.urls.rename_async,"new_name"),$("#workflow-tag").click(function(){return $(".tag-area").click(),!1}),(0,y.default)("workflow-annotation","workflow-annotation",i.urls.annotate_async,"new_annotation",25,!0,4)},_buildToolPanelWorkflows:function(){var o=this,t=$('<div class="toolSectionWrapper"><div class="toolSectionTitle"><a href="#"><span>Workflows</span></a></div><div class="toolSectionBody"><div class="toolSectionBg"/></div></div>');return _.each(this.options.workflows,function(e){if(e.id!==o.options.id){var i=new g.default.ButtonIcon({icon:"fa fa-copy",cls:"ui-button-icon-plain",tooltip:"Copy and insert individual steps",onclick:function(){e.step_count<2?o.copy_into_workflow(e.id,e.name):Galaxy.modal.show({title:"Warning",body:"This will copy "+e.step_count+" new steps into your workflow.",buttons:{Cancel:function(){Galaxy.modal.hide()},Copy:function(){Galaxy.modal.hide(),o.copy_into_workflow(e.id,e.name)}}})}}),a=$("<a/>").attr("href","#").html(e.name).on("click",function(){o.add_node_for_subworkflow(e.latest_id,e.name)});t.find(".toolSectionBg").append($("<div/>").addClass("toolTitle").append(a).append(i.$el))}}),t},copy_into_workflow:function(o){var t=this;this._workflowLoadAjax(o,{success:function(o){t.workflow.from_simple(o,!1);var e="";$.each(o.upgrade_messages,function(o,i){e+="<li>Step "+(parseInt(o,10)+1)+": "+t.workflow.nodes[o].name+"<ul>",$.each(i,function(o,t){e+="<li>"+t+"</li>"}),e+="</ul></li>"}),e?window.show_modal("Subworkflow embedded with changes","Problems were encountered loading this workflow (possibly a result of tool upgrades). Please review the following parameters and then save.<ul>"+e+"</ul>",{Continue:hide_modal}):hide_modal()},beforeSubmit:function(o){show_message("Importing workflow","progress")}})},reset:function(){this.workflow&&this.workflow.remove_all(),this.workflow=window.workflow_globals.workflow=new h.default(this,$("#canvas-container"))},scroll_to_nodes:function(){var o,t,e=$("#canvas-viewport"),i=$("#canvas-container");t=i.width()<e.width()?(e.width()-i.width())/2:0,o=i.height()<e.height()?(e.height()-i.height())/2:0,i.css({left:t,top:o})},_workflowLoadAjax:function(o,t){$.ajax(u.default.merge(t,{url:this.urls.load_workflow,data:{id:o,_:"true"},dataType:"json",cache:!1}))},_moduleInitAjax:function(o,t){var e=this;u.default.request({type:"POST",url:Galaxy.root+"api/workflows/build_module",data:t,success:function(t){o.init_field_data(t),o.update_field_data(t),e.workflow.activate_node(o)}})},add_node_for_tool:function(o,t){var e=this.workflow.create_node("tool",t,o);this._moduleInitAjax(e,{type:"tool",tool_id:o,_:"true"})},add_node_for_subworkflow:function(o,t){var e=this.workflow.create_node("subworkflow",t,o);this._moduleInitAjax(e,{type:"subworkflow",content_id:o,_:"true"})},add_node_for_module:function(o,t){var e=this.workflow.create_node(o,t);this._moduleInitAjax(e,{type:o,_:"true"})},display_pja:function(o,t){var e=this;$("#pja_container").append(get_pja_form(o,t)),$("#pja_container>.toolForm:last>.toolFormTitle>.buttons").click(function(){var o=$(this).closest(".toolForm",".action_tag").children(".action_tag:first").text();$(this).closest(".toolForm").remove(),delete e.workflow.active_node.post_job_actions[o],e.workflow.active_form_has_changes=!0})},display_pja_list:function(){return pja_list},display_file_list:function(o){var t="<select id='node_data_list' name='node_data_list'>";for(var e in o.output_terminals)t+="<option value='"+e+"'>"+e+"</option>";return t+="</select>"},new_pja:function(o,t,e){if(void 0===e.post_job_actions&&(e.post_job_actions={}),void 0===e.post_job_actions[o+t]){var i={};return i.action_type=o,i.output_name=t,e.post_job_actions[o+t]=null,e.post_job_actions[o+t]=i,display_pja(i,e),this.workflow.active_form_has_changes=!0,!0}return!1},showWorkflowParameters:function(){var o=/\$\{.+?\}/g,t=[],e=$("#workflow-parameters-container"),i=$("#workflow-parameters-box"),a="",n=[];$.each(this.workflow.nodes,function(e,i){i.config_form&&i.config_form.inputs&&u.default.deepeach(i.config_form.inputs,function(t){if("string"==typeof t.value){var e=t.value.match(o);e&&(n=n.concat(e))}}),i.post_job_actions&&$.each(i.post_job_actions,function(t,e){e.action_arguments&&$.each(e.action_arguments,function(t,e){var i=e.match(o);i&&(n=n.concat(i))})}),n&&$.each(n,function(o,e){-1===$.inArray(e,t)&&t.push(e)})}),t&&0!==t.length?($.each(t,function(o,t){a+="<div>"+t.substring(2,t.length-1)+"</div>"}),e.html(a),i.show()):(e.html(a),i.hide())},showAttributes:function(){$(".right-content").hide(),$("#edit-attributes").show()},showForm:function(o,t){var e="right-content",i=e+"-"+t.id,a=$("#"+e);if(o&&0==a.find("#"+i).length){var n=$('<div id="'+i+'" class="'+e+'"/>');if(o.node=t,o.workflow=this.workflow,o.datatypes=this.datatypes,o.icon=m.default[t.type],o.cls="ui-portlet-narrow",t){var s="tool"==t.type?"Tool":"Default";n.append(new k.default[s](o).form.$el),a.append(n)}else Galaxy.emit.debug("workflow-view::initialize()","Node not found in workflow.")}$("."+e).hide(),a.find("#"+i).show(),a.show(),a.scrollTop()},isSubType:function(o,t){return o=this.ext_to_type[o],t=this.ext_to_type[t],this.type_to_type[o]&&t in this.type_to_type[o]},prebuildNode:function(o,t,e){var i=this,a=$("<div class='toolForm toolFormInCanvas'/>"),n=$("<div class='toolFormTitle unselectable'><span class='nodeTitle'>"+t+"</div></div>");c(n.find(".nodeTitle"),o),a.append(n),a.css("left",$(window).scrollLeft()+20),a.css("top",$(window).scrollTop()+20),a.append($("<div class='toolFormBody'></div>"));var s=new v.default(this,{element:a});s.type=o,s.content_id=e;var l="<div><img height='16' align='middle' src='"+Galaxy.root+"static/images/loading_small_white_bg.gif'/> loading tool info...</div>";a.find(".toolFormBody").append(l);var r=$("<div class='buttons' style='float: right;'></div>");r.append($("<div/>").addClass("fa-icon-button fa fa-times").click(function(o){s.destroy()})),a.appendTo("#canvas-container");var d=$("#canvas-container").position(),w=$("#canvas-container").parent(),f=a.width(),u=a.height();return a.css({left:-d.left+w.width()/2-f/2,top:-d.top+w.height()/2-u/2}),r.prependTo(a.find(".toolFormTitle")),f+=r.width()+10,a.css("width",f),a.bind("dragstart",function(){i.workflow.activate_node(s)}).bind("dragend",function(){i.workflow.node_changed(this),i.workflow.fit_canvas_to_nodes(),i.canvas_manager.draw_overview()}).bind("dragclickonly",function(){i.workflow.activate_node(s)}).bind("drag",function(o,t){var e=$(this).offsetParent().offset(),i=t.offsetX-e.left,a=t.offsetY-e.top;$(this).css({left:i,top:a}),$(this).find(".terminal").each(function(){this.terminal.redraw()})}),s}})});
//# sourceMappingURL=../../../maps/mvc/workflow/workflow-view.js.map
