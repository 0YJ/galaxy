define(["mvc/workflow/workflow-globals"],function(t){function e(t){this.collectionType=t,this.isCollection=!0,this.rank=t.split(":").length}$.extend(e.prototype,{append:function(t){return t===NULL_COLLECTION_TYPE_DESCRIPTION?this:t===ANY_COLLECTION_TYPE_DESCRIPTION?otherCollectionType:new e(this.collectionType+":"+t.collectionType)},canMatch:function(t){return t!==NULL_COLLECTION_TYPE_DESCRIPTION&&(t===ANY_COLLECTION_TYPE_DESCRIPTION||t.collectionType==this.collectionType)},canMapOver:function(t){if(t===NULL_COLLECTION_TYPE_DESCRIPTION)return!1;if(t===ANY_COLLECTION_TYPE_DESCRIPTION)return!1;if(this.rank<=t.rank)return!1;var e=t.collectionType;return this._endsWith(this.collectionType,e)},effectiveMapOver:function(t){var n=t.collectionType;return new e(this.collectionType.substring(0,this.collectionType.length-n.length-1))},equal:function(t){return t.collectionType==this.collectionType},toString:function(){return"CollectionType["+this.collectionType+"]"},_endsWith:function(t,e){return-1!==t.indexOf(e,t.length-e.length)}}),NULL_COLLECTION_TYPE_DESCRIPTION={isCollection:!1,canMatch:function(t){return!1},canMapOver:function(t){return!1},toString:function(){return"NullCollectionType[]"},append:function(t){return t},equal:function(t){return t===this}},ANY_COLLECTION_TYPE_DESCRIPTION={isCollection:!0,canMatch:function(t){return NULL_COLLECTION_TYPE_DESCRIPTION!==t},canMapOver:function(t){return!1},toString:function(){return"AnyCollectionType[]"},append:function(t){throw"Cannot append to ANY_COLLECTION_TYPE_DESCRIPTION"},equal:function(t){return t===this}};var n=Backbone.Model.extend({initialize:function(t){this.mapOver=t.mapOver||NULL_COLLECTION_TYPE_DESCRIPTION,this.terminal=t.terminal,this.terminal.terminalMapping=this},disableMapOver:function(){this.setMapOver(NULL_COLLECTION_TYPE_DESCRIPTION)},setMapOver:function(t){this.mapOver=t,this.trigger("change")}}),i=Backbone.Model.extend({initialize:function(t){this.element=t.element,this.connectors=[]},connect:function(t){this.connectors.push(t),this.node&&this.node.markChanged()},disconnect:function(t){this.connectors.splice($.inArray(t,this.connectors),1),this.node&&(this.node.markChanged(),this.resetMappingIfNeeded())},redraw:function(){$.each(this.connectors,function(t,e){e.redraw()})},destroy:function(){$.each(this.connectors.slice(),function(t,e){e.destroy()})},destroyInvalidConnections:function(){_.each(this.connectors,function(t){t.destroyIfInvalid()})},setMapOver:function(t){this.multiple||this.mapOver().equal(t)||(this.terminalMapping.setMapOver(t),_.each(this.node.output_terminals,function(e){e.setMapOver(t)}))},mapOver:function(){return this.terminalMapping?this.terminalMapping.mapOver:NULL_COLLECTION_TYPE_DESCRIPTION},isMappedOver:function(){return this.terminalMapping&&this.terminalMapping.mapOver.isCollection},resetMapping:function(){this.terminalMapping.disableMapOver()},resetMappingIfNeeded:function(){}}),o=i.extend({initialize:function(t){i.prototype.initialize.call(this,t),this.datatypes=t.datatypes},resetMappingIfNeeded:function(){this.node.hasConnectedOutputTerminals()||this.node.hasConnectedMappedInputTerminals()||_.each(this.node.mappedInputTerminals(),function(t){t.resetMappingIfNeeded()}),!this.node.hasMappedOverInputTerminals()&&this.resetMapping()},resetMapping:function(){this.terminalMapping.disableMapOver(),_.each(this.connectors,function(t){var e=t.handle2;e&&(e.resetMappingIfNeeded(),t.destroyIfInvalid())})}}),c=i.extend({initialize:function(t){i.prototype.initialize.call(this,t),this.update(t.input)},canAccept:function(t){return!this._inputFilled()&&this.attachable(t)},resetMappingIfNeeded:function(){this.mapOver().isCollection&&((this.node.hasConnectedMappedInputTerminals()||!this.node.hasConnectedOutputTerminals())&&this.resetMapping())},resetMapping:function(){this.terminalMapping.disableMapOver(),this.node.hasMappedOverInputTerminals()||_.each(this.node.output_terminals,function(t){t.resetMapping()})},connected:function(){return 0!==this.connectors.length},_inputFilled:function(){var t;return this.connected()?this.multiple?this._collectionAttached()?inputsFilled=!0:t=!1:t=!0:t=!1,t},_collectionAttached:function(){if(this.connected()){var t=this.connectors[0].handle1;return!!t&&!!(t.isCollection||t.isMappedOver()||t.datatypes.indexOf("input_collection")>0)}return!1},_mappingConstraints:function(){if(!this.node)return[];var t=this.mapOver();if(t.isCollection)return[t];var e=[];return this.node.hasConnectedOutputTerminals()?e.push(_.first(_.values(this.node.output_terminals)).mapOver()):_.each(this.node.connectedMappedInputTerminals(),function(t){e.push(t.mapOver())}),e},_producesAcceptableDatatype:function(e){for(var n in this.datatypes){var i=this.datatypes[n];if("input"==i)return!0;var o=new Array;if(o=o.concat(e.datatypes),e.node.post_job_actions)for(var c in e.node.post_job_actions){var a=e.node.post_job_actions[c];"ChangeDatatypeAction"!=a.action_type||""!=a.output_name&&a.output_name!=e.name||!a.action_arguments||o.push(a.action_arguments.newtype)}for(var r in o){var s=o[r];if("input"==s||"_sniff_"==s||"input_collection"==s||t.app.isSubType(o[r],i))return!0}}return!1},_otherCollectionType:function(t){var e=NULL_COLLECTION_TYPE_DESCRIPTION;t.isCollection&&(e=t.collectionType);var n=t.mapOver();return n.isCollection&&(e=n.append(e)),e}});return{InputTerminal:c.extend({update:function(t){this.datatypes=t.extensions,this.multiple=t.multiple,this.collection=!1},connect:function(t){c.prototype.connect.call(this,t);var e=t.handle1;if(e){var n=this._otherCollectionType(e);n.isCollection&&this.setMapOver(n)}},attachable:function(t){var e=this._otherCollectionType(t),n=this.mapOver();if(e.isCollection){if(this.multiple)return!(this.connected()&&!this._collectionAttached())&&(1==e.rank&&this._producesAcceptableDatatype(t));if(n.isCollection&&n.canMatch(e))return this._producesAcceptableDatatype(t);return!!this._mappingConstraints().every(_.bind(e.canMatch,e))&&this._producesAcceptableDatatype(t)}return!n.isCollection&&this._producesAcceptableDatatype(t)}}),OutputTerminal:o,InputCollectionTerminal:c.extend({update:function(t){this.multiple=!1,this.collection=!0,this.datatypes=t.extensions;var n=[];t.collection_types?_.each(t.collection_types,function(t){n.push(new e(t))}):n.push(ANY_COLLECTION_TYPE_DESCRIPTION),this.collectionTypes=n},connect:function(t){c.prototype.connect.call(this,t);var e=t.handle1;if(e){var n=this._effectiveMapOver(e);this.setMapOver(n)}},_effectiveMapOver:function(t){var e=this.collectionTypes,n=this._otherCollectionType(t);if(!_.some(e,function(t){return t.canMatch(n)}))for(var i in e){var o=e[i],c=n.effectiveMapOver(o);if(c!=NULL_COLLECTION_TYPE_DESCRIPTION)return c}return NULL_COLLECTION_TYPE_DESCRIPTION},_effectiveCollectionTypes:function(){var t=this.mapOver();return _.map(this.collectionTypes,function(e){return t.append(e)})},attachable:function(t){var e=this._otherCollectionType(t);if(e.isCollection){var n=this._effectiveCollectionTypes(),i=this.mapOver();if(_.some(n,function(t){return t.canMatch(e)}))return this._producesAcceptableDatatype(t);if(i.isCollection)return!1;if(_.some(this.collectionTypes,function(t){return e.canMapOver(t)})){var o=this._effectiveMapOver(t);if(!o.isCollection)return!1;if(this._mappingConstraints().every(o.canMatch))return this._producesAcceptableDatatype(t)}}return!1}}),OutputCollectionTerminal:i.extend({initialize:function(t){i.prototype.initialize.call(this,t),this.datatypes=t.datatypes,this.collectionType=new e(t.collection_type),this.isCollection=!0},update:function(t){var n=new e(t.collection_type);n.collectionType!=this.collectionType.collectionType&&_.each(this.connectors,function(t){t.destroy()}),this.collectionType=n}}),TerminalMapping:n,CollectionTypeDescription:e,NULL_COLLECTION_TYPE_DESCRIPTION:NULL_COLLECTION_TYPE_DESCRIPTION,ANY_COLLECTION_TYPE_DESCRIPTION:ANY_COLLECTION_TYPE_DESCRIPTION}});
//# sourceMappingURL=../../../maps/mvc/workflow/workflow-terminals.js.map
