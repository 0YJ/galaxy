"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _underscore=require("libs/underscore"),_underscore2=_interopRequireDefault(_underscore),_backbone=require("libs/backbone"),_backbone2=_interopRequireDefault(_backbone),_baseMvc=require("mvc/base-mvc"),_baseMvc2=_interopRequireDefault(_baseMvc),ControlledFetchCollection=_backbone2.default.Collection.extend({initialize:function(e,t){_backbone2.default.Collection.prototype.initialize.call(this,e,t),this.setOrder(t.order||this.order,{silent:!0})},_setUpListeners:function(){return this.on({"changed-order":this.sort})},fetch:function(e){return e=this._buildFetchOptions(e),Galaxy.debug("fetch options:",e),_backbone2.default.Collection.prototype.fetch.call(this,e)},_buildFetchOptions:function(e){var t=this;(e=_underscore2.default.clone(e)||{}).traditional=!0,e.data=e.data||t._buildFetchData(e),Galaxy.debug("data:",e.data);var i=this._buildFetchFilters(e);return Galaxy.debug("filters:",i),_underscore2.default.isEmpty(i)||_underscore2.default.extend(e.data,this._fetchFiltersToAjaxData(i)),Galaxy.debug("data:",e.data),e},_buildFetchData:function(e){var t={};return this.order&&(t.order=this.order),_underscore2.default.defaults(_underscore2.default.pick(e,this._fetchParams),t)},_fetchParams:["order","limit","offset","view","keys"],_buildFetchFilters:function(e){return _underscore2.default.clone(e.filters||{})},_fetchFiltersToAjaxData:function(e){var t={q:[],qv:[]};return _underscore2.default.each(e,function(e,i){void 0!==e&&""!==e&&(!0===e&&(e="True"),!1===e&&(e="False"),null===e&&(e="None"),t.q.push(i),t.qv.push(e))}),t},reset:function(e,t){return this.allFetched=!1,_backbone2.default.Collection.prototype.reset.call(this,e,t)},order:null,comparators:{update_time:_baseMvc2.default.buildComparator("update_time",{ascending:!1}),"update_time-asc":_baseMvc2.default.buildComparator("update_time",{ascending:!0}),create_time:_baseMvc2.default.buildComparator("create_time",{ascending:!1}),"create_time-asc":_baseMvc2.default.buildComparator("create_time",{ascending:!0})},setOrder:function(e,t){t=t||{};var i=this,r=i.comparators[e];if(_underscore2.default.isUndefined(r))throw new Error("unknown order: "+e);if(r!==i.comparator)return i.order=e,i.comparator=r,t.silent||i.trigger("changed-order",t),i}}),PaginatedCollection=ControlledFetchCollection.extend({limitPerPage:500,initialize:function(e,t){ControlledFetchCollection.prototype.initialize.call(this,e,t),this.currentPage=t.currentPage||0},getTotalItemCount:function(){return this.length},shouldPaginate:function(){return this.getTotalItemCount()>=this.limitPerPage},getLastPage:function(){return Math.floor(this.getTotalItemCount()/this.limitPerPage)},getPageCount:function(){return this.getLastPage()+1},getPageLimitOffset:function(e){return e=this.constrainPageNum(e),{limit:this.limitPerPage,offset:e*this.limitPerPage}},constrainPageNum:function(e){return Math.max(0,Math.min(e,this.getLastPage()))},fetchPage:function(e,t){var i=this;return e=i.constrainPageNum(e),i.currentPage=e,t=_underscore2.default.defaults(t||{},i.getPageLimitOffset(e)),i.trigger("fetching-more"),i.fetch(t).always(function(){i.trigger("fetching-more-done")})},fetchCurrentPage:function(e){return this.fetchPage(this.currentPage,e)},fetchPrevPage:function(e){return this.fetchPage(this.currentPage-1,e)},fetchNextPage:function(e){return this.fetchPage(this.currentPage+1,e)}}),InfinitelyScrollingCollection=ControlledFetchCollection.extend({limitOnFirstFetch:null,limitPerFetch:100,initialize:function(e,t){ControlledFetchCollection.prototype.initialize.call(this,e,t),this.limitOnFirstFetch=t.limitOnFirstFetch||this.limitOnFirstFetch,this.limitPerFetch=t.limitPerFetch||this.limitPerFetch,this.allFetched=!1,this.lastFetched=t.lastFetched||0},_buildFetchOptions:function(e){return e.remove=e.remove||!1,ControlledFetchCollection.prototype._buildFetchOptions.call(this,e)},fetchFirst:function(e){return Galaxy.debug("ControlledFetchCollection.fetchFirst:",e),e=e?_underscore2.default.clone(e):{},this.allFetched=!1,this.lastFetched=0,this.fetchMore(_underscore2.default.defaults(e,{reset:!0,limit:this.limitOnFirstFetch}))},fetchMore:function(e){Galaxy.debug("ControlledFetchCollection.fetchMore:",e),e=_underscore2.default.clone(e||{});var t=this;if(Galaxy.debug("fetchMore, options.reset:",e.reset),!e.reset&&t.allFetched)return jQuery.when();e.reset?e.offset=0:void 0===e.offset&&(e.offset=t.lastFetched);var i=e.limit=e.limit||t.limitPerFetch||null;return Galaxy.debug("fetchMore, limit:",i,"offset:",e.offset),t.trigger("fetching-more"),t.fetch(e).always(function(){t.trigger("fetching-more-done")}).done(function(e){var r=_underscore2.default.isArray(e)?e.length:0;t.lastFetched+=r,Galaxy.debug("fetchMore, lastFetched:",t.lastFetched),(!i||r<i)&&(t.allFetched=!0,t.trigger("all-fetched",this))})},fetchAll:function(e){e=e||{};var t=this;return e=_underscore2.default.pick(e,"silent"),e.filters={},t.fetch(e).done(function(){t.allFetched=!0,t.trigger("all-fetched",t)})}});exports.default={ControlledFetchCollection:ControlledFetchCollection,PaginatedCollection:PaginatedCollection,InfinitelyScrollingCollection:InfinitelyScrollingCollection};
//# sourceMappingURL=../../../maps/mvc/base/controlled-fetch-collection.js.map
