define(["utils/utils","utils/deferred","mvc/ui/ui-misc","mvc/form/form-view","mvc/tools/tools-template","mvc/citation/citation-model","mvc/citation/citation-view"],function(f,d,g,c,a,e,b){return Backbone.View.extend({initialize:function(h){var i=parent.Galaxy;if(i&&i.currUser){this.is_admin=i.currUser.get("is_admin")}else{this.is_admin=false}this.deferred=new d();this.setElement("<div/>");this.container=h.container||"body";$(this.container).append(this.$el);this._buildForm(h)},_buildForm:function(i){var h=this;this.options=f.merge(i,this.options);this.options=f.merge({icon:"fa-wrench",title:"<b>"+i.name+"</b> "+i.description+" (Galaxy Tool Version "+i.version+")",operations:this._operations(),onchange:function(j){h.deferred.reset();h.deferred.execute(function(){h._updateModel()})}},this.options);this.form=new c(this.options);this._footer();this.$el.empty();this.$el.append(this.form.$el)},_buildModel:function(j){var i=this;var h=galaxy_config.root+"api/tools/"+j.id+"/build?";if(j.job_id){h+="job_id="+j.job_id}else{if(j.dataset_id){h+="dataset_id="+j.dataset_id}else{h+="tool_version="+j.version+"&";var l=top.location.href;var m=l.indexOf("?");if(l.indexOf("tool_id=")!=-1&&m!==-1){h+=l.slice(m+1)}}}var k=this.deferred.register();f.request({type:"GET",url:h,success:function(n){i._buildForm(n.tool_model||n);i.form.message.update({status:"success",message:"Now you are using '"+i.options.name+"' version "+i.options.version+".",persistent:false});i.deferred.done(k);console.debug("tools-form::initialize() - Initial tool model ready.");console.debug(n)},error:function(n){i.deferred.done(k);console.debug("tools-form::initialize() - Initial tool model request failed.");console.debug(n);var o=n.error||"Uncaught error.";i.form.modal.show({title:"Tool cannot be executed",body:o,buttons:{Close:function(){i.form.modal.hide()}}})}})},_updateModel:function(){var j=this.options.update_url;var h=this;var k=this.form;var i={tool_id:this.options.id,tool_version:this.options.version,inputs:$.extend(true,{},h.form.data.create())};k.wait(true);var l=this.deferred.register();console.debug("tools-form-base::_updateModel() - Sending current state (see below).");console.debug(i);f.request({type:"POST",url:j,data:i,success:function(m){h.form.update(m.tool_model||m);h.options.update&&h.options.update(m);k.wait(false);console.debug("tools-form-base::_updateModel() - Received new model (see below).");console.debug(m);h.deferred.done(l)},error:function(m){h.deferred.done(l);console.debug("tools-form-base::_updateModel() - Refresh request failed.");console.debug(m)}})},_operations:function(){var j=this;var k=this.options;var n=new g.ButtonMenu({icon:"fa-cubes",title:(!k.narrow&&"Versions")||null,tooltip:"Select another tool version"});if(k.versions&&k.versions.length>1){for(var m in k.versions){var h=k.versions[m];if(h!=k.version){n.addMenu({title:"Switch to "+h,version:h,icon:"fa-cube",onclick:function(){var o=k.id.replace(k.version,this.version);var i=this.version;j.deferred.reset();j.deferred.execute(function(){j._buildModel({id:o,version:i})})}})}}}else{n.$el.hide()}var l=new g.ButtonMenu({icon:"fa-caret-down",title:(!k.narrow&&"Options")||null,tooltip:"View available options"});if(k.biostar_url){l.addMenu({icon:"fa-question-circle",title:"Question?",tooltip:"Ask a question about this tool (Biostar)",onclick:function(){window.open(k.biostar_url+"/p/new/post/")}});l.addMenu({icon:"fa-search",title:"Search",tooltip:"Search help for this tool (Biostar)",onclick:function(){window.open(k.biostar_url+"/local/search/page/?q="+k.name)}})}l.addMenu({icon:"fa-share",title:"Share",tooltip:"Share this tool",onclick:function(){prompt("Copy to clipboard: Ctrl+C, Enter",window.location.origin+galaxy_config.root+"root?tool_id="+k.id)}});if(this.is_admin){l.addMenu({icon:"fa-download",title:"Download",tooltip:"Download this tool",onclick:function(){window.location.href=galaxy_config.root+"api/tools/"+k.id+"/download"}})}if(k.requirements&&k.requirements.length>0){l.addMenu({icon:"fa-info-circle",title:"Requirements",tooltip:"Display tool requirements",onclick:function(){if(!this.visible){this.visible=true;j.form.message.update({persistent:true,message:a.requirements(k),status:"info"})}else{this.visible=false;j.form.message.update({message:""})}}})}if(k.sharable_url){l.addMenu({icon:"fa-external-link",title:"See in Tool Shed",tooltip:"Access the repository",onclick:function(){window.open(k.sharable_url)}})}return{menu:l,versions:n}},_footer:function(){var i=this.options;if(i.help!=""){this.form.$el.append(a.help(i))}if(i.citations){var k=$("<div/>");var h=new e.ToolCitationCollection();h.tool_id=i.id;var j=new b.CitationListView({el:k,collection:h});j.render();h.fetch();this.form.$el.append(k)}}})});