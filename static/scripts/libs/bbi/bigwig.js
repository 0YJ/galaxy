"use strict";define(["libs/bbi/spans","libs/bbi/jszlib","libs/bbi/jquery-ajax-native"],function(e,r){function t(){}function n(e){e&&(this.id=e)}function i(e,r){return e[r+3]<<24|e[r+2]<<16|e[r+1]<<8|e[r]}function o(e,r,t){Math.pow(10,6);return $.ajax({type:"GET",dataType:"native",url:e,timeout:5e3,beforeSend:function(e){e.setRequestHeader("Range","bytes="+r+"-"+(r+(t-1)))},xhrFields:{responseType:"arraybuffer"}})}function a(e,r){return e[r]+e[r+1]*b+e[r+2]*x+e[r+3]*I+e[r+4]*z}function s(){}function f(e,r,t,n){this.bwg=e,this.cirTreeOffset=r,this.cirTreeLength=t,this.isSummary=n}function h(e){var r=$.Deferred(),t=new s;return t.url=e,$.when(o(t.url,0,512)).then(function(e){if(!e)return r.resolve(null,"Couldn't fetch file");var n=e,i=new Uint8Array(n),o=new Int16Array(n),s=new Int32Array(n),f=i[0]+b*i[1]+x*i[2]+I*i[3];if(f==g)t.type="bigwig";else{if(f!=y)return f==w||f==p?r.resolve(null,"Currently don't support big-endian BBI files"):r.resolve(null,"Not a supported format, magic=0x"+f.toString(16));t.type="bigbed"}t.version=o[2],t.numZoomLevels=o[3],t.chromTreeOffset=a(i,8),t.unzoomedDataOffset=a(i,16),t.unzoomedIndexOffset=a(i,24),t.fieldCount=o[16],t.definedFieldCount=o[17],t.asOffset=a(i,36),t.totalSummaryOffset=a(i,44),t.uncompressBufSize=s[13],t.extHeaderOffset=a(i,56),t.zoomLevels=[];for(var h=0;h<t.numZoomLevels;++h){var u=s[6*h+16],c=a(i,24*h+72),l=a(i,24*h+80);t.zoomLevels.push({reduction:u,dataOffset:c,indexOffset:l})}$.when(t.readChromTree()).then(function(){t.getAutoSQL(function(e){return t.schema=e,r.resolve(t)})})}),r}function u(e,r,t,n,i){this.bbi=e,this.type=r,this.fieldCount=t,this.offset=n,this.field=i}var c=e.Range,l=e.union,m=e.intersection,v=r.inflateBuffer,d=r.arrayCopy,g=2291137574,w=654086024,y=2273964779,p=3958540679,b=256,x=65536,I=16777216,z=4294967296,A=new RegExp("^[0-9]+,[0-9]+,[0-9]+");return s.prototype.readChromTree=function(){var e=this;this.chromsToIDs={},this.idsToChroms={},this.maxID=0;var r=this.unzoomedDataOffset;return r=r+4-(r-this.chromTreeOffset&3),$.when(o(this.url,this.chromTreeOffset,r-this.chromTreeOffset)).then(function(r){var t=new Uint8Array(r),n=new Int16Array(r),i=new Int32Array(r),o=(i[0],i[1],i[2]);i[3],a(t,16),function r(i){var s=t[i],f=n[i/2+1];i+=4;for(var h=0;h<f;++h)if(0===s){i+=o;var u=a(t,i);i+=8,u-=e.chromTreeOffset,r(u)}else{for(var c="",l=0;l<o;++l){var m=t[i++];0!==m&&(c+=String.fromCharCode(m))}var v=t[i+3]<<24|t[i+2]<<16|t[i+1]<<8|t[i+0];t[i+7],t[i+6],t[i+5],t[i+4],i+=8,e.chromsToIDs[c]=v,0===c.indexOf("chr")&&(e.chromsToIDs[c.substr(3)]=v),e.idsToChroms[v]=c,e.maxID=Math.max(e.maxID,v)}}(32)})},f.prototype.readWigData=function(e,r,t){var n=this.bwg.chromsToIDs[e];return void 0===n?[]:this.readWigDataById(n,r,t)},f.prototype.readWigDataById=function(e,r,t){var n=this,i=$.Deferred();if(!this.cirHeader)return $.when(o(n.bwg.url,this.cirTreeOffset,48)).then(function(o){n.cirHeader=o;var a=new Int32Array(n.cirHeader);n.cirBlockSize=a[1],$.when(n.readWigDataById(e,r,t)).then(function(e){i.resolve(e)})}),i;var s=[],f=0,h=(Date.now(),function(n,i,o,a){return(e<0||n==e)&&i<=t&&o>=r}),u=function(e,r){if(n.bwg.instrument&&console.log("level="+r+"; offset="+e+"; time="+(0|Date.now())),f+=e.length,1==e.length&&e[0]-n.cirTreeOffset==48&&n.cachedCirRoot)return v(n.cachedCirRoot,0,r),void(0===--f&&$.when(n.fetchFeatures(h,s)).then(function(e){i.resolve(e)}));for(var t,o=4+32*n.cirBlockSize,a=0;a<e.length;++a){var u=new c(e[a],e[a]+o);t=t?l(t,u):u}for(var d=t.ranges(),g=0;g<d.length;++g){var w=d[g];m(e,w,r)}},m=function(e,r,t,a){r.max(),r.min();$.when(o(n.bwg.url,r.min(),r.max()-r.min())).then(function(o){for(var a=0;a<e.length;++a)r.contains(e[a])&&(v(o,e[a]-r.min(),t),e[a]-n.cirTreeOffset==48&&e[a]-r.min()==0&&(n.cachedCirRoot=o),0===--f&&$.when(n.fetchFeatures(h,s)).then(function(e){i.resolve(e)}))})},v=function(n,i,o){var f=new Uint8Array(n),h=new Int16Array(n),c=new Int32Array(n),l=f[i],m=h[i/2+1];if(i+=4,0!==l)for(var v=0;v<m;++v){var d=i/4,g=c[d],w=c[d+1],y=c[d+2],p=c[d+3],b=a(f,i+16),x=a(f,i+24);(e<0||g<e||g==e&&w<=t)&&(e<0||y>e||y==e&&p>=r)&&s.push({offset:b,size:x}),i+=32}else{for(var I=[],v=0;v<m;++v){var d=i/4,g=c[d],w=c[d+1],y=c[d+2],p=c[d+3],b=a(f,i+16);(e<0||g<e||g==e&&w<=t)&&(e<0||y>e||y==e&&p>=r)&&I.push(b),i+=24}I.length>0&&u(I,o+1)}};return u([n.cirTreeOffset+48],1),i},f.prototype.fetchFeatures=function(e,r){var n=this,i=$.Deferred();if(r.sort(function(e,r){return(0|e.offset)-(0|r.offset)}),0===r.length)return[];var a=[],s=function(e,r,i,o){o||(o={});var s=new t;s._chromId=e,s.segment=n.bwg.idsToChroms[e],s.min=r,s.max=i,s.type=n.bwg.type;for(var f in o)s[f]=o[f];a.push(s)};return function t(){if(0===r.length){Date.now();return i.resolve(a)}var f=r[0];if(f.data)n.parseFeatures(f.data,s,e),r.splice(0,1),t();else{for(var h=f.offset,u=f.size,c=1;c<r.length&&r[c].offset==h+u;)u+=r[c].size,++c;$.when(o(n.bwg.url,h,u)).then(function(e){for(var i=0,o=0;i<u;){var a,s=r[o];if(n.bwg.uncompressBufSize>0)a=v(e,i+2,s.size-2);else{var f=new Uint8Array(s.size);d(new Uint8Array(e,i,s.size),0,f,0,s.size),a=f.buffer}s.data=a,i+=s.size,++o}t()})}}(),i},f.prototype.parseFeatures=function(e,r,t){var i=new Uint8Array(e);if(this.isSummary)for(var o=new Int16Array(e),a=new Int32Array(e),s=new Float32Array(e),f=e.byteLength/32,h=0;h<f;++h){var u=a[8*h],v=a[8*h+1],d=a[8*h+2],g=a[8*h+3],w=(s[8*h+4],s[8*h+5]),y=s[8*h+6];s[8*h+7];if(t(u,v+1,d)){var p={type:"bigwig",score:y/g,maxScore:w};"bigbed"==this.bwg.type&&(p.type="density"),r(u,v+1,d,p)}}else if("bigwig"==this.bwg.type){var o=new Int16Array(e),a=new Int32Array(e),s=new Float32Array(e),u=a[0],b=a[1],x=(a[2],a[3]),I=a[4],z=i[20],f=o[11];if(3==z)for(var h=0;h<f;++h){var O=s[h+6],C=b+h*x+1,D=b+h*x+I;t(u,C,D)&&r(u,C,D,{score:O})}else if(2==z)for(var h=0;h<f;++h){var v=a[2*h+6]+1,d=v+I-1,O=s[2*h+7];t(u,v,d)&&r(u,v,d,{score:O})}else if(1==z)for(var h=0;h<f;++h){var v=a[3*h+6]+1,d=a[3*h+7],O=s[3*h+8];v>d&&(v=d),t(u,v,d)&&r(u,v,d,{score:O})}else console.log("Currently not handling bwgType="+z)}else{if("bigbed"!=this.bwg.type)throw Error("Don't know what to do with "+this.bwg.type);for(var T=0,F=this.bwg.definedFieldCount,S=this.bwg.schema;T<i.length;){var u=i[T+3]<<24|i[T+2]<<16|i[T+1]<<8|i[T+0],v=i[T+7]<<24|i[T+6]<<16|i[T+5]<<8|i[T+4],d=i[T+11]<<24|i[T+10]<<16|i[T+9]<<8|i[T+8];T+=12;for(var L="";;){var B=i[T++];if(0==B)break;L+=String.fromCharCode(B)}var U,R={};if(U=L.length>0?L.split("\t"):[],U.length>0&&F>3&&(R.label=U[0]),U.length>1&&F>4){var O=parseInt(U[1]);isNaN(O)||(R.score=O)}if(U.length>2&&F>5&&(R.orientation=U[2]),U.length>5&&F>8){var V=U[5];A.test(V)&&(R.itemRgb="rgb("+V+")")}if(U.length>F-3&&S)for(var j=F-3;j<U.length;++j)R[S.fields[j+3].name]=U[j];if(t(u,v+1,d,U))if(F<12)r(u,v+1,d,R);else{var H=0|U[3],k=0|U[4],W=0|U[6],_=U[7].split(","),N=U[8].split(",");if(R.exonFrames){var Z=R.exonFrames.split(",");R.exonFrames=void 0}R.type="transcript";var E=new n;for(var q in R)E[q]=R[q];if(E.id=U[0],E.segment=this.bwg.idsToChroms[u],E.min=v+1,E.max=d,E.notes=[],R.groups=[E],U.length>9){var M=R.geneName||U[9],Q=M;U.length>10&&(Q=U[10]),R.geneName2&&(Q=R.geneName2);var G=$.extend({},E);G.id=M,G.label=Q,G.type="gene",R.groups.push(G)}for(var J=[],K=0;K<W;++K){var P=(0|N[K])+v,X=P+(0|_[K]),Y=new c(P,X);J.push(Y)}for(var ee=l(J),re=ee.ranges(),te=0;te<re.length;++te){var ne=re[te];r(u,ne.min()+1,ne.max(),R)}if(k>H){var ie="+"==R.orientation?new c(H,k+3):new c(H-3,k),oe=m(ee,ie);if(oe){R.type="translation";for(var ae=oe.ranges(),se=0,fe=0;ae[0].min()>re[fe].max();)fe++;for(var te=0;te<ae.length;++te){var he=te;"-"==R.orientation&&(he=ae.length-te-1);var ne=ae[he];if(R.readframe=se,Z){var ue=parseInt(Z[he+fe]);"number"==typeof ue&&ue>=0&&ue<=2&&(R.readframe=ue,R.readframeExplicit=!0)}var ce=ne.max()-ne.min();se=(se+ce)%3,r(u,ne.min()+1,ne.max(),R)}}}}}}},f.prototype.getFirstAdjacent=function(e,r,t,n){var i=this.bwg.chromsToIDs[e];if(void 0===i)return n([]);this.getFirstAdjacentById(i,r,t,n)},f.prototype.getFirstAdjacentById=function(e,r,t,n){var i=this;if(!this.cirHeader)return void this.bwg.data.slice(this.cirTreeOffset,48).fetch(function(o){i.cirHeader=o;var a=new Int32Array(i.cirHeader);i.cirBlockSize=a[1],i.getFirstAdjacentById(e,r,t,n)});var o=null,s=-1,f=-1,h=0,u=(Date.now(),function(e,r){h+=e.length;for(var t,n=4+32*i.cirBlockSize,o=0;o<e.length;++o){var a=new c(e[o],e[o]+n);t=t?l(t,a):a}for(var s=t.ranges(),f=0;f<s.length;++f){var u=s[f];m(e,u,r)}}),m=function(a,s,f,u){s.max(),s.min();i.bwg.data.slice(s.min(),s.max()-s.min()).fetch(function(u){for(var c=0;c<a.length;++c)if(s.contains(a[c])&&(v(u,a[c]-s.min(),f),0==--h)){if(!o)return t>0&&(0!=e||r>0)?i.getFirstAdjacentById(0,0,t,n):t<0&&(e!=i.bwg.maxID||r<1e9)?i.getFirstAdjacentById(i.bwg.maxID,1e9,t,n):n([]);i.fetchFeatures(function(n,i,o,a){return t<0&&(n<e||o<r)||t>0&&(n>e||i>r)},[o],function(e){for(var r=null,i=-1,o=-1,a=0;a<e.length;++a){var s=e[a],f=s._chromId,h=s.min,u=s.max;(null==r||t<0&&(f>i||u>o)||t>0&&(f<i||h<o))&&(r=s,o=t<0?u:h,i=f)}return n(null!=r?[r]:[])})}})},v=function(n,h,c){var l=new Uint8Array(n),m=new Int16Array(n),v=new Int32Array(n),d=l[h],g=m[h/2+1];if(h+=4,0!=d)for(var w=0;w<g;++w){var y=h/4,p=v[y],b=v[y+1],x=v[y+2],I=v[y+3],z=a(l,h+16),A=a(l,h+24);(t<0&&(p<e||p==e&&b<=r)||t>0&&(x>e||x==e&&I>=r))&&(/_random/.exec(i.bwg.idsToChroms[p])||(null==o||t<0&&(x>s||x==s&&I>f)||t>0&&(p<s||p==s&&b<f))&&(o={offset:z,size:A},f=t<0?I:b,s=t<0?x:p)),h+=32}else{for(var O=-1,C=-1,w=0;w<g;++w){var y=h/4,p=v[y],b=v[y+1],x=v[y+2],I=v[y+3],z=v[y+4]<<32|v[y+5];(t<0&&(p<e||p==e&&b<=r)&&x>=e||t>0&&(x>e||x==e&&I>=r)&&p<=e)&&(O<0||I>C)&&(O=z,C=t<0?I:b,t<0?x:p),h+=24}O>=0&&u([O],c+1)}};u([i.cirTreeOffset+48],1)},s.prototype.readWigData=function(e,r,t){var n,i=t-r;if(i<=25e3||0===this.zoomLevels.length)n=this.getUnzoomedView();else for(var o=0;o<this.zoomLevels.length;o++)if(i/this.zoomLevels[o].reduction<25e3){n=this.getZoomedView(o);break}return n.readWigData(e,r,t)},s.prototype.getUnzoomedView=function(){if(!this.unzoomedView){var e=4e3;this.zoomLevels[0]&&(e=this.zoomLevels[0].dataOffset-this.unzoomedIndexOffset),this.unzoomedView=new f(this,this.unzoomedIndexOffset,e,!1)}return this.unzoomedView},s.prototype.getZoomedView=function(e){var r=this.zoomLevels[e];return r.view||(r.view=new f(this,r.indexOffset,4e3,!0)),r.view},s.prototype._tsFetch=function(e,r,t,n,i){var o=this;if(!(e>=this.zoomLevels.length-1)){var a;return a=e<0?this.getUnzoomedView():this.getZoomedView(e),a.readWigDataById(r,t,n,i)}if(this.topLevelReductionCache){for(var s=[],f=this.topLevelReductionCache,h=0;h<f.length;++h)f[h]._chromId==r&&s.push(f[h]);return i(s)}this.getZoomedView(this.zoomLevels.length-1).readWigDataById(-1,0,3e8,function(a){return o.topLevelReductionCache=a,o._tsFetch(e,r,t,n,i)})},s.prototype.thresholdSearch=function(e,r,t,n,i){function o(){if(0==f.length)return i(null);f.sort(function(e,r){var n=e.zoom-r.zoom;return 0!=n?n:(n=e.chrOrd-r.chrOrd,0!=n?n:e.min-r.min*t)});var e=f.splice(0,1)[0];a._tsFetch(e.zoom,e.chr,e.min,e.max,function(a){var s=t>0?0:3e8;e.fromRef&&(s=r);for(var h=0;h<a.length;++h){var u,c=a[h];if(u=void 0!=c.maxScore?c.maxScore:c.score,t>0){if(u>n)if(e.zoom<0){if(c.min>s)return i(c)}else c.max>s&&f.push({chr:e.chr,chrOrd:e.chrOrd,zoom:e.zoom-2,min:c.min,max:c.max,fromRef:e.fromRef})}else if(u>n)if(e.zoom<0){if(c.max<s)return i(c)}else c.min<s&&f.push({chr:e.chr,chrOrd:e.chrOrd,zoom:e.zoom-2,min:c.min,max:c.max,fromRef:e.fromRef})}o()})}t=t<0?-1:1;for(var a=this,s=this.chromsToIDs[e],f=[{chrOrd:0,chr:s,zoom:a.zoomLevels.length-4,min:0,max:3e8,fromRef:!0}],h=1;h<=this.maxID+1;++h){var u=(s+t*h)%(this.maxID+1);u<0&&(u+=this.maxID+1),f.push({chrOrd:h,chr:u,zoom:a.zoomLevels.length-1,min:0,max:3e8})}o()},s.prototype.getAutoSQL=function(e){if(!this.asOffset)return e(null);$.when(o(this.url,this.asOffset,2048)).then(function(r){for(var t=new Uint8Array(r),n="",i=0;i<t.length&&0!=t[i];++i)n+=String.fromCharCode(t[i]);var o=/(\w+)\s+(\w+)\s+("([^"]+)")?\s+\(\s*/,a=/([\w\[\]]+)\s+(\w+)\s*;\s*("([^"]+)")?\s*/g,s=o.exec(n);if(s){var f={declType:s[1],name:s[2],comment:s[4],fields:[]};n=n.substring(s[0]);for(var h=a.exec(n);null!=h;h=a.exec(n))f.fields.push({type:h[1],name:h[2],comment:h[4]});return e(f)}})},s.prototype.getExtraIndices=function(e){var r=this;if(this.version<4||0==this.extHeaderOffset||"bigbed"!=this.type)return e(null);this.data.slice(this.extHeaderOffset,64).fetch(function(t){if(!t)return e(null,"Couldn't fetch extension header");var n=new Uint8Array(t),i=new Int16Array(t),o=(new Int32Array(t),i[0],i[1]),s=a(n,4);if(0==o)return e(null);r.data.slice(s,20*o).fetch(function(t){if(!t)return e(null,"Couldn't fetch index info");for(var n=new Uint8Array(t),i=new Int16Array(t),s=(new Int32Array(t),[]),f=0;f<o;++f){var h=i[10*f],c=i[10*f+1],l=a(n,20*f+4),m=i[10*f+8],v=new u(r,h,c,l,m);s.push(v)}e(s)})})},u.prototype.lookup=function(e,r){var t=this;this.bbi.data.slice(this.offset,32).fetch(function(n){function o(n){t.bbi.data.slice(n,4+h*(u+c)).fetch(function(n){var s=new Uint8Array(n),f=new Uint16Array(n),h=(new Uint32Array(n),s[0]),l=f[1],m=4;if(0!=h){for(var v=0;v<l;++v){for(var d="",g=0;g<u;++g){var w=s[m++];0!=w&&(d+=String.fromCharCode(w))}if(d==e){var y=a(s,m),p=i(s,m+8);return t.bbi.getUnzoomedView().fetchFeatures(function(r,n,i,o){if(o&&o.length>t.field-3)return o[t.field-3]==e},[{offset:y,size:p}],r)}m+=c}return r([])}for(var b=null,v=0;v<l;++v){for(var d="",g=0;g<u;++g){var w=s[m++];0!=w&&(d+=String.fromCharCode(w))}var x=a(s,m);if(m+=8,e.localeCompare(d)<0&&b)return void o(b);b=x}o(b)})}var s=new Uint8Array(n),f=(new Int16Array(n),new Int32Array(n)),h=(f[0],f[1]),u=f[2],c=f[3];a(s,16);o(t.offset+32)})},{makeBwg:h}});
//# sourceMappingURL=../../../maps/libs/bbi/bigwig.js.map
