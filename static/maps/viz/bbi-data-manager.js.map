{"version":3,"sources":["viz/bbi-data-manager.js"],"names":["define","visualization","bigwig","BBIDataManager","GenomeDataManager","extend","load_data","region","mode","resolution","extra_params","$","Deferred","this","deferred","url","Galaxy","root","get","id","promise","then","bb","err","makeBwg","data","result","max","Number","MIN_VALUE","prev","d","min","push","score","entry","self","set_data"],"mappings":"YAAAA,SAAS,oBAAqB,mBACtB,SAASC,EAAeC,GA6D5B,OAAAC,eAxDqBF,EAAcG,kBAAkBC,QAOjDC,UAAW,SAASC,EAAQC,EAAMC,EAAYC,GAA9CJ,GAAAA,GAAWK,EAAAC,UACPC,MAAIC,SAAAA,EAAaF,EAGjB,IAAIG,GAAMC,OAAOC,KAAO,YAAcJ,KAAKK,IAAI,WAAWC,GAAK,WAA3DJ,EAAMC,IAAV,IAAAL,GAAAC,QAyCA,OAvCQQ,GAAAA,KAAAA,EAAcT,QAAEC,IAApBS,KAAA,SAAAC,EAAAC,GACOrB,EAAAA,KAAOsB,EAAAA,YAAcH,EAAKH,IAAA,SAAAX,EAAkBW,IAAA,SAAAX,EAAAW,IAAA,SAAAG,KAAA,SAAAI,GAG/C,GAAAC,MACIA,GAASC,IAAbC,OAAAC,UAAAJ,GACIK,QAASH,SAAKC,GAGdE,EAAAH,MAAAI,EAAAC,IAAA,IAEIN,EAAAO,MAAAH,EAAAH,IAAA,EAAA,IAGAD,EAAAO,MAAAF,EAAAC,IAAA,EAAA,KAKJN,EAAAO,MAAAF,EAAAC,IAAA,EAAAD,EAAAG,QAGAR,EAAAO,MAAAF,EAAAJ,IAAAI,EAAAG,QAGAJ,EAAOC,GAGX,IAAII,IAAAA,KAAQT,EACJD,OADIlB,EAEJA,aAFI,SAMZ6B,GAAKC,SAAS9B,EAAQ4B,GAAtBC,EAAKC,QAAS9B,OAKfO","file":"../../scripts/viz/bbi-data-manager.js","sourcesContent":["define( [\"viz/visualization\", \"libs/bbi/bigwig\"],\n        function(visualization, bigwig) {\n\n    /**\n     * Data manager for BBI datasets/files, including BigWig and BigBed.\n     */\n    var BBIDataManager = visualization.GenomeDataManager.extend({\n\n        /**\n         * Load data from server and manage data entries. Adds a Deferred to manager\n         * for region; when data becomes available, replaces Deferred with data.\n         * Returns the Deferred that resolves when data is available.\n         */\n        load_data: function(region, mode, resolution, extra_params) {\n            var deferred = $.Deferred();\n            this.set_data(region, deferred);\n\n            var url = Galaxy.root + 'datasets/' + this.get('dataset').id + '/display',\n                self = this;\n                var promise = new $.Deferred();\n                $.when(bigwig.makeBwg(url)).then(function(bb, err) {\n                    $.when(bb.readWigData(region.get(\"chrom\"), region.get(\"start\"), region.get(\"end\"))).then(function(data) {\n                    // Transform data into \"bigwig\" format for LinePainter. \"bigwig\" format is an array of 2-element arrays\n                    // where each element is [position, score]; unlike real bigwig format, no gaps are allowed.\n                    var result = [],\n                        prev = { max: Number.MIN_VALUE };\n                    data.forEach(function(d) {\n                        // If there is a gap between prev and d, fill it with an interval with score 0.\n                        // This is necessary for LinePainter to draw correctly.\n                        if (prev.max !== d.min - 1) {\n                            // +1 to start after previous region.\n                            result.push([prev.max + 1, 0]);\n                            // -2 = -1 for converting from 1-based to 0-based coordinates,\n                            //      -1 for ending before current region.\n                            result.push([d.min - 2, 0]);\n                        }\n\n                        // Add data point for entry start. -1 to convert from wiggle\n                        // 1-based coordinates to 0-based browser coordinates.\n                        result.push([d.min - 1, d.score]);\n\n                        // Add data point for entry end:\n                        result.push([d.max, d.score]);\n\n                        prev = d;\n                    });\n\n                    var entry = {\n                            data: result,\n                            region: region,\n                            dataset_type: 'bigwig'\n                        };\n\n                    self.set_data(region, entry);\n                    deferred.resolve(entry);\n                });\n            });\n\n            return deferred;\n        },\n    });\n\n    return {\n        BBIDataManager: BBIDataManager\n    };\n\n});\n"]}