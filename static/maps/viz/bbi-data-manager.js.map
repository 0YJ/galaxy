{"version":3,"sources":["viz/bbi-data-manager.js"],"names":["define","visualization","bigwig","BBIDataManager","GenomeDataManager","load_data","region","mode","extra_params","deferred","this","set_data","url","self","root","promise","when","$","Deferred","makeBwg","result","then","bb","err","data","get","prev","max","Number","MIN_VALUE","forEach","d","min","push","score","entry","dataset_type","resolve"],"mappings":"kCAAAA,QAAQ,oBAAqB,mBAAoB,SAC7CC,EACAC,GAsEA,OACIC,eAlEAA,EAAiBF,kBAAcG,QAM/BC,UAAAA,SAAWC,EAAAC,EAASD,EAATE,GACP,IAAAC,EAAIA,EAAAA,WACJC,KAAAC,SAAKA,EAASL,GAEd,IAAAM,EAKIC,OAAOC,KACPC,YACFC,KAAKd,IAAAA,WAAeU,GAClBK,WAOIJ,EAAAH,KACA,IAAAO,EAAAC,SAmCR,OAlCQD,EAAAD,KAAAd,EAAAiB,QAAIC,IAAJC,KAAA,SAAAC,EAAAC,GAAAN,EAAAD,KAEAQ,EAAAA,YACIlB,EAAAmB,IAAA,SACAnB,EAAAmB,IAAA,SACAnB,EAAAmB,IAAIC,SAEAN,KAAAA,SAAAA,GAGAA,IAAAA,KACHM,GAAAC,IAAAC,OAAAC,WATLL,EAAKM,QAAQ,SAASC,GAalBX,EAAAA,MAAaW,EAAEC,IAAM,IAErBZ,EAAAa,MAAAP,EAAAC,IAAA,EAAA,IAGAD,EAAOK,MAAPA,EAAAC,IAAA,EAAA,KAKA1B,EAAAA,MAAQA,EAAAA,IAFA,EAAAyB,EAAAG,QALRd,EAAOa,MAAMF,EAAEJ,IAAKI,EAAEG,QAY1BzB,EAAAA,IAPA,IAAI0B,GAWL1B,KAAAA,EACVH,OAAAA,EA9DL8B,aAAA,UAkEIjC,EAAAA,SAAgBA,EAAAA,GADpBM,EAAA4B,QAAAF,OAJe1B","file":"../../scripts/viz/bbi-data-manager.js","sourcesContent":["define([\"viz/visualization\", \"libs/bbi/bigwig\"], function(\n    visualization,\n    bigwig\n) {\n    /**\n     * Data manager for BBI datasets/files, including BigWig and BigBed.\n     */\n    var BBIDataManager = visualization.GenomeDataManager.extend({\n        /**\n         * Load data from server and manage data entries. Adds a Deferred to manager\n         * for region; when data becomes available, replaces Deferred with data.\n         * Returns the Deferred that resolves when data is available.\n         */\n        load_data: function(region, mode, resolution, extra_params) {\n            var deferred = $.Deferred();\n            this.set_data(region, deferred);\n\n            var url =\n                    Galaxy.root +\n                    \"datasets/\" +\n                    this.get(\"dataset\").id +\n                    \"/display\",\n                self = this;\n            var promise = new $.Deferred();\n            $.when(bigwig.makeBwg(url)).then(function(bb, err) {\n                $.when(\n                    bb.readWigData(\n                        region.get(\"chrom\"),\n                        region.get(\"start\"),\n                        region.get(\"end\")\n                    )\n                ).then(function(data) {\n                    // Transform data into \"bigwig\" format for LinePainter. \"bigwig\" format is an array of 2-element arrays\n                    // where each element is [position, score]; unlike real bigwig format, no gaps are allowed.\n                    var result = [],\n                        prev = { max: Number.MIN_VALUE };\n                    data.forEach(function(d) {\n                        // If there is a gap between prev and d, fill it with an interval with score 0.\n                        // This is necessary for LinePainter to draw correctly.\n                        if (prev.max !== d.min - 1) {\n                            // +1 to start after previous region.\n                            result.push([prev.max + 1, 0]);\n                            // -2 = -1 for converting from 1-based to 0-based coordinates,\n                            //      -1 for ending before current region.\n                            result.push([d.min - 2, 0]);\n                        }\n\n                        // Add data point for entry start. -1 to convert from wiggle\n                        // 1-based coordinates to 0-based browser coordinates.\n                        result.push([d.min - 1, d.score]);\n\n                        // Add data point for entry end:\n                        result.push([d.max, d.score]);\n\n                        prev = d;\n                    });\n\n                    var entry = {\n                        data: result,\n                        region: region,\n                        dataset_type: \"bigwig\"\n                    };\n\n                    self.set_data(region, entry);\n                    deferred.resolve(entry);\n                });\n            });\n\n            return deferred;\n        }\n    });\n\n    return {\n        BBIDataManager: BBIDataManager\n    };\n});\n"]}