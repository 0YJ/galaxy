{"version":3,"sources":["viz/phyloviz.js"],"names":["define","d3","visualization_mod","data_mod","mod_icon_btn","PhyloTreeLayout","leafHeight","layoutMode","height","leafIndex","children","layout","dist","node","defaultDist","y0","parent","depthSeparation","maxTextWidth","child","maxDepth","vertSeparation","sumChildVertSeparation","x","x0","y","self","hierarchy","sort","value","inputLeafHeight","mode","layoutAngle","angle","isNaN","separation","links","nodes","tree","d","i","toString","call","_nodes","window","_d","forEach","depth","push","numLeaves","UserMenuBase","Backbone","View","extend","className","isAcceptableValue","fieldName","$inputKey","min","max","val","parseFloat","attr","replace","n","isNumeric","isFinite","alert","hasIllegalJsonCharacters","search","PhyloTree","Visualization","scaleFactor","translate","fontSize","selectedNode","nodeAttrChangedTime","initialize","options","defaults","dataset_id","title","toggle","id","_children","root","toggleAll","length","this","getData","cleanTree","_selected","config","jQuery","attributes","show_message","$","ajax","url","type","dataType","data","success","PhylovizLinearView","stdInit","model","on","updateAndRender","vis","PhylovizLayoutBase","nodeRadius","width","source","select","renderNodes","diagonal","selectAll","renderLinks","target","calcalateLinePos","pos0","pos1","pos2","link","append","transition","duration","linkEnter","enter","exit","selectNode","linkExit","classed","set","name","annotation","remove","__data__","bootstrap","Math","round","addTooltips","placement","trigger","svg","get","event","stopPropagation","nodeEnter","style","nodeUpdate","text","nodeExit","PhylovizView","MIN_SCALE","MAX_DISPLACEMENT","radius","resize","phyloTree","zoomFunc","behavior","zoom","scaleExtent","MAX_SCALE","navMenu","HeaderButtons","SettingsMenu","nodeSelectionView","setTimeout","render","empty","mainSVG","zoomAndPan","boundingRect","layoutOptions","linearView","margins","zoomParams","zoomStatement","translateParams","scale","translationCoor","translateStatement","split","treeIndex","tree_index","reloadViz","phylovizView","packedJson","initRightHeaderBtns","off","nexSelected","icon_class","create_icon_buttons_menu","on_click","show","tooltip_config","initNavBtns","open","rightMenu","$el","inputs","apply","el","hide","resetToDefaults","updateUI","key","$input","each","enableEdit","NodeSelectionView","UI","saveChanges","updateNodes","cancelChanges","valuesOfConcern","toggleUI","fn","enable","isEnabled","removeAttr","checked","is","PhyloVizSearch","searchTerm","searchConditionVal","Date","searchTree","attrVal","condition","toLowerCase","indexOf"],"mappings":"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","file":"../../scripts/viz/phyloviz.js","sourcesContent":["define([\n    'libs/d3',\n    'viz/visualization',\n    'mvc/dataset/data',\n    'mvc/ui/icon-button'\n], function(d3, visualization_mod, data_mod, mod_icon_btn) {\n\n/**\n * Base class of any menus that takes in user interaction. Contains checking methods.\n */\nvar UserMenuBase = Backbone.View.extend({\n\n    className: 'UserMenuBase',\n\n    /**\n     * Check if an input value is a number and falls within max min.\n     */\n    isAcceptableValue : function ($inputKey, min, max) {\n        //TODO: use better feedback than alert\n        var value = $inputKey.val(),\n            fieldName = $inputKey.attr(\"displayLabel\") || $inputKey.attr(\"id\").replace(\"phyloViz\", \"\");\n\n        function isNumeric(n) {\n            return !isNaN(parseFloat(n)) && isFinite(n);\n        }\n\n        if (!isNumeric(value)){\n            alert(fieldName + \" is not a number!\");\n            return false;\n        }\n\n        if ( value > max){\n            alert(fieldName + \" is too large.\");\n            return false;\n        } else if ( value < min) {\n            alert(fieldName + \" is too small.\");\n            return false;\n        }\n        return true;\n    },\n\n    /**\n     * Check if any user string inputs has illegal characters that json cannot accept\n     */\n    hasIllegalJsonCharacters : function($inputKey) {\n        if ($inputKey.val().search(/\"|'|\\\\/) !== -1){\n            alert(\"Named fields cannot contain these illegal characters: \"\n                + \"double quote(\\\"), single guote(\\'), or back slash(\\\\). \");\n            return true;\n        }\n        return false;\n    }\n});\n\n\n/**\n * -- Custom Layout call for phyloViz to suit the needs of a phylogenetic tree.\n * -- Specifically: 1) Nodes have a display display of (= evo dist X depth separation) from their parent\n *                  2) Nodes must appear in other after they have expand and contracted\n */\nfunction PhyloTreeLayout() {\n\n    var self = this,\n        hierarchy = d3.layout.hierarchy().sort(null).value(null),\n        height = 360, // ! represents both the layout angle and the height of the layout, in px\n        layoutMode = \"Linear\",\n        leafHeight = 18, // height of each individual leaf node\n        depthSeparation = 200, // separation between nodes of different depth, in px\n        leafIndex = 0, // change to recurssive call\n        defaultDist = 0.5, // tree defaults to 0.5 dist if no dist is specified\n        maxTextWidth = 50; // maximum length of the text labels\n\n\n    self.leafHeight = function(inputLeafHeight){\n        if (typeof inputLeafHeight === \"undefined\"){ return leafHeight; }\n        else { leafHeight = inputLeafHeight; return self;}\n    };\n\n    self.layoutMode = function(mode){\n        if (typeof mode === \"undefined\"){ return layoutMode; }\n        else { layoutMode = mode; return self;}\n    };\n\n    // changes the layout angle of the display, which is really changing the height\n    self.layoutAngle = function(angle) {\n        if (typeof angle === \"undefined\"){ return height; }\n        // to use default if the user puts in strange values\n        if (isNaN(angle) || angle < 0 || angle > 360) { return self; }\n        else { height = angle; return self;}\n    };\n\n    self.separation = function(dist){   // changes the dist between the nodes of different depth\n        if (typeof dist === \"undefined\"){ return depthSeparation; }\n        else { depthSeparation = dist; return self;}\n    };\n\n    self.links = function (nodes) {     // uses d3 native method to generate links. Done.\n        return d3.layout.tree().links(nodes);\n    };\n\n    // -- Custom method for laying out phylogeny tree in a linear fashion\n    self.nodes = function (d, i) {\n        //TODO: newick and phyloxml return arrays. where should this go (client (here, else), server)?\n        if( toString.call( d ) === '[object Array]' ){\n            // if d is an array, replate with the first object (newick, phyloxml)\n            d = d[0];\n        }\n        // self is to find the depth of all the nodes, assumes root is passed in\n        var _nodes = hierarchy.call(self, d, i),\n            nodes = [],\n            maxDepth = 0,\n            numLeaves = 0;\n        //console.debug( JSON.stringify( _nodes, null, 2 ) )\n        window._d = d;\n        window._nodes = _nodes;\n\n        //TODO: remove dbl-touch loop\n        // changing from hierarchy's custom format for data to usable format\n        _nodes.forEach(function (node){\n            maxDepth = node.depth > maxDepth ? node.depth : maxDepth;  //finding max depth of tree\n            nodes.push(node);\n        });\n        // counting the number of leaf nodes and assigning max depth\n        //  to nodes that do not have children to flush all the leave nodes\n        nodes.forEach(function(node){\n            if ( !node.children )  { //&& !node._children\n                numLeaves += 1;\n                node.depth = maxDepth; // if a leaf has no child it would be assigned max depth\n            }\n        });\n\n        leafHeight = layoutMode === \"Circular\" ? height / numLeaves : leafHeight;\n        leafIndex = 0;\n        layout(nodes[0], maxDepth, leafHeight, null);\n\n        return nodes;\n    };\n\n\n    /**\n     * -- Function with side effect of adding x0, y0 to all child; take in the root as starting point\n     *  assuming that the leave nodes would be sorted in presented order\n     *          horizontal(y0) is calculated according to (= evo dist X depth separation) from their parent\n     *          vertical (x0) - if leave node: find its order in all of the  leave node === node.id,\n     *                              then multiply by verticalSeparation\n     *                  - if parent node: is place in the mid point all of its children nodes\n     * -- The layout will first calculate the y0 field going towards the leaves, and x0 when returning\n     */\n    function layout (node, maxDepth, vertSeparation, parent) {\n        var children = node.children,\n            sumChildVertSeparation = 0;\n\n        // calculation of node's dist from parents, going down.\n        var dist = node.dist || defaultDist;\n        dist = dist > 1 ? 1 : dist;     // We constrain all dist to be less than one\n        node.dist = dist;\n        if (parent !== null){\n            node.y0 = parent.y0 + dist * depthSeparation;\n        } else {    //root node\n            node.y0 = maxTextWidth;\n        }\n\n\n        // if a node have no children, we will treat it as a leaf and start laying it out first\n        if (!children) {\n            node.x0 = leafIndex * vertSeparation;\n            leafIndex += 1;\n        } else {\n            // if it has children, we will visit all its children and calculate its position from its children\n            children.forEach( function (child) {\n                child.parent = node;\n                sumChildVertSeparation += layout(child, maxDepth, vertSeparation, node);\n            });\n            node.x0 = sumChildVertSeparation / children.length;\n        }\n\n        // adding properties to the newly created node\n        node.x = node.x0;\n        node.y = node.y0;\n        return node.x0;\n    }\n    return self;\n}\n\n\n/**\n * -- PhyloTree Model --\n */\nvar PhyloTree = visualization_mod.Visualization.extend({\n    defaults : {\n        layout: \"Linear\",\n        separation : 250,    // px dist between nodes of different depth to represent 1 evolutionary until\n        leafHeight: 18,\n        type : \"phyloviz\",   // visualization type\n        title : \"Title\",\n        scaleFactor: 1,\n        translate: [0,0],\n        fontSize: 12,        //fontSize of node label\n        selectedNode : null,\n        nodeAttrChangedTime : 0\n    },\n\n    initialize: function(options) {\n        this.set(\"dataset\", new data_mod.Dataset({\n            id: options.dataset_id\n        }));\n\n    },\n\n    root : {}, // Root has to be its own independent object because it is not part of the viz_config\n\n    /**\n     * Mechanism to expand or contract a single node. Expanded nodes have a children list, while for\n     * contracted nodes the list is stored in _children. Nodes with their children data stored in _children will not\n     * have their children rendered.\n     */\n    toggle : function (d) {\n        if(typeof d === \"undefined\") {return ;}\n        if (d.children ) {\n            d._children = d.children;\n            d.children = null;\n        } else {\n            d.children = d._children;\n            d._children = null;\n        }\n    },\n\n    /**\n     *  Contracts the phylotree to a single node by repeatedly calling itself to place all the list\n     *  of children under _children.\n     */\n    toggleAll : function(d) {\n        if (d.children && d.children.length !== 0) {\n            d.children.forEach(this.toggleAll);\n            toggle(d);\n        }\n    },\n\n    /**\n     *  Return the data of the tree. Used for preserving state.\n     */\n    getData : function (){\n        return this.root;\n    },\n\n    /**\n     * Overriding the default save mechanism to do some clean of circular reference of the\n     * phyloTree and to include phyloTree in the saved json\n     */\n    save: function() {\n        var root = this.root;\n        cleanTree(root);\n        //this.set(\"root\", root);\n\n        function cleanTree(node){\n            // we need to remove parent to delete circular reference\n            delete node.parent;\n\n            // removing unnecessary attributes\n            if (node._selected){ delete node._selected;}\n\n            if (node.children) {\n                node.children.forEach(cleanTree);\n            }\n            if (node._children) {\n                node._children.forEach(cleanTree);\n            }\n        }\n\n        var config  = jQuery.extend(true, {}, this.attributes);\n        config.selectedNode = null;\n\n        show_message(\"Saving to Galaxy\", \"progress\");\n\n        return $.ajax({\n            url     : this.url(),\n            type    : \"POST\",\n            dataType: \"json\",\n            data    : {\n                config  : JSON.stringify( config ),\n                type    : 'phyloviz'\n            },\n            success: function(res){\n                hide_modal();\n            }\n        });\n    }\n});\n\n\n// -- Views --\n/**\n *  Stores the default variable for setting up the visualization\n */\nvar PhylovizLayoutBase =  Backbone.View.extend({\n    defaults : {\n        nodeRadius : 4.5 // radius of each node in the diagram\n    },\n\n\n    /**\n     *  Common initialization in layouts\n     */\n    stdInit : function (options) {\n\n        var self = this;\n        self.model.on(\"change:separation change:leafHeight change:fontSize change:nodeAttrChangedTime\",\n            self.updateAndRender, self);\n\n        self.vis = options.vis;\n        self.i = 0;\n        self.maxDepth = -1; // stores the max depth of the tree\n\n        self.width = options.width;\n        self.height = options.height;\n    },\n\n\n    /**\n     *  Updates the visualization whenever there are changes in the expansion and contraction of nodes\n     *  AND possibly when the tree is edited.\n     */\n    updateAndRender : function(source) {\n        var vis = d3.select(\".vis\"),\n            self = this;\n        source = source || self.model.root;\n\n        self.renderNodes(source);\n        self.renderLinks(source);\n        self.addTooltips();\n    },\n\n\n    /**\n     * Renders the links for the visualization.\n     */\n    renderLinks : function(source) {\n        var self = this;\n        var diagonal = self.diagonal;\n        var duration = self.duration;\n        var layoutMode = self.layoutMode;\n        var link = self.vis.selectAll(\"g.completeLink\")\n            .data(self.tree.links(self.nodes), function(d) { return d.target.id; });\n\n        var calcalateLinePos = function(d) {\n            // position of the source node <=> starting location of the line drawn\n            d.pos0 = d.source.y0 + \" \" + d.source.x0;\n            // position where the line makes a right angle bend\n            d.pos1 = d.source.y0 + \" \" + d.target.x0;\n            // point where the horizontal line becomes a dotted line\n            d.pos2 = d.target.y0 + \" \" + d.target.x0;\n        };\n\n        var linkEnter = link.enter().insert(\"svg:g\",\"g.node\")\n            .attr(\"class\", \"completeLink\");\n\n        linkEnter.append(\"svg:path\")\n            .attr(\"class\", \"link\")\n            .attr(\"d\", function(d) {\n                calcalateLinePos(d);\n                return \"M \" + d.pos0  + \" L \" + d.pos1;\n            });\n\n        var linkUpdate = link.transition().duration(500);\n\n        linkUpdate.select(\"path.link\")\n            .attr(\"d\", function(d) {\n                calcalateLinePos(d);\n                return \"M \" + d.pos0 + \" L \" + d.pos1 + \" L \" + d.pos2;\n            });\n\n        var linkExit = link.exit().remove();\n\n    },\n\n    // User Interaction methods below\n\n    /**\n     *  Displays the information for editing\n     */\n    selectNode : function(node){\n        var self = this;\n        d3.selectAll(\"g.node\")\n            .classed(\"selectedHighlight\", function(d){\n                if (node.id === d.id){\n                    if(node._selected) { // for de=selecting node.\n                        delete node._selected;\n                        return false;\n                    } else {\n                        node._selected = true;\n                        return true;\n                    }\n                }\n                return false;\n            });\n\n        self.model.set(\"selectedNode\", node);\n        $(\"#phyloVizSelectedNodeName\").val(node.name);\n        $(\"#phyloVizSelectedNodeDist\").val(node.dist);\n        $(\"#phyloVizSelectedNodeAnnotation\").val(node.annotation || \"\");\n    },\n\n    /**\n     *  Creates bootstrap tooltip for the visualization. Has to be called repeatedly due to newly generated\n     *  enterNodes\n     */\n    addTooltips : function (){\n        $(\".tooltip\").remove();      //clean up tooltip, just in case its listeners are removed by d3\n        $(\".node\")\n            .attr(\"data-original-title\", function(){\n                var d = this.__data__,\n                    annotation = d.annotation || \"None\" ;\n                return d ? ( (d.name ? d.name + \"<br/>\" : \"\") + \"Dist: \" + d.dist + \" <br/>Annotation1: \" + annotation +\n                    ( d.bootstrap ? \"<br/>Confidence level: \" + ( Math.round( 100 * d.bootstrap ) ) : \"\") ): \"\";\n            })\n            .tooltip({'placement':'top', 'trigger' : 'hover'});\n\n    }\n});\n\n\n/**\n * Linea layout class of Phyloviz, is responsible for rendering the nodes\n * calls PhyloTreeLayout to determine the positions of the nodes\n */\nvar PhylovizLinearView =  PhylovizLayoutBase.extend({\n    initialize : function(options){\n        // Default values of linear layout\n        var self = this;\n        self.margins = options.margins;\n        self.layoutMode = \"Linear\";\n\n        self.stdInit(options);\n\n        self.layout();\n        self.updateAndRender(self.model.root);\n    },\n\n    /**\n     * Creates the basic layout of a linear tree by precalculating fixed values.\n     * One of calculations are also made here\n     */\n    layout : function() {\n        var self = this;\n        self.tree = new PhyloTreeLayout().layoutMode(\"Linear\");\n        self.diagonal = d3.svg.diagonal()\n            .projection(function(d) { return [d.y, d.x ]; });\n    },\n\n    /**\n     * Renders the nodes base on Linear layout.\n     */\n    renderNodes : function (source) {\n        var self = this,\n            fontSize = self.model.get(\"fontSize\") + \"px\";\n\n        // assigning properties from models\n        self.tree.separation(self.model.get(\"separation\")).leafHeight(self.model.get(\"leafHeight\"));\n\n        var duration = 500,\n            nodes = self.tree.separation(self.model.get(\"separation\")).nodes(self.model.root);\n\n        var node = self.vis.selectAll(\"g.node\")\n            .data(nodes, function(d) {\n                return d.name + d.id || (d.id = ++self.i);\n            });\n\n        // These variables has to be passed into update links which are in the base methods\n        self.nodes = nodes;\n        self.duration = duration;\n\n        // ------- D3 ENTRY --------\n        // Enter any new nodes at the parent's previous position.\n        var nodeEnter = node.enter().append(\"svg:g\")\n            .attr(\"class\", \"node\")\n            .on(\"dblclick\", function(){ d3.event.stopPropagation();    })\n            .on(\"click\", function(d) {\n                if (d3.event.altKey) {\n                    self.selectNode(d);        // display info if alt is pressed\n                } else {\n                    if(d.children && d.children.length === 0){ return;}  // there is no need to toggle leaves\n                    self.model.toggle(d);   // contract/expand nodes at data level\n                    self.updateAndRender(d);   // re-render the tree\n                }\n            });\n        //TODO: newick and phyloxml return arrays. where should this go (client (here, else), server)?\n        if( toString.call( source ) === '[object Array]' ){\n            // if d is an array, replate with the first object (newick, phyloxml)\n            source = source[0];\n        }\n        nodeEnter.attr(\"transform\", function(d) { return \"translate(\" + source.y0 + \",\" + source.x0 + \")\"; });\n\n        nodeEnter.append(\"svg:circle\")\n            .attr(\"r\", 1e-6)\n            .style(\"fill\", function(d) { return d._children ? \"lightsteelblue\" : \"#fff\"; });\n\n        nodeEnter.append(\"svg:text\")\n            .attr(\"class\", \"nodeLabel\")\n            .attr(\"x\", function(d) { return d.children || d._children ? -10 : 10; })\n            .attr(\"dy\", \".35em\")\n            .attr(\"text-anchor\", function(d) { return d.children || d._children ? \"end\" : \"start\"; })\n            .style(\"fill-opacity\", 1e-6);\n\n        // ------- D3 TRANSITION --------\n        // Transition nodes to their new position.\n        var nodeUpdate = node.transition()\n            .duration(duration);\n\n        nodeUpdate.attr(\"transform\", function(d) {\n            return \"translate(\" + d.y + \",\" + d.x + \")\"; });\n\n        nodeUpdate.select(\"circle\")\n            .attr(\"r\", self.defaults.nodeRadius)\n            .style(\"fill\", function(d) { return d._children ? \"lightsteelblue\" : \"#fff\"; });\n\n        nodeUpdate.select(\"text\")\n            .style(\"fill-opacity\", 1)\n            .style(\"font-size\", fontSize)\n            .text(function(d) { return ( ( d.name && d.name !== \"\" ) ? d.name : ( d.bootstrap ? Math.round( 100 * d.bootstrap ) : \"\" ) ) });\n\n        // ------- D3 EXIT --------\n        // Transition exiting nodes to the parent's new position.\n        var nodeExit =node.exit().transition()\n            .duration(duration)\n            .remove();\n\n        nodeExit.select(\"circle\")\n            .attr(\"r\", 1e-6);\n\n        nodeExit.select(\"text\")\n            .style(\"fill-opacity\", 1e-6);\n\n        // Stash the old positions for transition.\n        nodes.forEach(function(d) {\n            d.x0 = d.x; // we need the x0, y0 for parents with children\n            d.y0 = d.y;\n        });\n    }\n\n});\n\nvar PhylovizView = Backbone.View.extend({\n\n    className: 'phyloviz',\n\n    initialize: function(options) {\n        var self = this;\n        // -- Default values of the vis\n        self.MIN_SCALE = 0.05; //for zooming\n        self.MAX_SCALE = 5;\n        self.MAX_DISPLACEMENT = 500;\n        self.margins = [10, 60, 10, 80];\n\n        self.width = $(\"#PhyloViz\").width();\n        self.height = $(\"#PhyloViz\").height();\n        self.radius = self.width;\n        self.data = options.data;\n\n        // -- Events Phyloviz view responses to\n        $(window).resize(function(){\n            self.width = $(\"#PhyloViz\").width();\n            self.height = $(\"#PhyloViz\").height();\n            self.render();\n        });\n\n        // -- Create phyloTree model\n        self.phyloTree = new PhyloTree(options.config);\n        self.phyloTree.root = self.data;\n\n        // -- Set up UI functions of main view\n        self.zoomFunc = d3.behavior.zoom().scaleExtent([self.MIN_SCALE, self.MAX_SCALE]);\n        self.zoomFunc.translate(self.phyloTree.get(\"translate\"));\n        self.zoomFunc.scale(self.phyloTree.get(\"scaleFactor\"));\n\n        // -- set up header buttons, search and settings menu\n        self.navMenu = new HeaderButtons(self);\n        self.settingsMenu = new SettingsMenu({phyloTree : self.phyloTree});\n        self.nodeSelectionView = new NodeSelectionView({phyloTree : self.phyloTree});\n        self.search = new PhyloVizSearch();\n\n        // using settimeout to call the zoomAndPan function according to the stored attributes in viz_config\n        setTimeout(function(){\n            self.zoomAndPan();\n        }, 1000);\n    },\n\n    render: function(){\n        // -- Creating helper function for vis. --\n        var self = this;\n        $(\"#PhyloViz\").empty();\n\n        // -- Layout viz. --\n        self.mainSVG = d3.select(\"#PhyloViz\").append(\"svg:svg\")\n            .attr(\"width\", self.width)\n            .attr(\"height\", self.height)\n            .attr(\"pointer-events\", \"all\")\n            .call(self.zoomFunc.on(\"zoom\", function(){\n            self.zoomAndPan();\n        }));\n\n        self.boundingRect = self.mainSVG.append(\"svg:rect\")\n            .attr(\"class\", \"boundingRect\")\n            .attr(\"width\", self.width)\n            .attr(\"height\", self.height)\n            .attr(\"stroke\", \"black\")\n            .attr(\"fill\", \"white\");\n\n        self.vis = self.mainSVG\n            .append(\"svg:g\")\n            .attr(\"class\", \"vis\");\n\n        self.layoutOptions = {\n            model : self.phyloTree,\n            width : self.width,\n            height : self.height,\n            vis: self.vis,\n            margins: self.margins\n        };\n\n        // -- Creating Title\n        $(\"#title\").text(\"Phylogenetic Tree from \" + self.phyloTree.get(\"title\") + \":\");\n\n        // -- Create Linear view instance --\n        var linearView = new PhylovizLinearView(self.layoutOptions);\n    },\n\n    /**\n     * Function to zoom and pan the svg element which the entire tree is contained within\n     * Uses d3.zoom events, and extend them to allow manual updates and keeping states in model\n     */\n    zoomAndPan : function(event){\n         var zoomParams,\n            translateParams;\n        if (typeof event !== \"undefined\") {\n            zoomParams = event.zoom;\n            translateParams = event.translate;\n        }\n\n        var self = this,\n            scaleFactor = self.zoomFunc.scale(),\n            translationCoor = self.zoomFunc.translate(),\n            zoomStatement = \"\",\n            translateStatement = \"\";\n\n        // Do manual scaling.\n        switch (zoomParams) {\n            case \"reset\":\n                scaleFactor = 1.0;\n                translationCoor = [0,0]; break;\n            case \"+\":\n                scaleFactor *= 1.1; break;\n            case \"-\":\n                scaleFactor *= 0.9; break;\n            default:\n                if (typeof zoomParams === \"number\") {\n                    scaleFactor = zoomParams;\n                } else if (d3.event !== null) {\n                    scaleFactor = d3.event.scale;\n                }\n        }\n        if (scaleFactor < self.MIN_SCALE || scaleFactor > self.MAX_SCALE) { return;}\n        self.zoomFunc.scale(scaleFactor); //update scale Factor\n        zoomStatement = \"translate(\" +  self.margins[3] + \",\" + self.margins[0] + \")\" +\n            \" scale(\" + scaleFactor + \")\";\n\n        // Do manual translation.\n        if( d3.event !== null) {\n            translateStatement = \"translate(\" + d3.event.translate + \")\";\n        } else {\n            if(typeof translateParams !== \"undefined\") {\n                var x = translateParams.split(\",\")[0];\n                var y = translateParams.split(\",\")[1];\n                if (!isNaN(x) && !isNaN(y)){\n                    translationCoor = [translationCoor[0] + parseFloat(x), translationCoor[1] + parseFloat(y)];\n                }\n            }\n            self.zoomFunc.translate(translationCoor);   // update zoomFunc\n            translateStatement = \"translate(\" + translationCoor + \")\";\n        }\n\n        self.phyloTree.set(\"scaleFactor\", scaleFactor);\n        self.phyloTree.set(\"translate\", translationCoor);\n        //refers to the view that we are actually zooming\n        self.vis.attr(\"transform\", translateStatement + zoomStatement);\n    },\n\n\n    /**\n     * Primes the Ajax URL to load another Nexus tree\n     */\n    reloadViz : function() {\n        var self = this,\n            treeIndex = $(\"#phylovizNexSelector :selected\").val();\n        $.getJSON(self.phyloTree.get(\"dataset\").url(), {\n                tree_index: treeIndex,\n                data_type: 'raw_data'\n            },\n            function(packedJson){\n                self.data = packedJson.data;\n                self.config = packedJson;\n                self.render();\n            });\n    }\n});\n\n\nvar HeaderButtons = Backbone.View.extend({\n\n    initialize : function(phylovizView){\n        var self = this;\n        self.phylovizView = phylovizView;\n\n        // Clean up code - if the class initialized more than once\n        $(\"#panelHeaderRightBtns\").empty();\n        $(\"#phyloVizNavBtns\").empty();\n        $(\"#phylovizNexSelector\").off();\n\n        self.initNavBtns();\n        self.initRightHeaderBtns();\n\n        // Initial a tree selector in the case of nexus\n        $(\"#phylovizNexSelector\").off().on(\"change\",  function() {self.phylovizView.reloadViz();}  );\n\n    },\n\n    initRightHeaderBtns : function(){\n        var self = this;\n\n        var rightMenu = mod_icon_btn.create_icon_buttons_menu([\n            { icon_class: 'gear', title: 'PhyloViz Settings', on_click: function(){\n                $(\"#SettingsMenu\").show();\n                self.settingsMenu.updateUI();\n            } },\n            { icon_class: 'disk', title: 'Save visualization', on_click: function() {\n                var nexSelected = $(\"#phylovizNexSelector option:selected\").text();\n                if(nexSelected) {\n                    self.phylovizView.phyloTree.set(\"title\", nexSelected);\n                }\n                self.phylovizView.phyloTree.save();\n            } },\n            { icon_class: 'chevron-expand', title: 'Search / Edit Nodes', on_click: function() {\n                $(\"#nodeSelectionView\").show();\n            } },\n            { icon_class: 'information', title: 'Phyloviz Help', on_click: function() {\n                window.open('https://galaxyproject.org/learn/visualization/phylogenetic-tree/');\n                // https://docs.google.com/document/d/1AXFoJgEpxr21H3LICRs3EyMe1B1X_KFPouzIgrCz3zk/edit\n            } }\n        ],\n            {\n                tooltip_config: { placement: 'bottom' }\n            });\n        $(\"#panelHeaderRightBtns\").append(rightMenu.$el);\n    },\n\n    initNavBtns: function() {\n        var self = this,\n            navMenu = mod_icon_btn.create_icon_buttons_menu([\n                { icon_class: 'zoom-in', title: 'Zoom in', on_click: function() {\n                    self.phylovizView.zoomAndPan({ zoom : \"+\"});\n                } },\n                { icon_class: 'zoom-out', title: 'Zoom out', on_click: function() {\n                    self.phylovizView.zoomAndPan({ zoom : \"-\"});\n                } },\n                { icon_class: 'arrow-circle', title: 'Reset Zoom/Pan', on_click: function() {\n                    self.phylovizView.zoomAndPan({ zoom : \"reset\"});\n                } }\n            ],\n                {\n                    tooltip_config: { placement: 'bottom' }\n                });\n        $(\"#phyloVizNavBtns\").append(navMenu.$el);\n    }\n});\n\n\nvar SettingsMenu = UserMenuBase.extend({\n\n    className: 'Settings',\n\n    initialize: function(options){\n        // settings needs to directly interact with the phyloviz model so it will get access to it.\n        var self = this;\n        self.phyloTree = options.phyloTree;\n        self.el = $(\"#SettingsMenu\");\n        self.inputs = {\n            separation : $(\"#phyloVizTreeSeparation\"),\n            leafHeight : $(\"#phyloVizTreeLeafHeight\"),\n            fontSize   : $(\"#phyloVizTreeFontSize\")\n        };\n\n        //init all buttons of settings\n        $(\"#settingsCloseBtn\").off().on(\"click\", function() { self.el.hide(); });\n        $(\"#phylovizResetSettingsBtn\").off().on(\"click\", function() { self.resetToDefaults(); });\n        $(\"#phylovizApplySettingsBtn\").off().on(\"click\", function() { self.apply(); });\n    },\n\n    /**\n     * Applying user values to phylotree model.\n     */\n    apply : function(){\n        var self = this;\n        if (!self.isAcceptableValue(self.inputs.separation, 50, 2500) ||\n            !self.isAcceptableValue(self.inputs.leafHeight, 5, 30) ||\n            !self.isAcceptableValue(self.inputs.fontSize, 5, 20)){\n            return;\n        }\n        $.each(self.inputs, function(key, $input){\n            self.phyloTree.set(key, $input.val());\n        });\n    },\n    /**\n     * Called to update the values input to that stored in the model\n     */\n    updateUI : function(){\n        var self = this;\n        $.each(self.inputs, function(key, $input){\n            $input.val(self.phyloTree.get(key));\n        });\n    },\n    /**\n     * Resets the value of the phyloTree model to its default\n     */\n    resetToDefaults : function(){\n        $(\".tooltip\").remove();      // just in case the tool tip was not removed\n        var self = this;\n        $.each(self.phyloTree.defaults, function(key, value) {\n            self.phyloTree.set(key, value);\n        });\n        self.updateUI();\n    },\n\n    render: function(){\n\n    }\n\n});\n\n\n/**\n * View for inspecting node properties and editing them\n */\nvar NodeSelectionView = UserMenuBase.extend({\n\n    className: 'Settings',\n\n    initialize : function (options){\n        var self = this;\n        self.el = $(\"#nodeSelectionView\");\n        self.phyloTree = options.phyloTree;\n\n        self.UI = {\n            enableEdit      : $('#phylovizEditNodesCheck'),\n            saveChanges     : $('#phylovizNodeSaveChanges'),\n            cancelChanges   : $(\"#phylovizNodeCancelChanges\"),\n            name            : $(\"#phyloVizSelectedNodeName\"),\n            dist            : $(\"#phyloVizSelectedNodeDist\"),\n            annotation      : $(\"#phyloVizSelectedNodeAnnotation\")\n        };\n\n        // temporarily stores the values in case user change their mind\n        self.valuesOfConcern = {\n            name : null,\n            dist : null,\n            annotation : null\n        };\n\n        //init UI buttons\n        $(\"#nodeSelCloseBtn\").off().on(\"click\", function() { self.el.hide(); });\n        self.UI.saveChanges.off().on(\"click\", function(){ self.updateNodes(); });\n        self.UI.cancelChanges.off().on(\"click\", function(){ self.cancelChanges(); });\n\n        (function ($) {\n            // extending jquery fxn for enabling and disabling nodes.\n            $.fn.enable = function (isEnabled) {\n                return $(this).each(function () {\n                    if(isEnabled){\n                        $(this).removeAttr('disabled');\n                    } else {\n                        $(this).attr('disabled', 'disabled');\n                    }\n                });\n            };\n        })(jQuery);\n\n        self.UI.enableEdit.off().on(\"click\", function () {\n            self.toggleUI();\n        });\n    },\n\n    /**\n     * For turning on and off the child elements\n     */\n    toggleUI : function(){\n        var self = this,\n            checked = self.UI.enableEdit.is(':checked');\n\n        if (!checked) { self.cancelChanges(); }\n\n        $.each(self.valuesOfConcern, function(key, value) {\n            self.UI[key].enable(checked);\n        });\n        if(checked){\n            self.UI.saveChanges.show();\n            self.UI.cancelChanges.show();\n        } else {\n            self.UI.saveChanges.hide();\n            self.UI.cancelChanges.hide();\n        }\n\n    },\n\n    /**\n     * Reverting to previous values in case user change their minds\n     */\n    cancelChanges : function() {\n        var self = this,\n            node = self.phyloTree.get(\"selectedNode\");\n        if (node){\n            $.each(self.valuesOfConcern, function(key, value) {\n                self.UI[key].val(node[key]);\n            });\n        }\n    },\n\n    /**\n     * Changing the data in the underlying tree with user-specified values\n     */\n    updateNodes : function (){\n        var self = this,\n            node = self.phyloTree.get(\"selectedNode\");\n        if (node){\n            if (!self.isAcceptableValue(self.UI.dist, 0, 1) ||\n                self.hasIllegalJsonCharacters(self.UI.name) ||\n                self.hasIllegalJsonCharacters(self.UI.annotation) ) {\n                return;\n            }\n            $.each(self.valuesOfConcern, function(key, value) {\n                (node[key]) = self.UI[key].val();\n            });\n            self.phyloTree.set(\"nodeAttrChangedTime\", new Date());\n        } else {\n            alert(\"No node selected\");\n        }\n    }\n});\n\n\n\n/**\n * Initializes the search panel on phyloviz and handles its user interaction\n * It allows user to search the entire free based on some qualifer, like dist <= val.\n */\nvar PhyloVizSearch = UserMenuBase.extend({\n    initialize : function () {\n        var self = this;\n\n        $(\"#phyloVizSearchBtn\").on(\"click\", function(){\n            var searchTerm = $(\"#phyloVizSearchTerm\"),\n                searchConditionVal = $(\"#phyloVizSearchCondition\").val().split(\"-\"),\n                attr = searchConditionVal[0],\n                condition = searchConditionVal[1];\n            self.hasIllegalJsonCharacters(searchTerm);\n\n            if (attr === \"dist\"){\n                self.isAcceptableValue(searchTerm, 0, 1);\n            }\n            self.searchTree(attr, condition, searchTerm.val());\n        });\n    },\n\n    /**\n     * Searches the entire tree and will highlight the nodes that match the condition in green\n     */\n    searchTree : function (attr, condition, val){\n        d3.selectAll(\"g.node\")\n            .classed(\"searchHighlight\", function(d){\n                var attrVal =  d[attr];\n                if (typeof attrVal !== \"undefined\" && attrVal !== null){\n                    if (attr === \"dist\"){\n                        switch (condition) {\n                            case \"greaterEqual\":\n                                return attrVal >= +val;\n                            case \"lesserEqual\":\n                                return attrVal <= +val;\n                            default:\n                                return;\n                        }\n\n                    } else if (attr === \"name\" || attr === \"annotation\") {\n                        return attrVal.toLowerCase().indexOf(val.toLowerCase()) !== -1;\n                    }\n                }\n            });\n    }\n});\n\nreturn {\n    PhylovizView: PhylovizView\n};\n\n});\n"]}