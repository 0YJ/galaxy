{"version":3,"sources":["viz/phyloviz.js"],"names":["PhyloTreeLayout","layout","node","maxDepth","vertSeparation","parent","children","nodes","numLeaves","depth","dist","y0","depthSeparation","forEach","child","sumChildVertSeparation","x0","length","leafIndex","x","self","this","alert","fieldName","hierarchy","sort","height","layoutMode","leafHeight","defaultDist","maxTextWidth","inputLeafHeight","mode","angle","separation","links","d3","tree","d","i","toString","call","_nodes","window","_d","push","UserMenuBase","Backbone","View","extend","className","isAcceptableValue","$inputKey","min","max","value","val","attr","replace","n","isNaN","parseFloat","isFinite","isNumeric","hasIllegalJsonCharacters","search","Visualization","defaults","title","translate","fontSize","selectedNode","initialize","options","set","_data2","default","Dataset","id","dataset_id","_children","toggleAll","toggle","root","cleanTree","getData","_selected","config","jQuery","attributes","show_message","$","ajax","url","type","dataType","data","success","PhylovizLinearView","hide_modal","model","on","updateAndRender","vis","PhylovizLayoutBase","nodeRadius","width","source","select","renderNodes","renderLinks","link","duration","target","calcalateLinePos","pos0","pos1","pos2","enter","insert","append","transition","linkEnter","exit","remove","selectNode","linkExit","selectAll","classed","name","annotation","__data__","bootstrap","Math","round","tooltip","placement","trigger","margins","diagonal","svg","projection","y","get","event","altKey","nodeEnter","nodeUpdate","style","nodeExit","text","PhylovizView","MAX_DISPLACEMENT","render","zoomFunc","MIN_SCALE","phyloTree","nodeSelectionView","radius","setTimeout","zoomAndPan","PhyloTree","empty","scaleExtent","MAX_SCALE","boundingRect","mainSVG","navMenu","HeaderButtons","layoutOptions","SettingsMenu","NodeSelectionView","PhyloVizSearch","zoomParams","translateParams","scaleFactor","translationCoor","zoomStatement","zoom","scale","translateStatement","reloadViz","treeIndex","getJSON","tree_index","data_type","phylovizView","initRightHeaderBtns","split","off","on_click","show","icon_class","packedJson","tooltip_config","initNavBtns","create_icon_buttons_menu","settingsMenu","updateUI","nexSelected","save","open","key","$input","$el","_iconButton2","cancelChanges","valuesOfConcern","saveChanges","updateNodes","resetToDefaults","apply","inputs","each","toggleUI","checked","UI","el","enableEdit","hide","fn","enable","isEnabled","removeAttr","searchTree","is","Date","searchTerm","searchConditionVal","condition","attrVal","toLowerCase","indexOf"],"mappings":"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","file":"../../scripts/viz/phyloviz.js","sourcesContent":["import * as d3 from \"libs/d3\";\nimport visualization_mod from \"viz/visualization\";\nimport data_mod from \"mvc/dataset/data\";\nimport mod_icon_btn from \"mvc/ui/icon-button\";\n/**\n * Base class of any menus that takes in user interaction. Contains checking methods.\n */\nvar UserMenuBase = Backbone.View.extend({\n    className: \"UserMenuBase\",\n\n    /**\n     * Check if an input value is a number and falls within max min.\n     */\n    isAcceptableValue: function($inputKey, min, max) {\n        //TODO: use better feedback than alert\n        var value = $inputKey.val();\n\n        var fieldName =\n            $inputKey.attr(\"displayLabel\") ||\n            $inputKey.attr(\"id\").replace(\"phyloViz\", \"\");\n\n        function isNumeric(n) {\n            return !isNaN(parseFloat(n)) && isFinite(n);\n        }\n\n        if (!isNumeric(value)) {\n            alert(`${fieldName} is not a number!`);\n            return false;\n        }\n\n        if (value > max) {\n            alert(`${fieldName} is too large.`);\n            return false;\n        } else if (value < min) {\n            alert(`${fieldName} is too small.`);\n            return false;\n        }\n        return true;\n    },\n\n    /**\n     * Check if any user string inputs has illegal characters that json cannot accept\n     */\n    hasIllegalJsonCharacters: function($inputKey) {\n        if ($inputKey.val().search(/\"|'|\\\\/) !== -1) {\n            alert(\n                \"Named fields cannot contain these illegal characters: \" +\n                    \"double quote(\\\"), single guote('), or back slash(\\\\). \"\n            );\n            return true;\n        }\n        return false;\n    }\n});\n\n/**\n * -- Custom Layout call for phyloViz to suit the needs of a phylogenetic tree.\n * -- Specifically: 1) Nodes have a display display of (= evo dist X depth separation) from their parent\n *                  2) Nodes must appear in other after they have expand and contracted\n */\nfunction PhyloTreeLayout() {\n    var self = this; // maximum length of the text labels\n\n    var hierarchy = d3.layout\n        .hierarchy()\n        .sort(null)\n        .value(null);\n\n    var // ! represents both the layout angle and the height of the layout, in px\n    height = 360;\n\n    var layoutMode = \"Linear\";\n\n    var // height of each individual leaf node\n    leafHeight = 18;\n\n    var // separation between nodes of different depth, in px\n    depthSeparation = 200;\n\n    var // change to recurssive call\n    leafIndex = 0;\n\n    var // tree defaults to 0.5 dist if no dist is specified\n    defaultDist = 0.5;\n\n    var maxTextWidth = 50;\n\n    self.leafHeight = inputLeafHeight => {\n        if (typeof inputLeafHeight === \"undefined\") {\n            return leafHeight;\n        } else {\n            leafHeight = inputLeafHeight;\n            return self;\n        }\n    };\n\n    self.layoutMode = mode => {\n        if (typeof mode === \"undefined\") {\n            return layoutMode;\n        } else {\n            layoutMode = mode;\n            return self;\n        }\n    };\n\n    // changes the layout angle of the display, which is really changing the height\n    self.layoutAngle = angle => {\n        if (typeof angle === \"undefined\") {\n            return height;\n        }\n        // to use default if the user puts in strange values\n        if (isNaN(angle) || angle < 0 || angle > 360) {\n            return self;\n        } else {\n            height = angle;\n            return self;\n        }\n    };\n\n    self.separation = dist => {\n        // changes the dist between the nodes of different depth\n        if (typeof dist === \"undefined\") {\n            return depthSeparation;\n        } else {\n            depthSeparation = dist;\n            return self;\n        }\n    };\n\n    self.links = (\n        nodes // uses d3 native method to generate links. Done.\n    ) => d3.layout.tree().links(nodes);\n\n    // -- Custom method for laying out phylogeny tree in a linear fashion\n    self.nodes = (d, i) => {\n        //TODO: newick and phyloxml return arrays. where should this go (client (here, else), server)?\n        if (toString.call(d) === \"[object Array]\") {\n            // if d is an array, replate with the first object (newick, phyloxml)\n            d = d[0];\n        }\n\n        // self is to find the depth of all the nodes, assumes root is passed in\n        var _nodes = hierarchy.call(self, d, i);\n\n        var nodes = [];\n        var maxDepth = 0;\n        var numLeaves = 0;\n        //console.debug( JSON.stringify( _nodes, null, 2 ) )\n        window._d = d;\n        window._nodes = _nodes;\n\n        //TODO: remove dbl-touch loop\n        // changing from hierarchy's custom format for data to usable format\n        _nodes.forEach(node => {\n            maxDepth = node.depth > maxDepth ? node.depth : maxDepth; //finding max depth of tree\n            nodes.push(node);\n        });\n        // counting the number of leaf nodes and assigning max depth\n        //  to nodes that do not have children to flush all the leave nodes\n        nodes.forEach(node => {\n            if (!node.children) {\n                //&& !node._children\n                numLeaves += 1;\n                node.depth = maxDepth; // if a leaf has no child it would be assigned max depth\n            }\n        });\n\n        leafHeight =\n            layoutMode === \"Circular\" ? height / numLeaves : leafHeight;\n        leafIndex = 0;\n        layout(nodes[0], maxDepth, leafHeight, null);\n\n        return nodes;\n    };\n\n    /**\n     * -- Function with side effect of adding x0, y0 to all child; take in the root as starting point\n     *  assuming that the leave nodes would be sorted in presented order\n     *          horizontal(y0) is calculated according to (= evo dist X depth separation) from their parent\n     *          vertical (x0) - if leave node: find its order in all of the  leave node === node.id,\n     *                              then multiply by verticalSeparation\n     *                  - if parent node: is place in the mid point all of its children nodes\n     * -- The layout will first calculate the y0 field going towards the leaves, and x0 when returning\n     */\n    function layout(node, maxDepth, vertSeparation, parent) {\n        var children = node.children;\n        var sumChildVertSeparation = 0;\n\n        // calculation of node's dist from parents, going down.\n        var dist = node.dist || defaultDist;\n        dist = dist > 1 ? 1 : dist; // We constrain all dist to be less than one\n        node.dist = dist;\n        if (parent !== null) {\n            node.y0 = parent.y0 + dist * depthSeparation;\n        } else {\n            //root node\n            node.y0 = maxTextWidth;\n        }\n\n        // if a node have no children, we will treat it as a leaf and start laying it out first\n        if (!children) {\n            node.x0 = leafIndex * vertSeparation;\n            leafIndex += 1;\n        } else {\n            // if it has children, we will visit all its children and calculate its position from its children\n            children.forEach(child => {\n                child.parent = node;\n                sumChildVertSeparation += layout(\n                    child,\n                    maxDepth,\n                    vertSeparation,\n                    node\n                );\n            });\n            node.x0 = sumChildVertSeparation / children.length;\n        }\n\n        // adding properties to the newly created node\n        node.x = node.x0;\n        node.y = node.y0;\n        return node.x0;\n    }\n    return self;\n}\n\n/**\n * -- PhyloTree Model --\n */\nvar PhyloTree = visualization_mod.Visualization.extend({\n    defaults: {\n        layout: \"Linear\",\n        separation: 250, // px dist between nodes of different depth to represent 1 evolutionary until\n        leafHeight: 18,\n        type: \"phyloviz\", // visualization type\n        title: \"Title\",\n        scaleFactor: 1,\n        translate: [0, 0],\n        fontSize: 12, //fontSize of node label\n        selectedNode: null,\n        nodeAttrChangedTime: 0\n    },\n\n    initialize: function(options) {\n        this.set(\n            \"dataset\",\n            new data_mod.Dataset({\n                id: options.dataset_id\n            })\n        );\n    },\n\n    root: {}, // Root has to be its own independent object because it is not part of the viz_config\n\n    /**\n     * Mechanism to expand or contract a single node. Expanded nodes have a children list, while for\n     * contracted nodes the list is stored in _children. Nodes with their children data stored in _children will not\n     * have their children rendered.\n     */\n    toggle: function(d) {\n        if (typeof d === \"undefined\") {\n            return;\n        }\n        if (d.children) {\n            d._children = d.children;\n            d.children = null;\n        } else {\n            d.children = d._children;\n            d._children = null;\n        }\n    },\n\n    /**\n     *  Contracts the phylotree to a single node by repeatedly calling itself to place all the list\n     *  of children under _children.\n     */\n    toggleAll: function(d) {\n        if (d.children && d.children.length !== 0) {\n            d.children.forEach(this.toggleAll);\n            toggle(d);\n        }\n    },\n\n    /**\n     *  Return the data of the tree. Used for preserving state.\n     */\n    getData: function() {\n        return this.root;\n    },\n\n    /**\n     * Overriding the default save mechanism to do some clean of circular reference of the\n     * phyloTree and to include phyloTree in the saved json\n     */\n    save: function() {\n        var root = this.root;\n        cleanTree(root);\n        //this.set(\"root\", root);\n\n        function cleanTree(node) {\n            // we need to remove parent to delete circular reference\n            delete node.parent;\n\n            // removing unnecessary attributes\n            if (node._selected) {\n                delete node._selected;\n            }\n\n            if (node.children) {\n                node.children.forEach(cleanTree);\n            }\n            if (node._children) {\n                node._children.forEach(cleanTree);\n            }\n        }\n\n        var config = jQuery.extend(true, {}, this.attributes);\n        config.selectedNode = null;\n\n        show_message(\"Saving to Galaxy\", \"progress\");\n\n        return $.ajax({\n            url: this.url(),\n            type: \"POST\",\n            dataType: \"json\",\n            data: {\n                config: JSON.stringify(config),\n                type: \"phyloviz\"\n            },\n            success: function(res) {\n                hide_modal();\n            }\n        });\n    }\n});\n\n// -- Views --\n/**\n *  Stores the default variable for setting up the visualization\n */\nvar PhylovizLayoutBase = Backbone.View.extend({\n    defaults: {\n        nodeRadius: 4.5 // radius of each node in the diagram\n    },\n\n    /**\n     *  Common initialization in layouts\n     */\n    stdInit: function(options) {\n        var self = this;\n        self.model.on(\n            \"change:separation change:leafHeight change:fontSize change:nodeAttrChangedTime\",\n            self.updateAndRender,\n            self\n        );\n\n        self.vis = options.vis;\n        self.i = 0;\n        self.maxDepth = -1; // stores the max depth of the tree\n\n        self.width = options.width;\n        self.height = options.height;\n    },\n\n    /**\n     *  Updates the visualization whenever there are changes in the expansion and contraction of nodes\n     *  AND possibly when the tree is edited.\n     */\n    updateAndRender: function(source) {\n        var vis = d3.select(\".vis\");\n        var self = this;\n        source = source || self.model.root;\n\n        self.renderNodes(source);\n        self.renderLinks(source);\n        self.addTooltips();\n    },\n\n    /**\n     * Renders the links for the visualization.\n     */\n    renderLinks: function(source) {\n        var self = this;\n        var diagonal = self.diagonal;\n        var duration = self.duration;\n        var layoutMode = self.layoutMode;\n        var link = self.vis\n            .selectAll(\"g.completeLink\")\n            .data(self.tree.links(self.nodes), d => d.target.id);\n\n        var calcalateLinePos = d => {\n            // position of the source node <=> starting location of the line drawn\n            d.pos0 = `${d.source.y0} ${d.source.x0}`;\n            // position where the line makes a right angle bend\n            d.pos1 = `${d.source.y0} ${d.target.x0}`;\n            // point where the horizontal line becomes a dotted line\n            d.pos2 = `${d.target.y0} ${d.target.x0}`;\n        };\n\n        var linkEnter = link\n            .enter()\n            .insert(\"svg:g\", \"g.node\")\n            .attr(\"class\", \"completeLink\");\n\n        linkEnter\n            .append(\"svg:path\")\n            .attr(\"class\", \"link\")\n            .attr(\"d\", d => {\n                calcalateLinePos(d);\n                return `M ${d.pos0} L ${d.pos1}`;\n            });\n\n        var linkUpdate = link.transition().duration(500);\n\n        linkUpdate.select(\"path.link\").attr(\"d\", d => {\n            calcalateLinePos(d);\n            return `M ${d.pos0} L ${d.pos1} L ${d.pos2}`;\n        });\n\n        var linkExit = link.exit().remove();\n    },\n\n    // User Interaction methods below\n\n    /**\n     *  Displays the information for editing\n     */\n    selectNode: function(node) {\n        var self = this;\n        d3.selectAll(\"g.node\").classed(\"selectedHighlight\", d => {\n            if (node.id === d.id) {\n                if (node._selected) {\n                    // for de=selecting node.\n                    delete node._selected;\n                    return false;\n                } else {\n                    node._selected = true;\n                    return true;\n                }\n            }\n            return false;\n        });\n\n        self.model.set(\"selectedNode\", node);\n        $(\"#phyloVizSelectedNodeName\").val(node.name);\n        $(\"#phyloVizSelectedNodeDist\").val(node.dist);\n        $(\"#phyloVizSelectedNodeAnnotation\").val(node.annotation || \"\");\n    },\n\n    /**\n     *  Creates bootstrap tooltip for the visualization. Has to be called repeatedly due to newly generated\n     *  enterNodes\n     */\n    addTooltips: function() {\n        $(\".tooltip\").remove(); //clean up tooltip, just in case its listeners are removed by d3\n        $(\".node\")\n            .attr(\"data-original-title\", function() {\n                var d = this.__data__;\n                var annotation = d.annotation || \"None\";\n                return d\n                    ? `${d.name\n                          ? `${d.name}<br/>`\n                          : \"\"}Dist: ${d.dist} <br/>Annotation1: ${annotation}${d.bootstrap\n                          ? `<br/>Confidence level: ${Math.round(\n                                100 * d.bootstrap\n                            )}`\n                          : \"\"}`\n                    : \"\";\n            })\n            .tooltip({ placement: \"top\", trigger: \"hover\" });\n    }\n});\n\n/**\n * Linea layout class of Phyloviz, is responsible for rendering the nodes\n * calls PhyloTreeLayout to determine the positions of the nodes\n */\nvar PhylovizLinearView = PhylovizLayoutBase.extend({\n    initialize: function(options) {\n        // Default values of linear layout\n        var self = this;\n        self.margins = options.margins;\n        self.layoutMode = \"Linear\";\n\n        self.stdInit(options);\n\n        self.layout();\n        self.updateAndRender(self.model.root);\n    },\n\n    /**\n     * Creates the basic layout of a linear tree by precalculating fixed values.\n     * One of calculations are also made here\n     */\n    layout: function() {\n        var self = this;\n        self.tree = new PhyloTreeLayout().layoutMode(\"Linear\");\n        self.diagonal = d3.svg.diagonal().projection(d => [d.y, d.x]);\n    },\n\n    /**\n     * Renders the nodes base on Linear layout.\n     */\n    renderNodes: function(source) {\n        var self = this;\n        var fontSize = `${self.model.get(\"fontSize\")}px`;\n\n        // assigning properties from models\n        self.tree\n            .separation(self.model.get(\"separation\"))\n            .leafHeight(self.model.get(\"leafHeight\"));\n\n        var duration = 500;\n\n        var nodes = self.tree\n            .separation(self.model.get(\"separation\"))\n            .nodes(self.model.root);\n\n        var node = self.vis\n            .selectAll(\"g.node\")\n            .data(nodes, d => d.name + d.id || (d.id = ++self.i));\n\n        // These variables has to be passed into update links which are in the base methods\n        self.nodes = nodes;\n        self.duration = duration;\n\n        // ------- D3 ENTRY --------\n        // Enter any new nodes at the parent's previous position.\n        var nodeEnter = node\n            .enter()\n            .append(\"svg:g\")\n            .attr(\"class\", \"node\")\n            .on(\"dblclick\", () => {\n                d3.event.stopPropagation();\n            })\n            .on(\"click\", d => {\n                if (d3.event.altKey) {\n                    self.selectNode(d); // display info if alt is pressed\n                } else {\n                    if (d.children && d.children.length === 0) {\n                        return;\n                    } // there is no need to toggle leaves\n                    self.model.toggle(d); // contract/expand nodes at data level\n                    self.updateAndRender(d); // re-render the tree\n                }\n            });\n        //TODO: newick and phyloxml return arrays. where should this go (client (here, else), server)?\n        if (toString.call(source) === \"[object Array]\") {\n            // if d is an array, replate with the first object (newick, phyloxml)\n            source = source[0];\n        }\n        nodeEnter.attr(\n            \"transform\",\n            d => `translate(${source.y0},${source.x0})`\n        );\n\n        nodeEnter\n            .append(\"svg:circle\")\n            .attr(\"r\", 1e-6)\n            .style(\"fill\", d => (d._children ? \"lightsteelblue\" : \"#fff\"));\n\n        nodeEnter\n            .append(\"svg:text\")\n            .attr(\"class\", \"nodeLabel\")\n            .attr(\"x\", d => (d.children || d._children ? -10 : 10))\n            .attr(\"dy\", \".35em\")\n            .attr(\n                \"text-anchor\",\n                d => (d.children || d._children ? \"end\" : \"start\")\n            )\n            .style(\"fill-opacity\", 1e-6);\n\n        // ------- D3 TRANSITION --------\n        // Transition nodes to their new position.\n        var nodeUpdate = node.transition().duration(duration);\n\n        nodeUpdate.attr(\"transform\", d => `translate(${d.y},${d.x})`);\n\n        nodeUpdate\n            .select(\"circle\")\n            .attr(\"r\", self.defaults.nodeRadius)\n            .style(\"fill\", d => (d._children ? \"lightsteelblue\" : \"#fff\"));\n\n        nodeUpdate\n            .select(\"text\")\n            .style(\"fill-opacity\", 1)\n            .style(\"font-size\", fontSize)\n            .text(\n                d =>\n                    d.name && d.name !== \"\"\n                        ? d.name\n                        : d.bootstrap ? Math.round(100 * d.bootstrap) : \"\"\n            );\n\n        // ------- D3 EXIT --------\n        // Transition exiting nodes to the parent's new position.\n        var nodeExit = node\n            .exit()\n            .transition()\n            .duration(duration)\n            .remove();\n\n        nodeExit.select(\"circle\").attr(\"r\", 1e-6);\n\n        nodeExit.select(\"text\").style(\"fill-opacity\", 1e-6);\n\n        // Stash the old positions for transition.\n        nodes.forEach(d => {\n            d.x0 = d.x; // we need the x0, y0 for parents with children\n            d.y0 = d.y;\n        });\n    }\n});\n\nvar PhylovizView = Backbone.View.extend({\n    className: \"phyloviz\",\n\n    initialize: function(options) {\n        var self = this;\n        // -- Default values of the vis\n        self.MIN_SCALE = 0.05; //for zooming\n        self.MAX_SCALE = 5;\n        self.MAX_DISPLACEMENT = 500;\n        self.margins = [10, 60, 10, 80];\n\n        self.width = $(\"#PhyloViz\").width();\n        self.height = $(\"#PhyloViz\").height();\n        self.radius = self.width;\n        self.data = options.data;\n\n        // -- Events Phyloviz view responses to\n        $(window).resize(() => {\n            self.width = $(\"#PhyloViz\").width();\n            self.height = $(\"#PhyloViz\").height();\n            self.render();\n        });\n\n        // -- Create phyloTree model\n        self.phyloTree = new PhyloTree(options.config);\n        self.phyloTree.root = self.data;\n\n        // -- Set up UI functions of main view\n        self.zoomFunc = d3.behavior\n            .zoom()\n            .scaleExtent([self.MIN_SCALE, self.MAX_SCALE]);\n        self.zoomFunc.translate(self.phyloTree.get(\"translate\"));\n        self.zoomFunc.scale(self.phyloTree.get(\"scaleFactor\"));\n\n        // -- set up header buttons, search and settings menu\n        self.navMenu = new HeaderButtons(self);\n        self.settingsMenu = new SettingsMenu({\n            phyloTree: self.phyloTree\n        });\n        self.nodeSelectionView = new NodeSelectionView({\n            phyloTree: self.phyloTree\n        });\n        self.search = new PhyloVizSearch();\n\n        // using settimeout to call the zoomAndPan function according to the stored attributes in viz_config\n        setTimeout(() => {\n            self.zoomAndPan();\n        }, 1000);\n    },\n\n    render: function() {\n        // -- Creating helper function for vis. --\n        var self = this;\n        $(\"#PhyloViz\").empty();\n\n        // -- Layout viz. --\n        self.mainSVG = d3\n            .select(\"#PhyloViz\")\n            .append(\"svg:svg\")\n            .attr(\"width\", self.width)\n            .attr(\"height\", self.height)\n            .attr(\"pointer-events\", \"all\")\n            .call(\n                self.zoomFunc.on(\"zoom\", () => {\n                    self.zoomAndPan();\n                })\n            );\n\n        self.boundingRect = self.mainSVG\n            .append(\"svg:rect\")\n            .attr(\"class\", \"boundingRect\")\n            .attr(\"width\", self.width)\n            .attr(\"height\", self.height)\n            .attr(\"stroke\", \"black\")\n            .attr(\"fill\", \"white\");\n\n        self.vis = self.mainSVG.append(\"svg:g\").attr(\"class\", \"vis\");\n\n        self.layoutOptions = {\n            model: self.phyloTree,\n            width: self.width,\n            height: self.height,\n            vis: self.vis,\n            margins: self.margins\n        };\n\n        // -- Creating Title\n        $(\"#title\").text(\n            `Phylogenetic Tree from ${self.phyloTree.get(\"title\")}:`\n        );\n\n        // -- Create Linear view instance --\n        var linearView = new PhylovizLinearView(self.layoutOptions);\n    },\n\n    /**\n     * Function to zoom and pan the svg element which the entire tree is contained within\n     * Uses d3.zoom events, and extend them to allow manual updates and keeping states in model\n     */\n    zoomAndPan: function(event) {\n        var zoomParams;\n        var translateParams;\n        if (typeof event !== \"undefined\") {\n            zoomParams = event.zoom;\n            translateParams = event.translate;\n        }\n\n        var self = this;\n        var scaleFactor = self.zoomFunc.scale();\n        var translationCoor = self.zoomFunc.translate();\n        var zoomStatement = \"\";\n        var translateStatement = \"\";\n\n        // Do manual scaling.\n        switch (zoomParams) {\n            case \"reset\":\n                scaleFactor = 1.0;\n                translationCoor = [0, 0];\n                break;\n            case \"+\":\n                scaleFactor *= 1.1;\n                break;\n            case \"-\":\n                scaleFactor *= 0.9;\n                break;\n            default:\n                if (typeof zoomParams === \"number\") {\n                    scaleFactor = zoomParams;\n                } else if (d3.event !== null) {\n                    scaleFactor = d3.event.scale;\n                }\n        }\n        if (scaleFactor < self.MIN_SCALE || scaleFactor > self.MAX_SCALE) {\n            return;\n        }\n        self.zoomFunc.scale(scaleFactor); //update scale Factor\n        zoomStatement = `translate(${self.margins[3]},${self\n            .margins[0]}) scale(${scaleFactor})`;\n\n        // Do manual translation.\n        if (d3.event !== null) {\n            translateStatement = `translate(${d3.event.translate})`;\n        } else {\n            if (typeof translateParams !== \"undefined\") {\n                var x = translateParams.split(\",\")[0];\n                var y = translateParams.split(\",\")[1];\n                if (!isNaN(x) && !isNaN(y)) {\n                    translationCoor = [\n                        translationCoor[0] + parseFloat(x),\n                        translationCoor[1] + parseFloat(y)\n                    ];\n                }\n            }\n            self.zoomFunc.translate(translationCoor); // update zoomFunc\n            translateStatement = `translate(${translationCoor})`;\n        }\n\n        self.phyloTree.set(\"scaleFactor\", scaleFactor);\n        self.phyloTree.set(\"translate\", translationCoor);\n        //refers to the view that we are actually zooming\n        self.vis.attr(\"transform\", translateStatement + zoomStatement);\n    },\n\n    /**\n     * Primes the Ajax URL to load another Nexus tree\n     */\n    reloadViz: function() {\n        var self = this;\n        var treeIndex = $(\"#phylovizNexSelector :selected\").val();\n        $.getJSON(\n            self.phyloTree.get(\"dataset\").url(),\n            {\n                tree_index: treeIndex,\n                data_type: \"raw_data\"\n            },\n            packedJson => {\n                self.data = packedJson.data;\n                self.config = packedJson;\n                self.render();\n            }\n        );\n    }\n});\n\nvar HeaderButtons = Backbone.View.extend({\n    initialize: function(phylovizView) {\n        var self = this;\n        self.phylovizView = phylovizView;\n\n        // Clean up code - if the class initialized more than once\n        $(\"#panelHeaderRightBtns\").empty();\n        $(\"#phyloVizNavBtns\").empty();\n        $(\"#phylovizNexSelector\").off();\n\n        self.initNavBtns();\n        self.initRightHeaderBtns();\n\n        // Initial a tree selector in the case of nexus\n        $(\"#phylovizNexSelector\")\n            .off()\n            .on(\"change\", () => {\n                self.phylovizView.reloadViz();\n            });\n    },\n\n    initRightHeaderBtns: function() {\n        var self = this;\n\n        var rightMenu = mod_icon_btn.create_icon_buttons_menu(\n            [\n                {\n                    icon_class: \"gear\",\n                    title: \"PhyloViz Settings\",\n                    on_click: function() {\n                        $(\"#SettingsMenu\").show();\n                        self.settingsMenu.updateUI();\n                    }\n                },\n                {\n                    icon_class: \"disk\",\n                    title: \"Save visualization\",\n                    on_click: function() {\n                        var nexSelected = $(\n                            \"#phylovizNexSelector option:selected\"\n                        ).text();\n                        if (nexSelected) {\n                            self.phylovizView.phyloTree.set(\n                                \"title\",\n                                nexSelected\n                            );\n                        }\n                        self.phylovizView.phyloTree.save();\n                    }\n                },\n                {\n                    icon_class: \"chevron-expand\",\n                    title: \"Search / Edit Nodes\",\n                    on_click: function() {\n                        $(\"#nodeSelectionView\").show();\n                    }\n                },\n                {\n                    icon_class: \"information\",\n                    title: \"Phyloviz Help\",\n                    on_click: function() {\n                        window.open(\n                            \"https://galaxyproject.org/learn/visualization/phylogenetic-tree/\"\n                        );\n                        // https://docs.google.com/document/d/1AXFoJgEpxr21H3LICRs3EyMe1B1X_KFPouzIgrCz3zk/edit\n                    }\n                }\n            ],\n            {\n                tooltip_config: { placement: \"bottom\" }\n            }\n        );\n        $(\"#panelHeaderRightBtns\").append(rightMenu.$el);\n    },\n\n    initNavBtns: function() {\n        var self = this;\n\n        var navMenu = mod_icon_btn.create_icon_buttons_menu(\n            [\n                {\n                    icon_class: \"zoom-in\",\n                    title: \"Zoom in\",\n                    on_click: function() {\n                        self.phylovizView.zoomAndPan({ zoom: \"+\" });\n                    }\n                },\n                {\n                    icon_class: \"zoom-out\",\n                    title: \"Zoom out\",\n                    on_click: function() {\n                        self.phylovizView.zoomAndPan({ zoom: \"-\" });\n                    }\n                },\n                {\n                    icon_class: \"arrow-circle\",\n                    title: \"Reset Zoom/Pan\",\n                    on_click: function() {\n                        self.phylovizView.zoomAndPan({\n                            zoom: \"reset\"\n                        });\n                    }\n                }\n            ],\n            {\n                tooltip_config: { placement: \"bottom\" }\n            }\n        );\n\n        $(\"#phyloVizNavBtns\").append(navMenu.$el);\n    }\n});\n\nvar SettingsMenu = UserMenuBase.extend({\n    className: \"Settings\",\n\n    initialize: function(options) {\n        // settings needs to directly interact with the phyloviz model so it will get access to it.\n        var self = this;\n        self.phyloTree = options.phyloTree;\n        self.el = $(\"#SettingsMenu\");\n        self.inputs = {\n            separation: $(\"#phyloVizTreeSeparation\"),\n            leafHeight: $(\"#phyloVizTreeLeafHeight\"),\n            fontSize: $(\"#phyloVizTreeFontSize\")\n        };\n\n        //init all buttons of settings\n        $(\"#settingsCloseBtn\")\n            .off()\n            .on(\"click\", () => {\n                self.el.hide();\n            });\n        $(\"#phylovizResetSettingsBtn\")\n            .off()\n            .on(\"click\", () => {\n                self.resetToDefaults();\n            });\n        $(\"#phylovizApplySettingsBtn\")\n            .off()\n            .on(\"click\", () => {\n                self.apply();\n            });\n    },\n\n    /**\n     * Applying user values to phylotree model.\n     */\n    apply: function() {\n        var self = this;\n        if (\n            !self.isAcceptableValue(self.inputs.separation, 50, 2500) ||\n            !self.isAcceptableValue(self.inputs.leafHeight, 5, 30) ||\n            !self.isAcceptableValue(self.inputs.fontSize, 5, 20)\n        ) {\n            return;\n        }\n        $.each(self.inputs, (key, $input) => {\n            self.phyloTree.set(key, $input.val());\n        });\n    },\n    /**\n     * Called to update the values input to that stored in the model\n     */\n    updateUI: function() {\n        var self = this;\n        $.each(self.inputs, (key, $input) => {\n            $input.val(self.phyloTree.get(key));\n        });\n    },\n    /**\n     * Resets the value of the phyloTree model to its default\n     */\n    resetToDefaults: function() {\n        $(\".tooltip\").remove(); // just in case the tool tip was not removed\n        var self = this;\n        $.each(self.phyloTree.defaults, (key, value) => {\n            self.phyloTree.set(key, value);\n        });\n        self.updateUI();\n    },\n\n    render: function() {}\n});\n\n/**\n * View for inspecting node properties and editing them\n */\nvar NodeSelectionView = UserMenuBase.extend({\n    className: \"Settings\",\n\n    initialize: function(options) {\n        var self = this;\n        self.el = $(\"#nodeSelectionView\");\n        self.phyloTree = options.phyloTree;\n\n        self.UI = {\n            enableEdit: $(\"#phylovizEditNodesCheck\"),\n            saveChanges: $(\"#phylovizNodeSaveChanges\"),\n            cancelChanges: $(\"#phylovizNodeCancelChanges\"),\n            name: $(\"#phyloVizSelectedNodeName\"),\n            dist: $(\"#phyloVizSelectedNodeDist\"),\n            annotation: $(\"#phyloVizSelectedNodeAnnotation\")\n        };\n\n        // temporarily stores the values in case user change their mind\n        self.valuesOfConcern = {\n            name: null,\n            dist: null,\n            annotation: null\n        };\n\n        //init UI buttons\n        $(\"#nodeSelCloseBtn\")\n            .off()\n            .on(\"click\", () => {\n                self.el.hide();\n            });\n        self.UI.saveChanges.off().on(\"click\", () => {\n            self.updateNodes();\n        });\n        self.UI.cancelChanges.off().on(\"click\", () => {\n            self.cancelChanges();\n        });\n\n        ($ => {\n            // extending jquery fxn for enabling and disabling nodes.\n            $.fn.enable = function(isEnabled) {\n                return $(this).each(function() {\n                    if (isEnabled) {\n                        $(this).removeAttr(\"disabled\");\n                    } else {\n                        $(this).attr(\"disabled\", \"disabled\");\n                    }\n                });\n            };\n        })(jQuery);\n\n        self.UI.enableEdit.off().on(\"click\", () => {\n            self.toggleUI();\n        });\n    },\n\n    /**\n     * For turning on and off the child elements\n     */\n    toggleUI: function() {\n        var self = this;\n        var checked = self.UI.enableEdit.is(\":checked\");\n\n        if (!checked) {\n            self.cancelChanges();\n        }\n\n        $.each(self.valuesOfConcern, (key, value) => {\n            self.UI[key].enable(checked);\n        });\n        if (checked) {\n            self.UI.saveChanges.show();\n            self.UI.cancelChanges.show();\n        } else {\n            self.UI.saveChanges.hide();\n            self.UI.cancelChanges.hide();\n        }\n    },\n\n    /**\n     * Reverting to previous values in case user change their minds\n     */\n    cancelChanges: function() {\n        var self = this;\n        var node = self.phyloTree.get(\"selectedNode\");\n        if (node) {\n            $.each(self.valuesOfConcern, (key, value) => {\n                self.UI[key].val(node[key]);\n            });\n        }\n    },\n\n    /**\n     * Changing the data in the underlying tree with user-specified values\n     */\n    updateNodes: function() {\n        var self = this;\n        var node = self.phyloTree.get(\"selectedNode\");\n        if (node) {\n            if (\n                !self.isAcceptableValue(self.UI.dist, 0, 1) ||\n                self.hasIllegalJsonCharacters(self.UI.name) ||\n                self.hasIllegalJsonCharacters(self.UI.annotation)\n            ) {\n                return;\n            }\n            $.each(self.valuesOfConcern, (key, value) => {\n                node[key] = self.UI[key].val();\n            });\n            self.phyloTree.set(\"nodeAttrChangedTime\", new Date());\n        } else {\n            alert(\"No node selected\");\n        }\n    }\n});\n\n/**\n * Initializes the search panel on phyloviz and handles its user interaction\n * It allows user to search the entire free based on some qualifer, like dist <= val.\n */\nvar PhyloVizSearch = UserMenuBase.extend({\n    initialize: function() {\n        var self = this;\n\n        $(\"#phyloVizSearchBtn\").on(\"click\", () => {\n            var searchTerm = $(\"#phyloVizSearchTerm\");\n\n            var searchConditionVal = $(\"#phyloVizSearchCondition\")\n                .val()\n                .split(\"-\");\n\n            var attr = searchConditionVal[0];\n            var condition = searchConditionVal[1];\n            self.hasIllegalJsonCharacters(searchTerm);\n\n            if (attr === \"dist\") {\n                self.isAcceptableValue(searchTerm, 0, 1);\n            }\n            self.searchTree(attr, condition, searchTerm.val());\n        });\n    },\n\n    /**\n     * Searches the entire tree and will highlight the nodes that match the condition in green\n     */\n    searchTree: function(attr, condition, val) {\n        d3.selectAll(\"g.node\").classed(\"searchHighlight\", d => {\n            var attrVal = d[attr];\n            if (typeof attrVal !== \"undefined\" && attrVal !== null) {\n                if (attr === \"dist\") {\n                    switch (condition) {\n                        case \"greaterEqual\":\n                            return attrVal >= +val;\n                        case \"lesserEqual\":\n                            return attrVal <= +val;\n                        default:\n                            return;\n                    }\n                } else if (attr === \"name\" || attr === \"annotation\") {\n                    return (\n                        attrVal.toLowerCase().indexOf(val.toLowerCase()) !== -1\n                    );\n                }\n            }\n        });\n    }\n});\n\nexport default {\n    PhylovizView: PhylovizView\n};\n"]}