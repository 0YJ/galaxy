{"version":3,"sources":["viz/trackster/util.js"],"names":["define","is_deferred","ServerStateDeferred","number","rgx","commatize","replace","get_random_color","d","Backbone","Model","extend","defaults","ajax_settings","result","go","deferred","$","Deferred","self","this","get","success_fn","interval","_go","success","resolve","colors","i","length","parseInt","slice","new_color","nr","ng","nb","other_color","or","og","ob","n_brightness","o_brightness","diff","brightness","r","g","b","ok","num_tries","Math","random","difference","r1","g1","b1","r2","g2","b2","max","min","abs","toString","substr"],"mappings":"kCAAAA,OAAO,WA+ICC,OACAC,UA/IJ,SAAAC,GAIIA,GAAU,GADd,IAEI,IAAIC,EAAM,eAFdA,EAASC,KAAAA,IACLF,EAAAA,EAAcG,QAAAF,EAAA,SAEd,OAAAD,GA0IAI,YApIJ,SAAAC,GAII,MAAO,YAAaA,GA4HjBN,oBArHmBO,SAASC,MAAMC,QACrCC,UACIC,iBAFJX,SAAAA,IACAU,WAAU,SAAAE,GACND,OAAAA,IAOJE,GAAA,WAII,IAAIC,EAAWC,EAAEC,WACbC,EAAOC,KAFXP,EAAWM,EAAAE,IAAA,iBACXC,EAAIN,EAAaE,IAAAA,cAAjBK,EACWJ,EADXE,IAAA,YAcS,OAZLR,SAFJW,IAGIF,EAAAA,KAAAA,GAAsBG,QAAA,SAH1BX,GAIIS,EAAWT,GAEAD,EAAAA,QAAeY,GAGdT,WAASU,EAATH,KAIHC,GACJR,KAnDrBT,iBA+D2B,SAASoB,GAEvBA,IAFLpB,EAAAA,WAIC,iBAAAoB,IAIGA,GAAUA,IACb,IAAA,IAAAC,EAAA,EAAAA,EAAAD,EAAAE,OAAAD,IAIGD,EAAOC,GAAKE,SAASH,EAAOC,GAAGG,MAAM,GAAI,IAI7C,IAkBAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAlBAC,EAAA,SAAAC,EAAAC,EAAAC,GAII,OAAY,IAAJF,EAAc,IAAJC,EAAc,IAAJC,GAAW,KA2B3CC,GAAG,EACCC,EAAA,EACAhB,EAAAA,CAQIK,IAFJG,EAAAG,EAHAR,GAAKH,UADLE,EAAMF,KAAAA,MAAN,SAAkBiB,KAAAC,aAClB,GACAV,GAAAA,MAAAA,IAA0BP,EAC1Bc,EAAA,IAAAA,GAEIX,GAAAA,EACAC,EAAAA,EAAAA,EAAMD,EAAAA,OAAcR,IAShB,GARJU,EAAMF,EAAAA,GACNG,GAAKH,SAALG,IAAA,GACAE,GAAeE,MAAfF,IAAe,EACfC,EAAOS,IAAPT,EACAD,EAAAE,EAAAN,EAAAC,EAAAC,GACAG,EA5CR,SAAAU,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,GAMI,OAFJR,KAAAS,IAAAN,EAAAG,GACIJ,KAAAA,IAAAA,EAAaI,IACbN,KAAAS,IACIT,EAAKS,GAAQH,KAAbI,IACAV,EAAKU,KAHbV,KAAAS,IAAAJ,EAAAG,GAAAR,KAAAU,IAAAL,EAAAG,IAuCQN,CAAAlB,EAAAC,EAAAC,EAAAE,EAAAC,EAAAC,GAGIU,KAAAW,IAAApB,EAAAC,GAAA,IAAAC,EAAA,IAAA,CACHK,GAAA,EACJ,MAEDC,WAGJD,GAAAC,GAAA,IACA,MAAO,KAAO,SAAYhB,GAAW6B,SAAS,IAAIC,OAAO,EAAG","file":"../../../scripts/viz/trackster/util.js","sourcesContent":["define(function() {\n    /**\n * Stringifies a number adding commas for digit grouping as per North America.\n */\n    function commatize(number) {\n        number += \"\"; // Convert to string\n        var rgx = /(\\d+)(\\d{3})/;\n        while (rgx.test(number)) {\n            number = number.replace(rgx, \"$1\" + \",\" + \"$2\");\n        }\n        return number;\n    }\n\n    /**\n * Helper to determine if object is jQuery deferred.\n */\n    var is_deferred = function(d) {\n        return \"promise\" in d;\n    };\n\n    /**\n * Implementation of a server-state based deferred. Server is repeatedly polled, and when\n * condition is met, deferred is resolved.\n */\n    var ServerStateDeferred = Backbone.Model.extend({\n        defaults: {\n            ajax_settings: {},\n            interval: 1000,\n            success_fn: function(result) {\n                return true;\n            }\n        },\n\n        /**\n     * Returns a deferred that resolves when success function returns true.\n     */\n        go: function() {\n            var deferred = $.Deferred(),\n                self = this,\n                ajax_settings = self.get(\"ajax_settings\"),\n                success_fn = self.get(\"success_fn\"),\n                interval = self.get(\"interval\"),\n                _go = function() {\n                    $.ajax(ajax_settings).success(function(result) {\n                        if (success_fn(result)) {\n                            // Result is good, so resolve.\n                            deferred.resolve(result);\n                        } else {\n                            // Result not good, try again.\n                            setTimeout(_go, interval);\n                        }\n                    });\n                };\n            _go();\n            return deferred;\n        }\n    });\n\n    /**\n * Returns a random color in hexadecimal format that is sufficiently different from a single color\n * or set of colors.\n * @param colors a color or list of colors in the format '#RRGGBB'\n */\n    var get_random_color = function(colors) {\n        // Default for colors is white.\n        if (!colors) {\n            colors = \"#ffffff\";\n        }\n\n        // If needed, create list of colors.\n        if (typeof colors === \"string\") {\n            colors = [colors];\n        }\n\n        // Convert colors to numbers.\n        for (var i = 0; i < colors.length; i++) {\n            colors[i] = parseInt(colors[i].slice(1), 16);\n        }\n\n        // -- Perceived brightness and difference formulas are from\n        // -- http://www.w3.org/WAI/ER/WD-AERT/#color-contrast\n\n        // Compute perceived color brightness (based on RGB-YIQ transformation):\n        var brightness = function(r, g, b) {\n            return (r * 299 + g * 587 + b * 114) / 1000;\n        };\n\n        // Compute color difference:\n        var difference = function(r1, g1, b1, r2, g2, b2) {\n            return (\n                Math.max(r1, r2) -\n                Math.min(r1, r2) +\n                (Math.max(g1, g2) - Math.min(g1, g2)) +\n                (Math.max(b1, b2) - Math.min(b1, b2))\n            );\n        };\n\n        // Create new random color.\n        var new_color,\n            nr,\n            ng,\n            nb,\n            other_color,\n            or,\n            og,\n            ob,\n            n_brightness,\n            o_brightness,\n            diff,\n            ok = false,\n            num_tries = 0;\n        do {\n            // New color is never white b/c random in [0,1)\n            new_color = Math.round(Math.random() * 0xffffff);\n            nr = (new_color & 0xff0000) >> 16;\n            ng = (new_color & 0x00ff00) >> 8;\n            nb = new_color & 0x0000ff;\n            n_brightness = brightness(nr, ng, nb);\n            ok = true;\n            for (i = 0; i < colors.length; i++) {\n                other_color = colors[i];\n                or = (other_color & 0xff0000) >> 16;\n                og = (other_color & 0x00ff00) >> 8;\n                ob = other_color & 0x0000ff;\n                o_brightness = brightness(or, og, ob);\n                diff = difference(nr, ng, nb, or, og, ob);\n                // These thresholds may need to be adjusted. Brightness difference range is 125;\n                // color difference range is 500.\n                if (Math.abs(n_brightness - o_brightness) < 40 || diff < 200) {\n                    ok = false;\n                    break;\n                }\n            }\n\n            num_tries++;\n        } while (!ok && num_tries <= 10);\n\n        // Add 0x1000000 to left pad number with 0s.\n        return \"#\" + (0x1000000 + new_color).toString(16).substr(1, 6);\n    };\n\n    return {\n        commatize: commatize,\n        is_deferred: is_deferred,\n        ServerStateDeferred: ServerStateDeferred,\n        get_random_color: get_random_color\n    };\n});\n"]}