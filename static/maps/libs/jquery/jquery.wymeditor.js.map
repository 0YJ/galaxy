{"version":3,"sources":["libs/jquery/jquery.wymeditor.js"],"names":["WYMeditor","window","console","firebug","names","i","length","jQuery","extend","VERSION","INSTANCES","STRINGS","SKINS","NAME","INDEX","WYM_INDEX","BASE_PATH","CSS_PATH","WYM_PATH","SKINS_DEFAULT_PATH","SKINS_DEFAULT_CSS","SKINS_DEFAULT_JS","LANG_DEFAULT_PATH","IFRAME_BASE_PATH","IFRAME_DEFAULT","JQUERY_PATH","DIRECTION","LOGO","TOOLS","TOOLS_ITEMS","TOOL_NAME","TOOL_TITLE","TOOL_CLASS","CLASSES","CLASSES_ITEMS","CLASS_NAME","CLASS_TITLE","CONTAINERS","CONTAINERS_ITEMS","CONTAINER_NAME","CONTAINER_TITLE","CONTAINER_CLASS","HTML","IFRAME","STATUS","DIALOG_TITLE","DIALOG_BODY","STRING","BODY","DIV","P","H1","H2","H3","H4","H5","H6","PRE","BLOCKQUOTE","A","BR","IMG","TABLE","TD","TH","UL","OL","LI","CLASS","HREF","SRC","TITLE","ALT","DIALOG_LINK","DIALOG_IMAGE","DIALOG_TABLE","DIALOG_PASTE","BOLD","ITALIC","CREATE_LINK","INSERT_IMAGE","INSERT_TABLE","INSERT_HTML","PASTE","INDENT","OUTDENT","TOGGLE_HTML","FORMAT_BLOCK","PREVIEW","UNLINK","INSERT_UNORDEREDLIST","INSERT_ORDEREDLIST","MAIN_CONTAINERS","Array","BLOCKS","KEY","BACKSPACE","ENTER","END","HOME","LEFT","UP","RIGHT","DOWN","CURSOR","DELETE","NODE","ELEMENT","ATTRIBUTE","TEXT","editor","elem","options","this","_index","push","_element","_options","_html","val","html","basePath","computeBasePath","skinPath","skin","wymPath","computeWymPath","langPath","iframeBasePath","jQueryPath","computeJqueryPath","init","fn","wymeditor","styles","stylesheet","initSkin","loadSkin","lang","direction","boxHtml","logoHtml","iframeHtml","editorStyles","toolsHtml","toolsItemHtml","toolsItems","name","title","css","containersHtml","containersItemHtml","containersItems","classesHtml","classesItemHtml","classesItems","statusHtml","htmlHtml","boxSelector","toolsSelector","toolsListSelector","containersSelector","classesSelector","htmlSelector","iframeSelector","iframeBodySelector","statusSelector","toolSelector","containerSelector","classSelector","htmlValSelector","hrefSelector","srcSelector","titleSelector","altSelector","textSelector","rowsSelector","colsSelector","captionSelector","summarySelector","submitSelector","cancelSelector","previewSelector","dialogTypeSelector","dialogLinkSelector","dialogImageSelector","dialogTableSelector","dialogPasteSelector","dialogPreviewSelector","updateSelector","updateEvent","dialogFeatures","dialogFeaturesPreview","dialogHtml","dialogLinkHtml","dialogImageHtml","dialogTableHtml","dialogPasteHtml","dialogPreviewHtml","dialogStyles","stringDelimiterLeft","stringDelimiterRight","preInit","preBind","postInit","preInitDialog","postInitDialog","each","wymeditors","prototype","browser","msie","WymClass","WymClassExplorer","mozilla","WymClassMozilla","opera","WymClassOpera","safari","chrome","WymClassSafari","isFunction","SaxListener","XhtmlSaxListener","parser","XhtmlParser","configureEditorUsingRawCss","helper","XmlHelper","prop","_box","hide","after","next","addClass","data","get","h","Helper","replaceAll","aTools","eval","sTools","oTool","sTool","aClasses","sClasses","oClass","sClass","aContainers","sContainers","oContainer","sContainer","replaceStrings","find","bindEvents","wym","click","_iframe","contentWindow","focus","exec","attr","container","keyup","_doc","body","toggleClass","blur","sName","findByName","jqexpr","expr","bind","update","ready","box","xhtml","parse","cmd","_selected_image","dialog","toggleHtml","is","listen","_exec","sType","selected","toLowerCase","tagName","aTypes","findUp","switchTo","newNode","blockquote","createElement","parentNode","insertBefore","appendChild","setFocusToNode","firstChild","nodes","childNodes","lgt","firstNode","item","x","removeChild","parentsOrSelf","removeAttr","_class","node","filter","tagname","bFound","replaceChild","sVal","ajax","url","async","responseText","e","error","key","encloseString","status","sMessage","not","dialogType","bodyHtml","features","_wym","wDialog","open","sBodyHtml","doc","document","write","close","toggle","uniqueStamp","Date","getTime","paste","sData","sTmp","aP","split","_newLine","rExp","RegExp","replace","append","insert","getSelection","focusNode","wrap","left","right","toString","unwrap","addCssRules","aCss","styleSheets","oCss","addCssRule","grep","s","src","match","computeCssPath","href","CssParser","WymCssParser","css_settings","mousedown","images","getElementsByTagName","evt","ownerDocument","stopPropagation","loadCss","link","rel","found","INIT_DIALOG","index","opener","sStamp","sUrl","iRows","iCols","table","newRow","sCaption","newCaption","createCaption","innerHTML","insertRow","y","insertCell","sText","_entitiesDiv","tag","tagOptions","contentTag","content","cdataSection","escapeOnce","xml","_fixDoubleEscape","escapeEntities","escaped","_formated_options","value","parseInt","shift","pop","string","escape_quotes","textContent","result","parseAttributes","tag_attributes","matches","k","v","re","delimiter","charAt","XhtmlValidator","_attributes","core","except","attributes","language","dir","0","1","keyboard","accesskey","tabindex","_events","only","form","mouse","_tags","a","2","3","4","rev","shape","5","area","nohref","required","base","bdo","6","button","disabled","type","inside","7","8","9","col","align","span","valign","colgroup","10","del","datetime","11","12","13","14","15","fieldset","method","head","16","17","18","19","20","21","22","23","img","input","checked","maxlength","readonly","size","ins","24","label","25","26","media","map","meta","http-equiv","27","object","28","optgroup","option","29","param","valuetype","30","q","31","script","defer","select","multiple","32","33","34","style","35","36","frame","rules","tbody","td","colspan","rowspan","scope","textarea","tfoot","th","thead","37","tr","38","39","40","skiped_attributes","skiped_attribute_values","getValidTagAttributes","valid_attributes","possible_attributes","getPossibleTagAttributes","attribute","contains","doesAttributeNeedsValidation","validateAttribute","getUniqueAttributesAndEventsForTag","getDefaultAttributesAndEventsForTags","isValidTag","getDefaultAttributesAndEventsForTag","default_attributes","default_attributes_and_events","defaults","tag_defaults","_possible_tag_attributes","concat","ParallelRegex","case_sensitive","_case","_patterns","_labels","_regex","addPattern","pattern","count","subject","_getCompoundedRegex","_untokenizeRegex","_tokenizeRegex","join","_getPerlMatchingFlags","regex","StateStack","start","_stack","getCurrent","enter","state","leave","LEXER_ENTER","LEXER_MATCHED","LEXER_UNMATCHED","LEXER_EXIT","LEXER_SPECIAL","Lexer","_regexes","_parser","_mode","_mode_handlers","mode","addEntryPattern","new_mode","addExitPattern","addSpecialPattern","special","mapHandler","handler","raw","parsed","_reduce","unmatched","matched","_dispatchTokens","_invokeParser","_isModeEnd","_isSpecialMode","_decodeSpecial","substring","is_match","test","current","action","unparsed_character_count","indexOf","unparsed","substr","XhtmlLexer","addTokens","addCommentTokens","addScriptTokens","addCssTokens","addTagTokens","addInTagDeclarationTokens","addAttributeTokens","Listener","_Lexer","_Listener","_matches","_last_match","_current_match","beforeParsing","afterParsing","getResult","avoidStylingTagsAndAttributes","_avoiding_tags_implicitly","allowStylingTagsAndAttributes","Ignore","Text","text","addContent","Comment","_addNonTagBlock","Script","Css","_non_tag","addComment","addScript","addCss","OpeningTag","_tag","normalizeTag","_tag_attributes","_callOpenTagListener","ClosingTag","_callCloseTagListener","autoCloseUnclosedBeforeNewOpening","isBlockTag","_tag_stack","fixNestingBeforeOpeningBlockTag","openBlockTag","_increaseOpenTagCounter","isInlineTag","inlineTag","openUnknownTag","last_tag","last_tag_opened","last_tag_attributes","_decreaseOpenTagCounter","autoCloseUnclosedBeforeTagClosing","expected_tag","closeBlockTag","closeUnknownTag","closeUnopenedTag","_open_tags","undefined","new_tag","_autoCloseUnclosed","closing","counter","shouldCloseTagAutomatically","getTagReplacements","tags","TagAttributes","_current_attribute","DoubleQuotedAttribute","SingleQuotedAttribute","UnquotedAttribute","output","validator","avoided_tags","entities","&nbsp;","&iexcl;","&cent;","&pound;","&curren;","&yen;","&brvbar;","&sect;","&uml;","&copy;","&ordf;","&laquo;","&not;","&shy;","&reg;","&macr;","&deg;","&plusmn;","&sup2;","&sup3;","&acute;","&micro;","&para;","&middot;","&cedil;","&sup1;","&ordm;","&raquo;","&frac14;","&frac12;","&frac34;","&iquest;","&Agrave;","&Aacute;","&Acirc;","&Atilde;","&Auml;","&Aring;","&AElig;","&Ccedil;","&Egrave;","&Eacute;","&Ecirc;","&Euml;","&Igrave;","&Iacute;","&Icirc;","&Iuml;","&ETH;","&Ntilde;","&Ograve;","&Oacute;","&Ocirc;","&Otilde;","&Ouml;","&times;","&Oslash;","&Ugrave;","&Uacute;","&Ucirc;","&Uuml;","&Yacute;","&THORN;","&szlig;","&agrave;","&aacute;","&acirc;","&atilde;","&auml;","&aring;","&aelig;","&ccedil;","&egrave;","&eacute;","&ecirc;","&euml;","&igrave;","&iacute;","&icirc;","&iuml;","&eth;","&ntilde;","&ograve;","&oacute;","&ocirc;","&otilde;","&ouml;","&divide;","&oslash;","&ugrave;","&uacute;","&ucirc;","&uuml;","&yacute;","&thorn;","&yuml;","&OElig;","&oelig;","&Scaron;","&scaron;","&Yuml;","&fnof;","&circ;","&tilde;","&Alpha;","&Beta;","&Gamma;","&Delta;","&Epsilon;","&Zeta;","&Eta;","&Theta;","&Iota;","&Kappa;","&Lambda;","&Mu;","&Nu;","&Xi;","&Omicron;","&Pi;","&Rho;","&Sigma;","&Tau;","&Upsilon;","&Phi;","&Chi;","&Psi;","&Omega;","&alpha;","&beta;","&gamma;","&delta;","&epsilon;","&zeta;","&eta;","&theta;","&iota;","&kappa;","&lambda;","&mu;","&nu;","&xi;","&omicron;","&pi;","&rho;","&sigmaf;","&sigma;","&tau;","&upsilon;","&phi;","&chi;","&psi;","&omega;","&thetasym;","&upsih;","&piv;","&ensp;","&emsp;","&thinsp;","&zwnj;","&zwj;","&lrm;","&rlm;","&ndash;","&mdash;","&lsquo;","&rsquo;","&sbquo;","&ldquo;","&rdquo;","&bdquo;","&dagger;","&Dagger;","&bull;","&hellip;","&permil;","&prime;","&Prime;","&lsaquo;","&rsaquo;","&oline;","&frasl;","&euro;","&image;","&weierp;","&real;","&trade;","&alefsym;","&larr;","&uarr;","&rarr;","&darr;","&harr;","&crarr;","&lArr;","&uArr;","&rArr;","&dArr;","&hArr;","&forall;","&part;","&exist;","&empty;","&nabla;","&isin;","&notin;","&ni;","&prod;","&sum;","&minus;","&lowast;","&radic;","&prop;","&infin;","&ang;","&and;","&or;","&cap;","&cup;","&int;","&there4;","&sim;","&cong;","&asymp;","&ne;","&equiv;","&le;","&ge;","&sub;","&sup;","&nsub;","&sube;","&supe;","&oplus;","&otimes;","&perp;","&sdot;","&lceil;","&rceil;","&lfloor;","&rfloor;","&lang;","&rang;","&loz;","&spades;","&clubs;","&hearts;","&diams;","block_tags","inline_tags","now_on_tag","replaceNamedEntities","joinRepeatedEntities","removeEmptyTags","removeBrInPre","entity","String","fromCharCode","b","remove_comments","remove_scripts","remove_embeded_styles","_getClosingTagContent","insertContentAfterClosingTag","_insertContentWhenClosingTag","insertContentBeforeClosingTag","position","WymCssLexer","only_wym_blocks","_in_style","_has_title","WymCssComment","_current_item","_current_element","expressions","trim","WymCssStyle","addStyleSetting","WymCssFeedbackStyle","feedback_style","WymCssStyleDeclaration","parts","toUpperCase","style_details","details","isPhantomNode","nodeType","n","isPhantomString","str","parents","slice","old","rep","insertAt","inserted","pos","arr","ret","initIframe","iframe","onfocus","designMode","onbeforedeactivate","saveCaret","onkeyup","onclick","onbeforepaste","event","returnValue","onpaste","clipboardData","getData","_initialized","ancestor","execCommand","caretPos","parentElement","selection","createRange","addRule","range","pasteHTML","moveToElementText","collapse","move","contentDocument","enableDesignMode","keydown","sel","anchorNode","nodeName","insertRule","cssRules","keyCode","$container","$","$embedded","parent","$newNode","hasClass","before","ctrlKey","shiftKey","preventDefault","metaKey","children","remove","selectNode","addRange","getTagForStyle","startNode","getRangeAt","startContainer","replaceWith"],"mappings":"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","file":"../../../scripts/libs/jquery/jquery.wymeditor.js","sourcesContent":["/**\n * @version 0.5-rc1\n *\n * WYMeditor : what you see is What You Mean web-based editor\n * Copyright (c) 2005 - 2009 Jean-Francois Hovinne, http://www.wymeditor.org/\n * Dual licensed under the MIT (MIT-license.txt)\n * and GPL (GPL-license.txt) licenses.\n *\n * For further information visit:\n *        http://www.wymeditor.org/\n *\n * File: jquery.wymeditor.js\n *\n *        Main JS file with core classes and functions.\n *        See the documentation for more info.\n *\n * About: authors\n *\n *        Jean-Francois Hovinne (jf.hovinne a-t wymeditor dotorg)\n *        Volker Mische (vmx a-t gmx dotde)\n *        Scott Lewis (lewiscot a-t gmail dotcom)\n *        Bermi Ferrer (wymeditor a-t bermi dotorg)\n *        Daniel Reszka (d.reszka a-t wymeditor dotorg)\n *        Jonatan Lundin (jonatan.lundin _at_ gmail.com)\n */\n\n/*\n   Namespace: WYMeditor\n   Global WYMeditor namespace.\n*/\nif(!WYMeditor) var WYMeditor = {};\n\n//Wrap the Firebug console in WYMeditor.console\n(function() {\n    if ( !window.console || !console.firebug ) {\n        var names = [\"log\", \"debug\", \"info\", \"warn\", \"error\", \"assert\", \"dir\", \"dirxml\",\n        \"group\", \"groupEnd\", \"time\", \"timeEnd\", \"count\", \"trace\", \"profile\", \"profileEnd\"];\n\n        WYMeditor.console = {};\n        for (var i = 0; i < names.length; ++i)\n            WYMeditor.console[names[i]] = function() {}\n\n    } else WYMeditor.console = window.console;\n})();\n\njQuery.extend(WYMeditor, {\n\n/*\n    Constants: Global WYMeditor constants.\n\n    VERSION             - Defines WYMeditor version.\n    INSTANCES           - An array of loaded WYMeditor.editor instances.\n    STRINGS             - An array of loaded WYMeditor language pairs/values.\n    SKINS               - An array of loaded WYMeditor skins.\n    NAME                - The \"name\" attribute.\n    INDEX               - A string replaced by the instance index.\n    WYM_INDEX           - A string used to get/set the instance index.\n    BASE_PATH           - A string replaced by WYMeditor's base path.\n    SKIN_PATH           - A string replaced by WYMeditor's skin path.\n    WYM_PATH            - A string replaced by WYMeditor's main JS file path.\n    SKINS_DEFAULT_PATH  - The skins default base path.\n    SKINS_DEFAULT_CSS   - The skins default CSS file.\n    LANG_DEFAULT_PATH   - The language files default path.\n    IFRAME_BASE_PATH    - A string replaced by the designmode iframe's base path.\n    IFRAME_DEFAULT      - The iframe's default base path.\n    JQUERY_PATH         - A string replaced by the computed jQuery path.\n    DIRECTION           - A string replaced by the text direction (rtl or ltr).\n    LOGO                - A string replaced by WYMeditor logo.\n    TOOLS               - A string replaced by the toolbar's HTML.\n    TOOLS_ITEMS         - A string replaced by the toolbar items.\n    TOOL_NAME           - A string replaced by a toolbar item's name.\n    TOOL_TITLE          - A string replaced by a toolbar item's title.\n    TOOL_CLASS          - A string replaced by a toolbar item's class.\n    CLASSES             - A string replaced by the classes panel's HTML.\n    CLASSES_ITEMS       - A string replaced by the classes items.\n    CLASS_NAME          - A string replaced by a class item's name.\n    CLASS_TITLE         - A string replaced by a class item's title.\n    CONTAINERS          - A string replaced by the containers panel's HTML.\n    CONTAINERS_ITEMS    - A string replaced by the containers items.\n    CONTAINER_NAME      - A string replaced by a container item's name.\n    CONTAINER_TITLE     - A string replaced by a container item's title.\n    CONTAINER_CLASS     - A string replaced by a container item's class.\n    HTML                - A string replaced by the HTML view panel's HTML.\n    IFRAME              - A string replaced by the designmode iframe.\n    STATUS              - A string replaced by the status panel's HTML.\n    DIALOG_TITLE        - A string replaced by a dialog's title.\n    DIALOG_BODY         - A string replaced by a dialog's HTML body.\n    BODY                - The BODY element.\n    STRING              - The \"string\" type.\n    BODY,DIV,P,\n    H1,H2,H3,H4,H5,H6,\n    PRE,BLOCKQUOTE,\n    A,BR,IMG,\n    TABLE,TD,TH,\n    UL,OL,LI            - HTML elements string representation.\n    CLASS,HREF,SRC,\n    TITLE,ALT           - HTML attributes string representation.\n    DIALOG_LINK         - A link dialog type.\n    DIALOG_IMAGE        - An image dialog type.\n    DIALOG_TABLE        - A table dialog type.\n    DIALOG_PASTE        - A 'Paste from Word' dialog type.\n    BOLD                - Command: (un)set selection to <strong>.\n    ITALIC              - Command: (un)set selection to <em>.\n    CREATE_LINK         - Command: open the link dialog or (un)set link.\n    INSERT_IMAGE        - Command: open the image dialog or insert an image.\n    INSERT_TABLE        - Command: open the table dialog.\n    PASTE               - Command: open the paste dialog.\n    INDENT              - Command: nest a list item.\n    OUTDENT             - Command: unnest a list item.\n    TOGGLE_HTML         - Command: display/hide the HTML view.\n    FORMAT_BLOCK        - Command: set a block element to another type.\n    PREVIEW             - Command: open the preview dialog.\n    UNLINK              - Command: unset a link.\n    INSERT_UNORDEREDLIST- Command: insert an unordered list.\n    INSERT_ORDEREDLIST  - Command: insert an ordered list.\n    MAIN_CONTAINERS     - An array of the main HTML containers used in WYMeditor.\n    BLOCKS              - An array of the HTML block elements.\n    KEY                 - Standard key codes.\n    NODE                - Node types.\n\n*/\n\n    VERSION             : \"0.5-rc1\",\n    INSTANCES           : [],\n    STRINGS             : [],\n    SKINS               : [],\n    NAME                : \"name\",\n    INDEX               : \"{Wym_Index}\",\n    WYM_INDEX           : \"wym_index\",\n    BASE_PATH           : \"{Wym_Base_Path}\",\n    CSS_PATH            : \"{Wym_Css_Path}\",\n    WYM_PATH            : \"{Wym_Wym_Path}\",\n    SKINS_DEFAULT_PATH  : \"skins/\",\n    SKINS_DEFAULT_CSS   : \"skin.css\",\n    SKINS_DEFAULT_JS    : \"skin.js\",\n    LANG_DEFAULT_PATH   : \"lang/\",\n    IFRAME_BASE_PATH    : \"{Wym_Iframe_Base_Path}\",\n    IFRAME_DEFAULT      : \"iframe/default/\",\n    JQUERY_PATH         : \"{Wym_Jquery_Path}\",\n    DIRECTION           : \"{Wym_Direction}\",\n    LOGO                : \"{Wym_Logo}\",\n    TOOLS               : \"{Wym_Tools}\",\n    TOOLS_ITEMS         : \"{Wym_Tools_Items}\",\n    TOOL_NAME           : \"{Wym_Tool_Name}\",\n    TOOL_TITLE          : \"{Wym_Tool_Title}\",\n    TOOL_CLASS          : \"{Wym_Tool_Class}\",\n    CLASSES             : \"{Wym_Classes}\",\n    CLASSES_ITEMS       : \"{Wym_Classes_Items}\",\n    CLASS_NAME          : \"{Wym_Class_Name}\",\n    CLASS_TITLE         : \"{Wym_Class_Title}\",\n    CONTAINERS          : \"{Wym_Containers}\",\n    CONTAINERS_ITEMS    : \"{Wym_Containers_Items}\",\n    CONTAINER_NAME      : \"{Wym_Container_Name}\",\n    CONTAINER_TITLE     : \"{Wym_Containers_Title}\",\n    CONTAINER_CLASS     : \"{Wym_Container_Class}\",\n    HTML                : \"{Wym_Html}\",\n    IFRAME              : \"{Wym_Iframe}\",\n    STATUS              : \"{Wym_Status}\",\n    DIALOG_TITLE        : \"{Wym_Dialog_Title}\",\n    DIALOG_BODY         : \"{Wym_Dialog_Body}\",\n    STRING              : \"string\",\n    BODY                : \"body\",\n    DIV                 : \"div\",\n    P                   : \"p\",\n    H1                  : \"h1\",\n    H2                  : \"h2\",\n    H3                  : \"h3\",\n    H4                  : \"h4\",\n    H5                  : \"h5\",\n    H6                  : \"h6\",\n    PRE                 : \"pre\",\n    BLOCKQUOTE          : \"blockquote\",\n    A                   : \"a\",\n    BR                  : \"br\",\n    IMG                 : \"img\",\n    TABLE               : \"table\",\n    TD                  : \"td\",\n    TH                  : \"th\",\n    UL                  : \"ul\",\n    OL                  : \"ol\",\n    LI                  : \"li\",\n    CLASS               : \"class\",\n    HREF                : \"href\",\n    SRC                 : \"src\",\n    TITLE               : \"title\",\n    ALT                 : \"alt\",\n    DIALOG_LINK         : \"Link\",\n    DIALOG_IMAGE        : \"Image\",\n    DIALOG_TABLE        : \"Table\",\n    DIALOG_PASTE        : \"Paste_From_Word\",\n    BOLD                : \"Bold\",\n    ITALIC              : \"Italic\",\n    CREATE_LINK         : \"CreateLink\",\n    INSERT_IMAGE        : \"InsertImage\",\n    INSERT_TABLE        : \"InsertTable\",\n    INSERT_HTML         : \"InsertHTML\",\n    PASTE               : \"Paste\",\n    INDENT              : \"Indent\",\n    OUTDENT             : \"Outdent\",\n    TOGGLE_HTML         : \"ToggleHtml\",\n    FORMAT_BLOCK        : \"FormatBlock\",\n    PREVIEW             : \"Preview\",\n    UNLINK\t\t\t        : \"Unlink\",\n    INSERT_UNORDEREDLIST: \"InsertUnorderedList\",\n    INSERT_ORDEREDLIST\t: \"InsertOrderedList\",\n\n    MAIN_CONTAINERS : new Array(\"p\",\"h1\",\"h2\",\"h3\",\"h4\",\"h5\",\"h6\",\"pre\",\"blockquote\"),\n\n    BLOCKS : new Array(\"address\", \"blockquote\", \"div\", \"dl\",\n\t   \"fieldset\", \"form\", \"h1\", \"h2\", \"h3\", \"h4\", \"h5\", \"h6\", \"hr\",\n\t   \"noscript\", \"ol\", \"p\", \"pre\", \"table\", \"ul\", \"dd\", \"dt\",\n\t   \"li\", \"tbody\", \"td\", \"tfoot\", \"th\", \"thead\", \"tr\"),\n\n    KEY : {\n      BACKSPACE: 8,\n      ENTER: 13,\n      END: 35,\n      HOME: 36,\n      LEFT: 37,\n      UP: 38,\n      RIGHT: 39,\n      DOWN: 40,\n      CURSOR: new Array(37, 38, 39, 40),\n      DELETE: 46\n    },\n\n    NODE : {\n      ELEMENT: 1,\n      ATTRIBUTE: 2,\n      TEXT: 3\n    },\n\t\n    /*\n        Class: WYMeditor.editor\n        WYMeditor editor main class, instanciated for each editor occurrence.\n    */\n\n\teditor : function(elem, options) {\n\n        /*\n            Constructor: WYMeditor.editor\n\n            Initializes main values (index, elements, paths, ...)\n            and call WYMeditor.editor.init which initializes the editor.\n\n            Parameters:\n\n                elem - The HTML element to be replaced by the editor.\n                options - The hash of options.\n\n            Returns:\n\n                Nothing.\n\n            See Also:\n\n                <WYMeditor.editor.init>\n        */\n\n        //store the instance in the INSTANCES array and store the index\n        this._index = WYMeditor.INSTANCES.push(this) - 1;\n        //store the element replaced by the editor\n        this._element = elem;\n        //store the options\n        this._options = options;\n        //store the element's inner value\n        this._html = jQuery(elem).val();\n\n        //store the HTML option, if any\n        if(this._options.html) this._html = this._options.html;\n        //get or compute the base path (where the main JS file is located)\n        this._options.basePath = this._options.basePath\n        || this.computeBasePath();\n        //get or set the skin path (where the skin files are located)\n        this._options.skinPath = this._options.skinPath\n        || this._options.basePath + WYMeditor.SKINS_DEFAULT_PATH\n           + this._options.skin + '/';\n        //get or compute the main JS file location\n        this._options.wymPath = this._options.wymPath\n        || this.computeWymPath();\n        //get or set the language files path\n        this._options.langPath = this._options.langPath\n        || this._options.basePath + WYMeditor.LANG_DEFAULT_PATH;\n        //get or set the designmode iframe's base path\n        this._options.iframeBasePath = this._options.iframeBasePath\n        || this._options.basePath + WYMeditor.IFRAME_DEFAULT;\n        //get or compute the jQuery JS file location\n        this._options.jQueryPath = this._options.jQueryPath\n        || this.computeJqueryPath();\n\n        //initialize the editor instance\n        this.init();\n\t\n\t}\n\n});\n\n/********** JQUERY **********/\n\n/**\n * Replace an HTML element by WYMeditor\n *\n * @example jQuery(\".wymeditor\").wymeditor(\n *        {\n *\n *        }\n *      );\n * @desc Example description here\n * \n * @name WYMeditor\n * @description WYMeditor is a web-based WYSIWYM XHTML editor\n * @param Hash hash A hash of parameters\n * @option Integer iExample Description here\n * @option String sExample Description here\n *\n * @type jQuery\n * @cat Plugins/WYMeditor\n * @author Jean-Francois Hovinne\n */\njQuery.fn.wymeditor = function(options) {\n\n  options = jQuery.extend({\n\n    html:       \"\",\n    \n    basePath:   false,\n    \n    skinPath:    false,\n    \n    wymPath:    false,\n    \n    iframeBasePath: false,\n    \n    jQueryPath: false,\n    \n    styles: false,\n    \n    stylesheet: false,\n    \n    skin:       \"default\",\n    initSkin:   true,\n    loadSkin:   true,\n\n    lang:       \"en\",\n\n    direction:  \"ltr\",\n\n    boxHtml:   \"<div class='wym_box'>\"\n              + \"<div class='wym_area_top'>\" \n              + WYMeditor.TOOLS\n              + \"</div>\"\n              + \"<div class='wym_area_left'></div>\"\n              + \"<div class='wym_area_right'>\"\n              + WYMeditor.CONTAINERS\n              + WYMeditor.CLASSES\n              + \"</div>\"\n              + \"<div class='wym_area_main'>\"\n              + WYMeditor.HTML\n              + WYMeditor.IFRAME\n              + WYMeditor.STATUS\n              + \"</div>\"\n              + \"<div class='wym_area_bottom'>\"\n              + WYMeditor.LOGO\n              + \"</div>\"\n              + \"</div>\",\n\n    logoHtml:  \"<a class='wym_wymeditor_link' \"\n              + \"href='http://www.wymeditor.org/'>WYMeditor</a>\",\n\n    iframeHtml:\"<div class='wym_iframe wym_section'>\"\n              + \"<iframe \"\n              + \"src='\"\n              + \"/page/get_editor_iframe' \"\n              //+ WYMeditor.IFRAME_BASE_PATH\n              //+ \"wymiframe.html' \"\n              + \"onload='this.contentWindow.parent.WYMeditor.INSTANCES[\"\n              + WYMeditor.INDEX + \"].initIframe(this)'\"\n              + \"></iframe>\"\n              + \"</div>\",\n              \n    editorStyles: [],\n\n    toolsHtml: \"<div class='wym_tools wym_section'>\"\n              + \"<h2>{Tools}</h2>\"\n              + \"<ul>\"\n              + WYMeditor.TOOLS_ITEMS\n              + \"</ul>\"\n              + \"</div>\",\n              \n    toolsItemHtml:   \"<li class='\"\n                        + WYMeditor.TOOL_CLASS\n                        + \"'><a href='#' name='\"\n                        + WYMeditor.TOOL_NAME\n                        + \"' title='\"\n                        + WYMeditor.TOOL_TITLE\n                        + \"'>\"\n                        + WYMeditor.TOOL_TITLE\n                        + \"</a></li>\",\n\n    toolsItems: [\n        {'name': 'Bold', 'title': 'Strong', 'css': 'wym_tools_strong'}, \n        {'name': 'Italic', 'title': 'Emphasis', 'css': 'wym_tools_emphasis'},\n        {'name': 'Superscript', 'title': 'Superscript',\n            'css': 'wym_tools_superscript'},\n        {'name': 'Subscript', 'title': 'Subscript',\n            'css': 'wym_tools_subscript'},\n        {'name': 'InsertOrderedList', 'title': 'Ordered_List',\n            'css': 'wym_tools_ordered_list'},\n        {'name': 'InsertUnorderedList', 'title': 'Unordered_List',\n            'css': 'wym_tools_unordered_list'},\n        {'name': 'Indent', 'title': 'Indent', 'css': 'wym_tools_indent'},\n        {'name': 'Outdent', 'title': 'Outdent', 'css': 'wym_tools_outdent'},\n        {'name': 'Undo', 'title': 'Undo', 'css': 'wym_tools_undo'},\n        {'name': 'Redo', 'title': 'Redo', 'css': 'wym_tools_redo'},\n        {'name': 'CreateLink', 'title': 'Link', 'css': 'wym_tools_link'},\n        {'name': 'Unlink', 'title': 'Unlink', 'css': 'wym_tools_unlink'},\n        {'name': 'InsertImage', 'title': 'Image', 'css': 'wym_tools_image'},\n        {'name': 'InsertTable', 'title': 'Table', 'css': 'wym_tools_table'},\n        {'name': 'Paste', 'title': 'Paste_From_Word',\n            'css': 'wym_tools_paste'},\n        {'name': 'ToggleHtml', 'title': 'HTML', 'css': 'wym_tools_html'},\n        {'name': 'Preview', 'title': 'Preview', 'css': 'wym_tools_preview'}\n    ],\n\n    containersHtml:    \"<div class='wym_containers wym_section'>\"\n                        + \"<h2>{Containers}</h2>\"\n                        + \"<ul>\"\n                        + WYMeditor.CONTAINERS_ITEMS\n                        + \"</ul>\"\n                        + \"</div>\",\n                        \n    containersItemHtml:\"<li class='\"\n                        + WYMeditor.CONTAINER_CLASS\n                        + \"'>\"\n                        + \"<a href='#' name='\"\n                        + WYMeditor.CONTAINER_NAME\n                        + \"'>\"\n                        + WYMeditor.CONTAINER_TITLE\n                        + \"</a></li>\",\n                        \n    containersItems: [\n        {'name': 'P', 'title': 'Paragraph', 'css': 'wym_containers_p'},\n        {'name': 'H1', 'title': 'Heading_1', 'css': 'wym_containers_h1'},\n        {'name': 'H2', 'title': 'Heading_2', 'css': 'wym_containers_h2'},\n        {'name': 'H3', 'title': 'Heading_3', 'css': 'wym_containers_h3'},\n        {'name': 'H4', 'title': 'Heading_4', 'css': 'wym_containers_h4'},\n        {'name': 'H5', 'title': 'Heading_5', 'css': 'wym_containers_h5'},\n        {'name': 'H6', 'title': 'Heading_6', 'css': 'wym_containers_h6'},\n        {'name': 'PRE', 'title': 'Preformatted', 'css': 'wym_containers_pre'},\n        {'name': 'BLOCKQUOTE', 'title': 'Blockquote',\n            'css': 'wym_containers_blockquote'},\n        {'name': 'TH', 'title': 'Table_Header', 'css': 'wym_containers_th'}\n    ],\n\n    classesHtml:       \"<div class='wym_classes wym_section'>\"\n                        + \"<h2>{Classes}</h2><ul>\"\n                        + WYMeditor.CLASSES_ITEMS\n                        + \"</ul></div>\",\n\n    classesItemHtml:   \"<li><a href='#' name='\"\n                        + WYMeditor.CLASS_NAME\n                        + \"'>\"\n                        + WYMeditor.CLASS_TITLE\n                        + \"</a></li>\",\n\n    classesItems:      [],\n\n    statusHtml:        \"<div class='wym_status wym_section'>\"\n                        + \"<h2>{Status}</h2>\"\n                        + \"</div>\",\n\n    htmlHtml:          \"<div class='wym_html wym_section'>\"\n                        + \"<h2>{Source_Code}</h2>\"\n                        + \"<textarea class='wym_html_val'></textarea>\"\n                        + \"</div>\",\n\n    boxSelector:       \".wym_box\",\n    toolsSelector:     \".wym_tools\",\n    toolsListSelector: \" ul\",\n    containersSelector:\".wym_containers\",\n    classesSelector:   \".wym_classes\",\n    htmlSelector:      \".wym_html\",\n    iframeSelector:    \".wym_iframe iframe\",\n    iframeBodySelector:\".wym_iframe\",\n    statusSelector:    \".wym_status\",\n    toolSelector:      \".wym_tools a\",\n    containerSelector: \".wym_containers a\",\n    classSelector:     \".wym_classes a\",\n    htmlValSelector:   \".wym_html_val\",\n    \n    hrefSelector:      \".wym_href\",\n    srcSelector:       \".wym_src\",\n    titleSelector:     \".wym_title\",\n    altSelector:       \".wym_alt\",\n    textSelector:      \".wym_text\",\n    \n    rowsSelector:      \".wym_rows\",\n    colsSelector:      \".wym_cols\",\n    captionSelector:   \".wym_caption\",\n    summarySelector:   \".wym_summary\",\n    \n    submitSelector:    \".wym_submit\",\n    cancelSelector:    \".wym_cancel\",\n    previewSelector:   \"\",\n    \n    dialogTypeSelector:    \".wym_dialog_type\",\n    dialogLinkSelector:    \".wym_dialog_link\",\n    dialogImageSelector:   \".wym_dialog_image\",\n    dialogTableSelector:   \".wym_dialog_table\",\n    dialogPasteSelector:   \".wym_dialog_paste\",\n    dialogPreviewSelector: \".wym_dialog_preview\",\n    \n    updateSelector:    \".wymupdate\",\n    updateEvent:       \"click\",\n    \n    dialogFeatures:    \"menubar=no,titlebar=no,toolbar=no,resizable=no\"\n                      + \",width=560,height=300,top=0,left=0\",\n    dialogFeaturesPreview: \"menubar=no,titlebar=no,toolbar=no,resizable=no\"\n                      + \",scrollbars=yes,width=560,height=300,top=0,left=0\",\n\n    dialogHtml:      \"<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Strict//EN'\"\n                      + \" 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd'>\"\n                      + \"<html dir='\"\n                      + WYMeditor.DIRECTION\n                      + \"'><head>\"\n                      + \"<link rel='stylesheet' type='text/css' media='screen'\"\n                      + \" href='\"\n                      + WYMeditor.CSS_PATH\n                      + \"' />\"\n                      + \"<title>\"\n                      + WYMeditor.DIALOG_TITLE\n                      + \"</title>\"\n                      + \"<script type='text/javascript'\"\n                      + \" src='\"\n                      + WYMeditor.JQUERY_PATH\n                      + \"'></script>\"\n                      + \"<script type='text/javascript'\"\n                      + \" src='\"\n                      + WYMeditor.WYM_PATH\n                      + \"'></script>\"\n                      + \"</head>\"\n                      + WYMeditor.DIALOG_BODY\n                      + \"</html>\",\n                      \n    dialogLinkHtml:  \"<body class='wym_dialog wym_dialog_link'\"\n               + \" onload='WYMeditor.INIT_DIALOG(\" + WYMeditor.INDEX + \")'\"\n               + \">\"\n               + \"<form>\"\n               + \"<fieldset>\"\n               + \"<input type='hidden' class='wym_dialog_type' value='\"\n               + WYMeditor.DIALOG_LINK\n               + \"' />\"\n               + \"<legend>{Link}</legend>\"\n               + \"<div class='row'>\"\n               + \"<label>{URL}</label>\"\n               + \"<input type='text' class='wym_href' value='' size='40' />\"\n               + \"</div>\"\n               + \"<div class='row'>\"\n               + \"<label>{Title}</label>\"\n               + \"<input type='text' class='wym_title' value='' size='40' />\"\n               + \"</div>\"\n               + \"<div class='row row-indent'>\"\n               + \"<input class='wym_submit' type='button'\"\n               + \" value='{Submit}' />\"\n               + \"<input class='wym_cancel' type='button'\"\n               + \"value='{Cancel}' />\"\n               + \"</div>\"\n               + \"</fieldset>\"\n               + \"</form>\"\n               + \"</body>\",\n    \n    dialogImageHtml:  \"<body class='wym_dialog wym_dialog_image'\"\n               + \" onload='WYMeditor.INIT_DIALOG(\" + WYMeditor.INDEX + \")'\"\n               + \">\"\n               + \"<form>\"\n               + \"<fieldset>\"\n               + \"<input type='hidden' class='wym_dialog_type' value='\"\n               + WYMeditor.DIALOG_IMAGE\n               + \"' />\"\n               + \"<legend>{Image}</legend>\"\n               + \"<div class='row'>\"\n               + \"<label>{URL}</label>\"\n               + \"<input type='text' class='wym_src' value='' size='40' />\"\n               + \"</div>\"\n               + \"<div class='row'>\"\n               + \"<label>{Alternative_Text}</label>\"\n               + \"<input type='text' class='wym_alt' value='' size='40' />\"\n               + \"</div>\"\n               + \"<div class='row'>\"\n               + \"<label>{Title}</label>\"\n               + \"<input type='text' class='wym_title' value='' size='40' />\"\n               + \"</div>\"\n               + \"<div class='row row-indent'>\"\n               + \"<input class='wym_submit' type='button'\"\n               + \" value='{Submit}' />\"\n               + \"<input class='wym_cancel' type='button'\"\n               + \"value='{Cancel}' />\"\n               + \"</div>\"\n               + \"</fieldset>\"\n               + \"</form>\"\n               + \"</body>\",\n    \n    dialogTableHtml:  \"<body class='wym_dialog wym_dialog_table'\"\n               + \" onload='WYMeditor.INIT_DIALOG(\" + WYMeditor.INDEX + \")'\"\n               + \">\"\n               + \"<form>\"\n               + \"<fieldset>\"\n               + \"<input type='hidden' class='wym_dialog_type' value='\"\n               + WYMeditor.DIALOG_TABLE\n               + \"' />\"\n               + \"<legend>{Table}</legend>\"\n               + \"<div class='row'>\"\n               + \"<label>{Caption}</label>\"\n               + \"<input type='text' class='wym_caption' value='' size='40' />\"\n               + \"</div>\"\n               + \"<div class='row'>\"\n               + \"<label>{Summary}</label>\"\n               + \"<input type='text' class='wym_summary' value='' size='40' />\"\n               + \"</div>\"\n               + \"<div class='row'>\"\n               + \"<label>{Number_Of_Rows}</label>\"\n               + \"<input type='text' class='wym_rows' value='3' size='3' />\"\n               + \"</div>\"\n               + \"<div class='row'>\"\n               + \"<label>{Number_Of_Cols}</label>\"\n               + \"<input type='text' class='wym_cols' value='2' size='3' />\"\n               + \"</div>\"\n               + \"<div class='row row-indent'>\"\n               + \"<input class='wym_submit' type='button'\"\n               + \" value='{Submit}' />\"\n               + \"<input class='wym_cancel' type='button'\"\n               + \"value='{Cancel}' />\"\n               + \"</div>\"\n               + \"</fieldset>\"\n               + \"</form>\"\n               + \"</body>\",\n\n    dialogPasteHtml:  \"<body class='wym_dialog wym_dialog_paste'\"\n               + \" onload='WYMeditor.INIT_DIALOG(\" + WYMeditor.INDEX + \")'\"\n               + \">\"\n               + \"<form>\"\n               + \"<input type='hidden' class='wym_dialog_type' value='\"\n               + WYMeditor.DIALOG_PASTE\n               + \"' />\"\n               + \"<fieldset>\"\n               + \"<legend>{Paste_From_Word}</legend>\"\n               + \"<div class='row'>\"\n               + \"<textarea class='wym_text' rows='10' cols='50'></textarea>\"\n               + \"</div>\"\n               + \"<div class='row'>\"\n               + \"<input class='wym_submit' type='button'\"\n               + \" value='{Submit}' />\"\n               + \"<input class='wym_cancel' type='button'\"\n               + \"value='{Cancel}' />\"\n               + \"</div>\"\n               + \"</fieldset>\"\n               + \"</form>\"\n               + \"</body>\",\n\n    dialogPreviewHtml: \"<body class='wym_dialog wym_dialog_preview'\"\n                      + \" onload='WYMeditor.INIT_DIALOG(\" + WYMeditor.INDEX + \")'\"\n                      + \"></body>\",\n                      \n    dialogStyles: [],\n\n    stringDelimiterLeft: \"{\",\n    stringDelimiterRight:\"}\",\n    \n    preInit: null,\n    preBind: null,\n    postInit: null,\n    \n    preInitDialog: null,\n    postInitDialog: null\n\n  }, options);\n\n  return this.each(function() {\n\n    new WYMeditor.editor(jQuery(this),options);\n  });\n};\n\n/* @name extend\n * @description Returns the WYMeditor instance based on its index\n */\njQuery.extend({\n  wymeditors: function(i) {\n    return (WYMeditor.INSTANCES[i]);\n  }\n});\n\n\n/********** WYMeditor **********/\n\n/* @name Wymeditor\n * @description WYMeditor class\n */\n\n/* @name init\n * @description Initializes a WYMeditor instance\n */\nWYMeditor.editor.prototype.init = function() {\n\n  //load subclass - browser specific\n  //unsupported browsers: do nothing\n  if (jQuery.browser.msie) {\n    var WymClass = new WYMeditor.WymClassExplorer(this);\n  }\n  else if (jQuery.browser.mozilla) {\n    var WymClass = new WYMeditor.WymClassMozilla(this);\n  }\n  else if (jQuery.browser.opera) {\n    var WymClass = new WYMeditor.WymClassOpera(this);\n  }\n  // Galaxy HACK: add Chrome to browser detection; this is fixed in later versions of WYMEditor.\n  else if (jQuery.browser.safari || jQuery.browser.chrome) {\n    var WymClass = new WYMeditor.WymClassSafari(this);\n  }\n  \n  if(WymClass) {\n  \n      if(jQuery.isFunction(this._options.preInit)) this._options.preInit(this);\n\n      var SaxListener = new WYMeditor.XhtmlSaxListener();\n      jQuery.extend(SaxListener, WymClass);\n      this.parser = new WYMeditor.XhtmlParser(SaxListener);\n      \n      if(this._options.styles || this._options.stylesheet){\n        this.configureEditorUsingRawCss();\n      }\n      \n      this.helper = new WYMeditor.XmlHelper();\n      \n      //extend the Wymeditor object\n      //don't use jQuery.extend since 1.1.4\n      //jQuery.extend(this, WymClass);\n      for (var prop in WymClass) { this[prop] = WymClass[prop]; }\n\n      //load wymbox\n      this._box = jQuery(this._element).hide().after(this._options.boxHtml).next().addClass('wym_box_' + this._index);\n\n      //store the instance index in wymbox and element replaced by editor instance\n      //but keep it compatible with jQuery < 1.2.3, see #122\n      if( jQuery.isFunction( jQuery.fn.data ) ) {\n        jQuery.data(this._box.get(0), WYMeditor.WYM_INDEX, this._index);\n        jQuery.data(this._element.get(0), WYMeditor.WYM_INDEX, this._index);\n      }\n      \n      var h = WYMeditor.Helper;\n\n      //construct the iframe\n      var iframeHtml = this._options.iframeHtml;\n      iframeHtml = h.replaceAll(iframeHtml, WYMeditor.INDEX, this._index);\n      iframeHtml = h.replaceAll(iframeHtml, WYMeditor.IFRAME_BASE_PATH, this._options.iframeBasePath);\n      \n      //construct wymbox\n      var boxHtml = jQuery(this._box).html();\n      \n      boxHtml = h.replaceAll(boxHtml, WYMeditor.LOGO, this._options.logoHtml);\n      boxHtml = h.replaceAll(boxHtml, WYMeditor.TOOLS, this._options.toolsHtml);\n      boxHtml = h.replaceAll(boxHtml, WYMeditor.CONTAINERS,this._options.containersHtml);\n      boxHtml = h.replaceAll(boxHtml, WYMeditor.CLASSES, this._options.classesHtml);\n      boxHtml = h.replaceAll(boxHtml, WYMeditor.HTML, this._options.htmlHtml);\n      boxHtml = h.replaceAll(boxHtml, WYMeditor.IFRAME, iframeHtml);\n      boxHtml = h.replaceAll(boxHtml, WYMeditor.STATUS, this._options.statusHtml);\n      \n      //construct tools list\n      var aTools = eval(this._options.toolsItems);\n      var sTools = \"\";\n\n      for(var i = 0; i < aTools.length; i++) {\n        var oTool = aTools[i];\n        if(oTool.name && oTool.title)\n          var sTool = this._options.toolsItemHtml;\n          var sTool = h.replaceAll(sTool, WYMeditor.TOOL_NAME, oTool.name);\n          sTool = h.replaceAll(sTool, WYMeditor.TOOL_TITLE, this._options.stringDelimiterLeft\n            + oTool.title\n            + this._options.stringDelimiterRight);\n          sTool = h.replaceAll(sTool, WYMeditor.TOOL_CLASS, oTool.css);\n          sTools += sTool;\n      }\n\n      boxHtml = h.replaceAll(boxHtml, WYMeditor.TOOLS_ITEMS, sTools);\n      \n      //construct classes list\n      var aClasses = eval(this._options.classesItems);\n      var sClasses = \"\";\n\n      for(var i = 0; i < aClasses.length; i++) {\n        var oClass = aClasses[i];\n        if(oClass.name && oClass.title)\n          var sClass = this._options.classesItemHtml;\n          sClass = h.replaceAll(sClass, WYMeditor.CLASS_NAME, oClass.name);\n          sClass = h.replaceAll(sClass, WYMeditor.CLASS_TITLE, oClass.title);\n          sClasses += sClass;\n      }\n\n      boxHtml = h.replaceAll(boxHtml, WYMeditor.CLASSES_ITEMS, sClasses);\n      \n      //construct containers list\n      var aContainers = eval(this._options.containersItems);\n      var sContainers = \"\";\n\n      for(var i = 0; i < aContainers.length; i++) {\n        var oContainer = aContainers[i];\n        if(oContainer.name && oContainer.title)\n          var sContainer = this._options.containersItemHtml;\n          sContainer = h.replaceAll(sContainer, WYMeditor.CONTAINER_NAME, oContainer.name);\n          sContainer = h.replaceAll(sContainer, WYMeditor.CONTAINER_TITLE,\n              this._options.stringDelimiterLeft\n            + oContainer.title\n            + this._options.stringDelimiterRight);\n          sContainer = h.replaceAll(sContainer, WYMeditor.CONTAINER_CLASS, oContainer.css);\n          sContainers += sContainer;\n      }\n\n      boxHtml = h.replaceAll(boxHtml, WYMeditor.CONTAINERS_ITEMS, sContainers);\n\n      //l10n\n      boxHtml = this.replaceStrings(boxHtml);\n      \n      //load html in wymbox\n      jQuery(this._box).html(boxHtml);\n      \n      //hide the html value\n      jQuery(this._box).find(this._options.htmlSelector).hide();\n      \n      //enable the skin\n      this.loadSkin();\n      \n    }\n};\n\nWYMeditor.editor.prototype.bindEvents = function() {\n\n  //copy the instance\n  var wym = this;\n  \n  //handle click event on tools buttons\n  jQuery(this._box).find(this._options.toolSelector).click(function() {\n    wym._iframe.contentWindow.focus(); //See #154\n    wym.exec(jQuery(this).attr(WYMeditor.NAME));    \n    return(false);\n  });\n  \n  //handle click event on containers buttons\n  jQuery(this._box).find(this._options.containerSelector).click(function() {\n    wym.container(jQuery(this).attr(WYMeditor.NAME));\n    return(false);\n  });\n  \n  //handle keyup event on html value: set the editor value\n  //handle focus/blur events to check if the element has focus, see #147\n  jQuery(this._box).find(this._options.htmlValSelector)\n    .keyup(function() { jQuery(wym._doc.body).html(jQuery(this).val());})\n    .focus(function() { jQuery(this).toggleClass('hasfocus'); })\n    .blur(function() { jQuery(this).toggleClass('hasfocus'); });\n\n  //handle click event on classes buttons\n  jQuery(this._box).find(this._options.classSelector).click(function() {\n  \n    var aClasses = eval(wym._options.classesItems);\n    var sName = jQuery(this).attr(WYMeditor.NAME);\n    \n    var oClass = WYMeditor.Helper.findByName(aClasses, sName);\n    \n    if(oClass) {\n      var jqexpr = oClass.expr;\n      wym.toggleClass(sName, jqexpr);\n    }\n    wym._iframe.contentWindow.focus(); //See #154\n    return(false);\n  });\n  \n  //handle event on update element\n  jQuery(this._options.updateSelector)\n    .bind(this._options.updateEvent, function() {\n      wym.update();\n  });\n};\n\nWYMeditor.editor.prototype.ready = function() {\n  return(this._doc != null);\n};\n\n\n/********** METHODS **********/\n\n/* @name box\n * @description Returns the WYMeditor container\n */\nWYMeditor.editor.prototype.box = function() {\n  return(this._box);\n};\n\n/* @name html\n * @description Get/Set the html value\n */\nWYMeditor.editor.prototype.html = function(html) {\n\n  if(typeof html === 'string') jQuery(this._doc.body).html(html);\n  else return(jQuery(this._doc.body).html());\n};\n\n/* @name xhtml\n * @description Cleans up the HTML\n */\nWYMeditor.editor.prototype.xhtml = function() {\n    return this.parser.parse(this.html());\n};\n\n/* @name exec\n * @description Executes a button command\n */\nWYMeditor.editor.prototype.exec = function(cmd) {\n  \n  //base function for execCommand\n  //open a dialog or exec\n  switch(cmd) {\n    case WYMeditor.CREATE_LINK:\n      var container = this.container();\n      if(container || this._selected_image) this.dialog(WYMeditor.DIALOG_LINK);\n    break;\n    \n    case WYMeditor.INSERT_IMAGE:\n      this.dialog(WYMeditor.DIALOG_IMAGE);\n    break;\n    \n    case WYMeditor.INSERT_TABLE:\n      this.dialog(WYMeditor.DIALOG_TABLE);\n    break;\n    \n    case WYMeditor.PASTE:\n      this.dialog(WYMeditor.DIALOG_PASTE);\n    break;\n    \n    case WYMeditor.TOGGLE_HTML:\n      this.update();\n      this.toggleHtml();\n\n      //partially fixes #121 when the user manually inserts an image\n      if(!jQuery(this._box).find(this._options.htmlSelector).is(':visible'))\n        this.listen();\n    break;\n    \n    case WYMeditor.PREVIEW:\n      this.dialog(WYMeditor.PREVIEW, this._options.dialogFeaturesPreview);\n    break;\n    \n    default:\n      this._exec(cmd);\n    break;\n  }\n};\n\n/* @name container\n * @description Get/Set the selected container\n */\nWYMeditor.editor.prototype.container = function(sType) {\n\n  if(sType) {\n  \n    var container = null;\n    \n    if(sType.toLowerCase() == WYMeditor.TH) {\n    \n      container = this.container();\n      \n      //find the TD or TH container\n      switch(container.tagName.toLowerCase()) {\n      \n        case WYMeditor.TD: case WYMeditor.TH:\n          break;\n        default:\n          var aTypes = new Array(WYMeditor.TD,WYMeditor.TH);\n          container = this.findUp(this.container(), aTypes);\n          break;\n      }\n      \n      //if it exists, switch\n      if(container!=null) {\n      \n        sType = (container.tagName.toLowerCase() == WYMeditor.TD)? WYMeditor.TH: WYMeditor.TD;\n        this.switchTo(container,sType);\n        this.update();\n      }\n    } else {\n  \n      //set the container type\n      var aTypes=new Array(WYMeditor.P,WYMeditor.H1,WYMeditor.H2,WYMeditor.H3,WYMeditor.H4,WYMeditor.H5,\n      WYMeditor.H6,WYMeditor.PRE,WYMeditor.BLOCKQUOTE);\n      container = this.findUp(this.container(), aTypes);\n      \n      if(container) {\n  \n        var newNode = null;\n  \n        //blockquotes must contain a block level element\n        if(sType.toLowerCase() == WYMeditor.BLOCKQUOTE) {\n        \n          var blockquote = this.findUp(this.container(), WYMeditor.BLOCKQUOTE);\n          \n          if(blockquote == null) {\n          \n            newNode = this._doc.createElement(sType);\n            container.parentNode.insertBefore(newNode,container);\n            newNode.appendChild(container);\n            this.setFocusToNode(newNode.firstChild);\n            \n          } else {\n          \n            var nodes = blockquote.childNodes;\n            var lgt = nodes.length;\n            var firstNode = null;\n            \n            if(lgt > 0) firstNode = nodes.item(0);\n            for(var x=0; x<lgt; x++) {\n              blockquote.parentNode.insertBefore(nodes.item(0),blockquote);\n            }\n            blockquote.parentNode.removeChild(blockquote);\n            if(firstNode) this.setFocusToNode(firstNode);\n          }\n        }\n        \n        else this.switchTo(container,sType);\n      \n        this.update();\n      }\n    }\n  }\n  else return(this.selected());\n};\n\n/* @name toggleClass\n * @description Toggles class on selected element, or one of its parents\n */\nWYMeditor.editor.prototype.toggleClass = function(sClass, jqexpr) {\n\n  var container = (this._selected_image\n                    ? this._selected_image\n                    : jQuery(this.selected()));\n  container = jQuery(container).parentsOrSelf(jqexpr);\n  jQuery(container).toggleClass(sClass);\n\n  if(!jQuery(container).attr(WYMeditor.CLASS)) jQuery(container).removeAttr(this._class);\n\n};\n\n/* @name findUp\n * @description Returns the first parent or self container, based on its type\n */\nWYMeditor.editor.prototype.findUp = function(node, filter) {\n\n  //filter is a string or an array of strings\n\n  if(node) {\n\n      var tagname = node.tagName.toLowerCase();\n      \n      if(typeof(filter) == WYMeditor.STRING) {\n    \n        while(tagname != filter && tagname != WYMeditor.BODY) {\n        \n          node = node.parentNode;\n          tagname = node.tagName.toLowerCase();\n        }\n      \n      } else {\n      \n        var bFound = false;\n        \n        while(!bFound && tagname != WYMeditor.BODY) {\n          for(var i = 0; i < filter.length; i++) {\n            if(tagname == filter[i]) {\n              bFound = true;\n              break;\n            }\n          }\n          if(!bFound) {\n            node = node.parentNode;\n            tagname = node.tagName.toLowerCase();\n          }\n        }\n      }\n      \n      if(tagname != WYMeditor.BODY) return(node);\n      else return(null);\n      \n  } else return(null);\n};\n\n/* @name switchTo\n * @description Switch the node's type\n */\nWYMeditor.editor.prototype.switchTo = function(node,sType) {\n\n  var newNode = this._doc.createElement(sType);\n  var html = jQuery(node).html();\n  node.parentNode.replaceChild(newNode,node);\n  jQuery(newNode).html(html);\n  this.setFocusToNode(newNode);\n};\n\nWYMeditor.editor.prototype.replaceStrings = function(sVal) {\n  //check if the language file has already been loaded\n  //if not, get it via a synchronous ajax call\n  if(!WYMeditor.STRINGS[this._options.lang]) {\n    try {\n      eval(jQuery.ajax({url:this._options.langPath\n        + this._options.lang + '.js', async:false}).responseText);\n    } catch(e) {\n        WYMeditor.console.error(\"WYMeditor: error while parsing language file.\");\n        return sVal;\n    }\n  }\n\n  //replace all the strings in sVal and return it\n  for (var key in WYMeditor.STRINGS[this._options.lang]) {\n    sVal = WYMeditor.Helper.replaceAll(sVal, this._options.stringDelimiterLeft + key \n    + this._options.stringDelimiterRight,\n    WYMeditor.STRINGS[this._options.lang][key]);\n  };\n  return(sVal);\n};\n\nWYMeditor.editor.prototype.encloseString = function(sVal) {\n\n  return(this._options.stringDelimiterLeft\n    + sVal\n    + this._options.stringDelimiterRight);\n};\n\n/* @name status\n * @description Prints a status message\n */\nWYMeditor.editor.prototype.status = function(sMessage) {\n\n  //print status message\n  jQuery(this._box).find(this._options.statusSelector).html(sMessage);\n};\n\n/* @name update\n * @description Updates the element and textarea values\n */\nWYMeditor.editor.prototype.update = function() {\n\n  var html = this.xhtml();\n  jQuery(this._element).val(html);\n  jQuery(this._box).find(this._options.htmlValSelector).not('.hasfocus').val(html); //#147\n};\n\n/* @name dialog\n * @description Opens a dialog box\n */\nWYMeditor.editor.prototype.dialog = function( dialogType, dialogFeatures, bodyHtml ) {\n  var features = dialogFeatures || this._wym._options.dialogFeatures;\n  var wDialog = window.open('', 'dialog', features);\n\n  if(wDialog) {\n\n    var sBodyHtml = \"\";\n    \n    switch( dialogType ) {\n\n      case(WYMeditor.DIALOG_LINK):\n        sBodyHtml = this._options.dialogLinkHtml;\n      break;\n      case(WYMeditor.DIALOG_IMAGE):\n        sBodyHtml = this._options.dialogImageHtml;\n      break;\n      case(WYMeditor.DIALOG_TABLE):\n        sBodyHtml = this._options.dialogTableHtml;\n      break;\n      case(WYMeditor.DIALOG_PASTE):\n        sBodyHtml = this._options.dialogPasteHtml;\n      break;\n      case(WYMeditor.PREVIEW):\n        sBodyHtml = this._options.dialogPreviewHtml;\n      break;\n      default:\n        sBodyHtml = bodyHtml;\n    }\n    var h = WYMeditor.Helper;\n\n    //construct the dialog\n    var dialogHtml = this._options.dialogHtml;\n    dialogHtml = h.replaceAll(dialogHtml, WYMeditor.BASE_PATH, this._options.basePath);\n    dialogHtml = h.replaceAll(dialogHtml, WYMeditor.DIRECTION, this._options.direction);\n    dialogHtml = h.replaceAll(dialogHtml, WYMeditor.CSS_PATH, this._options.skinPath + WYMeditor.SKINS_DEFAULT_CSS);\n    dialogHtml = h.replaceAll(dialogHtml, WYMeditor.WYM_PATH, this._options.wymPath);\n    dialogHtml = h.replaceAll(dialogHtml, WYMeditor.JQUERY_PATH, this._options.jQueryPath);\n    dialogHtml = h.replaceAll(dialogHtml, WYMeditor.DIALOG_TITLE, this.encloseString( dialogType ));\n    dialogHtml = h.replaceAll(dialogHtml, WYMeditor.DIALOG_BODY, sBodyHtml);\n    dialogHtml = h.replaceAll(dialogHtml, WYMeditor.INDEX, this._index);\n      \n    dialogHtml = this.replaceStrings(dialogHtml);\n    var doc = wDialog.document;\n    doc.write(dialogHtml);\n    doc.close();\n  }\n};\n\n/* @name toggleHtml\n * @description Shows/Hides the HTML\n */\nWYMeditor.editor.prototype.toggleHtml = function() {\n  jQuery(this._box).find(this._options.htmlSelector).toggle();\n};\n\nWYMeditor.editor.prototype.uniqueStamp = function() {\n\tvar now = new Date();\n\treturn(\"wym-\" + now.getTime());\n};\n\nWYMeditor.editor.prototype.paste = function(sData) {\n\n  var sTmp;\n  var container = this.selected();\n\t\n  //split the data, using double newlines as the separator\n  var aP = sData.split(this._newLine + this._newLine);\n  var rExp = new RegExp(this._newLine, \"g\");\n\n  //add a P for each item\n  if(container && container.tagName.toLowerCase() != WYMeditor.BODY) {\n    for(x = aP.length - 1; x >= 0; x--) {\n        sTmp = aP[x];\n        //simple newlines are replaced by a break\n        sTmp = sTmp.replace(rExp, \"<br />\");\n        jQuery(container).after(\"<p>\" + sTmp + \"</p>\");\n    }\n  } else {\n    for(x = 0; x < aP.length; x++) {\n        sTmp = aP[x];\n        //simple newlines are replaced by a break\n        sTmp = sTmp.replace(rExp, \"<br />\");\n        jQuery(this._doc.body).append(\"<p>\" + sTmp + \"</p>\");\n    }\n  \n  }\n};\n\nWYMeditor.editor.prototype.insert = function(html) {\n    // Do we have a selection?\n    if (this._iframe.contentWindow.getSelection().focusNode != null) {\n        // Overwrite selection with provided html\n        this._exec( WYMeditor.INSERT_HTML, html);\n    } else {\n        // Fall back to the internal paste function if there's no selection\n        this.paste(html)\n    }\n};\n\nWYMeditor.editor.prototype.wrap = function(left, right) {\n    // Do we have a selection?\n    if (this._iframe.contentWindow.getSelection().focusNode != null) {\n        // Wrap selection with provided html\n        this._exec( WYMeditor.INSERT_HTML, left + this._iframe.contentWindow.getSelection().toString() + right);\n    }\n};\n\nWYMeditor.editor.prototype.unwrap = function() {\n    // Do we have a selection?\n    if (this._iframe.contentWindow.getSelection().focusNode != null) {\n        // Unwrap selection\n        this._exec( WYMeditor.INSERT_HTML, this._iframe.contentWindow.getSelection().toString() );\n    }\n};\n\nWYMeditor.editor.prototype.addCssRules = function(doc, aCss) {\n  var styles = doc.styleSheets[0];\n  if(styles) {\n    for(var i = 0; i < aCss.length; i++) {\n      var oCss = aCss[i];\n      if(oCss.name && oCss.css) this.addCssRule(styles, oCss);\n    }\n  }\n};\n\n/********** CONFIGURATION **********/\n\nWYMeditor.editor.prototype.computeBasePath = function() {\n  return jQuery(jQuery.grep(jQuery('script'), function(s){\n    return (s.src && s.src.match(/jquery\\.wymeditor(\\.pack|\\.min|\\.packed)?\\.js(\\?.*)?$/ ))\n  })).attr('src').replace(/jquery\\.wymeditor(\\.pack|\\.min|\\.packed)?\\.js(\\?.*)?$/, '');\n};\n\nWYMeditor.editor.prototype.computeWymPath = function() {\n  return jQuery(jQuery.grep(jQuery('script'), function(s){\n    return (s.src && s.src.match(/jquery\\.wymeditor(\\.pack|\\.min|\\.packed)?\\.js(\\?.*)?$/ ))\n  })).attr('src');\n};\n\nWYMeditor.editor.prototype.computeJqueryPath = function() {\n  return jQuery(jQuery.grep(jQuery('script'), function(s){\n    return (s.src && s.src.match(/jquery(-(.*)){0,1}(\\.pack|\\.min|\\.packed)?\\.js(\\?.*)?$/ ))\n  })).attr('src');\n};\n\nWYMeditor.editor.prototype.computeCssPath = function() {\n  return jQuery(jQuery.grep(jQuery('link'), function(s){\n   return (s.href && s.href.match(/wymeditor\\/skins\\/(.*)screen\\.css(\\?.*)?$/ ))\n  })).attr('href');\n};\n\nWYMeditor.editor.prototype.configureEditorUsingRawCss = function() {\n\n  var CssParser = new WYMeditor.WymCssParser();\n  if(this._options.stylesheet){\n    CssParser.parse(jQuery.ajax({url: this._options.stylesheet,async:false}).responseText);\n  }else{\n    CssParser.parse(this._options.styles, false);\n  }\n\n  if(this._options.classesItems.length == 0) {\n    this._options.classesItems = CssParser.css_settings.classesItems;\n  }\n  if(this._options.editorStyles.length == 0) {\n    this._options.editorStyles = CssParser.css_settings.editorStyles;\n  }\n  if(this._options.dialogStyles.length == 0) {\n    this._options.dialogStyles = CssParser.css_settings.dialogStyles;\n  }\n};\n\n/********** EVENTS **********/\n\nWYMeditor.editor.prototype.listen = function() {\n\n  //don't use jQuery.find() on the iframe body\n  //because of MSIE + jQuery + expando issue (#JQ1143)\n  //jQuery(this._doc.body).find(\"*\").bind(\"mouseup\", this.mouseup);\n  \n  jQuery(this._doc.body).bind(\"mousedown\", this.mousedown);\n  var images = this._doc.body.getElementsByTagName(\"img\");\n  for(var i=0; i < images.length; i++) {\n    jQuery(images[i]).bind(\"mousedown\", this.mousedown);\n  }\n};\n\nWYMeditor.editor.prototype.mousedown = function(evt) {\n  \n  var wym = WYMeditor.INSTANCES[this.ownerDocument.title];\n  wym._selected_image = (this.tagName.toLowerCase() == WYMeditor.IMG) ? this : null;\n  evt.stopPropagation();\n};\n\n/********** SKINS **********/\n\n/*\n * Function: WYMeditor.loadCss\n *      Loads a stylesheet in the document.\n *\n * Parameters:\n *      href - The CSS path.\n */\nWYMeditor.loadCss = function(href) {\n    \n    var link = document.createElement('link');\n    link.rel = 'stylesheet';\n    link.href = href;\n\n    var head = jQuery('head').get(0);\n    head.appendChild(link);\n};\n\n/*\n *  Function: WYMeditor.editor.loadSkin\n *      Loads the skin CSS and initialization script (if needed).\n */\nWYMeditor.editor.prototype.loadSkin = function() {\n\n    //does the user want to automatically load the CSS (default: yes)?\n    //we also test if it hasn't been already loaded by another instance\n    //see below for a better (second) test\n    if(this._options.loadSkin && !WYMeditor.SKINS[this._options.skin]) {\n\n        //check if it hasn't been already loaded\n        //so we don't load it more than once\n        //(we check the existing <link> elements)\n\n        var found = false;\n        var rExp = new RegExp(this._options.skin\n             + '\\/' + WYMeditor.SKINS_DEFAULT_CSS + '$');\n\n        jQuery('link').each( function() {\n            if(this.href.match(rExp)) found = true;\n        });\n\n        //load it, using the skin path\n        if(!found) WYMeditor.loadCss( this._options.skinPath\n            + WYMeditor.SKINS_DEFAULT_CSS );\n    }\n\n    //put the classname (ex. wym_skin_default) on wym_box\n    jQuery(this._box).addClass( \"wym_skin_\" + this._options.skin );\n\n    //does the user want to use some JS to initialize the skin (default: yes)?\n    //also check if it hasn't already been loaded by another instance\n    if(this._options.initSkin && !WYMeditor.SKINS[this._options.skin]) {\n\n        eval(jQuery.ajax({url:this._options.skinPath\n            + WYMeditor.SKINS_DEFAULT_JS, async:false}).responseText);\n    }\n\n    //init the skin, if needed\n    if(WYMeditor.SKINS[this._options.skin]\n    && WYMeditor.SKINS[this._options.skin].init)\n       WYMeditor.SKINS[this._options.skin].init(this);\n\n};\n\n\n/********** DIALOGS **********/\n\nWYMeditor.INIT_DIALOG = function(index) {\n\n  var wym = window.opener.WYMeditor.INSTANCES[index];\n  var doc = window.document;\n  var selected = wym.selected();\n  var dialogType = jQuery(wym._options.dialogTypeSelector).val();\n  var sStamp = wym.uniqueStamp();\n\n  switch(dialogType) {\n\n  case WYMeditor.DIALOG_LINK:\n    //ensure that we select the link to populate the fields\n    if(selected && selected.tagName && selected.tagName.toLowerCase != WYMeditor.A)\n      selected = jQuery(selected).parentsOrSelf(WYMeditor.A);\n\n    //fix MSIE selection if link image has been clicked\n    if(!selected && wym._selected_image)\n      selected = jQuery(wym._selected_image).parentsOrSelf(WYMeditor.A);\n  break;\n\n  }\n\n  //pre-init functions\n  if(jQuery.isFunction(wym._options.preInitDialog))\n    wym._options.preInitDialog(wym,window);\n\n  //add css rules from options\n  var styles = doc.styleSheets[0];\n  var aCss = eval(wym._options.dialogStyles);\n\n  wym.addCssRules(doc, aCss);\n\n  //auto populate fields if selected container (e.g. A)\n  if(selected) {\n    jQuery(wym._options.hrefSelector).val(jQuery(selected).attr(WYMeditor.HREF));\n    jQuery(wym._options.srcSelector).val(jQuery(selected).attr(WYMeditor.SRC));\n    jQuery(wym._options.titleSelector).val(jQuery(selected).attr(WYMeditor.TITLE));\n    jQuery(wym._options.altSelector).val(jQuery(selected).attr(WYMeditor.ALT));\n  }\n\n  //auto populate image fields if selected image\n  if(wym._selected_image) {\n    jQuery(wym._options.dialogImageSelector + \" \" + wym._options.srcSelector)\n      .val(jQuery(wym._selected_image).attr(WYMeditor.SRC));\n    jQuery(wym._options.dialogImageSelector + \" \" + wym._options.titleSelector)\n      .val(jQuery(wym._selected_image).attr(WYMeditor.TITLE));\n    jQuery(wym._options.dialogImageSelector + \" \" + wym._options.altSelector)\n      .val(jQuery(wym._selected_image).attr(WYMeditor.ALT));\n  }\n\n  jQuery(wym._options.dialogLinkSelector + \" \"\n    + wym._options.submitSelector).click(function() {\n\n      var sUrl = jQuery(wym._options.hrefSelector).val();\n      if(sUrl.length > 0) {\n\n        wym._exec(WYMeditor.CREATE_LINK, sStamp);\n\n        jQuery(\"a[href=\" + sStamp + \"]\", wym._doc.body)\n            .attr(WYMeditor.HREF, sUrl)\n            .attr(WYMeditor.TITLE, jQuery(wym._options.titleSelector).val());\n\n      }\n      window.close();\n  });\n\n  jQuery(wym._options.dialogImageSelector + \" \"\n    + wym._options.submitSelector).click(function() {\n\n      var sUrl = jQuery(wym._options.srcSelector).val();\n      if(sUrl.length > 0) {\n\n        wym._exec(WYMeditor.INSERT_IMAGE, sStamp);\n\n        jQuery(\"img[src$=\" + sStamp + \"]\", wym._doc.body)\n            .attr(WYMeditor.SRC, sUrl)\n            .attr(WYMeditor.TITLE, jQuery(wym._options.titleSelector).val())\n            .attr(WYMeditor.ALT, jQuery(wym._options.altSelector).val());\n      }\n      window.close();\n  });\n\n  jQuery(wym._options.dialogTableSelector + \" \"\n    + wym._options.submitSelector).click(function() {\n\n      var iRows = jQuery(wym._options.rowsSelector).val();\n      var iCols = jQuery(wym._options.colsSelector).val();\n\n      if(iRows > 0 && iCols > 0) {\n\n        var table = wym._doc.createElement(WYMeditor.TABLE);\n        var newRow = null;\n\t\tvar newCol = null;\n\n\t\tvar sCaption = jQuery(wym._options.captionSelector).val();\n\n\t\t//we create the caption\n\t\tvar newCaption = table.createCaption();\n\t\tnewCaption.innerHTML = sCaption;\n\n\t\t//we create the rows and cells\n\t\tfor(x=0; x<iRows; x++) {\n\t\t\tnewRow = table.insertRow(x);\n\t\t\tfor(y=0; y<iCols; y++) {newRow.insertCell(y);}\n\t\t}\n\n        //set the summary attr\n        jQuery(table).attr('summary',\n            jQuery(wym._options.summarySelector).val());\n\n        //append the table after the selected container\n        var node = jQuery(wym.findUp(wym.container(),\n          WYMeditor.MAIN_CONTAINERS)).get(0);\n        if(!node || !node.parentNode) jQuery(wym._doc.body).append(table);\n        else jQuery(node).after(table);\n      }\n      window.close();\n  });\n\n  jQuery(wym._options.dialogPasteSelector + \" \"\n    + wym._options.submitSelector).click(function() {\n\n      var sText = jQuery(wym._options.textSelector).val();\n      wym.paste(sText);\n      window.close();\n  });\n\n  jQuery(wym._options.dialogPreviewSelector + \" \"\n    + wym._options.previewSelector)\n    .html(wym.xhtml());\n\n  //cancel button\n  jQuery(wym._options.cancelSelector).mousedown(function() {\n    window.close();\n  });\n\n  //pre-init functions\n  if(jQuery.isFunction(wym._options.postInitDialog))\n    wym._options.postInitDialog(wym,window);\n\n};\n\n/********** XHTML LEXER/PARSER **********/\n\n/*\n* @name xml\n* @description Use these methods to generate XML and XHTML compliant tags and\n* escape tag attributes correctly\n* @author Bermi Ferrer - http://bermi.org\n* @author David Heinemeier Hansson http://loudthinking.com\n*/\nWYMeditor.XmlHelper = function()\n{\n  this._entitiesDiv = document.createElement('div');\n  return this;\n};\n\n\n/*\n* @name tag\n* @description\n* Returns an empty HTML tag of type *name* which by default is XHTML\n* compliant. Setting *open* to true will create an open tag compatible\n* with HTML 4.0 and below. Add HTML attributes by passing an attributes\n* array to *options*. For attributes with no value like (disabled and\n* readonly), give it a value of true in the *options* array.\n*\n* Examples:\n*\n*   this.tag('br')\n*    # => <br />\n*   this.tag ('br', false, true)\n*    # => <br>\n*   this.tag ('input', jQuery({type:'text',disabled:true }) )\n*    # => <input type=\"text\" disabled=\"disabled\" />\n*/\nWYMeditor.XmlHelper.prototype.tag = function(name, options, open)\n{\n  options = options || false;\n  open = open || false;\n  return '<'+name+(options ? this.tagOptions(options) : '')+(open ? '>' : ' />');\n};\n\n/*\n* @name contentTag\n* @description\n* Returns a XML block tag of type *name* surrounding the *content*. Add\n* XML attributes by passing an attributes array to *options*. For attributes\n* with no value like (disabled and readonly), give it a value of true in\n* the *options* array. You can use symbols or strings for the attribute names.\n*\n*   this.contentTag ('p', 'Hello world!' )\n*    # => <p>Hello world!</p>\n*   this.contentTag('div', this.contentTag('p', \"Hello world!\"), jQuery({class : \"strong\"}))\n*    # => <div class=\"strong\"><p>Hello world!</p></div>\n*   this.contentTag(\"select\", options, jQuery({multiple : true}))\n*    # => <select multiple=\"multiple\">...options...</select>\n*/\nWYMeditor.XmlHelper.prototype.contentTag = function(name, content, options)\n{\n  options = options || false;\n  return '<'+name+(options ? this.tagOptions(options) : '')+'>'+content+'</'+name+'>';\n};\n\n/*\n* @name cdataSection\n* @description\n* Returns a CDATA section for the given +content+.  CDATA sections\n* are used to escape blocks of text containing characters which would\n* otherwise be recognized as markup. CDATA sections begin with the string\n* <tt>&lt;![CDATA[</tt> and } with (and may not contain) the string\n* <tt>]]></tt>.\n*/\nWYMeditor.XmlHelper.prototype.cdataSection = function(content)\n{\n  return '<![CDATA['+content+']]>';\n};\n\n\n/*\n* @name escapeOnce\n* @description\n* Returns the escaped +xml+ without affecting existing escaped entities.\n*\n*  this.escapeOnce( \"1 > 2 &amp; 3\")\n*    # => \"1 &gt; 2 &amp; 3\"\n*/\nWYMeditor.XmlHelper.prototype.escapeOnce = function(xml)\n{\n  return this._fixDoubleEscape(this.escapeEntities(xml));\n};\n\n/*\n* @name _fixDoubleEscape\n* @description\n* Fix double-escaped entities, such as &amp;amp;, &amp;#123;, etc.\n*/\nWYMeditor.XmlHelper.prototype._fixDoubleEscape = function(escaped)\n{\n  return escaped.replace(/&amp;([a-z]+|(#\\d+));/ig, \"&$1;\");\n};\n\n/*\n* @name tagOptions\n* @description\n* Takes an array like the one generated by Tag.parseAttributes\n*  [[\"src\", \"http://www.editam.com/?a=b&c=d&amp;f=g\"], [\"title\", \"Editam, <Simplified> CMS\"]]\n* or an object like {src:\"http://www.editam.com/?a=b&c=d&amp;f=g\", title:\"Editam, <Simplified> CMS\"}\n* and returns a string properly escaped like\n* ' src = \"http://www.editam.com/?a=b&amp;c=d&amp;f=g\" title = \"Editam, &lt;Simplified&gt; CMS\"'\n* which is valid for strict XHTML\n*/\nWYMeditor.XmlHelper.prototype.tagOptions = function(options)\n{\n  var xml = this;\n  xml._formated_options = '';\n\n  for (var key in options) {\n    var formated_options = '';\n    var value = options[key];\n    if(typeof value != 'function' && value.length > 0) {\n\n      if(parseInt(key) == key && typeof value == 'object'){\n        key = value.shift();\n        value = value.pop();\n      }\n      if(key != '' && value != ''){\n        xml._formated_options += ' '+key+'=\"'+xml.escapeOnce(value)+'\"';\n      }\n    }\n  }\n  return xml._formated_options;\n};\n\n/*\n* @name escapeEntities\n* @description\n* Escapes XML/HTML entities <, >, & and \". If seccond parameter is set to false it\n* will not escape \". If set to true it will also escape '\n*/\nWYMeditor.XmlHelper.prototype.escapeEntities = function(string, escape_quotes)\n{\n  this._entitiesDiv.innerHTML = string;\n  this._entitiesDiv.textContent = string;\n  var result = this._entitiesDiv.innerHTML;\n  if(typeof escape_quotes == 'undefined'){\n    if(escape_quotes != false) result = result.replace('\"', '&quot;');\n    if(escape_quotes == true)  result = result.replace('\"', '&#039;');\n  }\n  return result;\n};\n\n/*\n* Parses a string conatining tag attributes and values an returns an array formated like\n*  [[\"src\", \"http://www.editam.com\"], [\"title\", \"Editam, Simplified CMS\"]]\n*/\nWYMeditor.XmlHelper.prototype.parseAttributes = function(tag_attributes)\n{\n  // Use a compounded regex to match single quoted, double quoted and unquoted attribute pairs\n  var result = [];\n  var matches = tag_attributes.split(/((=\\s*\")(\")(\"))|((=\\s*\\')(\\')(\\'))|((=\\s*[^>\\s]*))/g);\n  if(matches.toString() != tag_attributes){\n    for (var k in matches) {\n      var v = matches[k];\n      if(typeof v != 'function' && v.length != 0){\n        var re = new RegExp('(\\\\w+)\\\\s*'+v);\n        if(match = tag_attributes.match(re) ){\n          var value = v.replace(/^[\\s=]+/, \"\");\n          var delimiter = value.charAt(0);\n          delimiter = delimiter == '\"' ? '\"' : (delimiter==\"'\"?\"'\":'');\n          if(delimiter != ''){\n            value = delimiter == '\"' ? value.replace(/^\"|\"+$/g, '') :  value.replace(/^'|'+$/g, '');\n          }\n          tag_attributes = tag_attributes.replace(match[0],'');\n          result.push([match[1] , value]);\n        }\n      }\n    }\n  }\n  return result;\n};\n\n/**\n* XhtmlValidator for validating tag attributes\n*\n* @author Bermi Ferrer - http://bermi.org\n*/\nWYMeditor.XhtmlValidator = {\n  \"_attributes\":\n  {\n    \"core\":\n    {\n      \"except\":[\n      \"base\",\n      \"head\",\n      \"html\",\n      \"meta\",\n      \"param\",\n      \"script\",\n      \"style\",\n      \"title\"\n      ],\n      \"attributes\":[\n      \"class\",\n      \"id\",\n      \"style\",\n      \"title\",\n      \"accesskey\",\n      \"tabindex\"\n      ]\n    },\n    \"language\":\n    {\n      \"except\":[\n      \"base\",\n      \"br\",\n      \"hr\",\n      \"iframe\",\n      \"param\",\n      \"script\"\n      ],\n      \"attributes\":\n      {\n        \"dir\":[\n        \"ltr\",\n        \"rtl\"\n        ],\n        \"0\":\"lang\",\n        \"1\":\"xml:lang\"\n      }\n    },\n    \"keyboard\":\n    {\n      \"attributes\":\n      {\n        \"accesskey\":/^(\\w){1}$/,\n        \"tabindex\":/^(\\d)+$/\n      }\n    }\n  },\n  \"_events\":\n  {\n    \"window\":\n    {\n      \"only\":[\n      \"body\"\n      ],\n      \"attributes\":[\n      \"onload\",\n      \"onunload\"\n      ]\n    },\n    \"form\":\n    {\n      \"only\":[\n      \"form\",\n      \"input\",\n      \"textarea\",\n      \"select\",\n      \"a\",\n      \"label\",\n      \"button\"\n      ],\n      \"attributes\":[\n      \"onchange\",\n      \"onsubmit\",\n      \"onreset\",\n      \"onselect\",\n      \"onblur\",\n      \"onfocus\"\n      ]\n    },\n    \"keyboard\":\n    {\n      \"except\":[\n      \"base\",\n      \"bdo\",\n      \"br\",\n      \"frame\",\n      \"frameset\",\n      \"head\",\n      \"html\",\n      \"iframe\",\n      \"meta\",\n      \"param\",\n      \"script\",\n      \"style\",\n      \"title\"\n      ],\n      \"attributes\":[\n      \"onkeydown\",\n      \"onkeypress\",\n      \"onkeyup\"\n      ]\n    },\n    \"mouse\":\n    {\n      \"except\":[\n      \"base\",\n      \"bdo\",\n      \"br\",\n      \"head\",\n      \"html\",\n      \"meta\",\n      \"param\",\n      \"script\",\n      \"style\",\n      \"title\"\n      ],\n      \"attributes\":[\n      \"onclick\",\n      \"ondblclick\",\n      \"onmousedown\",\n      \"onmousemove\",\n      \"onmouseover\",\n      \"onmouseout\",\n      \"onmouseup\"\n      ]\n    }\n  },\n  \"_tags\":\n  {\n    \"a\":\n    {\n      \"attributes\":\n      {\n        \"0\":\"charset\",\n        \"1\":\"coords\",\n        \"2\":\"href\",\n        \"3\":\"hreflang\",\n        \"4\":\"name\",\n        \"rel\":/^(alternate|designates|stylesheet|start|next|prev|contents|index|glossary|copyright|chapter|section|subsection|appendix|help|bookmark| |shortcut|icon)+$/,\n        \"rev\":/^(alternate|designates|stylesheet|start|next|prev|contents|index|glossary|copyright|chapter|section|subsection|appendix|help|bookmark| |shortcut|icon)+$/,\n        \"shape\":/^(rect|rectangle|circ|circle|poly|polygon)$/,\n        \"5\":\"type\"\n      }\n    },\n    \"0\":\"abbr\",\n    \"1\":\"acronym\",\n    \"2\":\"address\",\n    \"area\":\n    {\n      \"attributes\":\n      {\n        \"0\":\"alt\",\n        \"1\":\"coords\",\n        \"2\":\"href\",\n        \"nohref\":/^(true|false)$/,\n        \"shape\":/^(rect|rectangle|circ|circle|poly|polygon)$/\n      },\n      \"required\":[\n      \"alt\"\n      ]\n    },\n    \"3\":\"b\",\n    \"base\":\n    {\n      \"attributes\":[\n      \"href\"\n      ],\n      \"required\":[\n      \"href\"\n      ]\n    },\n    \"bdo\":\n    {\n      \"attributes\":\n      {\n        \"dir\":/^(ltr|rtl)$/\n      },\n      \"required\":[\n      \"dir\"\n      ]\n    },\n    \"4\":\"big\",\n    \"blockquote\":\n    {\n      \"attributes\":[\n      \"cite\"\n      ]\n    },\n    \"5\":\"body\",\n    \"6\":\"br\",\n    \"button\":\n    {\n      \"attributes\":\n      {\n        \"disabled\":/^(disabled)$/,\n        \"type\":/^(button|reset|submit)$/,\n        \"0\":\"value\"\n      },\n      \"inside\":\"form\"\n    },\n    \"7\":\"caption\",\n    \"8\":\"cite\",\n    \"9\":\"code\",\n    \"col\":\n    {\n      \"attributes\":\n      {\n        \"align\":/^(right|left|center|justify)$/,\n        \"0\":\"char\",\n        \"1\":\"charoff\",\n        \"span\":/^(\\d)+$/,\n        \"valign\":/^(top|middle|bottom|baseline)$/,\n        \"2\":\"width\"\n      },\n      \"inside\":\"colgroup\"\n    },\n    \"colgroup\":\n    {\n      \"attributes\":\n      {\n        \"align\":/^(right|left|center|justify)$/,\n        \"0\":\"char\",\n        \"1\":\"charoff\",\n        \"span\":/^(\\d)+$/,\n        \"valign\":/^(top|middle|bottom|baseline)$/,\n        \"2\":\"width\"\n      }\n    },\n    \"10\":\"dd\",\n    \"del\":\n    {\n      \"attributes\":\n      {\n        \"0\":\"cite\",\n        \"datetime\":/^([0-9]){8}/\n      }\n    },\n    \"11\":\"div\",\n    \"12\":\"dfn\",\n    \"13\":\"dl\",\n    \"14\":\"dt\",\n    \"15\":\"em\",\n    \"fieldset\":\n    {\n      \"inside\":\"form\"\n    },\n    \"form\":\n    {\n      \"attributes\":\n      {\n        \"0\":\"action\",\n        \"1\":\"accept\",\n        \"2\":\"accept-charset\",\n        \"3\":\"enctype\",\n        \"method\":/^(get|post)$/\n      },\n      \"required\":[\n      \"action\"\n      ]\n    },\n    \"head\":\n    {\n      \"attributes\":[\n      \"profile\"\n      ]\n    },\n    \"16\":\"h1\",\n    \"17\":\"h2\",\n    \"18\":\"h3\",\n    \"19\":\"h4\",\n    \"20\":\"h5\",\n    \"21\":\"h6\",\n    \"22\":\"hr\",\n    \"html\":\n    {\n      \"attributes\":[\n      \"xmlns\"\n      ]\n    },\n    \"23\":\"i\",\n    \"img\":\n    {\n      \"attributes\":[\n      \"alt\",\n      \"src\",\n      \"height\",\n      \"ismap\",\n      \"longdesc\",\n      \"usemap\",\n      \"width\"\n      ],\n      \"required\":[\n      \"alt\",\n      \"src\"\n      ]\n    },\n    \"input\":\n    {\n      \"attributes\":\n      {\n        \"0\":\"accept\",\n        \"1\":\"alt\",\n        \"checked\":/^(checked)$/,\n        \"disabled\":/^(disabled)$/,\n        \"maxlength\":/^(\\d)+$/,\n        \"2\":\"name\",\n        \"readonly\":/^(readonly)$/,\n        \"size\":/^(\\d)+$/,\n        \"3\":\"src\",\n        \"type\":/^(button|checkbox|file|hidden|image|password|radio|reset|submit|text)$/,\n        \"4\":\"value\"\n      },\n      \"inside\":\"form\"\n    },\n    \"ins\":\n    {\n      \"attributes\":\n      {\n        \"0\":\"cite\",\n        \"datetime\":/^([0-9]){8}/\n      }\n    },\n    \"24\":\"kbd\",\n    \"label\":\n    {\n      \"attributes\":[\n      \"for\"\n      ],\n      \"inside\":\"form\"\n    },\n    \"25\":\"legend\",\n    \"26\":\"li\",\n    \"link\":\n    {\n      \"attributes\":\n      {\n        \"0\":\"charset\",\n        \"1\":\"href\",\n        \"2\":\"hreflang\",\n        \"media\":/^(all|braille|print|projection|screen|speech|,|;| )+$/i,\n        //next comment line required by Opera!\n        /*\"rel\":/^(alternate|appendix|bookmark|chapter|contents|copyright|glossary|help|home|index|next|prev|section|start|stylesheet|subsection| |shortcut|icon)+$/i,*/\n        \"rel\":/^(alternate|appendix|bookmark|chapter|contents|copyright|glossary|help|home|index|next|prev|section|start|stylesheet|subsection| |shortcut|icon)+$/i,\n        \"rev\":/^(alternate|appendix|bookmark|chapter|contents|copyright|glossary|help|home|index|next|prev|section|start|stylesheet|subsection| |shortcut|icon)+$/i,\n        \"3\":\"type\"\n      },\n      \"inside\":\"head\"\n    },\n    \"map\":\n    {\n      \"attributes\":[\n      \"id\",\n      \"name\"\n      ],\n      \"required\":[\n      \"id\"\n      ]\n    },\n    \"meta\":\n    {\n      \"attributes\":\n      {\n        \"0\":\"content\",\n        \"http-equiv\":/^(content\\-type|expires|refresh|set\\-cookie)$/i,\n        \"1\":\"name\",\n        \"2\":\"scheme\"\n      },\n      \"required\":[\n      \"content\"\n      ]\n    },\n    \"27\":\"noscript\",\n    \"object\":\n    {\n      \"attributes\":[\n      \"archive\",\n      \"classid\",\n      \"codebase\",\n      \"codetype\",\n      \"data\",\n      \"declare\",\n      \"height\",\n      \"name\",\n      \"standby\",\n      \"type\",\n      \"usemap\",\n      \"width\"\n      ]\n    },\n    \"28\":\"ol\",\n    \"optgroup\":\n    {\n      \"attributes\":\n      {\n        \"0\":\"label\",\n        \"disabled\": /^(disabled)$/\n      },\n      \"required\":[\n      \"label\"\n      ]\n    },\n    \"option\":\n    {\n      \"attributes\":\n      {\n        \"0\":\"label\",\n        \"disabled\":/^(disabled)$/,\n        \"selected\":/^(selected)$/,\n        \"1\":\"value\"\n      },\n      \"inside\":\"select\"\n    },\n    \"29\":\"p\",\n    \"param\":\n    {\n      \"attributes\":\n      {\n        \"0\":\"type\",\n        \"valuetype\":/^(data|ref|object)$/,\n        \"1\":\"valuetype\",\n        \"2\":\"value\"\n      },\n      \"required\":[\n      \"name\"\n      ]\n    },\n    \"30\":\"pre\",\n    \"q\":\n    {\n      \"attributes\":[\n      \"cite\"\n      ]\n    },\n    \"31\":\"samp\",\n    \"script\":\n    {\n      \"attributes\":\n      {\n        \"type\":/^(text\\/ecmascript|text\\/javascript|text\\/jscript|text\\/vbscript|text\\/vbs|text\\/xml)$/,\n        \"0\":\"charset\",\n        \"defer\":/^(defer)$/,\n        \"1\":\"src\"\n      },\n      \"required\":[\n      \"type\"\n      ]\n    },\n    \"select\":\n    {\n      \"attributes\":\n      {\n        \"disabled\":/^(disabled)$/,\n        \"multiple\":/^(multiple)$/,\n        \"0\":\"name\",\n        \"1\":\"size\"\n      },\n      \"inside\":\"form\"\n    },\n    \"32\":\"small\",\n    \"33\":\"span\",\n    \"34\":\"strong\",\n    \"style\":\n    {\n      \"attributes\":\n      {\n        \"0\":\"type\",\n        \"media\":/^(screen|tty|tv|projection|handheld|print|braille|aural|all)$/\n      },\n      \"required\":[\n      \"type\"\n      ]\n    },\n    \"35\":\"sub\",\n    \"36\":\"sup\",\n    \"table\":\n    {\n      \"attributes\":\n      {\n        \"0\":\"border\",\n        \"1\":\"cellpadding\",\n        \"2\":\"cellspacing\",\n        \"frame\":/^(void|above|below|hsides|lhs|rhs|vsides|box|border)$/,\n        \"rules\":/^(none|groups|rows|cols|all)$/,\n        \"3\":\"summary\",\n        \"4\":\"width\"\n      }\n    },\n    \"tbody\":\n    {\n      \"attributes\":\n      {\n        \"align\":/^(right|left|center|justify)$/,\n        \"0\":\"char\",\n        \"1\":\"charoff\",\n        \"valign\":/^(top|middle|bottom|baseline)$/\n      }\n    },\n    \"td\":\n    {\n      \"attributes\":\n      {\n        \"0\":\"abbr\",\n        \"align\":/^(left|right|center|justify|char)$/,\n        \"1\":\"axis\",\n        \"2\":\"char\",\n        \"3\":\"charoff\",\n        \"colspan\":/^(\\d)+$/,\n        \"4\":\"headers\",\n        \"rowspan\":/^(\\d)+$/,\n        \"scope\":/^(col|colgroup|row|rowgroup)$/,\n        \"valign\":/^(top|middle|bottom|baseline)$/\n      }\n    },\n    \"textarea\":\n    {\n      \"attributes\":[\n      \"cols\",\n      \"rows\",\n      \"disabled\",\n      \"name\",\n      \"readonly\"\n      ],\n      \"required\":[\n      \"cols\",\n      \"rows\"\n      ],\n      \"inside\":\"form\"\n    },\n    \"tfoot\":\n    {\n      \"attributes\":\n      {\n        \"align\":/^(right|left|center|justify)$/,\n        \"0\":\"char\",\n        \"1\":\"charoff\",\n        \"valign\":/^(top|middle|bottom)$/,\n        \"2\":\"baseline\"\n      }\n    },\n    \"th\":\n    {\n      \"attributes\":\n      {\n        \"0\":\"abbr\",\n        \"align\":/^(left|right|center|justify|char)$/,\n        \"1\":\"axis\",\n        \"2\":\"char\",\n        \"3\":\"charoff\",\n        \"colspan\":/^(\\d)+$/,\n        \"4\":\"headers\",\n        \"rowspan\":/^(\\d)+$/,\n        \"scope\":/^(col|colgroup|row|rowgroup)$/,\n        \"valign\":/^(top|middle|bottom|baseline)$/\n      }\n    },\n    \"thead\":\n    {\n      \"attributes\":\n      {\n        \"align\":/^(right|left|center|justify)$/,\n        \"0\":\"char\",\n        \"1\":\"charoff\",\n        \"valign\":/^(top|middle|bottom|baseline)$/\n      }\n    },\n    \"37\":\"title\",\n    \"tr\":\n    {\n      \"attributes\":\n      {\n        \"align\":/^(right|left|center|justify|char)$/,\n        \"0\":\"char\",\n        \"1\":\"charoff\",\n        \"valign\":/^(top|middle|bottom|baseline)$/\n      }\n    },\n    \"38\":\"tt\",\n    \"39\":\"ul\",\n    \"40\":\"var\"\n  },\n\n  // Temporary skiped attributes\n  skiped_attributes : [],\n  skiped_attribute_values : [],\n\n  getValidTagAttributes: function(tag, attributes)\n  {\n    var valid_attributes = {};\n    var possible_attributes = this.getPossibleTagAttributes(tag);\n    for(var attribute in attributes) {\n      var value = attributes[attribute];\n      var h = WYMeditor.Helper;\n      if(!h.contains(this.skiped_attributes, attribute) && !h.contains(this.skiped_attribute_values, value)){\n        if (typeof value != 'function' && h.contains(possible_attributes, attribute)) {\n          if (this.doesAttributeNeedsValidation(tag, attribute)) {\n            if(this.validateAttribute(tag, attribute, value)){\n              valid_attributes[attribute] = value;\n            }\n          }else{\n            valid_attributes[attribute] = value;\n          }\n        }\n      }\n    }\n    return valid_attributes;\n  },\n  getUniqueAttributesAndEventsForTag : function(tag)\n  {\n    var result = [];\n\n    if (this._tags[tag] && this._tags[tag]['attributes']) {\n      for (k in this._tags[tag]['attributes']) {\n        result.push(parseInt(k) == k ? this._tags[tag]['attributes'][k] : k);\n      }\n    }\n    return result;\n  },\n  getDefaultAttributesAndEventsForTags : function()\n  {\n    var result = [];\n    for (var key in this._events){\n      result.push(this._events[key]);\n    }\n    for (var key in this._attributes){\n      result.push(this._attributes[key]);\n    }\n    return result;\n  },\n  isValidTag : function(tag)\n  {\n    if(this._tags[tag]){\n      return true;\n    }\n    for(var key in this._tags){\n      if(this._tags[key] == tag){\n        return true;\n      }\n    }\n    return false;\n  },\n  getDefaultAttributesAndEventsForTag : function(tag)\n  {\n    var default_attributes = [];\n    if (this.isValidTag(tag)) {\n      var default_attributes_and_events = this.getDefaultAttributesAndEventsForTags();\n\n      for(var key in default_attributes_and_events) {\n        var defaults = default_attributes_and_events[key];\n        if(typeof defaults == 'object'){\n          var h = WYMeditor.Helper;\n          if ((defaults['except'] && h.contains(defaults['except'], tag)) || (defaults['only'] && !h.contains(defaults['only'], tag))) {\n            continue;\n          }\n\n          var tag_defaults = defaults['attributes'] ? defaults['attributes'] : defaults['events'];\n          for(var k in tag_defaults) {\n            default_attributes.push(typeof tag_defaults[k] != 'string' ? k : tag_defaults[k]);\n          }\n        }\n      }\n    }\n    return default_attributes;\n  },\n  doesAttributeNeedsValidation: function(tag, attribute)\n  {\n    return this._tags[tag] && ((this._tags[tag]['attributes'] && this._tags[tag]['attributes'][attribute]) || (this._tags[tag]['required'] &&\n     WYMeditor.Helper.contains(this._tags[tag]['required'], attribute)));\n  },\n  validateAttribute : function(tag, attribute, value)\n  {\n    if ( this._tags[tag] &&\n      (this._tags[tag]['attributes'] && this._tags[tag]['attributes'][attribute] && value.length > 0 && !value.match(this._tags[tag]['attributes'][attribute])) || // invalid format\n      (this._tags[tag] && this._tags[tag]['required'] && WYMeditor.Helper.contains(this._tags[tag]['required'], attribute) && value.length == 0) // required attribute\n    ) {\n      return false;\n    }\n    return typeof this._tags[tag] != 'undefined';\n  },\n  getPossibleTagAttributes : function(tag)\n  {\n    if (!this._possible_tag_attributes) {\n      this._possible_tag_attributes = {};\n    }\n    if (!this._possible_tag_attributes[tag]) {\n      this._possible_tag_attributes[tag] = this.getUniqueAttributesAndEventsForTag(tag).concat(this.getDefaultAttributesAndEventsForTag(tag));\n    }\n    return this._possible_tag_attributes[tag];\n  }\n};\n\n\n/**\n*    Compounded regular expression. Any of\n*    the contained patterns could match and\n*    when one does, its label is returned.\n*\n*    Constructor. Starts with no patterns.\n*    @param boolean case    True for case sensitive, false\n*                            for insensitive.\n*    @access public\n*    @author Marcus Baker (http://lastcraft.com)\n*    @author Bermi Ferrer (http://bermi.org)\n*/\nWYMeditor.ParallelRegex = function(case_sensitive)\n{\n  this._case = case_sensitive;\n  this._patterns = [];\n  this._labels = [];\n  this._regex = null;\n  return this;\n};\n\n\n/**\n*    Adds a pattern with an optional label.\n*    @param string pattern      Perl style regex, but ( and )\n*                                lose the usual meaning.\n*    @param string label        Label of regex to be returned\n*                                on a match.\n*    @access public\n*/\nWYMeditor.ParallelRegex.prototype.addPattern = function(pattern, label)\n{\n  label = label || true;\n  var count = this._patterns.length;\n  this._patterns[count] = pattern;\n  this._labels[count] = label;\n  this._regex = null;\n};\n\n/**\n*    Attempts to match all patterns at once against\n*    a string.\n*    @param string subject      String to match against.\n*\n*    @return boolean             True on success.\n*    @return string match         First matched portion of\n*                                subject.\n*    @access public\n*/\nWYMeditor.ParallelRegex.prototype.match = function(subject)\n{\n  if (this._patterns.length == 0) {\n    return [false, ''];\n  }\n  var matches = subject.match(this._getCompoundedRegex());\n\n  if(!matches){\n    return [false, ''];\n  }\n  var match = matches[0];\n  for (var i = 1; i < matches.length; i++) {\n    if (matches[i]) {\n      return [this._labels[i-1], match];\n    }\n  }\n  return [true, matches[0]];\n};\n\n/**\n*    Compounds the patterns into a single\n*    regular expression separated with the\n*    \"or\" operator. Caches the regex.\n*    Will automatically escape (, ) and / tokens.\n*    @param array patterns    List of patterns in order.\n*    @access private\n*/\nWYMeditor.ParallelRegex.prototype._getCompoundedRegex = function()\n{\n  if (this._regex == null) {\n    for (var i = 0, count = this._patterns.length; i < count; i++) {\n      this._patterns[i] = '(' + this._untokenizeRegex(this._tokenizeRegex(this._patterns[i]).replace(/([\\/\\(\\)])/g,'\\\\$1')) + ')';\n    }\n    this._regex = new RegExp(this._patterns.join(\"|\") ,this._getPerlMatchingFlags());\n  }\n  return this._regex;\n};\n\n/**\n* Escape lookahead/lookbehind blocks\n*/\nWYMeditor.ParallelRegex.prototype._tokenizeRegex = function(regex)\n{\n  return regex.\n  replace(/\\(\\?(i|m|s|x|U)\\)/,     '~~~~~~Tk1\\$1~~~~~~').\n  replace(/\\(\\?(\\-[i|m|s|x|U])\\)/, '~~~~~~Tk2\\$1~~~~~~').\n  replace(/\\(\\?\\=(.*)\\)/,          '~~~~~~Tk3\\$1~~~~~~').\n  replace(/\\(\\?\\!(.*)\\)/,          '~~~~~~Tk4\\$1~~~~~~').\n  replace(/\\(\\?\\<\\=(.*)\\)/,        '~~~~~~Tk5\\$1~~~~~~').\n  replace(/\\(\\?\\<\\!(.*)\\)/,        '~~~~~~Tk6\\$1~~~~~~').\n  replace(/\\(\\?\\:(.*)\\)/,          '~~~~~~Tk7\\$1~~~~~~');\n};\n\n/**\n* Unscape lookahead/lookbehind blocks\n*/\nWYMeditor.ParallelRegex.prototype._untokenizeRegex = function(regex)\n{\n  return regex.\n  replace(/~~~~~~Tk1(.{1})~~~~~~/,    \"(?\\$1)\").\n  replace(/~~~~~~Tk2(.{2})~~~~~~/,    \"(?\\$1)\").\n  replace(/~~~~~~Tk3(.*)~~~~~~/,      \"(?=\\$1)\").\n  replace(/~~~~~~Tk4(.*)~~~~~~/,      \"(?!\\$1)\").\n  replace(/~~~~~~Tk5(.*)~~~~~~/,      \"(?<=\\$1)\").\n  replace(/~~~~~~Tk6(.*)~~~~~~/,      \"(?<!\\$1)\").\n  replace(/~~~~~~Tk7(.*)~~~~~~/,      \"(?:\\$1)\");\n};\n\n\n/**\n*    Accessor for perl regex mode flags to use.\n*    @return string       Perl regex flags.\n*    @access private\n*/\nWYMeditor.ParallelRegex.prototype._getPerlMatchingFlags = function()\n{\n  return (this._case ? \"m\" : \"mi\");\n};\n\n\n\n/**\n*    States for a stack machine.\n*\n*    Constructor. Starts in named state.\n*    @param string start        Starting state name.\n*    @access public\n*    @author Marcus Baker (http://lastcraft.com)\n*    @author Bermi Ferrer (http://bermi.org)\n*/\nWYMeditor.StateStack = function(start)\n{\n  this._stack = [start];\n  return this;\n};\n\n/**\n*    Accessor for current state.\n*    @return string       State.\n*    @access public\n*/\nWYMeditor.StateStack.prototype.getCurrent = function()\n{\n  return this._stack[this._stack.length - 1];\n};\n\n/**\n*    Adds a state to the stack and sets it\n*    to be the current state.\n*    @param string state        New state.\n*    @access public\n*/\nWYMeditor.StateStack.prototype.enter = function(state)\n{\n  this._stack.push(state);\n};\n\n/**\n*    Leaves the current state and reverts\n*    to the previous one.\n*    @return boolean    False if we drop off\n*                       the bottom of the list.\n*    @access public\n*/\nWYMeditor.StateStack.prototype.leave = function()\n{\n  if (this._stack.length == 1) {\n    return false;\n  }\n  this._stack.pop();\n  return true;\n};\n\n\n// GLOBALS\nWYMeditor.LEXER_ENTER = 1;\nWYMeditor.LEXER_MATCHED = 2;\nWYMeditor.LEXER_UNMATCHED = 3;\nWYMeditor.LEXER_EXIT = 4;\nWYMeditor.LEXER_SPECIAL = 5;\n\n\n/**\n*    Accepts text and breaks it into tokens.\n*    Some optimisation to make the sure the\n*    content is only scanned by the PHP regex\n*    parser once. Lexer modes must not start\n*    with leading underscores.\n*\n*    Sets up the lexer in case insensitive matching\n*    by default.\n*    @param Parser parser  Handling strategy by reference.\n*    @param string start            Starting handler.\n*    @param boolean case            True for case sensitive.\n*    @access public\n*    @author Marcus Baker (http://lastcraft.com)\n*    @author Bermi Ferrer (http://bermi.org)\n*/\nWYMeditor.Lexer = function(parser, start, case_sensitive)\n{\n  start = start || 'accept';\n  this._case = case_sensitive || false;\n  this._regexes = {};\n  this._parser = parser;\n  this._mode = new WYMeditor.StateStack(start);\n  this._mode_handlers = {};\n  this._mode_handlers[start] = start;\n  return this;\n};\n\n/**\n*    Adds a token search pattern for a particular\n*    parsing mode. The pattern does not change the\n*    current mode.\n*    @param string pattern      Perl style regex, but ( and )\n*                                lose the usual meaning.\n*    @param string mode         Should only apply this\n*                                pattern when dealing with\n*                                this type of input.\n*    @access public\n*/\nWYMeditor.Lexer.prototype.addPattern = function(pattern, mode)\n{\n  var mode = mode || \"accept\";\n  if (typeof this._regexes[mode] == 'undefined') {\n    this._regexes[mode] = new WYMeditor.ParallelRegex(this._case);\n  }\n  this._regexes[mode].addPattern(pattern);\n  if (typeof this._mode_handlers[mode] == 'undefined') {\n    this._mode_handlers[mode] = mode;\n  }\n};\n\n/**\n*    Adds a pattern that will enter a new parsing\n*    mode. Useful for entering parenthesis, strings,\n*    tags, etc.\n*    @param string pattern      Perl style regex, but ( and )\n*                                lose the usual meaning.\n*    @param string mode         Should only apply this\n*                                pattern when dealing with\n*                                this type of input.\n*    @param string new_mode     Change parsing to this new\n*                                nested mode.\n*    @access public\n*/\nWYMeditor.Lexer.prototype.addEntryPattern = function(pattern, mode, new_mode)\n{\n  if (typeof this._regexes[mode] == 'undefined') {\n    this._regexes[mode] = new WYMeditor.ParallelRegex(this._case);\n  }\n  this._regexes[mode].addPattern(pattern, new_mode);\n  if (typeof this._mode_handlers[new_mode] == 'undefined') {\n    this._mode_handlers[new_mode] = new_mode;\n  }\n};\n\n/**\n*    Adds a pattern that will exit the current mode\n*    and re-enter the previous one.\n*    @param string pattern      Perl style regex, but ( and )\n*                                lose the usual meaning.\n*    @param string mode         Mode to leave.\n*    @access public\n*/\nWYMeditor.Lexer.prototype.addExitPattern = function(pattern, mode)\n{\n  if (typeof this._regexes[mode] == 'undefined') {\n    this._regexes[mode] = new WYMeditor.ParallelRegex(this._case);\n  }\n  this._regexes[mode].addPattern(pattern, \"__exit\");\n  if (typeof this._mode_handlers[mode] == 'undefined') {\n    this._mode_handlers[mode] = mode;\n  }\n};\n\n/**\n*    Adds a pattern that has a special mode. Acts as an entry\n*    and exit pattern in one go, effectively calling a special\n*    parser handler for this token only.\n*    @param string pattern      Perl style regex, but ( and )\n*                                lose the usual meaning.\n*    @param string mode         Should only apply this\n*                                pattern when dealing with\n*                                this type of input.\n*    @param string special      Use this mode for this one token.\n*    @access public\n*/\nWYMeditor.Lexer.prototype.addSpecialPattern =  function(pattern, mode, special)\n{\n  if (typeof this._regexes[mode] == 'undefined') {\n    this._regexes[mode] = new WYMeditor.ParallelRegex(this._case);\n  }\n  this._regexes[mode].addPattern(pattern, '_'+special);\n  if (typeof this._mode_handlers[special] == 'undefined') {\n    this._mode_handlers[special] = special;\n  }\n};\n\n/**\n*    Adds a mapping from a mode to another handler.\n*    @param string mode        Mode to be remapped.\n*    @param string handler     New target handler.\n*    @access public\n*/\nWYMeditor.Lexer.prototype.mapHandler = function(mode, handler)\n{\n  this._mode_handlers[mode] = handler;\n};\n\n/**\n*    Splits the page text into tokens. Will fail\n*    if the handlers report an error or if no\n*    content is consumed. If successful then each\n*    unparsed and parsed token invokes a call to the\n*    held listener.\n*    @param string raw        Raw HTML text.\n*    @return boolean           True on success, else false.\n*    @access public\n*/\nWYMeditor.Lexer.prototype.parse = function(raw)\n{\n  if (typeof this._parser == 'undefined') {\n    return false;\n  }\n\n  var length = raw.length;\n  var parsed;\n  while (typeof (parsed = this._reduce(raw)) == 'object') {\n    var raw = parsed[0];\n    var unmatched = parsed[1];\n    var matched = parsed[2];\n    var mode = parsed[3];\n\n    if (! this._dispatchTokens(unmatched, matched, mode)) {\n      return false;\n    }\n\n    if (raw == '') {\n      return true;\n    }\n    if (raw.length == length) {\n      return false;\n    }\n    length = raw.length;\n  }\n  if (! parsed ) {\n    return false;\n  }\n\n  return this._invokeParser(raw, WYMeditor.LEXER_UNMATCHED);\n};\n\n/**\n*    Sends the matched token and any leading unmatched\n*    text to the parser changing the lexer to a new\n*    mode if one is listed.\n*    @param string unmatched    Unmatched leading portion.\n*    @param string matched      Actual token match.\n*    @param string mode         Mode after match. A boolean\n*                                false mode causes no change.\n*    @return boolean             False if there was any error\n*                                from the parser.\n*    @access private\n*/\nWYMeditor.Lexer.prototype._dispatchTokens = function(unmatched, matched, mode)\n{\n  mode = mode || false;\n\n  if (! this._invokeParser(unmatched, WYMeditor.LEXER_UNMATCHED)) {\n    return false;\n  }\n\n  if (typeof mode == 'boolean') {\n    return this._invokeParser(matched, WYMeditor.LEXER_MATCHED);\n  }\n  if (this._isModeEnd(mode)) {\n    if (! this._invokeParser(matched, WYMeditor.LEXER_EXIT)) {\n      return false;\n    }\n    return this._mode.leave();\n  }\n  if (this._isSpecialMode(mode)) {\n    this._mode.enter(this._decodeSpecial(mode));\n    if (! this._invokeParser(matched, WYMeditor.LEXER_SPECIAL)) {\n      return false;\n    }\n    return this._mode.leave();\n  }\n  this._mode.enter(mode);\n\n  return this._invokeParser(matched, WYMeditor.LEXER_ENTER);\n};\n\n/**\n*    Tests to see if the new mode is actually to leave\n*    the current mode and pop an item from the matching\n*    mode stack.\n*    @param string mode    Mode to test.\n*    @return boolean        True if this is the exit mode.\n*    @access private\n*/\nWYMeditor.Lexer.prototype._isModeEnd = function(mode)\n{\n  return (mode === \"__exit\");\n};\n\n/**\n*    Test to see if the mode is one where this mode\n*    is entered for this token only and automatically\n*    leaves immediately afterwoods.\n*    @param string mode    Mode to test.\n*    @return boolean        True if this is the exit mode.\n*    @access private\n*/\nWYMeditor.Lexer.prototype._isSpecialMode = function(mode)\n{\n  return (mode.substring(0,1) == \"_\");\n};\n\n/**\n*    Strips the magic underscore marking single token\n*    modes.\n*    @param string mode    Mode to decode.\n*    @return string         Underlying mode name.\n*    @access private\n*/\nWYMeditor.Lexer.prototype._decodeSpecial = function(mode)\n{\n  return mode.substring(1);\n};\n\n/**\n*    Calls the parser method named after the current\n*    mode. Empty content will be ignored. The lexer\n*    has a parser handler for each mode in the lexer.\n*    @param string content        Text parsed.\n*    @param boolean is_match      Token is recognised rather\n*                                  than unparsed data.\n*    @access private\n*/\nWYMeditor.Lexer.prototype._invokeParser = function(content, is_match)\n{\n\n  if (!/ +/.test(content) && ((content === '') || (content == false))) {\n    return true;\n  }\n  var current = this._mode.getCurrent();\n  var handler = this._mode_handlers[current];\n  var result;\n  eval('result = this._parser.' + handler + '(content, is_match);');\n  return result;\n};\n\n/**\n*    Tries to match a chunk of text and if successful\n*    removes the recognised chunk and any leading\n*    unparsed data. Empty strings will not be matched.\n*    @param string raw         The subject to parse. This is the\n*                               content that will be eaten.\n*    @return array/boolean      Three item list of unparsed\n*                               content followed by the\n*                               recognised token and finally the\n*                               action the parser is to take.\n*                               True if no match, false if there\n*                               is a parsing error.\n*    @access private\n*/\nWYMeditor.Lexer.prototype._reduce = function(raw)\n{\n  var matched = this._regexes[this._mode.getCurrent()].match(raw);\n  var match = matched[1];\n  var action = matched[0];\n  if (action) {\n    var unparsed_character_count = raw.indexOf(match);\n    var unparsed = raw.substr(0, unparsed_character_count);\n    raw = raw.substring(unparsed_character_count + match.length);\n    return [raw, unparsed, match, action];\n  }\n  return true;\n};\n\n\n\n/**\n* This are the rules for breaking the XHTML code into events\n* handled by the provided parser.\n*\n*    @author Marcus Baker (http://lastcraft.com)\n*    @author Bermi Ferrer (http://bermi.org)\n*/\nWYMeditor.XhtmlLexer = function(parser)\n{\n  jQuery.extend(this, new WYMeditor.Lexer(parser, 'Text'));\n\n  this.mapHandler('Text', 'Text');\n\n  this.addTokens();\n\n  this.init();\n\n  return this;\n};\n\n\nWYMeditor.XhtmlLexer.prototype.init = function()\n{\n};\n\nWYMeditor.XhtmlLexer.prototype.addTokens = function()\n{\n  this.addCommentTokens('Text');\n  this.addScriptTokens('Text');\n  this.addCssTokens('Text');\n  this.addTagTokens('Text');\n};\n\nWYMeditor.XhtmlLexer.prototype.addCommentTokens = function(scope)\n{\n  this.addEntryPattern(\"<!--\", scope, 'Comment');\n  this.addExitPattern(\"-->\", 'Comment');\n};\n\nWYMeditor.XhtmlLexer.prototype.addScriptTokens = function(scope)\n{\n  this.addEntryPattern(\"<script\", scope, 'Script');\n  this.addExitPattern(\"</script>\", 'Script');\n};\n\nWYMeditor.XhtmlLexer.prototype.addCssTokens = function(scope)\n{\n  this.addEntryPattern(\"<style\", scope, 'Css');\n  this.addExitPattern(\"</style>\", 'Css');\n};\n\nWYMeditor.XhtmlLexer.prototype.addTagTokens = function(scope)\n{\n  this.addSpecialPattern(\"<\\\\s*[a-z0-9:\\-]+\\\\s*>\", scope, 'OpeningTag');\n  this.addEntryPattern(\"<[a-z0-9:\\-]+\"+'[\\\\\\/ \\\\\\>]+', scope, 'OpeningTag');\n  this.addInTagDeclarationTokens('OpeningTag');\n\n  this.addSpecialPattern(\"</\\\\s*[a-z0-9:\\-]+\\\\s*>\", scope, 'ClosingTag');\n\n};\n\nWYMeditor.XhtmlLexer.prototype.addInTagDeclarationTokens = function(scope)\n{\n  this.addSpecialPattern('\\\\s+', scope, 'Ignore');\n\n  this.addAttributeTokens(scope);\n\n  this.addExitPattern('/>', scope);\n  this.addExitPattern('>', scope);\n\n};\n\nWYMeditor.XhtmlLexer.prototype.addAttributeTokens = function(scope)\n{\n  this.addSpecialPattern(\"\\\\s*[a-z-_0-9]*:?[a-z-_0-9]+\\\\s*(?=\\=)\\\\s*\", scope, 'TagAttributes');\n\n  this.addEntryPattern('=\\\\s*\"', scope, 'DoubleQuotedAttribute');\n  this.addPattern(\"\\\\\\\\\\\"\", 'DoubleQuotedAttribute');\n  this.addExitPattern('\"', 'DoubleQuotedAttribute');\n\n  this.addEntryPattern(\"=\\\\s*'\", scope, 'SingleQuotedAttribute');\n  this.addPattern(\"\\\\\\\\'\", 'SingleQuotedAttribute');\n  this.addExitPattern(\"'\", 'SingleQuotedAttribute');\n\n  this.addSpecialPattern('=\\\\s*[^>\\\\s]*', scope, 'UnquotedAttribute');\n};\n\n\n\n/**\n* XHTML Parser.\n*\n* This XHTML parser will trigger the events available on on\n* current SaxListener\n*\n*    @author Bermi Ferrer (http://bermi.org)\n*/\nWYMeditor.XhtmlParser = function(Listener, mode)\n{\n  var mode = mode || 'Text';\n  this._Lexer = new WYMeditor.XhtmlLexer(this);\n  this._Listener = Listener;\n  this._mode = mode;\n  this._matches = [];\n  this._last_match = '';\n  this._current_match = '';\n\n  return this;\n};\n\nWYMeditor.XhtmlParser.prototype.parse = function(raw)\n{\n  this._Lexer.parse(this.beforeParsing(raw));\n  return this.afterParsing(this._Listener.getResult());\n};\n\nWYMeditor.XhtmlParser.prototype.beforeParsing = function(raw)\n{\n  if(raw.match(/class=\"MsoNormal\"/) || raw.match(/ns = \"urn:schemas-microsoft-com/)){\n    // Usefull for cleaning up content pasted from other sources (MSWord)\n    this._Listener.avoidStylingTagsAndAttributes();\n  }\n  return this._Listener.beforeParsing(raw);\n};\n\nWYMeditor.XhtmlParser.prototype.afterParsing = function(parsed)\n{\n  if(this._Listener._avoiding_tags_implicitly){\n    this._Listener.allowStylingTagsAndAttributes();\n  }\n  return this._Listener.afterParsing(parsed);\n};\n\n\nWYMeditor.XhtmlParser.prototype.Ignore = function(match, state)\n{\n  return true;\n};\n\nWYMeditor.XhtmlParser.prototype.Text = function(text)\n{\n  this._Listener.addContent(text);\n  return true;\n};\n\nWYMeditor.XhtmlParser.prototype.Comment = function(match, status)\n{\n  return this._addNonTagBlock(match, status, 'addComment');\n};\n\nWYMeditor.XhtmlParser.prototype.Script = function(match, status)\n{\n  return this._addNonTagBlock(match, status, 'addScript');\n};\n\nWYMeditor.XhtmlParser.prototype.Css = function(match, status)\n{\n  return this._addNonTagBlock(match, status, 'addCss');\n};\n\nWYMeditor.XhtmlParser.prototype._addNonTagBlock = function(match, state, type)\n{\n  switch (state){\n    case WYMeditor.LEXER_ENTER:\n    this._non_tag = match;\n    break;\n    case WYMeditor.LEXER_UNMATCHED:\n    this._non_tag += match;\n    break;\n    case WYMeditor.LEXER_EXIT:\n    switch(type) {\n      case 'addComment':\n      this._Listener.addComment(this._non_tag+match);\n      break;\n      case 'addScript':\n      this._Listener.addScript(this._non_tag+match);\n      break;\n      case 'addCss':\n      this._Listener.addCss(this._non_tag+match);\n      break;\n    }\n  }\n  return true;\n};\n\nWYMeditor.XhtmlParser.prototype.OpeningTag = function(match, state)\n{\n  switch (state){\n    case WYMeditor.LEXER_ENTER:\n    this._tag = this.normalizeTag(match);\n    this._tag_attributes = {};\n    break;\n    case WYMeditor.LEXER_SPECIAL:\n    this._callOpenTagListener(this.normalizeTag(match));\n    break;\n    case WYMeditor.LEXER_EXIT:\n    this._callOpenTagListener(this._tag, this._tag_attributes);\n  }\n  return true;\n};\n\nWYMeditor.XhtmlParser.prototype.ClosingTag = function(match, state)\n{\n  this._callCloseTagListener(this.normalizeTag(match));\n  return true;\n};\n\nWYMeditor.XhtmlParser.prototype._callOpenTagListener = function(tag, attributes)\n{\n  var  attributes = attributes || {};\n  this.autoCloseUnclosedBeforeNewOpening(tag);\n\n  if(this._Listener.isBlockTag(tag)){\n    this._Listener._tag_stack.push(tag);\n    this._Listener.fixNestingBeforeOpeningBlockTag(tag, attributes);\n    this._Listener.openBlockTag(tag, attributes);\n    this._increaseOpenTagCounter(tag);\n  }else if(this._Listener.isInlineTag(tag)){\n    this._Listener.inlineTag(tag, attributes);\n  }else{\n    this._Listener.openUnknownTag(tag, attributes);\n    this._increaseOpenTagCounter(tag);\n  }\n  this._Listener.last_tag = tag;\n  this._Listener.last_tag_opened = true;\n  this._Listener.last_tag_attributes = attributes;\n};\n\nWYMeditor.XhtmlParser.prototype._callCloseTagListener = function(tag)\n{\n  if(this._decreaseOpenTagCounter(tag)){\n    this.autoCloseUnclosedBeforeTagClosing(tag);\n\n    if(this._Listener.isBlockTag(tag)){\n      var expected_tag = this._Listener._tag_stack.pop();\n      if(expected_tag == false){\n        return;\n      }else if(expected_tag != tag){\n        tag = expected_tag;\n      }\n      this._Listener.closeBlockTag(tag);\n    }else{\n      this._Listener.closeUnknownTag(tag);\n    }\n  }else{\n    this._Listener.closeUnopenedTag(tag);\n  }\n  this._Listener.last_tag = tag;\n  this._Listener.last_tag_opened = false;\n};\n\nWYMeditor.XhtmlParser.prototype._increaseOpenTagCounter = function(tag)\n{\n  this._Listener._open_tags[tag] = this._Listener._open_tags[tag] || 0;\n  this._Listener._open_tags[tag]++;\n};\n\nWYMeditor.XhtmlParser.prototype._decreaseOpenTagCounter = function(tag)\n{\n  if(this._Listener._open_tags[tag]){\n    this._Listener._open_tags[tag]--;\n    if(this._Listener._open_tags[tag] == 0){\n      this._Listener._open_tags[tag] = undefined;\n    }\n    return true;\n  }\n  return false;\n};\n\nWYMeditor.XhtmlParser.prototype.autoCloseUnclosedBeforeNewOpening = function(new_tag)\n{\n  this._autoCloseUnclosed(new_tag, false);\n};\n\nWYMeditor.XhtmlParser.prototype.autoCloseUnclosedBeforeTagClosing = function(tag)\n{\n  this._autoCloseUnclosed(tag, true);\n};\n\nWYMeditor.XhtmlParser.prototype._autoCloseUnclosed = function(new_tag, closing)\n{\n  var closing = closing || false;\n  if(this._Listener._open_tags){\n    for (var tag in this._Listener._open_tags) {\n      var counter = this._Listener._open_tags[tag];\n      if(counter > 0 && this._Listener.shouldCloseTagAutomatically(tag, new_tag, closing)){\n        this._callCloseTagListener(tag, true);\n      }\n    }\n  }\n};\n\nWYMeditor.XhtmlParser.prototype.getTagReplacements = function()\n{\n  return this._Listener.getTagReplacements();\n};\n\nWYMeditor.XhtmlParser.prototype.normalizeTag = function(tag)\n{\n  tag = tag.replace(/^([\\s<\\/>]*)|([\\s<\\/>]*)$/gm,'').toLowerCase();\n  var tags = this._Listener.getTagReplacements();\n  if(tags[tag]){\n    return tags[tag];\n  }\n  return tag;\n};\n\nWYMeditor.XhtmlParser.prototype.TagAttributes = function(match, state)\n{\n  if(WYMeditor.LEXER_SPECIAL == state){\n    this._current_attribute = match;\n  }\n  return true;\n};\n\nWYMeditor.XhtmlParser.prototype.DoubleQuotedAttribute = function(match, state)\n{\n  if(WYMeditor.LEXER_UNMATCHED == state){\n    this._tag_attributes[this._current_attribute] = match;\n  }\n  return true;\n};\n\nWYMeditor.XhtmlParser.prototype.SingleQuotedAttribute = function(match, state)\n{\n  if(WYMeditor.LEXER_UNMATCHED == state){\n    this._tag_attributes[this._current_attribute] = match;\n  }\n  return true;\n};\n\nWYMeditor.XhtmlParser.prototype.UnquotedAttribute = function(match, state)\n{\n  this._tag_attributes[this._current_attribute] = match.replace(/^=/,'');\n  return true;\n};\n\n\n\n/**\n* XHTML Sax parser.\n*\n*    @author Bermi Ferrer (http://bermi.org)\n*/\nWYMeditor.XhtmlSaxListener = function()\n{\n  this.output = '';\n  this.helper = new WYMeditor.XmlHelper();\n  this._open_tags = {};\n  this.validator = WYMeditor.XhtmlValidator;\n  this._tag_stack = [];\n  this.avoided_tags = [];\n\n  this.entities = {\n    '&nbsp;':'&#160;','&iexcl;':'&#161;','&cent;':'&#162;',\n    '&pound;':'&#163;','&curren;':'&#164;','&yen;':'&#165;',\n    '&brvbar;':'&#166;','&sect;':'&#167;','&uml;':'&#168;',\n    '&copy;':'&#169;','&ordf;':'&#170;','&laquo;':'&#171;',\n    '&not;':'&#172;','&shy;':'&#173;','&reg;':'&#174;',\n    '&macr;':'&#175;','&deg;':'&#176;','&plusmn;':'&#177;',\n    '&sup2;':'&#178;','&sup3;':'&#179;','&acute;':'&#180;',\n    '&micro;':'&#181;','&para;':'&#182;','&middot;':'&#183;',\n    '&cedil;':'&#184;','&sup1;':'&#185;','&ordm;':'&#186;',\n    '&raquo;':'&#187;','&frac14;':'&#188;','&frac12;':'&#189;',\n    '&frac34;':'&#190;','&iquest;':'&#191;','&Agrave;':'&#192;',\n    '&Aacute;':'&#193;','&Acirc;':'&#194;','&Atilde;':'&#195;',\n    '&Auml;':'&#196;','&Aring;':'&#197;','&AElig;':'&#198;',\n    '&Ccedil;':'&#199;','&Egrave;':'&#200;','&Eacute;':'&#201;',\n    '&Ecirc;':'&#202;','&Euml;':'&#203;','&Igrave;':'&#204;',\n    '&Iacute;':'&#205;','&Icirc;':'&#206;','&Iuml;':'&#207;',\n    '&ETH;':'&#208;','&Ntilde;':'&#209;','&Ograve;':'&#210;',\n    '&Oacute;':'&#211;','&Ocirc;':'&#212;','&Otilde;':'&#213;',\n    '&Ouml;':'&#214;','&times;':'&#215;','&Oslash;':'&#216;',\n    '&Ugrave;':'&#217;','&Uacute;':'&#218;','&Ucirc;':'&#219;',\n    '&Uuml;':'&#220;','&Yacute;':'&#221;','&THORN;':'&#222;',\n    '&szlig;':'&#223;','&agrave;':'&#224;','&aacute;':'&#225;',\n    '&acirc;':'&#226;','&atilde;':'&#227;','&auml;':'&#228;',\n    '&aring;':'&#229;','&aelig;':'&#230;','&ccedil;':'&#231;',\n    '&egrave;':'&#232;','&eacute;':'&#233;','&ecirc;':'&#234;',\n    '&euml;':'&#235;','&igrave;':'&#236;','&iacute;':'&#237;',\n    '&icirc;':'&#238;','&iuml;':'&#239;','&eth;':'&#240;',\n    '&ntilde;':'&#241;','&ograve;':'&#242;','&oacute;':'&#243;',\n    '&ocirc;':'&#244;','&otilde;':'&#245;','&ouml;':'&#246;',\n    '&divide;':'&#247;','&oslash;':'&#248;','&ugrave;':'&#249;',\n    '&uacute;':'&#250;','&ucirc;':'&#251;','&uuml;':'&#252;',\n    '&yacute;':'&#253;','&thorn;':'&#254;','&yuml;':'&#255;',\n    '&OElig;':'&#338;','&oelig;':'&#339;','&Scaron;':'&#352;',\n    '&scaron;':'&#353;','&Yuml;':'&#376;','&fnof;':'&#402;',\n    '&circ;':'&#710;','&tilde;':'&#732;','&Alpha;':'&#913;',\n    '&Beta;':'&#914;','&Gamma;':'&#915;','&Delta;':'&#916;',\n    '&Epsilon;':'&#917;','&Zeta;':'&#918;','&Eta;':'&#919;',\n    '&Theta;':'&#920;','&Iota;':'&#921;','&Kappa;':'&#922;',\n    '&Lambda;':'&#923;','&Mu;':'&#924;','&Nu;':'&#925;',\n    '&Xi;':'&#926;','&Omicron;':'&#927;','&Pi;':'&#928;',\n    '&Rho;':'&#929;','&Sigma;':'&#931;','&Tau;':'&#932;',\n    '&Upsilon;':'&#933;','&Phi;':'&#934;','&Chi;':'&#935;',\n    '&Psi;':'&#936;','&Omega;':'&#937;','&alpha;':'&#945;',\n    '&beta;':'&#946;','&gamma;':'&#947;','&delta;':'&#948;',\n    '&epsilon;':'&#949;','&zeta;':'&#950;','&eta;':'&#951;',\n    '&theta;':'&#952;','&iota;':'&#953;','&kappa;':'&#954;',\n    '&lambda;':'&#955;','&mu;':'&#956;','&nu;':'&#957;',\n    '&xi;':'&#958;','&omicron;':'&#959;','&pi;':'&#960;',\n    '&rho;':'&#961;','&sigmaf;':'&#962;','&sigma;':'&#963;',\n    '&tau;':'&#964;','&upsilon;':'&#965;','&phi;':'&#966;',\n    '&chi;':'&#967;','&psi;':'&#968;','&omega;':'&#969;',\n    '&thetasym;':'&#977;','&upsih;':'&#978;','&piv;':'&#982;',\n    '&ensp;':'&#8194;','&emsp;':'&#8195;','&thinsp;':'&#8201;',\n    '&zwnj;':'&#8204;','&zwj;':'&#8205;','&lrm;':'&#8206;',\n    '&rlm;':'&#8207;','&ndash;':'&#8211;','&mdash;':'&#8212;',\n    '&lsquo;':'&#8216;','&rsquo;':'&#8217;','&sbquo;':'&#8218;',\n    '&ldquo;':'&#8220;','&rdquo;':'&#8221;','&bdquo;':'&#8222;',\n    '&dagger;':'&#8224;','&Dagger;':'&#8225;','&bull;':'&#8226;',\n    '&hellip;':'&#8230;','&permil;':'&#8240;','&prime;':'&#8242;',\n    '&Prime;':'&#8243;','&lsaquo;':'&#8249;','&rsaquo;':'&#8250;',\n    '&oline;':'&#8254;','&frasl;':'&#8260;','&euro;':'&#8364;',\n    '&image;':'&#8465;','&weierp;':'&#8472;','&real;':'&#8476;',\n    '&trade;':'&#8482;','&alefsym;':'&#8501;','&larr;':'&#8592;',\n    '&uarr;':'&#8593;','&rarr;':'&#8594;','&darr;':'&#8595;',\n    '&harr;':'&#8596;','&crarr;':'&#8629;','&lArr;':'&#8656;',\n    '&uArr;':'&#8657;','&rArr;':'&#8658;','&dArr;':'&#8659;',\n    '&hArr;':'&#8660;','&forall;':'&#8704;','&part;':'&#8706;',\n    '&exist;':'&#8707;','&empty;':'&#8709;','&nabla;':'&#8711;',\n    '&isin;':'&#8712;','&notin;':'&#8713;','&ni;':'&#8715;',\n    '&prod;':'&#8719;','&sum;':'&#8721;','&minus;':'&#8722;',\n    '&lowast;':'&#8727;','&radic;':'&#8730;','&prop;':'&#8733;',\n    '&infin;':'&#8734;','&ang;':'&#8736;','&and;':'&#8743;',\n    '&or;':'&#8744;','&cap;':'&#8745;','&cup;':'&#8746;',\n    '&int;':'&#8747;','&there4;':'&#8756;','&sim;':'&#8764;',\n    '&cong;':'&#8773;','&asymp;':'&#8776;','&ne;':'&#8800;',\n    '&equiv;':'&#8801;','&le;':'&#8804;','&ge;':'&#8805;',\n    '&sub;':'&#8834;','&sup;':'&#8835;','&nsub;':'&#8836;',\n    '&sube;':'&#8838;','&supe;':'&#8839;','&oplus;':'&#8853;',\n    '&otimes;':'&#8855;','&perp;':'&#8869;','&sdot;':'&#8901;',\n    '&lceil;':'&#8968;','&rceil;':'&#8969;','&lfloor;':'&#8970;',\n    '&rfloor;':'&#8971;','&lang;':'&#9001;','&rang;':'&#9002;',\n    '&loz;':'&#9674;','&spades;':'&#9824;','&clubs;':'&#9827;',\n    '&hearts;':'&#9829;','&diams;':'&#9830;'};\n\n    this.block_tags = [\"a\", \"abbr\", \"acronym\", \"address\", \"area\", \"b\",\n    \"base\", \"bdo\", \"big\", \"blockquote\", \"body\", \"button\",\n    \"caption\", \"cite\", \"code\", \"col\", \"colgroup\", \"dd\", \"del\", \"div\",\n    \"dfn\", \"dl\", \"dt\", \"em\", \"fieldset\", \"form\", \"head\", \"h1\", \"h2\",\n    \"h3\", \"h4\", \"h5\", \"h6\", \"html\", \"i\", \"ins\",\n    \"kbd\", \"label\", \"legend\", \"li\", \"map\", \"noscript\",\n    \"object\", \"ol\", \"optgroup\", \"option\", \"p\", \"param\", \"pre\", \"q\",\n    \"samp\", \"script\", \"select\", \"small\", \"span\", \"strong\", \"style\",\n    \"sub\", \"sup\", \"table\", \"tbody\", \"td\", \"textarea\", \"tfoot\", \"th\",\n    \"thead\", \"title\", \"tr\", \"tt\", \"ul\", \"var\", \"extends\"];\n\n\n    this.inline_tags = [\"br\", \"hr\", \"img\", \"input\"];\n\n    return this;\n};\n\nWYMeditor.XhtmlSaxListener.prototype.shouldCloseTagAutomatically = function(tag, now_on_tag, closing)\n{\n  var closing = closing || false;\n  if(tag == 'td'){\n    if((closing && now_on_tag == 'tr') || (!closing && now_on_tag == 'td')){\n      return true;\n    }\n  }\n  if(tag == 'option'){\n    if((closing && now_on_tag == 'select') || (!closing && now_on_tag == 'option')){\n      return true;\n    }\n  }\n  return false;\n};\n\nWYMeditor.XhtmlSaxListener.prototype.beforeParsing = function(raw)\n{\n  this.output = '';\n  return raw;\n};\n\nWYMeditor.XhtmlSaxListener.prototype.afterParsing = function(xhtml)\n{\n  xhtml = this.replaceNamedEntities(xhtml);\n  xhtml = this.joinRepeatedEntities(xhtml);\n  xhtml = this.removeEmptyTags(xhtml);\n  xhtml = this.removeBrInPre(xhtml);\n  return xhtml;\n};\n\nWYMeditor.XhtmlSaxListener.prototype.replaceNamedEntities = function(xhtml)\n{\n  for (var entity in this.entities) {\n    xhtml = xhtml.replace(new RegExp(entity, 'g'), this.entities[entity]);\n  }\n  return xhtml;\n};\n\nWYMeditor.XhtmlSaxListener.prototype.joinRepeatedEntities = function(xhtml)\n{\n  var tags = 'em|strong|sub|sup|acronym|pre|del|address';\n  return xhtml.replace(new RegExp('<\\/('+tags+')><\\\\1>' ,''),'').\n  replace(new RegExp('(\\s*<('+tags+')>\\s*){2}(.*)(\\s*<\\/\\\\2>\\s*){2}' ,''),'<\\$2>\\$3<\\$2>');\n};\n\n// keep empty paragraphs\n// from: http://forum.wymeditor.org/forum/viewtopic.php?f=2&t=711#p2430\n//WYMeditor.XhtmlSaxListener.prototype.removeEmptyTags = function(xhtml)\n//{\n//  return xhtml.replace(new RegExp('<('+this.block_tags.join(\"|\").replace(/\\|td/,'')\n//\t.replace(/\\|th/, '')+')>(<br \\/>|&#160;|&nbsp;|\\\\s)*<\\/\\\\1>' ,'g'),'');\n//};\nWYMeditor.XhtmlSaxListener.prototype.removeEmptyTags = function(xhtml)\n{\n  return xhtml.replace(new RegExp('<('+this.block_tags.join(\"|\").replace(/\\|td/,'').replace(/\\|p/,'')\n\t.replace(/\\|th/, '')+')>(<br \\/>|&#160;|&nbsp;|\\\\s)*<\\/\\\\1>' ,'g'),'');\n};\n\nWYMeditor.XhtmlSaxListener.prototype.removeBrInPre = function(xhtml)\n{\n  var matches = xhtml.match(new RegExp('<pre[^>]*>(.*?)<\\/pre>','gmi'));\n  if(matches) {\n    for(var i=0; i<matches.length; i++) {\n      xhtml = xhtml.replace(matches[i], matches[i].replace(new RegExp('<br \\/>', 'g'), String.fromCharCode(13,10)));\n    }\n  }\n  return xhtml;\n};\n\nWYMeditor.XhtmlSaxListener.prototype.getResult = function()\n{\n  return this.output;\n};\n\nWYMeditor.XhtmlSaxListener.prototype.getTagReplacements = function()\n{\n  return {'b':'strong', 'i':'em'};\n};\n\nWYMeditor.XhtmlSaxListener.prototype.addContent = function(text)\n{\n  this.output += text;\n};\n\nWYMeditor.XhtmlSaxListener.prototype.addComment = function(text)\n{\n  if(this.remove_comments){\n    this.output += text;\n  }\n};\n\nWYMeditor.XhtmlSaxListener.prototype.addScript = function(text)\n{\n  if(!this.remove_scripts){\n    this.output += text;\n  }\n};\n\nWYMeditor.XhtmlSaxListener.prototype.addCss = function(text)\n{\n  if(!this.remove_embeded_styles){\n    this.output += text;\n  }\n};\n\nWYMeditor.XhtmlSaxListener.prototype.openBlockTag = function(tag, attributes)\n{\n  this.output += this.helper.tag(tag, this.validator.getValidTagAttributes(tag, attributes), true);\n};\n\nWYMeditor.XhtmlSaxListener.prototype.inlineTag = function(tag, attributes)\n{\n  this.output += this.helper.tag(tag, this.validator.getValidTagAttributes(tag, attributes));\n};\n\nWYMeditor.XhtmlSaxListener.prototype.openUnknownTag = function(tag, attributes)\n{\n  //this.output += this.helper.tag(tag, attributes, true);\n};\n\nWYMeditor.XhtmlSaxListener.prototype.closeBlockTag = function(tag)\n{\n  this.output = this.output.replace(/<br \\/>$/, '')+this._getClosingTagContent('before', tag)+\"</\"+tag+\">\"+this._getClosingTagContent('after', tag);\n};\n\nWYMeditor.XhtmlSaxListener.prototype.closeUnknownTag = function(tag)\n{\n  //this.output += \"</\"+tag+\">\";\n};\n\nWYMeditor.XhtmlSaxListener.prototype.closeUnopenedTag = function(tag)\n{\n  this.output += \"</\"+tag+\">\";\n};\n\nWYMeditor.XhtmlSaxListener.prototype.avoidStylingTagsAndAttributes = function()\n{\n  this.avoided_tags = ['div','span'];\n  this.validator.skiped_attributes = ['style'];\n  this.validator.skiped_attribute_values = ['MsoNormal','main1']; // MS Word attributes for class\n  this._avoiding_tags_implicitly = true;\n};\n\nWYMeditor.XhtmlSaxListener.prototype.allowStylingTagsAndAttributes = function()\n{\n  this.avoided_tags = [];\n  this.validator.skiped_attributes = [];\n  this.validator.skiped_attribute_values = [];\n  this._avoiding_tags_implicitly = false;\n};\n\nWYMeditor.XhtmlSaxListener.prototype.isBlockTag = function(tag)\n{\n  return !WYMeditor.Helper.contains(this.avoided_tags, tag) && WYMeditor.Helper.contains(this.block_tags, tag);\n};\n\nWYMeditor.XhtmlSaxListener.prototype.isInlineTag = function(tag)\n{\n  return !WYMeditor.Helper.contains(this.avoided_tags, tag) && WYMeditor.Helper.contains(this.inline_tags, tag);\n};\n\nWYMeditor.XhtmlSaxListener.prototype.insertContentAfterClosingTag = function(tag, content)\n{\n  this._insertContentWhenClosingTag('after', tag, content);\n};\n\nWYMeditor.XhtmlSaxListener.prototype.insertContentBeforeClosingTag = function(tag, content)\n{\n  this._insertContentWhenClosingTag('before', tag, content);\n};\n\nWYMeditor.XhtmlSaxListener.prototype.fixNestingBeforeOpeningBlockTag = function(tag, attributes)\n{\n    if(tag != 'li' && (tag == 'ul' || tag == 'ol') && this.last_tag && !this.last_tag_opened && this.last_tag == 'li'){\n      this.output = this.output.replace(/<\\/li>$/, '');\n      this.insertContentAfterClosingTag(tag, '</li>');\n    }\n};\n\nWYMeditor.XhtmlSaxListener.prototype._insertContentWhenClosingTag = function(position, tag, content)\n{\n  if(!this['_insert_'+position+'_closing']){\n    this['_insert_'+position+'_closing'] = [];\n  }\n  if(!this['_insert_'+position+'_closing'][tag]){\n    this['_insert_'+position+'_closing'][tag] = [];\n  }\n  this['_insert_'+position+'_closing'][tag].push(content);\n};\n\nWYMeditor.XhtmlSaxListener.prototype._getClosingTagContent = function(position, tag)\n{\n  if( this['_insert_'+position+'_closing'] &&\n      this['_insert_'+position+'_closing'][tag] &&\n      this['_insert_'+position+'_closing'][tag].length > 0){\n        return this['_insert_'+position+'_closing'][tag].pop();\n  }\n  return '';\n};\n\n\n/********** CSS PARSER **********/\n\n\nWYMeditor.WymCssLexer = function(parser, only_wym_blocks)\n{\n  var only_wym_blocks = (typeof only_wym_blocks == 'undefined' ? true : only_wym_blocks);\n\n  jQuery.extend(this, new WYMeditor.Lexer(parser, (only_wym_blocks?'Ignore':'WymCss')));\n\n  this.mapHandler('WymCss', 'Ignore');\n\n  if(only_wym_blocks == true){\n    this.addEntryPattern(\"/\\\\\\x2a[<\\\\s]*WYMeditor[>\\\\s]*\\\\\\x2a/\", 'Ignore', 'WymCss');\n    this.addExitPattern(\"/\\\\\\x2a[<\\/\\\\s]*WYMeditor[>\\\\s]*\\\\\\x2a/\", 'WymCss');\n  }\n\n  this.addSpecialPattern(\"[\\\\sa-z1-6]*\\\\\\x2e[a-z-_0-9]+\", 'WymCss', 'WymCssStyleDeclaration');\n\n  this.addEntryPattern(\"/\\\\\\x2a\", 'WymCss', 'WymCssComment');\n  this.addExitPattern(\"\\\\\\x2a/\", 'WymCssComment');\n\n  this.addEntryPattern(\"\\x7b\", 'WymCss', 'WymCssStyle');\n  this.addExitPattern(\"\\x7d\", 'WymCssStyle');\n\n  this.addEntryPattern(\"/\\\\\\x2a\", 'WymCssStyle', 'WymCssFeedbackStyle');\n  this.addExitPattern(\"\\\\\\x2a/\", 'WymCssFeedbackStyle');\n\n  return this;\n};\n\nWYMeditor.WymCssParser = function()\n{\n  this._in_style = false;\n  this._has_title = false;\n  this.only_wym_blocks = true;\n  this.css_settings = {'classesItems':[], 'editorStyles':[], 'dialogStyles':[]};\n  return this;\n};\n\nWYMeditor.WymCssParser.prototype.parse = function(raw, only_wym_blocks)\n{\n  var only_wym_blocks = (typeof only_wym_blocks == 'undefined' ? this.only_wym_blocks : only_wym_blocks);\n  this._Lexer = new WYMeditor.WymCssLexer(this, only_wym_blocks);\n  this._Lexer.parse(raw);\n};\n\nWYMeditor.WymCssParser.prototype.Ignore = function(match, state)\n{\n  return true;\n};\n\nWYMeditor.WymCssParser.prototype.WymCssComment = function(text, status)\n{\n  if(text.match(/end[a-z0-9\\s]*wym[a-z0-9\\s]*/mi)){\n    return false;\n  }\n  if(status == WYMeditor.LEXER_UNMATCHED){\n    if(!this._in_style){\n      this._has_title = true;\n      this._current_item = {'title':WYMeditor.Helper.trim(text)};\n    }else{\n      if(this._current_item[this._current_element]){\n        if(!this._current_item[this._current_element].expressions){\n          this._current_item[this._current_element].expressions = [text];\n        }else{\n          this._current_item[this._current_element].expressions.push(text);\n        }\n      }\n    }\n    this._in_style = true;\n  }\n  return true;\n};\n\nWYMeditor.WymCssParser.prototype.WymCssStyle = function(match, status)\n{\n  if(status == WYMeditor.LEXER_UNMATCHED){\n    match = WYMeditor.Helper.trim(match);\n    if(match != ''){\n      this._current_item[this._current_element].style = match;\n    }\n  }else if (status == WYMeditor.LEXER_EXIT){\n    this._in_style = false;\n    this._has_title = false;\n    this.addStyleSetting(this._current_item);\n  }\n  return true;\n};\n\nWYMeditor.WymCssParser.prototype.WymCssFeedbackStyle = function(match, status)\n{\n  if(status == WYMeditor.LEXER_UNMATCHED){\n    this._current_item[this._current_element].feedback_style = match.replace(/^([\\s\\/\\*]*)|([\\s\\/\\*]*)$/gm,'');\n  }\n  return true;\n};\n\nWYMeditor.WymCssParser.prototype.WymCssStyleDeclaration = function(match)\n{\n  match = match.replace(/^([\\s\\.]*)|([\\s\\.*]*)$/gm, '');\n\n  var tag = '';\n  if(match.indexOf('.') > 0){\n    var parts = match.split('.');\n    this._current_element = parts[1];\n    var tag = parts[0];\n  }else{\n    this._current_element = match;\n  }\n\n  if(!this._has_title){\n    this._current_item = {'title':(!tag?'':tag.toUpperCase()+': ')+this._current_element};\n    this._has_title = true;\n  }\n\n  if(!this._current_item[this._current_element]){\n    this._current_item[this._current_element] = {'name':this._current_element};\n  }\n  if(tag){\n    if(!this._current_item[this._current_element].tags){\n      this._current_item[this._current_element].tags = [tag];\n    }else{\n      this._current_item[this._current_element].tags.push(tag);\n    }\n  }\n  return true;\n};\n\nWYMeditor.WymCssParser.prototype.addStyleSetting = function(style_details)\n{\n  for (var name in style_details){\n    var details = style_details[name];\n    if(typeof details == 'object' && name != 'title'){\n\n      this.css_settings.classesItems.push({\n        'name': WYMeditor.Helper.trim(details.name),\n        'title': style_details.title,\n        'expr' : WYMeditor.Helper.trim((details.expressions||details.tags).join(', '))\n      });\n      if(details.feedback_style){\n        this.css_settings.editorStyles.push({\n          'name': '.'+ WYMeditor.Helper.trim(details.name),\n          'css': details.feedback_style\n        });\n      }\n      if(details.style){\n        this.css_settings.dialogStyles.push({\n          'name': '.'+ WYMeditor.Helper.trim(details.name),\n          'css': details.style\n        });\n      }\n    }\n  }\n};\n\n/********** HELPERS **********/\n\n// Returns true if it is a text node with whitespaces only\njQuery.fn.isPhantomNode = function() {\n  if (this[0].nodeType == 3)\n    return !(/[^\\t\\n\\r ]/.test(this[0].data));\n\n  return false;\n};\n\nWYMeditor.isPhantomNode = function(n) {\n  if (n.nodeType == 3)\n    return !(/[^\\t\\n\\r ]/.test(n.data));\n\n  return false;\n};\n\nWYMeditor.isPhantomString = function(str) {\n    return !(/[^\\t\\n\\r ]/.test(str));\n};\n\n// Returns the Parents or the node itself\n// jqexpr = a jQuery expression\njQuery.fn.parentsOrSelf = function(jqexpr) {\n  var n = this;\n\n  if (n[0].nodeType == 3)\n    n = n.parents().slice(0,1);\n\n//  if (n.is(jqexpr)) // XXX should work, but doesn't (probably a jQuery bug)\n  if (n.filter(jqexpr).size() == 1)\n    return n;\n  else\n    return n.parents(jqexpr).slice(0,1);\n};\n\n// String & array helpers\n\nWYMeditor.Helper = {\n\n    //replace all instances of 'old' by 'rep' in 'str' string\n    replaceAll: function(str, old, rep) {\n        var rExp = new RegExp(old, \"g\");\n        return(str.replace(rExp, rep));\n    },\n\n    //insert 'inserted' at position 'pos' in 'str' string\n    insertAt: function(str, inserted, pos) {\n        return(str.substr(0,pos) + inserted + str.substring(pos));\n    },\n\n    //trim 'str' string\n    trim: function(str) {\n        return str.replace(/^(\\s*)|(\\s*)$/gm,'');\n    },\n\n    //return true if 'arr' array contains 'elem', or false\n    contains: function(arr, elem) {\n        for (var i = 0; i < arr.length; i++) {\n            if (arr[i] === elem) return true;\n        }\n        return false;\n    },\n\n    //return 'item' position in 'arr' array, or -1\n    indexOf: function(arr, item) {\n        var ret=-1;\n        for(var i = 0; i < arr.length; i++) {\n            if (arr[i] == item) {\n                ret = i;\n                break;\n            }\n        }\n\t    return(ret);\n    },\n\n    //return 'item' object in 'arr' array, checking its 'name' property, or null\n    findByName: function(arr, name) {\n        for(var i = 0; i < arr.length; i++) {\n            var item = arr[i];\n            if(item.name == name) return(item);\n        }\n        return(null);\n    }\n};\n\n\n/*\n * WYMeditor : what you see is What You Mean web-based editor\n * Copyright (c) 2005 - 2009 Jean-Francois Hovinne, http://www.wymeditor.org/\n * Dual licensed under the MIT (MIT-license.txt)\n * and GPL (GPL-license.txt) licenses.\n *\n * For further information visit:\n *        http://www.wymeditor.org/\n *\n * File Name:\n *        jquery.wymeditor.explorer.js\n *        MSIE specific class and functions.\n *        See the documentation for more info.\n *\n * File Authors:\n *        Jean-Francois Hovinne (jf.hovinne a-t wymeditor dotorg)\n *        Bermi Ferrer (wymeditor a-t bermi dotorg)\n *        Frédéric Palluel-Lafleur (fpalluel a-t gmail dotcom)\n *        Jonatan Lundin (jonatan.lundin _at_ gmail.com)\n */\n\nWYMeditor.WymClassExplorer = function(wym) {\n\n    this._wym = wym;\n    this._class = \"className\";\n    this._newLine = \"\\r\\n\";\n\n};\n\nWYMeditor.WymClassExplorer.prototype.initIframe = function(iframe) {\n\n    //This function is executed twice, though it is called once!\n    //But MSIE needs that, otherwise designMode won't work.\n    //Weird.\n    \n    this._iframe = iframe;\n    this._doc = iframe.contentWindow.document;\n    \n    //add css rules from options\n    var styles = this._doc.styleSheets[0];\n    var aCss = eval(this._options.editorStyles);\n\n    this.addCssRules(this._doc, aCss);\n\n    this._doc.title = this._wym._index;\n\n    //set the text direction\n    jQuery('html', this._doc).attr('dir', this._options.direction);\n    \n    //init html value\n    jQuery(this._doc.body).html(this._wym._html);\n    \n    //handle events\n    var wym = this;\n    \n    this._doc.body.onfocus = function()\n      {wym._doc.designMode = \"on\"; wym._doc = iframe.contentWindow.document;};\n    this._doc.onbeforedeactivate = function() {wym.saveCaret();};\n    this._doc.onkeyup = function() {\n      wym.saveCaret();\n      wym.keyup();\n    };\n    this._doc.onclick = function() {wym.saveCaret();};\n    \n    this._doc.body.onbeforepaste = function() {\n      wym._iframe.contentWindow.event.returnValue = false;\n    };\n    \n    this._doc.body.onpaste = function() {\n      wym._iframe.contentWindow.event.returnValue = false;\n      wym.paste(window.clipboardData.getData(\"Text\"));\n    };\n    \n    //callback can't be executed twice, so we check\n    if(this._initialized) {\n      \n      //pre-bind functions\n      if(jQuery.isFunction(this._options.preBind)) this._options.preBind(this);\n      \n      //bind external events\n      this._wym.bindEvents();\n      \n      //post-init functions\n      if(jQuery.isFunction(this._options.postInit)) this._options.postInit(this);\n      \n      //add event listeners to doc elements, e.g. images\n      this.listen();\n    }\n    \n    this._initialized = true;\n    \n    //init designMode\n    this._doc.designMode=\"on\";\n    try{\n        // (bermi's note) noticed when running unit tests on IE6\n        // Is this really needed, it trigger an unexisting property on IE6\n        this._doc = iframe.contentWindow.document; \n    }catch(e){}\n};\n\nWYMeditor.WymClassExplorer.prototype._exec = function(cmd,param) {\n\n    switch(cmd) {\n    \n    case WYMeditor.INDENT: case WYMeditor.OUTDENT:\n    \n        var container = this.findUp(this.container(), WYMeditor.LI);\n        if(container) {\n            var ancestor = container.parentNode.parentNode;\n            if(container.parentNode.childNodes.length>1\n              || ancestor.tagName.toLowerCase() == WYMeditor.OL\n              || ancestor.tagName.toLowerCase() == WYMeditor.UL)\n              this._doc.execCommand(cmd);\n        }\n    break;\n    default:\n        if(param) this._doc.execCommand(cmd,false,param);\n        else this._doc.execCommand(cmd);\n    break;\n\t}\n    \n    this.listen();\n};\n\nWYMeditor.WymClassExplorer.prototype.selected = function() {\n\n    var caretPos = this._iframe.contentWindow.document.caretPos;\n        if(caretPos!=null) {\n            if(caretPos.parentElement!=undefined)\n              return(caretPos.parentElement());\n        }\n};\n\nWYMeditor.WymClassExplorer.prototype.saveCaret = function() {\n\n    this._doc.caretPos = this._doc.selection.createRange();\n};\n\nWYMeditor.WymClassExplorer.prototype.addCssRule = function(styles, oCss) {\n\n    styles.addRule(oCss.name, oCss.css);\n};\n\nWYMeditor.WymClassExplorer.prototype.insert = function(html) {\n\n    // Get the current selection\n    var range = this._doc.selection.createRange();\n\n    // Check if the current selection is inside the editor\n    if ( jQuery(range.parentElement()).parents( this._options.iframeBodySelector ).is('*') ) {\n        try {\n            // Overwrite selection with provided html\n            range.pasteHTML(html);\n        } catch (e) { }\n    } else {\n        // Fall back to the internal paste function if there's no selection\n        this.paste(html);\n    }\n};\n\nWYMeditor.WymClassExplorer.prototype.wrap = function(left, right) {\n\n    // Get the current selection\n    var range = this._doc.selection.createRange();\n\n    // Check if the current selection is inside the editor\n    if ( jQuery(range.parentElement()).parents( this._options.iframeBodySelector ).is('*') ) {\n        try {\n            // Overwrite selection with provided html\n            range.pasteHTML(left + range.text + right);\n        } catch (e) { }\n    }\n};\n\nWYMeditor.WymClassExplorer.prototype.unwrap = function() {\n\n    // Get the current selection\n    var range = this._doc.selection.createRange();\n\n    // Check if the current selection is inside the editor\n    if ( jQuery(range.parentElement()).parents( this._options.iframeBodySelector ).is('*') ) {\n        try {\n            // Unwrap selection\n            var text = range.text;\n            this._exec( 'Cut' );\n            range.pasteHTML( text );\n        } catch (e) { }\n    }\n};\n\n//keyup handler\nWYMeditor.WymClassExplorer.prototype.keyup = function() {\n  this._selected_image = null;\n};\n\nWYMeditor.WymClassExplorer.prototype.setFocusToNode = function(node) {\n    var range = this._doc.selection.createRange();\n    range.moveToElementText(node);\n    range.collapse(false);\n    range.move('character',-1);\n    range.select();\n    node.focus();\n};\n\n/*\n * WYMeditor : what you see is What You Mean web-based editor\n * Copyright (c) 2005 - 2009 Jean-Francois Hovinne, http://www.wymeditor.org/\n * Dual licensed under the MIT (MIT-license.txt)\n * and GPL (GPL-license.txt) licenses.\n *\n * For further information visit:\n *        http://www.wymeditor.org/\n *\n * File Name:\n *        jquery.wymeditor.mozilla.js\n *        Gecko specific class and functions.\n *        See the documentation for more info.\n *\n * File Authors:\n *        Jean-Francois Hovinne (jf.hovinne a-t wymeditor dotorg)\n *        Volker Mische (vmx a-t gmx dotde)\n *        Bermi Ferrer (wymeditor a-t bermi dotorg)\n *        Frédéric Palluel-Lafleur (fpalluel a-t gmail dotcom)\n */\n\nWYMeditor.WymClassMozilla = function(wym) {\n\n    this._wym = wym;\n    this._class = \"class\";\n    this._newLine = \"\\n\";\n};\n\nWYMeditor.WymClassMozilla.prototype.initIframe = function(iframe) {\n\n    this._iframe = iframe;\n    this._doc = iframe.contentDocument;\n    \n    //add css rules from options\n    \n    var styles = this._doc.styleSheets[0];    \n    var aCss = eval(this._options.editorStyles);\n    \n    this.addCssRules(this._doc, aCss);\n\n    this._doc.title = this._wym._index;\n\n    //set the text direction\n    jQuery('html', this._doc).attr('dir', this._options.direction);\n    \n    //init html value\n    this.html(this._wym._html);\n    \n    //init designMode\n    this.enableDesignMode();\n    \n    //pre-bind functions\n    if(jQuery.isFunction(this._options.preBind)) this._options.preBind(this);\n    \n    //bind external events\n    this._wym.bindEvents();\n    \n    //bind editor keydown events\n    jQuery(this._doc).bind(\"keydown\", this.keydown);\n    \n    //bind editor keyup events\n    jQuery(this._doc).bind(\"keyup\", this.keyup);\n    \n    //bind editor focus events (used to reset designmode - Gecko bug)\n    jQuery(this._doc).bind(\"focus\", this.enableDesignMode);\n    \n    //post-init functions\n    if(jQuery.isFunction(this._options.postInit)) this._options.postInit(this);\n    \n    //add event listeners to doc elements, e.g. images\n    this.listen();\n};\n\n/* @name html\n * @description Get/Set the html value\n */\nWYMeditor.WymClassMozilla.prototype.html = function(html) {\n\n  if(typeof html === 'string') {\n  \n    //disable designMode\n    try { this._doc.designMode = \"off\"; } catch(e) { };\n    \n    //replace em by i and strong by bold\n    //(designMode issue)\n    html = html.replace(/<em(\\b[^>]*)>/gi, \"<i$1>\")\n      .replace(/<\\/em>/gi, \"</i>\")\n      .replace(/<strong(\\b[^>]*)>/gi, \"<b$1>\")\n      .replace(/<\\/strong>/gi, \"</b>\");\n\n    //update the html body\n    jQuery(this._doc.body).html(html);\n    \n    //re-init designMode\n    this.enableDesignMode();\n  }\n  else return(jQuery(this._doc.body).html());\n};\n\nWYMeditor.WymClassMozilla.prototype._exec = function(cmd,param) {\n\n    if(!this.selected()) return(false);\n\n    switch(cmd) {\n    \n    case WYMeditor.INDENT: case WYMeditor.OUTDENT:\n    \n        var focusNode = this.selected();    \n        var sel = this._iframe.contentWindow.getSelection();\n        var anchorNode = sel.anchorNode;\n        if(anchorNode.nodeName == \"#text\") anchorNode = anchorNode.parentNode;\n        \n        focusNode = this.findUp(focusNode, WYMeditor.BLOCKS);\n        anchorNode = this.findUp(anchorNode, WYMeditor.BLOCKS);\n        \n        if(focusNode && focusNode == anchorNode\n          && focusNode.tagName.toLowerCase() == WYMeditor.LI) {\n\n            var ancestor = focusNode.parentNode.parentNode;\n\n            if(focusNode.parentNode.childNodes.length>1\n              || ancestor.tagName.toLowerCase() == WYMeditor.OL\n              || ancestor.tagName.toLowerCase() == WYMeditor.UL)\n                this._doc.execCommand(cmd,'',null);\n        }\n\n    break;\n    \n    default:\n\n        if(param) this._doc.execCommand(cmd,'',param);\n        else this._doc.execCommand(cmd,'',null);\n    }\n    \n    //set to P if parent = BODY\n    var container = this.selected();\n    if(container.tagName.toLowerCase() == WYMeditor.BODY)\n        this._exec(WYMeditor.FORMAT_BLOCK, WYMeditor.P);\n    \n    //add event handlers on doc elements\n\n    this.listen();\n};\n\n/* @name selected\n * @description Returns the selected container\n */\nWYMeditor.WymClassMozilla.prototype.selected = function() {\n\n    var sel = this._iframe.contentWindow.getSelection();\n    var node = sel.focusNode;\n    if(node) {\n        if(node.nodeName == \"#text\") return(node.parentNode);\n        else return(node);\n    } else return(null);\n};\n\nWYMeditor.WymClassMozilla.prototype.addCssRule = function(styles, oCss) {\n\n    styles.insertRule(oCss.name + \" {\" + oCss.css + \"}\",\n        styles.cssRules.length);\n};\n\n\n//keydown handler, mainly used for keyboard shortcuts\nWYMeditor.WymClassMozilla.prototype.keydown = function(evt) {\n  \n  //'this' is the doc\n  var wym = WYMeditor.INSTANCES[this.title];\n  var container = null;  \n\n  if( evt.keyCode === WYMeditor.KEY.ENTER ){\n\tcontainer = wym.selected();\n\tif( container ){\n\t\tvar $container = $( container ),\n\t\t\t$parent = $container.parent(),\n\t\t\t$embedded = $container.parents( '.embedded-item' );\n\t\tif( $embedded.size() ){\n\t\t\t// if the cursor is in the title, add a para before\n\t\t\tvar $newNode = $( '<p/>' );\n\t\t\tif( $container.hasClass( 'title' ) ){\n\t\t\t\t$embedded.before( $newNode );\n\t\t\t// if the cursor is in the content, add after\n\t\t\t} else if( $container.hasClass( 'content' ) ){\n\t\t\t\t$embedded.after( $newNode );\n\t\t\t}\n\t\t\twym.setFocusToNode( $newNode.get(0) );\n\t\t\t// prevent the default - wym's chop the text and split it up into paras\n\t\t\treturn false;\n\t\t}\n\t}\n  }\n\n  if(evt.ctrlKey){\n    if(evt.keyCode == 66){\n      //CTRL+b => STRONG\n      wym._exec(WYMeditor.BOLD);\n      return false;\n    }\n    if(evt.keyCode == 73){\n      //CTRL+i => EMPHASIS\n      wym._exec(WYMeditor.ITALIC);\n      return false;\n    }\n  }\n\n  else if(evt.keyCode == 13) {\n    if(!evt.shiftKey){\n      //fix PRE bug #73\n      container = wym.selected();\n      if(container && container.tagName.toLowerCase() == WYMeditor.PRE) {\n        evt.preventDefault();\n        wym.insert('<p></p>');\n      }\n    }\n  }\n};\n\n//keyup handler, mainly used for cleanups\nWYMeditor.WymClassMozilla.prototype.keyup = function(evt) {\n\n  //'this' is the doc\n  var wym = WYMeditor.INSTANCES[this.title];\n\n  wym._selected_image = null;\n  var container = null;\n\n  if(evt.keyCode == 13 && !evt.shiftKey) {\n\n    //RETURN key\n    //cleanup <br><br> between paragraphs\n    jQuery(wym._doc.body).children(WYMeditor.BR).remove();\n  }\n\n  else if(evt.keyCode != 8\n       && evt.keyCode != 17\n       && evt.keyCode != 46\n       && evt.keyCode != 224\n       && !evt.metaKey\n       && !evt.ctrlKey) {\n\n    //NOT BACKSPACE, NOT DELETE, NOT CTRL, NOT COMMAND\n    //text nodes replaced by P\n\n    container = wym.selected();\n    var name = container.tagName.toLowerCase();\n\n    //fix forbidden main containers\n    if(\n      name == \"strong\" ||\n      name == \"b\" ||\n      name == \"em\" ||\n      name == \"i\" ||\n      name == \"sub\" ||\n      name == \"sup\" ||\n      name == \"a\"\n\n    ) name = container.parentNode.tagName.toLowerCase();\n\n    if(name == WYMeditor.BODY) wym._exec(WYMeditor.FORMAT_BLOCK, WYMeditor.P);\n  }\n};\n\nWYMeditor.WymClassMozilla.prototype.enableDesignMode = function() {\n    if(this.designMode == \"off\") {\n      try {\n        this.designMode = \"on\";\n        this.execCommand(\"styleWithCSS\", '', false);\n      } catch(e) { }\n    }\n};\n\nWYMeditor.WymClassMozilla.prototype.setFocusToNode = function(node) {\n    var range = document.createRange();\n    range.selectNode(node);\n    var selected = this._iframe.contentWindow.getSelection();\n    selected.addRange(range);\n    selected.collapse(node, node.childNodes.length);\n    this._iframe.contentWindow.focus();\n};\n\nWYMeditor.WymClassMozilla.prototype.openBlockTag = function(tag, attributes)\n{\n  var attributes = this.validator.getValidTagAttributes(tag, attributes);\n\n  // Handle Mozilla styled spans\n  if(tag == 'span' && attributes.style){\n    var new_tag = this.getTagForStyle(attributes.style);\n    if(new_tag){\n      this._tag_stack.pop();\n      var tag = new_tag;\n      this._tag_stack.push(new_tag);\n      attributes.style = '';\n    }else{\n      return;\n    }\n  }\n\n  this.output += this.helper.tag(tag, attributes, true);\n};\n\nWYMeditor.WymClassMozilla.prototype.getTagForStyle = function(style) {\n\n  if(/bold/.test(style)) return 'strong';\n  if(/italic/.test(style)) return 'em';\n  if(/sub/.test(style)) return 'sub';\n  if(/sub/.test(style)) return 'super';\n  return false;\n};\n\n/*\n * WYMeditor : what you see is What You Mean web-based editor\n * Copyright (c) 2005 - 2009 Jean-Francois Hovinne, http://www.wymeditor.org/\n * Dual licensed under the MIT (MIT-license.txt)\n * and GPL (GPL-license.txt) licenses.\n *\n * For further information visit:\n *        http://www.wymeditor.org/\n *\n * File Name:\n *        jquery.wymeditor.opera.js\n *        Opera specific class and functions.\n *        See the documentation for more info.\n *\n * File Authors:\n *        Jean-Francois Hovinne (jf.hovinne a-t wymeditor dotorg)\n */\n\nWYMeditor.WymClassOpera = function(wym) {\n\n    this._wym = wym;\n    this._class = \"class\";\n    this._newLine = \"\\r\\n\";\n};\n\nWYMeditor.WymClassOpera.prototype.initIframe = function(iframe) {\n\n    this._iframe = iframe;\n    this._doc = iframe.contentWindow.document;\n\n    //add css rules from options\n    var styles = this._doc.styleSheets[0];\n    var aCss = eval(this._options.editorStyles);\n\n    this.addCssRules(this._doc, aCss);\n\n    this._doc.title = this._wym._index;\n\n    //set the text direction\n    jQuery('html', this._doc).attr('dir', this._options.direction);\n\n    //init designMode\n    this._doc.designMode = \"on\";\n\n    //init html value\n    this.html(this._wym._html);\n\n    //pre-bind functions\n    if(jQuery.isFunction(this._options.preBind)) this._options.preBind(this);\n\n    //bind external events\n    this._wym.bindEvents();\n\n    //bind editor keydown events\n    jQuery(this._doc).bind(\"keydown\", this.keydown);\n\n    //bind editor events\n    jQuery(this._doc).bind(\"keyup\", this.keyup);\n\n    //post-init functions\n    if(jQuery.isFunction(this._options.postInit)) this._options.postInit(this);\n\n    //add event listeners to doc elements, e.g. images\n    this.listen();\n};\n\nWYMeditor.WymClassOpera.prototype._exec = function(cmd,param) {\n\n    if(param) this._doc.execCommand(cmd,false,param);\n    else this._doc.execCommand(cmd);\n\n    this.listen();\n};\n\nWYMeditor.WymClassOpera.prototype.selected = function() {\n\n    var sel=this._iframe.contentWindow.getSelection();\n    var node=sel.focusNode;\n    if(node) {\n        if(node.nodeName==\"#text\")return(node.parentNode);\n        else return(node);\n    } else return(null);\n};\n\nWYMeditor.WymClassOpera.prototype.addCssRule = function(styles, oCss) {\n\n    styles.insertRule(oCss.name + \" {\" + oCss.css + \"}\",\n        styles.cssRules.length);\n};\n\n//keydown handler\nWYMeditor.WymClassOpera.prototype.keydown = function(evt) {\n\n  //'this' is the doc\n  var wym = WYMeditor.INSTANCES[this.title];\n  var sel = wym._iframe.contentWindow.getSelection();\n  startNode = sel.getRangeAt(0).startContainer;\n\n  //Get a P instead of no container\n  if(!jQuery(startNode).parentsOrSelf(\n                WYMeditor.MAIN_CONTAINERS.join(\",\"))[0]\n      && !jQuery(startNode).parentsOrSelf('li')\n      && evt.keyCode != WYMeditor.KEY.ENTER\n      && evt.keyCode != WYMeditor.KEY.LEFT\n      && evt.keyCode != WYMeditor.KEY.UP\n      && evt.keyCode != WYMeditor.KEY.RIGHT\n      && evt.keyCode != WYMeditor.KEY.DOWN\n      && evt.keyCode != WYMeditor.KEY.BACKSPACE\n      && evt.keyCode != WYMeditor.KEY.DELETE)\n      wym._exec(WYMeditor.FORMAT_BLOCK, WYMeditor.P);\n\n};\n\n//keyup handler\nWYMeditor.WymClassOpera.prototype.keyup = function(evt) {\n\n  //'this' is the doc\n  var wym = WYMeditor.INSTANCES[this.title];\n  wym._selected_image = null;\n};\n\n// TODO: implement me\nWYMeditor.WymClassOpera.prototype.setFocusToNode = function(node) {\n\n};\n\n/*\n * WYMeditor : what you see is What You Mean web-based editor\n * Copyright (c) 2005 - 2009 Jean-Francois Hovinne, http://www.wymeditor.org/\n * Dual licensed under the MIT (MIT-license.txt)\n * and GPL (GPL-license.txt) licenses.\n *\n * For further information visit:\n *        http://www.wymeditor.org/\n *\n * File Name:\n *        jquery.wymeditor.safari.js\n *        Safari specific class and functions.\n *        See the documentation for more info.\n *\n * File Authors:\n *        Jean-Francois Hovinne (jf.hovinne a-t wymeditor dotorg)\n *        Scott Lewis (lewiscot a-t gmail dotcom)\n */\n\nWYMeditor.WymClassSafari = function(wym) {\n\n    this._wym = wym;\n    this._class = \"class\";\n    this._newLine = \"\\n\";\n};\n\nWYMeditor.WymClassSafari.prototype.initIframe = function(iframe) {\n\n    this._iframe = iframe;\n    this._doc = iframe.contentDocument;\n\n    //add css rules from options\n\n    var styles = this._doc.styleSheets[0];\n    var aCss = eval(this._options.editorStyles);\n\n    this.addCssRules(this._doc, aCss);\n\n    this._doc.title = this._wym._index;\n\n    //set the text direction\n    jQuery('html', this._doc).attr('dir', this._options.direction);\n\n    //init designMode\n    this._doc.designMode = \"on\";\n\n    //init html value\n    this.html(this._wym._html);\n\n    //pre-bind functions\n    if(jQuery.isFunction(this._options.preBind)) this._options.preBind(this);\n\n    //bind external events\n    this._wym.bindEvents();\n\n    //bind editor keydown events\n    jQuery(this._doc).bind(\"keydown\", this.keydown);\n\n    //bind editor keyup events\n    jQuery(this._doc).bind(\"keyup\", this.keyup);\n\n    //post-init functions\n    if(jQuery.isFunction(this._options.postInit)) this._options.postInit(this);\n\n    //add event listeners to doc elements, e.g. images\n    this.listen();\n};\n\nWYMeditor.WymClassSafari.prototype._exec = function(cmd,param) {\n\n    if(!this.selected()) return(false);\n\n    switch(cmd) {\n\n    case WYMeditor.INDENT: case WYMeditor.OUTDENT:\n\n        var focusNode = this.selected();\n        var sel = this._iframe.contentWindow.getSelection();\n        var anchorNode = sel.anchorNode;\n        if(anchorNode.nodeName == \"#text\") anchorNode = anchorNode.parentNode;\n\n        focusNode = this.findUp(focusNode, WYMeditor.BLOCKS);\n        anchorNode = this.findUp(anchorNode, WYMeditor.BLOCKS);\n\n        if(focusNode && focusNode == anchorNode\n          && focusNode.tagName.toLowerCase() == WYMeditor.LI) {\n\n            var ancestor = focusNode.parentNode.parentNode;\n\n            if(focusNode.parentNode.childNodes.length>1\n              || ancestor.tagName.toLowerCase() == WYMeditor.OL\n              || ancestor.tagName.toLowerCase() == WYMeditor.UL)\n                this._doc.execCommand(cmd,'',null);\n        }\n\n    break;\n\n    case WYMeditor.INSERT_ORDEREDLIST: case WYMeditor.INSERT_UNORDEREDLIST:\n\n        this._doc.execCommand(cmd,'',null);\n\n        //Safari creates lists in e.g. paragraphs.\n        //Find the container, and remove it.\n        var focusNode = this.selected();\n        var container = this.findUp(focusNode, WYMeditor.MAIN_CONTAINERS);\n        if(container) jQuery(container).replaceWith(jQuery(container).html());\n\n    break;\n\n    default:\n\n        if(param) this._doc.execCommand(cmd,'',param);\n        else this._doc.execCommand(cmd,'',null);\n    }\n\n    //set to P if parent = BODY\n    var container = this.selected();\n    if(container && container.tagName.toLowerCase() == WYMeditor.BODY)\n        this._exec(WYMeditor.FORMAT_BLOCK, WYMeditor.P);\n\n    //add event handlers on doc elements\n    this.listen();\n};\n\n/* @name selected\n * @description Returns the selected container\n */\nWYMeditor.WymClassSafari.prototype.selected = function() {\n\n    var sel = this._iframe.contentWindow.getSelection();\n    var node = sel.focusNode;\n    if(node) {\n        if(node.nodeName == \"#text\") return(node.parentNode);\n        else return(node);\n    } else return(null);\n};\n\nWYMeditor.WymClassSafari.prototype.addCssRule = function(styles, oCss) {\n\n    styles.insertRule(oCss.name + \" {\" + oCss.css + \"}\",\n        styles.cssRules.length);\n};\n\n\n//keydown handler, mainly used for keyboard shortcuts\nWYMeditor.WymClassSafari.prototype.keydown = function(evt) {\n\n  //'this' is the doc\n  var wym = WYMeditor.INSTANCES[this.title];\n\n  if( evt.keyCode === WYMeditor.KEY.ENTER ){\n\tvar container = wym.selected();\n\tif( container ){\n\t\tvar $container = $( container ),\n\t\t\t$parent = $container.parent(),\n\t\t\t$embedded = $container.parents( '.embedded-item' );\n\t\tif( $embedded.size() ){\n\t\t\t// if the cursor is in the title, add a para before\n\t\t\tvar $newNode = $( '<p/>' );\n\t\t\tif( $container.hasClass( 'title' ) ){\n\t\t\t\t$embedded.before( $newNode );\n\t\t\t// if the cursor is in the content, add after\n\t\t\t} else if( $container.hasClass( 'content' ) ){\n\t\t\t\t$embedded.after( $newNode );\n\t\t\t}\n\t\t\twym.setFocusToNode( $newNode.get(0) );\n\t\t\t// prevent the default - wym's chop the text and split it up into paras\n\t\t\treturn false;\n\t\t}\n\t}\n  }\n  \n  if(evt.ctrlKey){\n    if(evt.keyCode == 66){\n      //CTRL+b => STRONG\n      wym._exec(WYMeditor.BOLD);\n      return false;\n    }\n    if(evt.keyCode == 73){\n      //CTRL+i => EMPHASIS\n      wym._exec(WYMeditor.ITALIC);\n      return false;\n    }\n  }\n};\n\n//keyup handler, mainly used for cleanups\nWYMeditor.WymClassSafari.prototype.keyup = function(evt) {\n\n  //'this' is the doc\n  var wym = WYMeditor.INSTANCES[this.title];\n  \n  wym._selected_image = null;\n  var container = null;\n\n  if(evt.keyCode == 13 && !evt.shiftKey) {\n  \n    //RETURN key\n    //cleanup <br><br> between paragraphs\n    jQuery(wym._doc.body).children(WYMeditor.BR).remove();\n    \n    //fix PRE bug #73\n    container = wym.selected();\n    if(container && container.tagName.toLowerCase() == WYMeditor.PRE)\n        wym._exec(WYMeditor.FORMAT_BLOCK, WYMeditor.P); //create P after PRE\n  }\n\n  //fix #112\n  if(evt.keyCode == 13 && evt.shiftKey) {\n    wym._exec('InsertLineBreak');\n  }\n  \n  if(evt.keyCode != 8\n       && evt.keyCode != 17\n       && evt.keyCode != 46\n       && evt.keyCode != 224\n       && !evt.metaKey\n       && !evt.ctrlKey) {\n      \n    //NOT BACKSPACE, NOT DELETE, NOT CTRL, NOT COMMAND\n    //text nodes replaced by P\n    \n    container = wym.selected();\n    var name = container.tagName.toLowerCase();\n\n    //fix forbidden main containers\n    if(\n      name == \"strong\" ||\n      name == \"b\" ||\n      name == \"em\" ||\n      name == \"i\" ||\n      name == \"sub\" ||\n      name == \"sup\" ||\n      name == \"a\" ||\n      name == \"span\" //fix #110\n\n    ) name = container.parentNode.tagName.toLowerCase();\n\n    if(name == WYMeditor.BODY || name == WYMeditor.DIV) wym._exec(WYMeditor.FORMAT_BLOCK, WYMeditor.P); //fix #110 for DIV\n  }\n};\n\nWYMeditor.WymClassSafari.prototype.setFocusToNode = function(node) {\n    var range = this._iframe.contentDocument.createRange();\n    range.selectNode(node);\n    var selected = this._iframe.contentWindow.getSelection();\n    selected.addRange(range);\n    selected.collapse(node, node.childNodes.length);\n    this._iframe.contentWindow.focus();\n};\n\nWYMeditor.WymClassSafari.prototype.openBlockTag = function(tag, attributes)\n{\n  var attributes = this.validator.getValidTagAttributes(tag, attributes);\n\n  // Handle Safari styled spans\n  if(tag == 'span' && attributes.style) {\n    var new_tag = this.getTagForStyle(attributes.style);\n    if(new_tag){\n      this._tag_stack.pop();\n      var tag = new_tag;\n      this._tag_stack.push(new_tag);\n      attributes.style = '';\n      \n      //should fix #125 - also removed the xhtml() override\n      if(typeof attributes['class'] == 'string')\n        attributes['class'] = attributes['class'].replace(/apple-style-span/gi, '');\n    \n    } else {\n      return;\n    }\n  }\n  \n  this.output += this.helper.tag(tag, attributes, true);\n};\n\nWYMeditor.WymClassSafari.prototype.getTagForStyle = function(style) {\n\n  if(/bold/.test(style)) return 'strong';\n  if(/italic/.test(style)) return 'em';\n  if(/sub/.test(style)) return 'sub';\n  if(/super/.test(style)) return 'sup';\n  return false;\n};\n"]}