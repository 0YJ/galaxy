{"version":3,"sources":["layout/scratchbook.js"],"names":["define","Frames","Backbone","View","extend","initialize","options","self","this","frames","visible","setElement","$el","buttonActive","collection","add","id","icon","tooltip","onclick","active","set","toggle","show_note","note_cls","hide","onbeforeunload","length","buttonLoad","e","show","on","note","history_cache","addDataset","dataset_id","current_dataset","Galaxy","currHistoryPanel","history_id","historyId","name","model","get","dataset_ids","each","push","_findDataset","dataset","offset","history_details","dataset_list","pos","indexOf","_loadDatasetOffset","frame","new_dataset_id","_loadDataset","new_dataset","config","trigger","_","menu","disabled","callback","require","DATA","Dataset","$","when","fetch","then","is_tabular","find","data_type","title","url","content","createTabularDatasetChunkedView","TabularDataset","toJSON","embedded","height","root","addTrackster","viz_id","visualization","trackster","viz","Visualization","ui","TracksterUI","frame_config","type","parent_elt","view_config","container","dbkey","stand_alone","latest_revision","drawables","view","d","hda_ldda","create_visualization","viewport","bookmarks","target","window","open","location","noscratchbook","$galaxy_main","parent","document","attr"],"mappings":"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","file":"../../scripts/layout/scratchbook.js","sourcesContent":["/** Frame manager uses the ui-frames to create the scratch book masthead icon and functionality **/\ndefine([ 'mvc/ui/ui-frames' ], function( Frames ) {\nreturn Backbone.View.extend({\n    initialize : function( options ) {\n        var self = this;\n        options = options || {};\n        this.frames = new Frames.View({ visible : false });\n        this.setElement( this.frames.$el );\n        this.buttonActive = options.collection.add({\n            id              : 'enable-scratchbook',\n            icon            : 'fa-th',\n            tooltip         : 'Enable/Disable Scratchbook',\n            onclick         : function() {\n                self.active = !self.active;\n                self.buttonActive.set({\n                    toggle    : self.active,\n                    show_note : self.active,\n                    note_cls  : self.active && 'fa fa-check'\n                });\n                !self.active && self.frames.hide();\n            },\n            onbeforeunload  : function() {\n                if ( self.frames.length() > 0 ) {\n                    return 'You opened ' + self.frames.length() + ' frame(s) which will be lost.';\n                }\n            }\n        });\n        this.buttonLoad = options.collection.add({\n            id              : 'show-scratchbook',\n            icon            : 'fa-eye',\n            tooltip         : 'Show/Hide Scratchbook',\n            show_note       : true,\n            visible         : false,\n            onclick         : function( e ) {\n                self.frames.visible ? self.frames.hide() : self.frames.show();\n            }\n        });\n        this.frames.on( 'add remove', function() {\n            this.visible && this.length() == 0 && this.hide();\n            self.buttonLoad.set( { 'note': this.length(), 'visible': this.length() > 0 } );\n        }).on( 'show hide ', function() {\n            self.buttonLoad.set( { 'toggle': this.visible, 'icon': this.visible && 'fa-eye' || 'fa-eye-slash' } );\n        });\n        this.history_cache = {};\n    },\n\n    /** Add a dataset to the frames */\n    addDataset: function( dataset_id ) {\n        var self = this;\n        var current_dataset = null;\n        if ( Galaxy && Galaxy.currHistoryPanel ) {\n            var history_id = Galaxy.currHistoryPanel.collection.historyId;\n            this.history_cache[ history_id ] = { name: Galaxy.currHistoryPanel.model.get( 'name' ), dataset_ids: [] };\n            Galaxy.currHistoryPanel.collection.each( function( model ) {\n                !model.get( 'deleted' ) && model.get( 'visible' ) && self.history_cache[ history_id ].dataset_ids.push( model.get( 'id' ) );\n            });\n        }\n        var _findDataset = function( dataset, offset ) {\n            if ( dataset ) {\n                var history_details = self.history_cache[ dataset.get( 'history_id' ) ];\n                if ( history_details && history_details.dataset_ids ) {\n                    var dataset_list = history_details.dataset_ids;\n                    var pos = dataset_list.indexOf( dataset.get( 'id' ) );\n                    if ( pos !== -1 && pos + offset >= 0 && pos + offset < dataset_list.length ) {\n                        return dataset_list[ pos + offset ];\n                    }\n                }\n            }\n        };\n        var _loadDatasetOffset = function( dataset, offset, frame ) {\n            var new_dataset_id = _findDataset( dataset, offset );\n            if ( new_dataset_id ) {\n                self._loadDataset( new_dataset_id, function( new_dataset, config ) {\n                    current_dataset = new_dataset;\n                    frame.model.set( config );\n                });\n            } else {\n                frame.model.trigger( 'change' );\n            }\n        }\n        this._loadDataset( dataset_id, function( dataset, config ) {\n            current_dataset = dataset;\n            self.add( _.extend( { menu: [ { icon     : 'fa fa-chevron-circle-left',\n                                            tooltip  : 'Previous in History',\n                                            onclick  : function( frame ) { _loadDatasetOffset( current_dataset, -1, frame ) },\n                                            disabled : function() { return !_findDataset( current_dataset, -1 ) } },\n                                          { icon     : 'fa fa-chevron-circle-right',\n                                            tooltip  : 'Next in History',\n                                            onclick  : function( frame ) { _loadDatasetOffset( current_dataset, 1, frame ) },\n                                            disabled : function() { return !_findDataset( current_dataset, 1 ) } } ] }, config ) )\n        });\n    },\n\n    _loadDataset: function( dataset_id, callback ) {\n        var self = this;\n        require([ 'mvc/dataset/data' ], function( DATA ) {\n            var dataset = new DATA.Dataset( { id : dataset_id } );\n            $.when( dataset.fetch() ).then( function() {\n                var is_tabular = _.find( [ 'tabular', 'interval' ] , function( data_type ) {\n                    return dataset.get( 'data_type' ).indexOf( data_type ) !== -1;\n                });\n                var title = dataset.get( 'name' );\n                var history_details = self.history_cache[ dataset.get( 'history_id' ) ];\n                if ( history_details ) {\n                    title = history_details.name + ': ' + title;\n                }\n                callback( dataset, is_tabular ? {\n                    title   : title,\n                    url     : null,\n                    content : DATA.createTabularDatasetChunkedView({\n                        model       : new DATA.TabularDataset( dataset.toJSON() ),\n                        embedded    : true,\n                        height      : '100%'\n                    }).$el\n                } : {\n                    title   : title,\n                    url     : Galaxy.root + 'datasets/' + dataset_id + '/display/?preview=True',\n                    content : null\n                } );\n            });\n        });\n    },\n\n    /** Add a trackster visualization to the frames. */\n    addTrackster: function(viz_id) {\n        var self = this;\n        require(['viz/visualization', 'viz/trackster'], function(visualization, trackster) {\n            var viz = new visualization.Visualization({id: viz_id});\n            $.when( viz.fetch() ).then( function() {\n                var ui = new trackster.TracksterUI(Galaxy.root);\n\n                // Construct frame config based on dataset's type.\n                var frame_config = {\n                        title: viz.get('name'),\n                        type: 'other',\n                        content: function(parent_elt) {\n                            // Create view config.\n                            var view_config = {\n                                container: parent_elt,\n                                name: viz.get('title'),\n                                id: viz.id,\n                                // FIXME: this will not work with custom builds b/c the dbkey needed to be encoded.\n                                dbkey: viz.get('dbkey'),\n                                stand_alone: false\n                            },\n                            latest_revision = viz.get('latest_revision'),\n                            drawables = latest_revision.config.view.drawables;\n\n                            // Set up datasets in drawables.\n                            _.each(drawables, function(d) {\n                                d.dataset = {\n                                    hda_ldda: d.hda_ldda,\n                                    id: d.dataset_id\n                                };\n                            });\n                            view = ui.create_visualization(view_config,\n                                                           latest_revision.config.viewport,\n                                                           latest_revision.config.view.drawables,\n                                                           latest_revision.config.bookmarks,\n                                                           false);\n                        }\n                    };\n                self.add(frame_config);\n            });\n        });\n    },\n\n    /** Add and display a new frame/window based on options. */\n    add: function( options ) {\n        if ( options.target == '_blank' ) {\n            window.open( options.url );\n        } else if ( options.target == '_top' || options.target == '_parent' || options.target == '_self' ) {\n            window.location = options.url;\n        } else if ( !this.active || options.noscratchbook ) {\n            var $galaxy_main = $( window.parent.document ).find( '#galaxy_main' );\n            if ( options.target == 'galaxy_main' || options.target == 'center' ) {\n                if ( $galaxy_main.length === 0 ) {\n                    window.location = options.url + ( options.url.indexOf( '?' ) == -1 ? '?' : '&' ) + 'use_panels=True';\n                } else {\n                    $galaxy_main.attr( 'src', options.url );\n                }\n            } else\n                window.location = options.url;\n        } else {\n            this.frames.add( options );\n        }\n    }\n});\n\n});"]}