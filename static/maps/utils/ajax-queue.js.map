{"version":3,"sources":["utils/ajax-queue.js"],"names":["define","AjaxQueue","initialFunctions","self","this","deferred","jQuery","Deferred","queue","responses","numToProcess","running","init","NamedAjaxQueue","call","prototype","forEach","fn","add","index","length","push","fnIndex","xhr","done","response","notify","total","always","stop","start","causeFail","msg","reject","resolve","fail","progress","create","constructor","obj","hasOwnProperty","Error","JSON","stringify","names","clear"],"mappings":"aAAAA,UACG,WAWH,SAASC,EAAWC,GAChB,IAAAC,EAAAC,KAgBA,OAdAD,EAAAE,SAAAC,OAAAC,WAEAJ,EAAAK,SAEAL,EAAAM,aAEAN,EAAAO,aAAA,EAEAP,EAAAQ,SAAA,EAGAR,EAAKS,KAAMV,OAAXC,EAAAA,QAGOA,EAwGX,SAAAU,EAASA,GACL,IAAAV,EAAIA,KAGJ,OAFAA,EAAAA,SACAF,EAAAA,KAAUa,KAAMZ,GAChBC,EAsCIF,OA/IRA,EAAAc,UAAAH,KAAA,SAAAV,GACAD,IAAAA,EAAUc,KACNb,EAAWc,QAAX,SAAAC,GACAf,EAAAA,IAAAA,MAKJD,EAAAc,UAAAG,IAAA,SAAAD,GAEI,IAAAd,EAAAC,KACAe,EAAIhB,KAAOK,MAAXY,OAqBC,OArBDhB,KAAAM,cACiBF,EAGjBJ,KAAKI,MAAMa,KAAM,WAAjB,IAAAC,EAAWD,EACPE,EAAID,IAEJC,EAAAC,KAAA,SAAAC,GACAF,EAAIC,SAAME,QAAUD,KAAUH,EAAAK,MAAAxB,EAAAO,aAAAe,SAAAA,MAI9BF,EAAAK,OAAA,SAAAH,GACAF,EAAIK,UAAQP,KAAUI,GAClBtB,EAAKM,MAAAA,OACLN,EAAIA,MAAKK,OAATL,GAECA,EAFD0B,WAXRzB,MAqBJH,EAAAc,UAAAe,MAAA,WAKK,OAJL7B,KAAAA,MAAUc,SACNX,KAAIO,SAAWS,EACXhB,KAAAI,MAAKG,OAALP,IAEHA,MAQLH,EAAUc,UAAUc,KAAO,SAAeE,EAAWC,GAWjD,OAVA5B,KAAAO,SAAA,EACAP,KAAAI,SACAuB,EAEI3B,KAAAC,SAAA4B,OAAAD,GAEH5B,KAHDC,SAGO6B,QAAA9B,KAAAK,WAENL,KAAAM,aAAA,EACDN,KAAAC,SAAKK,OAALH,WACAH,MAKJH,EAAAc,UAAAS,KAAA,SAAAP,GACAhB,OAAAA,KAAUc,SAAUS,KAAOP,IAG3BhB,EAAAc,UAAAoB,KAAA,SAAAlB,GACAhB,OAAAA,KAAUc,SAAUoB,KAAOlB,IAG3BhB,EAAAc,UAAAa,OAAA,SAAAX,GACAhB,OAAAA,KAAUc,SAAUa,OAASX,IAG7BhB,EAAAc,UAAAqB,SAAA,SAAAnB,GACAhB,OAAAA,KAAUc,SAAUqB,SAAWnB,IAO/BhB,EAAUoC,OAAS,SAAiBnC,GAApCD,OAAAA,IAAUoC,EAASnC,GAAiBA,UAsBpCW,EAAAA,UAAeE,IAAYd,EAC3BY,EAAAA,UAAeE,YAAUuB,EAGzBzB,EAAAA,UAAeE,IAAUG,SAAeA,GAGpC,IAAAqB,EAAOA,eAAIC,UAAJD,EAAgCA,eAAoB,MACvD,MAAA,IAAME,MAAIA,oEAAOC,KAAsEA,UAAKC,IAEhG,IAAAvC,KAAIwC,MAAKA,eAAMJ,EAAgBD,MAM/B,OAFAnC,KAAAwC,MAAKA,EAAOL,OAAZ,EAEAtC,EAAOA,UAAUc,IAAUG,KAAIJ,KAAMyB,EAAMA,KAK/C1B,EAAAA,UAAeE,MAAU8B,WAErB,OADAzC,KAAAwC,SACAxC,MAMJS,EAAAA,OAAewB,SAAkBA,GAC7B,OAAA,IAAOxB,EAAIA,GAAJR,WAOHQ,UAAkBA,EAFtBA,eAAAA","file":"../../scripts/utils/ajax-queue.js","sourcesContent":["define([\n], function(){\n//ASSUMES: jquery\n//=============================================================================\n/** @class AjaxQueue\n *  Class that allows queueing functions that return jQuery promises (such\n *  as ajax calls). Each function waits for the previous to complete before\n *  being called\n *\n *  @constructor accepts a list of functions and automatically begins\n *      processing them\n */\nfunction AjaxQueue( initialFunctions ){\n    //TODO: possibly rename to DeferredQueue\n    var self = this;\n    /** the main deferred for the entire queue - note: also sends notifications of progress */\n    self.deferred = jQuery.Deferred();\n    /** the queue array of functions */\n    self.queue = [];\n    /** cache the response from each deferred call - error or success */\n    self.responses = [];\n    /** total number of fn's to process */\n    self.numToProcess = 0;\n    /** is the queue processing/waiting for any calls to return? */\n    self.running = false;\n\n    self.init( initialFunctions || [] );\n    self.start();\n\n    return self;\n}\n\n/** add all fns in initialFunctions (if any) to the queue */\nAjaxQueue.prototype.init = function init( initialFunctions ){\n    var self = this;\n    initialFunctions.forEach( function( fn ){\n        self.add( fn );\n    });\n};\n\n/** add a fn to the queue */\nAjaxQueue.prototype.add = function add( fn ){\n    //console.debug( 'AjaxQueue.prototype.add:', fn );\n    var self = this,\n        index = this.queue.length;\n    this.numToProcess += 1;\n\n    this.queue.push( function(){\n        var fnIndex = index,\n            xhr = fn();\n        // if successful, notify using the deferred to allow tracking progress\n        xhr.done( function( response ){\n            self.deferred.notify({ curr: fnIndex, total: self.numToProcess, response: response });\n        });\n        // (regardless of previous error or success) if not last ajax call, shift and call the next\n        //  if last fn, resolve deferred\n        xhr.always( function( response ){\n            self.responses.push( response );\n            if( self.queue.length ){\n                self.queue.shift()();\n            } else {\n                self.stop();\n            }\n        });\n    });\n    return this;\n};\n\n/** start processing the queue */\nAjaxQueue.prototype.start = function start(){\n    if( this.queue.length ){\n        this.running = true;\n        this.queue.shift()();\n    }\n    return this;\n};\n\n/** stop the queue\n *  @param {boolean} causeFail  cause an error/fail on the main deferred\n *  @param {String} msg         message to send when rejecting the main deferred\n */\nAjaxQueue.prototype.stop = function stop( causeFail, msg ){\n    //TODO: doesn't abort current call\n    this.running = false;\n    this.queue = [];\n    if( causeFail ){\n        //TODO: spliced args instead\n        this.deferred.reject( msg );\n    } else {\n        this.deferred.resolve( this.responses );\n    }\n    this.numToProcess = 0;\n    this.deferred = jQuery.Deferred();\n    return this;\n};\n\n// only a handful of the deferred interface for now - possible YAGNI\n/** implement done from the jq deferred interface */\nAjaxQueue.prototype.done = function done( fn ){\n    return this.deferred.done( fn );\n};\n/** implement fail from the jq deferred interface */\nAjaxQueue.prototype.fail = function fail( fn ){\n    return this.deferred.fail( fn );\n};\n/** implement always from the jq deferred interface */\nAjaxQueue.prototype.always = function always( fn ){\n    return this.deferred.always( fn );\n};\n/** implement progress from the jq deferred interface */\nAjaxQueue.prototype.progress = function progress( fn ){\n    return this.deferred.progress( fn );\n};\n\n/** shortcut constructor / fire and forget\n *  @returns {Deferred} the queue's main deferred\n */\nAjaxQueue.create = function create( initialFunctions ){\n    return new AjaxQueue( initialFunctions ).deferred;\n};\n\n\n//=============================================================================\n/** @class NamedAjaxQueue\n *  @augments AjaxQueue\n *  Allows associating a name with a deferring fn and prevents adding deferring\n *  fns if the name has already been used. Useful to prevent build up of duplicate\n *  async calls.\n *  Both the array initialFunctions sent to constructor and any added later with\n *  add() should be objects (NOT functions) of the form:\n *  { name: some unique id,\n *    fn:   the deferring fn or ajax call }\n */\nfunction NamedAjaxQueue( initialFunctions ){\n    var self = this;\n    self.names = {};\n    AjaxQueue.call( this, initialFunctions );\n    return self;\n}\nNamedAjaxQueue.prototype = new AjaxQueue();\nNamedAjaxQueue.prototype.constructor = NamedAjaxQueue;\n\n/** add the obj.fn to the queue if obj.name hasn't been used before */\nNamedAjaxQueue.prototype.add = function add( obj ){\n    //console.debug( 'NamedAjaxQueue.adding:', obj )\n    //console.debug( 'NamedAjaxQueue.prototype.add:', obj );\n    if( !( obj.hasOwnProperty( 'name' ) && obj.hasOwnProperty( 'fn' ) ) ){\n        throw new Error( 'NamedAjaxQueue.add requires an object with both \"name\" and \"fn\": ' + JSON.stringify( obj ) );\n    }\n    if( this.names.hasOwnProperty( obj.name ) ){\n        //console.warn( 'name has been used:', obj.name );\n        return;\n    }\n    this.names[ obj.name ] = true;\n    //console.debug( '\\t names: ', this.names )\n    return AjaxQueue.prototype.add.call( this, obj.fn );\n    //console.debug( '\\t queue: ', this.queue.length );\n};\n\n/** override to remove names */\nNamedAjaxQueue.prototype.clear = function clear(){\n    this.names = {};\n    return this;\n};\n\n/** shortcut constructor / fire and forget\n *  @returns {Deferred} the queue's main deferred\n */\nNamedAjaxQueue.create = function create( initialFunctions ){\n    return new NamedAjaxQueue( initialFunctions ).deferred;\n};\n\n\n//=============================================================================\n    return {\n        AjaxQueue       : AjaxQueue,\n        NamedAjaxQueue  : NamedAjaxQueue\n    };\n});\n"]}