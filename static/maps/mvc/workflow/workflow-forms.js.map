{"version":3,"sources":["mvc/workflow/workflow-forms.js"],"names":["define","Utils","Form","ToolFormBase","Default","Backbone","View","extend","initialize","options","Tool","workflow","this","self","node","post_job_actions","inputs","input","type","info","indexOf","textify","extensions","__class__","fixed","value","is_workflow","length","deepeach","collapsible_value","undefined","_makeSections","merge","text_enable","text_disable","narrow","initial_errors","cls","process","form","postchange","model","attributes","current_state","id","tool_id","version","tool_version","$","data","create","Galaxy","emit","debug","root","url","success","update","config_form","update_field_data","error","response","datatypes","Object","keys","output_terminals","output_id","name","label","String","Boolean","ignore","help","payload","window","location","host","push","i","_makeSection","visit","head","head_list","action","pja_arg","p_id","p","d","j","action_arguments","slice","input_terminal_names","0","key","1","input_terminals","sort","a","b","unshift","input_config","title","flat","output","getWorkflowOutput","new_value","onchange","attemptUpdateOutputLabel","join"],"mappings":"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","file":"../../../scripts/mvc/workflow/workflow-forms.js","sourcesContent":["define( [ 'utils/utils', 'mvc/form/form-view', 'mvc/tool/tool-form-base' ], function( Utils, Form, ToolFormBase ) {\n\n    /** Default form wrapper for non-tool modules in the workflow editor. */\n    var Default = Backbone.View.extend({\n        initialize: function( options ) {\n            this.form = new Form( options );\n        }\n    });\n\n    /** Tool form wrapper for the workflow editor. */\n    var Tool = Backbone.View.extend({\n        initialize: function( options ) {\n            var self = this;\n            this.workflow = options.workflow;\n            this.node     = options.node;\n            if ( this.node ) {\n                this.post_job_actions = this.node.post_job_actions || {};\n                Utils.deepeach( options.inputs, function( input ) {\n                    if ( input.type ) {\n                        if ( [ 'data', 'data_collection' ].indexOf( input.type ) != -1 ) {\n                            input.type = 'hidden';\n                            input.info = 'Data input \\'' + input.name + '\\' (' + Utils.textify( input.extensions ) + ')';\n                            input.value = { '__class__': 'RuntimeValue' };\n                        } else if ( !input.fixed ) {\n                            input.collapsible_value = { '__class__': 'RuntimeValue' };\n                            input.is_workflow = ( input.options && input.options.length == 0 ) ||\n                                                ( [ 'integer', 'float' ].indexOf( input.type ) != -1 );\n                        }\n                    }\n                });\n                Utils.deepeach( options.inputs, function( input ) {\n                    input.type == 'conditional' && ( input.test_param.collapsible_value = undefined );\n                });\n                this._makeSections( options );\n                this.form = new ToolFormBase( Utils.merge( options, {\n                    text_enable     : 'Set in Advance',\n                    text_disable    : 'Set at Runtime',\n                    narrow          : true,\n                    initial_errors  : true,\n                    cls             : 'ui-portlet-narrow',\n                    postchange      : function( process, form ) {\n                        var options = form.model.attributes;\n                        var current_state = {\n                            tool_id         : options.id,\n                            tool_version    : options.version,\n                            type            : 'tool',\n                            inputs          : $.extend( true, {}, form.data.create() )\n                        }\n                        Galaxy.emit.debug( 'tool-form-workflow::postchange()', 'Sending current state.', current_state );\n                        Utils.request({\n                            type    : 'POST',\n                            url     : Galaxy.root + 'api/workflows/build_module',\n                            data    : current_state,\n                            success : function( data ) {\n                                form.update( data.config_form );\n                                form.errors( data.config_form );\n                                // This hasn't modified the workflow, just returned\n                                // module information for the tool to update the workflow\n                                // state stored on the client with. User needs to save\n                                // for this to take effect.\n                                self.node.update_field_data( data );\n                                Galaxy.emit.debug( 'tool-form-workflow::postchange()', 'Received new model.', data );\n                                process.resolve();\n                            },\n                            error   : function( response ) {\n                                Galaxy.emit.debug( 'tool-form-workflow::postchange()', 'Refresh request failed.', response );\n                                process.reject();\n                            }\n                        });\n                    },\n                }));\n            } else {\n                Galaxy.emit.debug('tool-form-workflow::initialize()', 'Node not found in workflow.');\n            }\n        },\n\n        /** Builds all sub sections */\n        _makeSections: function( options ){\n            var inputs = options.inputs;\n            var datatypes = options.datatypes;\n            var output_id = this.node.output_terminals && Object.keys( this.node.output_terminals )[ 0 ];\n            if ( output_id ) {\n                inputs.push({\n                    name        : 'pja__' + output_id + '__EmailAction',\n                    label       : 'Email notification',\n                    type        : 'boolean',\n                    value       : String( Boolean( this.post_job_actions[ 'EmailAction' + output_id ] ) ),\n                    ignore      : 'false',\n                    help        : 'An email notification will be sent when the job has completed.',\n                    payload     : {\n                        'host'  : window.location.host\n                    }\n                });\n                inputs.push({\n                    name        : 'pja__' + output_id + '__DeleteIntermediatesAction',\n                    label       : 'Output cleanup',\n                    type        : 'boolean',\n                    value       : String( Boolean( this.post_job_actions[ 'DeleteIntermediatesAction' + output_id ] ) ),\n                    ignore      : 'false',\n                    help        : 'Upon completion of this step, delete non-starred outputs from completed workflow steps if they are no longer required as inputs.'\n                });\n                for ( var i in this.node.output_terminals ) {\n                    inputs.push( this._makeSection( i, datatypes ) );\n                }\n            }\n        },\n\n        /** Builds sub section with step actions/annotation */\n        _makeSection: function( output_id, datatypes ){\n            var self = this;\n            var extensions = [];\n            var input_terminal_names = [];\n            for ( key in datatypes  ) {\n                extensions.push( { 0 : datatypes[ key ], 1 : datatypes[ key ] } );\n            }\n            for ( key in this.node.input_terminals ){\n                input_terminal_names.push( this.node.input_terminals[ key ].name );\n            }\n            extensions.sort( function( a, b ) {\n                return a.label > b.label ? 1 : a.label < b.label ? -1 : 0;\n            });\n            extensions.unshift({\n                0 : 'Sequences',\n                1 : 'Sequences'\n            });\n            extensions.unshift({\n                0 : 'Roadmaps',\n                1 : 'Roadmaps'\n            });\n            extensions.unshift({\n                0 : 'Leave unchanged',\n                1 : '__empty__'\n            });\n            var input_config = {\n                title   : 'Configure Output: \\'' + output_id + '\\'',\n                type    : 'section',\n                flat    : true,\n                inputs  : [{\n                    label       : 'Label',\n                    type        : 'text',\n                    value       : ( output = this.node.getWorkflowOutput( output_id ) ) && output.label || '',\n                    help        : 'This will provide a short name to describe the output - this must be unique across workflows.',\n                    onchange    : function( new_value ) {\n                        self.workflow.attemptUpdateOutputLabel( self.node, output_id, new_value );\n                    }\n                },{\n                    action      : 'RenameDatasetAction',\n                    pja_arg     : 'newname',\n                    label       : 'Rename dataset',\n                    type        : 'text',\n                    value       : '',\n                    ignore      : '',\n                    help        : 'This action will rename the output dataset. Click <a href=\"https://galaxyproject.org/learn/advanced-workflow/variables/\">here</a> for more information. Valid inputs are: <strong>' + input_terminal_names.join(', ') + '</strong>.'\n                },{\n                    action      : 'ChangeDatatypeAction',\n                    pja_arg     : 'newtype',\n                    label       : 'Change datatype',\n                    type        : 'select',\n                    ignore      : '__empty__',\n                    value       : '__empty__',\n                    options     : extensions,\n                    help        : 'This action will change the datatype of the output to the indicated value.'\n                },{\n                    action      : 'TagDatasetAction',\n                    pja_arg     : 'tags',\n                    label       : 'Add Tags',\n                    type        : 'text',\n                    value       : '',\n                    ignore      : '',\n                    help        : 'This action will set tags for the dataset.'\n                },{\n                    action      : 'RemoveTagDatasetAction',\n                    pja_arg     : 'tags',\n                    label       : 'Remove Tags',\n                    type        : 'text',\n                    value       : '',\n                    ignore      : '',\n                    help        : 'This action will remove tags for the dataset.'\n                },{\n                    title   : 'Assign columns',\n                    type    : 'section',\n                    flat    : true,\n                    inputs  : [{\n                        action      : 'ColumnSetAction',\n                        pja_arg     : 'chromCol',\n                        label       : 'Chrom column',\n                        type        : 'integer',\n                        value       : '',\n                        ignore      : ''\n                    },{\n                        action      : 'ColumnSetAction',\n                        pja_arg     : 'startCol',\n                        label       : 'Start column',\n                        type        : 'integer',\n                        value       : '',\n                        ignore      : ''\n                    },{\n                        action      : 'ColumnSetAction',\n                        pja_arg     : 'endCol',\n                        label       : 'End column',\n                        type        : 'integer',\n                        value       : '',\n                        ignore      : ''\n                    },{\n                        action      : 'ColumnSetAction',\n                        pja_arg     : 'strandCol',\n                        label       : 'Strand column',\n                        type        : 'integer',\n                        value       : '',\n                        ignore      : ''\n                    },{\n                        action      : 'ColumnSetAction',\n                        pja_arg     : 'nameCol',\n                        label       : 'Name column',\n                        type        : 'integer',\n                        value       : '',\n                        ignore      : ''\n                    }],\n                    help    : 'This action will set column assignments in the output dataset. Blank fields are ignored.'\n                }]\n            };\n\n            // visit input nodes and enrich by name/value pairs from server data\n            function visit ( head, head_list ) {\n                head_list = head_list || [];\n                head_list.push( head );\n                for ( var i in head.inputs ) {\n                    var input = head.inputs[ i ];\n                    var action = input.action;\n                    if ( action ) {\n                        input.name = 'pja__' + output_id + '__' + input.action;\n                        if ( input.pja_arg ) {\n                            input.name += '__' + input.pja_arg;\n                        }\n                        if ( input.payload ) {\n                            for ( var p_id in input.payload ) {\n                                input.payload[ input.name + '__' + p_id ] = p;input.payload[ p_id ];\n                                delete input.payload[ p_id ];\n                            }\n                        }\n                        var d = self.post_job_actions[ input.action + output_id ];\n                        if ( d ) {\n                            for ( var j in head_list ) {\n                                head_list[ j ].expanded = true;\n                            }\n                            if ( input.pja_arg ) {\n                                input.value = d.action_arguments && d.action_arguments[ input.pja_arg ] || input.value;\n                            } else {\n                                input.value = 'true';\n                            }\n                        }\n                    }\n                    input.inputs && visit( input, head_list.slice( 0 ) );\n                }\n            }\n            visit( input_config );\n            return input_config;\n        }\n    });\n\n    return {\n        Default: Default,\n        Tool: Tool\n    };\n});\n"]}