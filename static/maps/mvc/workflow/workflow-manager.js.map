{"version":3,"sources":["mvc/workflow/workflow-manager.js"],"names":["define","Connector","app","canvas_container","this","id_counter","nodes","name","has_changes","active_form_has_changes","workflowOutputLabels","extend","Workflow","$","prototype","canLabelOutputWith","label","registerOutputLabel","unregisterOutputLabel","updateOutputLabel","fromLabel","toLabel","warning","node","labelWorkflowOutput","outputName","nodeView","redrawWorkflowOutputs","create_node","add_node","type","title_text","content_id","fit_canvas_to_nodes","canvas_manager","activate_node","draw_overview","element","id","workflow","remove_node","clear_active_node","active_node","remove_all","v","destroy","wf","k","rectify_workflow_outputs","using_workflow_outputs","each","has_existing_pjas","workflow_outputs","length","pja_id","pja","action_type","self","node_changed","post_job_actions","pjas_to_rem","push","pja_name","create_pja","ot_id","ot","isWorkflowOutput","output_name","action_arguments","reload_active_node","from_simple","input_terminals","i","input_connections","t","cons","connectors","con_dict","handle1","c","input_subworkflow_step_id","undefined","attributes","act","tool_version","tool_state","errors","config_form","version","position","annotation","uuid","node_data","steps","data","initialImport_","offset","initialImport","Object","max_id","keys","prebuildNode","step","workflow_output","parseInt","top","left","Math","max","isArray","other_node","connect","redraw","x","output_terminals","callout","attr","Galaxy","addWorkflowOutput","find","root","check_changes_in_active_form","submit","showAttributes","make_inactive","make_active","showForm","force","layout","n_pred","successors","j","other","node_ids_by_level","level_parents","pred_k","sk","all_nodes","v_pad","ids","sort","a","b","max_width","css","width","height","_","bounds_for_all_nodes","xmin","Infinity","xmax","ymax","ymin","p","min","e","ceil","n","fix_delta","round_up","bounds","parent","xmin_delta","ymin_delta","children"],"mappings":"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","file":"../../../scripts/mvc/workflow/workflow-manager.js","sourcesContent":["define([\n    'mvc/workflow/workflow-connector',\n    'libs/toastr'\n    ],\nfunction( Connector, Toastr ) {\n    function Workflow( app, canvas_container ) {\n        this.app = app;\n        this.canvas_container = canvas_container;\n        this.id_counter = 0;\n        this.nodes = {};\n        this.name = null;\n        this.has_changes = false;\n        this.active_form_has_changes = false;\n        this.workflowOutputLabels = {};\n    }\n    $.extend( Workflow.prototype, {\n        canLabelOutputWith: function( label ) {\n            if( label ) {\n                return ! (label in this.workflowOutputLabels);\n            } else {\n                // empty labels are non-exclusive, so allow this one.\n                return true;\n            }\n        },\n        registerOutputLabel: function( label ) {\n            if( label ) {\n                this.workflowOutputLabels[label] = true;\n            }\n        },\n        unregisterOutputLabel: function( label ) {\n            if( label ) {\n                delete this.workflowOutputLabels[label];\n            }\n        },\n        updateOutputLabel: function( fromLabel, toLabel ) {\n            if( fromLabel ) {\n                this.unregisterOutputLabel( fromLabel );\n            }\n            if( ! this.canLabelOutputWith( toLabel ) ) {\n                Toastr.warning(\"Workflow contains duplicate workflow output labels \" + toLabel + \". This must be fixed before it can be saved.\");\n            }\n            if( toLabel ) {\n                this.registerOutputLabel( toLabel );\n            }\n        },\n        attemptUpdateOutputLabel: function( node, outputName, label ) {\n            if( this.canLabelOutputWith( label ) ) {\n                node.labelWorkflowOutput( outputName, label );\n                node.nodeView.redrawWorkflowOutputs();\n                return true;\n            } else {\n                return false;\n            }\n        },\n        create_node: function ( type, title_text, content_id ) {\n            var node = this.app.prebuildNode( type, title_text, content_id );\n            this.add_node( node );\n            this.fit_canvas_to_nodes();\n            this.app.canvas_manager.draw_overview();\n            this.activate_node( node );\n            return node;\n        },\n        add_node : function( node ) {\n            node.id = this.id_counter;\n            node.element.attr( 'id', 'wf-node-step-' + node.id );\n            this.id_counter++;\n            this.nodes[ node.id ] = node;\n            this.has_changes = true;\n            node.workflow = this;\n        },\n        remove_node : function( node ) {\n            if ( this.active_node == node ) {\n                this.clear_active_node();\n            }\n            delete this.nodes[ node.id ];\n            this.has_changes = true;\n        },\n        remove_all : function() {\n            var wf = this;\n            $.each( this.nodes, function ( k, v ) {\n                v.destroy();\n                wf.remove_node( v );\n            });\n        },\n        rectify_workflow_outputs : function() {\n            // Find out if we're using workflow_outputs or not.\n            var using_workflow_outputs = false;\n            var has_existing_pjas = false;\n            $.each( this.nodes, function ( k, node ) {\n                if (node.workflow_outputs && node.workflow_outputs.length > 0){\n                    using_workflow_outputs = true;\n                }\n                $.each(node.post_job_actions, function(pja_id, pja){\n                    if (pja.action_type === \"HideDatasetAction\"){\n                        has_existing_pjas = true;\n                    }\n                });\n            });\n            if (using_workflow_outputs !== false || has_existing_pjas !== false){\n                // Using workflow outputs, or has existing pjas.  Remove all PJAs and recreate based on outputs.\n                var self = this;\n                $.each(this.nodes, function (k, node ){\n                    if (node.type === 'tool'){\n                        var node_changed = false;\n                        if (node.post_job_actions === null){\n                            node.post_job_actions = {};\n                            node_changed = true;\n                        }\n                        var pjas_to_rem = [];\n                        $.each(node.post_job_actions, function(pja_id, pja){\n                            if (pja.action_type == \"HideDatasetAction\"){\n                                pjas_to_rem.push(pja_id);\n                            }\n                        });\n                        if (pjas_to_rem.length > 0 ) {\n                            $.each(pjas_to_rem, function(i, pja_name){\n                                node_changed = true;\n                                delete node.post_job_actions[pja_name];\n                            });\n                        }\n                        if (using_workflow_outputs){\n                            $.each(node.output_terminals, function(ot_id, ot){\n                                var create_pja = !node.isWorkflowOutput(ot.name);\n                                if (create_pja === true){\n                                    node_changed = true;\n                                    var pja = {\n                                        action_type : \"HideDatasetAction\",\n                                        output_name : ot.name,\n                                        action_arguments : {}\n                                    };\n                                    node.post_job_actions['HideDatasetAction'+ot.name] = null;\n                                    node.post_job_actions['HideDatasetAction'+ot.name] = pja;\n                                }\n                            });\n                        }\n                        // lastly, if this is the active node, and we made changes, reload the display at right.\n                        if (self.active_node == node && node_changed === true) {\n                            self.reload_active_node();\n                        }\n                    }\n                });\n            }\n        },\n        to_simple : function () {\n            var nodes = {};\n            $.each( this.nodes, function ( i, node ) {\n                var input_connections = {};\n                $.each( node.input_terminals, function ( k, t ) {\n                    input_connections[ t.name ] = null;\n                    // There should only be 0 or 1 connectors, so this is\n                    // really a sneaky if statement\n                    var cons = [];\n                    $.each( t.connectors, function ( i, c ) {\n                        if ( c.handle1 ) {\n                            var con_dict = { id: c.handle1.node.id, output_name: c.handle1.name };\n                            var input_subworkflow_step_id = t.attributes.input.input_subworkflow_step_id;\n                            if( input_subworkflow_step_id !== undefined ) {\n                                con_dict[\"input_subworkflow_step_id\"] = input_subworkflow_step_id;\n                            }\n                            cons[i] = con_dict;\n                            input_connections[ t.name ] = cons;\n                        }\n                    });\n                });\n                var post_job_actions = {};\n                if (node.post_job_actions){\n                    $.each( node.post_job_actions, function ( i, act ) {\n                        var pja = {\n                            action_type : act.action_type,\n                            output_name : act.output_name,\n                            action_arguments : act.action_arguments\n                        };\n                        post_job_actions[ act.action_type + act.output_name ] = null;\n                        post_job_actions[ act.action_type + act.output_name ] = pja;\n                    });\n                }\n                if (!node.workflow_outputs){\n                    node.workflow_outputs = [];\n                    // Just in case.\n                }\n                var node_data = {\n                    id : node.id,\n                    type : node.type,\n                    content_id : node.content_id,\n                    tool_version : node.config_form.version,\n                    tool_state : node.tool_state,\n                    errors : node.errors,\n                    input_connections : input_connections,\n                    position : $(node.element).position(),\n                    annotation : node.annotation,\n                    post_job_actions : node.post_job_actions,\n                    uuid : node.uuid,\n                    label : node.label,\n                    workflow_outputs : node.workflow_outputs\n                };\n                nodes[ node.id ] = node_data;\n            });\n            return { steps: nodes };\n        },\n        from_simple : function ( data, initialImport_ ) {\n            var initialImport = (initialImport_ === undefined) ? true : initialImport_;\n            var wf = this;\n            var offset = 0;\n            if( initialImport ) {\n                wf.name = data.name;\n            } else {\n                offset = Object.keys(wf.nodes).length;\n            }\n            var max_id = offset;\n            // First pass, nodes\n            var using_workflow_outputs = false;\n            $.each( data.steps, function( id, step ) {\n                var node = wf.app.prebuildNode( step.type, step.name, step.content_id );\n                // If workflow being copied into another, wipe UUID and let\n                // Galaxy assign new ones.\n                if( ! initialImport ) {\n                    step.uuid = null;\n                    $.each(step.workflow_outputs, function( name, workflow_output ) {\n                        workflow_output.uuid = null;\n                    });\n                }\n                node.init_field_data( step );\n                if ( step.position ) {\n                    node.element.css( { top: step.position.top, left: step.position.left } );\n                }\n                node.id = parseInt(step.id) + offset;\n                wf.nodes[ node.id ] = node;\n                max_id = Math.max( max_id, parseInt( id ) + offset );\n                // For older workflows, it's possible to have HideDataset PJAs, but not WorkflowOutputs.\n                // Check for either, and then add outputs in the next pass.\n                if (!using_workflow_outputs){\n                    if (node.workflow_outputs.length > 0){\n                        using_workflow_outputs = true;\n                    }\n                    else{\n                        $.each(node.post_job_actions || [], function(pja_id, pja){\n                            if (pja.action_type === \"HideDatasetAction\"){\n                                using_workflow_outputs = true;\n                            }\n                        });\n                    }\n                }\n            });\n            wf.id_counter = max_id + 1;\n            // Second pass, connections\n            $.each( data.steps, function( id, step ) {\n                var node = wf.nodes[parseInt(id) + offset];\n                $.each( step.input_connections, function( k, v ) {\n                    if ( v ) {\n                        if ( ! $.isArray( v ) ) {\n                            v = [ v ];\n                        }\n                        $.each( v, function( l, x ) {\n                            var other_node = wf.nodes[ parseInt(x.id) + offset ];\n                            var c = new Connector();\n                            c.connect( other_node.output_terminals[ x.output_name ],\n                                       node.input_terminals[ k ] );\n                            c.redraw();\n                        });\n                    }\n                });\n                if(using_workflow_outputs){\n                    // Ensure that every output terminal has a WorkflowOutput or HideDatasetAction.\n                    $.each(node.output_terminals, function(ot_id, ot){\n                        if(node.post_job_actions['HideDatasetAction'+ot.name] === undefined){\n                            node.addWorkflowOutput(ot.name);\n                            var callout = $(node.element).find('.callout.'+ot.name);\n                            callout.find('img').attr('src', Galaxy.root + 'static/images/fugue/asterisk-small.png');\n                            wf.has_changes = true;\n                        }\n                    });\n                }\n            });\n        },\n        check_changes_in_active_form : function() {\n            // If active form has changed, save it\n            if (this.active_form_has_changes) {\n                this.has_changes = true;\n                // Submit form.\n                $(\"#right-content\").find(\"form\").submit();\n                this.active_form_has_changes = false;\n            }\n        },\n        reload_active_node : function() {\n            if (this.active_node){\n                var node = this.active_node;\n                this.clear_active_node();\n                this.activate_node(node);\n            }\n        },\n        clear_active_node : function() {\n            if ( this.active_node ) {\n                this.active_node.make_inactive();\n                this.active_node = null;\n            }\n            this.app.showAttributes();\n        },\n        activate_node : function( node ) {\n            if ( this.active_node != node ) {\n                this.check_changes_in_active_form();\n                this.clear_active_node();\n                this.app.showForm( node.config_form, node );\n                node.make_active();\n                this.active_node = node;\n            }\n        },\n        node_changed : function ( node, force ) {\n            this.has_changes = true;\n            if ( this.active_node == node && force ) {\n                // Force changes to be saved even on new connection (previously dumped)\n                this.check_changes_in_active_form();\n                this.app.showForm( node.config_form, node );\n            }\n            this.app.showWorkflowParameters();\n        },\n        layout : function () {\n            this.check_changes_in_active_form();\n            this.has_changes = true;\n            // Prepare predecessor / successor tracking\n            var n_pred = {};\n            var successors = {};\n            // First pass to initialize arrays even for nodes with no connections\n            $.each( this.nodes, function( id, node ) {\n                if ( n_pred[id] === undefined ) { n_pred[id] = 0; }\n                if ( successors[id] === undefined ) { successors[id] = []; }\n            });\n            // Second pass to count predecessors and successors\n            $.each( this.nodes, function( id, node ) {\n                $.each( node.input_terminals, function ( j, t ) {\n                    $.each( t.connectors, function ( k, c ) {\n                        // A connection exists from `other` to `node`\n                        var other = c.handle1.node;\n                        // node gains a predecessor\n                        n_pred[node.id] += 1;\n                        // other gains a successor\n                        successors[other.id].push( node.id );\n                    });\n                });\n            });\n            // Assemble order, tracking levels\n            var node_ids_by_level = [];\n            while ( true ) {\n                // Everything without a predecessor\n                var level_parents = [];\n                for ( var pred_k in n_pred ) {\n                    if ( n_pred[ pred_k ] === 0 ) {\n                        level_parents.push( pred_k );\n                    }\n                }\n                if ( level_parents.length === 0 ) {\n                    break;\n                }\n                node_ids_by_level.push( level_parents );\n                // Remove the parents from this level, and decrement the number\n                // of predecessors for each successor\n                for ( var k in level_parents ) {\n                    var v = level_parents[k];\n                    delete n_pred[v];\n                    for ( var sk in successors[v] ) {\n                        n_pred[ successors[v][sk] ] -= 1;\n                    }\n                }\n            }\n            if ( n_pred.length ) {\n                // ERROR: CYCLE! Currently we do nothing\n                return;\n            }\n            // Layout each level\n            var all_nodes = this.nodes;\n            var h_pad = 80; v_pad = 30;\n            var left = h_pad;\n            $.each( node_ids_by_level, function( i, ids ) {\n                // We keep nodes in the same order in a level to give the user\n                // some control over ordering\n                ids.sort( function( a, b ) {\n                    return $(all_nodes[a].element).position().top - $(all_nodes[b].element).position().top;\n                });\n                // Position each node\n                var max_width = 0;\n                var top = v_pad;\n                $.each( ids, function( j, id ) {\n                    var node = all_nodes[id];\n                    var element = $(node.element);\n                    $(element).css( { top: top, left: left } );\n                    max_width = Math.max( max_width, $(element).width() );\n                    top += $(element).height() + v_pad;\n                });\n                left += max_width + h_pad;\n            });\n            // Need to redraw all connectors\n            $.each( all_nodes, function( _, node ) { node.redraw(); } );\n        },\n        bounds_for_all_nodes: function() {\n            var xmin = Infinity, xmax = -Infinity,\n                ymin = Infinity, ymax = -Infinity,\n                p;\n            $.each( this.nodes, function( id, node ) {\n                var e = $(node.element);\n                p = e.position();\n                xmin = Math.min( xmin, p.left );\n                xmax = Math.max( xmax, p.left + e.width() );\n                ymin = Math.min( ymin, p.top );\n                ymax = Math.max( ymax, p.top + e.width() );\n            });\n            return  { xmin: xmin, xmax: xmax, ymin: ymin, ymax: ymax };\n        },\n        fit_canvas_to_nodes: function() {\n            // Math utils\n            function round_up( x, n ) {\n                return Math.ceil( x / n ) * n;\n            }\n            function fix_delta( x, n ) {\n                if ( x < n|| x > 3*n ) {\n                    var new_pos = ( Math.ceil( ( ( x % n ) ) / n ) + 1 ) * n;\n                    return ( - ( x - new_pos ) );\n                }\n                return 0;\n            }\n            // Span of all elements\n            var bounds = this.bounds_for_all_nodes();\n            var position = this.canvas_container.position();\n            var parent = this.canvas_container.parent();\n            // Determine amount we need to expand on top/left\n            var xmin_delta = fix_delta( bounds.xmin, 100 );\n            var ymin_delta = fix_delta( bounds.ymin, 100 );\n            // May need to expand farther to fill viewport\n            xmin_delta = Math.max( xmin_delta, position.left );\n            ymin_delta = Math.max( ymin_delta, position.top );\n            var left = position.left - xmin_delta;\n            var top = position.top - ymin_delta;\n            // Same for width/height\n            var width = round_up( bounds.xmax + 100, 100 ) + xmin_delta;\n            var height = round_up( bounds.ymax + 100, 100 ) + ymin_delta;\n            width = Math.max( width, - left + parent.width() );\n            height = Math.max( height, - top + parent.height() );\n            // Grow the canvas container\n            this.canvas_container.css( {\n                left: left,\n                top: top,\n                width: width,\n                height: height\n            });\n            // Move elements back if needed\n            this.canvas_container.children().each( function() {\n                var p = $(this).position();\n                $(this).css( \"left\", p.left + xmin_delta );\n                $(this).css( \"top\", p.top + ymin_delta );\n            });\n        }\n    });\n    return Workflow;\n});\n"]}