{"version":3,"sources":["mvc/workflow/workflow.js"],"names":["define","Utils","Ui","build_messages","$el_message","$","response","getQueryString","_","escape","persistent","cls","Message","$el","View","Backbone","extend","this","setElement","initialize","render","self","getJSON","Galaxy","root","workflows","min_query_length","$el_workflow","_templateHeader","_templateActionButtons","length","append","adjust_actiondropdown","confirm_delete","wf","register_show_tool_menu","_templateNoWorkflow","$el_checkboxes","e","item","checkbox","checked","value","ajax","type","url","workflow_ids","ids","data","stringify","contentType","done","location","workflow","id","$el_wf_link","$el_shared_wf_link","name","click","search_workflow","$el_searchinput","$el_tabletr","min_querylen","on","val","query","regular_expression","RegExp","hide","test","text","show","css","show_in_tool_panel","_templateActions","owner","trHtml","tableHtml","each","checkbox_html","user","attributes","username","number_of_steps","published","ImportWorkflowView","slug","options","empty","_mainTemplate","myexperiment_target_url"],"mappings":"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","file":"../../../scripts/mvc/workflow/workflow.js","sourcesContent":["/** Workflow view */\ndefine( [ 'utils/utils', 'mvc/ui/ui-misc' ], function( Utils, Ui ) {\n\n    /** Build messages after user action */\n    function build_messages() {\n        var $el_message = $( '.response-message' ),\n            response = {};\n        response = {\n            'status': Utils.getQueryString( 'status' ),\n            'message': _.escape( Utils.getQueryString( 'message' ) ),\n            'persistent': true,\n            'cls': Utils.getQueryString( 'status' ) + 'message'\n        };\n        $el_message.empty().html( new Ui.Message( response ).$el );\n    }\n \n    /** View of the main workflow list page */\n    var View = Backbone.View.extend({\n\n        initialize: function() {\n            this.setElement( '<div/>' );\n            this.render();\n        },\n\n        render: function() {\n            var self = this,\n                min_query_length = 3;\n            $.getJSON( Galaxy.root + 'api/workflows/', function( workflows ) {\n                var $el_workflow = null;\n                // Add workflow header\n                self.$el.empty().append( self._templateHeader() );\n                // Add user actions message if any\n                build_messages();\n                $el_workflow = self.$( '.user-workflows' );\n                // Add the actions buttons\n                $el_workflow.append( self._templateActionButtons() );\n                if( workflows.length > 0) {\n                    $el_workflow.append( self._templateWorkflowTable( self, workflows) );\n                    self.adjust_actiondropdown( $el_workflow );\n                    // Register delete and run workflow events\n                    _.each( workflows, function( wf ) {\n                        self.confirm_delete( wf );\n                    });\n                    self.register_show_tool_menu();\n                    // Register search workflow event\n                    self.search_workflow( self.$( '.search-wf' ), self.$( '.workflow-search tr' ), min_query_length );\n                }\n                else {\n                    $el_workflow.append( self._templateNoWorkflow() );\n                }\n            });\n        },\n\n        // Save the workflow as an item in Tool panel\n        register_show_tool_menu: function() {\n            var $el_checkboxes = this.$( '.show-in-tool-panel' );\n            $el_checkboxes.on( 'click', function( e ) {\n                var ids = [];\n                // Look for all the checked checkboxes\n                for( var item = 0; item < $el_checkboxes.length; item++ ) {\n                    var checkbox = $el_checkboxes[ item ];\n                    if( checkbox.checked ) {\n                        ids.push( checkbox.value );\n                    }\n                }\n                // Save all the checked workflows\n                $.ajax({\n                    type: 'PUT',\n                    url: Galaxy.root + 'api/workflows/menu/',\n                    data: JSON.stringify( { 'workflow_ids': ids } ),\n                    contentType : 'application/json'\n                }).done( function( response ) {\n                    window.location = Galaxy.root + 'workflow';\n                });\n            });\n        },\n\n        /** Add confirm box before removing/unsharing workflow */\n        confirm_delete: function( workflow ) {\n            var $el_wf_link = this.$( '.link-confirm-' + workflow.id ),\n                $el_shared_wf_link = this.$( '.link-confirm-shared-' + workflow.id );\n            $el_wf_link.click( function() {\n                return confirm( \"Are you sure you want to delete workflow '\" + workflow.name + \"'?\" );\n            });\n            $el_shared_wf_link.click( function() {\n                return confirm( \"Are you sure you want to remove the shared workflow '\" + workflow.name + \"'?\" );\n            });\n        },\n\n        /** Implement client side workflow search/filtering */\n        search_workflow: function( $el_searchinput, $el_tabletr, min_querylen ) {\n            $el_searchinput.on( 'keyup', function () {\n                var query = $( this ).val();\n                // Filter when query is at least 3 characters\n                // otherwise show all rows\n                if( query.length >= min_querylen ) {\n                    // Ignore the query's case using 'i'\n                    var regular_expression = new RegExp( query, 'i' );\n                    $el_tabletr.hide();\n                    $el_tabletr.filter(function () {\n                        // Apply regular expression on each row's text\n                        // and show when there is a match\n                        return regular_expression.test( $( this ).text() );\n                    }).show();\n                }\n                else {\n                    $el_tabletr.show();\n                }\n            });\n        },\n\n        /** Ajust the position of dropdown with respect to table */\n        adjust_actiondropdown: function( $el ) {\n            $el.on( 'show.bs.dropdown', function () {\n                $el.css( \"overflow\", \"inherit\" );\n            });\n\n            $el.on( 'hide.bs.dropdown', function () {\n                $el.css( \"overflow\", \"auto\" );\n            });\n        },\n\n        /** Template for no workflow */\n        _templateNoWorkflow: function() {\n            return '<div class=\"wf-nodata\"> You have no workflows. </div>';\n        },\n\n        /** Template for actions buttons */\n        _templateActionButtons: function() {\n           return '<ul class=\"manage-table-actions\">' +\n                '<li>' +\n                    '<input class=\"search-wf form-control\" type=\"text\" autocomplete=\"off\" placeholder=\"search for workflow...\">' +\n                '</li>' +\n                '<li>' +\n                    '<a class=\"action-button fa fa-plus wf-action\" id=\"new-workflow\" title=\"Create new workflow\" href=\"'+ Galaxy.root +'workflow/create\">' +\n                    '</a>' +\n                '</li>' +\n                '<li>' +\n                    '<a class=\"action-button fa fa-upload wf-action\" id=\"import-workflow\" title=\"Upload or import workflow\" href=\"'+ Galaxy.root +'workflow/import_workflow\">' +\n                    '</a>' +\n                '</li>' +\n            '</ul>';\n        },\n\n        /** Template for workflow table */\n        _templateWorkflowTable: function( self, workflows ) {\n            var tableHtml = \"\", trHtml = \"\";\n            tableHtml = tableHtml + '<table class=\"table colored\"><thead>' +\n                    '<tr class=\"header\">' +\n                        '<th>Name</th>' +\n                        '<th>Owner</th>' +\n                        '<th># of Steps</th>' +\n                        '<th>Published</th>' +\n                        '<th>Show in tools panel</th>' +\n                    '</tr></thead>';\n            _.each( workflows, function( wf ) {\n                var checkbox_html = '<input type=\"checkbox\" class=\"show-in-tool-panel\" '+ ( wf.show_in_tool_panel ? 'checked=\"' + wf.show_in_tool_panel + '\"' : \"\" ) +' value=\"' + wf.id + '\">';\n                trHtml = trHtml + '<tr>' +\n                             '<td>' +\n                                 '<div class=\"dropdown\">' +\n                                     '<button class=\"menubutton\" type=\"button\" data-toggle=\"dropdown\">' +\n                                         _.escape( wf.name ) + '<span class=\"caret\"></span>' +\n                                     '</button>' +\n                                     self._templateActions( wf ) +\n                                 '</div>' +\n                              '</td>' +\n                              '<td>' + ( wf.owner === Galaxy.user.attributes.username ? \"You\" : wf.owner ) +'</td>' +\n                              '<td>' + wf.number_of_steps + '</td>' +\n                              '<td>' + ( wf.published ? \"Yes\" : \"No\" ) + '</td>' +\n                              '<td>'+ checkbox_html +'</td>' +\n                         '</tr>';\n            });\n            return tableHtml + '<tbody class=\"workflow-search\">' + trHtml + '</tbody></table>';\n        },\n\n        /** Template for user actions for workflows */\n        _templateActions: function( workflow ) {\n            if( workflow.owner === Galaxy.user.attributes.username ) {\n                return '<ul class=\"dropdown-menu action-dpd\">' +\n                           '<li><a href=\"'+ Galaxy.root +'workflow/editor?id='+ workflow.id +'\">Edit</a></li>' +\n                           '<li><a href=\"'+ Galaxy.root +'workflow/run?id='+ workflow.id +'\">Run</a></li>' +\n                           '<li><a href=\"'+ Galaxy.root +'workflow/sharing?id='+ workflow.id +'\">Share or Download</a></li>' +\n                           '<li><a href=\"'+ Galaxy.root +'workflow/copy?id='+ workflow.id +'\">Copy</a></li>' +\n                           '<li><a href=\"'+ Galaxy.root +'workflow/rename?id='+ workflow.id +'\">Rename</a></li>' +\n                           '<li><a href=\"'+ Galaxy.root +'workflow/display_by_id?id='+ workflow.id +'\">View</a></li>' +\n                           '<li><a class=\"link-confirm-'+ workflow.id +'\" href=\"'+ Galaxy.root +'workflow/delete?id='+ workflow.id +'\">Delete</a></li>' +\n                      '</ul>';\n            }\n            else {\n                return '<ul class=\"dropdown-menu action-dpd\">' +\n                         '<li><a href=\"'+ Galaxy.root +'workflow/display_by_username_and_slug?username='+ workflow.owner +'&slug='+ workflow.slug +'\">View</a></li>' +\n                         '<li><a href=\"'+ Galaxy.root +'workflow/run?id='+ workflow.id +'\">Run</a></li>' +\n                         '<li><a href=\"'+ Galaxy.root +'workflow/copy?id='+ workflow.id +'\">Copy</a></li>' +\n                         '<li><a class=\"link-confirm-shared-'+ workflow.id +'\" href=\"'+ Galaxy.root +'workflow/sharing?unshare_me=True&id='+ workflow.id +'\">Remove</a></li>' +\n                      '</ul>';\n            }\n        },\n\n        /** Main template */\n        _templateHeader: function() {\n            return '<div class=\"page-container\">' +\n                       '<div class=\"user-workflows wf\">' +\n                           '<div class=\"response-message\"></div>' +\n                           '<h2>Your workflows</h2>' +\n                       '</div>'+\n                   '</div>';\n        }\n    });\n\n    var ImportWorkflowView = Backbone.View.extend({\n\n        initialize: function() {\n            this.setElement( '<div/>' );\n            this.render();\n        },\n\n        /** Open page to import workflow */\n        render: function() {\n            var self = this;\n            $.getJSON( Galaxy.root + 'workflow/upload_import_workflow', function( options ) {\n                self.$el.empty().append( self._mainTemplate( options ) );\n            });\n        },\n\n        /** Template for the import workflow page */\n        _mainTemplate: function( options ) {\n            return \"<div class='toolForm'>\" +\n                       \"<div class='toolFormTitle'>Import Galaxy workflow</div>\" +\n                        \"<div class='toolFormBody'>\" +\n                            \"<form name='import_workflow' id='import_workflow' action='\"+ Galaxy.root + 'workflow/upload_import_workflow' +\"' enctype='multipart/form-data' method='POST'>\" +\n                            \"<div class='form-row'>\" +\n                                \"<label>Galaxy workflow URL:</label>\" + \n                                \"<input type='text' name='url' class='input-url' value='\"+ options.url +\"' size='40'>\" +\n                                \"<div class='toolParamHelp' style='clear: both;'>\" +\n                                    \"If the workflow is accessible via a URL, enter the URL above and click <b>Import</b>.\" +\n                                \"</div>\" +\n                                \"<div style='clear: both'></div>\" +\n                            \"</div>\" +\n                            \"<div class='form-row'>\" +\n                                \"<label>Galaxy workflow file:</label>\" +\n                            \"<div class='form-row-input'>\" +\n                                \"<input type='file' name='file_data' class='input-file'/>\" +\n                            \"</div>\" +\n                            \"<div class='toolParamHelp' style='clear: both;'>\" +\n                                \"If the workflow is in a file on your computer, choose it and then click <b>Import</b>.\" +\n                            \"</div>\" +\n                            \"<div style='clear: both'></div>\" +\n                            \"</div>\" +\n                            \"<div class='form-row'>\" +\n                                \"<input type='submit' class='primary-button wf-import' name='import_button' value='Import'>\" +\n                            \"</div>\" +\n                            \"</form>\" +\n                           \"<hr/>\" +\n                           \"<div class='form-row'>\" +\n                               \"<label>Import a Galaxy workflow from myExperiment:</label>\" +\n                               \"<div class='form-row-input'>\" +\n                                   \"<a href='\" + options.myexperiment_target_url + \"'> Visit myExperiment</a>\" +\n                               \"</div>\" +\n                               \"<div class='toolParamHelp' style='clear: both;'>\" +\n                                   \"Click the link above to visit myExperiment and browse for Galaxy workflows.\" +\n                               \"</div>\" +\n                               \"<div style='clear: both'></div>\" +\n                           \"</div>\" +\n                       \"</div>\" +\n                   \"</div>\";\n        },\n\n    });\n\n    return {\n        View  : View,\n        ImportWorkflowView : ImportWorkflowView\n    };\n});\n"]}