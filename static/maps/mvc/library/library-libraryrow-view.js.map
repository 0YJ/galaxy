{"version":3,"sources":["mvc/library/library-libraryrow-view.js"],"names":["define","mod_masthead","mod_utils","mod_toastr","LibraryRowView","Backbone","View","extend","events","click .edit_library_btn","click .cancel_library_btn","click .save_library_btn","click .delete_library_btn","click .undelete_library_btn","edit_mode","element_visibility_config","upload_library_btn","edit_library_btn","permission_library_btn","save_library_btn","cancel_library_btn","delete_library_btn","undelete_library_btn","initialize","library","this","render","Galaxy","libraries","libraryListView","collection","get","$el","data","prepareButtons","tmpl","templateRow","setElement","button_config","show","repaint","$","hide","old_element","replaceWith","find","tooltip","vis_config","edit_button_clicked","cancel_library_modification","save_library_modification","is_changed","new_name","val","length","warning","set","new_description","new_synopsis","row_view","save","patch","success","error","model","response","responseJSON","err_msg","info","delete_library","destroy","add","preferences","remove","undelete_library","url","urlRoot","id","_","template","join"],"mappings":"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","file":"../../../scripts/mvc/library/library-libraryrow-view.js","sourcesContent":["// dependencies\ndefine([\n    \"layout/masthead\",\n    \"utils/utils\",\n    \"libs/toastr\"],\nfunction(mod_masthead,\n         mod_utils,\n         mod_toastr) {\n\n// galaxy library row view\nvar LibraryRowView = Backbone.View.extend({\n  events: {\n    'click .edit_library_btn'           : 'edit_button_clicked',\n    'click .cancel_library_btn'         : 'cancel_library_modification',\n    'click .save_library_btn'           : 'save_library_modification',\n    'click .delete_library_btn'         : 'delete_library',\n    'click .undelete_library_btn'       : 'undelete_library'\n  },\n\n  edit_mode: false,\n\n  element_visibility_config: {\n    upload_library_btn: false,\n    edit_library_btn: false,\n    permission_library_btn: false,\n    save_library_btn: false,\n    cancel_library_btn: false,\n    delete_library_btn: false,\n    undelete_library_btn: false\n  },\n\n  initialize : function(library){\n    this.render(library);\n  },\n\n  render: function(library){\n    if (typeof library === 'undefined'){\n      library = Galaxy.libraries.libraryListView.collection.get(this.$el.data('id'));\n    }\n    this.prepareButtons(library);\n    var tmpl = this.templateRow();\n    this.setElement(tmpl({library:library, button_config: this.element_visibility_config, edit_mode: this.edit_mode}));\n    this.$el.show();\n    return this;\n  },\n\n  repaint: function(library){\n    /* need to hide manually because of the element removal in setElement\n    invoked in render() */\n    $(\".tooltip\").hide();\n    /* we need to store the old element to be able to replace it with\n    new one */\n    var old_element = this.$el;\n    /* if user canceled the library param is undefined,\n      if user saved and succeeded the updated library is rendered */\n    this.render();\n    old_element.replaceWith(this.$el);\n    /* now we attach new tooltips to the newly created row element */\n    this.$el.find(\"[data-toggle]\").tooltip();\n  },\n\n  /**\n   * Function modifies the visibility of buttons for\n   * the filling of the row template of given library.\n   */\n  prepareButtons: function(library){\n    vis_config = this.element_visibility_config;\n\n    if (this.edit_mode === false){\n      vis_config.save_library_btn = false;\n      vis_config.cancel_library_btn = false;\n      vis_config.delete_library_btn = false;\n      if (library.get('deleted') === true ){\n          vis_config.undelete_library_btn = true;\n          vis_config.upload_library_btn = false;\n          vis_config.edit_library_btn = false;\n          vis_config.permission_library_btn = false;\n      } else if (library.get('deleted') === false ) {\n        vis_config.save_library_btn = false;\n        vis_config.cancel_library_btn = false;\n        vis_config.undelete_library_btn = false;\n        if (library.get('can_user_add') === true){\n          vis_config.upload_library_btn = true;\n        }\n        if (library.get('can_user_modify') === true){\n          vis_config.edit_library_btn = true;\n        }\n        if (library.get('can_user_manage') === true){\n          vis_config.permission_library_btn = true;\n        }\n      }\n    } else if (this.edit_mode === true){\n      vis_config.upload_library_btn = false;\n      vis_config.edit_library_btn = false;\n      vis_config.permission_library_btn = false;\n      vis_config.save_library_btn = true;\n      vis_config.cancel_library_btn = true;\n      vis_config.delete_library_btn = true;\n      vis_config.undelete_library_btn = false;\n    }\n\n    this.element_visibility_config = vis_config;\n  },\n\n  /* User clicked the 'edit' button on row so we render a new row\n    that allows editing */\n  edit_button_clicked: function(){\n    this.edit_mode = true;\n    this.repaint();\n  },\n\n  /* User clicked the 'cancel' button so we render normal rowView */\n  cancel_library_modification: function(){\n    // mod_toastr.info('Modifications canceled');\n    this.edit_mode = false;\n    this.repaint();\n  },\n\n  save_library_modification: function(){\n    var library = Galaxy.libraries.libraryListView.collection.get(this.$el.data('id'));\n    var is_changed = false;\n\n    var new_name = this.$el.find('.input_library_name').val();\n    if (typeof new_name !== 'undefined' && new_name !== library.get('name') ){\n        if (new_name.length > 2){\n            library.set(\"name\", new_name);\n            is_changed = true;\n        } else{\n            mod_toastr.warning('Library name has to be at least 3 characters long.');\n            return;\n        }\n    }\n\n    var new_description = this.$el.find('.input_library_description').val();\n    if (typeof new_description !== 'undefined' && new_description !== library.get('description') ){\n        library.set(\"description\", new_description);\n        is_changed = true;\n    }\n\n    var new_synopsis = this.$el.find('.input_library_synopsis').val();\n    if (typeof new_synopsis !== 'undefined' && new_synopsis !== library.get('synopsis') ){\n        library.set(\"synopsis\", new_synopsis);\n        is_changed = true;\n    }\n\n    if (is_changed){\n      var row_view = this;\n        library.save(null, {\n          patch: true,\n          success: function(library) {\n            row_view.edit_mode = false;\n            row_view.repaint(library);\n            mod_toastr.success('Changes to library saved.');\n          },\n          error: function(model, response){\n            if (typeof response.responseJSON !== \"undefined\"){\n              mod_toastr.error(response.responseJSON.err_msg);\n            } else {\n              mod_toastr.error('An error occured while attempting to update the library.');\n            }\n          }\n        });\n    } else {\n      this.edit_mode = false;\n      this.repaint(library);\n      mod_toastr.info('Nothing has changed.');\n    }\n  },\n\n  delete_library: function(){\n    var library = Galaxy.libraries.libraryListView.collection.get(this.$el.data('id'));\n    var row_view = this;\n    // mark the library deleted\n    library.destroy({\n      success: function (library) {\n        library.set('deleted', true);\n        // add the new deleted library back to the collection (Galaxy specialty)\n        Galaxy.libraries.libraryListView.collection.add(library);\n        row_view.edit_mode = false;\n        if (Galaxy.libraries.preferences.get('with_deleted') === false){\n          $('.tooltip').hide();\n          row_view.repaint(library);\n          row_view.$el.remove();\n        } else if (Galaxy.libraries.preferences.get('with_deleted') === true){\n          row_view.repaint(library);\n        }\n        mod_toastr.success('Library has been marked deleted.');\n      },\n      error: function(model, response){\n        if (typeof response.responseJSON !== \"undefined\"){\n          mod_toastr.error(response.responseJSON.err_msg);\n        } else {\n          mod_toastr.error('An error occured during deleting the library.');\n        }\n      }\n    });\n  },\n\n  undelete_library: function(){\n    var library = Galaxy.libraries.libraryListView.collection.get(this.$el.data('id'));\n    var row_view = this;\n\n    // mark the library undeleted\n    library.url = library.urlRoot + library.id + '?undelete=true';\n    library.destroy({\n      success: function (library) {\n        // add the newly undeleted library back to the collection\n        // backbone does not accept changes through destroy, so update it too\n        library.set('deleted', false);\n        Galaxy.libraries.libraryListView.collection.add(library);\n        row_view.edit_mode = false;\n        row_view.repaint(library);\n        mod_toastr.success('Library has been undeleted.');\n      },\n      error: function(model, response){\n        if (typeof response.responseJSON !== \"undefined\"){\n          mod_toastr.error(response.responseJSON.err_msg);\n        } else {\n          mod_toastr.error('An error occured while undeleting the library.');\n        }\n      }\n    });\n  },\n\n  templateRow: function() {\n    return _.template([\n    '<tr class=\"<% if(library.get(\"deleted\") === true) { print(\"active\") } %>\" style=\"display:none;\" data-id=\"<%- library.get(\"id\") %>\">',\n      '<% if(!edit_mode) { %>',\n        '<% if(library.get(\"deleted\")) { %>',\n          '<td style=\"color:grey;\"><span data-toggle=\"tooltip\" data-placement=\"top\" title=\"Marked deleted\" style=\"color:grey;\" class=\"fa fa-ban fa-lg deleted_lib_ico\"> </span> <%- library.get(\"name\") %></td>',\n        '<% } else { %>',\n          '<td><a href=\"#folders/<%- library.get(\"root_folder_id\") %>\"><%- library.get(\"name\") %></a></td>',\n        '<% } %>',\n      '<% if(library.get(\"description\")) { %>',\n        '<% if( (library.get(\"description\")).length> 80 ) { %>',\n          '<td data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"<%= _.escape(library.get(\"description\")) %>\"><%= _.escape(library.get(\"description\")).substring(0, 80) + \"...\" %></td>',\n        '<% } else { %>',\n          '<td><%= _.escape(library.get(\"description\"))%></td>',\n        '<% } %>',\n      '<% } else { %>',\n        '<td></td>',\n      '<% } %>',\n      '<% if(library.get(\"synopsis\")) { %>',\n        '<% if( (library.get(\"synopsis\")).length> 120 ) { %>',\n          '<td data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"<%= _.escape(library.get(\"synopsis\")) %>\"><%= _.escape(library.get(\"synopsis\")).substring(0, 120) + \"...\" %></td>',\n        '<% } else { %>',\n          '<td><%= _.escape(library.get(\"synopsis\"))%></td>',\n        '<% } %>',\n      '<% } else { %>',\n        '<td></td>',\n      '<% } %>',\n      '<% } else if(edit_mode){ %>',\n        '<td><textarea rows=\"4\" class=\"form-control input_library_name\" placeholder=\"name\" ><%- library.get(\"name\") %></textarea></td>',\n        '<td><textarea rows=\"4\" class=\"form-control input_library_description\" placeholder=\"description\" ><%- library.get(\"description\") %></textarea></td>',\n        '<td><textarea rows=\"4\" class=\"form-control input_library_synopsis\" placeholder=\"synopsis\" ><%- library.get(\"synopsis\") %></textarea></td>',\n      '<% } %>',\n      '<td class=\"right-center\">',\n        '<% if( (library.get(\"public\")) && (library.get(\"deleted\") === false) ) { %>',\n          '<span data-toggle=\"tooltip\" data-placement=\"top\" title=\"Unrestricted library\" style=\"color:grey;\" class=\"fa fa-globe fa-lg public_lib_ico\"> </span>',\n        '<% }%>',\n        '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Modify \\'<%- library.get(\"name\") %>\\'\" class=\"primary-button btn-xs edit_library_btn\" type=\"button\" style=\"<% if(button_config.edit_library_btn === false) { print(\"display:none;\") } %>\"><span class=\"fa fa-pencil\"></span></button>',\n        '<a href=\"#library/<%- library.get(\"id\") %>/permissions\"><button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Manage \\'<%- library.get(\"name\") %>\\'\" class=\"primary-button btn-xs permission_library_btn\" type=\"button\" style=\"<% if(button_config.permission_library_btn === false) { print(\"display:none;\") } %>\"><span class=\"fa fa-group\"></span></button></a>',\n        '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Save changes\" class=\"primary-button btn-xs save_library_btn\" type=\"button\" style=\"<% if(button_config.save_library_btn === false) { print(\"display:none;\") } %>\"><span class=\"fa fa-floppy-o\"> Save</span></button>',\n        '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Discard changes\" class=\"primary-button btn-xs cancel_library_btn\" type=\"button\" style=\"<% if(button_config.cancel_library_btn === false) { print(\"display:none;\") } %>\"><span class=\"fa fa-times\"> Cancel</span></button>',\n        '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Delete <%- library.get(\"name\") %>\" class=\"primary-button btn-xs delete_library_btn\" type=\"button\" style=\"<% if(button_config.delete_library_btn === false) { print(\"display:none;\") } %>\"><span class=\"fa fa-trash-o\"> Delete</span></button>',\n        '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Undelete <%- library.get(\"name\") %> \" class=\"primary-button btn-xs undelete_library_btn\" type=\"button\" style=\"<% if(button_config.undelete_library_btn === false) { print(\"display:none;\") } %>\"><span class=\"fa fa-unlock\"> Undelete</span></button>',\n      '</td>',\n    '</tr>'\n    ].join(''));\n  }\n\n});\n\nreturn {\n    LibraryRowView: LibraryRowView\n};\n\n});\n"]}