{"version":3,"sources":["mvc/library/library-libraryrow-view.js"],"names":["define","mod_masthead","LibraryRowView","events","Backbone","View","extend","click .edit_library_btn","click .cancel_library_btn","click .save_library_btn","edit_mode","click .undelete_library_btn","edit_library_btn","save_library_btn","cancel_library_btn","delete_library_btn","undelete_library_btn","initialize","render","library","this","prepareButtons","templateRow","tmpl","setElement","button_config","element_visibility_config","repaint","show","$","hide","old_element","replaceWith","$el","find","tooltip","vis_config","upload_library_btn","permission_library_btn","get","edit_button_clicked","cancel_library_modification","save_library_modification","new_name","libraries","libraryListView","data","is_changed","length","val","mod_toastr","warning","new_description","set","new_synopsis","success","row_view","error","model","response","responseJSON","err_msg","delete_library","destroy","Galaxy","collection","preferences","add","remove","undelete_library","url","urlRoot","id","_","template","join"],"mappings":"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","file":"../../../scripts/mvc/library/library-libraryrow-view.js","sourcesContent":["// dependencies\ndefine([\n    \"layout/masthead\",\n    \"utils/utils\",\n    \"libs/toastr\"],\nfunction(mod_masthead,\n         mod_utils,\n         mod_toastr) {\n\n// galaxy library row view\nvar LibraryRowView = Backbone.View.extend({\n  events: {\n    'click .edit_library_btn'           : 'edit_button_clicked',\n    'click .cancel_library_btn'         : 'cancel_library_modification',\n    'click .save_library_btn'           : 'save_library_modification',\n    'click .delete_library_btn'         : 'delete_library',\n    'click .undelete_library_btn'       : 'undelete_library'\n  },\n\n  edit_mode: false,\n\n  element_visibility_config: {\n    upload_library_btn: false,\n    edit_library_btn: false,\n    permission_library_btn: false,\n    save_library_btn: false,\n    cancel_library_btn: false,\n    delete_library_btn: false,\n    undelete_library_btn: false\n  },\n\n  initialize : function(library){\n    this.render(library);\n  },\n\n  render: function(library){\n    if (typeof library === 'undefined'){\n      library = Galaxy.libraries.libraryListView.collection.get(this.$el.data('id'));\n    }\n    this.prepareButtons(library);\n    var tmpl = this.templateRow();\n    this.setElement(tmpl({library:library, button_config: this.element_visibility_config, edit_mode: this.edit_mode}));\n    this.$el.show();\n    return this;\n  },\n\n  repaint: function(library){\n    /* need to hide manually because of the element removal in setElement\n    invoked in render() */\n    $(\".tooltip\").hide();\n    /* we need to store the old element to be able to replace it with\n    new one */\n    var old_element = this.$el;\n    /* if user canceled the library param is undefined,\n      if user saved and succeeded the updated library is rendered */\n    this.render();\n    old_element.replaceWith(this.$el);\n    /* now we attach new tooltips to the newly created row element */\n    this.$el.find(\"[data-toggle]\").tooltip();\n  },\n\n  /**\n   * Function modifies the visibility of buttons for\n   * the filling of the row template of given library.\n   */\n  prepareButtons: function(library){\n    var vis_config = this.element_visibility_config;\n\n    if (this.edit_mode === false){\n      vis_config.save_library_btn = false;\n      vis_config.cancel_library_btn = false;\n      vis_config.delete_library_btn = false;\n      if (library.get('deleted') === true ){\n          vis_config.undelete_library_btn = true;\n          vis_config.upload_library_btn = false;\n          vis_config.edit_library_btn = false;\n          vis_config.permission_library_btn = false;\n      } else if (library.get('deleted') === false ) {\n        vis_config.save_library_btn = false;\n        vis_config.cancel_library_btn = false;\n        vis_config.undelete_library_btn = false;\n        if (library.get('can_user_add') === true){\n          vis_config.upload_library_btn = true;\n        }\n        if (library.get('can_user_modify') === true){\n          vis_config.edit_library_btn = true;\n        }\n        if (library.get('can_user_manage') === true){\n          vis_config.permission_library_btn = true;\n        }\n      }\n    } else if (this.edit_mode === true){\n      vis_config.upload_library_btn = false;\n      vis_config.edit_library_btn = false;\n      vis_config.permission_library_btn = false;\n      vis_config.save_library_btn = true;\n      vis_config.cancel_library_btn = true;\n      vis_config.delete_library_btn = true;\n      vis_config.undelete_library_btn = false;\n    }\n\n    this.element_visibility_config = vis_config;\n  },\n\n  /* User clicked the 'edit' button on row so we render a new row\n    that allows editing */\n  edit_button_clicked: function(){\n    this.edit_mode = true;\n    this.repaint();\n  },\n\n  /* User clicked the 'cancel' button so we render normal rowView */\n  cancel_library_modification: function(){\n    // mod_toastr.info('Modifications canceled');\n    this.edit_mode = false;\n    this.repaint();\n  },\n\n  save_library_modification: function(){\n    var library = Galaxy.libraries.libraryListView.collection.get(this.$el.data('id'));\n    var is_changed = false;\n\n    var new_name = this.$el.find('.input_library_name').val();\n    if (typeof new_name !== 'undefined' && new_name !== library.get('name') ){\n        if (new_name.length > 2){\n            library.set(\"name\", new_name);\n            is_changed = true;\n        } else{\n            mod_toastr.warning('Library name has to be at least 3 characters long.');\n            return;\n        }\n    }\n\n    var new_description = this.$el.find('.input_library_description').val();\n    if (typeof new_description !== 'undefined' && new_description !== library.get('description') ){\n        library.set(\"description\", new_description);\n        is_changed = true;\n    }\n\n    var new_synopsis = this.$el.find('.input_library_synopsis').val();\n    if (typeof new_synopsis !== 'undefined' && new_synopsis !== library.get('synopsis') ){\n        library.set(\"synopsis\", new_synopsis);\n        is_changed = true;\n    }\n\n    if (is_changed){\n      var row_view = this;\n        library.save(null, {\n          patch: true,\n          success: function(library) {\n            row_view.edit_mode = false;\n            row_view.repaint(library);\n            mod_toastr.success('Changes to library saved.');\n          },\n          error: function(model, response){\n            if (typeof response.responseJSON !== \"undefined\"){\n              mod_toastr.error(response.responseJSON.err_msg);\n            } else {\n              mod_toastr.error('An error occured while attempting to update the library.');\n            }\n          }\n        });\n    } else {\n      this.edit_mode = false;\n      this.repaint(library);\n      mod_toastr.info('Nothing has changed.');\n    }\n  },\n\n  delete_library: function(){\n    var library = Galaxy.libraries.libraryListView.collection.get(this.$el.data('id'));\n    var row_view = this;\n    // mark the library deleted\n    library.destroy({\n      success: function (library) {\n        library.set('deleted', true);\n        // add the new deleted library back to the collection (Galaxy specialty)\n        Galaxy.libraries.libraryListView.collection.add(library);\n        row_view.edit_mode = false;\n        if (Galaxy.libraries.preferences.get('with_deleted') === false){\n          $('.tooltip').hide();\n          row_view.repaint(library);\n          row_view.$el.remove();\n        } else if (Galaxy.libraries.preferences.get('with_deleted') === true){\n          row_view.repaint(library);\n        }\n        mod_toastr.success('Library has been marked deleted.');\n      },\n      error: function(model, response){\n        if (typeof response.responseJSON !== \"undefined\"){\n          mod_toastr.error(response.responseJSON.err_msg);\n        } else {\n          mod_toastr.error('An error occured during deleting the library.');\n        }\n      }\n    });\n  },\n\n  undelete_library: function(){\n    var library = Galaxy.libraries.libraryListView.collection.get(this.$el.data('id'));\n    var row_view = this;\n\n    // mark the library undeleted\n    library.url = library.urlRoot + library.id + '?undelete=true';\n    library.destroy({\n      success: function (library) {\n        // add the newly undeleted library back to the collection\n        // backbone does not accept changes through destroy, so update it too\n        library.set('deleted', false);\n        Galaxy.libraries.libraryListView.collection.add(library);\n        row_view.edit_mode = false;\n        row_view.repaint(library);\n        mod_toastr.success('Library has been undeleted.');\n      },\n      error: function(model, response){\n        if (typeof response.responseJSON !== \"undefined\"){\n          mod_toastr.error(response.responseJSON.err_msg);\n        } else {\n          mod_toastr.error('An error occured while undeleting the library.');\n        }\n      }\n    });\n  },\n\n  templateRow: function() {\n    return _.template([\n    '<tr class=\"<% if(library.get(\"deleted\") === true) { print(\"active\") } %>\" style=\"display:none;\" data-id=\"<%- library.get(\"id\") %>\">',\n      '<% if(!edit_mode) { %>',\n        '<% if(library.get(\"deleted\")) { %>',\n          '<td style=\"color:grey;\"><span data-toggle=\"tooltip\" data-placement=\"top\" title=\"Marked deleted\" style=\"color:grey;\" class=\"fa fa-ban fa-lg deleted_lib_ico\"> </span> <%- library.get(\"name\") %></td>',\n        '<% } else { %>',\n          '<td><a href=\"#folders/<%- library.get(\"root_folder_id\") %>\"><%- library.get(\"name\") %></a></td>',\n        '<% } %>',\n      '<% if(library.get(\"description\")) { %>',\n        '<% if( (library.get(\"description\")).length> 80 ) { %>',\n          '<td data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"<%= _.escape(library.get(\"description\")) %>\"><%= _.escape(library.get(\"description\")).substring(0, 80) + \"...\" %></td>',\n        '<% } else { %>',\n          '<td><%= _.escape(library.get(\"description\"))%></td>',\n        '<% } %>',\n      '<% } else { %>',\n        '<td></td>',\n      '<% } %>',\n      '<% if(library.get(\"synopsis\")) { %>',\n        '<% if( (library.get(\"synopsis\")).length> 120 ) { %>',\n          '<td data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"<%= _.escape(library.get(\"synopsis\")) %>\"><%= _.escape(library.get(\"synopsis\")).substring(0, 120) + \"...\" %></td>',\n        '<% } else { %>',\n          '<td><%= _.escape(library.get(\"synopsis\"))%></td>',\n        '<% } %>',\n      '<% } else { %>',\n        '<td></td>',\n      '<% } %>',\n      '<% } else if(edit_mode){ %>',\n        '<td><textarea rows=\"4\" class=\"form-control input_library_name\" placeholder=\"name\" ><%- library.get(\"name\") %></textarea></td>',\n        '<td><textarea rows=\"4\" class=\"form-control input_library_description\" placeholder=\"description\" ><%- library.get(\"description\") %></textarea></td>',\n        '<td><textarea rows=\"4\" class=\"form-control input_library_synopsis\" placeholder=\"synopsis\" ><%- library.get(\"synopsis\") %></textarea></td>',\n      '<% } %>',\n      '<td class=\"right-center\">',\n        '<% if( (library.get(\"public\")) && (library.get(\"deleted\") === false) ) { %>',\n          '<span data-toggle=\"tooltip\" data-placement=\"top\" title=\"Unrestricted library\" style=\"color:grey;\" class=\"fa fa-globe fa-lg public_lib_ico\"> </span>',\n        '<% }%>',\n        '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Modify \\'<%- library.get(\"name\") %>\\'\" class=\"primary-button btn-xs edit_library_btn\" type=\"button\" style=\"<% if(button_config.edit_library_btn === false) { print(\"display:none;\") } %>\"><span class=\"fa fa-pencil\"></span></button>',\n        '<a href=\"#library/<%- library.get(\"id\") %>/permissions\"><button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Manage \\'<%- library.get(\"name\") %>\\'\" class=\"primary-button btn-xs permission_library_btn\" type=\"button\" style=\"<% if(button_config.permission_library_btn === false) { print(\"display:none;\") } %>\"><span class=\"fa fa-group\"></span></button></a>',\n        '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Save changes\" class=\"primary-button btn-xs save_library_btn\" type=\"button\" style=\"<% if(button_config.save_library_btn === false) { print(\"display:none;\") } %>\"><span class=\"fa fa-floppy-o\"> Save</span></button>',\n        '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Discard changes\" class=\"primary-button btn-xs cancel_library_btn\" type=\"button\" style=\"<% if(button_config.cancel_library_btn === false) { print(\"display:none;\") } %>\"><span class=\"fa fa-times\"> Cancel</span></button>',\n        '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Delete <%- library.get(\"name\") %>\" class=\"primary-button btn-xs delete_library_btn\" type=\"button\" style=\"<% if(button_config.delete_library_btn === false) { print(\"display:none;\") } %>\"><span class=\"fa fa-trash-o\"> Delete</span></button>',\n        '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Undelete <%- library.get(\"name\") %> \" class=\"primary-button btn-xs undelete_library_btn\" type=\"button\" style=\"<% if(button_config.undelete_library_btn === false) { print(\"display:none;\") } %>\"><span class=\"fa fa-unlock\"> Undelete</span></button>',\n      '</td>',\n    '</tr>'\n    ].join(''));\n  }\n\n});\n\nreturn {\n    LibraryRowView: LibraryRowView\n};\n\n});\n"]}