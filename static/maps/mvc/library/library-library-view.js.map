{"version":3,"sources":["mvc/library/library-library-view.js"],"names":["LibraryView","Backbone","View","extend","el","model","options","events","click .toolbtn_save_permissions","initialize","this","_","id","fetchLibrary","_libraryModel2","default","Library","fetch","success","that","show_permissions","showPermissions","error","response","responseJSON","_toastr2","err_msg","Galaxy","libraries","library_router","back","onclick","$","remove","undefined","fetched_permissions","access_library_role_list","is_unrestricted","is_admin","user","isAdmin","template","templateLibraryPermissions","$el","library","self","get","prepareSelectBoxes","fail","_serializeRoles","tooltip","i","role_list","selected_roles","length","selected_access_library_roles","selected_add_item_roles","selected_manage_library_roles","selected_modify_library_roles","add_library_item_role_list","_createSelectOptions","is_library_access","minimumInputLength","css","modify_library_role_list","container","find","ajax","url","dataType","quietMillis","data","q","term","_uiSelect2","page_limit","page","results","manageSelectObject","roles","formatResult","modifySelectObject","name","initSelection","item","init_data","callback","multiple","initialData","dropdownCssClass","select_options","makeDatasetPrivate","post","root","set","removeDatasetRestrictions","total","more","role","type","formatSelection","element","ids_list","val","split","each","push","savePermissions","add_ids","done","_extractIds","roles_list","event","access_ids","accessSelectObject","select2","addSelectObject","manage_ids","modify_ids","access_ids[]","add_ids[]","manage_ids[]","modify_ids[]","join"],"mappings":"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","file":"../../../scripts/mvc/library/library-library-view.js","sourcesContent":["import mod_toastr from \"libs/toastr\";\nimport mod_library_model from \"mvc/library/library-model\";\nimport mod_select from \"mvc/ui/ui-select\";\nvar LibraryView = Backbone.View.extend({\n    el: \"#center\",\n\n    model: null,\n\n    options: {},\n\n    events: {\n        \"click .toolbtn_save_permissions\": \"savePermissions\"\n    },\n\n    initialize: function(options) {\n        this.options = _.extend(this.options, options);\n        if (this.options.id) {\n            this.fetchLibrary();\n        }\n    },\n\n    fetchLibrary: function(options) {\n        this.options = _.extend(this.options, options);\n        this.model = new mod_library_model.Library({\n            id: this.options.id\n        });\n        var that = this;\n        this.model.fetch({\n            success: function() {\n                if (that.options.show_permissions) {\n                    that.showPermissions();\n                }\n            },\n            error: function(model, response) {\n                if (typeof response.responseJSON !== \"undefined\") {\n                    mod_toastr.error(\n                        response.responseJSON.err_msg +\n                            \" Click this to go back.\",\n                        \"\",\n                        {\n                            onclick: function() {\n                                Galaxy.libraries.library_router.back();\n                            }\n                        }\n                    );\n                } else {\n                    mod_toastr.error(\n                        \"An error occurred. Click this to go back.\",\n                        \"\",\n                        {\n                            onclick: function() {\n                                Galaxy.libraries.library_router.back();\n                            }\n                        }\n                    );\n                }\n            }\n        });\n    },\n\n    showPermissions: function(options) {\n        this.options = _.extend(this.options, options);\n        $(\".tooltip\").remove();\n\n        if (this.options.fetched_permissions !== undefined) {\n            if (\n                this.options.fetched_permissions.access_library_role_list\n                    .length === 0\n            ) {\n                this.model.set({ is_unrestricted: true });\n            } else {\n                this.model.set({ is_unrestricted: false });\n            }\n        }\n        var is_admin = false;\n        if (Galaxy.user) {\n            is_admin = Galaxy.user.isAdmin();\n        }\n        var template = this.templateLibraryPermissions();\n        this.$el.html(template({ library: this.model, is_admin: is_admin }));\n\n        var self = this;\n        $.get(\n            Galaxy.root +\n                \"api/libraries/\" +\n                self.id +\n                \"/permissions?scope=current\"\n        )\n            .done(function(fetched_permissions) {\n                self.prepareSelectBoxes({\n                    fetched_permissions: fetched_permissions\n                });\n            })\n            .fail(function() {\n                mod_toastr.error(\n                    \"An error occurred while attempting to fetch library permissions.\"\n                );\n            });\n\n        $(\"#center [data-toggle]\").tooltip();\n        //hack to show scrollbars\n        $(\"#center\").css(\"overflow\", \"auto\");\n    },\n\n    _serializeRoles: function(role_list) {\n        var selected_roles = [];\n        for (var i = 0; i < role_list.length; i++) {\n            selected_roles.push(role_list[i][1] + \":\" + role_list[i][0]);\n        }\n        return selected_roles;\n    },\n\n    prepareSelectBoxes: function(options) {\n        this.options = _.extend(this.options, options);\n        var fetched_permissions = this.options.fetched_permissions;\n        var self = this;\n\n        var selected_access_library_roles = this._serializeRoles(\n            fetched_permissions.access_library_role_list\n        );\n        var selected_add_item_roles = this._serializeRoles(\n            fetched_permissions.add_library_item_role_list\n        );\n        var selected_manage_library_roles = this._serializeRoles(\n            fetched_permissions.manage_library_role_list\n        );\n        var selected_modify_library_roles = this._serializeRoles(\n            fetched_permissions.modify_library_role_list\n        );\n\n        self.accessSelectObject = new mod_select.View(\n            this._createSelectOptions(\n                this,\n                \"access_perm\",\n                selected_access_library_roles,\n                true\n            )\n        );\n        self.addSelectObject = new mod_select.View(\n            this._createSelectOptions(\n                this,\n                \"add_perm\",\n                selected_add_item_roles,\n                false\n            )\n        );\n        self.manageSelectObject = new mod_select.View(\n            this._createSelectOptions(\n                this,\n                \"manage_perm\",\n                selected_manage_library_roles,\n                false\n            )\n        );\n        self.modifySelectObject = new mod_select.View(\n            this._createSelectOptions(\n                this,\n                \"modify_perm\",\n                selected_modify_library_roles,\n                false\n            )\n        );\n    },\n\n    _createSelectOptions: function(self, id, init_data, is_library_access) {\n        is_library_access =\n            is_library_access === true ? is_library_access : false;\n        var select_options = {\n            minimumInputLength: 0,\n            css: id,\n            multiple: true,\n            placeholder: \"Click to select a role\",\n            container: self.$el.find(\"#\" + id),\n            ajax: {\n                url:\n                    Galaxy.root +\n                    \"api/libraries/\" +\n                    self.id +\n                    \"/permissions?scope=available&is_library_access=\" +\n                    is_library_access,\n                dataType: \"json\",\n                quietMillis: 100,\n                data: function(term, page) {\n                    // page is the one-based page number tracked by Select2\n                    return {\n                        q: term, //search term\n                        page_limit: 10, // page size\n                        page: page // page number\n                    };\n                },\n                results: function(data, page) {\n                    var more = page * 10 < data.total; // whether or not there are more results available\n                    // notice we return the value of more so Select2 knows if more results can be loaded\n                    return { results: data.roles, more: more };\n                }\n            },\n            formatResult: function roleFormatResult(role) {\n                return role.name + \" type: \" + role.type;\n            },\n\n            formatSelection: function roleFormatSelection(role) {\n                return role.name;\n            },\n            initSelection: function(element, callback) {\n                // the input tag has a value attribute preloaded that points to a preselected role's id\n                // this function resolves that id attribute to an object that select2 can render\n                // using its formatResult renderer - that way the role name is shown preselected\n                var data = [];\n                $(element.val().split(\",\")).each(function() {\n                    var item = this.split(\":\");\n                    data.push({\n                        id: item[0],\n                        name: item[1]\n                    });\n                });\n                callback(data);\n            },\n            // initialData: init_data.join(','),\n            initialData: init_data,\n            dropdownCssClass: \"bigdrop\" // apply css that makes the dropdown taller\n        };\n\n        return select_options;\n    },\n\n    makeDatasetPrivate: function() {\n        var self = this;\n        $.post(\n            Galaxy.root +\n                \"api/libraries/datasets/\" +\n                self.id +\n                \"/permissions?action=make_private\"\n        )\n            .done(function(fetched_permissions) {\n                self.model.set({ is_unrestricted: false });\n                self.showPermissions({\n                    fetched_permissions: fetched_permissions\n                });\n                mod_toastr.success(\"The dataset is now private to you.\");\n            })\n            .fail(function() {\n                mod_toastr.error(\n                    \"An error occurred while attempting to make dataset private.\"\n                );\n            });\n    },\n\n    removeDatasetRestrictions: function() {\n        var self = this;\n        $.post(\n            Galaxy.root +\n                \"api/libraries/datasets/\" +\n                self.id +\n                \"/permissions?action=remove_restrictions\"\n        )\n            .done(function(fetched_permissions) {\n                self.model.set({ is_unrestricted: true });\n                self.showPermissions({\n                    fetched_permissions: fetched_permissions\n                });\n                mod_toastr.success(\n                    \"Access to this dataset is now unrestricted.\"\n                );\n            })\n            .fail(function() {\n                mod_toastr.error(\n                    \"An error occurred while attempting to make dataset unrestricted.\"\n                );\n            });\n    },\n\n    _extractIds: function(roles_list) {\n        var ids_list = [];\n        for (var i = roles_list.length - 1; i >= 0; i--) {\n            ids_list.push(roles_list[i].id);\n        }\n        return ids_list;\n    },\n    savePermissions: function(event) {\n        var self = this;\n\n        var access_ids = this._extractIds(\n            this.accessSelectObject.$el.select2(\"data\")\n        );\n        var add_ids = this._extractIds(\n            this.addSelectObject.$el.select2(\"data\")\n        );\n        var manage_ids = this._extractIds(\n            this.manageSelectObject.$el.select2(\"data\")\n        );\n        var modify_ids = this._extractIds(\n            this.modifySelectObject.$el.select2(\"data\")\n        );\n\n        $.post(\n            Galaxy.root +\n                \"api/libraries/\" +\n                self.id +\n                \"/permissions?action=set_permissions\",\n            {\n                \"access_ids[]\": access_ids,\n                \"add_ids[]\": add_ids,\n                \"manage_ids[]\": manage_ids,\n                \"modify_ids[]\": modify_ids\n            }\n        )\n            .done(function(fetched_permissions) {\n                //fetch dataset again\n                self.showPermissions({\n                    fetched_permissions: fetched_permissions\n                });\n                mod_toastr.success(\"Permissions saved.\");\n            })\n            .fail(function() {\n                mod_toastr.error(\n                    \"An error occurred while attempting to set library permissions.\"\n                );\n            });\n    },\n\n    templateLibraryPermissions: function() {\n        return _.template(\n            [\n                '<div class=\"library_style_container\">',\n                '<div id=\"library_toolbar\">',\n                '<a href=\"#\">',\n                '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Go back to the list of Libraries\" class=\"btn btn-default primary-button\" type=\"button\">',\n                '<span class=\"fa fa-list\"/>',\n                \"&nbsp;Libraries\",\n                \"</button>\",\n                \"</a>\",\n                \"</div>\",\n                \"<h1>\",\n                'Library: <%= _.escape(library.get(\"name\")) %>',\n                \"</h1>\",\n                '<div class=\"alert alert-warning\">',\n                \"<% if (is_admin) { %>\",\n                \"You are logged in as an <strong>administrator</strong> therefore you can manage any library on this Galaxy instance. Please make sure you understand the consequences.\",\n                \"<% } else { %>\",\n                \"You can assign any number of roles to any of the following permission types. However please read carefully the implications of such actions.\",\n                \"<% }%>\",\n                \"</div>\",\n                '<div class=\"dataset_table\">',\n                \"<h2>Library permissions</h2>\",\n                \"<h4>Roles that can access the library</h4>\",\n                '<div id=\"access_perm\" class=\"access_perm roles-selection\"/>',\n                '<div class=\"alert alert-info roles-selection\">',\n                \"User with <strong>any</strong> of these roles can access this library. If there are no access roles set on the library it is considered <strong>unrestricted</strong>.\",\n                \"</div>\",\n                \"<h4>Roles that can manage permissions on this library</h4>\",\n                '<div id=\"manage_perm\" class=\"manage_perm roles-selection\"/>',\n                '<div class=\"alert alert-info roles-selection\">',\n                \"User with <strong>any</strong> of these roles can manage permissions on this library (includes giving access).\",\n                \"</div>\",\n                \"<h4>Roles that can add items to this library</h4>\",\n                '<div id=\"add_perm\" class=\"add_perm roles-selection\"/>',\n                '<div class=\"alert alert-info roles-selection\">',\n                \"User with <strong>any</strong> of these roles can add items to this library (folders and datasets).\",\n                \"</div>\",\n                \"<h4>Roles that can modify this library</h4>\",\n                '<div id=\"modify_perm\" class=\"modify_perm roles-selection\"/>',\n                '<div class=\"alert alert-info roles-selection\">',\n                \"User with <strong>any</strong> of these roles can modify this library (name, synopsis, etc.).\",\n                \"</div>\",\n                '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Save modifications made on this page\" class=\"btn btn-default toolbtn_save_permissions primary-button\" type=\"button\">',\n                '<span class=\"fa fa-floppy-o\"/>',\n                \"&nbsp;Save\",\n                \"</button>\",\n                \"</div>\",\n                \"</div>\"\n            ].join(\"\")\n        );\n    }\n});\n\nexport default {\n    LibraryView: LibraryView\n};\n"]}