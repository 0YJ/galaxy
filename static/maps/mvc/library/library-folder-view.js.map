{"version":3,"sources":["mvc/library/library-folder-view.js"],"names":["define","el","mod_toastr","model","mod_select","FolderView","Backbone","View","extend","options","events","click .toolbtn_save_permissions","initialize","mod_library_model","this","_","fetch","success","that","FolderAsModel","id","error","Galaxy","libraries","showPermissions","response","responseJSON","err_msg","onclick","library_router","back","$","html","remove","template","templateFolder","shareFolder","item","info","get","tooltip","goBack","user","is_admin","isAdmin","self","prepareSelectBoxes","fail","folder","root","done","fetched_permissions","css","_serializeRoles","i","role_list","selected_roles","length","selected_add_item_roles","selected_manage_folder_roles","selected_modify_folder_roles","_createSelectOptions","manage_folder_role_list","modify_folder_role_list","init_data","manageSelectObject","minimumInputLength","placeholder","ajax","url","dataType","quietMillis","data","$el","find","term","page","q","page_limit","results","more","total","name","roles","role","type","formatSelection","roleFormatSelection","initSelection","element","callback","split","each","push","initialData","select_options","join","dropdownCssClass","copyToClipboard","href","window","prompt","history","location","lastIndexOf","substr","_extractIds","roles_list","ids_list","savePermissions","modify_ids","post","select2","modifySelectObject","add_ids[]","add_ids","manage_ids[]","manage_ids","modify_ids[]","templateFolderPermissions"],"mappings":"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","file":"../../../scripts/mvc/library/library-folder-view.js","sourcesContent":["define([\n  \"libs/toastr\",\n  \"mvc/library/library-model\",\n  'mvc/ui/ui-select'\n  ],\nfunction(\n        mod_toastr,\n        mod_library_model,\n        mod_select\n        ) {\n\nvar FolderView = Backbone.View.extend({\n  el: '#center',\n\n  model: null,\n\n  options: {\n\n  },\n\n  events: {\n    \"click .toolbtn_save_permissions\"     :   \"savePermissions\"\n  },\n\n  initialize: function(options){\n    this.options = _.extend(this.options, options);\n    if (this.options.id){\n      this.fetchFolder();\n    }\n  },\n\n  fetchFolder: function(options){\n    this.options = _.extend(this.options, options);\n    this.model = new mod_library_model.FolderAsModel({id:this.options.id});\n    var that = this;\n    this.model.fetch({\n      success: function() {\n        if (that.options.show_permissions){\n            that.showPermissions();\n        } else {\n            that.render();\n        }\n      },\n      error: function(model, response){\n        if (typeof response.responseJSON !== \"undefined\"){\n          mod_toastr.error(response.responseJSON.err_msg + ' Click this to go back.', '', {onclick: function() {Galaxy.libraries.library_router.back();}});\n        } else {\n          mod_toastr.error('An error ocurred. Click this to go back.', '', {onclick: function() {Galaxy.libraries.library_router.back();}});\n        }\n      }\n    });\n  },\n\n  render: function(options){\n    $(\".tooltip\").remove();\n    this.options = _.extend(this.options, options);\n    var template = this.templateFolder();\n    this.$el.html(template({item: this.model}));\n    $(\".peek\").html(this.model.get(\"peek\"));\n    $(\"#center [data-toggle]\").tooltip();\n  },\n\n  shareFolder: function(){\n    mod_toastr.info('Feature coming soon.');\n  },\n\n  goBack: function(){\n    Galaxy.libraries.library_router.back();\n  },\n\n  showPermissions: function(options){\n    this.options = _.extend(this.options, options);\n    $(\".tooltip\").remove();\n\n    var is_admin = false;\n    if (Galaxy.user){\n      is_admin = Galaxy.user.isAdmin();\n    }\n    var template = this.templateFolderPermissions();\n    this.$el.html(template({folder: this.model, is_admin:is_admin}));\n\n    var self = this;\n    $.get( Galaxy.root + \"api/folders/\" + self.id + \"/permissions?scope=current\").done(function(fetched_permissions) {\n      self.prepareSelectBoxes({fetched_permissions:fetched_permissions});\n    }).fail(function(){\n        mod_toastr.error('An error occurred while attempting to fetch folder permissions.');\n    });\n\n    $(\"#center [data-toggle]\").tooltip();\n    //hack to show scrollbars\n    $(\"#center\").css('overflow','auto');\n  },\n\n  _serializeRoles : function(role_list){\n    var selected_roles = [];\n    for (var i = 0; i < role_list.length; i++) {\n      selected_roles.push(role_list[i][1] + ':' + role_list[i][0]);\n    }\n    return selected_roles;\n  },\n\n  prepareSelectBoxes: function(options){\n    this.options = _.extend(this.options, options);\n    var fetched_permissions = this.options.fetched_permissions;\n    var self = this;\n\n    var selected_add_item_roles = this._serializeRoles(fetched_permissions.add_library_item_role_list);\n    var selected_manage_folder_roles = this._serializeRoles(fetched_permissions.manage_folder_role_list);\n    var selected_modify_folder_roles = this._serializeRoles(fetched_permissions.modify_folder_role_list);\n\n    self.addSelectObject = new mod_select.View(this._createSelectOptions(this, 'add_perm', selected_add_item_roles, false));\n    self.manageSelectObject = new mod_select.View(this._createSelectOptions(this, 'manage_perm', selected_manage_folder_roles, false));\n    self.modifySelectObject = new mod_select.View(this._createSelectOptions(this, 'modify_perm', selected_modify_folder_roles, false));\n  },\n\n  _createSelectOptions: function(self, id, init_data){\n    var select_options = {\n      minimumInputLength: 0,\n      css: id,\n      multiple:true,\n      placeholder: 'Click to select a role',\n      container: self.$el.find('#' + id),\n      ajax: {\n          url: Galaxy.root + \"api/folders/\" + self.id + \"/permissions?scope=available\",\n          dataType: 'json',\n          quietMillis: 100,\n          data: function (term, page) { // page is the one-based page number tracked by Select2\n              return {\n                  q: term, //search term\n                  page_limit: 10, // page size\n                  page: page // page number\n              };\n          },\n          results: function (data, page) {\n              var more = (page * 10) < data.total; // whether or not there are more results available\n              // notice we return the value of more so Select2 knows if more results can be loaded\n              return {results: data.roles, more: more};\n          }\n      },\n      formatResult : function roleFormatResult(role) {\n          return role.name + ' type: ' + role.type;\n      },\n\n      formatSelection: function roleFormatSelection(role) {\n          return role.name;\n      },\n      initSelection: function(element, callback) {\n      // the input tag has a value attribute preloaded that points to a preselected role's id\n      // this function resolves that id attribute to an object that select2 can render\n      // using its formatResult renderer - that way the role name is shown preselected\n          var data = [];\n          $(element.val().split(\",\")).each(function() {\n              var item = this.split(':');\n              data.push({\n                  id: item[0],\n                  name: item[1]\n              });\n          });\n          callback(data);\n      },\n      initialData: init_data.join(','),\n      dropdownCssClass: \"bigdrop\" // apply css that makes the dropdown taller\n    };\n\n    return select_options;\n  },\n\n  comingSoon: function(){\n    mod_toastr.warning('Feature coming soon.');\n  },\n\n  copyToClipboard: function(){\n    var href = Backbone.history.location.href;\n    if (href.lastIndexOf('/permissions') !== -1){\n      href = href.substr(0, href.lastIndexOf('/permissions'));\n    }\n    window.prompt(\"Copy to clipboard: Ctrl+C, Enter\", href);\n  },\n\n  /**\n   * Extract the role ids from Select2 elements's 'data'\n   */\n  _extractIds: function(roles_list){\n    var ids_list = [];\n    for (var i = roles_list.length - 1; i >= 0; i--) {\n      ids_list.push(roles_list[i].id);\n    };\n    return ids_list;\n  },\n\n  /**\n   * Save the permissions for roles entered in the select boxes.\n   */\n  savePermissions: function(event){\n    var self = this;\n    var add_ids = this._extractIds(this.addSelectObject.$el.select2('data'));\n    var manage_ids = this._extractIds(this.manageSelectObject.$el.select2('data'));\n    var modify_ids = this._extractIds(this.modifySelectObject.$el.select2('data'));\n    $.post( Galaxy.root + \"api/folders/\" + self.id + \"/permissions?action=set_permissions\", { 'add_ids[]': add_ids, 'manage_ids[]': manage_ids, 'modify_ids[]': modify_ids, } )\n    .done(function(fetched_permissions){\n      self.showPermissions({fetched_permissions:fetched_permissions})\n      mod_toastr.success('Permissions saved.');\n    })\n    .fail(function(){\n      mod_toastr.error('An error occurred while attempting to set folder permissions.');\n    })\n  },\n\n  templateFolder : function(){\n    return _.template([\n    '<div class=\"library_style_container\">',\n      '<div id=\"library_toolbar\">',\n        '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Modify library item\" class=\"btn btn-default toolbtn_modify_dataset primary-button\" type=\"button\">',\n          '<span class=\"fa fa-pencil\"/>',\n          '&nbsp;Modify',\n        '</button>',\n        '<a href=\"#folders/<%- item.get(\"folder_id\") %>/datasets/<%- item.id %>/permissions\">',\n          '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Manage permissions\" class=\"btn btn-default toolbtn_change_permissions primary-button\" type=\"button\">',\n            '<span class=\"fa fa-group\"/>',\n            '&nbsp;Permissions',\n          '</button>',\n        '</a>',\n        '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Share dataset\" class=\"btn btn-default toolbtn-share-dataset primary-button\" type=\"button\">',\n          '<span class=\"fa fa-share\"/>',\n          '&nbsp;Share',\n          '</span>',\n        '</button>',\n      '</div>',\n      '<p>',\n        'This dataset is unrestricted so everybody can access it. Just share the URL of this page. ',\n        '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Copy to clipboard\" class=\"btn btn-default btn-copy-link-to-clipboard primary-button\" type=\"button\">',\n          '<span class=\"fa fa-clipboard\"/>',\n          '&nbsp;To Clipboard',\n        '</button> ',\n      '</p>',\n      '<div class=\"dataset_table\">',\n        '<table class=\"grid table table-striped table-condensed\">',\n          '<tr>',\n            '<th scope=\"row\" id=\"id_row\" data-id=\"<%= _.escape(item.get(\"ldda_id\")) %>\">',\n              'Name',\n            '</th>',\n            '<td>',\n              '<%= _.escape(item.get(\"name\")) %>',\n            '</td>',\n          '</tr>',\n          '<% if (item.get(\"file_ext\")) { %>',\n            '<tr>',\n              '<th scope=\"row\">Data type</th>',\n              '<td>',\n                '<%= _.escape(item.get(\"file_ext\")) %>',\n              '</td>',\n            '</tr>',\n          '<% } %>',\n        '</table>',\n      '</div>',\n    '</div>'\n    ].join(''));\n  },\n\n  templateFolderPermissions : function(){\n    return _.template([\n    '<div class=\"library_style_container\">',\n      '<div id=\"library_toolbar\">',\n        '<a href=\"#/folders/<%= folder.get(\"parent_id\") %>\">',\n          '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Go back to the parent folder\" class=\"btn btn-default primary-button\" type=\"button\">',\n            '<span class=\"fa fa-caret-left fa-lg\"/>',\n            '&nbsp;Parent folder',\n          '</button>',\n        '</a>',\n      '</div>',\n      '<h1>',\n        'Folder: <%= _.escape(folder.get(\"name\")) %>',\n      '</h1>',\n      '<div class=\"alert alert-warning\">',\n        '<% if (is_admin) { %>',\n          'You are logged in as an <strong>administrator</strong> therefore you can manage any folder on this Galaxy instance. Please make sure you understand the consequences.',\n        '<% } else { %>',\n          'You can assign any number of roles to any of the following permission types. However please read carefully the implications of such actions.',\n        '<% }%>',\n      '</div>',\n      '<div class=\"dataset_table\">',\n        '<h2>Folder permissions</h2>',\n        '<h4>',\n          'Roles that can manage permissions on this folder',\n        '</h4>',\n        '<div id=\"manage_perm\" class=\"manage_perm roles-selection\"/>',\n        '<div class=\"alert alert-info roles-selection\">',\n          'User with <strong>any</strong> of these roles can manage permissions on this folder.',\n        '</div>',\n        '<h4>',\n          'Roles that can add items to this folder',\n        '</h4>',\n        '<div id=\"add_perm\" class=\"add_perm roles-selection\"/>',\n        '<div class=\"alert alert-info roles-selection\">',\n          'User with <strong>any</strong> of these roles can add items to this folder (folders and datasets).',\n        '</div>',\n        '<h4>',\n          'Roles that can modify this folder',\n        '</h4>',\n        '<div id=\"modify_perm\" class=\"modify_perm roles-selection\"/>',\n        '<div class=\"alert alert-info roles-selection\">',\n          'User with <strong>any</strong> of these roles can modify this folder (name, etc.).',\n        '</div>',\n        '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Save modifications\" class=\"btn btn-default toolbtn_save_permissions primary-button\" type=\"button\">',\n          '<span class=\"fa fa-floppy-o\"/>',\n          '&nbsp;Save',\n        '</button>',\n      '</div>',\n    '</div>'\n    ].join(''));\n  }\n\n});\n\nreturn {\n    FolderView: FolderView\n};\n\n});\n"]}