{"version":3,"sources":["mvc/library/library-librarylist-view.js"],"names":["define","el","events","mod_masthead","mod_baseMVC","defaults","page_count","show_page","all_fetched","_","LibraryListView","Backbone","View","extend","initialize","options","collection","mod_toastr","error","this","that","modal","mod_library_model","Libraries","url","urlRoot","fetch","success","render","model","response","template","templateLibraryList","libraries_to_render","setElement","models","libraries","$","hide","is_deleted","sortLibraries","Galaxy","preferences","get","where","deleted","page_start","Math","html","order","length","search_term","libraryToolbarView","ceil","total_libraries_count","renderPaginator","slice","libraries_shown","$el","renderRows","tooltip","remove","responseJSON","err_msg","library","rowView","mod_library_libraryrow_view","LibraryRowView","find","i","renderOne","append","sort_clicked","sortByNameAsc","redirectToLogin","window","location","sortByNameDesc","searchLibraries","trimmed_term","results","trim","search","searching","join"],"mappings":"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","file":"../../../scripts/mvc/library/library-librarylist-view.js","sourcesContent":["define([\n    \"layout/masthead\",\n    \"mvc/base-mvc\",\n    \"utils/utils\",\n    \"libs/toastr\",\n    \"mvc/library/library-model\",\n    \"mvc/library/library-libraryrow-view\",\n    \"libs/underscore\"\n], function(\n    mod_masthead,\n    mod_baseMVC,\n    mod_utils,\n    mod_toastr,\n    mod_library_model,\n    mod_library_libraryrow_view,\n    _\n){\n\nvar LibraryListView = Backbone.View.extend({\n    el: '#libraries_element',\n\n    events: {\n        'click .sort-libraries-link'    : 'sort_clicked'\n    },\n\n    defaults: {\n        page_count: null,\n        show_page: null,\n        all_fetched: false\n    },\n\n    /**\n     * Initialize and fetch the libraries from server.\n     * Async render afterwards.\n     * @param  {object} options an object with options\n     */\n    initialize : function( options ){\n        this.options = _.defaults( this.options || {}, options, this.defaults );\n        var that = this;\n        this.modal = null;\n        // collection of {Item}s\n        this.collection = new mod_library_model.Libraries();\n        this.collection.url = this.collection.urlRoot + '?deleted=false';\n        this.collection.fetch({\n          success: function(){\n            that.render();\n          },\n          error: function( model, response ){\n              if ( typeof response.responseJSON !== \"undefined\" ){\n                mod_toastr.error( response.responseJSON.err_msg );\n              } else {\n                mod_toastr.error( 'An error ocurred.' );\n              }\n          }\n        });\n    },\n\n    /**\n     * Render the libraries table either from the object's own collection,\n     * or from a given array of library models,\n     * or render an empty list in case no data is given.\n     */\n    render: function ( options ) {\n        this.options = _.extend( this.options, options );\n        this.setElement('#libraries_element');\n        var template = this.templateLibraryList();\n        var libraries_to_render = null;\n        var models = null;\n        $( \".tooltip\" ).hide();\n        if ( typeof options !== 'undefined' ){\n            models = typeof options.models !== 'undefined' ? options.models : null;\n        }\n        if ( this.collection !== null && models === null ){\n            this.sortLibraries();\n            if ( Galaxy.libraries.preferences.get( 'with_deleted' ) ){\n              libraries_to_render = this.collection.models;\n            } else {\n              libraries_to_render = this.collection.where( { deleted: false } );\n            }\n        } else if ( models !== null ){\n            if ( Galaxy.libraries.preferences.get( 'with_deleted' ) ){\n                libraries_to_render = models;\n            } else {\n                var is_deleted = function(model){ return model.get('deleted') === false; }\n                libraries_to_render = _.filter(models, is_deleted );\n            }\n        } else {\n            libraries_to_render = [];\n        }\n\n        // pagination\n        if ( this.options.show_page === null || this.options.show_page < 1 ){\n            this.options.show_page = 1;\n        }\n        this.options.total_libraries_count = libraries_to_render.length\n        var page_start = ( Galaxy.libraries.preferences.get( 'library_page_size' ) * ( this.options.show_page - 1 ) );\n        this.options.page_count = Math.ceil( this.options.total_libraries_count / Galaxy.libraries.preferences.get( 'library_page_size' ) );\n        if ( this.options.total_libraries_count > 0 && ( page_start < this.options.total_libraries_count ) ){\n            libraries_to_render = libraries_to_render.slice( page_start, page_start + Galaxy.libraries.preferences.get( 'library_page_size' ) );\n            this.options.libraries_shown = libraries_to_render.length;\n            // User requests page with no libraries\n            if ( Galaxy.libraries.preferences.get( 'library_page_size' ) * this.options.show_page > ( this.options.total_libraries_count + Galaxy.libraries.preferences.get( 'library_page_size' ) ) ){\n                libraries_to_render = [];\n            }\n            this.$el.html( template({\n                length: 1,\n                order: Galaxy.libraries.preferences.get( 'sort_order' ),\n                search_term: Galaxy.libraries.libraryToolbarView.options.search_term\n            }));\n            Galaxy.libraries.libraryToolbarView.renderPaginator( this.options );\n            this.renderRows( libraries_to_render );\n        } else {\n            this.$el.html( template({\n                length: 0,\n                order: Galaxy.libraries.preferences.get( 'sort_order' ),\n                search_term: Galaxy.libraries.libraryToolbarView.options.search_term\n            }));\n            Galaxy.libraries.libraryToolbarView.renderPaginator( this.options );\n        }\n        $( \"#center [data-toggle]\" ).tooltip();\n        $( \"#center\" ).css( 'overflow','auto' );\n    },\n\n    fetchDeleted: function(){\n      if (this.options.all_fetched){\n        this.render();\n      } else{\n        var that = this;\n        this.collection.url = this.collection.urlRoot + '?deleted=true';\n        this.collection.fetch({\n          remove: false,\n          success: function(){\n            that.options.all_fetched = true;\n            that.render();\n          },\n          error: function( model, response ){\n              if ( typeof response.responseJSON !== \"undefined\" ){\n                mod_toastr.error( response.responseJSON.err_msg );\n              } else {\n                mod_toastr.error( 'An error ocurred.' );\n              }\n          }\n        });\n      }\n    },\n\n    /**\n     * Render all given models as rows in the library list\n     * @param  {array} libraries_to_render array of library models to render\n     */\n    renderRows: function( libraries_to_render ){\n        for ( var i = 0; i < libraries_to_render.length; i++ ) {\n          var library = libraries_to_render[i];\n            this.renderOne( { library: library } );\n        }\n    },\n\n    /**\n     * Create a view for the given model and add it to the libraries view.\n     * @param {Library} model of the view that will be rendered\n     */\n    renderOne: function( options ){\n        var library = options.library;\n        var rowView = new mod_library_libraryrow_view.LibraryRowView( library );\n        this.$el.find( '#library_list_body' ).append( rowView.el );\n    },\n\n    /**\n     * Table heading was clicked, update sorting preferences and re-render.\n     * @return {[type]} [description]\n     */\n    sort_clicked : function(){\n        if (Galaxy.libraries.preferences.get('sort_order') === 'asc'){\n            Galaxy.libraries.preferences.set({'sort_order': 'desc'});\n        } else {\n            Galaxy.libraries.preferences.set({'sort_order': 'asc'});\n        }\n        this.render();\n    },\n\n    /**\n     * Sort the underlying collection according to the parameters received.\n     * Currently supports only sorting by name.\n     */\n    sortLibraries: function(){\n        if (Galaxy.libraries.preferences.get('sort_by') === 'name'){\n            if (Galaxy.libraries.preferences.get('sort_order') === 'asc'){\n                this.collection.sortByNameAsc();\n            } else if (Galaxy.libraries.preferences.get('sort_order') === 'desc'){\n                this.collection.sortByNameDesc();\n            }\n        }\n    },\n\n    redirectToHome: function(){\n        window.location = '../';\n    },\n    redirectToLogin: function(){\n        window.location = '/user/login';\n    },\n\n    /**\n     * In case the search_term is not empty perform the search and render\n     * the result. Render all visible libraries otherwise.\n     * @param  {string} search_term string to search for\n     */\n    searchLibraries: function(search_term){\n      var trimmed_term = $.trim(search_term);\n      if (trimmed_term !== ''){\n        var results = null\n        results = this.collection.search( search_term );\n        this.options.searching = true;\n        this.render({'models': results});\n      } else {\n        this.options.searching = false;\n        this.render();\n      }\n    },\n\n// MMMMMMMMMMMMMMMMMM\n// === TEMPLATES ====\n// MMMMMMMMMMMMMMMMMM\n\n    templateLibraryList: function(){\n      return _.template([\n      '<div class=\"library_container table-responsive\">',\n        '<% if(length === 0) { %>',\n          '<% if(search_term.length > 0) { %>',\n            '<div>',\n              'There are no libraries matching your search. Try different keyword.',\n            '</div>',\n          '<% } else{ %>',\n            '<div>',\n              'There are no libraries visible to you here. If you expected some to show up please consult the',\n              ' <a href=\"https://wiki.galaxyproject.org/Admin/DataLibraries/LibrarySecurity\" target=\"_blank\">library security wikipage</a>',\n              ' or visit the <a href=\"https://biostar.usegalaxy.org/\" target=\"_blank\">Galaxy support site</a>.',\n            '</div>',\n          '<% }%>',\n        '<% } else{ %>',\n          '<table class=\"grid table table-condensed\">',\n            '<thead>',\n              '<th style=\"width:30%;\">',\n                '<a class=\"sort-libraries-link\" title=\"Click to reverse order\" href=\"#\">',\n                  'name',\n                '</a>',\n                '<span title=\"Sorted alphabetically\" class=\"fa fa-sort-alpha-<%- order %>\"/>',\n              '</th>',\n              '<th style=\"width:22%;\">description</th>',\n              '<th style=\"width:22%;\">synopsis</th> ',\n              '<th style=\"width:26%;\"></th>',\n            '</thead>',\n            '<tbody id=\"library_list_body\">',\n            // library item views will attach here\n            '</tbody>',\n          '</table>',\n        '<% }%>',\n      '</div>'\n      ].join(''));\n    }\n\n});\n\nreturn {\n    LibraryListView: LibraryListView\n};\n\n});\n"]}