{"version":3,"sources":["mvc/library/library-librarylist-view.js"],"names":["define","el","events","mod_masthead","mod_baseMVC","defaults","page_count","show_page","all_fetched","_","LibraryListView","Backbone","View","extend","initialize","options","collection","mod_toastr","error","this","that","modal","mod_library_model","Libraries","url","urlRoot","fetch","success","render","model","response","template","templateLibraryList","sortLibraries","Galaxy","libraries","preferences","libraries_to_render","models","is_public","get","is_deleted","filter","total_libraries_count","$el","length","order","search_term","libraryToolbarView","slice","page_start","renderPaginator","$","renderRows","html","fetchDeleted","tooltip","remove","responseJSON","err_msg","renderOne","i","library","rowView","mod_library_libraryrow_view","sort_clicked","LibraryRowView","find","append","set","sort_order","redirectToHome","window","location","redirectToLogin","sortByNameAsc","sortByNameDesc","trimmed_term","searchLibraries","trim","results","search","searching","join"],"mappings":"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","file":"../../../scripts/mvc/library/library-librarylist-view.js","sourcesContent":["define([\n    \"layout/masthead\",\n    \"mvc/base-mvc\",\n    \"utils/utils\",\n    \"libs/toastr\",\n    \"mvc/library/library-model\",\n    \"mvc/library/library-libraryrow-view\",\n    \"libs/underscore\"\n], function(\n    mod_masthead,\n    mod_baseMVC,\n    mod_utils,\n    mod_toastr,\n    mod_library_model,\n    mod_library_libraryrow_view,\n    _\n){\n\nvar LibraryListView = Backbone.View.extend({\n    el: '#libraries_element',\n\n    events: {\n        'click .sort-libraries-link'    : 'sort_clicked'\n    },\n\n    defaults: {\n        page_count: null,\n        show_page: null,\n        all_fetched: false\n    },\n\n    /**\n     * Initialize and fetch the libraries from server.\n     * Async render afterwards.\n     * @param  {object} options an object with options\n     */\n    initialize : function( options ){\n        this.options = _.defaults( this.options || {}, options, this.defaults );\n        var that = this;\n        this.modal = null;\n        // collection of {Item}s\n        this.collection = new mod_library_model.Libraries();\n        this.collection.url = this.collection.urlRoot + '?deleted=false';\n        this.collection.fetch({\n          success: function(){\n            that.render();\n          },\n          error: function( model, response ){\n              if ( typeof response.responseJSON !== \"undefined\" ){\n                mod_toastr.error( response.responseJSON.err_msg );\n              } else {\n                mod_toastr.error( 'An error ocurred.' );\n              }\n          }\n        });\n    },\n\n    /**\n     * Render the libraries table either from the object's own collection,\n     * or from a given array of library models,\n     * or render an empty list in case no data is given.\n     */\n    render: function ( options ) {\n        this.options = _.extend( this.options, options );\n        this.setElement('#libraries_element');\n        var template = this.templateLibraryList();\n        var libraries_to_render = null;\n        var models = null;\n        var is_public = function(model){ return model.get('public') === true; }\n        $( \".tooltip\" ).hide();\n        if ( typeof options !== 'undefined' ){\n            models = typeof options.models !== 'undefined' ? options.models : null;\n        }\n        if ( this.collection !== null && models === null ){\n            this.sortLibraries();\n            if ( Galaxy.libraries.preferences.get( 'with_deleted' ) ){\n              libraries_to_render = this.collection.models;\n            } else {\n              libraries_to_render = this.collection.where( { deleted: false } );\n            }\n            if ( Galaxy.libraries.preferences.get( 'without_restricted' ) ){\n              libraries_to_render = _.filter( libraries_to_render, is_public );\n            }\n        } else if ( models !== null ){\n            if ( Galaxy.libraries.preferences.get( 'with_deleted' ) ){\n                libraries_to_render = models;\n            } else {\n                var is_deleted = function(model){ return model.get('deleted') === false; }\n                libraries_to_render = _.filter( models, is_deleted );\n            }\n            if ( Galaxy.libraries.preferences.get( 'without_restricted' ) ) {\n              libraries_to_render = _.filter( libraries_to_render, is_public );\n            }\n        } else {\n            libraries_to_render = [];\n        }\n\n        // pagination\n        if ( this.options.show_page === null || this.options.show_page < 1 ){\n            this.options.show_page = 1;\n        }\n        this.options.total_libraries_count = libraries_to_render.length\n        var page_start = ( Galaxy.libraries.preferences.get( 'library_page_size' ) * ( this.options.show_page - 1 ) );\n        this.options.page_count = Math.ceil( this.options.total_libraries_count / Galaxy.libraries.preferences.get( 'library_page_size' ) );\n        if ( this.options.total_libraries_count > 0 && ( page_start < this.options.total_libraries_count ) ){\n            libraries_to_render = libraries_to_render.slice( page_start, page_start + Galaxy.libraries.preferences.get( 'library_page_size' ) );\n            this.options.libraries_shown = libraries_to_render.length;\n            // User requests page with no libraries\n            if ( Galaxy.libraries.preferences.get( 'library_page_size' ) * this.options.show_page > ( this.options.total_libraries_count + Galaxy.libraries.preferences.get( 'library_page_size' ) ) ){\n                libraries_to_render = [];\n            }\n            this.$el.html( template({\n                length: 1,\n                order: Galaxy.libraries.preferences.get( 'sort_order' ),\n                search_term: Galaxy.libraries.libraryToolbarView.options.search_term\n            }));\n            Galaxy.libraries.libraryToolbarView.renderPaginator( this.options );\n            this.renderRows( libraries_to_render );\n        } else {\n            this.$el.html( template({\n                length: 0,\n                order: Galaxy.libraries.preferences.get( 'sort_order' ),\n                search_term: Galaxy.libraries.libraryToolbarView.options.search_term\n            }));\n            Galaxy.libraries.libraryToolbarView.renderPaginator( this.options );\n        }\n        $( \"#center [data-toggle]\" ).tooltip();\n        $( \"#center\" ).css( 'overflow','auto' );\n    },\n\n    fetchDeleted: function(){\n      if (this.options.all_fetched){\n        this.render();\n      } else{\n        var that = this;\n        this.collection.url = this.collection.urlRoot + '?deleted=true';\n        this.collection.fetch({\n          remove: false,\n          success: function(){\n            that.options.all_fetched = true;\n            that.render();\n          },\n          error: function( model, response ){\n              if ( typeof response.responseJSON !== \"undefined\" ){\n                mod_toastr.error( response.responseJSON.err_msg );\n              } else {\n                mod_toastr.error( 'An error ocurred.' );\n              }\n          }\n        });\n      }\n    },\n\n    /**\n     * Render all given models as rows in the library list\n     * @param  {array} libraries_to_render array of library models to render\n     */\n    renderRows: function( libraries_to_render ){\n        for ( var i = 0; i < libraries_to_render.length; i++ ) {\n          var library = libraries_to_render[i];\n            this.renderOne( { library: library } );\n        }\n    },\n\n    /**\n     * Create a view for the given model and add it to the libraries view.\n     * @param {Library} model of the view that will be rendered\n     */\n    renderOne: function( options ){\n        var library = options.library;\n        var rowView = new mod_library_libraryrow_view.LibraryRowView( library );\n        this.$el.find( '#library_list_body' ).append( rowView.el );\n    },\n\n    /**\n     * Table heading was clicked, update sorting preferences and re-render.\n     * @return {[type]} [description]\n     */\n    sort_clicked : function(){\n        if (Galaxy.libraries.preferences.get('sort_order') === 'asc'){\n            Galaxy.libraries.preferences.set({'sort_order': 'desc'});\n        } else {\n            Galaxy.libraries.preferences.set({'sort_order': 'asc'});\n        }\n        this.render();\n    },\n\n    /**\n     * Sort the underlying collection according to the parameters received.\n     * Currently supports only sorting by name.\n     */\n    sortLibraries: function(){\n        if (Galaxy.libraries.preferences.get('sort_by') === 'name'){\n            if (Galaxy.libraries.preferences.get('sort_order') === 'asc'){\n                this.collection.sortByNameAsc();\n            } else if (Galaxy.libraries.preferences.get('sort_order') === 'desc'){\n                this.collection.sortByNameDesc();\n            }\n        }\n    },\n\n    redirectToHome: function(){\n        window.location = '../';\n    },\n    redirectToLogin: function(){\n        window.location = '/user/login';\n    },\n\n    /**\n     * In case the search_term is not empty perform the search and render\n     * the result. Render all visible libraries otherwise.\n     * @param  {string} search_term string to search for\n     */\n    searchLibraries: function(search_term){\n      var trimmed_term = $.trim(search_term);\n      if (trimmed_term !== ''){\n        var results = null\n        results = this.collection.search( search_term );\n        this.options.searching = true;\n        this.render({'models': results});\n      } else {\n        this.options.searching = false;\n        this.render();\n      }\n    },\n\n// MMMMMMMMMMMMMMMMMM\n// === TEMPLATES ====\n// MMMMMMMMMMMMMMMMMM\n\n    templateLibraryList: function(){\n      return _.template([\n      '<div class=\"library_container table-responsive\">',\n        '<% if(length === 0) { %>',\n          '<% if(search_term.length > 0) { %>',\n            '<div>',\n              'There are no libraries matching your search. Try different keyword.',\n            '</div>',\n          '<% } else{ %>',\n            '<div>',\n              'There are no libraries visible to you here. If you expected some to show up please consult the',\n              ' <a href=\"https://galaxyproject.org/data-libraries/#permissions\" target=\"_blank\">library security wikipage</a>',\n              ' or visit the <a href=\"https://biostar.usegalaxy.org/\" target=\"_blank\">Galaxy support site</a>.',\n            '</div>',\n          '<% }%>',\n        '<% } else{ %>',\n          '<table class=\"grid table table-condensed\">',\n            '<thead>',\n              '<th style=\"width:30%;\">',\n                '<a class=\"sort-libraries-link\" title=\"Click to reverse order\" href=\"#\">',\n                  'name',\n                '</a>',\n                '<span title=\"Sorted alphabetically\" class=\"fa fa-sort-alpha-<%- order %>\"/>',\n              '</th>',\n              '<th style=\"width:22%;\">description</th>',\n              '<th style=\"width:22%;\">synopsis</th> ',\n              '<th style=\"width:26%;\"></th>',\n            '</thead>',\n            '<tbody id=\"library_list_body\">',\n            // library item views will attach here\n            '</tbody>',\n          '</table>',\n        '<% }%>',\n      '</div>'\n      ].join(''));\n    }\n\n});\n\nreturn {\n    LibraryListView: LibraryListView\n};\n\n});\n"]}