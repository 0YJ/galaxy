{"version":3,"sources":["mvc/library/library-librarylist-view.js"],"names":["define","mod_masthead","mod_baseMVC","mod_utils","mod_toastr","mod_library_model","mod_library_libraryrow_view","_","LibraryListView","Backbone","View","extend","el","events","click .sort-libraries-link","defaults","page_count","show_page","all_fetched","initialize","options","this","that","modal","collection","Libraries","url","urlRoot","fetch","success","render","error","model","response","responseJSON","err_msg","setElement","template","templateLibraryList","libraries_to_render","models","$","hide","sortLibraries","Galaxy","libraries","preferences","get","where","deleted","is_deleted","filter","total_libraries_count","length","page_start","Math","ceil","slice","libraries_shown","$el","html","order","search_term","libraryToolbarView","renderPaginator","renderRows","tooltip","css","fetchDeleted","remove","i","library","renderOne","rowView","LibraryRowView","find","append","sort_clicked","set","sort_order","sortByNameAsc","sortByNameDesc","redirectToHome","window","location","redirectToLogin","searchLibraries","trim","results","search","searching","join"],"mappings":"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","file":"../../../scripts/mvc/library/library-librarylist-view.js","sourcesContent":["define([\n    \"layout/masthead\",\n    \"mvc/base-mvc\",\n    \"utils/utils\",\n    \"libs/toastr\",\n    \"mvc/library/library-model\",\n    \"mvc/library/library-libraryrow-view\",\n    \"libs/underscore\"\n], function(\n    mod_masthead,\n    mod_baseMVC,\n    mod_utils,\n    mod_toastr,\n    mod_library_model,\n    mod_library_libraryrow_view,\n    _\n){\n\nvar LibraryListView = Backbone.View.extend({\n    el: '#libraries_element',\n\n    events: {\n        'click .sort-libraries-link'    : 'sort_clicked'\n    },\n\n    defaults: {\n        page_count: null,\n        show_page: null,\n        all_fetched: false\n    },\n\n    /**\n     * Initialize and fetch the libraries from server.\n     * Async render afterwards.\n     * @param  {object} options an object with options\n     */\n    initialize : function( options ){\n        this.options = _.defaults( this.options || {}, options, this.defaults );\n        var that = this;\n        this.modal = null;\n        // collection of {Item}s\n        this.collection = new mod_library_model.Libraries();\n        this.collection.url = this.collection.urlRoot + '?deleted=false';\n        this.collection.fetch({\n          success: function(){\n            that.render();\n          },\n          error: function( model, response ){\n              if ( typeof response.responseJSON !== \"undefined\" ){\n                mod_toastr.error( response.responseJSON.err_msg );\n              } else {\n                mod_toastr.error( 'An error ocurred.' );\n              }\n          }\n        });\n    },\n\n    /**\n     * Render the libraries table either from the object's own collection,\n     * or from a given array of library models,\n     * or render an empty list in case no data is given.\n     */\n    render: function ( options ) {\n        this.options = _.extend( this.options, options );\n        this.setElement('#libraries_element');\n        var template = this.templateLibraryList();\n        var libraries_to_render = null;\n        var models = null;\n        $( \".tooltip\" ).hide();\n        if ( typeof options !== 'undefined' ){\n            models = typeof options.models !== 'undefined' ? options.models : null;\n        }\n        if ( this.collection !== null && models === null ){\n            this.sortLibraries();\n            if ( Galaxy.libraries.preferences.get( 'with_deleted' ) ){\n              libraries_to_render = this.collection.models;\n            } else {\n              libraries_to_render = this.collection.where( { deleted: false } );\n            }\n        } else if ( models !== null ){\n            if ( Galaxy.libraries.preferences.get( 'with_deleted' ) ){\n                libraries_to_render = models;\n            } else {\n                var is_deleted = function(model){ return model.get('deleted') === false; }\n                libraries_to_render = _.filter(models, is_deleted );\n            }\n        } else {\n            libraries_to_render = [];\n        }\n\n        // pagination\n        if ( this.options.show_page === null || this.options.show_page < 1 ){\n            this.options.show_page = 1;\n        }\n        this.options.total_libraries_count = libraries_to_render.length\n        var page_start = ( Galaxy.libraries.preferences.get( 'library_page_size' ) * ( this.options.show_page - 1 ) );\n        this.options.page_count = Math.ceil( this.options.total_libraries_count / Galaxy.libraries.preferences.get( 'library_page_size' ) );\n        if ( this.options.total_libraries_count > 0 && ( page_start < this.options.total_libraries_count ) ){\n            libraries_to_render = libraries_to_render.slice( page_start, page_start + Galaxy.libraries.preferences.get( 'library_page_size' ) );\n            this.options.libraries_shown = libraries_to_render.length;\n            // User requests page with no libraries\n            if ( Galaxy.libraries.preferences.get( 'library_page_size' ) * this.options.show_page > ( this.options.total_libraries_count + Galaxy.libraries.preferences.get( 'library_page_size' ) ) ){\n                libraries_to_render = [];\n            }\n            this.$el.html( template({\n                length: 1,\n                order: Galaxy.libraries.preferences.get( 'sort_order' ),\n                search_term: Galaxy.libraries.libraryToolbarView.options.search_term\n            }));\n            Galaxy.libraries.libraryToolbarView.renderPaginator( this.options );\n            this.renderRows( libraries_to_render );\n        } else {\n            this.$el.html( template({\n                length: 0,\n                order: Galaxy.libraries.preferences.get( 'sort_order' ),\n                search_term: Galaxy.libraries.libraryToolbarView.options.search_term\n            }));\n            Galaxy.libraries.libraryToolbarView.renderPaginator( this.options );\n        }\n        $( \"#center [data-toggle]\" ).tooltip();\n        $( \"#center\" ).css( 'overflow','auto' );\n    },\n\n    fetchDeleted: function(){\n      if (this.options.all_fetched){\n        this.render();\n      } else{\n        var that = this;\n        this.collection.url = this.collection.urlRoot + '?deleted=true';\n        this.collection.fetch({\n          remove: false,\n          success: function(){\n            that.options.all_fetched = true;\n            that.render();\n          },\n          error: function( model, response ){\n              if ( typeof response.responseJSON !== \"undefined\" ){\n                mod_toastr.error( response.responseJSON.err_msg );\n              } else {\n                mod_toastr.error( 'An error ocurred.' );\n              }\n          }\n        });\n      }\n    },\n\n    /**\n     * Render all given models as rows in the library list\n     * @param  {array} libraries_to_render array of library models to render\n     */\n    renderRows: function( libraries_to_render ){\n        for ( var i = 0; i < libraries_to_render.length; i++ ) {\n          var library = libraries_to_render[i];\n            this.renderOne( { library: library } );\n        }\n    },\n\n    /**\n     * Create a view for the given model and add it to the libraries view.\n     * @param {Library} model of the view that will be rendered\n     */\n    renderOne: function( options ){\n        var library = options.library;\n        var rowView = new mod_library_libraryrow_view.LibraryRowView( library );\n        this.$el.find( '#library_list_body' ).append( rowView.el );\n    },\n\n    /**\n     * Table heading was clicked, update sorting preferences and re-render.\n     * @return {[type]} [description]\n     */\n    sort_clicked : function(){\n        if (Galaxy.libraries.preferences.get('sort_order') === 'asc'){\n            Galaxy.libraries.preferences.set({'sort_order': 'desc'});\n        } else {\n            Galaxy.libraries.preferences.set({'sort_order': 'asc'});\n        }\n        this.render();\n    },\n\n    /**\n     * Sort the underlying collection according to the parameters received.\n     * Currently supports only sorting by name.\n     */\n    sortLibraries: function(){\n        if (Galaxy.libraries.preferences.get('sort_by') === 'name'){\n            if (Galaxy.libraries.preferences.get('sort_order') === 'asc'){\n                this.collection.sortByNameAsc();\n            } else if (Galaxy.libraries.preferences.get('sort_order') === 'desc'){\n                this.collection.sortByNameDesc();\n            }\n        }\n    },\n\n    redirectToHome: function(){\n        window.location = '../';\n    },\n    redirectToLogin: function(){\n        window.location = '/user/login';\n    },\n\n    /**\n     * In case the search_term is not empty perform the search and render\n     * the result. Render all visible libraries otherwise.\n     * @param  {string} search_term string to search for\n     */\n    searchLibraries: function(search_term){\n      var trimmed_term = $.trim(search_term);\n      if (trimmed_term !== ''){\n        var results = null\n        results = this.collection.search( search_term );\n        this.options.searching = true;\n        this.render({'models': results});\n      } else {\n        this.options.searching = false;\n        this.render();\n      }\n    },\n\n// MMMMMMMMMMMMMMMMMM\n// === TEMPLATES ====\n// MMMMMMMMMMMMMMMMMM\n\n    templateLibraryList: function(){\n      return _.template([\n      '<div class=\"library_container table-responsive\">',\n        '<% if(length === 0) { %>',\n          '<% if(search_term.length > 0) { %>',\n            '<div>',\n              'There are no libraries matching your search. Try different keyword.',\n            '</div>',\n          '<% } else{ %>',\n            '<div>',\n              'There are no libraries visible to you here. If you expected some to show up please consult the',\n              ' <a href=\"https://wiki.galaxyproject.org/Admin/DataLibraries/LibrarySecurity\" target=\"_blank\">library security wikipage</a>',\n              ' or visit the <a href=\"https://biostar.usegalaxy.org/\" target=\"_blank\">Galaxy support site</a>.',\n            '</div>',\n          '<% }%>',\n        '<% } else{ %>',\n          '<table class=\"grid table table-condensed\">',\n            '<thead>',\n              '<th style=\"width:30%;\">',\n                '<a class=\"sort-libraries-link\" title=\"Click to reverse order\" href=\"#\">',\n                  'name',\n                '</a>',\n                '<span title=\"Sorted alphabetically\" class=\"fa fa-sort-alpha-<%- order %>\"/>',\n              '</th>',\n              '<th style=\"width:22%;\">description</th>',\n              '<th style=\"width:22%;\">synopsis</th> ',\n              '<th style=\"width:26%;\"></th>',\n            '</thead>',\n            '<tbody id=\"library_list_body\">',\n            // library item views will attach here\n            '</tbody>',\n          '</table>',\n        '<% }%>',\n      '</div>'\n      ].join(''));\n    }\n\n});\n\nreturn {\n    LibraryListView: LibraryListView\n};\n\n});\n"]}