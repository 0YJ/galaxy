{"version":3,"sources":["mvc/toolshed/repository-queue-view.js"],"names":["define","toolshed_model","toolshed_util","RepoQueueView","Backbone","View","extend","el","defaults","options","that","this","initialize","model","render","fetch","listenTo","repo_queue_template","templateRepoQueue","models","repositories","queue","queueLength","$","$el","bindEvents","on","loadFromQueue","attr","installFromQueue","repository_metadata","queue_key","repo_queue","JSON","parse","localStorage","id","hasOwnProperty","remove","repository_id","history","navigate","trigger","replace","params","Object","install_tool_dependencies","install_resolver_dependencies","tool_panel_section","install_repository_dependencies","changeset_revision","shed_tool_conf","tool_shed_repository_ids","stringify","tool_shed_url","changeset","url","root","queueKey","undefined","repository_queue","iri_params","data","new_route","join","post","Galaxy","reDraw","template"],"mappings":"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","file":"../../../scripts/mvc/toolshed/repository-queue-view.js","sourcesContent":["define(['mvc/toolshed/toolshed-model', 'mvc/toolshed/util'], function(toolshed_model, toolshed_util) {\n\n    var View = Backbone.View.extend({\n\n        el: '#center',\n\n        defaults: [{}],\n\n        initialize: function(options) {\n            var that = this;\n            this.model = new toolshed_model.RepoQueue();\n            this.listenTo(this.model, 'sync', this.render);\n            this.model.fetch();\n            that.render();\n        },\n\n        render: function(options) {\n            var that = this;\n            var repo_queue_template = that.templateRepoQueue;\n            var repositories = that.model.models;\n            that.$el.html(repo_queue_template({title: 'Repository Installation Queue', repositories: repositories, queue: toolshed_util.queueLength()}));\n            $(\"#center\").css('overflow', 'auto');\n            that.bindEvents();\n        },\n\n        bindEvents: function() {\n            var that = this;\n            $('.install_one').on('click', function() {\n                var repository_metadata = that.loadFromQueue($(this).attr('data-repokey'));\n                that.installFromQueue(repository_metadata, $(this).attr('data-repokey'));\n            });\n            $('.remove_one').on('click', function() {\n                var queue_key = $(this).attr('data-repokey');\n                var repo_queue = JSON.parse(localStorage.repositories);\n                if (repo_queue.hasOwnProperty(queue_key)) {\n                    var repository_id = repo_queue[queue_key].repository.id;\n                    delete repo_queue[queue_key];\n                    $('#queued_repository_' + repository_id).remove();\n                }\n                localStorage.repositories = JSON.stringify(repo_queue);\n            });\n            $('#clear_queue').on('click', function() {\n                localStorage.repositories = \"{}\";\n            });\n            $('#from_workflow').on('click', function() { Backbone.history.navigate('workflows', {trigger: true, replace:true}); });\n        },\n\n        installFromQueue: function(repository_metadata, queue_key) {\n            var that = this;\n            var params = Object();\n            params.install_tool_dependencies = repository_metadata.install_tool_dependencies;\n            params.install_repository_dependencies = repository_metadata.install_repository_dependencies;\n            params.install_resolver_dependencies = repository_metadata.install_resolver_dependencies;\n            params.tool_panel_section = repository_metadata.tool_panel_section;\n            params.shed_tool_conf = repository_metadata.shed_tool_conf;\n            params.repositories = JSON.stringify([[repository_metadata.repository.id, repository_metadata.changeset_revision]]);\n            params.tool_shed_repository_ids = JSON.stringify([repository_metadata.repository.id]);\n            params.tool_shed_url = queue_key.split('|')[0];\n            params.changeset = repository_metadata.changeset_revision;\n            var url = Galaxy.root + 'api/tool_shed_repositories/install?async=True';\n            $('#queued_repository_' + repository_metadata.repository.id).remove();\n            if (localStorage.repositories) {\n                if (queue_key === undefined) {\n                    queue_key = toolshed_util.queueKey(repository_metadata);\n                }\n                repository_queue = JSON.parse(localStorage.repositories);\n                if (repository_queue.hasOwnProperty(queue_key)) {\n                    delete repository_queue[queue_key];\n                    localStorage.repositories = JSON.stringify(repository_queue);\n                }\n            }\n\n            $.post(url, params, function(data) {\n                var iri_params = JSON.parse(data);\n                var repositories = iri_params.repositories;\n                var new_route = 'status/r/' + repositories.join('|');\n                $.post(Galaxy.root + 'admin_toolshed/manage_repositories', iri_params, function(data) {\n                    console.log( \"Initializing repository installation succeeded\" );\n                });\n                Backbone.history.navigate(new_route, {trigger: true, replace:true});\n            });\n        },\n\n        loadFromQueue: function(queue_key) {\n            repository_queue = JSON.parse(localStorage.repositories);\n            if (repository_queue.hasOwnProperty(queue_key)) {\n                return repository_queue[queue_key];\n            }\n            return undefined;\n        },\n\n        reDraw: function(options) {\n            this.$el.empty();\n            this.initialize(options);\n            this.model.fetch();\n            this.render(options);\n        },\n\n        templateRepoQueue: _.template([\n            '<div class=\"unified-panel-header\" id=\"panel_header\" unselectable=\"on\">',\n                '<div class=\"unified-panel-header-inner\"><%= title %></div>',\n                '<div class=\"unified-panel-header-inner\" style=\"position: absolute; right: 5px; top: 0px;\"><a href=\"#/queue\">Repository Queue (<%= queue %>)</a></div>',\n            '</div>',\n            '<div class=\"tab-pane\" id=\"panel_header\" id=\"repository_queue\">',\n                '<table id=\"queued_repositories\" class=\"grid\" border=\"0\" cellpadding=\"2\" cellspacing=\"2\" width=\"100%\">',\n                    '<thead id=\"grid-table-header\">',\n                        '<tr>',\n                            '<th class=\"datasetRow\">Name</th>',\n                            '<th class=\"datasetRow\">Owner</th>',\n                            '<th class=\"datasetRow\">Revision</th>',\n                            '<th class=\"datasetRow\">ToolShed</th>',\n                            '<th class=\"datasetRow\">Install</th>',\n                            '<th class=\"datasetRow\"><input class=\"btn btn-primary\" type=\"submit\" id=\"clear_queue\" name=\"clear_queue\" value=\"Clear queue\" /></th>',\n                        '</tr>',\n                    '</thead>',\n                    '<tbody>',\n                        '<% _.each(repositories, function(repository) { %>',\n                                '<tr id=\"queued_repository_<%= repository.get(\"id\") %>\">',\n                                    '<td class=\"datasetRow\"><%= repository.get(\"repository\").name %></td>',\n                                    '<td class=\"datasetRow\"><%= repository.get(\"repository\").owner %></td>',\n                                    '<td class=\"datasetRow\"><%= repository.get(\"changeset_revision\") %></td>',\n                                    '<td class=\"datasetRow\"><%= repository.get(\"tool_shed_url\") %></td>',\n                                    '<td class=\"datasetRow\">',\n                                        '<input class=\"btn btn-primary install_one\" data-repokey=\"<%= repository.get(\"queue_key\") %>\" type=\"submit\" id=\"install_repository_<%= repository.get(\"id\") %>\" name=\"install_repository\" value=\"Install now\" />',\n                                    '</td>',\n                                    '<td class=\"datasetRow\">',\n                                        '<input class=\"btn btn-primary remove_one\" data-repokey=\"<%= repository.get(\"queue_key\") %>\" type=\"submit\" id=\"unqueue_repository_<%= repository.get(\"id\") %>\" name=\"unqueue_repository\" value=\"Remove from queue\" />',\n                                    '</td>',\n                                '</tr>',\n                        '<% }); %>',\n                    '</tbody>',\n                '</table>',\n                '<input type=\"button\" class=\"btn btn-primary\" id=\"from_workflow\" value=\"Add from workflow\" />',\n            '</div>',\n            ].join(''))\n    });\n\n    return {\n        RepoQueueView: View,\n    };\n\n});"]}