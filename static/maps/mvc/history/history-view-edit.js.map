{"version":3,"sources":["mvc/history/history-view-edit.js"],"names":["define","HISTORY_VIEW","HISTORY_CONTENTS","STATES","HDA_MODEL","HDA_LI_EDIT","HDCA_LI_EDIT","TAGS","HDAViewClass","LIST_COLLECTION_CREATOR","HDCAViewClass","LIST_OF_PAIRS_COLLECTION_CREATOR","faIconButton","PopupMenu","BASE_MVC","_l","_super","HistoryView","HistoryViewEdit","extend","HDAListItemEdit","_setUpListeners","HDCAListItemEdit","initialize","dropTargetOff","attributes","prototype","call","this","tagsEditor","dragItems","_setUpModelListeners","purgeAllowed","_setUpCollectionListeners","annotationEditorShown","on","droptarget:drop","ev","data","dataDropped","view:attached view:removed","_renderCounts","search:loading-progress","_renderSearchProgress","search:searching","_renderSearchFindings","_buildNewRender","listenTo","$newRender","Galaxy","_renderTags","_renderAnnotation","change:deleted","_handleItemDeletedChange","change:visible","_handleItemVisibleChange","change:purged","model","fetch","fetching-deleted","collection","$","html","fetching-hidden","renderItems","searchFor","$whereTo","fetching-deleted-done fetching-hidden-done","user","id","get","panel","updateHistoryDiskSize","text","onhide","toggleHDATagEditors","fxSpeed","title","$activator","jQuery","$el","templates","counts","toJSON","$where","el","find","onshowFirstTime","render","TagsEditor","onshow","classes","faIcon","appendTo","_setUpBehaviors","AnnotationEditor","toggleHDAAnnotationEditors","nameSelector","on_finish","previousName","isAnonymous","actions","action","attr","tooltip","make_text_editable","getSelectedModels","newName","func","HistoryDatasetAssociation","name","ajaxQueue","fail","previous","multiselectActions","concat","_collectionActions","hide","unhide","buildCollection","undelete","selection","hideSourceItems","createFunc","purge","collectionType","_getItemViewOptions","options","createListCollection","itemModel","_handleItemDeletion","_handleItemUndeletion","createListOfPairsCollection","console","done","refresh","removeItemView","_","tagsEditorShown","hidden","annotationEditor","_handleItemUnhidden","contentsShown","active","contents","includeDeleted","_handleItemHidden","deleted","each","view","views","includeHidden","set","events","toggleShowDeleted","showOrHide","speed","toggle","found","dropTargetOn","clone","click .show-selectors-btn","click .toggle-deleted-link","click .toggle-hidden-link","toggleShowHidden","dropHandlers","limit","offset","stop","drop","join","hasOwnProperty","$dropTarget","_renderDropTarget","dropTarget","_renderDropTargetHelp","dragenter","dragover","bind","remove","dragleave","addClass","$list","before","evName","preventDefault","stopPropagation","_dropHandlers","off","dropTargetToggle","dataTransfer","css","self","isObject","originalEvent","JSON","parse","err","warn","trigger","countsTemplate","foundTemplate","wrapTemplate","currentPage","copy","when","toString"],"mappings":"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","file":"../../../scripts/mvc/history/history-view-edit.js","sourcesContent":["define([\n    \"mvc/history/history-view\",\n    \"mvc/history/history-contents\",\n    \"mvc/dataset/states\",\n    \"mvc/history/hda-model\",\n    \"mvc/history/hda-li-edit\",\n    \"mvc/history/hdca-li-edit\",\n    \"mvc/tag\",\n    \"mvc/annotation\",\n    \"mvc/collection/list-collection-creator\",\n    \"mvc/collection/pair-collection-creator\",\n    \"mvc/collection/list-of-pairs-collection-creator\",\n    \"ui/fa-icon-button\",\n    \"mvc/ui/popup-menu\",\n    \"mvc/base-mvc\",\n    \"utils/localization\",\n    \"ui/editable-text\",\n], function(\n    HISTORY_VIEW,\n    HISTORY_CONTENTS,\n    STATES,\n    HDA_MODEL,\n    HDA_LI_EDIT,\n    HDCA_LI_EDIT,\n    TAGS,\n    ANNOTATIONS,\n    LIST_COLLECTION_CREATOR,\n    PAIR_COLLECTION_CREATOR,\n    LIST_OF_PAIRS_COLLECTION_CREATOR,\n    faIconButton,\n    PopupMenu,\n    BASE_MVC,\n    _l\n){\n\n'use strict';\n\n/* =============================================================================\nTODO:\n\n============================================================================= */\nvar _super = HISTORY_VIEW.HistoryView;\n// base class for history-view-edit-current and used as-is in history/view.mako\n/** @class Editable View/Controller for the history model.\n *\n *  Allows:\n *      (everything HistoryView allows)\n *      changing the name\n *      displaying and editing tags and annotations\n *      multi-selection and operations on mulitple content items\n */\nvar HistoryViewEdit = _super.extend(\n/** @lends HistoryViewEdit.prototype */{\n\n    /** class to use for constructing the HistoryDatasetAssociation views */\n    HDAViewClass    : HDA_LI_EDIT.HDAListItemEdit,\n    /** class to use for constructing the HistoryDatasetCollectionAssociation views */\n    HDCAViewClass   : HDCA_LI_EDIT.HDCAListItemEdit,\n\n    // ......................................................................... SET UP\n    /** Set up the view, set up storage, bind listeners to HistoryContents events\n     *  @param {Object} attributes\n     */\n    initialize : function( attributes ){\n        attributes = attributes || {};\n        _super.prototype.initialize.call( this, attributes );\n\n        // ---- set up instance vars\n        /** editor for tags - sub-view */\n        this.tagsEditor = null;\n\n        /** enable drag and drop - sub-view */\n        this.dragItems  = true;\n\n        /** editor for annotations - sub-view */\n        this.annotationEditor = null;\n\n        /** allow user purge of dataset files? */\n        this.purgeAllowed = attributes.purgeAllowed || false;\n\n        // states/modes the panel can be in\n        /** is the panel currently showing the dataset selection controls? */\n        this.annotationEditorShown  = attributes.annotationEditorShown || false;\n        this.tagsEditorShown  = attributes.tagsEditorShown || false;\n    },\n\n    /** Override to handle history as drag-drop target */\n    _setUpListeners : function(){\n        _super.prototype._setUpListeners.call( this );\n        return this.on({\n            'droptarget:drop': function( ev, data ){\n                // process whatever was dropped and re-hide the drop target\n                this.dataDropped( data );\n                this.dropTargetOff();\n            },\n            'view:attached view:removed': function(){\n                this._renderCounts();\n            },\n            'search:loading-progress': this._renderSearchProgress,\n            'search:searching': this._renderSearchFindings,\n        });\n    },\n\n    // ------------------------------------------------------------------------ listeners\n    /** listening for history and HDA events */\n    _setUpModelListeners : function(){\n        _super.prototype._setUpModelListeners.call( this );\n        this.listenTo( this.model, 'change:size', this.updateHistoryDiskSize );\n        return this;\n    },\n\n    /** listening for collection events */\n    _setUpCollectionListeners : function(){\n        _super.prototype._setUpCollectionListeners.call( this );\n        this.listenTo( this.collection, {\n            'change:deleted': this._handleItemDeletedChange,\n            'change:visible': this._handleItemVisibleChange,\n            'change:purged' : function( model ){\n                // hafta get the new nice-size w/o the purged model\n                this.model.fetch();\n            },\n            // loading indicators for deleted/hidden\n            'fetching-deleted'      : function( collection ){\n                this.$( '> .controls .deleted-count' )\n                    .html( '<i>' + _l( 'loading...' ) + '</i>' );\n            },\n            'fetching-hidden'       : function( collection ){\n                this.$( '> .controls .hidden-count' )\n                    .html( '<i>' + _l( 'loading...' ) + '</i>' );\n            },\n            'fetching-deleted-done fetching-hidden-done'  : this._renderCounts,\n        });\n        return this;\n    },\n\n    // ------------------------------------------------------------------------ panel rendering\n    /** In this override, add tag and annotation editors and a btn to toggle the selectors */\n    _buildNewRender : function(){\n        // create a new render using a skeleton template, render title buttons, render body, and set up events, etc.\n        var $newRender = _super.prototype._buildNewRender.call( this );\n        if( !this.model ){ return $newRender; }\n\n        if( Galaxy && Galaxy.user && Galaxy.user.id && Galaxy.user.id === this.model.get( 'user_id' ) ){\n            this._renderTags( $newRender );\n            this._renderAnnotation( $newRender );\n        }\n        return $newRender;\n    },\n\n    /** Update the history size display (curr. upper right of panel). */\n    updateHistoryDiskSize : function(){\n        this.$( '.history-size' ).text( this.model.get( 'nice_size' ) );\n    },\n\n    /** override to render counts when the items are rendered */\n    renderItems : function( $whereTo ){\n        var views = _super.prototype.renderItems.call( this, $whereTo );\n        if( !this.searchFor ){ this._renderCounts( $whereTo ); }\n        else{ this._renderSearchFindings( $whereTo ); }\n        return views;\n    },\n\n    /** override to show counts, what's deleted/hidden, and links to toggle those */\n    _renderCounts : function( $whereTo ){\n        $whereTo = $whereTo instanceof jQuery? $whereTo : this.$el;\n        var html = this.templates.counts( this.model.toJSON(), this );\n        return $whereTo.find( '> .controls .subtitle' ).html( html );\n    },\n\n    /** render the tags sub-view controller */\n    _renderTags : function( $where ){\n        var panel = this;\n        this.tagsEditor = new TAGS.TagsEditor({\n            model           : this.model,\n            el              : $where.find( '.controls .tags-display' ),\n            onshowFirstTime : function(){ this.render(); },\n            // show hide sub-view tag editors when this is shown/hidden\n            onshow          : function(){\n                panel.toggleHDATagEditors( true,  panel.fxSpeed );\n            },\n            onhide          : function(){\n                panel.toggleHDATagEditors( false, panel.fxSpeed );\n            },\n            $activator      : faIconButton({\n                title   : _l( 'Edit history tags' ),\n                classes : 'history-tag-btn',\n                faIcon  : 'fa-tags'\n            }).appendTo( $where.find( '.controls .actions' ) )\n        });\n    },\n    /** render the annotation sub-view controller */\n    _renderAnnotation : function( $where ){\n        var panel = this;\n        this.annotationEditor = new ANNOTATIONS.AnnotationEditor({\n            model           : this.model,\n            el              : $where.find( '.controls .annotation-display' ),\n            onshowFirstTime : function(){ this.render(); },\n            // show hide sub-view view annotation editors when this is shown/hidden\n            onshow          : function(){\n                panel.toggleHDAAnnotationEditors( true,  panel.fxSpeed );\n            },\n            onhide          : function(){\n                panel.toggleHDAAnnotationEditors( false, panel.fxSpeed );\n            },\n            $activator      : faIconButton({\n                title   : _l( 'Edit history annotation' ),\n                classes : 'history-annotate-btn',\n                faIcon  : 'fa-comment'\n            }).appendTo( $where.find( '.controls .actions' ) )\n        });\n    },\n\n    /** Set up HistoryViewEdit js/widget behaviours\n     *  In this override, make the name editable\n     */\n    _setUpBehaviors : function( $where ){\n        $where = $where || this.$el;\n        _super.prototype._setUpBehaviors.call( this, $where );\n        if( !this.model ){ return; }\n\n        // anon users shouldn't have access to any of the following\n        if( ( !Galaxy.user || Galaxy.user.isAnonymous() )\n        ||  ( Galaxy.user.id !== this.model.get( 'user_id' ) ) ){\n            return;\n        }\n\n        var panel = this,\n            nameSelector = '> .controls .name';\n        $where.find( nameSelector )\n            .attr( 'title', _l( 'Click to rename history' ) )\n            .tooltip({ placement: 'bottom' })\n            .make_text_editable({\n                on_finish: function( newName ){\n                    var previousName = panel.model.get( 'name' );\n                    if( newName && newName !== previousName ){\n                        panel.$el.find( nameSelector ).text( newName );\n                        panel.model.save({ name: newName })\n                            .fail( function(){\n                                panel.$el.find( nameSelector ).text( panel.model.previous( 'name' ) );\n                            });\n                    } else {\n                        panel.$el.find( nameSelector ).text( previousName );\n                    }\n                }\n            });\n    },\n\n    /** return a new popup menu for choosing a multi selection action\n     *  ajax calls made for multiple datasets are queued\n     */\n    multiselectActions : function(){\n        var panel = this,\n            actions = [\n                {   html: _l( 'Hide datasets' ), func: function(){\n                        var action = HDA_MODEL.HistoryDatasetAssociation.prototype.hide;\n                        panel.getSelectedModels().ajaxQueue( action );\n                    }\n                },\n                {   html: _l( 'Unhide datasets' ), func: function(){\n                        var action = HDA_MODEL.HistoryDatasetAssociation.prototype.unhide;\n                        panel.getSelectedModels().ajaxQueue( action );\n                    }\n                },\n                {   html: _l( 'Delete datasets' ), func: function(){\n                        var action = HDA_MODEL.HistoryDatasetAssociation.prototype['delete'];\n                        panel.getSelectedModels().ajaxQueue( action );\n                    }\n                },\n                {   html: _l( 'Undelete datasets' ), func: function(){\n                        var action = HDA_MODEL.HistoryDatasetAssociation.prototype.undelete;\n                        panel.getSelectedModels().ajaxQueue( action );\n                    }\n                }\n            ];\n        if( panel.purgeAllowed ){\n            actions.push({\n                html: _l( 'Permanently delete datasets' ), func: function(){\n                    if( confirm( _l( 'This will permanently remove the data in your datasets. Are you sure?' ) ) ){\n                        var action = HDA_MODEL.HistoryDatasetAssociation.prototype.purge;\n                        panel.getSelectedModels().ajaxQueue( action );\n                    }\n                }\n            });\n        }\n        actions = actions.concat( panel._collectionActions() );\n        return actions;\n    },\n\n    /**   */\n    _collectionActions : function(){\n        var panel = this;\n        return [\n            {   html: _l( 'Build Dataset List' ), func: function() { panel.buildCollection( \"list\") }\n            },\n            // TODO: Only show quick pair if two things selected.\n            {   html: _l( 'Build Dataset Pair' ), func: function() { panel.buildCollection( \"paired\") }\n            },\n            {   html: _l( 'Build List of Dataset Pairs' ), func: function() { panel.buildCollection( \"list:paired\" ) }\n            },\n        ];\n    },\n\n    buildCollection : function( collectionType, selection, hideSourceItems ) {\n        var panel = this;\n        var selection = selection || panel.getSelectedModels();\n        var hideSourceItems = hideSourceItems || false;\n        var createFunc;\n        if( collectionType == \"list\" ) {\n            createFunc = LIST_COLLECTION_CREATOR.createListCollection;\n        } else if( collectionType == \"paired\" ) {\n            createFunc = PAIR_COLLECTION_CREATOR.createPairCollection;\n        } else if( collectionType == \"list:paired\" ) {\n            createFunc = LIST_OF_PAIRS_COLLECTION_CREATOR.createListOfPairsCollection;\n        } else {\n            console.warn( \"Unknown collectionType encountered \" + collectionType );\n        }\n        createFunc( selection, hideSourceItems ).done( function() { panel.model.refresh() } );\n    },\n\n    // ------------------------------------------------------------------------ sub-views\n    /** In this override, add purgeAllowed and whether tags/annotation editors should be shown */\n    _getItemViewOptions : function( model ){\n        var options = _super.prototype._getItemViewOptions.call( this, model );\n        _.extend( options, {\n            purgeAllowed            : this.purgeAllowed,\n            tagsEditorShown         : ( this.tagsEditor && !this.tagsEditor.hidden ),\n            annotationEditorShown   : ( this.annotationEditor && !this.annotationEditor.hidden )\n        });\n        return options;\n    },\n\n    /** If this item is deleted and we're not showing deleted items, remove the view\n     *  @param {Model} the item model to check\n     */\n    _handleItemDeletedChange : function( itemModel ){\n        if( itemModel.get( 'deleted' ) ){\n            this._handleItemDeletion( itemModel );\n        } else {\n            this._handleItemUndeletion( itemModel );\n        }\n        this._renderCounts();\n    },\n\n    _handleItemDeletion : function( itemModel ){\n        var contentsShown = this.model.get( 'contents_active' );\n        contentsShown.deleted += 1;\n        contentsShown.active -= 1;\n        if( !this.model.contents.includeDeleted ){\n            this.removeItemView( itemModel );\n        }\n        this.model.set( 'contents_active', contentsShown );\n    },\n\n    _handleItemUndeletion : function( itemModel ){\n        var contentsShown = this.model.get( 'contents_active' );\n        contentsShown.deleted -= 1;\n        if( !this.model.contents.includeDeleted ){\n            contentsShown.active -= 1;\n        }\n        this.model.set( 'contents_active', contentsShown );\n    },\n\n    /** If this item is hidden and we're not showing hidden items, remove the view\n     *  @param {Model} the item model to check\n     */\n    _handleItemVisibleChange : function( itemModel ){\n        if( itemModel.hidden() ){\n            this._handleItemHidden( itemModel );\n        } else {\n            this._handleItemUnhidden( itemModel );\n        }\n        this._renderCounts();\n    },\n\n    _handleItemHidden : function( itemModel ){\n        var contentsShown = this.model.get( 'contents_active' );\n        contentsShown.hidden += 1;\n        contentsShown.active -= 1;\n        if( !this.model.contents.includeHidden ){\n            this.removeItemView( itemModel );\n        }\n        this.model.set( 'contents_active', contentsShown );\n    },\n\n    _handleItemUnhidden : function( itemModel ){\n        var contentsShown = this.model.get( 'contents_active' );\n        contentsShown.hidden -= 1;\n        if( !this.model.contents.includeHidden ){\n            contentsShown.active -= 1;\n        }\n        this.model.set( 'contents_active', contentsShown );\n    },\n\n    /** toggle the visibility of each content's tagsEditor applying all the args sent to this function */\n    toggleHDATagEditors : function( showOrHide, speed ){\n        _.each( this.views, function( view ){\n            if( view.tagsEditor ){\n                view.tagsEditor.toggle( showOrHide, speed );\n            }\n        });\n    },\n\n    /** toggle the visibility of each content's annotationEditor applying all the args sent to this function */\n    toggleHDAAnnotationEditors : function( showOrHide, speed ){\n        _.each( this.views, function( view ){\n            if( view.annotationEditor ){\n                view.annotationEditor.toggle( showOrHide, speed );\n            }\n        });\n    },\n\n    // ------------------------------------------------------------------------ panel events\n    /** event map */\n    events : _.extend( _.clone( _super.prototype.events ), {\n        'click .show-selectors-btn'                 : 'toggleSelectors',\n        'click .toggle-deleted-link'                : function( ev ){ this.toggleShowDeleted(); },\n        'click .toggle-hidden-link'                 : function( ev ){ this.toggleShowHidden(); }\n    }),\n\n    // ------------------------------------------------------------------------ search\n    _renderSearchProgress : function( limit, offset ){\n        var stop = limit + offset;\n        return this.$( '> .controls .subtitle' ).html([\n            '<i>',\n                _l( 'Searching ' ), stop, '/', this.model.contentsShown(),\n            '</i>'\n        ].join(''));\n    },\n\n    /** override to display number found in subtitle */\n    _renderSearchFindings : function( $whereTo ){\n        $whereTo = $whereTo instanceof jQuery? $whereTo : this.$el;\n        var html = this.templates.found( this.model.toJSON(), this );\n        $whereTo.find( '> .controls .subtitle' ).html( html );\n        return this;\n    },\n\n    // ------------------------------------------------------------------------ as drop target\n    /** turn all the drag and drop handlers on and add some help text above the drop area */\n    dropTargetOn : function(){\n        if( this.dropTarget ){ return this; }\n        this.dropTarget = true;\n\n        //TODO: to init\n        var dropHandlers = {\n            'dragenter' : _.bind( this.dragenter, this ),\n            'dragover'  : _.bind( this.dragover,  this ),\n            'dragleave' : _.bind( this.dragleave, this ),\n            'drop'      : _.bind( this.drop, this )\n        };\n\n        var $dropTarget = this._renderDropTarget();\n        this.$list().before([ this._renderDropTargetHelp(), $dropTarget ]);\n        for( var evName in dropHandlers ){\n            if( dropHandlers.hasOwnProperty( evName ) ){\n                //console.debug( evName, dropHandlers[ evName ] );\n                $dropTarget.on( evName, dropHandlers[ evName ] );\n            }\n        }\n        return this;\n    },\n\n    /** render a box to serve as a 'drop here' area on the history */\n    _renderDropTarget : function(){\n        this.$( '.history-drop-target' ).remove();\n        return $( '<div/>' ).addClass( 'history-drop-target' );\n    },\n\n    /** tell the user how it works  */\n    _renderDropTargetHelp : function(){\n        this.$( '.history-drop-target-help' ).remove();\n        return $( '<div/>' ).addClass( 'history-drop-target-help' )\n            .text( _l( 'Drag datasets here to copy them to the current history' ) );\n    },\n\n    /** shut down drag and drop event handlers and remove drop target */\n    dropTargetOff : function(){\n        if( !this.dropTarget ){ return this; }\n        //this.log( 'dropTargetOff' );\n        this.dropTarget = false;\n        var dropTarget = this.$( '.history-drop-target' ).get(0);\n        for( var evName in this._dropHandlers ){\n            if( this._dropHandlers.hasOwnProperty( evName ) ){\n                dropTarget.off( evName, this._dropHandlers[ evName ] );\n            }\n        }\n        this.$( '.history-drop-target' ).remove();\n        this.$( '.history-drop-target-help' ).remove();\n        return this;\n    },\n    /** toggle the target on/off */\n    dropTargetToggle : function(){\n        if( this.dropTarget ){\n            this.dropTargetOff();\n        } else {\n            this.dropTargetOn();\n        }\n        return this;\n    },\n\n    dragenter : function( ev ){\n        //console.debug( 'dragenter:', this, ev );\n        ev.preventDefault();\n        ev.stopPropagation();\n        this.$( '.history-drop-target' ).css( 'border', '2px solid black' );\n    },\n    dragover : function( ev ){\n        ev.preventDefault();\n        ev.stopPropagation();\n    },\n    dragleave : function( ev ){\n        //console.debug( 'dragleave:', this, ev );\n        ev.preventDefault();\n        ev.stopPropagation();\n        this.$( '.history-drop-target' ).css( 'border', '1px dashed black' );\n    },\n    /** when (text) is dropped try to parse as json and trigger an event */\n    drop : function( ev ){\n        ev.preventDefault();\n        //ev.stopPropagation();\n\n        var self = this;\n        var dataTransfer = ev.originalEvent.dataTransfer;\n        var data = dataTransfer.getData( \"text\" );\n\n        dataTransfer.dropEffect = 'move';\n        try {\n            data = JSON.parse( data );\n        } catch( err ){\n            self.warn( 'error parsing JSON from drop:', data );\n        }\n\n        self.trigger( 'droptarget:drop', ev, data, self );\n        return false;\n    },\n\n    /** handler that copies data into the contents */\n    dataDropped : function( data ){\n        var self = this;\n        // HDA: dropping will copy it to the history\n        if( _.isObject( data ) && data.model_class === 'HistoryDatasetAssociation' && data.id ){\n            if( self.contents.currentPage !== 0 ){\n                return self.contents.fetchPage( 0 )\n                    .then( function(){\n                        return self.model.contents.copy( data.id );\n                    });\n            }\n            return self.model.contents.copy( data.id );\n        }\n        return jQuery.when();\n    },\n\n    // ........................................................................ misc\n    /** Return a string rep of the history */\n    toString    : function(){\n        return 'HistoryViewEdit(' + (( this.model )?( this.model.get( 'name' )):( '' )) + ')';\n    }\n});\n\n//------------------------------------------------------------------------------ TEMPLATES\nHistoryViewEdit.prototype.templates = (function(){\n\n    var countsTemplate = BASE_MVC.wrapTemplate([\n        '<% var shown = Math.max( view.views.length, history.contents_active.active ) %>',\n        '<% if( shown ){ %>',\n            '<span class=\"shown-count\">',\n                '<%- shown %> ', _l( 'shown' ),\n            '</span>',\n        '<% } %>',\n\n        '<% if( history.contents_active.deleted ){ %>',\n            '<span class=\"deleted-count\">',\n            '<% if( view.model.contents.includeDeleted ){ %>',\n                '<a class=\"toggle-deleted-link\" href=\"javascript:void(0);\">',\n                    _l( 'hide deleted' ),\n                '</a>',\n            '<% } else { %>',\n                '<%- history.contents_active.deleted %> ',\n                '<a class=\"toggle-deleted-link\" href=\"javascript:void(0);\">',\n                    _l( 'deleted' ),\n                '</a>',\n            '<% } %>',\n            '</span>',\n        '<% } %>',\n\n        '<% if( history.contents_active.hidden ){ %>',\n            '<span class=\"hidden-count\">',\n            '<% if( view.model.contents.includeHidden ){ %>',\n                '<a class=\"toggle-hidden-link\" href=\"javascript:void(0);\">',\n                    _l( 'hide hidden' ),\n                '</a>',\n            '<% } else { %>',\n                '<%- history.contents_active.hidden %> ',\n                '<a class=\"toggle-hidden-link\" href=\"javascript:void(0);\">',\n                    _l( 'hidden' ),\n                '</a>',\n            '<% } %>',\n            '</span>',\n        '<% } %>',\n    ], 'history' );\n\n    var foundTemplate = BASE_MVC.wrapTemplate([\n        _l( 'Found' ), ' <%- view.views.length %>, ',\n\n        '<% if( history.contents_active.deleted ){ %>',\n            '<% if( view.model.contents.includeDeleted ){ %>',\n                '<a class=\"toggle-deleted-link\" href=\"javascript:void(0);\">',\n                    _l( 'hide deleted' ),\n                '</a>, ',\n            '<% } else { %>',\n                '<a class=\"toggle-deleted-link\" href=\"javascript:void(0);\">',\n                    _l( 'show deleted' ),\n                '</a>, ',\n            '<% } %>',\n        '<% } %>',\n\n        '<% if( history.contents_active.hidden ){ %>',\n            '<% if( view.model.contents.includeHidden ){ %>',\n                '<a class=\"toggle-hidden-link\" href=\"javascript:void(0);\">',\n                    _l( 'hide hidden' ),\n                '</a>',\n            '<% } else { %>',\n                '<a class=\"toggle-hidden-link\" href=\"javascript:void(0);\">',\n                    _l( 'show hidden' ),\n                '</a>',\n            '<% } %>',\n        '<% } %>',\n    ], 'history' );\n\n    return _.extend( _.clone( _super.prototype.templates ), {\n        counts : countsTemplate,\n        found : foundTemplate \n    });\n}());\n\n\n//==============================================================================\n    return {\n        HistoryViewEdit : HistoryViewEdit\n    };\n});\n"]}