{"version":3,"sources":["mvc/history/history-view-edit.js"],"names":["define","HISTORY_VIEW","HISTORY_CONTENTS","STATES","HDA_MODEL","HDA_LI_EDIT","HDCA_LI_EDIT","TAGS","ANNOTATIONS","LIST_COLLECTION_CREATOR","PAIR_COLLECTION_CREATOR","LIST_OF_PAIRS_COLLECTION_CREATOR","faIconButton","PopupMenu","BASE_MVC","_l","_super","HistoryView","HistoryViewEdit","extend","HDAViewClass","HDAListItemEdit","HDCAViewClass","HDCAListItemEdit","initialize","attributes","prototype","call","this","tagsEditor","annotationEditor","purgeAllowed","annotationEditorShown","tagsEditorShown","_setUpListeners","on","droptarget:drop","ev","data","dataDropped","dropTargetOff","view:attached view:removed","_renderCounts","search:loading-progress","_renderSearchProgress","search:searching","_renderSearchFindings","_setUpModelListeners","listenTo","model","updateHistoryDiskSize","_setUpCollectionListeners","collection","change:deleted","_handleItemDeletedChange","change:visible","_handleItemVisibleChange","change:purged","fetch","fetching-deleted","$","html","fetching-hidden","fetching-deleted-done fetching-hidden-done","_buildNewRender","$newRender","Galaxy","user","id","get","_renderTags","_renderAnnotation","text","renderItems","$whereTo","views","searchFor","jQuery","$el","templates","counts","toJSON","find","$where","panel","TagsEditor","el","onshowFirstTime","render","onshow","toggleHDATagEditors","fxSpeed","onhide","$activator","title","classes","faIcon","appendTo","AnnotationEditor","toggleHDAAnnotationEditors","_setUpBehaviors","isAnonymous","attr","tooltip","placement","make_text_editable","on_finish","newName","previousName","save","name","fail","previous","multiselectActions","actions","func","action","HistoryDatasetAssociation","hide","getSelectedModels","ajaxQueue","unhide","undelete","push","confirm","purge","concat","_collectionActions","buildCollection","collectionType","selection","hideSourceItems","createFunc","createListCollection","createPairCollection","createListOfPairsCollection","console","warn","done","refresh","_getItemViewOptions","options","_","hidden","itemModel","_handleItemDeletion","_handleItemUndeletion","contentsShown","deleted","active","contents","includeDeleted","removeItemView","set","_handleItemHidden","_handleItemUnhidden","includeHidden","showOrHide","speed","each","view","toggle","events","clone","click .show-selectors-btn","click .toggle-deleted-link","toggleShowDeleted","click .toggle-hidden-link","toggleShowHidden","limit","offset","stop","join","length","dropTargetOn","dropTarget","dropHandlers","dragenter","bind","dragover","dragleave","drop","$dropTarget","_renderDropTarget","$list","before","_renderDropTargetHelp","evName","hasOwnProperty","remove","addClass","_dropHandlers","off","dropTargetToggle","preventDefault","stopPropagation","css","self","dataTransfer","originalEvent","getData","dropEffect","JSON","parse","err","trigger","isObject","model_class","currentPage","fetchPage","then","copy","when","toString","countsTemplate","wrapTemplate"],"mappings":"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","file":"../../../scripts/mvc/history/history-view-edit.js","sourcesContent":["define([\n    \"mvc/history/history-view\",\n    \"mvc/history/history-contents\",\n    \"mvc/dataset/states\",\n    \"mvc/history/hda-model\",\n    \"mvc/history/hda-li-edit\",\n    \"mvc/history/hdca-li-edit\",\n    \"mvc/tag\",\n    \"mvc/annotation\",\n    \"mvc/collection/list-collection-creator\",\n    \"mvc/collection/pair-collection-creator\",\n    \"mvc/collection/list-of-pairs-collection-creator\",\n    \"ui/fa-icon-button\",\n    \"mvc/ui/popup-menu\",\n    \"mvc/base-mvc\",\n    \"utils/localization\",\n    \"ui/editable-text\",\n], function(\n    HISTORY_VIEW,\n    HISTORY_CONTENTS,\n    STATES,\n    HDA_MODEL,\n    HDA_LI_EDIT,\n    HDCA_LI_EDIT,\n    TAGS,\n    ANNOTATIONS,\n    LIST_COLLECTION_CREATOR,\n    PAIR_COLLECTION_CREATOR,\n    LIST_OF_PAIRS_COLLECTION_CREATOR,\n    faIconButton,\n    PopupMenu,\n    BASE_MVC,\n    _l\n){\n\n'use strict';\n\n/* =============================================================================\nTODO:\n\n============================================================================= */\nvar _super = HISTORY_VIEW.HistoryView;\n// base class for history-view-edit-current and used as-is in history/view.mako\n/** @class Editable View/Controller for the history model.\n *\n *  Allows:\n *      (everything HistoryView allows)\n *      changing the name\n *      displaying and editing tags and annotations\n *      multi-selection and operations on mulitple content items\n */\nvar HistoryViewEdit = _super.extend(\n/** @lends HistoryViewEdit.prototype */{\n\n    /** class to use for constructing the HistoryDatasetAssociation views */\n    HDAViewClass    : HDA_LI_EDIT.HDAListItemEdit,\n    /** class to use for constructing the HistoryDatasetCollectionAssociation views */\n    HDCAViewClass   : HDCA_LI_EDIT.HDCAListItemEdit,\n\n    // ......................................................................... SET UP\n    /** Set up the view, set up storage, bind listeners to HistoryContents events\n     *  @param {Object} attributes\n     */\n    initialize : function( attributes ){\n        attributes = attributes || {};\n        _super.prototype.initialize.call( this, attributes );\n\n        // ---- set up instance vars\n        /** editor for tags - sub-view */\n        this.tagsEditor = null;\n        /** editor for annotations - sub-view */\n        this.annotationEditor = null;\n\n        /** allow user purge of dataset files? */\n        this.purgeAllowed = attributes.purgeAllowed || false;\n\n        // states/modes the panel can be in\n        /** is the panel currently showing the dataset selection controls? */\n        this.annotationEditorShown  = attributes.annotationEditorShown || false;\n        this.tagsEditorShown  = attributes.tagsEditorShown || false;\n    },\n\n    /** Override to handle history as drag-drop target */\n    _setUpListeners : function(){\n        _super.prototype._setUpListeners.call( this );\n        return this.on({\n            'droptarget:drop': function( ev, data ){\n                // process whatever was dropped and re-hide the drop target\n                this.dataDropped( data );\n                this.dropTargetOff();\n            },\n            'view:attached view:removed': function(){\n                this._renderCounts();\n            },\n            'search:loading-progress': this._renderSearchProgress,\n            'search:searching': this._renderSearchFindings,\n        });\n    },\n\n    // ------------------------------------------------------------------------ listeners\n    /** listening for history and HDA events */\n    _setUpModelListeners : function(){\n        _super.prototype._setUpModelListeners.call( this );\n        this.listenTo( this.model, 'change:size', this.updateHistoryDiskSize );\n        return this;\n    },\n\n    /** listening for collection events */\n    _setUpCollectionListeners : function(){\n        _super.prototype._setUpCollectionListeners.call( this );\n        this.listenTo( this.collection, {\n            'change:deleted': this._handleItemDeletedChange,\n            'change:visible': this._handleItemVisibleChange,\n            'change:purged' : function( model ){\n                // hafta get the new nice-size w/o the purged model\n                this.model.fetch();\n            },\n            // loading indicators for deleted/hidden\n            'fetching-deleted'      : function( collection ){\n                this.$( '> .controls .deleted-count' )\n                    .html( '<i>' + _l( 'loading...' ) + '</i>' );\n            },\n            'fetching-hidden'       : function( collection ){\n                this.$( '> .controls .hidden-count' )\n                    .html( '<i>' + _l( 'loading...' ) + '</i>' );\n            },\n            'fetching-deleted-done fetching-hidden-done'  : this._renderCounts,\n        });\n        return this;\n    },\n\n    // ------------------------------------------------------------------------ panel rendering\n    /** In this override, add tag and annotation editors and a btn to toggle the selectors */\n    _buildNewRender : function(){\n        // create a new render using a skeleton template, render title buttons, render body, and set up events, etc.\n        var $newRender = _super.prototype._buildNewRender.call( this );\n        if( !this.model ){ return $newRender; }\n\n        if( Galaxy && Galaxy.user && Galaxy.user.id && Galaxy.user.id === this.model.get( 'user_id' ) ){\n            this._renderTags( $newRender );\n            this._renderAnnotation( $newRender );\n        }\n        return $newRender;\n    },\n\n    /** Update the history size display (curr. upper right of panel). */\n    updateHistoryDiskSize : function(){\n        this.$( '.history-size' ).text( this.model.get( 'nice_size' ) );\n    },\n\n    /** override to render counts when the items are rendered */\n    renderItems : function( $whereTo ){\n        var views = _super.prototype.renderItems.call( this, $whereTo );\n        if( !this.searchFor ){ this._renderCounts( $whereTo ); }\n        return views;\n    },\n\n    /** override to show counts, what's deleted/hidden, and links to toggle those */\n    _renderCounts : function( $whereTo ){\n        $whereTo = $whereTo instanceof jQuery? $whereTo : this.$el;\n        var html = this.templates.counts( this.model.toJSON(), this );\n        return $whereTo.find( '> .controls .subtitle' ).html( html );\n    },\n\n    /** render the tags sub-view controller */\n    _renderTags : function( $where ){\n        var panel = this;\n        this.tagsEditor = new TAGS.TagsEditor({\n            model           : this.model,\n            el              : $where.find( '.controls .tags-display' ),\n            onshowFirstTime : function(){ this.render(); },\n            // show hide sub-view tag editors when this is shown/hidden\n            onshow          : function(){\n                panel.toggleHDATagEditors( true,  panel.fxSpeed );\n            },\n            onhide          : function(){\n                panel.toggleHDATagEditors( false, panel.fxSpeed );\n            },\n            $activator      : faIconButton({\n                title   : _l( 'Edit history tags' ),\n                classes : 'history-tag-btn',\n                faIcon  : 'fa-tags'\n            }).appendTo( $where.find( '.controls .actions' ) )\n        });\n    },\n    /** render the annotation sub-view controller */\n    _renderAnnotation : function( $where ){\n        var panel = this;\n        this.annotationEditor = new ANNOTATIONS.AnnotationEditor({\n            model           : this.model,\n            el              : $where.find( '.controls .annotation-display' ),\n            onshowFirstTime : function(){ this.render(); },\n            // show hide sub-view view annotation editors when this is shown/hidden\n            onshow          : function(){\n                panel.toggleHDAAnnotationEditors( true,  panel.fxSpeed );\n            },\n            onhide          : function(){\n                panel.toggleHDAAnnotationEditors( false, panel.fxSpeed );\n            },\n            $activator      : faIconButton({\n                title   : _l( 'Edit history annotation' ),\n                classes : 'history-annotate-btn',\n                faIcon  : 'fa-comment'\n            }).appendTo( $where.find( '.controls .actions' ) )\n        });\n    },\n\n    /** Set up HistoryViewEdit js/widget behaviours\n     *  In this override, make the name editable\n     */\n    _setUpBehaviors : function( $where ){\n        $where = $where || this.$el;\n        _super.prototype._setUpBehaviors.call( this, $where );\n        if( !this.model ){ return; }\n\n        // anon users shouldn't have access to any of the following\n        if( ( !Galaxy.user || Galaxy.user.isAnonymous() )\n        ||  ( Galaxy.user.id !== this.model.get( 'user_id' ) ) ){\n            return;\n        }\n\n        var panel = this,\n            nameSelector = '> .controls .name';\n        $where.find( nameSelector )\n            .attr( 'title', _l( 'Click to rename history' ) )\n            .tooltip({ placement: 'bottom' })\n            .make_text_editable({\n                on_finish: function( newName ){\n                    var previousName = panel.model.get( 'name' );\n                    if( newName && newName !== previousName ){\n                        panel.$el.find( nameSelector ).text( newName );\n                        panel.model.save({ name: newName })\n                            .fail( function(){\n                                panel.$el.find( nameSelector ).text( panel.model.previous( 'name' ) );\n                            });\n                    } else {\n                        panel.$el.find( nameSelector ).text( previousName );\n                    }\n                }\n            });\n    },\n\n    /** return a new popup menu for choosing a multi selection action\n     *  ajax calls made for multiple datasets are queued\n     */\n    multiselectActions : function(){\n        var panel = this,\n            actions = [\n                {   html: _l( 'Hide datasets' ), func: function(){\n                        var action = HDA_MODEL.HistoryDatasetAssociation.prototype.hide;\n                        panel.getSelectedModels().ajaxQueue( action );\n                    }\n                },\n                {   html: _l( 'Unhide datasets' ), func: function(){\n                        var action = HDA_MODEL.HistoryDatasetAssociation.prototype.unhide;\n                        panel.getSelectedModels().ajaxQueue( action );\n                    }\n                },\n                {   html: _l( 'Delete datasets' ), func: function(){\n                        var action = HDA_MODEL.HistoryDatasetAssociation.prototype['delete'];\n                        panel.getSelectedModels().ajaxQueue( action );\n                    }\n                },\n                {   html: _l( 'Undelete datasets' ), func: function(){\n                        var action = HDA_MODEL.HistoryDatasetAssociation.prototype.undelete;\n                        panel.getSelectedModels().ajaxQueue( action );\n                    }\n                }\n            ];\n        if( panel.purgeAllowed ){\n            actions.push({\n                html: _l( 'Permanently delete datasets' ), func: function(){\n                    if( confirm( _l( 'This will permanently remove the data in your datasets. Are you sure?' ) ) ){\n                        var action = HDA_MODEL.HistoryDatasetAssociation.prototype.purge;\n                        panel.getSelectedModels().ajaxQueue( action );\n                    }\n                }\n            });\n        }\n        actions = actions.concat( panel._collectionActions() );\n        return actions;\n    },\n\n    /**   */\n    _collectionActions : function(){\n        var panel = this;\n        return [\n            {   html: _l( 'Build Dataset List' ), func: function() { panel.buildCollection( \"list\") }\n            },\n            // TODO: Only show quick pair if two things selected.\n            {   html: _l( 'Build Dataset Pair' ), func: function() { panel.buildCollection( \"paired\") }\n            },\n            {   html: _l( 'Build List of Dataset Pairs' ), func: function() { panel.buildCollection( \"list:paired\" ) }\n            },\n        ];\n    },\n\n    buildCollection : function( collectionType, selection, hideSourceItems ) {\n        var panel = this;\n        var selection = selection || panel.getSelectedModels();\n        var hideSourceItems = hideSourceItems || false;\n        var createFunc;\n        if( collectionType == \"list\" ) {\n            createFunc = LIST_COLLECTION_CREATOR.createListCollection;\n        } else if( collectionType == \"paired\" ) {\n            createFunc = PAIR_COLLECTION_CREATOR.createPairCollection;\n        } else if( collectionType == \"list:paired\" ) {\n            createFunc = LIST_OF_PAIRS_COLLECTION_CREATOR.createListOfPairsCollection;\n        } else {\n            console.warn( \"Unknown collectionType encountered \" + collectionType );\n        }\n        createFunc( selection, hideSourceItems ).done( function() { panel.model.refresh() } );\n    },\n\n    // ------------------------------------------------------------------------ sub-views\n    /** In this override, add purgeAllowed and whether tags/annotation editors should be shown */\n    _getItemViewOptions : function( model ){\n        var options = _super.prototype._getItemViewOptions.call( this, model );\n        _.extend( options, {\n            purgeAllowed            : this.purgeAllowed,\n            tagsEditorShown         : ( this.tagsEditor && !this.tagsEditor.hidden ),\n            annotationEditorShown   : ( this.annotationEditor && !this.annotationEditor.hidden )\n        });\n        return options;\n    },\n\n    /** If this item is deleted and we're not showing deleted items, remove the view\n     *  @param {Model} the item model to check\n     */\n    _handleItemDeletedChange : function( itemModel ){\n        if( itemModel.get( 'deleted' ) ){\n            this._handleItemDeletion( itemModel );\n        } else {\n            this._handleItemUndeletion( itemModel );\n        }\n        this._renderCounts();\n    },\n\n    _handleItemDeletion : function( itemModel ){\n        var contentsShown = this.model.get( 'contents_active' );\n        contentsShown.deleted += 1;\n        contentsShown.active -= 1;\n        if( !this.model.contents.includeDeleted ){\n            this.removeItemView( itemModel );\n        }\n        this.model.set( 'contents_active', contentsShown );\n    },\n\n    _handleItemUndeletion : function( itemModel ){\n        var contentsShown = this.model.get( 'contents_active' );\n        contentsShown.deleted -= 1;\n        if( !this.model.contents.includeDeleted ){\n            contentsShown.active -= 1;\n        }\n        this.model.set( 'contents_active', contentsShown );\n    },\n\n    /** If this item is hidden and we're not showing hidden items, remove the view\n     *  @param {Model} the item model to check\n     */\n    _handleItemVisibleChange : function( itemModel ){\n        if( itemModel.hidden() ){\n            this._handleItemHidden( itemModel );\n        } else {\n            this._handleItemUnhidden( itemModel );\n        }\n        this._renderCounts();\n    },\n\n    _handleItemHidden : function( itemModel ){\n        var contentsShown = this.model.get( 'contents_active' );\n        contentsShown.hidden += 1;\n        contentsShown.active -= 1;\n        if( !this.model.contents.includeHidden ){\n            this.removeItemView( itemModel );\n        }\n        this.model.set( 'contents_active', contentsShown );\n    },\n\n    _handleItemUnhidden : function( itemModel ){\n        var contentsShown = this.model.get( 'contents_active' );\n        contentsShown.hidden -= 1;\n        if( !this.model.contents.includeHidden ){\n            contentsShown.active -= 1;\n        }\n        this.model.set( 'contents_active', contentsShown );\n    },\n\n    /** toggle the visibility of each content's tagsEditor applying all the args sent to this function */\n    toggleHDATagEditors : function( showOrHide, speed ){\n        _.each( this.views, function( view ){\n            if( view.tagsEditor ){\n                view.tagsEditor.toggle( showOrHide, speed );\n            }\n        });\n    },\n\n    /** toggle the visibility of each content's annotationEditor applying all the args sent to this function */\n    toggleHDAAnnotationEditors : function( showOrHide, speed ){\n        _.each( this.views, function( view ){\n            if( view.annotationEditor ){\n                view.annotationEditor.toggle( showOrHide, speed );\n            }\n        });\n    },\n\n    // ------------------------------------------------------------------------ panel events\n    /** event map */\n    events : _.extend( _.clone( _super.prototype.events ), {\n        'click .show-selectors-btn'                 : 'toggleSelectors',\n        'click .toggle-deleted-link'                : function( ev ){ this.toggleShowDeleted(); },\n        'click .toggle-hidden-link'                 : function( ev ){ this.toggleShowHidden(); }\n    }),\n\n    // ------------------------------------------------------------------------ search\n    _renderSearchProgress : function( limit, offset ){\n        var stop = limit + offset;\n        return this.$( '> .controls .subtitle' ).html([\n            '<i>',\n                _l( 'Searching ' ), stop, '/', this.model.contentsShown(),\n            '</i>'\n        ].join(''));\n    },\n\n    /** override to display number found in subtitle */\n    _renderSearchFindings : function(){\n        this.$( '> .controls .subtitle' ).html([\n            _l( 'Found' ), this.views.length\n        ].join(' '));\n        return this;\n    },\n\n    // ------------------------------------------------------------------------ as drop target\n    /** turn all the drag and drop handlers on and add some help text above the drop area */\n    dropTargetOn : function(){\n        if( this.dropTarget ){ return this; }\n        this.dropTarget = true;\n\n        //TODO: to init\n        var dropHandlers = {\n            'dragenter' : _.bind( this.dragenter, this ),\n            'dragover'  : _.bind( this.dragover,  this ),\n            'dragleave' : _.bind( this.dragleave, this ),\n            'drop'      : _.bind( this.drop, this )\n        };\n\n        var $dropTarget = this._renderDropTarget();\n        this.$list().before([ this._renderDropTargetHelp(), $dropTarget ]);\n        for( var evName in dropHandlers ){\n            if( dropHandlers.hasOwnProperty( evName ) ){\n                //console.debug( evName, dropHandlers[ evName ] );\n                $dropTarget.on( evName, dropHandlers[ evName ] );\n            }\n        }\n        return this;\n    },\n\n    /** render a box to serve as a 'drop here' area on the history */\n    _renderDropTarget : function(){\n        this.$( '.history-drop-target' ).remove();\n        return $( '<div/>' ).addClass( 'history-drop-target' );\n    },\n\n    /** tell the user how it works  */\n    _renderDropTargetHelp : function(){\n        this.$( '.history-drop-target-help' ).remove();\n        return $( '<div/>' ).addClass( 'history-drop-target-help' )\n            .text( _l( 'Drag datasets here to copy them to the current history' ) );\n    },\n\n    /** shut down drag and drop event handlers and remove drop target */\n    dropTargetOff : function(){\n        if( !this.dropTarget ){ return this; }\n        //this.log( 'dropTargetOff' );\n        this.dropTarget = false;\n        var dropTarget = this.$( '.history-drop-target' ).get(0);\n        for( var evName in this._dropHandlers ){\n            if( this._dropHandlers.hasOwnProperty( evName ) ){\n                dropTarget.off( evName, this._dropHandlers[ evName ] );\n            }\n        }\n        this.$( '.history-drop-target' ).remove();\n        this.$( '.history-drop-target-help' ).remove();\n        return this;\n    },\n    /** toggle the target on/off */\n    dropTargetToggle : function(){\n        if( this.dropTarget ){\n            this.dropTargetOff();\n        } else {\n            this.dropTargetOn();\n        }\n        return this;\n    },\n\n    dragenter : function( ev ){\n        //console.debug( 'dragenter:', this, ev );\n        ev.preventDefault();\n        ev.stopPropagation();\n        this.$( '.history-drop-target' ).css( 'border', '2px solid black' );\n    },\n    dragover : function( ev ){\n        ev.preventDefault();\n        ev.stopPropagation();\n    },\n    dragleave : function( ev ){\n        //console.debug( 'dragleave:', this, ev );\n        ev.preventDefault();\n        ev.stopPropagation();\n        this.$( '.history-drop-target' ).css( 'border', '1px dashed black' );\n    },\n    /** when (text) is dropped try to parse as json and trigger an event */\n    drop : function( ev ){\n        ev.preventDefault();\n        //ev.stopPropagation();\n\n        var self = this;\n        var dataTransfer = ev.originalEvent.dataTransfer;\n        var data = dataTransfer.getData( \"text\" );\n\n        dataTransfer.dropEffect = 'move';\n        try {\n            data = JSON.parse( data );\n        } catch( err ){\n            self.warn( 'error parsing JSON from drop:', data );\n        }\n\n        self.trigger( 'droptarget:drop', ev, data, self );\n        return false;\n    },\n\n    /** handler that copies data into the contents */\n    dataDropped : function( data ){\n        var self = this;\n        // HDA: dropping will copy it to the history\n        if( _.isObject( data ) && data.model_class === 'HistoryDatasetAssociation' && data.id ){\n            if( self.contents.currentPage !== 0 ){\n                return self.contents.fetchPage( 0 )\n                    .then( function(){\n                        return self.model.contents.copy( data.id );\n                    });\n            }\n            return self.model.contents.copy( data.id );\n        }\n        return jQuery.when();\n    },\n\n    // ........................................................................ misc\n    /** Return a string rep of the history */\n    toString    : function(){\n        return 'HistoryViewEdit(' + (( this.model )?( this.model.get( 'name' )):( '' )) + ')';\n    }\n});\n\n//------------------------------------------------------------------------------ TEMPLATES\nHistoryViewEdit.prototype.templates = (function(){\n\n    var countsTemplate = BASE_MVC.wrapTemplate([\n        '<% var shown = Math.max( view.views.length, history.contents_active.active ) %>',\n        '<% if( shown ){ %>',\n            '<span class=\"shown-count\">',\n                '<%- shown %> ', _l( 'shown' ),\n            '</span>',\n        '<% } %>',\n\n        '<% if( history.contents_active.deleted ){ %>',\n            '<span class=\"deleted-count\">',\n            '<% if( view.model.contents.includeDeleted ){ %>',\n                '<a class=\"toggle-deleted-link\" href=\"javascript:void(0);\">',\n                    _l( 'hide deleted' ),\n                '</a>',\n            '<% } else { %>',\n                '<%- history.contents_active.deleted %> ',\n                '<a class=\"toggle-deleted-link\" href=\"javascript:void(0);\">',\n                    _l( 'deleted' ),\n                '</a>',\n            '<% } %>',\n            '</span>',\n        '<% } %>',\n\n        '<% if( history.contents_active.hidden ){ %>',\n            '<span class=\"hidden-count\">',\n            '<% if( view.model.contents.includeHidden ){ %>',\n                '<a class=\"toggle-hidden-link\" href=\"javascript:void(0);\">',\n                    _l( 'hide hidden' ),\n                '</a>',\n            '<% } else { %>',\n                '<%- history.contents_active.hidden %> ',\n                '<a class=\"toggle-hidden-link\" href=\"javascript:void(0);\">',\n                    _l( 'hidden' ),\n                '</a>',\n            '<% } %>',\n            '</span>',\n        '<% } %>',\n    ], 'history' );\n\n    return _.extend( _.clone( _super.prototype.templates ), {\n        counts : countsTemplate\n    });\n}());\n\n\n//==============================================================================\n    return {\n        HistoryViewEdit : HistoryViewEdit\n    };\n});\n"]}