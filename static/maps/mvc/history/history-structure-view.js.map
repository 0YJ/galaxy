{"version":3,"sources":["mvc/history/history-structure-view.js"],"names":["define","JobDAG","JOB","JOB_LI","DATASET_LI","BASE_MVC","_l","window","HistoryStructureComponent","Backbone","View","extend","LoggableMixin","_logNamespace","className","_INITIAL_ZOOM_LEVEL","_MIN_ZOOM_LEVEL","_LINK_ID_SEP","_VERTEX_NAME_DATA_KEY","JobItemClass","JobListItemView","ContentItemClass","DatasetListItemView","initialize","attributes","this","log","component","_liMap","_createVertexItems","zoomLevel","layout","_createLayout","layoutOptions","view","eachVertex","vertex","li","type","data","job","_createJobListItem","_createContentListItem","name","debug","jobData","Job","outputModels","_","map","get","output","model","contents","type_id","outputCollection","reset","historyId","id","tool","listenTo","renderGraph","foldout","content","layoutDefaults","linkSpacing","linkWidth","linkHeight","jobWidth","jobHeight","jobSpacing","linkAdjX","linkAdjY","options","defaults","clone","vertices","values","nodeMap","links","svg","width","height","forEach","v","j","node","x","y","edges","e","link","source","target","push","render","$el","html","join","$graph","appendTo","$","_render","_updateLayout","css","renderSVG","position","top","left","is","delay","size","each","jobId","Math","max","x1","y1","x2","y2","JSON","stringify","highlightConnect","d","d3","select","classed","addClass","unhighlightConnect","removeClass","empty","append","attr","connections","selectAll","enter","on","_connectionPath","controlY","events","mouseover .graph > .list-item","ev","highlightConnected","currentTarget","mouseout  .graph > .list-item","jobElement","highlight","undefined","jobClassFn","jQuery","prototype","connectionClass","$hoverTarget","call","edge","ancestorId","ancestorLi","eachEdge","descendantId","descendantLi","zoom","level","min","toString","VerticalHistoryStructureComponent","nodeId","controlX","_layoutToComponentClass","horizontal","vertical","_DEFAULT_LAYOUT","contains","keys","_processTools","tools","_processJobs","jobs","_createDAG","dag","historyContents","toJSON","excludeSetMetadata","excludeErroredJobs","_createComponents","structure","componentViews","weakComponentGraphArray","componentGraph","_createComponent","ComponentClass","$components","changeLayout","Error"],"mappings":"AAAAA,QACI,sBACA,oBACA,iBACA,yBACA,eACA,qBACA,WACD,SAAUC,EAAQC,EAAKC,EAAQC,EAAYC,EAAUC,GAExD,YAuFAC,QAAON,OAASA,CAChB,IAAIO,GAA4BC,SAASC,KAAKC,OAAQN,EAASO,eAAgBD,QAC3EE,cAvFe,UAyFfC,UAAY,8BAEZC,oBAA0B,EAC1BC,gBAA0B,IAC1BC,aAA0B,OAC1BC,sBAA0B,cAE1BC,aAAsBhB,EAAOiB,gBAC7BC,iBAAsBjB,EAAWkB,oBAEjCC,WAAa,SAAUC,GACnBC,KAAKC,IAAKD,KAAO,0CAA2CD,GAC5DC,KAAKE,UAAYH,EAAWG,UAE5BF,KAAKG,UACLH,KAAKI,qBAELJ,KAAKK,UAAYN,EAAWM,WAAaL,KAAKV,oBAE9CU,KAAKM,OAASN,KAAKO,cAAeR,EAAWS,gBAGjDJ,mBAAqB,WACjB,GAAIK,GAAOT,IACXS,GAAKP,UAAUQ,WAAY,SAAUC,GAEjC,GACIC,GADAC,EAAOF,EAAOG,KAAKC,IAAK,MAAQ,MAEvB,SAATF,EACAD,EAAKH,EAAKO,mBAAoBL,GACd,SAATE,IACPD,EAAKH,EAAKQ,uBAAwBN,IAEtCF,EAAKN,OAAQQ,EAAOO,MAASN,IAEjCH,EAAKU,MAAO,UAAWV,EAAKN,SAGhCa,mBAAqB,SAAUL,GAC3BX,KAAKmB,MAAO,sBAAuBR,EACnC,IAAIF,GAAOT,KACPoB,EAAUT,EAAOG,KACjBC,EAAM,GAAItC,GAAI4C,IAAKD,EAAQL,KAG3BO,EAAeC,EAAEC,IAAKT,EAAIU,IAAK,WAAa,SAAUC,GAGtD,MAAOjB,GAAKkB,MAAMC,SAASH,IAAKC,EAAOG,UAG3Cd,GAAIe,iBAAiBC,MAAOT,GAC5BP,EAAIe,iBAAiBE,UAAYvB,EAAKkB,MAAMM,EAI5C,IAAIrB,GAAK,GAAIH,GAAKf,cAAeiC,MAAOZ,EAAKmB,KAAMd,EAAQc,KAAMd,QAASA,GAG1E,OAFAX,GAAK0B,SAAUvB,EAAI,0CAA2CH,EAAK2B,aACnE3B,EAAK0B,SAAUvB,EAAGyB,QAAS,8DAA+D5B,EAAK2B,aACxFxB,GAGXK,uBAAyB,SAAUN,GAC/BX,KAAKmB,MAAO,0BAA2BR,EACvC,IAAIF,GAAOT,KACPsC,EAAU3B,EAAOG,IACrBwB,GAAU7B,EAAKkB,MAAMC,SAASH,IAAKa,EAAQT,QAC3C,IAAIjB,GAAK,GAAIH,GAAKb,kBAAmB+B,MAAOW,GAE5C,OADA7B,GAAK0B,SAAUvB,EAAI,0CAA2CH,EAAK2B,aAC5DxB,GAGX2B,gBACIC,YAAkB,GAClBC,UAAkB,EAClBC,WAAkB,EAClBC,SAAkB,IAClBC,UAAkB,IAClBC,WAAkB,GAClBC,SAAkB,EAClBC,SAAkB,GAGtBxC,cAAgB,SAAUyC,GACtBA,EAAUzB,EAAE0B,SAAU1B,EAAE2B,MAAOF,OAAiBhD,KAAKuC,eACrD,IAAI9B,GAAOT,KACPmD,EAAW5B,EAAE6B,OAAQ3C,EAAKP,UAAUiD,UACpC7C,EAASiB,EAAErC,OAAQ8D,GACfK,WACAC,SACAC,KAAoBC,MAAO,EAAGC,OAAQ,IAgB9C,OAbAN,GAASO,QAAS,SAAUC,EAAGC,GAC3B,GAAIC,IAAS3C,KAAMyC,EAAEzC,KAAM4C,EAAG,EAAGC,EAAG,EACpCzD,GAAO+C,QAASM,EAAEzC,MAAS2C,IAG/BpD,EAAKP,UAAU8D,MAAO,SAAUC,GAC5B,GAAIC,IACIC,OAAQF,EAAEE,OACVC,OAAQH,EAAEG,OAElB9D,GAAOgD,MAAMe,KAAMH,KAGhB5D,GAGXgE,OAAS,SAAUtB,GACfhD,KAAKmB,MAAOnB,KAAO,WAAYgD,EAC/B,IAAIvC,GAAOT,IACXS,GAAK8D,IAAIC,MACL,oBACA,+BACA,kCACA,qBACFC,KAAM,IAER,IAAIC,GAASjE,EAAKiE,QAOlB,OANAjE,GAAKP,UAAUQ,WAAY,SAAUC,GACjCF,EAAKN,OAAQQ,EAAOO,MAAOoD,OAAQ,GAAIC,IAAII,SAAUD,GAEhD5D,KAAML,EAAKhB,sBAAuBkB,EAAOO,QAElDT,EAAK2B,cACEpC,MAGX0E,OAAS,WACL,MAAO1E,MAAK4E,EAAG,WAGnBxC,YAAc,SAAUY,GAIpB,QAAS6B,KAELpE,EAAKqE,gBAELrE,EAAKiE,SAEAK,IAAK,aAAe,SAAUtE,EAAKJ,UAAW,IAAKI,EAAKJ,UAAW,KAAMoE,KAAM,KAC/EjB,MAAO/C,EAAKH,OAAOiD,IAAIC,OACvBC,OAAQhD,EAAKH,OAAOiD,IAAIE,QAC7BhD,EAAKuE,YAGLvE,EAAKP,UAAUQ,WAAY,SAAUiD,GAEjC,GAAI/C,GAAKH,EAAKN,OAAQwD,EAAEzC,MACpB+D,EAAWxE,EAAKH,OAAO+C,QAASM,EAAEzC,KAEtCN,GAAG2D,IAAIQ,KAAMG,IAAKD,EAASlB,EAAGoB,KAAMF,EAASnB,MApBrD9D,KAAKmB,MAAOnB,KAAO,gBAAiBgD,EACpC,IAAIvC,GAAOT,IA4BX,OALKA,MAAKuE,IAAIa,GAAI,YAGdP,IAFAtD,EAAE8D,MAAOR,EAAS,GAIf7E,MAGX8E,cAAgB,WACZ9E,KAAKmB,MAAOnB,KAAO,kBACnB,IAAIS,GAAOT,KACPM,EAASG,EAAKH,MAElBA,GAAOoC,WAAapC,EAAOkC,YAAcjB,EAAE+D,KAAMhF,EAAO+C,SACxD/C,EAAOiD,IAAIE,OAASnD,EAAOoC,WAAapC,EAAOsC,UAG/CtC,EAAOiD,IAAIC,MAAQ,CAInB,IAAIM,GAAI,EACJC,EAAIzD,EAAOoC,UAqBf,OApBAnB,GAAEgE,KAAMjF,EAAO+C,QAAS,SAAUQ,EAAM2B,GAEpC3B,EAAKC,EAAIA,EACTD,EAAKE,EAAIA,EACTD,GAAKxD,EAAOqC,SAAWrC,EAAOuC,aAElCvC,EAAOiD,IAAIC,MAAQlD,EAAOmC,UAAYgD,KAAKC,IAAKpF,EAAOiD,IAAIC,MAAOM,GAIlExD,EAAOgD,MAAMI,QAAS,SAAUQ,GAC5B,GAAIC,GAAS7D,EAAO+C,QAASa,EAAKC,QAC9BC,EAAS9D,EAAO+C,QAASa,EAAKE,OAClCF,GAAKyB,GAAKxB,EAAOL,EAAIxD,EAAOwC,SAC5BoB,EAAK0B,GAAKzB,EAAOJ,EAAIzD,EAAOyC,SAC5BmB,EAAK2B,GAAKzB,EAAON,EAAIxD,EAAOwC,SAC5BoB,EAAK4B,GAAK1B,EAAOL,EAAIzD,EAAOyC,WAGhC/C,KAAKmB,MAAO4E,KAAKC,UAAW1F,EAAQ,KAAM,OACnCN,KAAKM,QAGhB0E,UAAY,WAcR,QAASiB,GAAkBC,GACvBC,GAAGC,OAAQpG,MAAOqG,QAAS,eAAe,GAC1C5F,EAAKN,OAAQ+F,EAAE/B,QAASI,IAAI+B,SAAU,eACtC7F,EAAKN,OAAQ+F,EAAE9B,QAASG,IAAI+B,SAAU,eAG1C,QAASC,GAAoBL,GACzBC,GAAGC,OAAQpG,MAAOqG,QAAS,eAAe,GAC1C5F,EAAKN,OAAQ+F,EAAE/B,QAASI,IAAIiC,YAAa,eACzC/F,EAAKN,OAAQ+F,EAAE9B,QAASG,IAAIiC,YAAa,eAtB7CxG,KAAKmB,MAAOnB,KAAO,cACnB,IAAIS,GAAOT,KACPM,EAASG,EAAKH,OAEdiD,EAAM4C,GAAGC,OAAQpG,KAAK0E,SAASjD,IAAI,IAAK2E,OAAQ,MAChD7C,GAAIkD,UACJlD,EAAM4C,GAAGC,OAAQpG,KAAK0E,SAASjD,IAAI,IAAKiF,OAAQ,QAGpDnD,EACKoD,KAAM,QAASrG,EAAOiD,IAAIC,OAC1BmD,KAAM,SAAUrG,EAAOiD,IAAIE,OAchC,IAAImD,GAAcrD,EAAIsD,UAAW,eACxB/F,KAAMR,EAAOgD,MAYtB,OAVAsD,GACKE,QAAQJ,OAAQ,QACZC,KAAM,QAAS,cACfA,KAAM,KAAM,SAAUT,GAAK,OAASA,EAAE/B,OAAQ+B,EAAE9B,QAASK,KAAMhE,EAAKjB,gBACpEuH,GAAI,YAAad,GACjBc,GAAI,WAAYR,GAEzBK,EACSD,KAAM,IAAK,SAAUT,GAAK,MAAOzF,GAAKuG,gBAAiBd,KAEzD3C,EAAIM,QAGfmD,gBAAkB,SAAUd,GACxB,GACIe,IAAef,EAAEL,GAAKK,EAAEP,IAAO3F,KAAKM,OAAOiD,IAAIC,MAAUxD,KAAKM,OAAOoC,UACzE,QACI,IAAKwD,EAAEP,GAAI,IAAKO,EAAEN,GAAI,IACtB,IACIM,EAAEP,GALI,EAKU,IAAKO,EAAEN,GAAKqB,EAAU,IACtCf,EAAEL,GANI,EAMU,IAAKK,EAAEJ,GAAKmB,EAAU,IAC1Cf,EAAEL,GAAI,IAAKK,EAAEJ,IACfrB,KAAM,KAGZyC,QACIC,gCAAmC,SAAUC,GAAMpH,KAAKqH,mBAAoBD,EAAGE,eAAe,IAC9FC,gCAAmC,SAAUH,GAAMpH,KAAKqH,mBAAoBD,EAAGE,eAAe,KAGlGD,mBAAqB,SAAUG,EAAYC,GACvCzH,KAAKmB,MAAO,qBAAsBqG,EAAYC,GAC9CA,MAA0BC,KAAdD,GAAyBA,CAErC,IAAIhH,GAAOT,KACPE,EAAYO,EAAKP,UACjByH,EAAaF,EAAWG,OAAOC,UAAUvB,SAAWsB,OAAOC,UAAUrB,YACrEsB,EAAkBL,EAAW,yBAA2B,aAGxDM,EAAeJ,EAAWK,KAAMpD,EAAG4C,GAAc,eACjDvF,EAAK8F,EAAajH,KAAML,EAAKhB,sBAGjCS,GAAU8D,OAAQI,OAAQnC,IAAMyB,QAAS,SAAUuE,GAC/C,GAAIC,GAAaD,EAAK9D,OAClBgE,EAAa1H,EAAKN,OAAQ+H,EAE9BP,GAAWK,KAAMG,EAAW5D,IAAK,eACjC9D,EAAKmE,EAAG,IAAMsD,EAAazH,EAAKjB,aAAeyC,GAAK0E,KAAM,QAASmB,KAGvE5H,EAAUiD,SAAUlB,GAAKmG,SAAU,SAAUH,GACzC,GAAII,GAAeJ,EAAK7D,OACpBkE,EAAe7H,EAAKN,OAAQkI,EAEhCV,GAAWK,KAAMM,EAAa/D,IAAK,eACnC9D,EAAKmE,EAAG,IAAM3C,EAAKxB,EAAKjB,aAAe6I,GAAe1B,KAAM,QAASmB,MAI7ES,KAAO,SAAUC,GAEb,MADAxI,MAAKK,UAAYoF,KAAKgD,IAAK,EAAKhD,KAAKC,IAAK1F,KAAKT,gBAAiBiJ,IACzDxI,KAAKoC,eAGhBsG,SAAW,WACP,MAAO,6BAA+B1I,KAAK2B,MAAMM,GAAK,OAS1D0G,EAAoC5J,EAA0BG,QAI9DG,UAAYN,EAA0B8I,UAAUxI,UAAY,YAE5DkD,eAAiBhB,EAAErC,OAAQqC,EAAE2B,MAAOnE,EAA0B8I,UAAUtF,iBACpEO,SAAkB,EAClBC,SAAkB,IAItB+B,cAAgB,WACZ9E,KAAKmB,MAAOnB,KAAO,kBACnB,IAAIS,GAAOT,KACPM,EAASG,EAAKH,MAGlBA,GAAOmC,UAAYnC,EAAOkC,YAAcjB,EAAE+D,KAAMhF,EAAO+C,SACvD/C,EAAOiD,IAAIC,MAAQlD,EAAOmC,UAAYnC,EAAOqC,SAG7CrC,EAAOiD,IAAIE,OAAS,CAGpB,IAAIK,GAAIxD,EAAOmC,UACXsB,EAAI,CAqBR,OApBAxC,GAAEgE,KAAMjF,EAAO+C,QAAS,SAAUQ,EAAM+E,GACpC/E,EAAKC,EAAIA,EACTD,EAAKE,EAAIA,CACT,IAAInD,GAAKH,EAAKN,OAAQyI,EACtB7E,IAAKnD,EAAG2D,IAAId,SAAWnD,EAAOuC,aAElCvC,EAAOoC,WAAapC,EAAOiD,IAAIE,OAASgC,KAAKC,IAAKpF,EAAOiD,IAAIE,OAAQM,GAGrEzD,EAAOgD,MAAMI,QAAS,SAAUQ,GAC5B,GAAIC,GAAS7D,EAAO+C,QAASa,EAAKC,QAC9BC,EAAS9D,EAAO+C,QAASa,EAAKE,OAClCF,GAAKyB,GAAKxB,EAAOL,EAAIxD,EAAOwC,SAC5BoB,EAAK0B,GAAKzB,EAAOJ,EAAIzD,EAAOyC,SAC5BmB,EAAK2B,GAAKzB,EAAON,EAAIxD,EAAOwC,SAC5BoB,EAAK4B,GAAK1B,EAAOL,EAAIzD,EAAOyC,WAIhC/C,KAAKmB,MAAO4E,KAAKC,UAAW1F,EAAQ,KAAM,OACnCA,GAGX0G,gBAAkB,SAAUd,GACxB,GACI2C,IAAe3C,EAAEJ,GAAKI,EAAEN,IAAO5F,KAAKM,OAAOiD,IAAIE,OAAWzD,KAAKM,OAAOmC,SAC1E,QACI,IAAKyD,EAAEP,GAAI,IAAKO,EAAEN,GAAI,IACtB,IACIM,EAAEP,GAAKkD,EAAU,IAAK3C,EAAEN,GALlB,EAKgC,IACtCM,EAAEL,GAAKgD,EAAU,IAAK3C,EAAEJ,GANlB,EAMgC,IAC1CI,EAAEL,GAAI,IAAKK,EAAEJ,IACfrB,KAAM,KAGZiE,SAAW,WACP,MAAO,qCAAuC1I,KAAK2B,MAAMM,GAAK,MA4GlE,OAnGuBjD,UAASC,KAAKC,OAAQN,EAASO,eAAgBD,QACtEE,cAvde,UAydfC,UAAY,oBAEZyJ,yBACIC,WAAkBhK,EAClBiK,SAAkBL,GAGtBM,gBAAkB,WAElBnJ,WAAa,SAAUC,GACnBC,KAAKM,OAASiB,EAAE2H,SAAUnJ,EAAWO,OAAQiB,EAAE4H,KAAMnJ,KAAK8I,0BACtD/I,EAAWO,OAASN,KAAKiJ,gBAC7BjJ,KAAKC,IAAKD,KAAO,qCAAsCD,EAAYC,KAAK2B,OAGxE3B,KAAKoJ,cAAerJ,EAAWsJ,OAC/BrJ,KAAKsJ,aAAcvJ,EAAWwJ,MAC9BvJ,KAAKwJ,cAGTJ,cAAgB,SAAUC,GAEtB,MADArJ,MAAKqJ,MAAQA,MACNrJ,KAAKqJ,OAGhBC,aAAe,SAAUC,GAErB,MADAvJ,MAAKuJ,KAAOA,MACLvJ,KAAKuJ,MAGhBC,WAAa,WACTxJ,KAAKyJ,IAAM,GAAIjL,IACXkL,gBAAsB1J,KAAK2B,MAAMC,SAAS+H,SAC1CN,MAAsBrJ,KAAKqJ,MAC3BE,KAAsBvJ,KAAKuJ,KAC3BK,oBAAsB,EACtBC,oBAAsB,IAE1B7J,KAAKmB,MAAOnB,KAAO,QAASA,KAAKyJ,KACjCzJ,KAAK8J,qBAGTA,kBAAoB,WAChB9J,KAAKC,IAAKD,KAAO,qBACjB,IAAI+J,GAAY/J,IAKhB,OAHA+J,GAAUC,eAAiBD,EAAUN,IAAIQ,0BAA0BzI,IAAK,SAAU0I,GAC9E,MAAOH,GAAUI,iBAAkBD,KAEhCH,EAAUC,gBAGrBG,iBAAmB,SAAUjK,GAGzB,MAFAF,MAAKC,IAAKD,KAAO,qBAAsBE,GAEhC,IAAIkK,EADUpK,KAAK8I,wBAAyB9I,KAAKM,UAEhDqB,MAAc3B,KAAK2B,MACnBzB,UAAcA,KAI1BoE,OAAS,SAAUtB,GACfhD,KAAKC,IAAKD,KAAO,WAAYgD,EAC7B,IAAI+G,GAAY/J,IAUhB,OARA+J,GAAUxF,IAAI+B,SAAU,SAAU9B,MAC9B,+BACA,kCACFC,KAAM,KAERsF,EAAUC,eAAetG,QAAS,SAAUxD,GACxCA,EAAUoE,SAASC,IAAII,SAAUoF,EAAUM,iBAExCN,GAGXM,YAAc,WACV,MAAOrK,MAAK4E,EAAG,gBAGnB0F,aAAe,SAAUhK,GACrB,KAAOA,IAAUN,MAAK8I,yBAClB,KAAM,IAAIyB,OAAOvK,KAAO,qBAAuBM,EAInD,OAFAN,MAAKM,OAASA,EACdN,KAAK8J,oBACE9J,KAAKsE,UAGhBoE,SAAW,WACP,MAAO,wBAA0B1I,KAAK2B,MAAMM,GAAK","file":"../../../scripts/mvc/history/history-structure-view.js","sourcesContent":["define([\n    'mvc/history/job-dag',\n    'mvc/job/job-model',\n    'mvc/job/job-li',\n    'mvc/dataset/dataset-li',\n    'mvc/base-mvc',\n    'utils/localization',\n    'libs/d3'\n], function( JobDAG, JOB, JOB_LI, DATASET_LI, BASE_MVC, _l ){\n\n'use strict';\n\nvar logNamespace = 'history';\n// ============================================================================\n/*\nTODO:\n    disruptive:\n        handle collections\n        retain contents to job relationships (out/input name)\n\n    display when *only* copied datasets\n        need to change when/how joblessVertices are created\n\n    components should be full height containers that scroll individually\n\n    use history contents views for job outputCollection, not vanilla datasets\n         need hid\n\n    show datasets when job not expanded\n        make them external to the job display\n    connect jobs by dataset\n        which datasets from job X are which inputs in job Y?\n\n    make job data human readable (needs tool data)\n        show only tool.inputs with labels (w/ job.params as values)\n        input datasets are special\n            they don't appear in job.params\n            have to connect to datasets in the dag\n                connect job.inputs to any tool.inputs by tool.input.name (in params)\n\nAPI: seems like this could be handled there - duplicating the input data in the proper param space\n\n    collections\n\n    use cases:\n        operations by thread:\n            copy to new history\n            rerun\n            to workflow\n        operations by branch (all descendants):\n            copy to new history\n            rerun\n            to workflow\n        signal to noise:\n            collapse/expand branch\n            hide jobs\n            visually isolate branch (hide other jobs) of thread\n            zoom (somehow)\n\n            layout changes:\n                move branch to new column in component\n                    complicated\n                pyramid\n                circular\n                    sources on inner radius\n            expansion in vertical:\n                obscures relations due to height\n                    could move details to side panel\n                difficult to compare two+ jobs/datasets when at different points in the topo\n\n    (other) controls:\n        (optionally) filter all deleted\n        (optionally) filter all hidden\n        //(optionally) filter __SET_METADATA__\n        //(optionally) filter error'd jobs\n        help and explanation\n        filtering/searching of jobs\n\n    challenges:\n        difficult to scale dom (for zoomout)\n            possible to use css transforms?\n                transform svg and dom elements\n                it is possible to use css transforms on svg nodes\n                use transform-origin to select origin to top left\n        on larger histories the svg section may become extremely large due to distance from output to input\n\n    how-to:\n        descendant ids: _.keys( component.depth/breadthFirstSearchTree( start ).vertices )\n\n    in-panel view of anc desc\n\n\n*/\n// ============================================================================\n/**\n *\n */\nwindow.JobDAG = JobDAG;\nvar HistoryStructureComponent = Backbone.View.extend( BASE_MVC.LoggableMixin ).extend({\n    _logNamespace : logNamespace,\n\n    className : 'history-structure-component',\n\n    _INITIAL_ZOOM_LEVEL     : 1.0,\n    _MIN_ZOOM_LEVEL         : 0.25,\n    _LINK_ID_SEP            : '-to-',\n    _VERTEX_NAME_DATA_KEY   : 'vertex-name',\n\n    JobItemClass        : JOB_LI.JobListItemView,\n    ContentItemClass    : DATASET_LI.DatasetListItemView,\n\n    initialize : function( attributes ){\n        this.log( this + '(HistoryStructureComponent).initialize:', attributes );\n        this.component = attributes.component;\n\n        this._liMap = {};\n        this._createVertexItems();\n\n        this.zoomLevel = attributes.zoomLevel || this._INITIAL_ZOOM_LEVEL;\n\n        this.layout = this._createLayout( attributes.layoutOptions );\n    },\n\n    _createVertexItems : function(){\n        var view = this;\n        view.component.eachVertex( function( vertex ){\n//TODO: hack\n            var type = vertex.data.job? 'job' : 'copy',\n                li;\n            if( type === 'job' ){\n                li = view._createJobListItem( vertex );\n            } else if( type === 'copy' ){\n                li = view._createContentListItem( vertex );\n            }\n            view._liMap[ vertex.name ] = li;\n        });\n        view.debug( '_liMap:', view._liMap );\n    },\n\n    _createJobListItem : function( vertex ){\n        this.debug( '_createJobListItem:', vertex );\n        var view = this,\n            jobData = vertex.data,\n            job = new JOB.Job( jobData.job );\n\n        // get the models of the outputs for this job from the history\n        var outputModels = _.map( job.get( 'outputs' ), function( output ){\n            //note: output is { src: 'hda/dataset_collection', id: <some id> }\n            // job output doesn't *quite* match up to normal typeId\n            return view.model.contents.get( output.type_id );\n        });\n        // set the collection (HistoryContents) for the job to that json (setting historyId for proper ajax urls)\n        job.outputCollection.reset( outputModels );\n        job.outputCollection.historyId = view.model.id;\n        //this.debug( job.outputCollection );\n\n        // create the bbone view for the job (to be positioned later accrd. to the layout) and cache\n        var li = new view.JobItemClass({ model: job, tool: jobData.tool, jobData: jobData });\n        view.listenTo( li, 'expanding expanded collapsing collapsed', view.renderGraph );\n        view.listenTo( li.foldout, 'view:expanding view:expanded view:collapsing view:collapsed', view.renderGraph );\n        return li;\n    },\n\n    _createContentListItem : function( vertex ){\n        this.debug( '_createContentListItem:', vertex );\n        var view = this;\n        var content = vertex.data;\n        content = view.model.contents.get( content.type_id );\n        var li = new view.ContentItemClass({ model: content });\n        view.listenTo( li, 'expanding expanded collapsing collapsed', view.renderGraph );\n        return li;\n    },\n\n    layoutDefaults : {\n        linkSpacing     : 16,\n        linkWidth       : 0,\n        linkHeight      : 0,\n        jobWidth        : 300,\n        jobHeight       : 300,\n        jobSpacing      : 12,\n        linkAdjX        : 4,\n        linkAdjY        : 0\n    },\n\n    _createLayout : function( options ){\n        options = _.defaults( _.clone( options || {} ), this.layoutDefaults );\n        var view = this,\n            vertices = _.values( view.component.vertices ),\n            layout = _.extend( options, {\n                nodeMap         : {},\n                links           : [],\n                svg             : { width: 0, height: 0 }\n            });\n\n        vertices.forEach( function( v, j ){\n            var node = { name: v.name, x: 0, y: 0 };\n            layout.nodeMap[ v.name ] = node;\n        });\n\n        view.component.edges( function( e ){\n            var link = {\n                    source: e.source,\n                    target: e.target\n                };\n            layout.links.push( link );\n        });\n        //this.debug( JSON.stringify( layout, null, '  ' ) );\n        return layout;\n    },\n\n    render : function( options ){\n        this.debug( this + '.render:', options );\n        var view = this;\n        view.$el.html([\n            '<header></header>',\n            '<nav class=\"controls\"></nav>',\n            '<figure class=\"graph\"></figure>',\n            '<footer></footer>'\n        ].join( '' ) );\n\n        var $graph = view.$graph();\n        view.component.eachVertex( function( vertex ){\n            view._liMap[ vertex.name ].render( 0 ).$el.appendTo( $graph )\n                // store the name in the DOM and cache by that name\n                .data( view._VERTEX_NAME_DATA_KEY, vertex.name );\n        });\n        view.renderGraph();\n        return this;\n    },\n\n    $graph : function(){\n        return this.$( '.graph' );\n    },\n\n    renderGraph : function( options ){\n        this.debug( this + '.renderGraph:', options );\n        var view = this;\n\n        function _render(){\n\n            view._updateLayout();\n            // set up the display containers\n            view.$graph()\n                // use css3 transform to scale component graph\n                .css( 'transform', [ 'scale(', view.zoomLevel, ',', view.zoomLevel, ')' ].join( '' ) )\n                .width( view.layout.svg.width )\n                .height( view.layout.svg.height );\n            view.renderSVG();\n\n            // position the job views accrd. to the layout\n            view.component.eachVertex( function( v ){\n//TODO:?? liMap needed - can't we attach to vertex?\n                var li = view._liMap[ v.name ],\n                    position = view.layout.nodeMap[ v.name ];\n                //this.debug( position );\n                li.$el.css({ top: position.y, left: position.x });\n            });\n        }\n//TODO: hack - li's invisible in updateLayout without this delay\n        if( !this.$el.is( ':visible' ) ){\n            _.delay( _render, 0 );\n        } else {\n            _render();\n        }\n        return this;\n    },\n\n    _updateLayout : function(){\n        this.debug( this + '._updateLayout:' );\n        var view = this,\n            layout = view.layout;\n\n        layout.linkHeight = layout.linkSpacing * _.size( layout.nodeMap );\n        layout.svg.height = layout.linkHeight + layout.jobHeight;\n\n        // reset for later max comparison\n        layout.svg.width = 0;\n\n//TODO:?? can't we just alter the component v and e's directly?\n        // layout the job views putting jobSpacing btwn each\n        var x = 0,\n            y = layout.linkHeight;\n        _.each( layout.nodeMap, function( node, jobId ){\n            //this.debug( node, jobId );\n            node.x = x;\n            node.y = y;\n            x += layout.jobWidth + layout.jobSpacing;\n        });\n        layout.svg.width = layout.linkWidth = Math.max( layout.svg.width, x );\n\n        // layout the links - connecting each job by it's main coords (currently)\n//TODO: somehow adjust the svg height based on the largest distance the longest connection needs\n        layout.links.forEach( function( link ){\n            var source = layout.nodeMap[ link.source ],\n                target = layout.nodeMap[ link.target ];\n            link.x1 = source.x + layout.linkAdjX;\n            link.y1 = source.y + layout.linkAdjY;\n            link.x2 = target.x + layout.linkAdjX;\n            link.y2 = target.y + layout.linkAdjY;\n        });\n\n        this.debug( JSON.stringify( layout, null, '  ' ) );\n        return this.layout;\n    },\n\n    renderSVG : function(){\n        this.debug( this + '.renderSVG:' );\n        var view = this,\n            layout = view.layout;\n\n        var svg = d3.select( this.$graph().get(0) ).select( 'svg' );\n        if( svg.empty() ){\n            svg = d3.select( this.$graph().get(0) ).append( 'svg' );\n        }\n\n        svg\n            .attr( 'width', layout.svg.width )\n            .attr( 'height', layout.svg.height );\n\n        function highlightConnect( d ){\n            d3.select( this ).classed( 'highlighted', true );\n            view._liMap[ d.source ].$el.addClass( 'highlighted' );\n            view._liMap[ d.target ].$el.addClass( 'highlighted' );\n        }\n\n        function unhighlightConnect( d ){\n            d3.select( this ).classed( 'highlighted', false );\n            view._liMap[ d.source ].$el.removeClass( 'highlighted' );\n            view._liMap[ d.target ].$el.removeClass( 'highlighted' );\n        }\n\n        var connections = svg.selectAll( '.connection' )\n                .data( layout.links );\n\n        connections\n            .enter().append( 'path' )\n                .attr( 'class', 'connection' )\n                .attr( 'id', function( d ){ return [ d.source, d.target ].join( view._LINK_ID_SEP ); })\n                .on( 'mouseover', highlightConnect )\n                .on( 'mouseout', unhighlightConnect );\n\n        connections\n                .attr( 'd', function( d ){ return view._connectionPath( d ); });\n\n        return svg.node();\n    },\n\n    _connectionPath : function( d ){\n        var CURVE_X = 0,\n            controlY = ( ( d.x2 - d.x1 ) / this.layout.svg.width ) * this.layout.linkHeight;\n        return [\n            'M', d.x1, ',', d.y1, ' ',\n            'C',\n                d.x1 + CURVE_X, ',', d.y1 - controlY, ' ',\n                d.x2 - CURVE_X, ',', d.y2 - controlY, ' ',\n            d.x2, ',', d.y2\n        ].join( '' );\n    },\n\n    events : {\n        'mouseover .graph > .list-item'  : function( ev ){ this.highlightConnected( ev.currentTarget, true ); },\n        'mouseout  .graph > .list-item'  : function( ev ){ this.highlightConnected( ev.currentTarget, false ); }\n    },\n\n    highlightConnected : function( jobElement, highlight ){\n        this.debug( 'highlightConnected', jobElement, highlight );\n        highlight = highlight !== undefined? highlight : true;\n\n        var view = this,\n            component = view.component,\n            jobClassFn = highlight? jQuery.prototype.addClass : jQuery.prototype.removeClass,\n            connectionClass = highlight? 'connection highlighted' : 'connection';\n\n        //console.debug( 'mouseover', this );\n        var $hoverTarget = jobClassFn.call( $( jobElement ), 'highlighted' ),\n            id = $hoverTarget.data( view._VERTEX_NAME_DATA_KEY );\n\n        // immed. ancestors\n        component.edges({ target: id }).forEach( function( edge ){\n            var ancestorId = edge.source,\n                ancestorLi = view._liMap[ ancestorId ];\n            //view.debug( '\\t ancestor:', ancestorId, ancestorLi );\n            jobClassFn.call( ancestorLi.$el, 'highlighted' );\n            view.$( '#' + ancestorId + view._LINK_ID_SEP + id ).attr( 'class', connectionClass );\n        });\n        // descendants\n        component.vertices[ id ].eachEdge( function( edge ){\n            var descendantId = edge.target,\n                descendantLi = view._liMap[ descendantId ];\n            //view.debug( '\\t descendant:', descendantId, descendantLi );\n            jobClassFn.call( descendantLi.$el, 'highlighted' );\n            view.$( '#' + id + view._LINK_ID_SEP + descendantId ).attr( 'class', connectionClass );\n        });\n    },\n\n    zoom : function( level ){\n        this.zoomLevel = Math.min( 1.0, Math.max( this._MIN_ZOOM_LEVEL, level ) );\n        return this.renderGraph();\n    },\n\n    toString : function(){\n        return 'HistoryStructureComponent(' + this.model.id + ')';\n    }\n});\n\n\n// ============================================================================\n/**\n *\n */\nvar VerticalHistoryStructureComponent = HistoryStructureComponent.extend({\n\n    //logger : console,\n\n    className : HistoryStructureComponent.prototype.className + ' vertical',\n\n    layoutDefaults : _.extend( _.clone( HistoryStructureComponent.prototype.layoutDefaults ), {\n        linkAdjX        : 0,\n        linkAdjY        : 4\n    }),\n\n//TODO: how can we use the dom height of the job li's - they're not visible when this is called?\n    _updateLayout : function(){\n        this.debug( this + '._updateLayout:' );\n        var view = this,\n            layout = view.layout;\n        //this.info( this.cid, '_updateLayout' )\n\n        layout.linkWidth = layout.linkSpacing * _.size( layout.nodeMap );\n        layout.svg.width = layout.linkWidth + layout.jobWidth;\n\n        // reset height - we'll get the max Y below to assign to it\n        layout.svg.height = 0;\n\n        //TODO:?? can't we just alter the component v and e's directly?\n        var x = layout.linkWidth,\n            y = 0;\n        _.each( layout.nodeMap, function( node, nodeId ){\n            node.x = x;\n            node.y = y;\n            var li = view._liMap[ nodeId ];\n            y += li.$el.height() + layout.jobSpacing;\n        });\n        layout.linkHeight = layout.svg.height = Math.max( layout.svg.height, y );\n\n        // layout the links - connecting each job by it's main coords (currently)\n        layout.links.forEach( function( link ){\n            var source = layout.nodeMap[ link.source ],\n                target = layout.nodeMap[ link.target ];\n            link.x1 = source.x + layout.linkAdjX;\n            link.y1 = source.y + layout.linkAdjY;\n            link.x2 = target.x + layout.linkAdjX;\n            link.y2 = target.y + layout.linkAdjY;\n            //view.debug( 'link:', link.x1, link.y1, link.x2, link.y2, link );\n        });\n\n        this.debug( JSON.stringify( layout, null, '  ' ) );\n        return layout;\n    },\n\n    _connectionPath : function( d ){\n        var CURVE_Y = 0,\n            controlX = ( ( d.y2 - d.y1 ) / this.layout.svg.height ) * this.layout.linkWidth;\n        return [\n            'M', d.x1, ',', d.y1, ' ',\n            'C',\n                d.x1 - controlX, ',', d.y1 + CURVE_Y, ' ',\n                d.x2 - controlX, ',', d.y2 - CURVE_Y, ' ',\n            d.x2, ',', d.y2\n        ].join( '' );\n    },\n\n    toString : function(){\n        return 'VerticalHistoryStructureComponent(' + this.model.id + ')';\n    }\n});\n\n\n// ============================================================================\n/**\n *\n */\nvar HistoryStructureView = Backbone.View.extend( BASE_MVC.LoggableMixin ).extend({\n    _logNamespace : logNamespace,\n\n    className : 'history-structure',\n\n    _layoutToComponentClass : {\n        'horizontal'    : HistoryStructureComponent,\n        'vertical'      : VerticalHistoryStructureComponent\n    },\n    //_DEFAULT_LAYOUT : 'horizontal',\n    _DEFAULT_LAYOUT : 'vertical',\n\n    initialize : function( attributes ){\n        this.layout = _.contains( attributes.layout, _.keys( this._layoutToComponentClass ) )?\n            attributes.layout : this._DEFAULT_LAYOUT;\n        this.log( this + '(HistoryStructureView).initialize:', attributes, this.model );\n        //TODO:?? to model - maybe glom jobs onto model in order to persist\n        // cache jobs since we need to re-create the DAG if settings change\n        this._processTools( attributes.tools );\n        this._processJobs( attributes.jobs );\n        this._createDAG();\n    },\n\n    _processTools : function( tools ){\n        this.tools = tools || {};\n        return this.tools;\n    },\n\n    _processJobs : function( jobs ){\n        this.jobs = jobs || [];\n        return this.jobs;\n    },\n\n    _createDAG : function(){\n        this.dag = new JobDAG({\n            historyContents     : this.model.contents.toJSON(),\n            tools               : this.tools,\n            jobs                : this.jobs,\n            excludeSetMetadata  : true,\n            excludeErroredJobs  : true\n        });\n        this.debug( this + '.dag:', this.dag );\n        this._createComponents();\n    },\n\n    _createComponents : function(){\n        this.log( this + '._createComponents' );\n        var structure = this;\n\n        structure.componentViews = structure.dag.weakComponentGraphArray().map( function( componentGraph ){\n            return structure._createComponent( componentGraph );\n        });\n        return structure.componentViews;\n    },\n\n    _createComponent : function( component ){\n        this.log( this + '._createComponent:', component );\n        var ComponentClass = this._layoutToComponentClass[ this.layout ];\n        return new ComponentClass({\n                model       : this.model,\n                component   : component\n            });\n    },\n\n    render : function( options ){\n        this.log( this + '.render:', options );\n        var structure = this;\n\n        structure.$el.addClass( 'clear' ).html([\n            '<div class=\"controls\"></div>',\n            '<div class=\"components\"></div>'\n        ].join( '' ));\n\n        structure.componentViews.forEach( function( component ){\n            component.render().$el.appendTo( structure.$components() );\n        });\n        return structure;\n    },\n\n    $components : function(){\n        return this.$( '.components' );\n    },\n\n    changeLayout : function( layout ){\n        if( !( layout in this._layoutToComponentClass ) ){\n            throw new Error( this + ': unknown layout: ' + layout );\n        }\n        this.layout = layout;\n        this._createComponents();\n        return this.render();\n    },\n\n    toString : function(){\n        return 'HistoryStructureView(' + this.model.id + ')';\n    }\n});\n\n\n// ============================================================================\n    return HistoryStructureView;\n});\n"]}