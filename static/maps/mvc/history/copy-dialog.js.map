{"version":3,"sources":["mvc/history/copy-dialog.js"],"names":["CopyDialog","defaultName","_","template","title","_localization2","default","submitLabel","errorMessage","progressive","activeLabel","allLabel","anonWarning","_template","_showAjaxIndicator","dialog","options","defaultCopyNameFn","name","join","indicator","autoClose","this","modal","$","empty","append","css","margin-top","history","copyWhat","val","copyAllDatasets","height","closing_events","closing_callback","deferred","reject","done","response","originalClosingCallback","fail","xhr","status","message","_errorModal2","ajaxErrorModal","keyCode","preventDefault","checkNameAndCopy","rejectWith","arguments","hide","Deferred","nameFn","get","defaultCopyWhat","allDatasets","allowAll","isUndefined","show","ImportDialog","defaultCopyName","isAnon","Galaxy","user","isAnonymous","buttons","object","cancelled","focus","select","on","ev","extend","window","parent","_uiModal2","View","useImport"],"mappings":"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","file":"../../../scripts/mvc/history/copy-dialog.js","sourcesContent":["import MODAL from \"mvc/ui/ui-modal\";\nimport ERROR_MODAL from \"mvc/ui/error-modal\";\nimport _l from \"utils/localization\";\n\n//==============================================================================\n/**\n * A dialog/modal that allows copying a user history or 'importing' from user\n * another. Generally called via historyCopyDialog below.\n * @type {Object}\n */\nvar CopyDialog = {\n    // language related strings/fns\n    defaultName: _.template(\"Copy of '<%- name %>'\"),\n    title: _.template(`${_l(\"Copying history\")} \"<%- name %>\"`),\n    submitLabel: _l(\"Copy\"),\n    errorMessage: _l(\"History could not be copied.\"),\n    progressive: _l(\"Copying history\"),\n    activeLabel: _l(\"Copy only the active, non-deleted datasets\"),\n    allLabel: _l(\"Copy all datasets including deleted ones\"),\n    anonWarning:\n        _l(\n            \"As an anonymous user, unless you login or register, you will lose your current history \"\n        ) + _l(\"after copying this history. \"),\n\n    // template for modal body\n    _template: _.template(\n        [\n            //TODO: remove inline styles\n            // show a warning message for losing current to anon users\n            \"<% if( isAnon ){ %>\",\n            '<div class=\"warningmessage\">',\n            \"<%- anonWarning %>\",\n            _l(\"You can\"),\n            ' <a href=\"/user/login\">',\n            _l(\"login here\"),\n            \"</a> \",\n            _l(\"or\"),\n            \" \",\n            ' <a href=\"/user/create\">',\n            _l(\"register here\"),\n            \"</a>.\",\n            \"</div>\",\n            \"<% } %>\",\n            \"<form>\",\n            '<label for=\"copy-modal-title\">',\n            _l(\"Enter a title for the new history\"),\n            \":\",\n            \"</label><br />\",\n            // TODO: could use required here and the form validators\n            // NOTE: use unescaped here if escaped in the modal function below\n            '<input id=\"copy-modal-title\" class=\"form-control\" style=\"width: 100%\" value=\"<%= name %>\" />',\n            '<p class=\"invalid-title bg-danger\" style=\"color: red; margin: 8px 0px 8px 0px; display: none\">',\n            _l(\"Please enter a valid history title\"),\n            \"</p>\",\n            // if allowAll, add the option to copy deleted datasets, too\n            \"<% if( allowAll ){ %>\",\n            \"<br />\",\n            \"<p>\",\n            _l(\"Choose which datasets from the original history to include:\"),\n            \"</p>\",\n            // copy non-deleted is the default\n            '<input name=\"copy-what\" type=\"radio\" id=\"copy-non-deleted\" value=\"copy-non-deleted\" ',\n            '<% if( copyWhat === \"copy-non-deleted\" ){ print( \"checked\" ); } %>/>',\n            '<label for=\"copy-non-deleted\"> <%- activeLabel %></label>',\n            \"<br />\",\n            '<input name=\"copy-what\" type=\"radio\" id=\"copy-all\" value=\"copy-all\" ',\n            '<% if( copyWhat === \"copy-all\" ){ print( \"checked\" ); } %>/>',\n            '<label for=\"copy-all\"> <%- allLabel %></label>',\n            \"<% } %>\",\n            \"</form>\"\n        ].join(\"\")\n    ),\n\n    // empty modal body and let the user know the copy is happening\n    _showAjaxIndicator: function _showAjaxIndicator() {\n        var indicator = `<p><span class=\"fa fa-spinner fa-spin\"></span> ${this\n            .progressive}...</p>`;\n        this.modal\n            .$(\".modal-body\")\n            .empty()\n            .append(indicator)\n            .css({ \"margin-top\": \"8px\" });\n    },\n\n    // (sorta) public interface - display the modal, render the form, and potentially copy the history\n    // returns a jQuery.Deferred done->history copied, fail->user cancelled\n    dialog: function _dialog(modal, history, options) {\n        options = options || {};\n\n        var dialog = this;\n        var deferred = jQuery.Deferred();\n\n        var // TODO: getting a little byzantine here\n        defaultCopyNameFn = options.nameFn || this.defaultName;\n\n        var defaultCopyName = defaultCopyNameFn({\n            name: history.get(\"name\")\n        });\n\n        var // TODO: these two might be simpler as one 3 state option (all,active,no-choice)\n        defaultCopyWhat = options.allDatasets ? \"copy-all\" : \"copy-non-deleted\";\n\n        var allowAll = !_.isUndefined(options.allowAll)\n            ? options.allowAll\n            : true;\n\n        var autoClose = !_.isUndefined(options.autoClose)\n            ? options.autoClose\n            : true;\n\n        this.modal = modal;\n\n        // validate the name and copy if good\n        function checkNameAndCopy() {\n            var name = modal.$(\"#copy-modal-title\").val();\n            if (!name) {\n                modal.$(\".invalid-title\").show();\n                return;\n            }\n            // get further settings, shut down and indicate the ajax call, then hide and resolve/reject\n            var copyAllDatasets =\n                modal.$('input[name=\"copy-what\"]:checked').val() === \"copy-all\";\n            modal.$(\"button\").prop(\"disabled\", true);\n            dialog._showAjaxIndicator();\n            history\n                .copy(true, name, copyAllDatasets)\n                .done(response => {\n                    deferred.resolve(response);\n                })\n                .fail(function(xhr, status, message) {\n                    var options = {\n                        name: name,\n                        copyAllDatasets: copyAllDatasets\n                    };\n                    ERROR_MODAL.ajaxErrorModal(\n                        history,\n                        xhr,\n                        options,\n                        dialog.errorMessage\n                    );\n                    deferred.rejectWith(deferred, arguments);\n                })\n                .done(() => {\n                    if (autoClose) {\n                        modal.hide();\n                    }\n                });\n        }\n\n        var originalClosingCallback = options.closing_callback;\n        modal.show(\n            _.extend(options, {\n                title: this.title({ name: history.get(\"name\") }),\n                body: $(\n                    dialog._template({\n                        name: defaultCopyName,\n                        isAnon: Galaxy.user.isAnonymous(),\n                        allowAll: allowAll,\n                        copyWhat: defaultCopyWhat,\n                        activeLabel: this.activeLabel,\n                        allLabel: this.allLabel,\n                        anonWarning: this.anonWarning\n                    })\n                ),\n                buttons: _.object([\n                    [\n                        _l(\"Cancel\"),\n                        () => {\n                            modal.hide();\n                        }\n                    ],\n                    [this.submitLabel, checkNameAndCopy]\n                ]),\n                height: \"auto\",\n                closing_events: true,\n                closing_callback: function _historyCopyClose(cancelled) {\n                    if (cancelled) {\n                        deferred.reject({ cancelled: true });\n                    }\n                    if (originalClosingCallback) {\n                        originalClosingCallback(cancelled);\n                    }\n                }\n            })\n        );\n\n        // set the default dataset copy, autofocus the title, and set up for a simple return\n        modal\n            .$(\"#copy-modal-title\")\n            .focus()\n            .select();\n        modal.$(\"#copy-modal-title\").on(\"keydown\", ev => {\n            if (ev.keyCode === 13) {\n                ev.preventDefault();\n                checkNameAndCopy();\n            }\n        });\n\n        return deferred;\n    }\n};\n\n//==============================================================================\n// maintain the (slight) distinction between copy and import\n/**\n * Subclass CopyDialog to use the import language.\n */\nvar ImportDialog = _.extend({}, CopyDialog, {\n    defaultName: _.template(\"imported: <%- name %>\"),\n    title: _.template(`${_l(\"Importing history\")} \"<%- name %>\"`),\n    submitLabel: _l(\"Import\"),\n    errorMessage: _l(\"History could not be imported.\"),\n    progressive: _l(\"Importing history\"),\n    activeLabel: _l(\"Import only the active, non-deleted datasets\"),\n    allLabel: _l(\"Import all datasets including deleted ones\"),\n    anonWarning:\n        _l(\n            \"As an anonymous user, unless you login or register, you will lose your current history \"\n        ) + _l(\"after importing this history. \")\n});\n\n//==============================================================================\n/**\n * Main interface for both history import and history copy dialogs.\n * @param  {Backbone.Model} history     the history to copy\n * @param  {Object}         options     a hash\n * @return {jQuery.Deferred}            promise that fails on close and succeeds on copy\n *\n * options:\n *     (this object is also passed to the modal used to display the dialog and accepts modal options)\n *     {Function} nameFn    if defined, use this to build the default name shown to the user\n *                          (the fn is passed: {name: <original history's name>})\n *     {bool} useImport     if true, use the 'import' language (instead of Copy)\n *     {bool} allowAll      if true, allow the user to choose between copying all datasets and\n *                          only non-deleted datasets\n *     {String} allDatasets default initial checked radio button: 'copy-all' or 'copy-non-deleted',\n */\nvar historyCopyDialog = (history, options) => {\n    options = options || {};\n    // create our own modal if Galaxy doesn't have one (mako tab without use_panels)\n    var modal = window.parent.Galaxy.modal || new MODAL.View({});\n    return options.useImport\n        ? ImportDialog.dialog(modal, history, options)\n        : CopyDialog.dialog(modal, history, options);\n};\n\n//==============================================================================\nexport default historyCopyDialog;\n"]}