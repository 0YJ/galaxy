{"version":3,"sources":["mvc/history/copy-dialog.js"],"names":["_uiModal","require","_errorModal","_localization","CopyDialog","defaultName","_","template","title","_localization2","default","submitLabel","errorMessage","progressive","activeLabel","allLabel","anonWarning","_template","_showAjaxIndicator","indicator","options","dialog","deferred","defaultCopyNameFn","defaultCopyName","name","join","this","modal","$","append","css","margin-top","history","copyAllDatasets","val","height","closing_events","closing_callback","prop","_historyCopyClose","copy","done","originalClosingCallback","fail","xhr","status","message","_errorModal2","ajaxErrorModal","keyCode","preventDefault","checkNameAndCopy","rejectWith","arguments","autoClose","hide","show","Deferred","nameFn","allDatasets","allowAll","isUndefined","extend","isAnon","ImportDialog","get","Galaxy","user","isAnonymous","copyWhat","defaultCopyWhat","buttons","object","cancelled","historyCopyDialog","parent","focus","select","on","ev","window","_uiModal2","View","useImport"],"mappings":"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","file":"../../../scripts/mvc/history/copy-dialog.js","sourcesContent":["import MODAL from \"mvc/ui/ui-modal\";\nimport ERROR_MODAL from \"mvc/ui/error-modal\";\nimport _l from \"utils/localization\";\n\n//==============================================================================\n/**\n * A dialog/modal that allows copying a user history or 'importing' from user\n * another. Generally called via historyCopyDialog below.\n * @type {Object}\n */\nvar CopyDialog = {\n    // language related strings/fns\n    defaultName: _.template(\"Copy of '<%- name %>'\"),\n    title: _.template(_l(\"Copying history\") + ' \"<%- name %>\"'),\n    submitLabel: _l(\"Copy\"),\n    errorMessage: _l(\"History could not be copied.\"),\n    progressive: _l(\"Copying history\"),\n    activeLabel: _l(\"Copy only the active, non-deleted datasets\"),\n    allLabel: _l(\"Copy all datasets including deleted ones\"),\n    anonWarning:\n        _l(\n            \"As an anonymous user, unless you login or register, you will lose your current history \"\n        ) + _l(\"after copying this history. \"),\n\n    // template for modal body\n    _template: _.template(\n        [\n            //TODO: remove inline styles\n            // show a warning message for losing current to anon users\n            \"<% if( isAnon ){ %>\",\n            '<div class=\"warningmessage\">',\n            \"<%- anonWarning %>\",\n            _l(\"You can\"),\n            ' <a href=\"/user/login\">',\n            _l(\"login here\"),\n            \"</a> \",\n            _l(\"or\"),\n            \" \",\n            ' <a href=\"/user/create\">',\n            _l(\"register here\"),\n            \"</a>.\",\n            \"</div>\",\n            \"<% } %>\",\n            \"<form>\",\n            '<label for=\"copy-modal-title\">',\n            _l(\"Enter a title for the new history\"),\n            \":\",\n            \"</label><br />\",\n            // TODO: could use required here and the form validators\n            // NOTE: use unescaped here if escaped in the modal function below\n            '<input id=\"copy-modal-title\" class=\"form-control\" style=\"width: 100%\" value=\"<%= name %>\" />',\n            '<p class=\"invalid-title bg-danger\" style=\"color: red; margin: 8px 0px 8px 0px; display: none\">',\n            _l(\"Please enter a valid history title\"),\n            \"</p>\",\n            // if allowAll, add the option to copy deleted datasets, too\n            \"<% if( allowAll ){ %>\",\n            \"<br />\",\n            \"<p>\",\n            _l(\"Choose which datasets from the original history to include:\"),\n            \"</p>\",\n            // copy non-deleted is the default\n            '<input name=\"copy-what\" type=\"radio\" id=\"copy-non-deleted\" value=\"copy-non-deleted\" ',\n            '<% if( copyWhat === \"copy-non-deleted\" ){ print( \"checked\" ); } %>/>',\n            '<label for=\"copy-non-deleted\"> <%- activeLabel %></label>',\n            \"<br />\",\n            '<input name=\"copy-what\" type=\"radio\" id=\"copy-all\" value=\"copy-all\" ',\n            '<% if( copyWhat === \"copy-all\" ){ print( \"checked\" ); } %>/>',\n            '<label for=\"copy-all\"> <%- allLabel %></label>',\n            \"<% } %>\",\n            \"</form>\"\n        ].join(\"\")\n    ),\n\n    // empty modal body and let the user know the copy is happening\n    _showAjaxIndicator: function _showAjaxIndicator() {\n        var indicator =\n            '<p><span class=\"fa fa-spinner fa-spin\"></span> ' +\n            this.progressive +\n            \"...</p>\";\n        this.modal\n            .$(\".modal-body\")\n            .empty()\n            .append(indicator)\n            .css({ \"margin-top\": \"8px\" });\n    },\n\n    // (sorta) public interface - display the modal, render the form, and potentially copy the history\n    // returns a jQuery.Deferred done->history copied, fail->user cancelled\n    dialog: function _dialog(modal, history, options) {\n        options = options || {};\n\n        var dialog = this,\n            deferred = jQuery.Deferred(),\n            // TODO: getting a little byzantine here\n            defaultCopyNameFn = options.nameFn || this.defaultName,\n            defaultCopyName = defaultCopyNameFn({\n                name: history.get(\"name\")\n            }),\n            // TODO: these two might be simpler as one 3 state option (all,active,no-choice)\n            defaultCopyWhat = options.allDatasets\n                ? \"copy-all\"\n                : \"copy-non-deleted\",\n            allowAll = !_.isUndefined(options.allowAll)\n                ? options.allowAll\n                : true,\n            autoClose = !_.isUndefined(options.autoClose)\n                ? options.autoClose\n                : true;\n\n        this.modal = modal;\n\n        // validate the name and copy if good\n        function checkNameAndCopy() {\n            var name = modal.$(\"#copy-modal-title\").val();\n            if (!name) {\n                modal.$(\".invalid-title\").show();\n                return;\n            }\n            // get further settings, shut down and indicate the ajax call, then hide and resolve/reject\n            var copyAllDatasets =\n                modal.$('input[name=\"copy-what\"]:checked').val() === \"copy-all\";\n            modal.$(\"button\").prop(\"disabled\", true);\n            dialog._showAjaxIndicator();\n            history\n                .copy(true, name, copyAllDatasets)\n                .done(function(response) {\n                    deferred.resolve(response);\n                })\n                .fail(function(xhr, status, message) {\n                    var options = {\n                        name: name,\n                        copyAllDatasets: copyAllDatasets\n                    };\n                    ERROR_MODAL.ajaxErrorModal(\n                        history,\n                        xhr,\n                        options,\n                        dialog.errorMessage\n                    );\n                    deferred.rejectWith(deferred, arguments);\n                })\n                .done(function() {\n                    if (autoClose) {\n                        modal.hide();\n                    }\n                });\n        }\n\n        var originalClosingCallback = options.closing_callback;\n        modal.show(\n            _.extend(options, {\n                title: this.title({ name: history.get(\"name\") }),\n                body: $(\n                    dialog._template({\n                        name: defaultCopyName,\n                        isAnon: Galaxy.user.isAnonymous(),\n                        allowAll: allowAll,\n                        copyWhat: defaultCopyWhat,\n                        activeLabel: this.activeLabel,\n                        allLabel: this.allLabel,\n                        anonWarning: this.anonWarning\n                    })\n                ),\n                buttons: _.object([\n                    [\n                        _l(\"Cancel\"),\n                        function() {\n                            modal.hide();\n                        }\n                    ],\n                    [this.submitLabel, checkNameAndCopy]\n                ]),\n                height: \"auto\",\n                closing_events: true,\n                closing_callback: function _historyCopyClose(cancelled) {\n                    if (cancelled) {\n                        deferred.reject({ cancelled: true });\n                    }\n                    if (originalClosingCallback) {\n                        originalClosingCallback(cancelled);\n                    }\n                }\n            })\n        );\n\n        // set the default dataset copy, autofocus the title, and set up for a simple return\n        modal\n            .$(\"#copy-modal-title\")\n            .focus()\n            .select();\n        modal.$(\"#copy-modal-title\").on(\"keydown\", function(ev) {\n            if (ev.keyCode === 13) {\n                ev.preventDefault();\n                checkNameAndCopy();\n            }\n        });\n\n        return deferred;\n    }\n};\n\n//==============================================================================\n// maintain the (slight) distinction between copy and import\n/**\n * Subclass CopyDialog to use the import language.\n */\nvar ImportDialog = _.extend({}, CopyDialog, {\n    defaultName: _.template(\"imported: <%- name %>\"),\n    title: _.template(_l(\"Importing history\") + ' \"<%- name %>\"'),\n    submitLabel: _l(\"Import\"),\n    errorMessage: _l(\"History could not be imported.\"),\n    progressive: _l(\"Importing history\"),\n    activeLabel: _l(\"Import only the active, non-deleted datasets\"),\n    allLabel: _l(\"Import all datasets including deleted ones\"),\n    anonWarning:\n        _l(\n            \"As an anonymous user, unless you login or register, you will lose your current history \"\n        ) + _l(\"after importing this history. \")\n});\n\n//==============================================================================\n/**\n * Main interface for both history import and history copy dialogs.\n * @param  {Backbone.Model} history     the history to copy\n * @param  {Object}         options     a hash\n * @return {jQuery.Deferred}            promise that fails on close and succeeds on copy\n *\n * options:\n *     (this object is also passed to the modal used to display the dialog and accepts modal options)\n *     {Function} nameFn    if defined, use this to build the default name shown to the user\n *                          (the fn is passed: {name: <original history's name>})\n *     {bool} useImport     if true, use the 'import' language (instead of Copy)\n *     {bool} allowAll      if true, allow the user to choose between copying all datasets and\n *                          only non-deleted datasets\n *     {String} allDatasets default initial checked radio button: 'copy-all' or 'copy-non-deleted',\n */\nvar historyCopyDialog = function(history, options) {\n    options = options || {};\n    // create our own modal if Galaxy doesn't have one (mako tab without use_panels)\n    var modal = window.parent.Galaxy.modal || new MODAL.View({});\n    return options.useImport\n        ? ImportDialog.dialog(modal, history, options)\n        : CopyDialog.dialog(modal, history, options);\n};\n\n//==============================================================================\nexport default historyCopyDialog;\n"]}