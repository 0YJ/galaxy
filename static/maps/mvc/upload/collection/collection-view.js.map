{"version":3,"sources":["mvc/upload/collection/collection-view.js"],"names":["define","Utils","UploadModel","UploadRow","UploadFtp","UploadExtension","Popover","Select","Ui","LIST_COLLECTION_CREATOR","Backbone","View","extend","upload_size","collection","Collection","counter","announce","success","error","running","this","initialize","app","self","list_extensions","list_genomes","options","ui_button","setElement","_template","id","title","onclick","uploadbox","select","icon","btnFtp","Button","_eventFtp","btnCreate","_eventCreate","btnLocal","_eventStart","_eventBuild","btnStop","_eventStop","_eventReset","modal","hide","_","each","btnReset","btnStart","btnBuild","btnClose","button","prepend","url","nginx_upload_path","file","_eventAnnounce","index","toData","get","history_id","progress","percentage","_eventProgress","message","_eventSuccess","_eventError","complete","_eventComplete","ondragover","$","addClass","removeClass","ftp","container","$el","select_extension","css","data","filter","ext","composite_files","extension","updateExtension","select_collection","text","value","collectionType","updateCollectionType","on","e","target","ondragleave","preventDefault","select_genome","default_genome","onchange","genome","updateGenome","model","_eventRemove","_updateScreen","new_model","Model","file_name","name","file_size","size","mode","path","add","upload_row","append","render","list","placement","set","_uploadPercentage","it","hids","status","Galaxy","currHistoryPanel","refreshContents","info","upload_completed","file_mode","file_path","file_data","allHids","forEach","push","apply","upload","models","map","getByHid","hid","selection","constructor","historyId","buildCollection","pluck","ftp_upload_site","onadd","ftp_file","onremove","model_index","remove","currentHistory","start","visible","html","stop","default_extension","defaults_only","compatible","enable_reset","reset","enable_start","enable_build","enable_sources","show_table"],"mappings":"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","file":"../../../../scripts/mvc/upload/collection/collection-view.js","sourcesContent":["/** Renders contents of the collection uploader */\ndefine([ 'utils/utils', 'mvc/upload/upload-model', 'mvc/upload/collection/collection-row', 'mvc/upload/upload-ftp', 'mvc/upload/upload-extension','mvc/ui/ui-popover', 'mvc/ui/ui-select',  'mvc/ui/ui-misc', 'mvc/collection/list-collection-creator', 'utils/uploadbox' ],\nfunction( Utils, UploadModel, UploadRow, UploadFtp, UploadExtension, Popover, Select, Ui, LIST_COLLECTION_CREATOR ) {\n    return Backbone.View.extend({\n        // current upload size in bytes\n        upload_size: 0,\n\n        // contains upload row models\n        collection : new UploadModel.Collection(),\n\n        // keeps track of the current uploader state\n        counter : {\n            announce    : 0,\n            success     : 0,\n            error       : 0,\n            running     : 0,\n            reset : function() { this.announce = this.success = this.error = this.running = 0 }\n        },\n\n        initialize : function( app ) {\n            var self = this;\n            this.app                = app;\n            this.options            = app.options;\n            this.list_extensions    = app.list_extensions;\n            this.list_genomes       = app.list_genomes;\n            this.ui_button          = app.ui_button;\n            this.ftp_upload_site    = app.currentFtp();\n            this.setElement( this._template() );\n\n            // append buttons to dom\n            this.btnLocal    = new Ui.Button( { id: 'btn-local', title: 'Choose local files',  onclick: function() { self.uploadbox.select() }, icon: 'fa fa-laptop' } );\n            this.btnFtp      = new Ui.Button( { id: 'btn-ftp',   title: 'Choose FTP files',    onclick: function() { self._eventFtp() }, icon: 'fa fa-folder-open-o' } );\n            this.btnCreate   = new Ui.Button( { id: 'btn-new',   title: 'Paste/Fetch data',    onclick: function() { self._eventCreate() }, icon: 'fa fa-edit' } );\n            this.btnStart    = new Ui.Button( { id: 'btn-start', title: 'Start',               onclick: function() { self._eventStart() } } );\n            this.btnBuild    = new Ui.Button( { id: 'btn-build', title: 'Build',               onclick: function() { self._eventBuild() } } );\n            this.btnStop     = new Ui.Button( { id: 'btn-stop',  title: 'Pause',               onclick: function() { self._eventStop() } } );\n            this.btnReset    = new Ui.Button( { id: 'btn-reset', title: 'Reset',               onclick: function() { self._eventReset() } } );\n            this.btnClose    = new Ui.Button( { id: 'btn-close', title: 'Close',               onclick: function() { self.app.modal.hide() } } );\n            _.each( [ this.btnLocal, this.btnFtp, this.btnCreate, this.btnStop, this.btnReset, this.btnStart, this.btnBuild, this.btnClose ], function( button ) {\n                self.$( '.upload-buttons' ).prepend( button.$el );\n            });\n\n            // file upload\n            this.uploadbox = this.$( '.upload-box' ).uploadbox({\n                url             : this.app.options.nginx_upload_path,\n                announce        : function( index, file )       { self._eventAnnounce( index, file ) },\n                initialize      : function( index )             { return self.app.toData( [ self.collection.get( index ) ], self.history_id ) },\n                progress        : function( index, percentage ) { self._eventProgress( index, percentage ) },\n                success         : function( index, message )    { self._eventSuccess( index, message ) },\n                error           : function( index, message )    { self._eventError( index, message ) },\n                complete        : function()                    { self._eventComplete() },\n                ondragover      : function()                    { self.$( '.upload-box' ).addClass( 'highlight' ) },\n                ondragleave     : function()                    { self.$( '.upload-box' ).removeClass( 'highlight' ) }\n            });\n\n            // add ftp file viewer\n            this.ftp = new Popover.View( { title: 'FTP files', container: this.btnFtp.$el } );\n\n            // select extension\n            this.select_extension = new Select.View({\n                css         : 'upload-footer-selection-compressed',\n                container   : this.$( '.upload-footer-extension' ),\n                data        : _.filter( this.list_extensions, function( ext ) { return !ext.composite_files } ),\n                value       : this.options.default_extension,\n                onchange    : function( extension ) { self.updateExtension( extension ) }\n            });\n\n            this.collectionType = \"list\";\n            this.select_collection = new Select.View({\n                css         : 'upload-footer-selection-compressed',\n                container   : this.$( '.upload-footer-collection-type' ),\n                data        : [{\"id\": \"list\", \"text\": \"List\"}, {\"id\": \"paired\", \"text\": \"Paired\"}, {\"id\": \"list:paired\", \"text\": \"List of Pairs\"}],\n                value       : \"list\",\n                onchange    : function( collectionType ) { self.updateCollectionType( collectionType ) }\n            })\n\n            // handle extension info popover\n            this.$( '.upload-footer-extension-info' ).on( 'click', function( e ) {\n                new UploadExtension({\n                    $el         : $( e.target ),\n                    title       : self.select_extension.text(),\n                    extension   : self.select_extension.value(),\n                    list        : self.list_extensions,\n                    placement   : 'top'\n                });\n            }).on( 'mousedown', function( e ) { e.preventDefault() } );\n\n            // genome extension\n            this.select_genome = new Select.View({\n                css         : 'upload-footer-selection',\n                container   : this.$( '.upload-footer-genome' ),\n                data        : this.list_genomes,\n                value       : this.options.default_genome,\n                onchange    : function( genome ) { self.updateGenome(genome) }\n            });\n\n            // events\n            this.collection.on( 'remove', function( model ) { self._eventRemove( model ) } );\n            this._updateScreen();\n        },\n\n        /** A new file has been dropped/selected through the uploadbox plugin */\n        _eventAnnounce: function( index, file ) {\n            this.counter.announce++;\n            var new_model = new UploadModel.Model({\n                id          : index,\n                file_name   : file.name,\n                file_size   : file.size,\n                file_mode   : file.mode || 'local',\n                file_path   : file.path,\n                file_data   : file,\n                extension   : this.select_extension.value(),\n                genome      : this.select_genome.value()\n            });\n            this.collection.add( new_model );\n            var upload_row = new UploadRow( this, { model: new_model } );\n            this.$( '.upload-table > tbody:first' ).append( upload_row.$el );\n            this._updateScreen();\n            upload_row.render();\n        },\n\n        /** Progress */\n        _eventProgress: function( index, percentage ) {\n            var it = this.collection.get( index );\n            it.set( 'percentage', percentage );\n            this.ui_button.model.set( 'percentage', this._uploadPercentage( percentage, it.get( 'file_size' ) ) );\n        },\n\n        /** Success */\n        _eventSuccess: function( index, message ) {\n            // var hdaId = message[\"outputs\"][0][\"id\"];\n            var hids = _.pluck(message[\"outputs\"], \"hid\");\n            var it = this.collection.get( index );\n            it.set( { 'percentage': 100, 'status': 'success', 'hids': hids } );\n            this.ui_button.model.set( 'percentage', this._uploadPercentage( 100, it.get( 'file_size' ) ) );\n            this.upload_completed += it.get( 'file_size' ) * 100;\n            this.counter.announce--;\n            this.counter.success++;\n            this._updateScreen();\n            Galaxy.currHistoryPanel.refreshContents();\n        },\n\n        /** Error */\n        _eventError: function( index, message ) {\n            var it = this.collection.get( index );\n            it.set( { 'percentage': 100, 'status': 'error', 'info': message } );\n            this.ui_button.model.set( { 'percentage': this._uploadPercentage( 100, it.get( 'file_size' ) ), 'status': 'danger' } );\n            this.upload_completed += it.get( 'file_size' ) * 100;\n            this.counter.announce--;\n            this.counter.error++;\n            this._updateScreen();\n        },\n\n        /** Queue is done */\n        _eventComplete: function() {\n            this.collection.each( function( model ) { model.get( 'status' ) == 'queued' && model.set( 'status', 'init' ) } );\n            this.counter.running = 0;\n            this._updateScreen();\n        },\n\n        _eventBuild: function() {\n            var allHids = [];\n            _.forEach( this.collection.models, function( upload ) { allHids.push.apply(allHids, upload.get( 'hids' )); } );\n            var models = _.map( allHids, function( hid ) { return Galaxy.currHistoryPanel.collection.getByHid( hid ) } );\n            var selection = new Galaxy.currHistoryPanel.collection.constructor( models );\n            // I'm building the selection wrong because I need to set this historyId directly.\n            selection.historyId = Galaxy.currHistoryPanel.collection.historyId;\n            Galaxy.currHistoryPanel.buildCollection( this.collectionType, selection, true );\n            this.counter.running = 0;\n            this._updateScreen();\n            this._eventReset();\n            this.app.modal.hide();\n        },\n\n        /** Remove model from upload list */\n        _eventRemove: function( model ) {\n            var status = model.get( 'status' );\n            if ( status == 'success' ) {\n                this.counter.success--;\n            } else if ( status == 'error' ) {\n                this.counter.error--;\n            } else {\n                this.counter.announce--;\n            }\n            this.uploadbox.remove( model.id );\n            this._updateScreen();\n        },\n\n        //\n        // events triggered by this view\n        //\n\n        /** Show/hide ftp popup */\n        _eventFtp: function() {\n            if ( !this.ftp.visible ) {\n                this.ftp.empty();\n                var self = this;\n                this.ftp.append( ( new UploadFtp({\n                    collection      : this.collection,\n                    ftp_upload_site : this.ftp_upload_site,\n                    onadd           : function( ftp_file ) {\n                        return self.uploadbox.add([{\n                            mode: 'ftp',\n                            name: ftp_file.path,\n                            size: ftp_file.size,\n                            path: ftp_file.path\n                        }]);\n                    },\n                    onremove: function( model_index ) {\n                        self.collection.remove( model_index );\n                    }\n                } ) ).$el );\n                this.ftp.show();\n            } else {\n                this.ftp.hide();\n            }\n        },\n\n        /** Create a new file */\n        _eventCreate: function (){\n            this.uploadbox.add( [ { name: 'New File', size: 0, mode: 'new' } ] );\n        },\n\n        /** Start upload process */\n        _eventStart: function() {\n            if ( this.counter.announce == 0 || this.counter.running > 0 ) {\n                return;\n            }\n            var self = this;\n            this.upload_size = 0;\n            this.upload_completed = 0;\n            this.collection.each( function( model ) {\n                if( model.get( 'status' ) == 'init' ) {\n                    model.set( 'status', 'queued' );\n                    self.upload_size += model.get( 'file_size' );\n                }\n            });\n            this.ui_button.model.set( { 'percentage': 0, 'status': 'success' } );\n            this.counter.running = this.counter.announce;\n            this.history_id = this.app.currentHistory();\n            this.uploadbox.start();\n            this._updateScreen();\n        },\n\n        /** Pause upload process */\n        _eventStop: function() {\n            if ( this.counter.running > 0 ) {\n                this.ui_button.model.set( 'status', 'info' );\n                $( '.upload-top-info' ).html( 'Queue will pause after completing the current file...' );\n                this.uploadbox.stop();\n            }\n        },\n\n        /** Remove all */\n        _eventReset: function() {\n            if ( this.counter.running == 0 ){\n                this.collection.reset();\n                this.counter.reset();\n                this.uploadbox.reset();\n                this.select_extension.value( this.options.default_extension );\n                this.select_genome.value( this.options.default_genome );\n                this.ui_button.model.set( 'percentage', 0 );\n                this._updateScreen();\n            }\n        },\n\n        /** Update extension for all models */\n        updateExtension: function( extension, defaults_only ) {\n            var self = this;\n            this.collection.each( function( model ) {\n                if ( model.get( 'status' ) == 'init' && ( model.get( 'extension' ) == self.options.default_extension || !defaults_only ) ) {\n                    model.set( 'extension', extension );\n                }\n            });\n        },\n\n        /** Update collection type */\n        updateCollectionType: function( collectionType ) {\n            var self = this;\n            this.collectionType = collectionType;\n        },\n\n        /** Update genome for all models */\n        updateGenome: function( genome, defaults_only ) {\n            var self = this;\n            this.collection.each( function( model ) {\n                if ( model.get( 'status' ) == 'init' && ( model.get( 'genome' ) == self.options.default_genome || !defaults_only ) ) {\n                    model.set( 'genome', genome );\n                }\n            });\n        },\n\n        /** Set screen */\n        _updateScreen: function () {\n            var message = '';\n            if( this.counter.announce == 0 ) {\n                if (this.uploadbox.compatible()) {\n                    message = '&nbsp;';\n                } else {\n                    message = 'Browser does not support Drag & Drop. Try Firefox 4+, Chrome 7+, IE 10+, Opera 12+ or Safari 6+.';\n                }\n            } else {\n                if ( this.counter.running == 0 ) {\n                    message = 'You added ' + this.counter.announce + ' file(s) to the queue. Add more files or click \\'Start\\' to proceed.';\n                } else {\n                    message = 'Please wait...' + this.counter.announce + ' out of ' + this.counter.running + ' remaining.';\n                }\n            }\n            this.$( '.upload-top-info' ).html( message );\n            var enable_reset = this.counter.running == 0 && this.counter.announce + this.counter.success + this.counter.error > 0;\n            var enable_start = this.counter.running == 0 && this.counter.announce > 0;\n            var enable_build = this.counter.running == 0 && this.counter.announce == 0 && this.counter.success > 0 && this.counter.error == 0\n            var enable_sources = this.counter.running == 0;\n            var show_table = this.counter.announce + this.counter.success + this.counter.error > 0;\n            this.btnReset[ enable_reset ? 'enable' : 'disable' ]();\n            this.btnStart[ enable_start ? 'enable' : 'disable' ]();\n            this.btnStart.$el[ enable_start ? 'addClass' : 'removeClass' ]( 'btn-primary' );\n            this.btnBuild[ enable_build ? 'enable' : 'disable' ]();\n            this.btnBuild.$el[ enable_build ? 'addClass' : 'removeClass' ]( 'btn-primary' );\n            this.btnStop[ this.counter.running > 0 ? 'enable' : 'disable' ]();\n            this.btnLocal[ enable_sources ? 'enable' : 'disable' ]();\n            this.btnFtp[ enable_sources ? 'enable' : 'disable' ]();\n            this.btnCreate[ enable_sources ? 'enable' : 'disable' ]();\n            this.btnFtp.$el[ this.ftp_upload_site ? 'show' : 'hide' ]();\n            this.$( '.upload-table' )[ show_table ? 'show' : 'hide' ]();\n            this.$( '.upload-helper' )[ show_table ? 'hide' : 'show' ]();\n        },\n\n        /** Calculate percentage of all queued uploads */\n        _uploadPercentage: function( percentage, size ) {\n            return ( this.upload_completed + ( percentage * size ) ) / this.upload_size;\n        },\n\n        /** Template */\n        _template: function() {\n            return  '<div class=\"upload-view-default\">' +\n                        '<div class=\"upload-top\">' +\n                            '<h6 class=\"upload-top-info\"/>' +\n                        '</div>' +\n                        '<div class=\"upload-box\">' +\n                            '<div class=\"upload-helper\"><i class=\"fa fa-files-o\"/>Drop files here</div>' +\n                            '<table class=\"upload-table ui-table-striped\" style=\"display: none;\">' +\n                                '<thead>' +\n                                    '<tr>' +\n                                        '<th>Name</th>' +\n                                        '<th>Size</th>' +\n                                        '<th>Status</th>' +\n                                        '<th/>' +\n                                    '</tr>' +\n                                '</thead>' +\n                                '<tbody/>' +\n                            '</table>' +\n                        '</div>' +\n                        '<div class=\"upload-footer\">' +\n                            '<span class=\"upload-footer-title-compressed\">Collection Type:</span>' +\n                            '<span class=\"upload-footer-collection-type\"/>' +\n                            '<span class=\"upload-footer-title-compressed\">File Type:</span>' +\n                            '<span class=\"upload-footer-extension\"/>' +\n                            '<span class=\"upload-footer-extension-info upload-icon-button fa fa-search\"/> ' +\n                            '<span class=\"upload-footer-title-compressed\">Genome (set all):</span>' +\n                            '<span class=\"upload-footer-genome\"/>' +\n                        '</div>' +\n                        '<div class=\"upload-buttons\"/>' +\n                    '</div>';\n        }\n    });\n});\n"]}