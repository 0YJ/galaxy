{"version":3,"sources":["mvc/upload/composite/composite-view.js"],"names":["_utils","require","_uploadModel","_compositeRow","_uploadExtension","_uiPopover","_uiSelect","_uiMisc","Backbone","View","extend","collection","_uploadModel2","default","Collection","initialize","app","self","this","options","list_extensions","list_genomes","ftp_upload_site","currentFtp","setElement","_template","btnStart","_uiMisc2","Button","title","onclick","_eventStart","btnClose","modal","hide","_","each","button","$","prepend","$el","_uiSelect2","css","container","data","ext","composite_files","onchange","reset","details","findWhere","extension","item","add","id","size","file_desc","description","name","e","_uploadExtension2","target","select_extension","text","value","list","on","select_genome","listenTo","model","_eventAnnounce","render","placement","first","get","disable","preventDefault","enable","status","length","default_genome","addClass","removeClass","upload_row","append","genome","uploadpost","url","nginx_upload_path","toData","filter","success","message","_eventSuccess","progress","percentage","_eventProgress","it","Galaxy","currHistoryPanel","refreshContents","set","info"],"mappings":"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","file":"../../../../scripts/mvc/upload/composite/composite-view.js","sourcesContent":["/** Renders contents of the composite uploader */\nimport Utils from \"utils/utils\";\nimport UploadModel from \"mvc/upload/upload-model\";\nimport UploadRow from \"mvc/upload/composite/composite-row\";\nimport UploadExtension from \"mvc/upload/upload-extension\";\nimport Popover from \"mvc/ui/ui-popover\";\nimport Select from \"mvc/ui/ui-select\";\nimport Ui from \"mvc/ui/ui-misc\";\nexport default Backbone.View.extend({\n    collection: new UploadModel.Collection(),\n    initialize: function(app) {\n        var self = this;\n        this.app = app;\n        this.options = app.options;\n        this.list_extensions = app.list_extensions;\n        this.list_genomes = app.list_genomes;\n        this.ftp_upload_site = app.currentFtp();\n        this.setElement(this._template());\n\n        // create button section\n        this.btnStart = new Ui.Button({\n            title: \"Start\",\n            onclick: function() {\n                self._eventStart();\n            }\n        });\n        this.btnClose = new Ui.Button({\n            title: \"Close\",\n            onclick: function() {\n                self.app.modal.hide();\n            }\n        });\n\n        // append buttons to dom\n        _.each([this.btnStart, this.btnClose], function(button) {\n            self.$(\".upload-buttons\").prepend(button.$el);\n        });\n\n        // select extension\n        this.select_extension = new Select.View({\n            css: \"upload-footer-selection\",\n            container: this.$(\".upload-footer-extension\"),\n            data: _.filter(this.list_extensions, function(ext) {\n                return ext.composite_files;\n            }),\n            onchange: function(extension) {\n                self.collection.reset();\n                var details = _.findWhere(self.list_extensions, {\n                    id: extension\n                });\n                if (details && details.composite_files) {\n                    _.each(details.composite_files, function(item) {\n                        self.collection.add({\n                            id: self.collection.size(),\n                            file_desc: item.description || item.name\n                        });\n                    });\n                }\n            }\n        });\n\n        // handle extension info popover\n        this.$(\".upload-footer-extension-info\")\n            .on(\"click\", function(e) {\n                new UploadExtension({\n                    $el: $(e.target),\n                    title: self.select_extension.text(),\n                    extension: self.select_extension.value(),\n                    list: self.list_extensions,\n                    placement: \"top\"\n                });\n            })\n            .on(\"mousedown\", function(e) {\n                e.preventDefault();\n            });\n\n        // genome extension\n        this.select_genome = new Select.View({\n            css: \"upload-footer-selection\",\n            container: this.$(\".upload-footer-genome\"),\n            data: this.list_genomes,\n            value: this.options.default_genome\n        });\n\n        // listener for collection triggers on change in composite datatype and extension selection\n        this.listenTo(this.collection, \"add\", function(model) {\n            self._eventAnnounce(model);\n        });\n        this.listenTo(this.collection, \"change add\", function() {\n            self.render();\n        });\n        this.select_extension.options.onchange(this.select_extension.value());\n        this.render();\n    },\n\n    render: function() {\n        var model = this.collection.first();\n        if (model && model.get(\"status\") == \"running\") {\n            this.select_genome.disable();\n            this.select_extension.disable();\n        } else {\n            this.select_genome.enable();\n            this.select_extension.enable();\n        }\n        if (\n            this.collection.where({ status: \"ready\" }).length ==\n                this.collection.length &&\n            this.collection.length > 0\n        ) {\n            this.btnStart.enable();\n            this.btnStart.$el.addClass(\"btn-primary\");\n        } else {\n            this.btnStart.disable();\n            this.btnStart.$el.removeClass(\"btn-primary\");\n        }\n        this.$(\".upload-table\")[this.collection.length > 0 ? \"show\" : \"hide\"]();\n    },\n\n    //\n    // upload events / process pipeline\n    //\n\n    /** Builds the basic ui with placeholder rows for each composite data type file */\n    _eventAnnounce: function(model) {\n        var upload_row = new UploadRow(this, { model: model });\n        this.$(\".upload-table > tbody:first\").append(upload_row.$el);\n        this.$(\".upload-table\")[this.collection.length > 0 ? \"show\" : \"hide\"]();\n        upload_row.render();\n    },\n\n    /** Start upload process */\n    _eventStart: function() {\n        var self = this;\n        this.collection.each(function(model) {\n            model.set({\n                genome: self.select_genome.value(),\n                extension: self.select_extension.value()\n            });\n        });\n        $.uploadpost({\n            url: this.app.options.nginx_upload_path,\n            data: this.app.toData(this.collection.filter()),\n            success: function(message) {\n                self._eventSuccess(message);\n            },\n            error: function(message) {\n                self._eventError(message);\n            },\n            progress: function(percentage) {\n                self._eventProgress(percentage);\n            }\n        });\n    },\n\n    /** Refresh progress state */\n    _eventProgress: function(percentage) {\n        this.collection.each(function(it) {\n            it.set(\"percentage\", percentage);\n        });\n    },\n\n    /** Refresh success state */\n    _eventSuccess: function(message) {\n        this.collection.each(function(it) {\n            it.set(\"status\", \"success\");\n        });\n        Galaxy.currHistoryPanel.refreshContents();\n    },\n\n    /** Refresh error state */\n    _eventError: function(message) {\n        this.collection.each(function(it) {\n            it.set({ status: \"error\", info: message });\n        });\n    },\n\n    /** Load html template */\n    _template: function() {\n        return (\n            '<div class=\"upload-view-composite\">' +\n            '<div class=\"upload-top\">' +\n            '<h6 class=\"upload-top-info\"/>' +\n            \"</div>\" +\n            '<div class=\"upload-box\">' +\n            '<table class=\"upload-table ui-table-striped\" style=\"display: none;\">' +\n            \"<thead>\" +\n            \"<tr>\" +\n            \"<th/>\" +\n            \"<th/>\" +\n            \"<th>Description</th>\" +\n            \"<th>Name</th>\" +\n            \"<th>Size</th>\" +\n            \"<th>Settings</th>\" +\n            \"<th>Status</th>\" +\n            \"</tr>\" +\n            \"</thead>\" +\n            \"<tbody/>\" +\n            \"</table>\" +\n            \"</div>\" +\n            '<div class=\"upload-footer\">' +\n            '<span class=\"upload-footer-title\">Composite Type:</span>' +\n            '<span class=\"upload-footer-extension\"/>' +\n            '<span class=\"upload-footer-extension-info upload-icon-button fa fa-search\"/> ' +\n            '<span class=\"upload-footer-title\">Genome/Build:</span>' +\n            '<span class=\"upload-footer-genome\"/>' +\n            \"</div>\" +\n            '<div class=\"upload-buttons\"/>' +\n            \"</div>\"\n        );\n    }\n});\n"]}