{"version":3,"sources":["mvc/upload/composite/composite-view.js"],"names":["Backbone","View","extend","collection","_uploadModel2","default","Collection","initialize","app","self","this","options","list_extensions","list_genomes","ftp_upload_site","currentFtp","setElement","_template","btnStart","_uiMisc2","Button","title","onclick","_eventStart","btnClose","modal","hide","_","each","button","$el","select_extension","_uiSelect2","$","ext","composite_files","onchange","extension","reset","findWhere","details","item","add","size","file_desc","prepend","name","on","e","id","list","placement","select_genome","css","container","data","value","default_genome","listenTo","render","first","disable","enable","where","length","addClass","model","_eventAnnounce","upload_row","_compositeRow2","append","removeClass","set","genome","uploadpost","nginx_upload_path","toData","filter","success","message","_eventSuccess","error","percentage","it","_eventProgress","Galaxy","currHistoryPanel","refreshContents","status","info"],"mappings":"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","file":"../../../../scripts/mvc/upload/composite/composite-view.js","sourcesContent":["/** Renders contents of the composite uploader */\nimport Utils from \"utils/utils\";\nimport UploadModel from \"mvc/upload/upload-model\";\nimport UploadRow from \"mvc/upload/composite/composite-row\";\nimport UploadExtension from \"mvc/upload/upload-extension\";\nimport Popover from \"mvc/ui/ui-popover\";\nimport Select from \"mvc/ui/ui-select\";\nimport Ui from \"mvc/ui/ui-misc\";\nexport default Backbone.View.extend({\n    collection: new UploadModel.Collection(),\n    initialize: function(app) {\n        var self = this;\n        this.app = app;\n        this.options = app.options;\n        this.list_extensions = app.list_extensions;\n        this.list_genomes = app.list_genomes;\n        this.ftp_upload_site = app.currentFtp();\n        this.setElement(this._template());\n\n        // create button section\n        this.btnStart = new Ui.Button({\n            title: \"Start\",\n            onclick: function() {\n                self._eventStart();\n            }\n        });\n        this.btnClose = new Ui.Button({\n            title: \"Close\",\n            onclick: function() {\n                self.app.modal.hide();\n            }\n        });\n\n        // append buttons to dom\n        _.each([this.btnStart, this.btnClose], function(button) {\n            self.$(\".upload-buttons\").prepend(button.$el);\n        });\n\n        // select extension\n        this.select_extension = new Select.View({\n            css: \"upload-footer-selection\",\n            container: this.$(\".upload-footer-extension\"),\n            data: _.filter(this.list_extensions, function(ext) {\n                return ext.composite_files;\n            }),\n            onchange: function(extension) {\n                self.collection.reset();\n                var details = _.findWhere(self.list_extensions, {\n                    id: extension\n                });\n                if (details && details.composite_files) {\n                    _.each(details.composite_files, function(item) {\n                        self.collection.add({\n                            id: self.collection.size(),\n                            file_desc: item.description || item.name\n                        });\n                    });\n                }\n            }\n        });\n\n        // handle extension info popover\n        this.$(\".upload-footer-extension-info\")\n            .on(\"click\", function(e) {\n                new UploadExtension({\n                    $el: $(e.target),\n                    title: self.select_extension.text(),\n                    extension: self.select_extension.value(),\n                    list: self.list_extensions,\n                    placement: \"top\"\n                });\n            })\n            .on(\"mousedown\", function(e) {\n                e.preventDefault();\n            });\n\n        // genome extension\n        this.select_genome = new Select.View({\n            css: \"upload-footer-selection\",\n            container: this.$(\".upload-footer-genome\"),\n            data: this.list_genomes,\n            value: this.options.default_genome\n        });\n\n        // listener for collection triggers on change in composite datatype and extension selection\n        this.listenTo(this.collection, \"add\", function(model) {\n            self._eventAnnounce(model);\n        });\n        this.listenTo(this.collection, \"change add\", function() {\n            self.render();\n        });\n        this.select_extension.options.onchange(this.select_extension.value());\n        this.render();\n    },\n\n    render: function() {\n        var model = this.collection.first();\n        if (model && model.get(\"status\") == \"running\") {\n            this.select_genome.disable();\n            this.select_extension.disable();\n        } else {\n            this.select_genome.enable();\n            this.select_extension.enable();\n        }\n        if (\n            this.collection.where({ status: \"ready\" }).length ==\n                this.collection.length &&\n            this.collection.length > 0\n        ) {\n            this.btnStart.enable();\n            this.btnStart.$el.addClass(\"btn-primary\");\n        } else {\n            this.btnStart.disable();\n            this.btnStart.$el.removeClass(\"btn-primary\");\n        }\n        this.$(\".upload-table\")[this.collection.length > 0 ? \"show\" : \"hide\"]();\n    },\n\n    //\n    // upload events / process pipeline\n    //\n\n    /** Builds the basic ui with placeholder rows for each composite data type file */\n    _eventAnnounce: function(model) {\n        var upload_row = new UploadRow(this, { model: model });\n        this.$(\".upload-table > tbody:first\").append(upload_row.$el);\n        this.$(\".upload-table\")[this.collection.length > 0 ? \"show\" : \"hide\"]();\n        upload_row.render();\n    },\n\n    /** Start upload process */\n    _eventStart: function() {\n        var self = this;\n        this.collection.each(function(model) {\n            model.set({\n                genome: self.select_genome.value(),\n                extension: self.select_extension.value()\n            });\n        });\n        $.uploadpost({\n            url: this.app.options.nginx_upload_path,\n            data: this.app.toData(this.collection.filter()),\n            success: function(message) {\n                self._eventSuccess(message);\n            },\n            error: function(message) {\n                self._eventError(message);\n            },\n            progress: function(percentage) {\n                self._eventProgress(percentage);\n            }\n        });\n    },\n\n    /** Refresh progress state */\n    _eventProgress: function(percentage) {\n        this.collection.each(function(it) {\n            it.set(\"percentage\", percentage);\n        });\n    },\n\n    /** Refresh success state */\n    _eventSuccess: function(message) {\n        this.collection.each(function(it) {\n            it.set(\"status\", \"success\");\n        });\n        Galaxy.currHistoryPanel.refreshContents();\n    },\n\n    /** Refresh error state */\n    _eventError: function(message) {\n        this.collection.each(function(it) {\n            it.set({ status: \"error\", info: message });\n        });\n    },\n\n    /** Load html template */\n    _template: function() {\n        return (\n            '<div class=\"upload-view-composite\">' +\n            '<div class=\"upload-top\">' +\n            '<h6 class=\"upload-top-info\"/>' +\n            \"</div>\" +\n            '<div class=\"upload-box\">' +\n            '<table class=\"upload-table ui-table-striped\" style=\"display: none;\">' +\n            \"<thead>\" +\n            \"<tr>\" +\n            \"<th/>\" +\n            \"<th/>\" +\n            \"<th>Description</th>\" +\n            \"<th>Name</th>\" +\n            \"<th>Size</th>\" +\n            \"<th>Settings</th>\" +\n            \"<th>Status</th>\" +\n            \"</tr>\" +\n            \"</thead>\" +\n            \"<tbody/>\" +\n            \"</table>\" +\n            \"</div>\" +\n            '<div class=\"upload-footer\">' +\n            '<span class=\"upload-footer-title\">Composite Type:</span>' +\n            '<span class=\"upload-footer-extension\"/>' +\n            '<span class=\"upload-footer-extension-info upload-icon-button fa fa-search\"/> ' +\n            '<span class=\"upload-footer-title\">Genome/Build:</span>' +\n            '<span class=\"upload-footer-genome\"/>' +\n            \"</div>\" +\n            '<div class=\"upload-buttons\"/>' +\n            \"</div>\"\n        );\n    }\n});\n"]}