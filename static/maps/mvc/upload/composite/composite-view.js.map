{"version":3,"sources":["mvc/upload/composite/composite-view.js"],"names":["define","Utils","UploadModel","UploadRow","Popover","Select","Ui","Backbone","View","extend","collection","Collection","initialize","app","self","this","options","list_extensions","list_genomes","ftp_upload_site","currentFtp","setElement","_template","btnStart","Button","title","onclick","_eventStart","btnClose","modal","hide","_","each","button","$","prepend","$el","select_extension","css","container","data","filter","ext","composite_files","onchange","extension","reset","details","findWhere","id","item","add","size","file_desc","description","name","on","e","_showExtensionInfo","target","text","value","placement","preventDefault","select_genome","default_genome","listenTo","model","_eventAnnounce","render","first","get","disable","enable","where","status","length","addClass","removeClass","upload_row","append","set","genome","uploadpost","url","nginx_upload_path","toData","success","message","_eventSuccess","error","_eventError","progress","percentage","_eventProgress","it","Galaxy","currHistoryPanel","refreshContents","info","extension_popup","remove","destroy","empty","_templateDescription","show","tmpl","description_url"],"mappings":"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","file":"../../../../scripts/mvc/upload/composite/composite-view.js","sourcesContent":["/** Renders contents of the composite uploader */\ndefine([ 'utils/utils', 'mvc/upload/upload-model', 'mvc/upload/composite/composite-row', 'mvc/ui/ui-popover', 'mvc/ui/ui-select', 'mvc/ui/ui-misc'],\nfunction( Utils, UploadModel, UploadRow, Popover, Select, Ui ) {\n    return Backbone.View.extend({\n        collection: new UploadModel.Collection(),\n        initialize: function(app) {\n            var self = this;\n            this.app                = app;\n            this.options            = app.options;\n            this.list_extensions    = app.list_extensions;\n            this.list_genomes       = app.list_genomes;\n            this.ftp_upload_site    = app.currentFtp();\n            this.setElement( this._template() );\n\n            // create button section\n            this.btnStart = new Ui.Button( { title: 'Start', onclick: function() { self._eventStart() } } );\n            this.btnClose = new Ui.Button( { title: 'Close', onclick: function() { self.app.modal.hide() } } );\n\n            // append buttons to dom\n            _.each( [ this.btnStart, this.btnClose ], function( button ) {\n                self.$( '.upload-buttons' ).prepend( button.$el );\n            });\n\n            // select extension\n            this.select_extension = new Select.View({\n                css         : 'upload-footer-selection',\n                container   : this.$( '.upload-footer-extension' ),\n                data        : _.filter( this.list_extensions, function( ext ) { return ext.composite_files } ),\n                onchange    : function( extension ) {\n                    self.collection.reset();\n                    var details = _.findWhere( self.list_extensions, { id : extension } );\n                    if ( details && details.composite_files ) {\n                        _.each( details.composite_files, function( item ) {\n                            self.collection.add( { id          : self.collection.size(),\n                                                   file_desc   : item.description || item.name } );\n                        } );\n                    }\n                }\n            });\n\n            // handle extension info popover\n            this.$( '.upload-footer-extension-info' ).on( 'click', function( e ) {\n                self._showExtensionInfo({\n                    $el         : $( e.target ),\n                    title       : self.select_extension.text(),\n                    extension   : self.select_extension.value(),\n                    placement   : 'top'\n                });\n            }).on( 'mousedown', function( e ) { e.preventDefault() } );\n\n            // genome extension\n            this.select_genome = new Select.View({\n                css         : 'upload-footer-selection',\n                container   : this.$( '.upload-footer-genome' ),\n                data        : this.list_genomes,\n                value       : this.options.default_genome\n            });\n\n            // listener for collection triggers on change in composite datatype and extension selection\n            this.listenTo( this.collection, 'add', function ( model ) { self._eventAnnounce( model ) } );\n            this.listenTo( this.collection, 'change add', function() { self.render() } );\n            this.select_extension.options.onchange( this.select_extension.value() );\n            this.render();\n        },\n\n        render: function () {\n            var model = this.collection.first();\n            if ( model && model.get( 'status' ) == 'running' ) {\n                this.select_genome.disable();\n                this.select_extension.disable();\n            } else {\n                this.select_genome.enable();\n                this.select_extension.enable();\n            }\n            if ( this.collection.where( { status : 'ready' } ).length == this.collection.length && this.collection.length > 0 ) {\n                this.btnStart.enable();\n                this.btnStart.$el.addClass( 'btn-primary' );\n            } else {\n                this.btnStart.disable();\n                this.btnStart.$el.removeClass( 'btn-primary' );\n            }\n            this.$( '.upload-table' )[ this.collection.length > 0 ? 'show' : 'hide' ]();\n        },\n\n        //\n        // upload events / process pipeline\n        //\n\n        /** Builds the basic ui with placeholder rows for each composite data type file */\n        _eventAnnounce: function( model ) {\n            var upload_row = new UploadRow( this, { model : model } );\n            this.$( '.upload-table > tbody:first' ).append( upload_row.$el );\n            this.$( '.upload-table' )[ this.collection.length > 0 ? 'show' : 'hide' ]();\n            upload_row.render();\n        },\n\n        /** Start upload process */\n        _eventStart: function() {\n            var self = this;\n            this.collection.each( function( model ) {\n                model.set( { 'genome'   : self.select_genome.value(),\n                             'extension': self.select_extension.value() } );\n            });\n            $.uploadpost({\n                url      : this.app.options.nginx_upload_path,\n                data     : this.app.toData( this.collection.filter() ),\n                success  : function( message )      { self._eventSuccess( message ) },\n                error    : function( message )      { self._eventError( message ) },\n                progress : function( percentage )   { self._eventProgress( percentage ) }\n            });\n        },\n\n        /** Refresh progress state */\n        _eventProgress: function( percentage ) {\n            this.collection.each( function( it ) { it.set( 'percentage', percentage ) } );\n        },\n\n        /** Refresh success state */\n        _eventSuccess: function( message ) {\n            this.collection.each( function( it ) { it.set('status', 'success') } );\n            Galaxy.currHistoryPanel.refreshContents();\n        },\n\n        /** Refresh error state */\n        _eventError: function( message ) {\n            this.collection.each( function( it ) { it.set( { 'status': 'error', 'info': message } ) } );\n        },\n\n        /** Display extension info popup */\n        _showExtensionInfo: function(options) {\n            var self = this;\n            var $el         = options.$el;\n            var extension   = options.extension;\n            var title       = options.title;\n            var description = _.findWhere(this.list_extensions, { id : extension });\n            this.extension_popup && this.extension_popup.remove();\n            this.extension_popup = new Popover.View({\n                placement: options.placement || 'bottom',\n                container: $el,\n                destroy: true\n            });\n            this.extension_popup.title( title );\n            this.extension_popup.empty();\n            this.extension_popup.append( this._templateDescription( description ) );\n            this.extension_popup.show();\n        },\n\n        /* Template for extensions description */\n        _templateDescription: function( options ) {\n            if ( options.description ) {\n                var tmpl = options.description;\n                if ( options.description_url ) {\n                    tmpl += '&nbsp;(<a href=\"' + options.description_url + '\" target=\"_blank\">read more</a>)';\n                }\n                return tmpl;\n            } else {\n                return 'There is no description available for this file extension.';\n            }\n        },\n\n        /** Load html template */\n        _template: function() {\n            return  '<div class=\"upload-view-composite\">' +\n                        '<div class=\"upload-footer\">' +\n                            '<span class=\"upload-footer-title\">Composite Type:</span>' +\n                            '<span class=\"upload-footer-extension\"/>' +\n                            '<span class=\"upload-footer-extension-info upload-icon-button fa fa-search\"/> ' +\n                            '<span class=\"upload-footer-title\">Genome/Build:</span>' +\n                            '<span class=\"upload-footer-genome\"/>' +\n                        '</div>' +\n                        '<div class=\"upload-box\">' +\n                            '<table class=\"upload-table ui-table-striped\" style=\"display: none;\">' +\n                                '<thead>' +\n                                    '<tr>' +\n                                        '<th/>' +\n                                        '<th/>' +\n                                        '<th>Description</th>' +\n                                        '<th>Name</th>' +\n                                        '<th>Size</th>' +\n                                        '<th>Settings</th>' +\n                                        '<th>Status</th>' +\n                                    '</tr>' +\n                                '</thead>' +\n                                '<tbody/>' +\n                            '</table>' +\n                        '</div>' +\n                        '<div class=\"upload-buttons\"/>' +\n                    '</div>';\n        }\n    });\n});\n"]}