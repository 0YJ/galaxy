{"version":3,"sources":["mvc/user/user-model.js"],"names":["_underscore","require","_backbone","_baseMvc","_localization","logNamespace","User","_backbone2","default","Model","extend","_baseMvc2","LoggableMixin","_logNamespace","urlRoot","Galaxy","root","defaults","username","_localization2","email","total_disk_usage","nice_total_disk_usage","quota_percent","is_admin","initialize","data","this","log","on","model","resp","changes","get","isAdmin","loadFromApi","idOrCurrent","options","CURRENT_ID_STR","isAnonymous","userFn","success","newModel","response","url","prototype","call","clearSessionStorage","key","sessionStorage","trigger","removeItem","toString","userInfo","unshift","push","join","getCurrentUserFromApi","currentUser","Collection"],"mappings":"4IAAA,IAAAA,YAAAC,QAAA,oEACAC,UAAAD,QAAA,8DACAE,SAAAF,QAAA,2DACAG,cAAAH,QAAA,2EAEII,aAAe,OAJnBC,KAAAC,WAAAC,QAAAC,MAAAC,OAAAC,UAAAH,QAAAI,eAAAF,QAWQG,cAAeR,aAGfS,QAAS,WACL,OAAOC,OAAOC,KAAO,aAOzBC,UAlBJZ,GAAAA,KACJa,SAAA,KAAA,EAAAC,eAAAX,SAAA,kBAAA,IACAY,MAAA,GAoBYC,iBAAkB,EAClBC,sBAAuB,GAlBxBC,cAAA,KACPC,UAAA,GAA6BC,WAAA,SAAAC,GA0BrBC,KAAKC,IAAI,mBAAoBF,GAE7BC,KAAKE,GAAG,SAAU,SAASC,EAAOC,GAC9BJ,KAAKC,IAAID,KAAO,eAAgBG,EAAOC,KAjB/Cd,KAAUY,GAAA,SAAA,SAAAC,EAA6BJ,GAAAC,KAAAC,IAAAD,KAAA,gBAAAG,EAAAJ,EAAAM,YAKnCV,YAAAA,WACAC,OAAAA,KAAeU,IANoB,UA4BvCC,QAAS,WAlBT,OAAAP,KAAAM,IAAA,aAUQE,YAAS,SAAOC,EAAhBC,GADJD,EAAAA,GAAA9B,KAAAgC,eAKJC,IAAAA,EAAaZ,KACDa,GAiBRH,EAAUA,OAjBVI,QAcJN,OAXAD,EAASO,QAAA,SAAWC,EAAAC,GACTb,EAAKG,QAAI,SAAhBS,EAAAC,GAzCqBH,GA8DbA,EAAOE,EAAUC,IAKrBP,IAAgB9B,KAAKgC,iBACrBD,EAAQO,IAAMjB,KAAKb,QAAU,IAAMR,KAAKgC,gBAjBnC/B,WAAAC,QAAAC,MAAAoC,UAAST,MAATU,KAAsBT,KAASA,IAIxCU,oBACqBN,WAoBrB,IAAK,IAAIO,KAAOC,eAhBsBN,IAA5BO,EAAAA,QAAQ,YACVV,eAAQW,WAAAH,GACSL,kBAAVD,GACVO,eAAAE,WAAAH,IAMJI,SAAA,WACD,IAAOC,GAAA1B,KAAAM,IAASxB,aAKpBsC,OA3EyBpB,KAAAM,IAAA,QA2FjBoB,EAASC,QAAQ3B,KAAKM,IAAI,OAlBlCoB,EAAAE,KAAA5B,KAAAM,IAAA,WAEAc,QAAqBM,EAAAG,KAAA,KAAA,OAMZlD,KAAAgC,eAAM,UAGVhC,KAAAmD,sBAAA,SAAApB,GACJ,IArFwBqB,EAAA,IAAApD,KAuFzB,OAkBJoD,EAAYvB,YAAY7B,KAAKgC,eAAgBD,GAlBzCqB,GAIQL,IAAAA,eAASC,WAAAA,QAAQK,WAASjD,OAA1BC,UAAAH,QAAAI,eAAAF,QACA2C,MAAAA,KACHvC,QAAA,WACD,OAAOC,OAAAC,KAAUqC,gCAQ7B/C,KAAAA","file":"../../../scripts/mvc/user/user-model.js","sourcesContent":["import _ from \"libs/underscore\";\nimport Backbone from \"libs/backbone\";\nimport baseMVC from \"mvc/base-mvc\";\nimport _l from \"utils/localization\";\n\nvar logNamespace = \"user\";\n//==============================================================================\n/** @class Model for a Galaxy user (including anonymous users).\n *  @name User\n */\nvar User = Backbone.Model.extend(baseMVC.LoggableMixin).extend(\n    /** @lends User.prototype */ {\n        _logNamespace: logNamespace,\n\n        /** API location for this resource */\n        urlRoot: function() {\n            return Galaxy.root + \"api/users\";\n        },\n\n        /** Model defaults\n     *  Note: don't check for anon-users with the username as the default is '(anonymous user)'\n     *      a safer method is if( !user.get( 'email' ) ) -> anon user\n     */\n        defaults: /** @lends User.prototype */ {\n            id: null,\n            username: \"(\" + _l(\"anonymous user\") + \")\",\n            email: \"\",\n            total_disk_usage: 0,\n            nice_total_disk_usage: \"\",\n            quota_percent: null,\n            is_admin: false\n        },\n\n        /** Set up and bind events\n     *  @param {Object} data Initial model data.\n     */\n        initialize: function(data) {\n            this.log(\"User.initialize:\", data);\n\n            this.on(\"loaded\", function(model, resp) {\n                this.log(this + \" has loaded:\", model, resp);\n            });\n            this.on(\"change\", function(model, data) {\n                this.log(this + \" has changed:\", model, data.changes);\n            });\n        },\n\n        isAnonymous: function() {\n            return !this.get(\"email\");\n        },\n\n        isAdmin: function() {\n            return this.get(\"is_admin\");\n        },\n\n        /** Load a user with the API using an id.\n     *      If getting an anonymous user or no access to a user id, pass the User.CURRENT_ID_STR\n     *      (e.g. 'current') and the API will return the current transaction's user data.\n     *  @param {String} idOrCurrent encoded user id or the User.CURRENT_ID_STR\n     *  @param {Object} options hash to pass to Backbone.Model.fetch. Can contain success, error fns.\n     *  @fires loaded when the model has been loaded from the API, passing the newModel and AJAX response.\n     */\n        loadFromApi: function(idOrCurrent, options) {\n            idOrCurrent = idOrCurrent || User.CURRENT_ID_STR;\n\n            options = options || {};\n            var model = this,\n                userFn = options.success;\n\n            /** @ignore */\n            options.success = function(newModel, response) {\n                model.trigger(\"loaded\", newModel, response);\n                if (userFn) {\n                    userFn(newModel, response);\n                }\n            };\n\n            // requests for the current user must have a sep. constructed url (fetch don't work, ma)\n            if (idOrCurrent === User.CURRENT_ID_STR) {\n                options.url = this.urlRoot + \"/\" + User.CURRENT_ID_STR;\n            }\n            return Backbone.Model.prototype.fetch.call(this, options);\n        },\n\n        /** Clears all data from the sessionStorage.\n     */\n        clearSessionStorage: function() {\n            for (var key in sessionStorage) {\n                //TODO: store these under the user key so we don't have to do this\n                // currently only history\n                if (key.indexOf(\"history:\") === 0) {\n                    sessionStorage.removeItem(key);\n                } else if (key === \"history-panel\") {\n                    sessionStorage.removeItem(key);\n                }\n            }\n        },\n\n        /** string representation */\n        toString: function() {\n            var userInfo = [this.get(\"username\")];\n            if (this.get(\"id\")) {\n                userInfo.unshift(this.get(\"id\"));\n                userInfo.push(this.get(\"email\"));\n            }\n            return \"User(\" + userInfo.join(\":\") + \")\";\n        }\n    }\n);\n\n// string to send to tell server to return this transaction's user (see api/users.py)\nUser.CURRENT_ID_STR = \"current\";\n\n// class method to load the current user via the api and return that model\nUser.getCurrentUserFromApi = function(options) {\n    var currentUser = new User();\n    currentUser.loadFromApi(User.CURRENT_ID_STR, options);\n    return currentUser;\n};\n\n// (stub) collection for users (shouldn't be common unless admin UI)\nvar UserCollection = Backbone.Collection.extend(baseMVC.LoggableMixin).extend({\n    model: User,\n    urlRoot: function() {\n        return Galaxy.root + \"api/users\";\n    }\n    //logger  : console,\n});\n\n//==============================================================================\nexport default {\n    User: User\n};\n"]}