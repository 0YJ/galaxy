{"version":3,"sources":["mvc/user/user-model.js"],"names":["define","_","Backbone","baseMVC","_l","User","Model","extend","LoggableMixin","_logNamespace","urlRoot","Galaxy","root","defaults","id","username","email","total_disk_usage","nice_total_disk_usage","quota_percent","is_admin","initialize","data","this","log","on","model","resp","changes","isAnonymous","get","isAdmin","loadFromApi","idOrCurrent","options","CURRENT_ID_STR","userFn","success","newModel","response","trigger","url","prototype","fetch","call","clearSessionStorage","key","sessionStorage","indexOf","removeItem","toString","userInfo","unshift","push","join","getCurrentUserFromApi","currentUser","Collection"],"mappings":"AAAAA,QACI,kBACA,gBACA,eACA,sBACD,SAAUC,EAAGC,EAAUC,EAASC,GACnC,YAEA,IAKIC,GAAOH,EAASI,MAAMC,OAAQJ,EAAQK,eAAgBD,QAEtDE,cAPe,OAUfC,QAAU,WAAY,MAAOC,QAAOC,KAAO,aAM3CC,UACIC,GAA0B,KAC1BC,SAA0B,IAAMX,EAAI,kBAAqB,IACzDY,MAA0B,GAC1BC,iBAA0B,EAC1BC,sBAA0B,GAC1BC,cAA0B,KAC1BC,UAA0B,GAM9BC,WAAa,SAAUC,GACnBC,KAAKC,IAAK,mBAAoBF,GAE9BC,KAAKE,GAAI,SAAU,SAAUC,EAAOC,GAAQJ,KAAKC,IAAKD,KAAO,eAAgBG,EAAOC,KACpFJ,KAAKE,GAAI,SAAU,SAAUC,EAAOJ,GAAQC,KAAKC,IAAKD,KAAO,gBAAiBG,EAAOJ,EAAKM,YAG9FC,YAAc,WACV,OAAUN,KAAKO,IAAK,UAGxBC,QAAU,WACN,MAASR,MAAKO,IAAK,aAUvBE,YAAc,SAAUC,EAAaC,GACjCD,EAAcA,GAAe5B,EAAK8B,eAElCD,EAAUA,KACV,IAAIR,GAAQH,KACRa,EAASF,EAAQG,OAYrB,OATAH,GAAQG,QAAU,SAAUC,EAAUC,GAClCb,EAAMc,QAAS,SAAUF,EAAUC,GAC/BH,GAAUA,EAAQE,EAAUC,IAIhCN,IAAgB5B,EAAK8B,iBACrBD,EAAQO,IAAMlB,KAAKb,QAAU,IAAML,EAAK8B,gBAErCjC,EAASI,MAAMoC,UAAUC,MAAMC,KAAMrB,KAAMW,IAKtDW,oBAAsB,WAClB,IAAK,GAAIC,KAAOC,gBAGsB,IAA9BD,EAAIE,QAAS,YACbD,eAAeE,WAAYH,GAEZ,kBAARA,GACPC,eAAeE,WAAYH,IAMvCI,SAAW,WACP,GAAIC,IAAa5B,KAAKO,IAAK,YAK3B,OAJIP,MAAKO,IAAK,QACVqB,EAASC,QAAS7B,KAAKO,IAAK,OAC5BqB,EAASE,KAAM9B,KAAKO,IAAK,WAEtB,QAAUqB,EAASG,KAAM,KAAQ,MAKhDjD,GAAK8B,eAAiB,UAGtB9B,EAAKkD,sBAAwB,SAAUrB,GACnC,GAAIsB,GAAc,GAAInD,EAEtB,OADAmD,GAAYxB,YAAa3B,EAAK8B,eAAgBD,GACvCsB,EAIUtD,GAASuD,WAAWlD,OAAQJ,EAAQK,eAAgBD,QACrEmB,MAAUrB,EACVK,QAAU,WAAY,MAAOC,QAAOC,KAAO,cAM/C,QACIP,KAAOA","file":"../../../scripts/mvc/user/user-model.js","sourcesContent":["define([\n    'libs/underscore',\n    'libs/backbone',\n    'mvc/base-mvc',\n    'utils/localization'\n], function( _, Backbone, baseMVC, _l ){\n'use strict';\n\nvar logNamespace = 'user';\n//==============================================================================\n/** @class Model for a Galaxy user (including anonymous users).\n *  @name User\n */\nvar User = Backbone.Model.extend( baseMVC.LoggableMixin ).extend(\n/** @lends User.prototype */{\n    _logNamespace : logNamespace,\n\n    /** API location for this resource */\n    urlRoot : function(){ return Galaxy.root + 'api/users'; },\n\n    /** Model defaults\n     *  Note: don't check for anon-users with the username as the default is '(anonymous user)'\n     *      a safer method is if( !user.get( 'email' ) ) -> anon user\n     */\n    defaults : /** @lends User.prototype */{\n        id                      : null,\n        username                : '(' + _l( \"anonymous user\" ) + ')',\n        email                   : \"\",\n        total_disk_usage        : 0,\n        nice_total_disk_usage   : \"\",\n        quota_percent           : null,\n        is_admin                : false\n    },\n\n    /** Set up and bind events\n     *  @param {Object} data Initial model data.\n     */\n    initialize : function( data ){\n        this.log( 'User.initialize:', data );\n\n        this.on( 'loaded', function( model, resp ){ this.log( this + ' has loaded:', model, resp ); });\n        this.on( 'change', function( model, data ){ this.log( this + ' has changed:', model, data.changes ); });\n    },\n\n    isAnonymous : function(){\n        return ( !this.get( 'email' ) );\n    },\n\n    isAdmin : function(){\n        return ( this.get( 'is_admin' ) );\n    },\n\n    /** Load a user with the API using an id.\n     *      If getting an anonymous user or no access to a user id, pass the User.CURRENT_ID_STR\n     *      (e.g. 'current') and the API will return the current transaction's user data.\n     *  @param {String} idOrCurrent encoded user id or the User.CURRENT_ID_STR\n     *  @param {Object} options hash to pass to Backbone.Model.fetch. Can contain success, error fns.\n     *  @fires loaded when the model has been loaded from the API, passing the newModel and AJAX response.\n     */\n    loadFromApi : function( idOrCurrent, options ){\n        idOrCurrent = idOrCurrent || User.CURRENT_ID_STR;\n\n        options = options || {};\n        var model = this,\n            userFn = options.success;\n\n        /** @ignore */\n        options.success = function( newModel, response ){\n            model.trigger( 'loaded', newModel, response );\n            if( userFn ){ userFn( newModel, response ); }\n        };\n\n        // requests for the current user must have a sep. constructed url (fetch don't work, ma)\n        if( idOrCurrent === User.CURRENT_ID_STR ){\n            options.url = this.urlRoot + '/' + User.CURRENT_ID_STR;\n        }\n        return Backbone.Model.prototype.fetch.call( this, options );\n    },\n\n    /** Clears all data from the sessionStorage.\n     */\n    clearSessionStorage : function(){\n        for( var key in sessionStorage ){\n            //TODO: store these under the user key so we don't have to do this\n            // currently only history\n            if( key.indexOf( 'history:' ) === 0 ){\n                sessionStorage.removeItem( key );\n\n            } else if( key === 'history-panel' ){\n                sessionStorage.removeItem( key );\n            }\n        }\n    },\n\n    /** string representation */\n    toString : function(){\n        var userInfo = [ this.get( 'username' ) ];\n        if( this.get( 'id' ) ){\n            userInfo.unshift( this.get( 'id' ) );\n            userInfo.push( this.get( 'email' ) );\n        }\n        return 'User(' + userInfo.join( ':' ) + ')';\n    }\n});\n\n// string to send to tell server to return this transaction's user (see api/users.py)\nUser.CURRENT_ID_STR = 'current';\n\n// class method to load the current user via the api and return that model\nUser.getCurrentUserFromApi = function( options ){\n    var currentUser = new User();\n    currentUser.loadFromApi( User.CURRENT_ID_STR, options );\n    return currentUser;\n};\n\n// (stub) collection for users (shouldn't be common unless admin UI)\nvar UserCollection = Backbone.Collection.extend( baseMVC.LoggableMixin ).extend({\n    model   : User,\n    urlRoot : function(){ return Galaxy.root + 'api/users'; },\n    //logger  : console,\n});\n\n\n//==============================================================================\nreturn {\n    User : User\n};});\n"]}