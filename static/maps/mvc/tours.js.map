{"version":3,"sources":["mvc/tours.js"],"names":["define","BootstrapTour","gxy_root","Galaxy","root","tour_opts","preclick","window","sessionStorage","onShow","removeItem","$","orphan","hooked_tour_from_data","data","step","_","postclick","click","onHide","onShown","textinsert","element","val","trigger","TourItem","extend","getJSON","url","model","tour","init","tour_id","goTo","restart","tourdata","ToursView","Backbone","JSON","stringify","initialize","Tour","self","steps","success","View","this","setElement","Tours","render","fetch","html","giveTour","console","error","$el","tpl","tours","models","on","e","preventDefault"],"mappings":"YAUAA,SAAQ,uBAAuB,SAASC,GAAxCD,GAAQE,GAAuB,mBAAvBC,QAAgCF,IAAeE,OAAAC,KA4B3CC,GAASC,QAASC,OAAAC,eACTC,MAAL,WACID,eAAAE,WAA+BJ,qBAE3BK,MAAEL,IAFNM,QAAA,GAMRC,EAAmB,SAAAC,GAwB3B,MAvBYC,GAAAA,KAAAA,EAAAA,MAAA,SAAcA,GACVC,EAAAA,WACID,EAAAN,OAAA,WACAE,EAAAA,KAAEM,EAAAA,SAAF,SAAAX,GAHRK,EAAAL,GAAAY,YASAH,EAAAE,YACAF,EAAAI,OAAA,WACAJ,EAAKK,KAAAA,EAASH,UAAU,SAAAA,GAAxBN,EAAAM,GAAAC,YAtBZH,EAAAM,aA8BAN,EAAAK,QAAA,WAPgBT,EAAEI,EAAKO,SAASC,IAAIR,EAAKM,YAAYG,QAAQ,cAW7DV,GAOIW,EAAUvB,SAAAA,MAAWwB,QACrBf,QAAEgB,EAAc,cAGZnB,EAAAA,SAAAA,WAAuBkB,QACvBE,IAAA1B,EAAA,YACA2B,MAAAJ,IAIAK,EAAKC,SAALC,GACAF,GAAAA,GAAKG,EAAL,aAAAD,CACAF,GAAAA,QAAKI,EAAL,SAAApB,GAbR,GAAAqB,GAAAtB,EAAAC,EAgBIsB,gBAAYC,QAAcX,mBAAOY,KAAAC,UAAAzB,GAEjC0B,IAAAA,GAAY,GAAAC,MAAAzB,EAAAU,QACJgB,MAAOP,EAAXQ,OACAtC,GAEAyB,GAAKD,OACHe,EAAAA,KAAAA,GACEF,EAAAA,YAkBZ,QAAQN,UAfIC,SAAAQ,KAAAnB,QAEDc,WAAA,WAPc,GAAjBE,GAAAI,IAN6BA,MAAAC,WAAA,UAK7BD,KAAKjB,MAAQ,GAAImB,GAYrBC,KAAQpB,MAAAqB,OACJN,QAAU5B,WACV0B,EAASS,UAELC,MAAAA,WAEPC,QAAAC,MAAA,8BAKGjD,OAAAA,WACA+C,GAAAA,GAAUA,EAAAA,SA7GdlD,8fAFR4C,MAAAS,IAAAJ,KAAAK,GAAAC,MAAAX,KAAAjB,MAAA6B,UAAAC,GAAA,QAAA,YAAA,SAAAC,GAsGgBA,EAAEC,iBACFT,EAASzC,EAAEmC,MAAMhC,KAAK,iBAM1BD,sBAAuBA,EACvBR,UAAWA,EACX+C,SAAUA","file":"../../scripts/mvc/tours.js","sourcesContent":["/**\n *  This is the primary galaxy tours definition, currently only used for\n *  rendering a tour menu.\n *\n *  For now it's intended to be plunked into the center display a-la\n *  Galaxy.app.display, but we could use a modal as well for more flexibility.\n *\n *  DBTODO - This is downright backbone abuse, rewrite it.\n */\n\ndefine(['libs/bootstrap-tour'],function(BootstrapTour) {\n\n    var gxy_root = typeof Galaxy === \"undefined\" ? '/' : Galaxy.root;\n\n    var tourpage_template = `<h2>Galaxy Tours</h2>\n<p>This page presents a list of interactive tours available on this Galaxy server.\nSelect any tour to get started (and remember, you can click 'End Tour' at any time).</p>\n<ul>\n<% _.each(tours, function(tour) { %>\n    <li>\n        <a href=\"/tours/<%- tour.id %>\" class=\"tourItem\" data-tour.id=<%- tour.id %>>\n            <%- tour.attributes.name || tour.id %>\n        </a>\n         - <%- tour.attributes.description || \"No description given.\" %>\n    </li>\n<% }); %>\n</ul>`;\n\n    var tour_opts = { storage: window.sessionStorage,\n                      onEnd: function(){\n                          sessionStorage.removeItem('activeGalaxyTour');\n                      },\n                      delay: 150, // Attempts to make it look natural\n                      orphan:true\n    };\n\n    var hooked_tour_from_data = function(data){\n        _.each(data.steps, function(step) {\n            if (step.preclick){\n                step.onShow= function(){\n                    _.each(step.preclick, function(preclick){\n                        // TODO: click delay between clicks\n                        $(preclick).click();\n                    });\n                };\n            }\n            if (step.postclick){\n                step.onHide = function(){\n                    _.each(step.postclick, function(postclick){\n                        // TODO: click delay between clicks\n                        $(postclick).click();\n                    });\n                };\n            }\n            if (step.textinsert){\n                // Have to manually trigger a change here, for some\n                // elements which have additional logic, like the\n                // upload input box\n                step.onShown= function(){\n                    $(step.element).val(step.textinsert).trigger(\"change\");\n                };\n            }\n        });\n        return data;\n    };\n\n    var TourItem = Backbone.Model.extend({\n      urlRoot: gxy_root + 'api/tours',\n    });\n\n    var Tours = Backbone.Collection.extend({\n      url:  gxy_root + 'api/tours',\n      model: TourItem,\n    });\n\n\n    var giveTour =  function(tour_id){\n        var url = gxy_root + 'api/tours/' + tour_id;\n        $.getJSON( url, function( data ) {\n            // Set hooks for additional click and data entry actions.\n            var tourdata = hooked_tour_from_data(data);\n            sessionStorage.setItem('activeGalaxyTour', JSON.stringify(data));\n            // Store tour steps in sessionStorage to easily persist w/o hackery.\n            var tour = new Tour(_.extend({\n                steps: tourdata.steps,\n            }, tour_opts));\n            // Always clean restart, since this is a new, explicit giveTour execution.\n            tour.init();\n            tour.goTo(0);\n            tour.restart();\n        });\n    };\n    var ToursView = Backbone.View.extend({\n        // initialize\n        initialize: function() {\n            var self = this;\n            this.setElement('<div/>');\n            this.model = new Tours();\n            this.model.fetch({\n              success: function(){\n                self.render();\n              },\n              error: function(){\n                // Do something.\n                console.error(\"Failed to fetch tours.\");\n              }\n            });\n        },\n\n        render: function(){\n            var tpl = _.template(tourpage_template);\n            this.$el.html(tpl({tours: this.model.models})).on(\"click\", \".tourItem\", function(e){\n                e.preventDefault();\n                giveTour($(this).data(\"tour.id\"));\n            });\n        }\n    });\n\n    return {ToursView: ToursView,\n            hooked_tour_from_data: hooked_tour_from_data,\n            tour_opts: tour_opts,\n            giveTour: giveTour};\n});\n"]}