{"version":3,"sources":["mvc/dataset/dataset-choice.js"],"names":["define","DATASET","DATASET_LIST","MODAL","BASE_MVC","_l","_filterDatasetJSON","hasOwnProperty","where","datasetsOnly","matches","obj","toMatch","key","console","datasetJSON","filter","json","debug","deleted","visible","undefined","collection_type","DatasetChoiceModal","options","resolveWithSelected","promise","multiselect","map","model","buttons","toJSON","selected","state","filterFn","length","reject","modal","height","body","closing_events","resolve","join","title","subtitle","el","find","selecting","list","$body","addClass","collection","DatasetAssociationCollection","show","$el","on","render","hide","view","always","DatasetChoice","Backbone","View","extend","LoggableMixin","_logNamespace","className","initialize","attributes","this","label","_setUpListeners","_template","_","template","html","$","replaceWith","_renderSelected","datasets","chooser","variable","trigger","id","findWhere","events","click","_createModal","done","pluck","fail","arguments","_getModalOptions","cells","hid","name","misc_blurb","toString","showHeaders","prototype","file_ext","tags","annotation","call","MultiDatasetChoice"],"mappings":"YAAAA,SACI,4BADJA,2BAOA,kBAHI,eAKJ,sBACA,SAAAC,EAAAC,EAAAC,EAAAC,EAAAC,GAqBY,QAAAC,GAAYC,EAARC,EAA+BC,GAE3B,QAAAC,GAAAC,EAAAC,GACH,IAAA,GAAAC,KAAAD,GACJ,GAAAA,EAAAL,eAAAM,IACJF,EAAAE,KAAAD,EAAAC,GACM,OAAP,CAIAC,QAAAA,EAKP,MAAAC,GAAAC,OAAA,SAAAC,GAED,MAPQH,SAAQI,MAAOD,IAOvBA,EAAAE,SAAAF,EAAAG,WACAX,OAAAY,KAAAJ,EAAAK,kBALiBZ,EAASO,EAAMT,KAnChC,GAgFQe,GAAA,SAAAR,EAAAS,GA2BJ,QAAAC,KACAC,EAAIF,QAAQG,EAAAA,oBAAaC,IAAA,SAAAC,GACrBC,MAAAA,GAAAC,YA1BAJ,EAAAA,EAAAA,SAAkBH,OAElBQ,cAAkB,EAEtBxB,OAAAyB,MAAA,MAJIN,aAAkB,EAQtBK,cAAAR,EAEIU,MAAAA,EAAWV,OAJYnB,EAArBmB,EAAQG,YAAiB,mBAA0B,oBAOzDZ,IAAAA,GAAAA,EAAAA,EACAW,EAAKX,OAAYoB,UAKjB,OADApB,IAHWW,EAAQU,QAAQ9B,GAG3BS,EAAAS,EAAAhB,MAAAgB,EAAAf,cACAM,EAASU,QAWTD,EAAAG,cACAU,KACIC,EAAAA,EAAsB,OADHb,GAIeC,EAAAA,GAAAA,GAAAA,MAA0BY,OAJzC,OAKnBC,QACQT,EANWU,gBAAvB,EASAH,iBAAS,WAATX,EAAAe,QAAA,OACAJ,MAJY,kCAMZK,KAAA,MAEIC,EAAAA,EAAAA,iBAAsBA,SACtBC,EAAAA,EAAAA,iBAAsBA,IAAAA,aAAe,OAKrCC,EAAAA,GAAAA,GAA0BC,aAC1BC,MAAAA,EARgCJ,MAShCX,SAAcR,EAAQQ,UATU3B,GAApC,yDAKY,mDAQZqC,KAAA,KACAM,GAAWX,EAAAY,MAAAH,KAAoB,eAC3BT,WAAA,EACAA,SAAUa,EAAVlB,SACHmB,WAHD,GAAAlD,GAAAmD,6BAAArC,KAOQiC,EAAAA,KAAAA,mBAAQ,WACXX,EAFDgB,OAGAhB,EAAAiB,IAAAJ,SAAA,0BAEIxB,EAAAA,cAEPsB,EAAAO,GAAA,WAAA,WACDP,EAAKQ,EAAQ,iBAAbC,SAGAT,EAAAO,GAAO7B,gBAAgB,SAAUgC,GAC7BrB,EAAMoB,SAANC,EAAA7B,MAAAE,cAJJiB,EAAKQ,OAAQ,GAGN9B,EAAQiC,OAAQ,WACnBtB,EAAMoB,UAxDN/B,EAAQe,OAASO,qBAyFrBY,EAAgBC,SAASC,KAAKC,OAAQ3D,EAAS4D,eAAgBD,QAS3DE,cAzMW,UA2MXC,UAAA,iBAGAC,WAAKnC,SAALoC,GAPAC,KAAKnD,MAAOmD,KAAO,8BAA+BD,GAUrDC,KAjBqEC,UAAAjD,KAAA+C,EAAAE,MAAAjE,EAAA+D,EAAAE,OAAA,GAUlED,KAAK7D,MAAQ4D,EAAW5D,MAS5B6D,KAAA5D,iBAAAY,KAAA+C,EAAA3D,cAAA2D,EAAA3D,aAEI4D,KAAAtD,YAAAqD,EAAArD,gBACAsD,KAAArC,SAAAoC,EAAApC,aAEHqC,KAxBqEE,mBA4BlEA,gBAAItD,aAORuD,OAAAA,WACI,GAAAvD,GAAOwD,KAAEC,QAQb,OAFCL,MA1CqEf,IAAAqB,KAAAN,KAAAG,UAAAvD,IA8BlEoD,KAAKO,EAAG,aAAcC,YAAaR,KAAKS,gBAAiB7D,IAc7DoD,MAIQG,UAAA,SAAUC,GAUb,MAAAA,GAAAC,UACD,UA3DkE,2CAuC1D,+BA2BhB,YACIhC,KAAA,KAAAzB,IAIQqD,gBAAAA,SAAsBA,GACtBS,MAAAA,GAAAA,SAAcC,OAEVJ,EAAAH,EAAAC,UACH,yBALL,uEAtEkE,0BAoDlD,oCA2BpB,MAAArE,EAAA,UAAA,KAAA,+BACS,mCACL,UACA,UAlFkEqC,KAAA,KAAAuC,SAAA,aAAAhE,EAAAe,SAAA,KAqF1E4C,GACA,oCACIvE,EAAA,6BAzBQ,YACFqC,KAAM,MAKZX,OAAS,WA2BL,GAAAiD,GAAOX,IAEC,QACIW,MAAAA,EAAQhD,MACRgD,SAAAA,EAAQE,YACRF,SAAAA,EAAQxB,QAARiB,EAAA7C,IAAAoD,EAAAhD,SAAA,SAAAmD,GAEH,MAAMV,GAAAW,UAAAJ,EAAAjE,aAAAoE,GAAAA,SAQlBE,QAEDC,MAAA,mBAUQtD,gBAAAA,WACAxB,GAAAA,GAAAA,IAJG,OAAP6D,MAAAkB,eAvHkEC,KAAA,SAAAvE,GAiGtDA,GA+BhB+D,EAAAhD,SAAAyC,EAAAgB,MAAAxE,EAAA,MACA+D,EAAAE,QAAA,WAAAF,EAAA/D,GACW+D,EAAAxB,UAlIfwB,EAAAE,QAAA,YAAAF,KA2GaU,KAAM,WACHV,EAAQE,QAAS,QAASF,EAASW,cAK/CJ,aAAe,WACX,MAAO,IAAIhE,GAAoB8C,KAAKtD,YAAasD,KAAKuB,qBAmC1D1B,iBAAYN,WA9BR,OAgCJjB,MAAA0B,KAAAC,MACAuB,aAAQ,EACJC,SAAsBzB,KADlBrC,SAEJ+D,MAFI1B,KAAA7D,MAGJwF,aAAsB3B,KAAA5D,eAzB1BwF,SAAW,WAgCX,MAAA,iBAAA5B,KAAArC,SAAA,OAuCAD,EAAS6B,EAAUG,QAEXmC,UAAAA,EAAcC,UAAKD,UADuC,SAIjEL,OArDGC,IAAkBzF,EAAI,aAuD1B0F,KAAA1F,EAAA,QACAuF,WAAmBvF,EAAA,WACf+F,SAASrC,EAAQH,UACbjC,aAAAA,EAAc,UADsD0E,KAAxEhG,EAAA,QAGHiG,WAlEyCjG,EAAA,eAsE1C4F,WAAAA,SAAW7B,GACPC,KAAA6B,gBAA0C7E,KAAnC+C,EAAmB8B,aAA1B9B,EAAA8B,YACH7B,KAAAwB,MAAAzB,EAAAyB,OAAAxB,KAAAwB,MAxELjC,EAAAuC,UAAAhC,WAAAoC,KAAAlC,KAAAD,IA8EQ7C,gBAAAA,SAA0BA,GAC1BqC,MAAAA,GAAAA,SAA0BA,OAC1B4C,EAAAA,EAAAA,UAHJ,2BAzaJ,gCAwXwB,cACI,iDACI,sBACJ,YACJ,gBACJ,UACA,UACI,oDACI,OACI,iDACI,0DACJ,WACJ,QACJ,YACJ,WACJ,YACF9D,KAAM,KAAQuC,SAAU,SAAWhE,IAElC2D,GACH,oCACIvE,EAAI,6BACR,YACFqC,KAAM,MAIZX,OAAS,WACL,MAAO0C,GAAEV,OAAQH,EAAcuC,UAAUpE,OAAOwE,KAAMlC,OAClD6B,YAAc7B,KAAK6B,YACnBL,MAAcxB,KAAKwB,SAK3BD,iBAAmB,WACf,MAAOnB,GAAEV,OAAQH,EAAcuC,UAAUP,iBAAiBW,KAAMlC,OAC5D1C,aAAc,KAMtBsE,SAAW,WACP,MAAO,iBAAmB5B,KAAKrC,SAAW,MAM9C,QACIT,mBAA0BA,EAC1BqC,cAA0BA,EAC1B4C,mBAA0BA","file":"../../../scripts/mvc/dataset/dataset-choice.js","sourcesContent":["define([\n    'mvc/dataset/dataset-model',\n    'mvc/dataset/dataset-list',\n    'mvc/ui/ui-modal',\n    'mvc/base-mvc',\n    'utils/localization'\n], function( DATASET, DATASET_LIST, MODAL, BASE_MVC, _l ){\n'use strict';\n\nvar logNamespace = 'dataset';\n/* ============================================================================\nTODO:\n    does this really work with mixed contents?\n    Single dataset choice: allow none?\n    tooltips rendered *behind* modal\n    collection selector\n    better handling when no results returned from filterDatasetJSON\n    pass optional subtitle from choice display to modal\n    onfirstclick\n    drop target\n    return modal with promise?\n\n    auto showing the modal may not be best\n\n============================================================================ */\n/** Filters an array of dataset plain JSON objs.\n */\nfunction _filterDatasetJSON( datasetJSON, where, datasetsOnly ){\n//TODO: replace with _.matches (underscore 1.6.0)\n    function matches( obj, toMatch ){\n        for( var key in toMatch ){\n            if( toMatch.hasOwnProperty( key ) ){\n                if( obj[ key ] !== toMatch[ key ] ){\n                    return false;\n                }\n            }\n        }\n        return true;\n    }\n\n    return datasetJSON.filter( function( json ){\n        console.debug( json )\n        return ( !json.deleted && json.visible )\n            && ( !datasetsOnly || json.collection_type === undefined )\n            && ( matches( json, where ) );\n    });\n}\n\n// ============================================================================\n/** Given an array of plain JSON objs rep. datasets, show a modal allowing a choice\n *      of one or more of those datasets.\n *\n *  Pass:\n *      an array of plain JSON objects representing allowed dataset choices\n *      a map of options (see below)\n *\n *  Options:\n *      datasetsOnly:   T: display only datasets, F: datasets + dataset collections\n *      where:          a map of attributes available choices *must have* (defaults to { state: 'ok' })\n *      multiselect:    T: user can select more than one, F: only one\n *      selected:       array of dataset ids to make them selected by default\n *\n *  @example:\n *      var datasetJSON = // from ajax or bootstrap\n *      // returns a jQuery promise (that 'fail's only if no datasets are found matching 'where' below)\n *      var choice = new DatasetChoiceModal( datasetJSON, {\n *          datasetsOnly    : false,\n *          where           : { state: 'ok', file_ext: 'bed', ... },\n *          multiselect     : true,\n *          selected        : [ 'df7a1f0c02a5b08e', 'abcdef0123456789' ]\n *\n *      }).done( function( json ){\n *          if( json ){\n *              console.debug( json );\n *              // returned choice will always be an array (single or multi)\n *              // [{ <selected dataset JSON 1>, <selected dataset JSON 2>, ... }]\n *              // ... do stuff\n *          } else {\n *              // json will === null if the user cancelled selection\n *              console.debug( 'cancelled' );\n *          }\n *      });\n */\nvar DatasetChoiceModal = function( datasetJSON, options ){\n\n    // option defaults\n    options = _.defaults( options || {}, {\n        // show datasets or datasets and collections\n        datasetsOnly    : true,\n        // map of attributes to filter datasetJSON by\n        where           : { state: 'ok' },\n        // select more than one dataset?\n        multiselect     : false,\n        // any dataset ids that will display as already selected\n        selected        : []\n    });\n    // default title should depend on multiselect\n    options.title = options.title ||\n        ( options.multiselect? _l( 'Choose datasets:' ): _l( 'Choose a dataset:' ) );\n\n    var modal, list, buttons,\n        promise = jQuery.Deferred(),\n        filterFn = options.filter || _filterDatasetJSON;\n\n    // filter the given datasets and if none left return a rejected promise for use with fail()\n    datasetJSON = filterFn( datasetJSON, options.where, options.datasetsOnly );\n    if( !datasetJSON.length ){\n        return promise.reject( 'No matches found' );\n    }\n\n    // resolve the returned promise with the json of the selected datasets\n    function resolveWithSelected(){\n        promise.resolve( list.getSelectedModels().map( function( model ){\n            return model.toJSON();\n        }));\n    }\n    // if multiselect - add a button for the user to complete the changes\n    if( options.multiselect ){\n        buttons = {};\n        buttons[ _l( 'Ok' ) ] = resolveWithSelected;\n    }\n\n    // create a full-height modal that's cancellable, remove unneeded elements and styles\n    modal = new MODAL.View({\n        height              : 'auto',\n        buttons             : buttons,\n        closing_events      : true,\n        closing_callback    : function(){ promise.resolve( null ); },\n        body                : [\n                '<div class=\"list-panel\"></div>'\n            ].join('')\n    });\n    modal.$( '.modal-header' ).remove();\n    modal.$( '.modal-footer' ).css( 'margin-top', '0px' );\n\n    // attach a dataset list (of the filtered datasets) to that modal that's selectable\n    list = new DATASET_LIST.DatasetList({\n        title       : options.title,\n        subtitle    : options.subtitle || _l([\n//TODO: as option\n                'Click the checkboxes on the right to select datasets. ',\n                'Click the datasets names to see their details. '\n            ].join('')),\n        el          : modal.$body.find( '.list-panel' ),\n        selecting   : true,\n        selected    : options.selected,\n        collection  : new DATASET.DatasetAssociationCollection( datasetJSON )\n    });\n\n    // when the list is rendered, show the modal (also add a specifying class for css)\n    list.once( 'rendered:initial', function(){\n        modal.show();\n        modal.$el.addClass( 'dataset-choice-modal' );\n    });\n    if( !options.multiselect ){\n        // if single select, remove the all/none list actions from the panel\n        list.on( 'rendered', function(){\n            list.$( '.list-actions' ).hide();\n        });\n        // if single select, immediately resolve on a single selection\n        list.on( 'view:selected', function( view ){\n            promise.resolve([ view.model.toJSON() ]);\n        });\n    }\n    list.render( 0 );\n\n    // return the promise, and on any resolution close the modal\n    return promise.always( function(){\n        modal.hide();\n    });\n};\n\n\n// ============================================================================\n/** Activator for single dataset selection modal and display of the selected dataset.\n *      The activator/display will show as a single div and, when a dataset is selected,\n *      show the name and details of the selected dataset.\n *\n *      When clicked the div will generate a DatasetChoiceModal of the available choices.\n *\n *  Options:\n *      datasetJSON:    array of plain json objects representing allowed choices\n *      datasetsOnly:   T: only show datasets in the allowed choices, F: datasets + collections\n *      where:          map of attributes to filter datasetJSON by (e.g. { file_ext: 'bed' })\n *      label:          the label/prompt displayed\n *      selected:       array of dataset ids that will show as already selected in the control\n *\n *  @example:\n *      var choice1 = new DATASET_CHOICE.DatasetChoice({\n *          datasetJSON : datasetJSON,\n *          label       : 'Input dataset',\n *          selected    : [ 'df7a1f0c02a5b08e' ]\n *      });\n *      $( 'body' ).append( choice1.render().$el )\n *\n *  Listen to the DatasetChoice to react to changes in the user's choice/selection:\n *  @example:\n *      choice1.on( 'selected', function( chooser, selectionJSONArray ){\n *          // ... do stuff with new selections\n *      });\n */\nvar DatasetChoice = Backbone.View.extend( BASE_MVC.LoggableMixin ).extend({\n    _logNamespace : logNamespace,\n\n    className : 'dataset-choice',\n\n    /** set up defaults, options, and listeners */\n    initialize : function( attributes ){\n        this.debug( this + '(DatasetChoice).initialize:', attributes );\n\n        this.label = attributes.label !== undefined? _l( attributes.label ) : '';\n        this.where = attributes.where;\n        this.datasetsOnly = attributes.datasetsOnly !== undefined? attributes.datasetsOnly: true;\n\n        this.datasetJSON = attributes.datasetJSON || [];\n        this.selected = attributes.selected || [];\n\n        this._setUpListeners();\n    },\n\n    /** add any (bbone) listeners */\n    _setUpListeners : function(){\n        //this.on( 'all', function(){\n        //    this.log( this + '', arguments );\n        //});\n    },\n\n    /** render the view */\n    render : function(){\n        var json = this.toJSON();\n        this.$el.html( this._template( json ) );\n        this.$( '.selected' ).replaceWith( this._renderSelected( json ) );\n        return this;\n    },\n\n    /** return plain html for the overall control */\n    _template : function( json ){\n        return _.template([\n            '<label>',\n                '<span class=\"prompt\"><%- label %></span>',\n                '<div class=\"selected\"></div>',\n            '</label>'\n        ].join(''))( json );\n    },\n\n    /** return jQ DOM for the selected dataset (only one) */\n    _renderSelected : function( json ){\n        if( json.selected.length ){\n//TODO: break out?\n            return $( _.template([\n                '<div class=\"selected\">',\n                    '<span class=\"title\"><%- selected.hid %>: <%- selected.name %></span>',\n                    '<span class=\"subtitle\">',\n                        '<i><%- selected.misc_blurb %></i>',\n                        '<i>', _l( 'format' ) + ': ', '<%- selected.file_ext %></i>',\n                        '<i><%- selected.misc_info %></i>',\n                    '</span>',\n                '</div>'\n            ].join( '' ), { variable : 'selected' })( json.selected[0] ));\n        }\n        return $([\n            '<span class=\"none-selected-msg\">(',\n                _l( 'click to select a dataset' ),\n            ')</span>'\n        ].join( '' ));\n    },\n\n//TODO:?? why not just pass in view?\n    /** return a plain JSON object with both the view and dataset attributes */\n    toJSON : function(){\n        var chooser = this;\n        return {\n            label       : chooser.label,\n            datasets    : chooser.datasetJSON,\n            selected    : _.compact( _.map( chooser.selected, function( id ){\n                return _.findWhere( chooser.datasetJSON, { id: id });\n            }))\n        };\n    },\n\n    /** event map: when to open the modal */\n    events : {\n        // the whole thing functions as a button\n        'click' : 'chooseWithModal'\n    },\n\n//TODO:?? modal to prop of this?\n//TODO:?? should be able to handle 'none selectable' on initialize\n    /** open the modal and handle the promise representing the user's choice\n     *  @fires 'selected' when the user selects dataset(s) - passed full json of the selected datasets\n     *  @fires 'cancelled' when the user clicks away/closes the modal (no selection made) - passed this\n     *  @fires 'error' if the modal has no selectable datasets based on this.where - passed this and other args\n     */\n    chooseWithModal : function(){\n        var chooser = this;\n\n        return this._createModal()\n            .done( function( json ){\n                if( json ){\n                    chooser.selected = _.pluck( json, 'id' );\n                    chooser.trigger( 'selected', chooser, json );\n                    chooser.render();\n\n                } else {\n                    chooser.trigger( 'cancelled', chooser );\n                }\n            })\n\n            .fail( function(){\n                chooser.trigger( 'error', chooser, arguments );\n            });\n    },\n\n    /** create and return the modal to use for choosing */\n    _createModal : function(){\n        return new DatasetChoiceModal( this.datasetJSON, this._getModalOptions() );\n    },\n\n    /** return a plain JSON containing the options to pass to the modal */\n    _getModalOptions : function(){\n        return {\n            title           : this.label,\n            multiselect     : false,\n            selected        : this.selected,\n            where           : this.where,\n            datasetsOnly    : this.datasetsOnly\n        };\n    },\n\n    // ------------------------------------------------------------------------ misc\n    /** string rep */\n    toString : function(){\n        return 'DatasetChoice(' + this.selected + ')';\n    }\n});\n\n\n// ============================================================================\n/** Activator for multiple dataset selection modal and display of the selected datasets.\n *      The activator/display will show as a table of all choices.\n *\n *  See DatasetChoice (above) for example usage.\n *\n *  Additional options:\n *      showHeaders:    T: show headers for selected dataset attributes in the display table\n *      cells:          map of attribute keys -> Human readable/localized column headers\n *          (e.g. { file_ext: _l( 'Format' ) }) - defaults are listed below\n */\nvar MultiDatasetChoice = DatasetChoice.extend({\n\n    className : DatasetChoice.prototype.className + ' multi',\n\n    /** default (dataset attribute key -> table header text) map of what cells to display in the table */\n    cells : {\n        hid             : _l( 'History #' ),\n        name            : _l( 'Name' ),\n        misc_blurb      : _l( 'Summary' ),\n        file_ext        : _l( 'Format' ),\n        genome_build    : _l( 'Genome' ),\n        tags            : _l( 'Tags' ),\n        annotation      : _l( 'Annotation' )\n    },\n\n    /** in this override, add the showHeaders and cells options */\n    initialize : function( attributes ){\n        this.showHeaders = attributes.showHeaders !== undefined? attributes.showHeaders : true;\n        this.cells = attributes.cells || this.cells;\n        DatasetChoice.prototype.initialize.call( this, attributes );\n    },\n\n    /** in this override, display the selected datasets as a table with optional headers */\n    _renderSelected : function( json ){\n        if( json.selected.length ){\n            return $( _.template([\n                '<table class=\"selected\">',\n                    '<% if( json.showHeaders ){ %>',\n                        '<thead><tr>',\n                            '<% _.map( json.cells, function( val, key ){ %>',\n                                '<th><%- val %></th>',\n                            '<% }); %>',\n                        '</tr></thead>',\n                    '<% } %>',\n                    '<tbody>',\n                        '<% _.map( json.selected, function( selected ){ %>',\n                            '<tr>',\n                                '<% _.map( json.cells, function( val, key ){ %>',\n                                    '<td class=\"cell-<%- key %>\"><%- selected[ key ] %></td>',\n                                '<% }) %>',\n                            '</tr>',\n                        '<% }); %>',\n                    '</tbody>',\n                '</table>'\n            ].join( '' ), { variable: 'json' })( json ));\n        }\n        return $([\n            '<span class=\"none-selected-msg\">(',\n                _l( 'click to select a dataset' ),\n            ')</span>'\n        ].join( '' ));\n    },\n\n    /** in this override, send the showHeaders and cells options as well */\n    toJSON : function(){\n        return _.extend( DatasetChoice.prototype.toJSON.call( this ), {\n            showHeaders : this.showHeaders,\n            cells       : this.cells\n        });\n    },\n\n    /** in this override, set multiselect to true */\n    _getModalOptions : function(){\n        return _.extend( DatasetChoice.prototype._getModalOptions.call( this ), {\n            multiselect : true\n        });\n    },\n\n    // ------------------------------------------------------------------------ misc\n    /** string rep */\n    toString : function(){\n        return 'DatasetChoice(' + this.selected + ')';\n    }\n});\n\n\n// ============================================================================\n    return {\n        DatasetChoiceModal      : DatasetChoiceModal,\n        DatasetChoice           : DatasetChoice,\n        MultiDatasetChoice      : MultiDatasetChoice\n    };\n});\n"]}