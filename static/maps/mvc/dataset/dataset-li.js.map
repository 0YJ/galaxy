{"version":3,"sources":["mvc/dataset/dataset-li.js"],"names":["define","LIST_ITEM","STATES","faIconButton","BASE_MVC","_l","_super","ListItemView","DatasetListItemView","extend","_logNamespace","className","prototype","id","this","model","get","join","initialize","attributes","logger","log","call","linkTarget","_setUpListeners","self","listenTo","change","options","changedAttributes","state","inReadyState","expanded","hasDetails","fetch","silent","done","render","_fetchModelDetails","view","jQuery","when","remove","speed","callback","fxSpeed","$el","fadeOut","Backbone","View","_swapNewRender","$newRender","has","addClass","_renderPrimaryActions","_renderDisplayButton","NOT_VIEWABLE","DISCARDED","displayBtnData","target","classes","disabled","title","UPLOAD","NEW","href","urls","display","onclick","ev","Galaxy","frame","active","addDataset","preventDefault","faIcon","_renderDetails","$","templates","noAccess","toJSON","$details","find","empty","append","_renderSecondaryActions","html","_renderSummary","prepend","_renderDetailMessages","_renderDisplayApplications","_setUpBehaviors","json","summaryRenderFn","summaries","unknown","$warnings","_","each","detailMessages","templateFn","isDeletedOrPurged","displayApplications","debug","OK","FAILED_METADATA","ERROR","_renderDownloadButton","_renderShowParamsButton","show_params","add","url","stopPropagation","hasData","isEmpty","download","_renderMetaFileDownloadButton","map","meta_file","meta_download","file_type","events","clone","click .display-btn","trigger","click .params-btn","click .download-btn","toString","warnings","failed_metadata","wrapTemplate","error","purged","deleted","detailsTemplate","noAccessTemplate","summaryTemplates","QUEUED","RUNNING","SETTING_METADATA","PAUSED","EMPTY","detailMessageTemplates","resubmitted","displayApplicationsTemplate","details"],"mappings":"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","file":"../../../scripts/mvc/dataset/dataset-li.js","sourcesContent":["define([\n    \"mvc/list/list-item\",\n    \"mvc/dataset/states\",\n    \"ui/fa-icon-button\",\n    \"mvc/base-mvc\",\n    \"utils/localization\"\n], function( LIST_ITEM, STATES, faIconButton, BASE_MVC, _l ){\n'use strict';\n\nvar logNamespace = 'dataset';\n/*==============================================================================\nTODO:\n    straighten out state rendering and templates used\n    inaccessible/STATES.NOT_VIEWABLE is a special case\n    simplify button rendering\n\n==============================================================================*/\nvar _super = LIST_ITEM.ListItemView;\n/** @class Read only list view for either LDDAs, HDAs, or HDADCEs.\n *      Roughly, any DatasetInstance (and not a raw Dataset).\n */\nvar DatasetListItemView = _super.extend(\n/** @lends DatasetListItemView.prototype */{\n    _logNamespace : logNamespace,\n\n    className   : _super.prototype.className + \" dataset\",\n    //TODO:?? doesn't exactly match an hda's type_id\n    id          : function(){\n        return [ 'dataset', this.model.get( 'id' ) ].join( '-' );\n    },\n\n    /** Set up: instance vars, options, and event handlers */\n    initialize : function( attributes ){\n        if( attributes.logger ){ this.logger = this.model.logger = attributes.logger; }\n        this.log( this + '.initialize:', attributes );\n        _super.prototype.initialize.call( this, attributes );\n\n        /** where should pages from links be displayed? (default to new tab/window) */\n        this.linkTarget = attributes.linkTarget || '_blank';\n    },\n\n    /** event listeners */\n    _setUpListeners : function(){\n        _super.prototype._setUpListeners.call( this );\n        var self = this;\n\n        // re-rendering on any model changes\n        return self.listenTo( self.model, {\n            'change': function( model, options ){\n                // if the model moved into the ready state and is expanded without details, fetch those details now\n                if( self.model.changedAttributes().state\n                &&  self.model.inReadyState()\n                &&  self.expanded\n                && !self.model.hasDetails() ){\n                    // normally, will render automatically (due to fetch -> change),\n                    // but! setting_metadata sometimes doesn't cause any other changes besides state\n                    // so, not rendering causes it to seem frozen in setting_metadata state\n                    self.model.fetch({ silent : true })\n                        .done( function(){ self.render(); });\n\n                } else {\n                    self.render();\n                }\n            }\n        });\n    },\n\n    // ......................................................................... expandable\n    /** In this override, only get details if in the ready state, get rerunnable if in other states.\n     *  Note: fetch with no 'change' event triggering to prevent automatic rendering.\n     */\n    _fetchModelDetails : function(){\n        var view = this;\n        if( view.model.inReadyState() && !view.model.hasDetails() ){\n            return view.model.fetch({ silent: true });\n        }\n        return jQuery.when();\n    },\n\n    // ......................................................................... removal\n    /** Remove this view's html from the DOM and remove all event listeners.\n     *  @param {Number or String} speed jq effect speed\n     *  @param {Function} callback      an optional function called when removal is done (scoped to this view)\n     */\n    remove : function( speed, callback ){\n        var view = this;\n        speed = speed || this.fxSpeed;\n        this.$el.fadeOut( speed, function(){\n            Backbone.View.prototype.remove.call( view );\n            if( callback ){ callback.call( view ); }\n        });\n    },\n\n    // ......................................................................... rendering\n    /* TODO:\n        dataset states are the issue primarily making dataset rendering complex\n            each state should have it's own way of displaying/set of details\n            often with different actions that can be applied\n        throw in deleted/purged/visible and things get complicated easily\n        I've considered (a couple of times) - creating a view for each state\n            - but recreating the view during an update...seems wrong\n    */\n    /** In this override, add the dataset state as a class for use with state-based CSS */\n    _swapNewRender : function( $newRender ){\n        _super.prototype._swapNewRender.call( this, $newRender );\n        if( this.model.has( 'state' ) ){\n            this.$el.addClass( 'state-' + this.model.get( 'state' ) );\n        }\n        return this.$el;\n    },\n\n    // ................................................................................ titlebar\n    /** In this override, add the dataset display button. */\n    _renderPrimaryActions : function(){\n        // render just the display for read-only\n        return [ this._renderDisplayButton() ];\n    },\n\n    /** Render icon-button to display dataset data */\n    _renderDisplayButton : function(){\n        // don't show display if not viewable or not accessible\n        var state = this.model.get( 'state' );\n        if( ( state === STATES.NOT_VIEWABLE )\n        ||  ( state === STATES.DISCARDED )\n        ||  ( !this.model.get( 'accessible' ) ) ){\n            return null;\n        }\n\n        var displayBtnData = {\n            target      : this.linkTarget,\n            classes     : 'display-btn'\n        };\n\n        // show a disabled display if the data's been purged\n        if( this.model.get( 'purged' ) ){\n            displayBtnData.disabled = true;\n            displayBtnData.title = _l( 'Cannot display datasets removed from disk' );\n\n        // disable if still uploading\n        } else if( state === STATES.UPLOAD ){\n            displayBtnData.disabled = true;\n            displayBtnData.title = _l( 'This dataset must finish uploading before it can be viewed' );\n\n        // disable if still new\n        } else if( state === STATES.NEW ){\n            displayBtnData.disabled = true;\n            displayBtnData.title = _l( 'This dataset is not yet viewable' );\n\n        } else {\n            displayBtnData.title = _l( 'View data' );\n\n            // default link for dataset\n            displayBtnData.href  = this.model.urls.display;\n\n            // add frame manager option onclick event\n            var self = this;\n            displayBtnData.onclick = function( ev ){\n                if (Galaxy.frame && Galaxy.frame.active) {\n                    // Add dataset to frames.\n                    Galaxy.frame.addDataset(self.model.get('id'));\n                    ev.preventDefault();\n                }\n            };\n        }\n        displayBtnData.faIcon = 'fa-eye';\n        return faIconButton( displayBtnData );\n    },\n\n    // ......................................................................... rendering details\n    /** Render the enclosing div of the hda body and, if expanded, the html in the body\n     *  @returns {jQuery} rendered DOM\n     */\n    _renderDetails : function(){\n        //TODO: generalize to be allow different details for each state\n\n        // no access - render nothing but a message\n        if( this.model.get( 'state' ) === STATES.NOT_VIEWABLE ){\n            return $( this.templates.noAccess( this.model.toJSON(), this ) );\n        }\n\n        var $details = _super.prototype._renderDetails.call( this );\n        $details.find( '.actions .left' ).empty().append( this._renderSecondaryActions() );\n        $details.find( '.summary' ).html( this._renderSummary() )\n            .prepend( this._renderDetailMessages() );\n        $details.find( '.display-applications' ).html( this._renderDisplayApplications() );\n\n        this._setUpBehaviors( $details );\n        return $details;\n    },\n\n    /** Defer to the appropo summary rendering fn based on state */\n    _renderSummary : function(){\n        var json = this.model.toJSON(),\n            summaryRenderFn = this.templates.summaries[ json.state ];\n        summaryRenderFn = summaryRenderFn || this.templates.summaries.unknown;\n        return summaryRenderFn( json, this );\n    },\n\n    /** Render messages to be displayed only when the details are shown */\n    _renderDetailMessages : function(){\n        var view = this,\n            $warnings = $( '<div class=\"detail-messages\"></div>' ),\n            json = view.model.toJSON();\n        //TODO:! unordered (map)\n        _.each( view.templates.detailMessages, function( templateFn ){\n            $warnings.append( $( templateFn( json, view ) ) );\n        });\n        return $warnings;\n    },\n\n    /** Render the external display application links */\n    _renderDisplayApplications : function(){\n        if( this.model.isDeletedOrPurged() ){ return ''; }\n        // render both old and new display apps using the same template\n        return [\n            this.templates.displayApplications( this.model.get( 'display_apps' ), this ),\n            this.templates.displayApplications( this.model.get( 'display_types' ), this )\n        ].join( '' );\n    },\n\n    // ......................................................................... secondary/details actions\n    /** A series of links/buttons for less commonly used actions: re-run, info, etc. */\n    _renderSecondaryActions : function(){\n        this.debug( '_renderSecondaryActions' );\n        switch( this.model.get( 'state' ) ){\n            case STATES.NOT_VIEWABLE:\n                return [];\n            case STATES.OK:\n            case STATES.FAILED_METADATA:\n            case STATES.ERROR:\n                return [ this._renderDownloadButton(), this._renderShowParamsButton() ];\n        }\n        return [ this._renderShowParamsButton() ];\n    },\n\n    /** Render icon-button to show the input and output (stdout/err) for the job that created this.\n     *  @returns {jQuery} rendered DOM\n     */\n    _renderShowParamsButton : function(){\n        // gen. safe to show in all cases\n        return faIconButton({\n            title       : _l( 'View details' ),\n            classes     : 'params-btn',\n            href        : this.model.urls.show_params,\n            target      : this.linkTarget,\n            faIcon      : 'fa-info-circle',\n            onclick     : function( ev ) {\n                if ( Galaxy.frame && Galaxy.frame.active ) {\n                    Galaxy.frame.add( { title: 'Dataset details', url: this.href } );\n                    ev.preventDefault();\n                    ev.stopPropagation();\n                }\n            }\n        });\n    },\n\n\n    /** Render icon-button/popupmenu to download the data (and/or the associated meta files (bai, etc.)) for this.\n     *  @returns {jQuery} rendered DOM\n     */\n    _renderDownloadButton : function(){\n        // don't show anything if the data's been purged\n        if( this.model.get( 'purged' ) || !this.model.hasData() ){ return null; }\n\n        // return either: a popupmenu with links to download assoc. meta files (if there are meta files)\n        //  or a single download icon-button (if there are no meta files)\n        if( !_.isEmpty( this.model.get( 'meta_files' ) ) ){\n            return this._renderMetaFileDownloadButton();\n        }\n\n        return $([\n            '<a class=\"download-btn icon-btn\" ',\n                'href=\"', this.model.urls.download, '\" title=\"' + _l( 'Download' ) + '\" download>',\n                '<span class=\"fa fa-floppy-o\"></span>',\n            '</a>'\n        ].join( '' ));\n    },\n\n    /** Render the download button which opens a dropdown with links to download assoc. meta files (indeces, etc.) */\n    _renderMetaFileDownloadButton : function(){\n        var urls = this.model.urls;\n        return $([\n            '<div class=\"metafile-dropdown dropdown\">',\n                '<a class=\"download-btn icon-btn\" href=\"javascript:void(0)\" data-toggle=\"dropdown\"',\n                    ' title=\"' + _l( 'Download' ) + '\">',\n                    '<span class=\"fa fa-floppy-o\"></span>',\n                '</a>',\n                '<ul class=\"dropdown-menu\" role=\"menu\" aria-labelledby=\"dLabel\">',\n                    '<li><a href=\"' + urls.download + '\" download>', _l( 'Download dataset' ), '</a></li>',\n                    _.map( this.model.get( 'meta_files' ), function( meta_file ){\n                        return [\n                            '<li><a href=\"', urls.meta_download + meta_file.file_type, '\">',\n                                _l( 'Download' ), ' ', meta_file.file_type,\n                            '</a></li>'\n                        ].join( '' );\n                    }).join( '\\n' ),\n                '</ul>',\n            '</div>'\n        ].join( '\\n' ));\n    },\n\n    // ......................................................................... misc\n    events : _.extend( _.clone( _super.prototype.events ), {\n        'click .display-btn'    : function( ev ){ this.trigger( 'display', this, ev ); },\n        'click .params-btn'     : function( ev ){ this.trigger( 'params', this, ev ); },\n        'click .download-btn'   : function( ev ){ this.trigger( 'download', this, ev ); }\n    }),\n\n    // ......................................................................... misc\n    /** String representation */\n    toString : function(){\n        var modelString = ( this.model )?( this.model + '' ):( '(no model)' );\n        return 'DatasetListItemView(' + modelString + ')';\n    }\n});\n\n// ............................................................................ TEMPLATES\n/** underscore templates */\nDatasetListItemView.prototype.templates = (function(){\n//TODO: move to require text! plugin\n\n    var warnings = _.extend( {}, _super.prototype.templates.warnings, {\n        failed_metadata : BASE_MVC.wrapTemplate([\n            // failed metadata is rendered as a warning on an otherwise ok dataset view\n            '<% if( model.state === \"failed_metadata\" ){ %>',\n                '<div class=\"warningmessagesmall\">',\n                    _l( 'An error occurred setting the metadata for this dataset' ),\n                '</div>',\n            '<% } %>'\n        ]),\n        error : BASE_MVC.wrapTemplate([\n            // error during index fetch - show error on dataset\n            '<% if( model.error ){ %>',\n                '<div class=\"errormessagesmall\">',\n                    _l( 'There was an error getting the data for this dataset' ), ': <%- model.error %>',\n                '</div>',\n            '<% } %>'\n        ]),\n        purged : BASE_MVC.wrapTemplate([\n            '<% if( model.purged ){ %>',\n                '<div class=\"purged-msg warningmessagesmall\">',\n                    _l( 'This dataset has been deleted and removed from disk' ),\n                '</div>',\n            '<% } %>'\n        ]),\n        deleted : BASE_MVC.wrapTemplate([\n            // deleted not purged\n            '<% if( model.deleted && !model.purged ){ %>',\n                '<div class=\"deleted-msg warningmessagesmall\">',\n                    _l( 'This dataset has been deleted' ),\n                '</div>',\n            '<% } %>'\n        ])\n\n        //NOTE: hidden warning is only needed for HDAs\n    });\n\n    var detailsTemplate = BASE_MVC.wrapTemplate([\n        '<div class=\"details\">',\n            '<div class=\"summary\"></div>',\n\n            '<div class=\"actions clear\">',\n                '<div class=\"left\"></div>',\n                '<div class=\"right\"></div>',\n            '</div>',\n\n            // do not display tags, annotation, display apps, or peek when deleted\n            '<% if( !dataset.deleted && !dataset.purged ){ %>',\n                '<div class=\"tags-display\"></div>',\n                '<div class=\"annotation-display\"></div>',\n\n                '<div class=\"display-applications\"></div>',\n\n                '<% if( dataset.peek ){ %>',\n                    '<pre class=\"dataset-peek\"><%= dataset.peek %></pre>',\n                '<% } %>',\n            '<% } %>',\n        '</div>'\n    ], 'dataset' );\n\n    var noAccessTemplate = BASE_MVC.wrapTemplate([\n        '<div class=\"details\">',\n            '<div class=\"summary\">',\n                _l( 'You do not have permission to view this dataset' ),\n            '</div>',\n        '</div>'\n    ], 'dataset' );\n\n//TODO: still toooooooooooooo complex - rework\n    var summaryTemplates = {};\n    summaryTemplates[ STATES.OK ] = summaryTemplates[ STATES.FAILED_METADATA ] = BASE_MVC.wrapTemplate([\n        '<% if( dataset.misc_blurb ){ %>',\n            '<div class=\"blurb\">',\n                '<span class=\"value\"><%- dataset.misc_blurb %></span>',\n            '</div>',\n        '<% } %>',\n\n        '<% if( dataset.file_ext ){ %>',\n            '<div class=\"datatype\">',\n                '<label class=\"prompt\">', _l( 'format' ), '</label>',\n                '<span class=\"value\"><%- dataset.file_ext %></span>',\n            '</div>',\n        '<% } %>',\n\n        '<% if( dataset.metadata_dbkey ){ %>',\n            '<div class=\"dbkey\">',\n                '<label class=\"prompt\">', _l( 'database' ), '</label>',\n                '<span class=\"value\">',\n                    '<%- dataset.metadata_dbkey %>',\n                '</span>',\n            '</div>',\n        '<% } %>',\n\n        '<% if( dataset.misc_info ){ %>',\n            '<div class=\"info\">',\n                '<span class=\"value\"><%- dataset.misc_info %></span>',\n            '</div>',\n        '<% } %>'\n    ], 'dataset' );\n    summaryTemplates[ STATES.NEW ] = BASE_MVC.wrapTemplate([\n        '<div>', _l( 'This is a new dataset and not all of its data are available yet' ), '</div>'\n    ], 'dataset' );\n    summaryTemplates[ STATES.NOT_VIEWABLE ] = BASE_MVC.wrapTemplate([\n        '<div>', _l( 'You do not have permission to view this dataset' ), '</div>'\n    ], 'dataset' );\n    summaryTemplates[ STATES.DISCARDED ] = BASE_MVC.wrapTemplate([\n        '<div>', _l( 'The job creating this dataset was cancelled before completion' ), '</div>'\n    ], 'dataset' );\n    summaryTemplates[ STATES.QUEUED ] = BASE_MVC.wrapTemplate([\n        '<div>', _l( 'This job is waiting to run' ), '</div>'\n    ], 'dataset' );\n    summaryTemplates[ STATES.RUNNING ] = BASE_MVC.wrapTemplate([\n        '<div>', _l( 'This job is currently running' ), '</div>'\n    ], 'dataset' );\n    summaryTemplates[ STATES.UPLOAD ] = BASE_MVC.wrapTemplate([\n        '<div>', _l( 'This dataset is currently uploading' ), '</div>'\n    ], 'dataset' );\n    summaryTemplates[ STATES.SETTING_METADATA ] = BASE_MVC.wrapTemplate([\n        '<div>', _l( 'Metadata is being auto-detected' ), '</div>'\n    ], 'dataset' );\n    summaryTemplates[ STATES.PAUSED ] = BASE_MVC.wrapTemplate([\n        '<div>', _l( 'This job is paused. Use the \"Resume Paused Jobs\" in the history menu to resume' ), '</div>'\n    ], 'dataset' );\n    summaryTemplates[ STATES.ERROR ] = BASE_MVC.wrapTemplate([\n        '<% if( !dataset.purged ){ %>',\n            '<div><%- dataset.misc_blurb %></div>',\n        '<% } %>',\n        '<span class=\"help-text\">', _l( 'An error occurred with this dataset' ), ':</span>',\n        '<div class=\"job-error-text\"><%- dataset.misc_info %></div>'\n    ], 'dataset' );\n    summaryTemplates[ STATES.EMPTY ] = BASE_MVC.wrapTemplate([\n        '<div>', _l( 'No data' ), ': <i><%- dataset.misc_blurb %></i></div>'\n    ], 'dataset' );\n    summaryTemplates.unknown = BASE_MVC.wrapTemplate([\n        '<div>Error: unknown dataset state: \"<%- dataset.state %>\"</div>'\n    ], 'dataset' );\n\n    // messages to be displayed only within the details section ('below the fold')\n    var detailMessageTemplates = {\n        resubmitted : BASE_MVC.wrapTemplate([\n            // deleted not purged\n            '<% if( model.resubmitted ){ %>',\n                '<div class=\"resubmitted-msg infomessagesmall\">',\n                    _l( 'The job creating this dataset has been resubmitted' ),\n                '</div>',\n            '<% } %>'\n        ])\n    };\n\n    // this is applied to both old and new style display apps\n    var displayApplicationsTemplate = BASE_MVC.wrapTemplate([\n        '<% _.each( apps, function( app ){ %>',\n            '<div class=\"display-application\">',\n                '<span class=\"display-application-location\"><%- app.label %></span> ',\n                '<span class=\"display-application-links\">',\n                    '<% _.each( app.links, function( link ){ %>',\n                        '<a target=\"<%- link.target %>\" href=\"<%- link.href %>\">',\n                            '<% print( _l( link.text ) ); %>',\n                        '</a> ',\n                    '<% }); %>',\n                '</span>',\n            '</div>',\n        '<% }); %>'\n    ], 'apps' );\n\n    return _.extend( {}, _super.prototype.templates, {\n        warnings    : warnings,\n        details     : detailsTemplate,\n        noAccess    : noAccessTemplate,\n        summaries   : summaryTemplates,\n        detailMessages      : detailMessageTemplates,\n        displayApplications : displayApplicationsTemplate\n    });\n}());\n\n\n// ============================================================================\n    return {\n        DatasetListItemView : DatasetListItemView\n    };\n});\n"]}