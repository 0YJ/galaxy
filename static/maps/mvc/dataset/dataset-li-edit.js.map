{"version":3,"sources":["mvc/dataset/dataset-li-edit.js"],"names":["define","STATES","DATASET_LI","TAGS","ANNOTATIONS","faIconButton","BASE_MVC","_l","_super","DatasetListItemView","prototype","initialize","purgeAllowed","call","this","attributes","hasUser","tagsEditorShown","_renderPrimaryActions","annotationEditorShown","actions","model","get","NOT_VIEWABLE","concat","_renderEditButton","_renderDeleteButton","deleted","href","Galaxy","root","DISCARDED","faIcon","classes","purged","editBtnData","disabled","title","id","_","contains","UPLOAD","NEW","deletedAlready","self","isDeletedOrPurged","onclick","$el","find","trigger","$details","_renderDetails","_setUpBehaviors","state","OK","FAILED_METADATA","_renderTags","_renderAnnotation","_makeDbkeyEditLink","helpString","datasetID","dataset_id","creating_job","data","parseToolID","help","$","name","url","parseToolBuild","append","parseHTML","user","ajax","tool_id","done","divString","length","toggle","jobID","fail","_renderSecondaryActions","ERROR","_renderErrButton","unshift","_renderRerunButton","_renderToolHelpButton","ev","preventDefault","urls","rerun","target","linkTarget","_renderVisualizationsButton","visualizations","push","job_id","$visualizations","templates","hasData","isEmpty","_addScratchBookFn","isObject","warn","frame","attr","addBack","$links","click","active","add","view","tagsEditor","onshow","$where","onhide","TagsEditor","el","$activator","render","appendTo","annotationEditor","onshowFirstTime","editableDbkey","edit","replaceWith","events","extend","clone","click .undelete-link","click .purge-link","click .edit-btn","click .rerun-btn","click .report-err-btn","click .visualization-btn","click .dbkey a","_clickUndeleteLink","undelete","_clickPurgeLink","confirm","purge","toString","DatasetListItemEdit","warnings","failed_metadata","wrapTemplate","modelString","visualizationsTemplate"],"mappings":"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","file":"../../../scripts/mvc/dataset/dataset-li-edit.js","sourcesContent":["define([\n    \"mvc/dataset/states\",\n    \"mvc/dataset/dataset-li\",\n    \"mvc/tag\",\n    \"mvc/annotation\",\n    \"ui/fa-icon-button\",\n    \"mvc/base-mvc\",\n    \"utils/localization\"\n], function( STATES, DATASET_LI, TAGS, ANNOTATIONS, faIconButton, BASE_MVC, _l ){\n\n'use strict';\n//==============================================================================\nvar _super = DATASET_LI.DatasetListItemView;\n/** @class Editing view for DatasetAssociation.\n */\nvar DatasetListItemEdit = _super.extend(\n/** @lends DatasetListItemEdit.prototype */{\n\n    /** set up: options */\n    initialize  : function( attributes ){\n        _super.prototype.initialize.call( this, attributes );\n        this.hasUser = attributes.hasUser;\n\n        /** allow user purge of dataset files? */\n        this.purgeAllowed = attributes.purgeAllowed || false;\n\n        //TODO: move to HiddenUntilActivatedViewMixin\n        /** should the tags editor be shown or hidden initially? */\n        this.tagsEditorShown        = attributes.tagsEditorShown || false;\n        /** should the tags editor be shown or hidden initially? */\n        this.annotationEditorShown  = attributes.annotationEditorShown || false;\n    },\n\n    // ......................................................................... titlebar actions\n    /** In this override, add the other two primary actions: edit and delete */\n    _renderPrimaryActions : function(){\n        var actions = _super.prototype._renderPrimaryActions.call( this );\n        if( this.model.get( 'state' ) === STATES.NOT_VIEWABLE ){\n            return actions;\n        }\n        // render the display, edit attr and delete icon-buttons\n        return _super.prototype._renderPrimaryActions.call( this ).concat([\n            this._renderEditButton(),\n            this._renderDeleteButton()\n        ]);\n    },\n\n    //TODO: move titleButtons into state renderers, remove state checks in the buttons\n\n    /** Render icon-button to edit the attributes (format, permissions, etc.) this dataset. */\n    _renderEditButton : function(){\n        // don't show edit while uploading, in-accessible\n        // DO show if in error (ala previous history panel)\n        if( ( this.model.get( 'state' ) === STATES.DISCARDED )\n        ||  ( !this.model.get( 'accessible' ) ) ){\n            return null;\n        }\n\n        var purged = this.model.get( 'purged' ),\n            deleted = this.model.get( 'deleted' ),\n            editBtnData = {\n                title       : _l( 'Edit attributes' ),\n                href        : Galaxy.root + 'datasets/edit?dataset_id=' + this.model.attributes.id,\n                faIcon      : 'fa-pencil',\n                classes     : 'edit-btn'\n            };\n        // disable if purged or deleted and explain why in the tooltip\n        if( deleted || purged ){\n            editBtnData.disabled = true;\n            if( purged ){\n                editBtnData.title = _l( 'Cannot edit attributes of datasets removed from disk' );\n            } else if( deleted ){\n                editBtnData.title = _l( 'Undelete dataset to edit attributes' );\n            }\n\n        // disable if still uploading or new\n        } else if( _.contains( [ STATES.UPLOAD, STATES.NEW ], this.model.get( 'state' ) ) ){\n            editBtnData.disabled = true;\n            editBtnData.title = _l( 'This dataset is not yet editable' );\n        }\n        return faIconButton( editBtnData );\n    },\n\n    /** Render icon-button to delete this hda. */\n    _renderDeleteButton : function(){\n        // don't show delete if...\n        if( ( !this.model.get( 'accessible' ) ) ){\n            return null;\n        }\n\n        var self = this,\n            deletedAlready = this.model.isDeletedOrPurged();\n        return faIconButton({\n                title       : !deletedAlready? _l( 'Delete' ) : _l( 'Dataset is already deleted' ),\n                disabled    : deletedAlready,\n                faIcon      : 'fa-times',\n                classes     : 'delete-btn',\n                onclick     : function() {\n                    // ...bler... tooltips being left behind in DOM (hover out never called on deletion)\n                    self.$el.find( '.icon-btn.delete-btn' ).trigger( 'mouseout' );\n                    self.model[ 'delete' ]();\n                }\n        });\n    },\n\n    // ......................................................................... details\n    /** In this override, add tags and annotations controls, make the ? dbkey a link to editing page */\n    _renderDetails : function(){\n        //TODO: generalize to be allow different details for each state\n        var $details = _super.prototype._renderDetails.call( this ),\n            state = this.model.get( 'state' );\n\n        if( !this.model.isDeletedOrPurged() && _.contains([ STATES.OK, STATES.FAILED_METADATA ], state ) ){\n            this._renderTags( $details );\n            this._renderAnnotation( $details );\n            this._makeDbkeyEditLink( $details );\n        }\n\n        this._setUpBehaviors( $details );\n        return $details;\n    },\n\n    /**************************************************************************\n     * Render help button to show tool help text without rerunning the tool.\n     * Issue #2100\n     */\n    _renderToolHelpButton : function() {\n        var datasetID = this.model.attributes.dataset_id;\n        var jobID = this.model.attributes.creating_job;\n        var self = this;\n\n        var parseToolBuild = function(data) {\n            var helpString = '<div id=\"thdiv-' + datasetID + '\" class=\"toolhelp\">'\n            if (data.name && data.help){\n                helpString += '<strong>Tool help for ' + data.name + '</strong><hr/>';\n                helpString += data.help;\n            } else {\n                helpString += '<strong>Tool help is unavailable for this dataset.</strong><hr/>';\n            }\n            helpString += '</div>';\n            self.$el.find( '.details' ).append($.parseHTML(helpString));\n        };\n        var parseToolID = function(data) {\n            $.ajax({\n                url: Galaxy.root + 'api/tools/' + data.tool_id + '/build'\n            }).done(function(data){\n                parseToolBuild(data);\n            }).fail(function(){\n                parseToolBuild({})\n            });\n        };\n        if (Galaxy.user.id === null){\n            return null\n        }\n        return faIconButton({\n            title: _l('Tool Help'),\n            classes: 'icon-btn',\n            href: '#',\n            faIcon: 'fa-question',\n            onclick: function() {\n                var divString = 'thdiv-' + datasetID;\n                if (self.$el.find(\".toolhelp\").length > 0){\n                    self.$el.find(\".toolhelp\").toggle();\n                } else {\n                    $.ajax({\n                        url: Galaxy.root + 'api/jobs/' + jobID\n                    }).done(function(data){\n                        parseToolID(data);\n                    }).fail(function(){\n                       console.log('Failed at recovering job information from the  Galaxy API for job id \"' + jobID + '\".');\n                    });\n                }\n            }\n        });\n    },\n    //*************************************************************************\n\n    /** Add less commonly used actions in the details section based on state */\n    _renderSecondaryActions : function(){\n        var actions = _super.prototype._renderSecondaryActions.call( this );\n        switch( this.model.get( 'state' ) ){\n            case STATES.UPLOAD:\n            case STATES.NOT_VIEWABLE:\n                return actions;\n            case STATES.ERROR:\n                // error button comes first\n                actions.unshift( this._renderErrButton() );\n                return actions.concat([ this._renderRerunButton(), this._renderToolHelpButton() ]);\n            case STATES.OK:\n            case STATES.FAILED_METADATA:\n                return actions.concat([ this._renderRerunButton(), this._renderVisualizationsButton(), this._renderToolHelpButton() ]);\n        }\n        return actions.concat([ this._renderRerunButton(), this._renderToolHelpButton() ]);\n    },\n\n    /** Render icon-button to report an error on this dataset to the galaxy admin. */\n    _renderErrButton : function(){\n        return faIconButton({\n            title       : _l( 'View or report this error' ),\n            href        : Galaxy.root + 'datasets/error?dataset_id=' + this.model.attributes.id,\n            classes     : 'report-error-btn',\n            faIcon      : 'fa-bug'\n        });\n    },\n\n    /** Render icon-button to re-run the job that created this dataset. */\n    _renderRerunButton : function(){\n        var creating_job = this.model.get( 'creating_job' );\n        if( this.model.get( 'rerunnable' ) ){\n            return faIconButton({\n                title       : _l( 'Run this job again' ),\n                href        : this.model.urls.rerun,\n                classes     : 'rerun-btn',\n                target      : this.linkTarget,\n                faIcon      : 'fa-refresh',\n                onclick     : function( ev ) {\n                    ev.preventDefault();\n                    Galaxy.router.push( '/', { job_id : creating_job } );\n                }\n            });\n        }\n    },\n\n    /** Render an icon-button or popupmenu of links based on the applicable visualizations */\n    _renderVisualizationsButton : function(){\n        //TODO: someday - lazyload visualizations\n        var visualizations = this.model.get( 'visualizations' );\n        if( ( this.model.isDeletedOrPurged() )\n        ||  ( !this.hasUser )\n        ||  ( !this.model.hasData() )\n        ||  ( _.isEmpty( visualizations ) ) ){\n            return null;\n        }\n        if( !_.isObject( visualizations[0] ) ){\n            this.warn( 'Visualizations have been switched off' );\n            return null;\n        }\n\n        var $visualizations = $( this.templates.visualizations( visualizations, this ) );\n        //HACK: need to re-write those directed at galaxy_main with linkTarget\n        $visualizations.find( '[target=\"galaxy_main\"]').attr( 'target', this.linkTarget );\n        // use addBack here to include the root $visualizations elem (for the case of 1 visualization)\n        this._addScratchBookFn( $visualizations.find( '.visualization-link' ).addBack( '.visualization-link' ) );\n        return $visualizations;\n    },\n\n    /** add scratchbook functionality to visualization links */\n    _addScratchBookFn : function( $links ){\n        var li = this;\n        $links.click( function( ev ){\n            if( Galaxy.frame && Galaxy.frame.active ){\n                Galaxy.frame.add({\n                    title       : 'Visualization',\n                    url         : $( this ).attr( 'href' )\n                });\n                ev.preventDefault();\n                ev.stopPropagation();\n            }\n        });\n    },\n\n    //TODO: if possible move these to readonly view - but display the owner's tags/annotation (no edit)\n    /** Render the tags list/control */\n    _renderTags : function( $where ){\n        if( !this.hasUser ){ return; }\n        var view = this;\n        this.tagsEditor = new TAGS.TagsEditor({\n            model           : this.model,\n            el              : $where.find( '.tags-display' ),\n            onshowFirstTime : function(){ this.render(); },\n            // persist state on the hda view (and not the editor) since these are currently re-created each time\n            onshow          : function(){ view.tagsEditorShown = true; },\n            onhide          : function(){ view.tagsEditorShown = false; },\n            $activator      : faIconButton({\n                title   : _l( 'Edit dataset tags' ),\n                classes : 'tag-btn',\n                faIcon  : 'fa-tags'\n            }).appendTo( $where.find( '.actions .right' ) )\n        });\n        if( this.tagsEditorShown ){ this.tagsEditor.toggle( true ); }\n    },\n\n    /** Render the annotation display/control */\n    _renderAnnotation : function( $where ){\n        if( !this.hasUser ){ return; }\n        var view = this;\n        this.annotationEditor = new ANNOTATIONS.AnnotationEditor({\n            model           : this.model,\n            el              : $where.find( '.annotation-display' ),\n            onshowFirstTime : function(){ this.render(); },\n            // persist state on the hda view (and not the editor) since these are currently re-created each time\n            onshow          : function(){ view.annotationEditorShown = true; },\n            onhide          : function(){ view.annotationEditorShown = false; },\n            $activator      : faIconButton({\n                title   : _l( 'Edit dataset annotation' ),\n                classes : 'annotate-btn',\n                faIcon  : 'fa-comment'\n            }).appendTo( $where.find( '.actions .right' ) )\n        });\n        if( this.annotationEditorShown ){ this.annotationEditor.toggle( true ); }\n    },\n\n    /** If the format/dbkey/genome_build isn't set, make the display a link to the edit page */\n    _makeDbkeyEditLink : function( $details ){\n        // make the dbkey a link to editing\n        if( this.model.get( 'metadata_dbkey' ) === '?'\n        &&  !this.model.isDeletedOrPurged() ){\n            var editableDbkey = $( '<a class=\"value\">?</a>' )\n                .attr( 'href', this.model.urls.edit )\n                .attr( 'target', 'top' );\n            $details.find( '.dbkey .value' ).replaceWith( editableDbkey );\n        }\n    },\n\n    // ......................................................................... events\n    /** event map */\n    events : _.extend( _.clone( _super.prototype.events ), {\n        'click .undelete-link'  : '_clickUndeleteLink',\n        'click .purge-link'     : '_clickPurgeLink',\n\n        'click .edit-btn'       : function( ev ){ this.trigger( 'edit', this, ev ); },\n        'click .delete-btn'     : function( ev ){ this.trigger( 'delete', this, ev ); },\n        'click .rerun-btn'      : function( ev ){ this.trigger( 'rerun', this, ev ); },\n        'click .report-err-btn' : function( ev ){ this.trigger( 'report-err', this, ev ); },\n        'click .visualization-btn' : function( ev ){ this.trigger( 'visualize', this, ev ); },\n        'click .dbkey a'        : function( ev ){ this.trigger( 'edit', this, ev ); }\n    }),\n\n    /** listener for item undelete (in the messages section) */\n    _clickUndeleteLink : function( ev ){\n        this.model.undelete();\n        return false;\n    },\n\n    /** listener for item purge (in the messages section) */\n    _clickPurgeLink : function( ev ){\n        if( confirm( _l( 'This will permanently remove the data in your dataset. Are you sure?' ) ) ){\n            this.model.purge();\n        }\n        return false;\n    },\n\n    // ......................................................................... misc\n    /** string rep */\n    toString : function(){\n        var modelString = ( this.model )?( this.model + '' ):( '(no model)' );\n        return 'HDAEditView(' + modelString + ')';\n    }\n});\n\n\n// ............................................................................ TEMPLATES\n/** underscore templates */\nDatasetListItemEdit.prototype.templates = (function(){\n\n    var warnings = _.extend( {}, _super.prototype.templates.warnings, {\n        failed_metadata : BASE_MVC.wrapTemplate([\n            // in this override, provide a link to the edit page\n            '<% if( dataset.state === \"failed_metadata\" ){ %>',\n                '<div class=\"failed_metadata-warning warningmessagesmall\">',\n                    _l( 'An error occurred setting the metadata for this dataset' ),\n                    '<br /><a href=\"<%- dataset.urls.edit %>\" target=\"top\">',\n                        _l( 'Set it manually or retry auto-detection' ),\n                    '</a>',\n                '</div>',\n            '<% } %>'\n        ], 'dataset' ),\n\n        deleted : BASE_MVC.wrapTemplate([\n            // in this override, provide links to undelete or purge the dataset\n            '<% if( dataset.deleted && !dataset.purged ){ %>',\n                // deleted not purged\n                '<div class=\"deleted-msg warningmessagesmall\">',\n                    _l( 'This dataset has been deleted' ),\n                    '<br /><a class=\"undelete-link\" href=\"javascript:void(0);\">', _l( 'Undelete it' ), '</a>',\n                    '<% if( view.purgeAllowed ){ %>',\n                        '<br /><a class=\"purge-link\" href=\"javascript:void(0);\">',\n                            _l( 'Permanently remove it from disk' ),\n                        '</a>',\n                    '<% } %>',\n                '</div>',\n            '<% } %>'\n        ], 'dataset' )\n    });\n\n    var visualizationsTemplate = BASE_MVC.wrapTemplate([\n        '<% if( visualizations.length === 1 ){ %>',\n            '<a class=\"visualization-link icon-btn\" href=\"<%- visualizations[0].href %>\"',\n                    ' target=\"<%- visualizations[0].target %>\" title=\"', _l( 'Visualize in' ),\n                    ' <%- visualizations[0].html %>\">',\n                '<span class=\"fa fa-bar-chart-o\"></span>',\n            '</a>',\n\n        '<% } else { %>',\n            '<div class=\"visualizations-dropdown dropdown icon-btn\">',\n                '<a data-toggle=\"dropdown\" title=\"', _l( 'Visualize' ), '\">',\n                    '<span class=\"fa fa-bar-chart-o\"></span>',\n                '</a>',\n                '<ul class=\"dropdown-menu\" role=\"menu\">',\n                    '<% _.each( visualizations, function( visualization ){ %>',\n                        '<li><a class=\"visualization-link\" href=\"<%- visualization.href %>\"',\n                                ' target=\"<%- visualization.target %>\">',\n                            '<%- visualization.html %>',\n                        '</a></li>',\n                    '<% }); %>',\n                '</ul>',\n            '</div>',\n        '<% } %>'\n    ], 'visualizations' );\n\n    return _.extend( {}, _super.prototype.templates, {\n        warnings : warnings,\n        visualizations : visualizationsTemplate\n    });\n}());\n\n\n//==============================================================================\n    return {\n        DatasetListItemEdit : DatasetListItemEdit\n    };\n});\n"]}