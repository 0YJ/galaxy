{"version":3,"sources":["mvc/citation/citation-view.js"],"names":["CitationView","Backbone","View","extend","tagName","className","render","this","$el","append","formattedReference","model","entryType","fields","ref","authorsAndYear","_asSentence","author","year","title","pages","address","volume","number","journal","booktitle","howpublished","note","institution","doiUrl","type","url","_formatBookInfo","info","doi","publisher","str","series","CitationListView","initialize","collection","trim","citationView","el","renderCitation","events","click .citations-to-bibtex","click .citations-to-formatted","showBibtex","citation","show","$","hide","rawTextarea","val","select","content","citationsElement","each","item","showFormatted","partialWarningElement","partial","join","_localization2","default"],"mappings":"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","file":"../../../scripts/mvc/citation/citation-view.js","sourcesContent":["import baseMVC from \"mvc/base-mvc\";\nimport citationModel from \"mvc/citation/citation-model\";\nimport _l from \"utils/localization\";\nvar CitationView = Backbone.View.extend({\n    tagName: \"div\",\n    className: \"citations\",\n    render: function() {\n        this.$el.append(`<p>${this.formattedReference()}</p>`);\n        return this;\n    },\n    formattedReference: function() {\n        var model = this.model;\n        var entryType = model.entryType();\n        var fields = model.fields();\n\n        var ref = \"\";\n        // Code inspired by...\n        // https://github.com/vkaravir/bib-publication-list/blob/master/src/bib-publication-list.js\n        var authorsAndYear = `${this._asSentence(\n            (fields.author ? fields.author : \"\") +\n                (fields.year ? ` (${fields.year})` : \"\")\n        )} `;\n        var title = fields.title || \"\";\n        var pages = fields.pages ? `pp. ${fields.pages}` : \"\";\n        var address = fields.address;\n        if (entryType == \"article\") {\n            var volume =\n                (fields.volume ? fields.volume : \"\") +\n                (fields.number ? ` (${fields.number})` : \"\") +\n                (pages ? `, ${pages}` : \"\");\n            ref = `${authorsAndYear +\n                this._asSentence(title) +\n                (fields.journal ? `In <em>${fields.journal}, ` : \"\") +\n                this._asSentence(volume) +\n                this._asSentence(fields.address)}</em>`;\n        } else if (entryType == \"inproceedings\" || entryType == \"proceedings\") {\n            ref = `${authorsAndYear +\n                this._asSentence(title) +\n                (fields.booktitle ? `In <em>${fields.booktitle}, ` : \"\") +\n                (pages ? pages : \"\") +\n                (address ? `, ${address}` : \"\")}.</em>`;\n        } else if (entryType == \"mastersthesis\" || entryType == \"phdthesis\") {\n            ref =\n                authorsAndYear +\n                this._asSentence(title) +\n                (fields.howpublished ? `${fields.howpublished}. ` : \"\") +\n                (fields.note ? `${fields.note}.` : \"\");\n        } else if (entryType == \"techreport\") {\n            ref =\n                authorsAndYear +\n                this._asSentence(title) +\n                this._asSentence(fields.institution) +\n                this._asSentence(fields.number) +\n                this._asSentence(fields.type);\n        } else if (\n            entryType == \"book\" ||\n            entryType == \"inbook\" ||\n            entryType == \"incollection\"\n        ) {\n            ref = `${authorsAndYear} ${this._formatBookInfo(fields)}`;\n        } else {\n            ref = `${authorsAndYear} ${this._asSentence(\n                title\n            )}${this._asSentence(fields.howpublished)}${this._asSentence(\n                fields.note\n            )}`;\n        }\n        var doiUrl = \"\";\n        if (fields.doi) {\n            doiUrl = `http://dx.doi.org/${fields.doi}`;\n            ref += `[<a href=\"${doiUrl}\" target=\"_blank\">doi:${fields.doi}</a>]`;\n        }\n        var url = fields.url || doiUrl;\n        if (url) {\n            ref += `[<a href=\"${url}\" target=\"_blank\">Link</a>]`;\n        }\n        return ref;\n    },\n    _formatBookInfo: function(fields) {\n        var info = \"\";\n        if (fields.chapter) {\n            info += `${fields.chapter} in `;\n        }\n        if (fields.title) {\n            info += `<em>${fields.title}</em>`;\n        }\n        if (fields.editor) {\n            info += `, Edited by ${fields.editor}, `;\n        }\n        if (fields.publisher) {\n            info += `, ${fields.publisher}`;\n        }\n        if (fields.pages) {\n            info += `, pp. ${fields.pages}`;\n        }\n        if (fields.series) {\n            info += `, <em>${fields.series}</em>`;\n        }\n        if (fields.volume) {\n            info += `, Vol.${fields.volume}`;\n        }\n        if (fields.issn) {\n            info += `, ISBN: ${fields.issn}`;\n        }\n        return `${info}.`;\n    },\n    _asSentence: function(str) {\n        return str && str.trim() ? `${str}. ` : \"\";\n    }\n});\n\nvar CitationListView = Backbone.View.extend({\n    el: \"#citations\",\n    /**\n     * Set up view.\n     */\n    initialize: function() {\n        this.listenTo(this.collection, \"add\", this.renderCitation);\n    },\n\n    events: {\n        \"click .citations-to-bibtex\": \"showBibtex\",\n        \"click .citations-to-formatted\": \"showFormatted\"\n    },\n\n    renderCitation: function(citation) {\n        var citationView = new CitationView({ model: citation });\n        this.$(\".citations-formatted\").append(citationView.render().el);\n        var rawTextarea = this.$(\".citations-bibtex-text\");\n        rawTextarea.val(\n            `${rawTextarea.val()}\\n\\r${citation.attributes.content}`\n        );\n    },\n\n    render: function() {\n        this.$el.html(this.citationsElement());\n        this.collection.each(function(item) {\n            this.renderCitation(item);\n        }, this);\n        this.showFormatted();\n    },\n\n    showBibtex: function() {\n        this.$(\".citations-to-formatted\").show();\n        this.$(\".citations-to-bibtex\").hide();\n        this.$(\".citations-bibtex\").show();\n        this.$(\".citations-formatted\").hide();\n        this.$(\".citations-bibtex-text\").select();\n    },\n\n    showFormatted: function() {\n        this.$(\".citations-to-formatted\").hide();\n        this.$(\".citations-to-bibtex\").show();\n        this.$(\".citations-bibtex\").hide();\n        this.$(\".citations-formatted\").show();\n    },\n\n    partialWarningElement: function() {\n        if (this.collection.partial) {\n            return [\n                '<div style=\"padding:5px 10px\">',\n                \"<b>Warning: This is a experimental feature.</b> Most Galaxy tools will not annotate\",\n                \" citations explicitly at this time. When writing up your analysis, please manually\",\n                \" review your histories and find all references\",\n                \" that should be cited in order to completely describe your work. Also, please remember to\",\n                ' <a href=\"https://galaxyproject.org/citing-galaxy\">cite Galaxy</a>.',\n                \"</div>\"\n            ].join(\"\");\n        } else {\n            return \"\";\n        }\n    },\n\n    citationsElement: function() {\n        return [\n            '<div class=\"toolForm\">',\n            '<div class=\"toolFormTitle\">',\n            _l(\"Citations\"),\n            ' <button type=\"button\" class=\"btn btn-xs citations-to-bibtex\" title=\"Show all in BibTeX format.\"><i class=\"fa fa-pencil-square-o\"></i> Show BibTeX</button>',\n            ' <button type=\"button\" class=\"btn btn-xs citations-to-formatted\" title=\"Return to formatted citation list.\"><i class=\"fa fa-times\"></i> Hide BibTeX</button>',\n            \"</div>\",\n            '<div class=\"toolFormBody\" style=\"padding:5px 10px\">',\n            this.partialWarningElement(),\n            '<span class=\"citations-formatted\" style=\"word-wrap: break-word;\"></span>',\n            \"</div>\",\n            '<div class=\"citations-bibtex toolFormBody\" style=\"padding:5px 10px\">',\n            '<textarea style=\"width: 100%; height: 500px;\" class=\"citations-bibtex-text\"></textarea>',\n            \"</div>\",\n            \"</div>\"\n        ].join(\"\");\n    }\n});\n\n//==============================================================================\nexport default {\n    CitationView: CitationView,\n    CitationListView: CitationListView\n};\n"]}