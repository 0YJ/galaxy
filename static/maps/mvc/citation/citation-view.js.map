{"version":3,"sources":["mvc/citation/citation-view.js"],"names":["define","baseMVC","citationModel","_l","CitationView","Backbone","View","extend","tagName","className","render","$el","append","this","formattedReference","model","entryType","ref","authorsAndYear","title","fields","author","pages","address","volume","_asSentence","journal","doiUrl","doi","url","booktitle","info","chapter","publisher","howpublished","note","institution","type","_formatBookInfo","CitationListView","initialize","renderCitation","rawTextarea","citationView","html","collection","each","showFormatted","editor","showBibtex","series","issn","partialWarningElement","str","trim","el","events","click .citations-to-bibtex","click .citations-to-formatted","citation","$","val","attributes","content","citationsElement","item","show","hide","select","partial","join"],"mappings":"kCAAAA,QACK,eAAgB,8BAA+B,sBAChD,SAASC,EAASC,EAAeC,GAFrCH,IACKI,EAADC,SAAiBC,KAAAC,QAETH,QAAAA,MACAI,UAAS,YACTC,OAAAA,WAEI,OADJC,KAAQC,IAAAC,OAAA,MAAWC,KAAAC,qBAAA,QACVH,MAERG,mBANmC,WAOpCA,IAAAA,EAAAA,KAAoBC,MACZA,EAAQA,EAAZC,YACIA,EAAAA,EAAYD,SAGZE,EAAM,GAEVC,EACIA,KAAAA,aAKAC,EAAQC,OAAAA,EAAZC,OAAA,KACYD,EAAOE,KAAQ,KAAAF,EAASA,KAAxB,IAAZ,KACIG,IACAP,EAAAA,EAAaG,OAAW,GACxBG,EAAIE,EACCJ,MAAOI,OAASJ,EAAOI,MAAS,GAGrCP,EACIC,EAAAA,QAQP,GACGF,WAfJA,EAeiB,CAGbC,IAAAA,GASGG,EACHJ,OAAaI,EAAAI,OAAb,KAGAP,EACIC,OAAAA,KACKO,EAAAA,OAAYN,IAChBC,KAIFE,EAAIN,KAAaM,EAAA,IACpBL,EAMGC,EAKHD,KAAMC,YAAAA,IACHE,EAAAM,QAECR,UAAAA,EAEAQ,QAAKD,KAGZ,IACGE,KAASF,YAAbD,GACIJ,KAAOQ,YAAKR,EAAAG,SACZI,aAUAV,EAHH,iBAAAD,GACgBa,eAAbA,EAGHX,EACMD,KAAPQ,YAAAN,IAhGgCC,EAAAU,UAkGnB,UAAAV,EAAAU,UAAA,KACb,KACIV,GAAgB,KAChBW,EAAeC,KAAPT,EAAR,IACH,SAEW,iBAARQ,GACH,aAAAf,EAGAE,EACGE,KAAOa,YAAWd,IAClBY,EAAQG,aACXd,EAAAc,aAAA,KACUZ,KACPS,EAAQI,KAAWf,EAAOE,KAAlB,IAAR,IACH,cAAAN,EAEGe,EACHlB,KAAAY,YAAAN,GACGC,KAAOI,YAAQJ,EAAAgB,aACfL,KAAQN,YAAWL,EAAOI,QAC7BX,KAAAY,YAAAL,EAAAiB,MAEW,QAARN,GACH,UAAAf,GACD,gBAAAA,EAESE,EAAA,IAAAL,KAAcyB,gBAAAlB,GA9H/BF,EA6EgB,IAsDZqB,KAAAA,YAA4BjC,GACxBO,KADoCY,YAAAL,EAAAc,cAExCrB,KAAAY,YAAAL,EAAAe,MAnDI,IAAIR,EAAS,GAsDjBa,EAAYZ,MAL4BX,GA7C5B,cAmDRU,EAAA,qBAAAP,EAA2CqB,KAI3C,yBACArB,EAAAQ,IAXoC,SAcxCa,IAAAA,EAAAA,EAAgBZ,KAAAF,EAIZe,OAHIC,IACJ1B,GAAO,aAAAY,EAAwBjB,+BAE/B8B,GAnDJJ,gBAAiB,SAASlB,GAwD1BV,IAAQqB,EAAA,GAyBA,OAxBJX,EAASwB,UACTb,GAAKc,EAAWC,QAAK,QAElB1B,EAFHD,QAGAY,GAAKgB,OAAL3B,EAAAD,MAAA,SArDIC,EAAO4B,SAwDfC,GAAY,eAAA7B,EAAW4B,OAAA,MAEnB5B,EAAOa,YACPF,GAAO,KAAAX,EAAPa,WAEAb,EAAOE,QApC6BS,GAAA,SAAAX,EAAAE,OAuCxCyB,EAAeG,SACXnB,GAAO,SAAAX,EAAA8B,OAAP,SAEA9B,EAAOI,SACPO,GAAO,SAAAX,EAAPI,QArDIJ,EAAO+B,OAwDfC,GAAAA,WAAuBhC,EAAA+B,MAEfpB,EACI,KASJN,YAAA,SAAA4B,GACH,OAAAA,GAAAA,EAAAC,OAAAD,EAAA,KAAA,MAIDd,EACIlC,SAAAC,KAAAC,QAePgD,GAAA,aAILf,WAAO,WACHpC,KAAAA,SAAcA,KAAAA,WADX,MAAAS,KAAA4B,iBAzNfe,QAgJgBC,6BAA8B,aAC9BC,gCAAiC,iBAGrCjB,eAAgB,SAASkB,GACrB,IAAIhB,EAAe,IAAIvC,GAAeW,MAAO4C,IAC7C9C,KAAK+C,EAAE,wBAAwBhD,OAAO+B,EAAajC,SAAS6C,IAC5D,IAAIb,EAAc7B,KAAK+C,EAAE,0BACzBlB,EAAYmB,IACRnB,EAAYmB,MAAQ,OAASF,EAASG,WAAWC,UAIzDrD,OAAQ,WACJG,KAAKF,IAAIiC,KAAK/B,KAAKmD,oBACnBnD,KAAKgC,WAAWC,KAAK,SAASmB,GAC1BpD,KAAK4B,eAAewB,IACrBpD,MACHA,KAAKkC,iBAGTE,WAAY,WACRpC,KAAK+C,EAAE,2BAA2BM,OAClCrD,KAAK+C,EAAE,wBAAwBO,OAC/BtD,KAAK+C,EAAE,qBAAqBM,OAC5BrD,KAAK+C,EAAE,wBAAwBO,OAC/BtD,KAAK+C,EAAE,0BAA0BQ,UAGrCrB,cAAe,WACXlC,KAAK+C,EAAE,2BAA2BO,OAClCtD,KAAK+C,EAAE,wBAAwBM,OAC/BrD,KAAK+C,EAAE,qBAAqBO,OAC5BtD,KAAK+C,EAAE,wBAAwBM,QAGnCd,sBAAuB,WACnB,OAAIvC,KAAKgC,WAAWwB,SAEZ,iCACA,sFACA,qFACA,iDACA,4FACA,sEACA,UACFC,KAAK,IAEA,IAIfN,iBAAkB,WACd,OACI,yBACA,8BACA7D,EAAG,aACH,8JACA,+JACA,SACA,sDACAU,KAAKuC,wBACL,2EACA,SACA,uEACA,0FACA,SACA,UACFkB,KAAK,OAKf,OACIlE,aAAcA,EACdmC,iBAAkBA","file":"../../../scripts/mvc/citation/citation-view.js","sourcesContent":["define(\n    [\"mvc/base-mvc\", \"mvc/citation/citation-model\", \"utils/localization\"],\n    function(baseMVC, citationModel, _l) {\n        var CitationView = Backbone.View.extend({\n            tagName: \"div\",\n            className: \"citations\",\n            render: function() {\n                this.$el.append(\"<p>\" + this.formattedReference() + \"</p>\");\n                return this;\n            },\n            formattedReference: function() {\n                var model = this.model;\n                var entryType = model.entryType();\n                var fields = model.fields();\n\n                var ref = \"\";\n                // Code inspired by...\n                // https://github.com/vkaravir/bib-publication-list/blob/master/src/bib-publication-list.js\n                var authorsAndYear =\n                    this._asSentence(\n                        (fields.author ? fields.author : \"\") +\n                            (fields.year ? \" (\" + fields.year + \")\" : \"\")\n                    ) + \" \";\n                var title = fields.title || \"\";\n                var pages = fields.pages ? \"pp. \" + fields.pages : \"\";\n                var address = fields.address;\n                if (entryType == \"article\") {\n                    var volume =\n                        (fields.volume ? fields.volume : \"\") +\n                        (fields.number ? \" (\" + fields.number + \")\" : \"\") +\n                        (pages ? \", \" + pages : \"\");\n                    ref =\n                        authorsAndYear +\n                        this._asSentence(title) +\n                        (fields.journal\n                            ? \"In <em>\" + fields.journal + \", \"\n                            : \"\") +\n                        this._asSentence(volume) +\n                        this._asSentence(fields.address) +\n                        \"</em>\";\n                } else if (\n                    entryType == \"inproceedings\" ||\n                    entryType == \"proceedings\"\n                ) {\n                    ref =\n                        authorsAndYear +\n                        this._asSentence(title) +\n                        (fields.booktitle\n                            ? \"In <em>\" + fields.booktitle + \", \"\n                            : \"\") +\n                        (pages ? pages : \"\") +\n                        (address ? \", \" + address : \"\") +\n                        \".</em>\";\n                } else if (\n                    entryType == \"mastersthesis\" ||\n                    entryType == \"phdthesis\"\n                ) {\n                    ref =\n                        authorsAndYear +\n                        this._asSentence(title) +\n                        (fields.howpublished\n                            ? fields.howpublished + \". \"\n                            : \"\") +\n                        (fields.note ? fields.note + \".\" : \"\");\n                } else if (entryType == \"techreport\") {\n                    ref =\n                        authorsAndYear +\n                        this._asSentence(title) +\n                        this._asSentence(fields.institution) +\n                        this._asSentence(fields.number) +\n                        this._asSentence(fields.type);\n                } else if (\n                    entryType == \"book\" ||\n                    entryType == \"inbook\" ||\n                    entryType == \"incollection\"\n                ) {\n                    ref = authorsAndYear + \" \" + this._formatBookInfo(fields);\n                } else {\n                    ref =\n                        authorsAndYear +\n                        \" \" +\n                        this._asSentence(title) +\n                        this._asSentence(fields.howpublished) +\n                        this._asSentence(fields.note);\n                }\n                var doiUrl = \"\";\n                if (fields.doi) {\n                    doiUrl = \"http://dx.doi.org/\" + fields.doi;\n                    ref +=\n                        '[<a href=\"' +\n                        doiUrl +\n                        '\" target=\"_blank\">doi:' +\n                        fields.doi +\n                        \"</a>]\";\n                }\n                var url = fields.url || doiUrl;\n                if (url) {\n                    ref += '[<a href=\"' + url + '\" target=\"_blank\">Link</a>]';\n                }\n                return ref;\n            },\n            _formatBookInfo: function(fields) {\n                var info = \"\";\n                if (fields.chapter) {\n                    info += fields.chapter + \" in \";\n                }\n                if (fields.title) {\n                    info += \"<em>\" + fields.title + \"</em>\";\n                }\n                if (fields.editor) {\n                    info += \", Edited by \" + fields.editor + \", \";\n                }\n                if (fields.publisher) {\n                    info += \", \" + fields.publisher;\n                }\n                if (fields.pages) {\n                    info += \", pp. \" + fields.pages + \"\";\n                }\n                if (fields.series) {\n                    info += \", <em>\" + fields.series + \"</em>\";\n                }\n                if (fields.volume) {\n                    info += \", Vol.\" + fields.volume;\n                }\n                if (fields.issn) {\n                    info += \", ISBN: \" + fields.issn;\n                }\n                return info + \".\";\n            },\n            _asSentence: function(str) {\n                return str && str.trim() ? str + \". \" : \"\";\n            }\n        });\n\n        var CitationListView = Backbone.View.extend({\n            el: \"#citations\",\n            /**\n     * Set up view.\n     */\n            initialize: function() {\n                this.listenTo(this.collection, \"add\", this.renderCitation);\n            },\n\n            events: {\n                \"click .citations-to-bibtex\": \"showBibtex\",\n                \"click .citations-to-formatted\": \"showFormatted\"\n            },\n\n            renderCitation: function(citation) {\n                var citationView = new CitationView({ model: citation });\n                this.$(\".citations-formatted\").append(citationView.render().el);\n                var rawTextarea = this.$(\".citations-bibtex-text\");\n                rawTextarea.val(\n                    rawTextarea.val() + \"\\n\\r\" + citation.attributes.content\n                );\n            },\n\n            render: function() {\n                this.$el.html(this.citationsElement());\n                this.collection.each(function(item) {\n                    this.renderCitation(item);\n                }, this);\n                this.showFormatted();\n            },\n\n            showBibtex: function() {\n                this.$(\".citations-to-formatted\").show();\n                this.$(\".citations-to-bibtex\").hide();\n                this.$(\".citations-bibtex\").show();\n                this.$(\".citations-formatted\").hide();\n                this.$(\".citations-bibtex-text\").select();\n            },\n\n            showFormatted: function() {\n                this.$(\".citations-to-formatted\").hide();\n                this.$(\".citations-to-bibtex\").show();\n                this.$(\".citations-bibtex\").hide();\n                this.$(\".citations-formatted\").show();\n            },\n\n            partialWarningElement: function() {\n                if (this.collection.partial) {\n                    return [\n                        '<div style=\"padding:5px 10px\">',\n                        \"<b>Warning: This is a experimental feature.</b> Most Galaxy tools will not annotate\",\n                        \" citations explicitly at this time. When writing up your analysis, please manually\",\n                        \" review your histories and find all references\",\n                        \" that should be cited in order to completely describe your work. Also, please remember to\",\n                        ' <a href=\"https://galaxyproject.org/citing-galaxy\">cite Galaxy</a>.',\n                        \"</div>\"\n                    ].join(\"\");\n                } else {\n                    return \"\";\n                }\n            },\n\n            citationsElement: function() {\n                return [\n                    '<div class=\"toolForm\">',\n                    '<div class=\"toolFormTitle\">',\n                    _l(\"Citations\"),\n                    ' <button type=\"button\" class=\"btn btn-xs citations-to-bibtex\" title=\"Show all in BibTeX format.\"><i class=\"fa fa-pencil-square-o\"></i> Show BibTeX</button>',\n                    ' <button type=\"button\" class=\"btn btn-xs citations-to-formatted\" title=\"Return to formatted citation list.\"><i class=\"fa fa-times\"></i> Hide BibTeX</button>',\n                    \"</div>\",\n                    '<div class=\"toolFormBody\" style=\"padding:5px 10px\">',\n                    this.partialWarningElement(),\n                    '<span class=\"citations-formatted\" style=\"word-wrap: break-word;\"></span>',\n                    \"</div>\",\n                    '<div class=\"citations-bibtex toolFormBody\" style=\"padding:5px 10px\">',\n                    '<textarea style=\"width: 100%; height: 500px;\" class=\"citations-bibtex-text\"></textarea>',\n                    \"</div>\",\n                    \"</div>\"\n                ].join(\"\");\n            }\n        });\n\n        //==============================================================================\n        return {\n            CitationView: CitationView,\n            CitationListView: CitationListView\n        };\n    }\n);\n"]}