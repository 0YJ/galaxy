{"version":3,"sources":["mvc/citation/citation-view.js"],"names":["CitationView","Backbone","View","extend","tagName","className","render","this","$el","append","formattedReference","model","entryType","fields","ref","authorsAndYear","author","year","title","pages","address","number","_asSentence","booktitle","howpublished","note","doiUrl","institution","url","type","info","_formatBookInfo","publisher","doi","series","volume","str","editor","initialize","renderCitation","issn","rawTextarea","html","trim","citationsElement","CitationListView","showFormatted","el","listenTo","collection","events","click .citations-to-bibtex","citation","citationView","show","$","partialWarningElement","partial","attributes","content","each","item","showBibtex","hide","select","join","_localization2","default"],"mappings":"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","file":"../../../scripts/mvc/citation/citation-view.js","sourcesContent":["import baseMVC from \"mvc/base-mvc\";\nimport citationModel from \"mvc/citation/citation-model\";\nimport _l from \"utils/localization\";\nvar CitationView = Backbone.View.extend({\n    tagName: \"div\",\n    className: \"citations\",\n    render: function() {\n        this.$el.append(\"<p>\" + this.formattedReference() + \"</p>\");\n        return this;\n    },\n    formattedReference: function() {\n        var model = this.model;\n        var entryType = model.entryType();\n        var fields = model.fields();\n\n        var ref = \"\";\n        // Code inspired by...\n        // https://github.com/vkaravir/bib-publication-list/blob/master/src/bib-publication-list.js\n        var authorsAndYear =\n            this._asSentence(\n                (fields.author ? fields.author : \"\") +\n                    (fields.year ? \" (\" + fields.year + \")\" : \"\")\n            ) + \" \";\n        var title = fields.title || \"\";\n        var pages = fields.pages ? \"pp. \" + fields.pages : \"\";\n        var address = fields.address;\n        if (entryType == \"article\") {\n            var volume =\n                (fields.volume ? fields.volume : \"\") +\n                (fields.number ? \" (\" + fields.number + \")\" : \"\") +\n                (pages ? \", \" + pages : \"\");\n            ref =\n                authorsAndYear +\n                this._asSentence(title) +\n                (fields.journal ? \"In <em>\" + fields.journal + \", \" : \"\") +\n                this._asSentence(volume) +\n                this._asSentence(fields.address) +\n                \"</em>\";\n        } else if (entryType == \"inproceedings\" || entryType == \"proceedings\") {\n            ref =\n                authorsAndYear +\n                this._asSentence(title) +\n                (fields.booktitle ? \"In <em>\" + fields.booktitle + \", \" : \"\") +\n                (pages ? pages : \"\") +\n                (address ? \", \" + address : \"\") +\n                \".</em>\";\n        } else if (entryType == \"mastersthesis\" || entryType == \"phdthesis\") {\n            ref =\n                authorsAndYear +\n                this._asSentence(title) +\n                (fields.howpublished ? fields.howpublished + \". \" : \"\") +\n                (fields.note ? fields.note + \".\" : \"\");\n        } else if (entryType == \"techreport\") {\n            ref =\n                authorsAndYear +\n                this._asSentence(title) +\n                this._asSentence(fields.institution) +\n                this._asSentence(fields.number) +\n                this._asSentence(fields.type);\n        } else if (\n            entryType == \"book\" ||\n            entryType == \"inbook\" ||\n            entryType == \"incollection\"\n        ) {\n            ref = authorsAndYear + \" \" + this._formatBookInfo(fields);\n        } else {\n            ref =\n                authorsAndYear +\n                \" \" +\n                this._asSentence(title) +\n                this._asSentence(fields.howpublished) +\n                this._asSentence(fields.note);\n        }\n        var doiUrl = \"\";\n        if (fields.doi) {\n            doiUrl = \"http://dx.doi.org/\" + fields.doi;\n            ref +=\n                '[<a href=\"' +\n                doiUrl +\n                '\" target=\"_blank\">doi:' +\n                fields.doi +\n                \"</a>]\";\n        }\n        var url = fields.url || doiUrl;\n        if (url) {\n            ref += '[<a href=\"' + url + '\" target=\"_blank\">Link</a>]';\n        }\n        return ref;\n    },\n    _formatBookInfo: function(fields) {\n        var info = \"\";\n        if (fields.chapter) {\n            info += fields.chapter + \" in \";\n        }\n        if (fields.title) {\n            info += \"<em>\" + fields.title + \"</em>\";\n        }\n        if (fields.editor) {\n            info += \", Edited by \" + fields.editor + \", \";\n        }\n        if (fields.publisher) {\n            info += \", \" + fields.publisher;\n        }\n        if (fields.pages) {\n            info += \", pp. \" + fields.pages + \"\";\n        }\n        if (fields.series) {\n            info += \", <em>\" + fields.series + \"</em>\";\n        }\n        if (fields.volume) {\n            info += \", Vol.\" + fields.volume;\n        }\n        if (fields.issn) {\n            info += \", ISBN: \" + fields.issn;\n        }\n        return info + \".\";\n    },\n    _asSentence: function(str) {\n        return str && str.trim() ? str + \". \" : \"\";\n    }\n});\n\nvar CitationListView = Backbone.View.extend({\n    el: \"#citations\",\n    /**\n     * Set up view.\n     */\n    initialize: function() {\n        this.listenTo(this.collection, \"add\", this.renderCitation);\n    },\n\n    events: {\n        \"click .citations-to-bibtex\": \"showBibtex\",\n        \"click .citations-to-formatted\": \"showFormatted\"\n    },\n\n    renderCitation: function(citation) {\n        var citationView = new CitationView({ model: citation });\n        this.$(\".citations-formatted\").append(citationView.render().el);\n        var rawTextarea = this.$(\".citations-bibtex-text\");\n        rawTextarea.val(\n            rawTextarea.val() + \"\\n\\r\" + citation.attributes.content\n        );\n    },\n\n    render: function() {\n        this.$el.html(this.citationsElement());\n        this.collection.each(function(item) {\n            this.renderCitation(item);\n        }, this);\n        this.showFormatted();\n    },\n\n    showBibtex: function() {\n        this.$(\".citations-to-formatted\").show();\n        this.$(\".citations-to-bibtex\").hide();\n        this.$(\".citations-bibtex\").show();\n        this.$(\".citations-formatted\").hide();\n        this.$(\".citations-bibtex-text\").select();\n    },\n\n    showFormatted: function() {\n        this.$(\".citations-to-formatted\").hide();\n        this.$(\".citations-to-bibtex\").show();\n        this.$(\".citations-bibtex\").hide();\n        this.$(\".citations-formatted\").show();\n    },\n\n    partialWarningElement: function() {\n        if (this.collection.partial) {\n            return [\n                '<div style=\"padding:5px 10px\">',\n                \"<b>Warning: This is a experimental feature.</b> Most Galaxy tools will not annotate\",\n                \" citations explicitly at this time. When writing up your analysis, please manually\",\n                \" review your histories and find all references\",\n                \" that should be cited in order to completely describe your work. Also, please remember to\",\n                ' <a href=\"https://galaxyproject.org/citing-galaxy\">cite Galaxy</a>.',\n                \"</div>\"\n            ].join(\"\");\n        } else {\n            return \"\";\n        }\n    },\n\n    citationsElement: function() {\n        return [\n            '<div class=\"toolForm\">',\n            '<div class=\"toolFormTitle\">',\n            _l(\"Citations\"),\n            ' <button type=\"button\" class=\"btn btn-xs citations-to-bibtex\" title=\"Show all in BibTeX format.\"><i class=\"fa fa-pencil-square-o\"></i> Show BibTeX</button>',\n            ' <button type=\"button\" class=\"btn btn-xs citations-to-formatted\" title=\"Return to formatted citation list.\"><i class=\"fa fa-times\"></i> Hide BibTeX</button>',\n            \"</div>\",\n            '<div class=\"toolFormBody\" style=\"padding:5px 10px\">',\n            this.partialWarningElement(),\n            '<span class=\"citations-formatted\" style=\"word-wrap: break-word;\"></span>',\n            \"</div>\",\n            '<div class=\"citations-bibtex toolFormBody\" style=\"padding:5px 10px\">',\n            '<textarea style=\"width: 100%; height: 500px;\" class=\"citations-bibtex-text\"></textarea>',\n            \"</div>\",\n            \"</div>\"\n        ].join(\"\");\n    }\n});\n\n//==============================================================================\nexport default {\n    CitationView: CitationView,\n    CitationListView: CitationListView\n};\n"]}