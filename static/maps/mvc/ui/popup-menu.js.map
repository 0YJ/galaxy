{"version":3,"sources":["mvc/ui/popup-menu.js"],"names":["define","PopupMenu","Backbone","View","extend","initialize","$button","options","this","length","data","menu","click","event","$","remove","_renderAndShow","clickEvent","render","css","_getShownPosition","show","_setUpCloseBehavior","addClass","hide","position","html","$el","attr","find","each","i","li","option","children","func","call","template","id","_templateOptions","join","_","map","divider","header","href","check","checked","target","menuWidth","width","top","pageY","x","Math","min","document","scrollLeft","window","max","closePopup","off","parent","one","contents","err","addItem","index","item","removeItem","findIndexByHtml","splice","has","findItemByHtml","toString","create","make_popupmenu","optionVal","button_element","initial_options","convertedOptions","newOption","optionKey","push","convertLinksToOptions","$parent","selector","$link","text","elem","confirmText","linkTarget","confirm","location","linkHref","$menuElement","$buttonElement","menuElementLinkSelector","make_popup_menus","menuSelector","buttonSelectorBuildFn","popupMenusCreated","fromDom"],"mappings":"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","file":"../../../scripts/mvc/ui/popup-menu.js","sourcesContent":["define([\n    //jquery\n    //backbone\n], function(){\n// =============================================================================\n/**\n * view for a popup menu\n */\nvar PopupMenu = Backbone.View.extend({\n//TODO: maybe better as singleton off the Galaxy obj\n    /** Cache the desired button element and options, set up the button click handler\n     *  NOTE: attaches this view as HTML/jQ data on the button for later use.\n     */\n    initialize: function( $button, options ){\n        // default settings\n        this.$button = $button;\n        if( !this.$button.length ){\n            this.$button = $( '<div/>' );\n        }\n        this.options = options || [];\n        this.$button.data( 'popupmenu', this );\n\n        // set up button click -> open menu behavior\n        var menu = this;\n        this.$button.click( function( event ){\n            // if there's already a menu open, remove it\n            $( '.popmenu-wrapper' ).remove();\n            menu._renderAndShow( event );\n            return false;\n        });\n    },\n\n    // render the menu, append to the page body at the click position, and set up the 'click-away' handlers, show\n    _renderAndShow: function( clickEvent ){\n        this.render();\n        this.$el.appendTo( 'body' ).css( this._getShownPosition( clickEvent )).show();\n        this._setUpCloseBehavior();\n    },\n\n    // render the menu\n    // this menu doesn't attach itself to the DOM ( see _renderAndShow )\n    render: function(){\n        // render the menu body absolute and hidden, fill with template\n        this.$el.addClass( 'popmenu-wrapper' ).hide()\n            .css({ position : 'absolute' })\n            .html( this.template( this.$button.attr( 'id' ), this.options ));\n\n        // set up behavior on each link/anchor elem\n        if( this.options.length ){\n            var menu = this;\n            //precondition: there should be one option per li\n            this.$el.find( 'li' ).each( function( i, li ){\n                var option = menu.options[i];\n\n                // if the option has 'func', call that function when the anchor is clicked\n                if( option.func ){\n                    $( this ).children( 'a.popupmenu-option' ).click( function( event ){\n                        option.func.call( menu, event, option );\n                        // We must preventDefault otherwise clicking \"cancel\"\n                        // on a purge or something still navigates and causes\n                        // the action.\n                        event.preventDefault();\n                        // bubble up so that an option click will call the close behavior\n                    });\n                }\n            });\n        }\n        return this;\n    },\n\n    template : function( id, options ){\n        return [\n            '<ul id=\"', id, '-menu\" class=\"dropdown-menu\">', this._templateOptions( options ), '</ul>'\n        ].join( '' );\n    },\n\n    _templateOptions : function( options ){\n        if( !options.length ){\n            return '<li>(no options)</li>';\n        }\n        return _.map( options, function( option ){\n            if( option.divider ){\n                return '<li class=\"divider\"></li>';\n            } else if( option.header ){\n                return [ '<li class=\"head\"><a href=\"javascript:void(0);\">', option.html, '</a></li>' ].join( '' );\n            }\n            var href   = option.href || 'javascript:void(0);',\n                target = ( option.target  )?( ' target=\"' + option.target + '\"' ):( '' ),\n                check  = ( option.checked )?( '<span class=\"fa fa-check\"></span>' ):( '' );\n            return [\n                '<li><a class=\"popupmenu-option\" href=\"', href, '\"', target, '>',\n                    check, option.html,\n                '</a></li>'\n            ].join( '' );\n        }).join( '' );\n    },\n\n    // get the absolute position/offset for the menu\n    _getShownPosition : function( clickEvent ){\n\n        // display menu horiz. centered on click...\n        var menuWidth = this.$el.width();\n        var x = clickEvent.pageX - menuWidth / 2 ;\n\n        // adjust to handle horiz. scroll and window dimensions ( draw entirely on visible screen area )\n        x = Math.min( x, $( document ).scrollLeft() + $( window ).width() - menuWidth - 5 );\n        x = Math.max( x, $( document ).scrollLeft() + 5 );\n        return {\n            top: clickEvent.pageY,\n            left: x\n        };\n    },\n\n    // bind an event handler to all available frames so that when anything is clicked\n    // the menu is removed from the DOM and the event handler unbinds itself\n    _setUpCloseBehavior: function(){\n        var menu = this;\n//TODO: alternately: focus hack, blocking overlay, jquery.blockui\n\n        // function to close popup and unbind itself\n        function closePopup( event ){\n            $( document ).off( 'click.close_popup' );\n            if( window && window.parent !== window ){\n                try {\n                    $( window.parent.document ).off( \"click.close_popup\" );\n                } catch( err ){}\n            } else {\n                try {\n                    $( 'iframe#galaxy_main' ).contents().off( \"click.close_popup\" );\n                } catch( err ){}\n            }\n            menu.remove();\n        }\n\n        $( 'html' ).one( \"click.close_popup\", closePopup );\n        if( window && window.parent !== window ){\n            try {\n                $( window.parent.document ).find( 'html' ).one( \"click.close_popup\", closePopup );\n            } catch( err ){}\n        } else {\n            try {\n                $( 'iframe#galaxy_main' ).contents().one( \"click.close_popup\", closePopup );\n            } catch( err ){}\n        }\n    },\n\n    // add a menu option/item at the given index\n    addItem: function( item, index ){\n        // append to end if no index\n        index = ( index >= 0 ) ? index : this.options.length;\n        this.options.splice( index, 0, item );\n        return this;\n    },\n\n    // remove a menu option/item at the given index\n    removeItem: function( index ){\n        if( index >=0 ){\n            this.options.splice( index, 1 );\n        }\n        return this;\n    },\n\n    // search for a menu option by its html\n    findIndexByHtml: function( html ){\n        for( var i = 0; i < this.options.length; i++ ){\n            if( _.has( this.options[i], 'html' ) && ( this.options[i].html === html )){\n                return i;\n            }\n        }\n        return null;\n    },\n\n    // search for a menu option by its html\n    findItemByHtml: function( html ){\n        return this.options[( this.findIndexByHtml( html ))];\n    },\n\n    // string representation\n    toString: function(){\n        return 'PopupMenu';\n    }\n});\n/** shortcut to new for when you don't need to preserve the ref */\nPopupMenu.create = function _create( $button, options ){\n    return new PopupMenu( $button, options );\n};\n\n// -----------------------------------------------------------------------------\n// the following class functions are bridges from the original make_popupmenu and make_popup_menus\n// to the newer backbone.js PopupMenu\n\n/** Create a PopupMenu from simple map initial_options activated by clicking button_element.\n *      Converts initial_options to object array used by PopupMenu.\n *  @param {jQuery|DOMElement} button_element element which, when clicked, activates menu\n *  @param {Object} initial_options map of key -> values, where\n *      key is option text, value is fn to call when option is clicked\n *  @returns {PopupMenu} the PopupMenu created\n */\nPopupMenu.make_popupmenu = function( button_element, initial_options ){\n    var convertedOptions = [];\n    _.each( initial_options, function( optionVal, optionKey ){\n        var newOption = { html: optionKey };\n\n        // keys with null values indicate: header\n        if( optionVal === null ){ // !optionVal? (null only?)\n            newOption.header = true;\n\n        // keys with function values indicate: a menu option\n        } else if( jQuery.type( optionVal ) === 'function' ){\n            newOption.func = optionVal;\n        }\n        //TODO:?? any other special optionVals?\n        // there was no divider option originally\n        convertedOptions.push( newOption );\n    });\n    return new PopupMenu( $( button_element ), convertedOptions );\n};\n\n/** Find all anchors in $parent (using selector) and covert anchors into a PopupMenu options map.\n *  @param {jQuery} $parent the element that contains the links to convert to options\n *  @param {String} selector jq selector string to find links\n *  @returns {Object[]} the options array to initialize a PopupMenu\n */\n//TODO: lose parent and selector, pass in array of links, use map to return options\nPopupMenu.convertLinksToOptions = function( $parent, selector ){\n    $parent = $( $parent );\n    selector = selector || 'a';\n    var options = [];\n    $parent.find( selector ).each( function( elem, i ){\n        var option = {}, $link = $( elem );\n\n        // convert link text to the option text (html) and the href into the option func\n        option.html = $link.text();\n        if( $link.attr( 'href' ) ){\n            var linkHref    = $link.attr( 'href' ),\n                linkTarget  = $link.attr( 'target' ),\n                confirmText = $link.attr( 'confirm' );\n\n            option.func = function(){\n                // if there's a \"confirm\" attribute, throw up a confirmation dialog, and\n                //  if the user cancels - do nothing\n                if( ( confirmText ) && ( !confirm( confirmText ) ) ){ return; }\n\n                // if there's no confirm attribute, or the user accepted the confirm dialog:\n                switch( linkTarget ){\n                    // relocate the center panel\n                    case '_parent':\n                        window.parent.location = linkHref;\n                        break;\n\n                    // relocate the entire window\n                    case '_top':\n                        window.top.location = linkHref;\n                        break;\n\n                    // relocate this panel\n                    default:\n                        window.location = linkHref;\n                }\n            };\n        }\n        options.push( option );\n    });\n    return options;\n};\n\n/** Create a single popupmenu from existing DOM button and anchor elements\n *  @param {jQuery} $buttonElement the element that when clicked will open the menu\n *  @param {jQuery} $menuElement the element that contains the anchors to convert into a menu\n *  @param {String} menuElementLinkSelector jq selector string used to find anchors to be made into menu options\n *  @returns {PopupMenu} the PopupMenu (Backbone View) that can render, control the menu\n */\nPopupMenu.fromExistingDom = function( $buttonElement, $menuElement, menuElementLinkSelector ){\n    $buttonElement = $( $buttonElement );\n    $menuElement = $( $menuElement );\n    var options = PopupMenu.convertLinksToOptions( $menuElement, menuElementLinkSelector );\n    // we're done with the menu (having converted it to an options map)\n    $menuElement.remove();\n    return new PopupMenu( $buttonElement, options );\n};\n\n/** Create all popupmenus within a document or a more specific element\n *  @param {DOMElement} parent the DOM element in which to search for popupmenus to build (defaults to document)\n *  @param {String} menuSelector jq selector string to find popupmenu menu elements (defaults to \"div[popupmenu]\")\n *  @param {Function} buttonSelectorBuildFn the function to build the jq button selector.\n *      Will be passed $menuElement, parent.\n *      (Defaults to return '#' + $menuElement.attr( 'popupmenu' ); )\n *  @returns {PopupMenu[]} array of popupmenus created\n */\nPopupMenu.make_popup_menus = function( parent, menuSelector, buttonSelectorBuildFn ){\n    parent = parent || document;\n    // orig. Glx popupmenu menus have a (non-std) attribute 'popupmenu'\n    //  which contains the id of the button that activates the menu\n    menuSelector = menuSelector || 'div[popupmenu]';\n    // default to (orig. Glx) matching button to menu by using the popupmenu attr of the menu as the id of the button\n    buttonSelectorBuildFn = buttonSelectorBuildFn || function( $menuElement, parent ){\n        return '#' + $menuElement.attr( 'popupmenu' );\n    };\n\n    // aggregate and return all PopupMenus\n    var popupMenusCreated = [];\n    $( parent ).find( menuSelector ).each( function(){\n        var $menuElement    = $( this ),\n            $buttonElement  = $( parent ).find( buttonSelectorBuildFn( $menuElement, parent ) );\n        popupMenusCreated.push( PopupMenu.fromDom( $buttonElement, $menuElement ) );\n        $buttonElement.addClass( 'popup' );\n    });\n    return popupMenusCreated;\n};\n\n\n// =============================================================================\n    return PopupMenu;\n});\n\n"]}