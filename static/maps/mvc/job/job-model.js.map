{"version":3,"sources":["mvc/job/job-model.js"],"names":["searchableMixin","_baseMvc2","default","SearchableModelMixin","Job","Backbone","Model","extend","LoggableMixin","mixin","_logNamespace","defaults","model_class","tool_id","exit_code","logNamespace","outputs","create_time","state","_states2","NEW","response","options","params","this","parseParams","inputs","update_time","value","key","newParams","JSON","parse","initialize","attributes","debug","get","silent","outputCollection","on","currModel","newState","log","inReadyState","trigger","_setUpListeners","previous","_","contains","READY_STATES","hasDetails","isEmpty","urlRoot","Galaxy","root","toString","join","JobCollection","Collection","model","url","intialize","models","ids","map","item","notReady","filter","job","haveDetails","all","queueDetailFetching","collection","queue","_ajaxQueue2","AjaxQueue","fetch","matches","matchesWhat","length","fromHistory","historyId","console","data","history_id","done","window"],"mappings":"yTAOIA,QAAkBC,EAAAC,QAASC,sBAG3BC,EAAMC,SAASC,MAAMC,OAAON,EAAAC,QAASM,eAAeD,OACpDN,EAAAC,QAASO,MACLT,GAEIU,cATO,OAYPC,UACIC,YAAa,MAEbC,QAAS,KACTC,UAAW,KAhBvBC,UACJC,WACIhB,UAoBYiB,YAAa,KAjBnBZ,YAAeE,KAGjBW,MAAAC,EAAAjB,QAAAkB,KAIIT,MAAU,SAAAU,EAAAC,GAkBN,OAjBAV,EAAaW,OADPC,KAAAC,YAAAJ,EAAAE,QAkBCF,GAZPK,YANM,SAAAH,GAONP,IAAAA,KAIAW,OAHAJ,EAAAA,KARMA,EAAA,SAAAK,EAAAC,GAyBFC,EAAUD,GAAOE,KAAKC,MAAMJ,KAdhCD,GAIJM,WAAA,SAAAC,EAAAZ,GACOE,KAAAW,MAAAX,KAASH,mBAAmBa,EAAAZ,GAE/BE,KAAOH,IAAAA,SAAPG,KAAAC,YAAAD,KAAAY,IAAA,YAtBoBC,QAAA,IA0BxBZ,KAAaa,iBACLR,EAAJQ,kBACOf,IAAAA,EAAAA,QAASK,oBACZE,KAAAA,mBAMRG,gBAAY,WAkBRT,KAAKe,GAAG,eAAgB,SAASC,EAAWC,GAf5CjB,KAASkB,IAATlB,KAAwBC,sBAAqBe,EAAYC,GAC7CjB,KAAAmB,gBADZnB,KAAAoB,QAmBY,cAfPN,EAGAO,EA7CerB,KAAAsB,SAAA,aAwDZH,aAAKC,WAMR,OAAAG,EAAAC,SAAA7B,EAAAjB,QAAA+C,aAAAzB,KAAAY,IAAA,WAITc,WAAA,WAWI,OAAQH,EAAEI,QAAQ3B,KAAKY,IAAI,aAK/BgB,QAASC,OAAOC,KAAO,WAGvBC,SAAA,WACA,OACA,OACA/B,KAAAY,IAAA,MACA,IACAZ,KAAAY,IAAA,WAUQ,KARRoB,KAAA,QAkBRC,EAAgBpD,SAASqD,WAAWnD,OAAON,EAAAC,QAASM,eAAeD,QACnEG,cAvHe,OA0HXiD,MAAOvD,EAEPgD,QAAAC,OAAAC,KAAA,WACAF,IAAAA,WACAQ,OAAKpC,KAAA4B,SAILS,UAAW,SAASC,EAAQxC,GAA5BuC,QAAW1B,MAAA2B,EAAAxC,IAQXyC,IAAK,WAALA,OAAKvC,KAAAwC,IAAW,SAAAC,GAAA,OAAAA,EAAA7B,IAAA,SAIhB8B,SAAA,WAII,OAAO1C,KAAK2C,OAAO,SAAAC,GAAA,OAAQA,EAAIzB,kBAAZ0B,YAAA,WAAA,OAAnB7C,KAAA8C,IAAA,SAAAF,GAAA,OAAAA,EAAAlB,gBAKAqB,oBAAgB,WAAA,IAAAC,EAAWtB,KAhCGuB,EAAA,IAAAC,EAAAxE,QAAAyE,UAyC1BnD,KAAKwC,IAAI,SAAAI,GAAA,OAAO,WAAA,OAAMA,EAAIQ,OAAQvC,QAAQ,QAD9C,OAHJkC,EAAAA,KAAAA,WACQC,EAAAA,QAAJ,oBAEIC,GAOJI,QAAA,SAAAC,GA/C8B,OAAAtD,KAAA2C,OAAA,SAAAC,GAAA,OAAAA,EAAAS,QAAAC,MA8DlCvB,SAAU,WARV,OAAA,iBAAA/B,KAAAuD,OAAA,KAAAvB,KAAA,OAgBAwB,YAAa,SAASC,GAVtBC,QAAA/C,MAAAX,MACA,IACA+B,EAAU,IADV/B,SAKA,OAHIgD,EAAQI,OAAAO,MAAkBC,WAAaH,KAAvCI,KAAA,WACHC,OAAAb,MAAAD,EAAAD,wBAEDC,gBAQIA,IAAAA,EACIc,cAAAA","file":"../../../scripts/mvc/job/job-model.js","sourcesContent":["import HISTORY_CONTENTS from \"mvc/history/history-contents\";\nimport STATES from \"mvc/dataset/states\";\nimport AJAX_QUEUE from \"utils/ajax-queue\";\nimport BASE_MVC from \"mvc/base-mvc\";\nimport _l from \"utils/localization\";\nvar logNamespace = \"jobs\";\n//==============================================================================\nvar searchableMixin = BASE_MVC.SearchableModelMixin;\n/** @class Represents a job running or ran on the server job handlers.\n */\nvar Job = Backbone.Model.extend(BASE_MVC.LoggableMixin).extend(\n    BASE_MVC.mixin(\n        searchableMixin,\n        /** @lends Job.prototype */ {\n            _logNamespace: logNamespace,\n\n            /** default attributes for a model */\n            defaults: {\n                model_class: \"Job\",\n\n                tool_id: null,\n                exit_code: null,\n\n                inputs: {},\n                outputs: {},\n                params: {},\n\n                create_time: null,\n                update_time: null,\n                state: STATES.NEW\n            },\n\n            /** override to parse params on incomming */\n            parse: function(response, options) {\n                response.params = this.parseParams(response.params);\n                return response;\n            },\n\n            /** override to treat param values as json */\n            parseParams: function(params) {\n                var newParams = {};\n                _.each(params, (value, key) => {\n                    newParams[key] = JSON.parse(value);\n                });\n                return newParams;\n            },\n\n            /** instance vars and listeners */\n            initialize: function(attributes, options) {\n                this.debug(this + \"(Job).initialize\", attributes, options);\n\n                this.set(\"params\", this.parseParams(this.get(\"params\")), {\n                    silent: true\n                });\n\n                this.outputCollection =\n                    attributes.outputCollection ||\n                    new HISTORY_CONTENTS.HistoryContents([]);\n                this._setUpListeners();\n            },\n\n            /** set up any event listeners\n     *  event: state:ready  fired when this DA moves into/is already in a ready state\n     */\n            _setUpListeners: function() {\n                // if the state has changed and the new state is a ready state, fire an event\n                this.on(\"change:state\", function(currModel, newState) {\n                    this.log(this + \" has changed state:\", currModel, newState);\n                    if (this.inReadyState()) {\n                        this.trigger(\n                            \"state:ready\",\n                            currModel,\n                            newState,\n                            this.previous(\"state\")\n                        );\n                    }\n                });\n            },\n\n            // ........................................................................ common queries\n            /** Is this job in a 'ready' state; where 'Ready' states are states where no\n     *      processing is left to do on the server.\n     */\n            inReadyState: function() {\n                return _.contains(STATES.READY_STATES, this.get(\"state\"));\n            },\n\n            /** Does this model already contain detailed data (as opposed to just summary level data)? */\n            hasDetails: function() {\n                //?? this may not be reliable\n                return !_.isEmpty(this.get(\"outputs\"));\n            },\n\n            // ........................................................................ ajax\n            /** root api url */\n            urlRoot: Galaxy.root + \"api/jobs\",\n            //url : function(){ return this.urlRoot; },\n\n            // ........................................................................ searching\n            // see base-mvc, SearchableModelMixin\n            /** what attributes of an Job will be used in a text search */\n            //searchAttributes : [\n            //    'tool'\n            //],\n\n            // ........................................................................ misc\n            /** String representation */\n            toString: function() {\n                return [\n                    \"Job(\",\n                    this.get(\"id\"),\n                    \":\",\n                    this.get(\"tool_id\"),\n                    \")\"\n                ].join(\"\");\n            }\n        }\n    )\n);\n\n//==============================================================================\n/** @class Backbone collection for Jobs.\n */\nvar JobCollection = Backbone.Collection.extend(BASE_MVC.LoggableMixin).extend(\n    /** @lends JobCollection.prototype */ {\n        _logNamespace: logNamespace,\n\n        model: Job,\n\n        /** root api url */\n        urlRoot: Galaxy.root + \"api/jobs\",\n        url: function() {\n            return this.urlRoot;\n        },\n\n        intialize: function(models, options) {\n            console.debug(models, options);\n        },\n\n        // ........................................................................ common queries\n        /** Get the ids of every item in this collection\n     *  @returns array of encoded ids\n     */\n        ids: function() {\n            return this.map(item => item.get(\"id\"));\n        },\n\n        /** Get jobs that are not ready\n     *  @returns array of content models\n     */\n        notReady: function() {\n            return this.filter(job => !job.inReadyState());\n        },\n\n        /** return true if any jobs don't have details */\n        haveDetails: function() {\n            return this.all(job => job.hasDetails());\n        },\n\n        // ........................................................................ ajax\n        /** fetches all details for each job in the collection using a queue */\n        queueDetailFetching: function() {\n            var collection = this;\n\n            var queue = new AJAX_QUEUE.AjaxQueue(\n                this.map(job => () => job.fetch({ silent: true }))\n            );\n\n            queue.done(() => {\n                collection.trigger(\"details-loaded\");\n            });\n            return queue;\n        },\n\n        //toDAG : function(){\n        //    return new JobDAG( this.toJSON() );\n        //},\n\n        // ........................................................................ sorting/filtering\n        /** return a new collection of jobs whose attributes contain the substring matchesWhat */\n        matches: function(matchesWhat) {\n            return this.filter(job => job.matches(matchesWhat));\n        },\n\n        // ........................................................................ misc\n        /** String representation. */\n        toString: function() {\n            return [\"JobCollection(\", this.length, \")\"].join(\"\");\n        }\n\n        //----------------------------------------------------------------------------- class vars\n    },\n    {\n        /** class level fn for fetching the job details for all jobs in a history */\n        fromHistory: function(historyId) {\n            console.debug(this);\n            var Collection = this;\n            var collection = new Collection([]);\n            collection.fetch({ data: { history_id: historyId } }).done(() => {\n                window.queue = collection.queueDetailFetching();\n            });\n            return collection;\n        }\n    }\n);\n\n//=============================================================================\nexport default {\n    Job: Job,\n    JobCollection: JobCollection\n};\n"]}