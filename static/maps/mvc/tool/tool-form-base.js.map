{"version":3,"sources":["mvc/tool/tool-form-base.js"],"names":["define","initialize","FormBase","Utils","Deferred","Ui","CitationModel","CitationView","extend","options","self","this","model","listenTo","parent","currHistoryPanel","_update","get","Galaxy","collection","callback","deferred","reset","$el","on","_destroy","execute","process","prototype","call","emit","debug","_render","operations","onchange","remove","status","message","persistent","attributes","set","show_message","fixed_title","name","description","version","versions_button","ButtonMenu","_operations","icon","tooltip","render","title","onclick","_footer","hide","id","menu_button","biostar_url","window","narrow","addMenu","sustain_version","versions","length","i","user","replace","url","root","error","open","requirements","prompt","update","location","href","func","success","response","err_msg","_templateHelp","citation_list_view","citations","append","$citations","requirements_visible","portlet","collapsed","addClass","expand","_templateRequirements","requirements_message","sharable_url","$","getJSON","webhooks","_","each","webhook","activate","config","function","Function","menu","ToolCitationCollection","tool_id","CitationListView","el","fetch","$tmpl","help","find","attr","nreq","req","requirements_link","text"],"mappings":"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","file":"../../../scripts/mvc/tool/tool-form-base.js","sourcesContent":["/**\n    This is the base class of the tool form plugin. This class is e.g. inherited by the regular and the workflow tool form.\n*/\ndefine(\n    [\n        \"utils/utils\",\n        \"utils/deferred\",\n        \"mvc/ui/ui-misc\",\n        \"mvc/form/form-view\",\n        \"mvc/citation/citation-model\",\n        \"mvc/citation/citation-view\"\n    ],\n    function(Utils, Deferred, Ui, FormBase, CitationModel, CitationView) {\n        return FormBase.extend({\n            initialize: function(options) {\n                var self = this;\n                this.deferred = new Deferred();\n                FormBase.prototype.initialize.call(this, options);\n\n                // optional model update\n                this._update(this.model.get(\"initialmodel\"));\n\n                // listen to history panel\n                if (\n                    this.model.get(\"listen_to_history\") &&\n                    parent.Galaxy &&\n                    parent.Galaxy.currHistoryPanel\n                ) {\n                    this.listenTo(\n                        parent.Galaxy.currHistoryPanel.collection,\n                        \"change\",\n                        function() {\n                            self.model.get(\"onchange\")();\n                        }\n                    );\n                }\n                // destroy dom elements\n                this.$el.on(\"remove\", function() {\n                    self._destroy();\n                });\n            },\n\n            /** Allows tool form variation to update tool model */\n            _update: function(callback) {\n                var self = this;\n                callback = callback || this.model.get(\"buildmodel\");\n                if (callback) {\n                    this.deferred.reset();\n                    this.deferred.execute(function(process) {\n                        callback(process, self);\n                        process.then(function() {\n                            self._render();\n                        });\n                    });\n                } else {\n                    this._render();\n                }\n            },\n\n            /** Wait for deferred build processes before removal */\n            _destroy: function() {\n                var self = this;\n                this.$el.off().hide();\n                this.deferred.execute(function() {\n                    FormBase.prototype.remove.call(self);\n                    Galaxy.emit.debug(\n                        \"tool-form-base::_destroy()\",\n                        \"Destroy view.\"\n                    );\n                });\n            },\n\n            /** Build form */\n            _render: function() {\n                var self = this;\n                var options = this.model.attributes;\n                this.model.set({\n                    title:\n                        options.fixed_title ||\n                        \"<b>\" +\n                            options.name +\n                            \"</b> \" +\n                            options.description +\n                            \" (Galaxy Version \" +\n                            options.version +\n                            \")\",\n                    operations: !options.hide_operations && this._operations(),\n                    onchange: function() {\n                        self.deferred.reset();\n                        self.deferred.execute(function(process) {\n                            self.model.get(\"postchange\")(process, self);\n                        });\n                    }\n                });\n                this.render();\n                if (!this.model.get(\"collapsible\")) {\n                    this.$el.append(\n                        $(\"<div/>\")\n                            .addClass(\"ui-margin-top-large\")\n                            .append(this._footer())\n                    );\n                }\n                this.show_message &&\n                    this.message.update({\n                        status: \"success\",\n                        message:\n                            \"Now you are using '\" +\n                            options.name +\n                            \"' version \" +\n                            options.version +\n                            \", id '\" +\n                            options.id +\n                            \"'.\",\n                        persistent: false\n                    });\n                this.show_message = true;\n            },\n\n            /** Create tool operation menu */\n            _operations: function() {\n                var self = this;\n                var options = this.model.attributes;\n\n                // button for version selection\n                var versions_button = new Ui.ButtonMenu({\n                    icon: \"fa-cubes\",\n                    title: (!options.narrow && \"Versions\") || null,\n                    tooltip: \"Select another tool version\"\n                });\n                if (\n                    !options.sustain_version &&\n                    options.versions &&\n                    options.versions.length > 1\n                ) {\n                    for (var i in options.versions) {\n                        var version = options.versions[i];\n                        if (version != options.version) {\n                            versions_button.addMenu({\n                                title: \"Switch to \" + version,\n                                version: version,\n                                icon: \"fa-cube\",\n                                onclick: function() {\n                                    // here we update the tool version (some tools encode the version also in the id)\n                                    self.model.set(\n                                        \"id\",\n                                        options.id.replace(\n                                            options.version,\n                                            this.version\n                                        )\n                                    );\n                                    self.model.set(\"version\", this.version);\n                                    self._update();\n                                }\n                            });\n                        }\n                    }\n                } else {\n                    versions_button.$el.hide();\n                }\n\n                // button for options e.g. search, help\n                var menu_button = new Ui.ButtonMenu({\n                    id: \"options\",\n                    icon: \"fa-caret-down\",\n                    title: (!options.narrow && \"Options\") || null,\n                    tooltip: \"View available options\"\n                });\n                if (options.biostar_url) {\n                    menu_button.addMenu({\n                        icon: \"fa-question-circle\",\n                        title: \"Question?\",\n                        onclick: function() {\n                            window.open(options.biostar_url + \"/p/new/post/\");\n                        }\n                    });\n                    menu_button.addMenu({\n                        icon: \"fa-search\",\n                        title: \"Search\",\n                        onclick: function() {\n                            window.open(\n                                options.biostar_url +\n                                    \"/local/search/page/?q=\" +\n                                    options.name\n                            );\n                        }\n                    });\n                }\n                menu_button.addMenu({\n                    icon: \"fa-share\",\n                    title: \"Share\",\n                    onclick: function() {\n                        prompt(\n                            \"Copy to clipboard: Ctrl+C, Enter\",\n                            window.location.origin +\n                                Galaxy.root +\n                                \"root?tool_id=\" +\n                                options.id\n                        );\n                    }\n                });\n\n                // add admin operations\n                if (Galaxy.user && Galaxy.user.get(\"is_admin\")) {\n                    menu_button.addMenu({\n                        icon: \"fa-download\",\n                        title: \"Download\",\n                        onclick: function() {\n                            window.location.href =\n                                Galaxy.root +\n                                \"api/tools/\" +\n                                options.id +\n                                \"/download\";\n                        }\n                    });\n                    menu_button.addMenu({\n                        icon: \"fa-refresh\",\n                        title: \"Reload XML\",\n                        onclick: function() {\n                            Utils.get({\n                                url:\n                                    Galaxy.root +\n                                    \"api/tools/\" +\n                                    options.id +\n                                    \"/reload\",\n                                success: function(response) {\n                                    self.message.update({\n                                        persistent: false,\n                                        message: \"Tool XML has been reloaded.\",\n                                        status: \"success\"\n                                    });\n                                },\n                                error: function(response) {\n                                    self.message.update({\n                                        persistent: false,\n                                        message: response.err_msg,\n                                        status: \"danger\"\n                                    });\n                                }\n                            });\n                        }\n                    });\n                }\n\n                // button for version selection\n                if (options.requirements && options.requirements.length > 0) {\n                    menu_button.addMenu({\n                        icon: \"fa-info-circle\",\n                        title: \"Requirements\",\n                        onclick: function() {\n                            if (\n                                !this.requirements_visible ||\n                                self.portlet.collapsed\n                            ) {\n                                this.requirements_visible = true;\n                                self.portlet.expand();\n                                self.message.update({\n                                    persistent: true,\n                                    message: self._templateRequirements(\n                                        options\n                                    ),\n                                    status: \"info\"\n                                });\n                            } else {\n                                this.requirements_visible = false;\n                                self.message.update({ message: \"\" });\n                            }\n                        }\n                    });\n                }\n\n                // add toolshed url\n                if (options.sharable_url) {\n                    menu_button.addMenu({\n                        icon: \"fa-external-link\",\n                        title: \"See in Tool Shed\",\n                        onclick: function() {\n                            window.open(options.sharable_url);\n                        }\n                    });\n                }\n\n                // add tool menu webhooks\n                $.getJSON(\"/api/webhooks/tool-menu/all\", function(webhooks) {\n                    _.each(webhooks, function(webhook) {\n                        if (webhook.activate && webhook.config.function) {\n                            menu_button.addMenu({\n                                icon: webhook.config.icon,\n                                title: webhook.config.title,\n                                onclick: function() {\n                                    var func = new Function(\n                                        \"options\",\n                                        webhook.config.function\n                                    );\n                                    func(options);\n                                }\n                            });\n                        }\n                    });\n                });\n\n                return {\n                    menu: menu_button,\n                    versions: versions_button\n                };\n            },\n\n            /** Create footer */\n            _footer: function() {\n                var options = this.model.attributes;\n                var $el = $(\"<div/>\").append(this._templateHelp(options));\n                if (options.citations) {\n                    var $citations = $(\"<div/>\");\n                    var citations = new CitationModel.ToolCitationCollection();\n                    citations.tool_id = options.id;\n                    var citation_list_view = new CitationView.CitationListView({\n                        el: $citations,\n                        collection: citations\n                    });\n                    citation_list_view.render();\n                    citations.fetch();\n                    $el.append($citations);\n                }\n                return $el;\n            },\n\n            /** Templates */\n            _templateHelp: function(options) {\n                var $tmpl = $(\"<div/>\")\n                    .addClass(\"ui-form-help\")\n                    .append(options.help);\n                $tmpl.find(\"a\").attr(\"target\", \"_blank\");\n                return $tmpl;\n            },\n\n            _templateRequirements: function(options) {\n                var nreq = options.requirements.length;\n                if (nreq > 0) {\n                    var requirements_message = \"This tool requires \";\n                    _.each(options.requirements, function(req, i) {\n                        requirements_message +=\n                            req.name +\n                            (req.version\n                                ? \" (Version \" + req.version + \")\"\n                                : \"\") +\n                            (i < nreq - 2\n                                ? \", \"\n                                : i == nreq - 2 ? \" and \" : \"\");\n                    });\n                    var requirements_link = $(\"<a/>\")\n                        .attr(\"target\", \"_blank\")\n                        .attr(\n                            \"href\",\n                            \"https://galaxyproject.org/tools/requirements/\"\n                        )\n                        .text(\"here\");\n                    return $(\"<span/>\")\n                        .append(requirements_message + \". Click \")\n                        .append(requirements_link)\n                        .append(\" for more information.\");\n                }\n                return \"No requirements found.\";\n            }\n        });\n    }\n);\n"]}