{"version":3,"sources":["mvc/tool/tool-form.js"],"names":["define","Utils","Ui","Modal","ToolFormBase","Webhooks","View","Backbone","extend","initialize","this","self","parent","Galaxy","modal","merge","listen_to_history","always_refresh","process","form","buildmodel","model","attributes","build_url","build_data","job_id","root","options","id","params","version","get","url","data","display","set","_customize","emit","window","error","response","status","error_message","err_msg","$","param","redirect","location","is","$el","Message","message","persistent","large","show","title","body","buttons","hide","debug","postchange","current_state","tool_id","tool_version","create","wait","type","success","update","deferred","setElement","execute_button","Button","icon","name","tooltip","cls","wait_cls","onclick","portlet","disable","submit","unwait","execute","job_remap","push","label","ignore","value","callback","job_def","trigger","validate","action","method","enctype","_","each","$f","inputs","attr","append","remove","request","children","jobs","length","_templateSuccess","WebhookView","toolId","input_found","err_data","matchResponse","error_messages","input_id","_templateError","Close","job_inputs","batch_n","batch_src","job_input_id","input_value","match","field_list","input_list","input_def","input_field","optional","highlight","batch","values","src","n","njobs","njobs_text","$message","addClass","text","output","hid","JSON","stringify"],"mappings":"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","file":"../../../scripts/mvc/tool/tool-form.js","sourcesContent":["/* This is the regular tool form */\ndefine([ 'utils/utils', 'mvc/ui/ui-misc', 'mvc/ui/ui-modal', 'mvc/tool/tool-form-base', 'mvc/webhooks' ],\n    function( Utils, Ui, Modal, ToolFormBase, Webhooks ) {\n    var View = Backbone.View.extend({\n        initialize: function( options ) {\n            var self = this;\n            this.modal = parent.Galaxy.modal || new Modal.View();\n            this.form = new ToolFormBase( Utils.merge({\n                listen_to_history : true,\n                always_refresh    : false,\n                buildmodel: function( process, form ) {\n                    var options = form.model.attributes;\n\n                    // build request url\n                    var build_url = '';\n                    var build_data = {};\n                    var job_id = options.job_id;\n                    if ( job_id ) {\n                        build_url = Galaxy.root + 'api/jobs/' + job_id + '/build_for_rerun';\n                    } else {\n                        build_url = Galaxy.root + 'api/tools/' + options.id + '/build';\n                        build_data = $.extend( {}, Galaxy.params );\n                        build_data[ 'tool_id' ] && ( delete build_data[ 'tool_id' ] );\n                    }\n                    options.version && ( build_data[ 'tool_version' ] = options.version );\n\n                    // get initial model\n                    Utils.get({\n                        url     : build_url,\n                        data    : build_data,\n                        success : function( data ) {\n                            if( !data.display ) {\n                                window.location = Galaxy.root;\n                                return;\n                            }\n                            form.model.set( data );\n                            self._customize( form );\n                            Galaxy.emit.debug('tool-form-base::_buildModel()', 'Initial tool model ready.', data);\n                            process.resolve();\n                        },\n                        error   : function( response, status ) {\n                            var error_message = ( response && response.err_msg ) || 'Uncaught error.';\n                            if ( status == 401 ) {\n                                window.location = Galaxy.root + 'user/login?' + $.param({ redirect : Galaxy.root + '?tool_id=' + options.id });\n                            } else if ( form.$el.is( ':empty' ) ) {\n                                form.$el.prepend( ( new Ui.Message({\n                                    message     : error_message,\n                                    status      : 'danger',\n                                    persistent  : true,\n                                    large       : true\n                                }) ).$el );\n                            } else {\n                                Galaxy.modal && Galaxy.modal.show({\n                                    title   : 'Tool request failed',\n                                    body    : error_message,\n                                    buttons : {\n                                        'Close' : function() {\n                                            Galaxy.modal.hide();\n                                        }\n                                    }\n                                });\n                            }\n                            Galaxy.emit.debug( 'tool-form-base::_buildModel()', 'Initial tool model request failed.', response );\n                            process.reject();\n                        }\n                    });\n                },\n                postchange          : function( process, form ) {\n                    var current_state = {\n                        tool_id         : form.model.get( 'id' ),\n                        tool_version    : form.model.get( 'version' ),\n                        inputs          : $.extend(true, {}, form.data.create())\n                    }\n                    form.wait( true );\n                    Galaxy.emit.debug( 'tool-form::postchange()', 'Sending current state.', current_state );\n                    Utils.request({\n                        type    : 'POST',\n                        url     : Galaxy.root + 'api/tools/' + form.model.get( 'id' ) + '/build',\n                        data    : current_state,\n                        success : function( data ) {\n                            form.update( data );\n                            form.wait( false );\n                            Galaxy.emit.debug( 'tool-form::postchange()', 'Received new model.', data );\n                            process.resolve();\n                        },\n                        error   : function( response ) {\n                            Galaxy.emit.debug( 'tool-form::postchange()', 'Refresh request failed.', response );\n                            process.reject();\n                        }\n                    });\n                }\n            }, options ) );\n            this.deferred = this.form.deferred;\n            this.setElement( '<div/>' );\n            this.$el.append( this.form.$el );\n        },\n\n        _customize: function( form ) {\n            var self = this;\n            var options = form.model.attributes;\n            // build execute button\n            var execute_button = new Ui.Button({\n                    icon     : 'fa-check',\n                    tooltip  : 'Execute: ' + options.name + ' (' + options.version + ')',\n                    title    : 'Execute',\n                    cls      : 'btn btn-primary ui-clear-float',\n                    wait_cls : 'btn btn-info ui-clear-float',\n                    onclick  : function() {\n                        execute_button.wait();\n                        form.portlet.disable();\n                        self.submit( options, function() {\n                            execute_button.unwait();\n                            form.portlet.enable();\n                        } );\n                    }\n                });\n            options.buttons = { execute: execute_button };\n\n            // remap feature\n            if ( options.job_id && options.job_remap ) {\n                options.inputs.push({\n                    label       : 'Resume dependencies from this job',\n                    name        : 'rerun_remap_job_id',\n                    type        : 'select',\n                    display     : 'radio',\n                    ignore      : '__ignore__',\n                    value       : '__ignore__',\n                    options     : [ [ 'Yes', options.job_id ], [ 'No', '__ignore__' ] ],\n                    help        : 'The previous run of this tool failed and other tools were waiting for it to finish successfully. Use this option to resume those tools using the new output(s) of this tool run.'\n                });\n            }\n        },\n\n        /** Submit a regular job.\n         * @param{dict}     options   - Specifies tool id and version\n         * @param{function} callback  - Called when request has completed\n         */\n        submit: function( options, callback ) {\n            var self = this;\n            var job_def = {\n                tool_id         : options.id,\n                tool_version    : options.version,\n                inputs          : this.form.data.create()\n            }\n            this.form.trigger( 'reset' );\n            if ( !self.validate( job_def ) ) {\n                Galaxy.emit.debug( 'tool-form::submit()', 'Submission canceled. Validation failed.' );\n                callback && callback();\n                return;\n            }\n            if ( options.action !== Galaxy.root + 'tool_runner/index' ) {\n                var $f = $( '<form/>' ).attr( { action: options.action, method: options.method, enctype: options.enctype } );\n                _.each( job_def.inputs, function( value, key ) { $f.append( $( '<input/>' ).attr( { 'name': key, 'value': value } ) ) } );\n                $f.hide().appendTo( 'body' ).submit().remove();\n                callback && callback();\n                return;\n            }\n            Galaxy.emit.debug( 'tool-form::submit()', 'Validation complete.', job_def );\n            Utils.request({\n                type    : 'POST',\n                url     : Galaxy.root + 'api/tools',\n                data    : job_def,\n                success : function( response ) {\n                    callback && callback();\n                    self.$el.children().hide();\n                    self.$el.append( self._templateSuccess( response ) );\n                    // Show Webhook if job is running\n                    if ( response.jobs && response.jobs.length > 0 ) {\n                        self.$el.append( $( '<div/>', { id: 'webhook-view' } ) );\n                        var WebhookApp = new Webhooks.WebhookView({\n                            urlRoot: Galaxy.root + 'api/webhooks/tool',\n                            toolId: job_def.tool_id\n                        });\n                    }\n                    parent.Galaxy && parent.Galaxy.currHistoryPanel && parent.Galaxy.currHistoryPanel.refreshContents();\n                },\n                error   : function( response ) {\n                    callback && callback();\n                    Galaxy.emit.debug( 'tool-form::submit', 'Submission failed.', response );\n                    var input_found = false;\n                    if ( response && response.err_data ) {\n                        var error_messages = self.form.data.matchResponse( response.err_data );\n                        for ( var input_id in error_messages ) {\n                            self.form.highlight( input_id, error_messages[ input_id ]);\n                            input_found = true;\n                            break;\n                        }\n                    }\n                    if ( !input_found ) {\n                        self.modal.show({\n                            title   : 'Job submission failed',\n                            body    : self._templateError( job_def, response && response.err_msg ),\n                            buttons : { 'Close' : function() { self.modal.hide() } }\n                        });\n                    }\n                }\n            });\n        },\n\n        /** Validate job dictionary.\n         * @param{dict}     job_def   - Job execution dictionary\n        */\n        validate: function( job_def ) {\n            var job_inputs  = job_def.inputs;\n            var batch_n     = -1;\n            var batch_src   = null;\n            for ( var job_input_id in job_inputs ) {\n                var input_value = job_inputs[ job_input_id ];\n                var input_id    = this.form.data.match( job_input_id );\n                var input_field = this.form.field_list[ input_id ];\n                var input_def   = this.form.input_list[ input_id ];\n                if ( !input_id || !input_def || !input_field ) {\n                    Galaxy.emit.debug('tool-form::validate()', 'Retrieving input objects failed.');\n                    continue;\n                }\n                if ( !input_def.optional && input_value == null ) {\n                    this.form.highlight( input_id );\n                    return false;\n                }\n                if ( input_value && input_value.batch ) {\n                    var n = input_value.values.length;\n                    var src = n > 0 && input_value.values[ 0 ] && input_value.values[ 0 ].src;\n                    if ( src ) {\n                        if ( batch_src === null ) {\n                            batch_src = src;\n                        } else if ( batch_src !== src ) {\n                            this.form.highlight( input_id, 'Please select either dataset or dataset list fields for all batch mode fields.' );\n                            return false;\n                        }\n                    }\n                    if ( batch_n === -1 ) {\n                        batch_n = n;\n                    } else if ( batch_n !== n ) {\n                        this.form.highlight( input_id, 'Please make sure that you select the same number of inputs for all batch mode fields. This field contains <b>' + n + '</b> selection(s) while a previous field contains <b>' + batch_n + '</b>.' );\n                        return false;\n                    }\n                }\n            }\n            return true;\n        },\n\n        _templateSuccess: function( response ) {\n            if ( response.jobs && response.jobs.length > 0 ) {\n                var njobs = response.jobs.length;\n                var njobs_text = njobs == 1 ? '1 job has' : njobs + ' jobs have';\n                var $message = $( '<div/>' ).addClass( 'donemessagelarge' )\n                                            .append( $( '<p/>' ).text( njobs_text + ' been successfully added to the queue - resulting in the following datasets:' ) );\n                _.each( response.outputs, function( output ) {\n                    $message.append( $( '<p/>' ).addClass( 'messagerow' ).append( $( '<b/>' ).text( output.hid + ': ' + output.name ) ) );\n                });\n                $message.append( $( '<p/>' ).append( '<b/>' ).text( 'You can check the status of queued jobs and view the resulting data by refreshing the History pane. When the job has been run the status will change from \\'running\\' to \\'finished\\' if completed successfully or \\'error\\' if problems were encountered.' ) );\n                return $message;\n            } else {\n                return this._templateError( response, 'Invalid success response. No jobs found.' );\n            }\n        },\n\n        _templateError: function( response, err_msg ) {\n            return  $( '<div/>' ).addClass( 'errormessagelarge' )\n                                 .append( $( '<p/>' ).text( 'The server could not complete the request. Please contact the Galaxy Team if this error persists. ' + ( err_msg || '' ) ) )\n                                 .append( $( '<pre/>' ).text( JSON.stringify( response, null, 4 ) ) );\n        }\n    });\n\n    return {\n        View: View\n    };\n});\n"]}