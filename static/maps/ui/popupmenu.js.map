{"version":3,"sources":["ui/popupmenu.js"],"names":["define","jQuery","make_popupmenu","button_element","initial_options","element_menu_exists","data","bind","e","$","remove","menu_element","setTimeout","attr","options","appendTo","each","k","v","append","url","html","click","action","css","pageY","x","close_popup","el","unbind","width","Math","min","window","wrapper","frame_id","scrollLeft","top","left","document","make_popup_menus","parent","frames","length","find","menu","this","link","event","preventDefault","confirmtext","link_dom","getAttribute","href","target","text","confirm","open","box","stopPropagation","addClass"],"mappings":"kCAAAA,QAAQ,UAAW,SAASC,GACxB,aAYA,SAASC,EAAeC,EAAgBC,GACpC,IAAAC,EAAAF,EAAAG,KAAA,gBAIAH,EAAeG,KAAK,eAAgBF,GAApCD,GAIIA,EAAAI,KAAA,mBAAA,SAAAC,GA+EA,OA1EAC,EAAE,oBAAoBC,SAAtBD,WAAE,WAEF,IAAAE,EAAAF,EACAG,iCACIT,EAAAU,KAAA,MACIF,gBAMJG,EAAIX,EAAJG,KAA0B,gBACtBG,EAAAA,KAAEK,IAAA,GACLL,EAAA,wBAAAM,SAAAJ,GAEGF,EAAAO,KAAAF,EAAO,SAAAG,EAAAC,GACH,GAAAA,EAAA,CAEAP,IAAAA,EAAAA,EAAAA,QACIF,EAOPE,EAAMQ,OACHR,EAAAA,aAAaQ,OAKhBV,EAAA,OAlBLI,KAAA,OAAAK,EAAAE,KAqBIC,KAAAJ,GAZiBK,MAAMC,UAInBZ,EAAaQ,OAuBbK,EAAAA,aACGC,SADC,QAEFC,OAAAA,EAAAA,oBAAAA,KAAAA,OAIdd,IAAAA,EAAWH,EACP,uFAEAU,OAAIQ,GACAlB,SAAMF,QAEFqB,EAAAA,EAAAA,MAAGC,EAAOC,QAAA,EACbJ,EAAAK,KAHDC,IAIHN,EACDC,EAAAA,UAAYlB,aACZkB,EAAAA,QAAcM,QACdxB,EAAKyB,GAAIC,QACL,GAEAR,EAAAA,KAAAA,IAAAA,EAAAA,EAAAA,UAAAS,aAAA,GAEPF,EAhBDV,KALQa,IAAK7B,EAAEiB,MAuBfa,KAAOZ,KAEd,IAEDd,WAAA,WAnBY,IAAIe,EAAc,SAASC,GACvBnB,EAAEmB,GAAIrB,KAAK,oBAAqB,WAC5BE,EAAE,oBAAoBC,SACtBkB,EAAGC,OAAO,wBAGlBF,EAAYlB,EAAEwB,OAAOM,WACrBZ,EAAYlB,EAAEwB,OAAOI,IAAIE,WAuBrC,IAASC,IAAAA,EAAiBC,OAAQJ,IAAAK,OAAAC,OAAAR,KAG9BM,EADAhC,EAAAwB,OAAAI,IAAAK,OAAAP,GAAAI,YAKQ,KAtBG,IArGnBvC,IAAAA,EAAQC,EAiLJ,OACIC,eAAgBA,EAChBsC,iBAvCoBjB,SAAAA,GAGQkB,EAAAA,GAAAF,SACA9B,EAAAgC,GACAG,KAAA,kBACIX,KAAAA,WACA,IAAAnB,KACH+B,EAAApC,EAAAqC,MAGAD,EAAAD,KAAA,KAAA5B,KAAA,WACJ,IAAA+B,EAAAtC,EAVDqC,MAWIE,EAAAA,EAAAA,IAAMC,GACTC,EAAAC,EAAAC,aAAA,WACJC,EAAAF,EAAAC,aAAA,QAjBkBE,EAAvBH,EAAAC,aAAA,UAwBRtC,EAAAiC,EAAAQ,QAHAF,GAIAjC,IAAAiC,EACA9B,OAAmB,SAASyB,GAExB,IAAAE,GAAAM,QAAAN,GAAA,CAGJ,GAAAI,EAEA,OADoBxC,OAApB2C,KAAAJ,EAAAC,IACA,EAGXP,EAAAzB,aAGM0B,EAAAC,mBAjBoCJ,OAA/B,IAAIa,EAAMjD,EAAEgC,GAAQG,KAAK,IAAMC,EAAKhC,KAAK,cAIzC6C,EAAId,KAAK,KAAKrC,KAAK,QAAS,SAASC,GAEjC,OADAA,EAAEmD,mBACK,IAIXzD,EAAewD,EAAK5C,GACpB4C,EAAIE,SAAS,SACbf,EAAKnC","file":"../../scripts/ui/popupmenu.js","sourcesContent":["define([\"jquery\"], function(jQuery) {\n    \"use_strict\";\n\n    var $ = jQuery;\n\n    // ============================================================================\n    // TODO: unify popup menus and/or eliminate this\n    /**\n * Sets up popupmenu rendering and binds options functions to the appropriate links.\n * initial_options is a dict with text describing the option pointing to either (a) a\n * function to perform; or (b) another dict with two required keys, 'url' and 'action' (the\n * function to perform. (b) is useful for exposing the underlying URL of the option.\n */\n    function make_popupmenu(button_element, initial_options) {\n        /*  Use the $.data feature to store options with the link element.\n        This allows options to be changed at a later time\n    */\n        var element_menu_exists = button_element.data(\"menu_options\");\n        button_element.data(\"menu_options\", initial_options);\n\n        // If element already has menu, nothing else to do since HTML and actions are already set.\n        if (element_menu_exists) {\n            return;\n        }\n\n        button_element.bind(\"click.show_popup\", function(e) {\n            // Close existing visible menus\n            $(\".popmenu-wrapper\").remove();\n\n            // Need setTimeouts so clicks don't interfere with each other\n            setTimeout(function() {\n                // Dynamically generate the wrapper holding all the selectable options of the menu.\n                var menu_element = $(\n                    \"<ul class='dropdown-menu' id='\" +\n                        button_element.attr(\"id\") +\n                        \"-menu'></ul>\"\n                );\n                var options = button_element.data(\"menu_options\");\n                if (_.size(options) <= 0) {\n                    $(\"<li>No Options.</li>\").appendTo(menu_element);\n                }\n                $.each(options, function(k, v) {\n                    if (v) {\n                        // Action can be either an anonymous function and a mapped dict.\n                        var action = v.action || v;\n                        menu_element.append(\n                            $(\"<li></li>\").append(\n                                $(\"<a>\")\n                                    .attr(\"href\", v.url)\n                                    .html(k)\n                                    .click(action)\n                            )\n                        );\n                    } else {\n                        menu_element.append(\n                            $(\"<li></li>\")\n                                .addClass(\"head\")\n                                .append($(\"<a href='#'></a>\").html(k))\n                        );\n                    }\n                });\n                var wrapper = $(\n                    \"<div class='popmenu-wrapper' style='position: absolute;left: 0; top: -1000;'></div>\"\n                )\n                    .append(menu_element)\n                    .appendTo(\"body\");\n\n                var x = e.pageX - wrapper.width() / 2;\n                x = Math.min(\n                    x,\n                    $(document).scrollLeft() +\n                        $(window).width() -\n                        $(wrapper).width() -\n                        5\n                );\n                x = Math.max(x, $(document).scrollLeft() + 5);\n\n                wrapper.css({\n                    top: e.pageY,\n                    left: x\n                });\n            }, 10);\n\n            setTimeout(function() {\n                // Bind click event to current window and all frames to remove any visible menus\n                // Bind to document object instead of window object for IE compat\n                var close_popup = function(el) {\n                    $(el).bind(\"click.close_popup\", function() {\n                        $(\".popmenu-wrapper\").remove();\n                        el.unbind(\"click.close_popup\");\n                    });\n                };\n                close_popup($(window.document)); // Current frame\n                close_popup($(window.top.document)); // Parent frame\n                for (var frame_id = window.top.frames.length; frame_id--; ) {\n                    // Sibling frames\n                    var frame = $(window.top.frames[frame_id].document);\n                    close_popup(frame);\n                }\n            }, 50);\n\n            return false;\n        });\n    }\n\n    /**\n *  Convert two seperate (often adjacent) divs into galaxy popupmenu\n *  - div 1 contains a number of anchors which become the menu options\n *  - div 1 should have a 'popupmenu' attribute\n *  - this popupmenu attribute contains the id of div 2\n *  - div 2 becomes the 'face' of the popupmenu\n *\n *  NOTE: make_popup_menus finds and operates on all divs with a popupmenu attr (no need to point it at something)\n *          but (since that selector searches the dom on the page), you can send a parent in\n *  NOTE: make_popup_menus, and make_popupmenu are horrible names\n */\n    function make_popup_menus(parent) {\n        // find all popupmenu menu divs (divs that contains anchors to be converted to menu options)\n        //  either in the parent or the document if no parent passed\n        parent = parent || document;\n        $(parent)\n            .find(\"div[popupmenu]\")\n            .each(function() {\n                var options = {};\n                var menu = $(this);\n\n                // find each anchor in the menu, convert them into an options map: { a.text : click_function }\n                menu.find(\"a\").each(function() {\n                    var link = $(this),\n                        link_dom = link.get(0),\n                        confirmtext = link_dom.getAttribute(\"confirm\"),\n                        href = link_dom.getAttribute(\"href\"),\n                        target = link_dom.getAttribute(\"target\");\n\n                    // no href - no function (gen. a label)\n                    if (!href) {\n                        options[link.text()] = null;\n                    } else {\n                        options[link.text()] = {\n                            url: href,\n                            action: function(event) {\n                                // if theres confirm text, send the dialog\n                                if (!confirmtext || confirm(confirmtext)) {\n                                    // link.click() doesn't use target for some reason,\n                                    // so manually do it here.\n                                    if (target) {\n                                        window.open(href, target);\n                                        return false;\n                                    } else {\n                                        // For all other links, do the default action.\n                                        link.click();\n                                    }\n                                } else {\n                                    event.preventDefault();\n                                }\n                            }\n                        };\n                    }\n                });\n                // locate the element with the id corresponding to the menu's popupmenu attr\n                var box = $(parent).find(\"#\" + menu.attr(\"popupmenu\"));\n\n                // For menus with clickable link text, make clicking on the link go through instead\n                // of activating the popup menu\n                box.find(\"a\").bind(\"click\", function(e) {\n                    e.stopPropagation(); // Stop bubbling so clicking on the link goes through\n                    return true;\n                });\n\n                // attach the click events and menu box building to the box element\n                make_popupmenu(box, options);\n                box.addClass(\"popup\");\n                menu.remove();\n            });\n    }\n\n    // ============================================================================\n    return {\n        make_popupmenu: make_popupmenu,\n        make_popup_menus: make_popup_menus\n    };\n});\n"]}